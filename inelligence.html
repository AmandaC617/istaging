<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>市場情資與競品分析平台 (V5 - 完整維度版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // Tailwind CSS configuration for a modern, tech-themed UI
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        techbg: '#181D27',
                        techpanel: '#22283A',
                        techaccent: '#2EE9E4',
                        techprimary: '#3762F0',
                        techsecondary: '#7D5FFF'
                    },
                    fontFamily: {
                        'tech': ['"Segoe UI"', 'Roboto', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styling and animations */
        body { font-family: "Segoe UI", Roboto, Arial, sans-serif; }
        .tab-main.active { border-color: #2EE9E4; background-color: #181D27; color: #2EE9E4; }
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.5s ease; }
        .locked { opacity: 0.5; pointer-events: none; }
        .spinner { border: 4px solid rgba(59,130,246,.2); width: 36px; height: 36px; border-radius: 50%; border-left-color: #2EE9E4; animation: spin 1s ease infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Table and result panel styling */
        th, td { padding: 12px 15px; }
        .result-panel { max-height: 65vh; overflow-y: auto; }
        .overflow-x-auto { overflow-x: auto; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #181D27; }
        ::-webkit-scrollbar-thumb { background: #3762F0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #7D5FFF; }

        /* Stepper UI */
        .stepper-container { display: flex; justify-content: space-between; margin-bottom: 1.5rem; }
        .step { flex: 1; text-align: center; position: relative; }
        .step-circle { width: 32px; height: 32px; line-height: 30px; border-radius: 50%; background-color: #22283A; color: #fff; display: inline-block; border: 2px solid #3762F0; font-weight: bold; cursor: pointer; transition: all .3s ease; }
        .step-title { margin-top: 0.5rem; font-size: 0.875rem; color: #9ca3af; }
        .step-line { position: absolute; top: 16px; left: 50%; width: 100%; height: 2px; background-color: #3762F0; z-index: -1; }
        .step:first-child .step-line { left: 50%; width: 50%; }
        .step:last-child .step-line { left: 0; width: 50%;}
        
        .step.active .step-circle { background-color: #3762F0; color: #fff; border-color: #2EE9E4; transform: scale(1.1); }
        .step.active .step-title { color: #2EE9E4; font-weight: bold; }
        .step.completed .step-circle { background-color: #2EE9E4; color: #181D27; border-color: #2EE9E4; }
        .step.completed .step-title { color: #d1d5db; }

        /* Badge Styles */
        .badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-weight: 600; font-size: 0.75rem; }
        .badge-high { background-color: #ef4444; color: white; }
        .badge-mid { background-color: #f97316; color: white; }
        .badge-low { background-color: #22c55e; color: white; }
        .badge-unknown { background-color: #6b7280; color: white; }
    </style>
</head>
<body class="bg-techbg font-tech text-gray-100 min-h-screen">
    <!-- Header Section -->
    <header class="bg-techpanel shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold tracking-wide text-techaccent flex items-center gap-2">
                <svg class="w-8 h-8 text-techprimary inline-block" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364-7.364l-1.414 1.414M6.05 17.95l-1.414 1.414m12.728 0l1.414-1.414M6.05 6.05L4.636 4.636" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                市場情資與競品分析平台
            </h1>
            <div id="auth-container">
                <div class="flex items-center gap-4">
                    <div id="user-profile" class="hidden items-center gap-3">
                        <img id="user-avatar" class="w-10 h-10 rounded-full" src="" alt="User Avatar">
                        <span id="user-name" class="font-semibold text-gray-200"></span>
                        <button id="signout_button" class="text-sm text-gray-400 hover:text-techaccent">登出</button>
                    </div>
                     <button id="authorize_button" class="hidden bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-5 py-2 rounded-lg shadow-lg">登入 Google</button>
                </div>
                <div class="text-xs text-yellow-400 mt-2">※ 需授權 Google Drive 全權限才能正確儲存資料</div>
            </div>
        </div>
    </header>

    <div id="alert-container" class="fixed top-24 right-6 z-50"></div>

    <main class="container mx-auto px-6 py-8">
        <div id="app-container" class="locked">
            <div class="flex border-b border-techprimary/20 mb-6">
                <button data-tab="analysis" class="tab-main tab-btn active flex-1 p-4 font-semibold">分析流程</button>
                <button data-tab="settings" class="tab-main tab-btn flex-1 p-4 font-semibold">API 設定</button>
                <button data-tab="history" class="tab-main tab-btn flex-1 p-4 font-semibold">歷史紀錄</button>
            </div>

            <!-- Main Panels -->
            <div id="analysis-panel" class="panel active">
                <!-- Stepper -->
                <div class="stepper-container mb-8">
                    <div id="step-1" class="step active">
                        <div class="step-circle" onclick="goToStep(1)">1</div>
                        <div class="step-title">分析設定</div>
                        <div class="step-line"></div>
                    </div>
                    <div id="step-2" class="step">
                        <div class="step-circle" onclick="goToStep(2)">2</div>
                        <div class="step-title">對手篩選與補充</div>
                        <div class="step-line"></div>
                    </div>
                    <div id="step-3" class="step">
                        <div class="step-circle" onclick="goToStep(3)">3</div>
                        <div class="step-title">完整報告</div>
                    </div>
                </div>

                <!-- Step Content -->
                <div id="step-content">
                    <!-- Step 1: Analysis Inputs -->
                    <div id="step-1-content" class="step-panel active">
                        <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8 max-w-3xl mx-auto">
                            <h2 class="text-2xl font-bold mb-6 text-techaccent text-center">設定分析目標</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="topic" class="block text-sm font-medium text-gray-300">分析主題</label>
                                    <input type="text" id="topic" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-gray-100" placeholder="如: 行動電源">
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium text-gray-300">商業模式</label>
                                    <div class="mt-2 grid grid-cols-3 gap-4 text-gray-300">
                                        <label class="p-3 bg-techbg rounded-lg text-center border-2 border-transparent has-[:checked]:border-techaccent cursor-pointer"><input type="radio" name="business-model" value="B2C" checked class="sr-only">B2C</label>
                                        <label class="p-3 bg-techbg rounded-lg text-center border-2 border-transparent has-[:checked]:border-techaccent cursor-pointer"><input type="radio" name="business-model" value="B2B" class="sr-only">B2B</label>
                                        <label class="p-3 bg-techbg rounded-lg text-center border-2 border-transparent has-[:checked]:border-techaccent cursor-pointer"><input type="radio" name="business-model" value="B2B2C" class="sr-only">B2B2C</label>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="country" class="block text-sm font-medium text-gray-300">國家/地區</label>
                                        <select id="country" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-gray-100"><option value="TW">台灣</option><option value="CN">中國</option><option value="HK">香港</option><option value="JP">日本</option><option value="KR">韓國</option><option value="US">美國</option><option value="SG">新加坡</option><option value="DE">德國</option><option value="GB">英國</option><option value="FR">法國</option></select>
                                    </div>
                                    <div>
                                        <label for="language" class="block text-sm font-medium text-gray-300">語言</label>
                                        <select id="language" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-gray-100"><option value="zh-TW">繁體中文</option><option value="zh-CN">簡體中文</option><option value="en">英文</option><option value="ja">日文</option><option value="ko">韓文</option><option value="de">德文</option><option value="fr">法文</option></select>
                                    </div>
                                </div>
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="industry" class="block text-sm font-medium text-gray-300">產業名稱</label><input type="text" id="industry" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="如: 消費性電子"></div>
                                    <div><label for="sector" class="block text-sm font-medium text-gray-300">行業名稱</label><input type="text" id="sector" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="如: 通訊設備"></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="product" class="block text-sm font-medium text-gray-300">產品名稱</label><input type="text" id="product" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="如: 行動電源"></div>
                                    <div><label for="company" class="block text-sm font-medium text-gray-300">公司名稱 (可選)</label><input type="text" id="company" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="如: 小米"></div>
                                </div>
                                <button id="start-analysis-btn" class="w-full bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-5 py-3 rounded-lg shadow-lg mt-6">產生建議列表</button>
                            </div>
                        </section>
                    </div>

                    <!-- Step 2: Competitor Selection & Supplement -->
                    <div id="step-2-content" class="step-panel hidden">
                        <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8 max-w-4xl mx-auto">
                            <h2 class="text-2xl font-bold mb-2 text-techaccent text-center">篩選與補充競爭對手</h2>
                            <p class="text-center text-gray-400 mb-6">請勾選 AI 建議的對手，並可手動補充額外名單。</p>
                            
                            <h3 class="font-semibold text-lg text-techaccent mb-3">AI 建議列表</h3>
                            <div id="competitor-checkbox-list" class="mb-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                            
                            <div class="mt-6 border-t border-techprimary/30 pt-6">
                                <label for="supplemental-competitors" class="font-semibold text-lg text-techaccent mb-3 block">補充自定義對手 (非必要)</label>
                                <textarea id="supplemental-competitors" rows="3" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="請輸入額外的公司或品牌名稱，每行一個或用逗號分隔"></textarea>
                            </div>

                            <div class="flex justify-between items-center mt-8">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="select-all-competitors" class="mr-2 accent-techaccent scale-125">
                                    <span class="font-semibold">全選/全不選 (AI 列表)</span>
                                </label>
                                <button id="analyze-selected-btn" class="bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-8 py-3 rounded-lg shadow-lg">整合並分析最終列表</button>
                            </div>
                        </section>
                    </div>

                    <!-- Step 3: Full Report -->
                    <div id="step-3-content" class="step-panel hidden">
                         <div id="loading-indicator" class="flex-col items-center justify-center h-full hidden">
                            <div class="spinner"></div>
                            <p id="loading-status" class="mt-4 text-techaccent font-medium"></p>
                        </div>
                        <div id="results-container">
                            <div class="flex justify-end gap-4 mb-4">
                                <button id="save-analysis-btn" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 font-bold text-white px-4 py-2 rounded-lg shadow-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a10 10 0 0 0 10-10c0-2.3-1.1-4.6-2.6-6.1-1.5-1.5-3.8-2.6-6.1-2.6-2.5 0-4.8.9-6.6 2.5-1.8 1.6-2.9 3.8-2.9 6.2 0 5.5 4.5 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>
                                    儲存至 Drive
                                </button>
                                <button id="export-excel-btn" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 font-bold text-white px-4 py-2 rounded-lg shadow-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                                    匯出 Excel
                                </button>
                            </div>
                            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                                <div id="competitors-result-card" class="bg-techpanel rounded-xl shadow-2xl p-6"></div>
                                <div id="keywords-result-card" class="bg-techpanel rounded-xl shadow-2xl p-6"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings-panel" class="panel hidden">
                <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8 max-w-lg mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-techaccent text-center">API 與應用程式設定</h2>
                    <div class="space-y-4">
                        <div><label for="google-api-key" class="block text-sm font-medium text-gray-300">Google API 金鑰</label><input type="password" id="google-api-key" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="填寫 Gemini/Custom Search API Key"></div>
                        <div><label for="search-engine-id" class="block text-sm font-medium text-gray-300">可程式化搜尋引擎 ID (CX)</label><input type="text" id="search-engine-id" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="填寫 Custom Search Engine ID"></div>
                        <div><label for="drive-folder-name" class="block text-sm font-medium text-gray-300">Google Drive 資料夾名稱</label><input type="text" id="drive-folder-name" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="Market_Analysis_Data"></div>
                        <button id="save-settings-btn" class="w-full bg-gradient-to-tr from-techprimary to-techaccent font-bold text-white px-5 py-3 rounded-lg shadow-lg mt-6">儲存設定</button>
                    </div>
                </section>
            </div>
            <div id="history-panel" class="panel hidden">
                 <div class="text-center text-gray-500 py-16">歷史紀錄功能正在開發中...</div>
            </div>
        </div>
    </main>

<script>
// --- GLOBAL STATE AND CONFIGURATION ---
const GOOGLE_CLIENT_ID = "733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com";
const GOOGLE_SCOPES = "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.profile";

const state = {
    gapiReady: false,
    gisReady: false,
    tokenClient: null,
    accessToken: null,
    userProfile: null,
    driveFolderId: null,
    apiKeys: {
        google: null, searchEngineId: null, driveFolderName: 'Market_Analysis_Data'
    },
    isApiReady: false,
    currentStep: 1,
    analysisData: {
        context: null,
        initialCompetitors: [],
        keywords: [],
        finalCompetitors: []
    },
    sortState: {
        keywords: { key: 'volume', order: 'desc' },
        competitors: { key: 'brandName', order: 'asc' }
    }
};

const ui = {
    authorizeButton: document.getElementById('authorize_button'),
    signOutButton: document.getElementById('signout_button'),
    userProfileDiv: document.getElementById('user-profile'),
    userNameSpan: document.getElementById('user-name'),
    userAvatarImg: document.getElementById('user-avatar'),
    appContainer: document.getElementById('app-container'),
    saveSettingsBtn: document.getElementById('save-settings-btn'),
    startAnalysisBtn: document.getElementById('start-analysis-btn'),
    analyzeSelectedBtn: document.getElementById('analyze-selected-btn'),
    selectAllCompetitors: document.getElementById('select-all-competitors'),
    loadingIndicator: document.getElementById('loading-indicator'),
    spinner: document.querySelector('.spinner'),
    loadingStatus: document.getElementById('loading-status'),
    resultsContainer: document.getElementById('results-container'),
    saveAnalysisBtn: document.getElementById('save-analysis-btn'),
    exportExcelBtn: document.getElementById('export-excel-btn'),
};

// --- INITIALIZATION ---
window.onload = function() {
    setupGapi();
    setupEventListeners();
};

function setupGapi() {
    const gapiScript = document.createElement('script');
    gapiScript.src = 'https://apis.google.com/js/api.js';
    gapiScript.onload = () => gapi.load('client', () => {
        state.gapiReady = true;
        updateUIState();
    });
    document.body.appendChild(gapiScript);

    const gisScript = document.createElement('script');
    gisScript.src = 'https://accounts.google.com/gsi/client';
    gisScript.async = true;
    gisScript.defer = true;
    gisScript.onload = () => {
        state.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: GOOGLE_SCOPES,
            callback: gisInCallback,
        });
        state.gisReady = true;
        updateUIState();
    };
    document.body.appendChild(gisScript);
}

function setupEventListeners() {
    ui.authorizeButton.onclick = () => state.tokenClient.requestAccessToken();
    ui.signOutButton.onclick = handleSignOut;
    ui.saveSettingsBtn.onclick = handleSaveSettings;
    ui.startAnalysisBtn.onclick = startInitialAnalysis;
    ui.analyzeSelectedBtn.onclick = processAndAnalyzeCompetitors;
    ui.selectAllCompetitors.onchange = (e) => {
        document.querySelectorAll('.competitor-checkbox').forEach(cb => cb.checked = e.target.checked);
    };
    document.querySelectorAll('.tab-main').forEach(btn => btn.addEventListener('click', handleMainTabSwitch));
    ui.saveAnalysisBtn.onclick = saveAnalysisToDrive;
    ui.exportExcelBtn.onclick = exportToExcel;
}

// --- UI & STATE MANAGEMENT ---
function updateUIState() {
    const loggedIn = !!state.accessToken;
    ui.authorizeButton.classList.toggle('hidden', loggedIn);
    ui.userProfileDiv.classList.toggle('hidden', !loggedIn);
    ui.appContainer.classList.toggle('locked', !loggedIn);

    if (!loggedIn) {
        goToStep(1); // Reset to first step on logout
        showAlert('請先登入', '登入 Google 帳號以開始使用。', 'info');
    } else if (!state.isApiReady) {
        handleMainTabSwitch({ target: document.querySelector('[data-tab="settings"]') });
        showAlert('請先設定 API', '請在 API 設定頁面填寫必要的金鑰。', 'warning');
    }
}

function showAlert(title, message, type = 'info') {
    const alertContainer = document.getElementById('alert-container');
    const colors = {
        success: { bg: 'bg-green-500', text: 'text-white' },
        error: { bg: 'bg-red-500', text: 'text-white' },
        warning: { bg: 'bg-yellow-400', text: 'text-black' },
        info: { bg: 'bg-blue-500', text: 'text-white' }
    };
    const alertDiv = document.createElement('div');
    alertDiv.className = `rounded-lg shadow-lg px-5 py-3 mb-2 font-bold ${colors[type].bg} ${colors[type].text} transition-all duration-300 opacity-0 transform translate-x-10`;
    alertDiv.innerHTML = `<strong>${title}</strong> <span class="font-normal">${message}</span>`;
    alertContainer.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.opacity = '1';
        alertDiv.style.transform = 'translateX(0)';
    }, 10);
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        alertDiv.style.transform = 'translateX(10px)';
        alertDiv.addEventListener('transitionend', () => alertDiv.remove());
    }, 5000);
}

function handleMainTabSwitch(event) {
    const btn = event.target.closest('.tab-main');
    if (!btn || btn.classList.contains('active')) return;

    document.querySelectorAll('.tab-main').forEach(tab => tab.classList.remove('active'));
    btn.classList.add('active');

    const tabName = btn.dataset.tab;
    document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
    document.getElementById(`${tabName}-panel`).classList.add('active');
}

function setLoadingState(isLoading, message = '') {
    ui.loadingIndicator.classList.toggle('hidden', !isLoading);
    ui.loadingIndicator.classList.toggle('flex', isLoading);
    ui.resultsContainer.classList.toggle('hidden', isLoading);

    ui.loadingStatus.textContent = message;

    ui.startAnalysisBtn.disabled = isLoading;
    ui.analyzeSelectedBtn.disabled = isLoading;
    document.querySelectorAll('.step-circle').forEach(c => c.style.pointerEvents = isLoading ? 'none' : 'auto');
}

// --- STEPPER NAVIGATION ---
window.goToStep = function(step) {
    if (step > state.currentStep) return;
    if (step === 3 && state.analysisData.finalCompetitors.length === 0) return;
    if (step === 2 && state.analysisData.initialCompetitors.length === 0) return;

    document.querySelectorAll('.step-panel').forEach(p => p.classList.add('hidden'));
    document.getElementById(`step-${step}-content`).classList.remove('hidden');

    document.querySelectorAll('.step').forEach((s) => {
        s.classList.remove('active', 'completed');
        const currentStepNum = parseInt(s.id.split('-')[1]);
        if (currentStepNum < step) {
            s.classList.add('completed');
        } else if (currentStepNum === step) {
            s.classList.add('active');
        }
    });
    if(step < state.currentStep) state.currentStep = step;
}

function advanceStep(step) {
    state.currentStep = step;
    goToStep(step);
}

// --- AUTHENTICATION & SETTINGS ---
async function gisInCallback(response) {
    if (response.error) { showAlert('登入失敗', response.error, 'error'); return; }
    state.accessToken = response.access_token;
    gapi.client.setToken({ access_token: state.accessToken });
    await updateUserInfo();
    updateUIState();
    if (state.isApiReady) await findOrCreateDriveFolder();
}

async function updateUserInfo() {
    try {
        const res = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', { headers: { 'Authorization': `Bearer ${state.accessToken}` } });
        if (!res.ok) throw new Error('無法獲取用戶資訊');
        const profile = await res.json();
        state.userProfile = profile;
        ui.userNameSpan.textContent = profile.name;
        ui.userAvatarImg.src = profile.picture;
        showAlert('登入成功', `歡迎您，${profile.name}！`, 'success');
    } catch (error) {
        showAlert('錯誤', '無法獲取用戶個人資料。', 'error');
        handleSignOut();
    }
}

function handleSignOut() {
    state.accessToken = null; state.userProfile = null; state.driveFolderId = null;
    gapi.client.setToken(null);
    updateUIState();
    showAlert('已登出', '您已成功登出。');
}

async function handleSaveSettings() {
    state.apiKeys.google = document.getElementById('google-api-key').value.trim();
    state.apiKeys.searchEngineId = document.getElementById('search-engine-id').value.trim();
    state.apiKeys.driveFolderName = document.getElementById('drive-folder-name').value.trim() || 'Market_Analysis_Data';

    if (state.apiKeys.google && state.apiKeys.searchEngineId) {
        state.isApiReady = true;
        showAlert('設定已儲存', 'API 已設定完成。', 'success');
        handleMainTabSwitch({ target: document.querySelector('[data-tab="analysis"]') });
        if (state.accessToken) await findOrCreateDriveFolder();
    } else {
        state.isApiReady = false;
        showAlert('設定不完整', '請填寫 Google API 金鑰和搜尋引擎 ID。', 'warning');
    }
}

// --- CORE ANALYSIS WORKFLOW ---
function validateInputFields() {
    const context = getSearchContext();
    const hasInput = context.topic || context.industry || context.product;
    if (!hasInput) {
        showAlert('輸入不足', '請至少填寫分析主題、產品或產業名稱。', 'warning');
    }
    return hasInput;
}

function getSearchContext() {
    return {
        topic: document.getElementById('topic')?.value.trim(),
        businessModel: document.querySelector('input[name="business-model"]:checked').value,
        country: document.getElementById('country').value,
        language: document.getElementById('language').value,
        industry: document.getElementById('industry').value.trim(),
        sector: document.getElementById('sector').value.trim(),
        product: document.getElementById('product').value.trim(),
        company: document.getElementById('company').value.trim(),
    };
}

async function startInitialAnalysis() {
    if (!validateInputFields()) return;
    
    state.analysisData = { context: getSearchContext(), initialCompetitors: [], keywords: [], finalCompetitors: [] };
    
    setLoadingState(true, '正在產生 AI 建議列表...');
    
    try {
        const [keywords, competitorNames] = await Promise.all([
            getAiKeywordSuggestions(state.analysisData.context),
            getAiCompetitorNames(state.analysisData.context)
        ]);

        state.analysisData.keywords = keywords || [];
        state.analysisData.initialCompetitors = competitorNames || [];

        if (competitorNames.length === 0) {
            showAlert('查無競爭對手', 'AI 未能找到相關對手，請直接進入報告頁面查看關鍵字。', 'info');
            renderFullReport(); 
            advanceStep(3);
        } else {
            renderCompetitorSelection(competitorNames);
            advanceStep(2);
        }
    } catch (error) {
        showAlert('分析失敗', `步驟一失敗: ${error.message}`, 'error');
    } finally {
        setLoadingState(false);
    }
}

function processAndAnalyzeCompetitors() {
    const selectedAINames = Array.from(document.querySelectorAll('.competitor-checkbox:checked')).map(cb => cb.value);
    const supplementalInput = document.getElementById('supplemental-competitors').value;
    const supplementalNames = supplementalInput.split(/[\n,]/).map(name => name.trim()).filter(Boolean);
    const finalCompetitorList = [...new Set([...selectedAINames, ...supplementalNames])];
    
    if (finalCompetitorList.length === 0) {
        showAlert("未指定對手", "請至少勾選或補充一個競爭對手進行分析。", "warning");
        return;
    }

    analyzeCompetitors(finalCompetitorList);
}


async function analyzeCompetitors(competitorNames) {
    advanceStep(3);
    setLoadingState(true, `正在分析 ${competitorNames.length} 個競爭對手...`);

    try {
        const competitorPromises = competitorNames.map(name => getFullCompetitorDetails(name, state.analysisData.context));
        const competitorDetails = await Promise.all(competitorPromises);
        
        state.analysisData.finalCompetitors = competitorDetails.filter(Boolean);
        
        renderFullReport();
        showAlert('分析完成', `已成功取得 ${state.analysisData.finalCompetitors.length} 家競爭對手的詳細資料。`, 'success');

    } catch (error) {
        showAlert('分析失敗', `步驟二失敗: ${error.message}`, 'error');
    } finally {
        setLoadingState(false);
    }
}

// --- GOOGLE API & AI PROMPTS ---
async function callGemini(prompt) {
    const apiKey = state.apiKeys.google;
    if (!apiKey) throw new Error('Google API 金鑰未設定。');
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
    const body = { contents: [{ parts: [{ text: prompt }] }] };
    const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`Gemini API 錯誤: ${errorData.error?.message || response.statusText}`);
    }
    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) throw new Error('Gemini 回傳內容為空。');
    try {
        const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```|(\[.*\])|(\{.*\})/s);
        if (!jsonMatch) throw new Error('回傳的內容不包含有效的 JSON 格式。');
        return JSON.parse(jsonMatch[1] || jsonMatch[2] || jsonMatch[3]);
    } catch (e) {
        console.error("Gemini JSON parsing error:", e, "\nOriginal text:", text);
        throw new Error('Gemini 回傳格式解析失敗，請查看控制台日誌。');
    }
}

async function searchGoogle(query) {
    const apiKey = state.apiKeys.google;
    const cx = state.apiKeys.searchEngineId;
    if (!apiKey || !cx) throw new Error('Google API 金鑰或搜尋引擎 ID 未設定。');
    const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=${encodeURIComponent(query)}`;
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Custom Search API 錯誤: ${response.statusText}`);
        const data = await response.json();
        return data.items?.[0]?.link || null;
    } catch (error) {
        console.error(`Google Search for "${query}" failed:`, error);
        return null;
    }
}

async function getAiKeywordSuggestions(context) {
    const prompt = `You are a world-class SEO expert. Based on the following criteria, generate as many relevant SEO keywords as possible, aiming for 40-50, in the specified language. Critically, tailor keywords to the "businessModel". Also provide estimated search volume (高/中/低), type, and bidding competition (高/中/低). Output MUST be a valid JSON array of objects, with NO other text. Criteria: ${JSON.stringify(context)}. Format: [{"keyword": "...", "volume": "...", "type": "...", "biddingCompetition": "..."}, ...].`;
    return callGemini(prompt);
}

async function getAiCompetitorNames(context) {
    const prompt = `You are a market analysis expert. Based on the criteria below, identify the top 10 competitors. Output MUST be a valid JSON array of strings, with NO other text. Criteria: ${JSON.stringify(context)}. Format: ["Competitor A", "Competitor B", ...].`;
    return callGemini(prompt);
}

async function getFullCompetitorDetails(name, context) {
    const prompt = `Analyze the company "${name}", a competitor in the market of "${context.topic}". Find its official stock ticker, headquarters state/province, and postal code. Output MUST be a single valid JSON object. If a value isn't found, use null. Criteria: ${JSON.stringify(context)}. Format: {"brandName": "${name}", "country": "...", "summary": "...", "companyType": "...", "stockTicker": "e.g., AAPL", "state": "e.g., California", "postalCode": "e.g., 95014"}`;
    const detailPromise = callGemini(prompt);
    const websitePromise = searchGoogle(`${name} ${context.industry || ''} official website`);
    const linkedinPromise = searchGoogle(`site:linkedin.com/company/ ${name}`);
    const [details, websiteUrl, linkedinUrl] = await Promise.all([detailPromise.catch(e => ({ brandName: name })), websitePromise, linkedinPromise]);
    return { ...details, websiteUrl, linkedinUrl };
}

// --- RESULT RENDERING ---
function renderCompetitorSelection(competitorNames) {
    const listEl = document.getElementById('competitor-checkbox-list');
    listEl.innerHTML = competitorNames.map(name => `
        <label class="block p-3 rounded-lg hover:bg-techprimary/20 transition-colors bg-techbg cursor-pointer">
            <input type="checkbox" class="competitor-checkbox mr-3 accent-techaccent" value="${name}" checked>
            <span>${name}</span>
        </label>
    `).join('');
    document.getElementById('supplemental-competitors').value = '';
}

function renderFullReport() {
    renderCompetitorResults();
    renderKeywordResults();
}

function renderCompetitorResults() {
    const card = document.getElementById('competitors-result-card');
    const data = state.analysisData.finalCompetitors || [];
    let content = `<h3 class="text-xl font-bold mb-4 text-techaccent">A. 競爭對手分析</h3>`;

    if (data.length === 0) {
        card.innerHTML = content + '<p class="text-gray-500">沒有要顯示的競爭對手資料。</p>';
        return;
    }
    const headers = ['品牌', '國家', '股票代號', '州別', '郵遞區號', '連結'];
    const keys = ['brandName', 'country', 'stockTicker', 'state', 'postalCode', 'links'];
    const sortedData = sortData('competitors', data);

    content += `<div class="overflow-x-auto result-panel">
        <table class="w-full text-left text-sm">
        <thead class="bg-gray-900 sticky top-0 z-10"><tr class="border-b border-techprimary/30">
        ${headers.map((h, i) => `<th class="py-3 px-3 cursor-pointer" onclick="sortTable('competitors', '${keys[i]}')">${h}${getSortIcon('competitors', keys[i])}</th>`).join('')}
        </tr></thead><tbody>
        ${sortedData.map(item => `
            <tr class="border-b border-techprimary/20 hover:bg-techprimary/10">
                <td class="font-semibold">${item.brandName || '-'}</td>
                <td>${item.country || '-'}</td>
                <td>${item.stockTicker || '-'}</td>
                <td>${item.state || '-'}</td>
                <td>${item.postalCode || '-'}</td>
                <td class="flex gap-4 items-center">
                    ${item.websiteUrl ? `<a href="${item.websiteUrl}" target="_blank" title="官方網站" class="text-gray-400 hover:text-techaccent"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></a>` : ''}
                    ${item.linkedinUrl ? `<a href="${item.linkedinUrl}" target="_blank" title="LinkedIn" class="text-gray-400 hover:text-techaccent"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a>` : ''}
                </td>
            </tr>
        `).join('')}
        </tbody></table></div>`;
    card.innerHTML = content;
}

function renderKeywordResults() {
    const card = document.getElementById('keywords-result-card');
    const data = state.analysisData.keywords || [];
    let content = `<h3 class="text-xl font-bold mb-4 text-techaccent">B. 關鍵字建議</h3>`;
    if (data.length === 0) {
        card.innerHTML = content + '<p class="text-gray-500">沒有要顯示的關鍵字資料。</p>'; return;
    }
    const headers = ['關鍵字', '搜尋量級', '出價競爭', '類型'];
    const keys = ['keyword', 'volume', 'biddingCompetition', 'type'];
    const sortedData = sortData('keywords', data);
    const getBadgeClass = (value) => {
        const lower = String(value).toLowerCase();
        if (lower === '高' || lower === 'high') return 'badge-high';
        if (lower === '中' || lower === 'medium') return 'badge-mid';
        if (lower === '低' || lower === 'low') return 'badge-low';
        return 'badge-unknown';
    };
    content += `<div class="overflow-x-auto result-panel"><table class="w-full text-left text-sm">
        <thead class="bg-gray-900 sticky top-0 z-10"><tr class="border-b border-techprimary/30">
        ${headers.map((h, i) => `<th class="py-3 px-3 cursor-pointer" onclick="sortTable('keywords', '${keys[i]}')">${h}${getSortIcon('keywords', keys[i])}</th>`).join('')}
        </tr></thead><tbody>
        ${sortedData.map(item => `
            <tr class="border-b border-techprimary/20 hover:bg-techprimary/10">
                <td>${item.keyword || '-'}</td>
                <td><span class="badge ${getBadgeClass(item.volume)}">${item.volume || 'N/A'}</span></td>
                <td><span class="badge ${getBadgeClass(item.biddingCompetition)}">${item.biddingCompetition || 'N/A'}</span></td>
                <td>${item.type || '-'}</td>
            </tr>
        `).join('')}
        </tbody></table></div>`;
    card.innerHTML = content;
}

// --- DATA SORTING & UTILS ---
function getSortIcon(type, key) {
    if (state.sortState[type].key !== key) return '';
    return state.sortState[type].order === 'asc' ? ' ▲' : ' ▼';
}
window.sortTable = function(type, key) {
    const sortState = state.sortState[type];
    if (sortState.key === key) {
        sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
    } else {
        sortState.key = key;
        sortState.order = (key === 'volume' || key === 'biddingCompetition') ? 'desc' : 'asc';
    }
    if (type === 'keywords') renderKeywordResults();
    if (type === 'competitors') renderCompetitorResults();
};
function sortData(type, data) {
    const { key, order } = state.sortState[type];
    if (!key || !data) return data;
    const competitionMap = { '高': 3, '中': 2, '低': 1 };
    return [...data].sort((a, b) => {
        let aVal = a[key] || '', bVal = b[key] || '';
        if (key === 'volume' || key === 'biddingCompetition') {
            aVal = competitionMap[aVal] || 0;
            bVal = competitionMap[bVal] || 0;
            return order === 'asc' ? aVal - bVal : bVal - aVal;
        }
        return order === 'asc' ? String(aVal).localeCompare(String(bVal)) : String(bVal).localeCompare(String(aVal));
    });
}

// --- ACTIONS (SAVE, EXPORT) ---
function exportToExcel() {
    if (state.analysisData.finalCompetitors.length === 0 && state.analysisData.keywords.length === 0) {
        return showAlert("無法匯出", "目前沒有可匯出的分析結果。", "warning");
    }
    const wb = XLSX.utils.book_new();
    if (state.analysisData.finalCompetitors.length > 0) {
        const sheetData = state.analysisData.finalCompetitors.map(c => ({
            '品牌名稱': c.brandName, '國家': c.country, '摘要': c.summary, '公司類型': c.companyType,
            '股票代號': c.stockTicker, '州別': c.state, '郵遞區號': c.postalCode,
            '官方網站': c.websiteUrl, 'LinkedIn': c.linkedinUrl
        }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetData), "A_競爭對手分析");
    }
    if (state.analysisData.keywords.length > 0) {
        const sheetData = state.analysisData.keywords.map(k => ({ '關鍵字': k.keyword, '搜尋量級': k.volume, '出價競爭': k.biddingCompetition, '類型': k.type }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetData), "B_關鍵字建議");
    }
    const fileName = `${state.analysisData.context.topic || '市場分析'}_${new Date().toISOString().slice(0, 10)}.xlsx`;
    XLSX.writeFile(wb, fileName);
    showAlert('匯出成功', `已產生檔案 ${fileName}`, 'success');
}

async function saveAnalysisToDrive() {
    if (!state.driveFolderId) return showAlert('錯誤', '無法找到 Drive 目標資料夾。', 'error');
    if (state.analysisData.finalCompetitors.length === 0 && state.analysisData.keywords.length === 0) return showAlert('尚無結果', '請先執行分析。', 'warning');
    setLoadingState(true, '正在儲存至 Google Drive...');
    try {
        const fileContent = JSON.stringify(state.analysisData, null, 2);
        const blob = new Blob([fileContent], { type: 'application/json' });
        const fileName = `分析報告_${state.analysisData.context.topic || '市場'}_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
        const metadata = { name: fileName, mimeType: 'application/json', parents: [state.driveFolderId] };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', blob);
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${state.accessToken}` },
            body: form
        });
        if (!response.ok) throw new Error((await response.json()).error?.message || '未知上傳錯誤');
        showAlert('儲存成功', `分析結果已儲存至您的 Drive 資料夾。`, 'success');
    } catch (error) {
        showAlert('存檔失敗', error.message, 'error');
    } finally {
        setLoadingState(false);
    }
}

async function findOrCreateDriveFolder() {
    try {
        await gapi.client.load('drive', 'v3');
        const folderName = state.apiKeys.driveFolderName;
        const response = await gapi.client.drive.files.list({ q: `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`, fields: 'files(id)' });
        if (response.result.files && response.result.files.length > 0) {
            state.driveFolderId = response.result.files[0].id;
        } else {
            const createResponse = await gapi.client.drive.files.create({ resource: { 'name': folderName, 'mimeType': 'application/vnd.google-apps.folder' }, fields: 'id' });
            state.driveFolderId = createResponse.result.id;
        }
    } catch (error) {
        console.error('Drive folder error:', error);
        showAlert('Drive 錯誤', `存取資料夾失敗: ${error.result?.error?.message || '未知錯誤'}`, 'error');
    }
}
</script>
</body>
</html>
