<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自動化媒體提案引擎 (台灣市場特化版 MVP)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.1);
        }
        .btn-primary:disabled {
            background: #a5b4fc;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        #proposalOutput h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #60a5fa;
            padding-bottom: 0.5rem;
        }
        #proposalOutput h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1d4ed8;
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
        }
        #proposalOutput p, #proposalOutput li, #proposalOutput td, #proposalOutput th {
            color: #374151;
            line-height: 1.7;
        }
        #proposalOutput p, #proposalOutput ul {
             margin-bottom: 1rem;
        }
        #proposalOutput ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        #proposalOutput strong {
            color: #1e40af;
            font-weight: 600;
        }
        .status-update {
            transition: all 0.5s ease;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
        }
        .status-update.active {
            max-height: 100px; /* or a suitable max-height */
            opacity: 1;
            margin-top: 1rem;
        }
        .input-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .input-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        #proposalOutput table {
            width: 100%;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border-collapse: collapse;
        }
        #proposalOutput th, #proposalOutput td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
        }
        #proposalOutput th {
            background-color: #f9fafb;
            font-weight: 600;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-6xl mx-auto">
        <div class="card p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">自動化媒體提案引擎</h1>
                <p class="mt-2 text-gray-600">v2.5 安全金鑰版 (MVP)</p>
            </div>

            <!-- Module 1: 使用者與配置介面 ('駕駛艙') -->
            <div class="space-y-6">
                 <!-- API 金鑰輸入 -->
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <label for="apiKeyInput" class="block text-sm font-medium text-yellow-800 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 8a6 6 0 11-12 0 6 6 0 0112 0zM7 8a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd"></path></svg>
                        Google Gemini API 金鑰 <span class="text-red-500 ml-1">*</span>
                    </label>
                    <input type="password" id="apiKeyInput" class="mt-1 block w-full px-3 py-2 border border-yellow-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="請在此貼上您的 API 金鑰">
                    <p class="mt-2 text-xs text-yellow-700">此金鑰僅存於您目前的瀏覽器分頁，關閉後即消失，不會被儲存。</p>
                </div>
                
                <!-- Project ID 輸入 -->
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <label for="projectIdInput" class="block text-sm font-medium text-blue-800 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v2a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                        專案 ID <span class="text-gray-500 ml-1">(可選)</span>
                    </label>
                    <input type="text" id="projectIdInput" class="mt-1 block w-full px-3 py-2 border border-blue-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="請輸入專案 ID (可選)">
                    <p class="mt-2 text-xs text-blue-700">如無專案ID，系統將自動產生臨時ID用於檔案命名</p>
                </div>
                
                <!-- 集中化資料夾管理設定 -->
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <label class="block text-sm font-medium text-green-800 flex items-center mb-3">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H8a3 3 0 00-3 3v1.5a1.5 1.5 0 01-3 0V6z" clip-rule="evenodd"></path><path d="M6 12a2 2 0 012-2h8a2 2 0 012 2v2a2 2 0 01-2 2H2h2a2 2 0 01-2-2v-2z"></path></svg>
                        集中化資料夾管理 <span class="text-gray-500 ml-1">(可選)</span>
                    </label>
                    <div class="space-y-3">
                        <div>
                            <label for="centralFolderName" class="block text-xs font-medium text-green-700">主要專案資料夾名稱</label>
                            <input type="text" id="centralFolderName" class="mt-1 block w-full px-3 py-2 border border-green-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" value="iStaging_專案管理" placeholder="例如: iStaging_專案管理">
                        </div>
                        <div>
                            <label for="mediaplanSubfolder" class="block text-xs font-medium text-green-700">媒體提案子資料夾名稱</label>
                            <input type="text" id="mediaplanSubfolder" class="mt-1 block w-full px-3 py-2 border border-green-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" value="02_媒體提案" placeholder="例如: 02_媒體提案">
                        </div>
                    </div>
                    <p class="mt-2 text-xs text-green-700">設定後將自動建立專案資料夾結構並儲存結果</p>
                </div>

                <div class="border-t border-gray-200 pt-6">
                    <div class="input-grid">
                        <div>
                            <label for="targetBrand" class="block text-sm font-medium text-gray-700">目標品牌 / 產品 <span class="text-red-500">*</span></label>
                            <input type="text" id="targetBrand" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：gogoro, 星宇航空">
                        </div>
                        <div>
                            <label for="competitorBrand" class="block text-sm font-medium text-gray-700">主要競爭對手 <span class="text-red-500">*</span></label>
                            <input type="text" id="competitorBrand" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：光陽, 長榮航空">
                        </div>
                         <div>
                            <label for="industry" class="block text-sm font-medium text-gray-700">目標市場 / 產業 <span class="text-red-500">*</span></label>
                            <select id="industry" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option>消費性電子產品</option>
                                <option>時尚服飾與配件</option>
                                <option>美妝保養</option>
                                <option>旅遊與航空服務</option>
                                <option>餐飲業</option>
                                <option>B2B 軟體服務</option>
                                <option>金融與保險服務</option>
                                <option>其他</option>
                            </select>
                        </div>
                        <div>
                            <label for="businessModel" class="block text-sm font-medium text-gray-700">商業模式 <span class="text-red-500">*</span></label>
                             <select id="businessModel" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="B2C">B2C (企業對消費者)</option>
                                <option value="B2B">B2B (企業對企業)</option>
                            </select>
                        </div>
                         <div>
                            <label for="salesChannels" class="block text-sm font-medium text-gray-700">主要銷售通路</label>
                            <input type="text" id="salesChannels" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：線上官網、MOMO、實體門市">
                        </div>
                        <div>
                            <label for="targetAudience" class="block text-sm font-medium text-gray-700">目標人群描述</label>
                            <input type="text" id="targetAudience" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：25-35歲都會女性、科技業採購主管">
                        </div>
                         <div class="md:col-span-3">
                            <label for="advertisingBudget" class="block text-sm font-medium text-gray-700">預計廣告預算 (台幣)</label>
                            <input type="number" id="advertisingBudget" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：300000">
                        </div>
                    </div>
                </div>

                <!-- B2B 專業市場分析設定 -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        B2B 專業市場分析設定
                    </h3>
                    <div class="input-grid">
                        <div>
                            <label for="targetCompanySize" class="block text-sm font-medium text-gray-700">目標企業規模</label>
                            <select id="targetCompanySize" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="startup">新創企業 (1-50人)</option>
                                <option value="sme">中小企業 (51-500人)</option>
                                <option value="mid-market">中型企業 (501-2000人)</option>
                                <option value="enterprise">大型企業 (2000+人)</option>
                                <option value="mixed">混合型企業</option>
                            </select>
                        </div>
                        <div>
                            <label for="decisionMakerRole" class="block text-sm font-medium text-gray-700">主要決策者角色</label>
                            <select id="decisionMakerRole" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="ceo">CEO/總經理</option>
                                <option value="cto">CTO/技術長</option>
                                <option value="cfo">CFO/財務長</option>
                                <option value="cmo">CMO/行銷長</option>
                                <option value="cio">CIO/資訊長</option>
                                <option value="procurement">採購經理</option>
                                <option value="department-head">部門主管</option>
                                <option value="influencer">影響者/推薦者</option>
                            </select>
                        </div>
                        <div>
                            <label for="purchaseCycle" class="block text-sm font-medium text-gray-700">採購週期</label>
                            <select id="purchaseCycle" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="immediate">立即採購 (1-30天)</option>
                                <option value="short">短期採購 (1-3個月)</option>
                                <option value="medium">中期採購 (3-6個月)</option>
                                <option value="long">長期採購 (6-12個月)</option>
                                <option value="strategic">策略性採購 (1年以上)</option>
                            </select>
                        </div>
                        <div>
                            <label for="budgetRange" class="block text-sm font-medium text-gray-700">預算範圍</label>
                            <select id="budgetRange" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="low">低預算 (10萬以下)</option>
                                <option value="medium">中等預算 (10-50萬)</option>
                                <option value="high">高預算 (50-200萬)</option>
                                <option value="enterprise">企業級預算 (200萬以上)</option>
                                <option value="unlimited">無限制預算</option>
                            </select>
                        </div>
                        <div>
                            <label for="painPoints" class="block text-sm font-medium text-gray-700">主要痛點</label>
                            <input type="text" id="painPoints" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：效率低下、成本過高、技術落後">
                        </div>
                        <div>
                            <label for="successMetrics" class="block text-sm font-medium text-gray-700">成功指標</label>
                            <input type="text" id="successMetrics" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：ROI、效率提升、成本節省">
                        </div>
                        <div class="md:col-span-3">
                            <label for="competitiveAdvantage" class="block text-sm font-medium text-gray-700">競爭優勢</label>
                            <textarea id="competitiveAdvantage" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="請描述相對於競爭對手的核心優勢，例如：技術領先、服務品質、價格優勢、本地化支援等"></textarea>
                        </div>
                        <div class="md:col-span-3">
                            <label for="industryChallenges" class="block text-sm font-medium text-gray-700">產業挑戰</label>
                            <textarea id="industryChallenges" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="請描述目標產業面臨的主要挑戰，例如：數位轉型壓力、人才短缺、法規變更、市場競爭等"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 跨國市場策略設定 -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        跨國市場策略設定
                    </h3>
                    <div class="input-grid">
                        <div>
                            <label for="targetMarkets" class="block text-sm font-medium text-gray-700">目標市場 <span class="text-red-500">*</span></label>
                            <select id="targetMarkets" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="single">單一市場 (台灣)</option>
                                <option value="multi-asia">多國亞洲市場</option>
                                <option value="global">全球市場</option>
                                <option value="custom">自訂市場組合</option>
                            </select>
                        </div>
                        <div>
                            <label for="primaryMarket" class="block text-sm font-medium text-gray-700">主要市場</label>
                            <select id="primaryMarket" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="taiwan">台灣</option>
                                <option value="japan">日本</option>
                                <option value="us">美國</option>
                                <option value="india">印度</option>
                                <option value="germany">德國</option>
                            </select>
                        </div>
                        <div>
                            <label for="secondaryMarkets" class="block text-sm font-medium text-gray-700">次要市場</label>
                            <input type="text" id="secondaryMarkets" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：日本、新加坡、香港">
                        </div>
                        <div>
                            <label for="marketEntryStrategy" class="block text-sm font-medium text-gray-700">市場進入策略</label>
                            <select id="marketEntryStrategy" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="organic">有機成長</option>
                                <option value="aggressive">積極擴張</option>
                                <option value="partnership">策略聯盟</option>
                                <option value="acquisition">併購進入</option>
                                <option value="franchise">特許經營</option>
                            </select>
                        </div>
                        <div>
                            <label for="localizationLevel" class="block text-sm font-medium text-gray-700">本地化程度</label>
                            <select id="localizationLevel" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="minimal">最小本地化</option>
                                <option value="moderate">中度本地化</option>
                                <option value="high">高度本地化</option>
                                <option value="full">完全本地化</option>
                            </select>
                        </div>
                        <div>
                            <label for="culturalSensitivity" class="block text-sm font-medium text-gray-700">文化敏感度</label>
                            <select id="culturalSensitivity" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="low">低 (標準化策略)</option>
                                <option value="medium">中 (適度調整)</option>
                                <option value="high">高 (深度文化適應)</option>
                                <option value="critical">關鍵 (文化優先)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 跨國溝通策略設定 -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        跨國溝通策略設定
                    </h3>
                    <div class="input-grid">
                        <div>
                            <label for="communicationStrategy" class="block text-sm font-medium text-gray-700">溝通策略類型</label>
                            <select id="communicationStrategy" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="global">全球統一策略</option>
                                <option value="glocal">全球在地化</option>
                                <option value="local">完全在地化</option>
                                <option value="hybrid">混合策略</option>
                            </select>
                        </div>
                        <div>
                            <label for="languageStrategy" class="block text-sm font-medium text-gray-700">語言策略</label>
                            <select id="languageStrategy" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="english">英語為主</option>
                                <option value="local">當地語言</option>
                                <option value="multilingual">多語言並行</option>
                                <option value="translation">翻譯策略</option>
                            </select>
                        </div>
                        <div>
                            <label for="toneStrategy" class="block text-sm font-medium text-gray-700">語調策略</label>
                            <select id="toneStrategy" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="formal">正式專業</option>
                                <option value="casual">輕鬆親切</option>
                                <option value="luxury">奢華高端</option>
                                <option value="youthful">年輕活力</option>
                                <option value="adaptive">適應性語調</option>
                            </select>
                        </div>
                        <div>
                            <label for="channelStrategy" class="block text-sm font-medium text-gray-700">通路策略</label>
                            <select id="channelStrategy" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="digital">數位優先</option>
                                <option value="traditional">傳統媒體</option>
                                <option value="omnichannel">全通路整合</option>
                                <option value="social">社群媒體</option>
                                <option value="influencer">網紅行銷</option>
                            </select>
                        </div>
                        <div>
                            <label for="timingStrategy" class="block text-sm font-medium text-gray-700">時機策略</label>
                            <select id="timingStrategy" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="simultaneous">同步發布</option>
                                <option value="staggered">分階段發布</option>
                                <option value="localized">當地時機</option>
                                <option value="event-driven">事件驅動</option>
                            </select>
                        </div>
                        <div>
                            <label for="crisisManagement" class="block text-sm font-medium text-gray-700">危機管理策略</label>
                            <select id="crisisManagement" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="centralized">中央化處理</option>
                                <option value="decentralized">分散化處理</option>
                                <option value="hybrid">混合處理</option>
                                <option value="localized">當地處理</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label for="culturalConsiderations" class="block text-sm font-medium text-gray-700">文化考量重點</label>
                            <textarea id="culturalConsiderations" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="請描述需要特別注意的文化敏感議題，例如：宗教禁忌、顏色象徵、數字禁忌等"></textarea>
                        </div>
                        <div class="md:col-span-3">
                            <label for="regulatoryRequirements" class="block text-sm font-medium text-gray-700">法規要求</label>
                            <textarea id="regulatoryRequirements" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="請描述各目標市場的廣告法規要求，例如：標示規定、內容限制、審查流程等"></textarea>
                        </div>
                    </div>
                </div>

                <button id="generateBtn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg flex items-center justify-center text-lg">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    生成 AI 分析報告
                </button>
            </div>

            <!-- 動態狀態更新區域 -->
            <div id="statusContainer" class="mt-4 space-y-2"></div>

            <!-- Module 4: 輸出與交付模組 ('渲染層') -->
            <div id="proposalOutput" class="mt-8 border-t-2 border-gray-200 pt-6">
                <!-- AI 生成的內容將會顯示在這裡 -->
            </div>
        </div>
        <footer class="text-center mt-4 text-sm text-gray-500">
            <p>本原型由 Google Gemini 驅動，所有分析皆為即時生成。</p>
        </footer>
    </div>

    <script type="module">
        // --- UI 元素 ---
        const apiKeyInput = document.getElementById('apiKeyInput');
        const projectIdInput = document.getElementById('projectIdInput');
        const generateBtn = document.getElementById('generateBtn');
        const targetBrandInput = document.getElementById('targetBrand');
        const competitorBrandInput = document.getElementById('competitorBrand');
        const industryInput = document.getElementById('industry');
        const businessModelInput = document.getElementById('businessModel');
        const salesChannelsInput = document.getElementById('salesChannels');
        const targetAudienceInput = document.getElementById('targetAudience');
        const advertisingBudgetInput = document.getElementById('advertisingBudget');
        const statusContainer = document.getElementById('statusContainer');
        const proposalOutput = document.getElementById('proposalOutput');

        // 跨國市場策略 UI 元素
        const targetMarketsInput = document.getElementById('targetMarkets');
        const primaryMarketInput = document.getElementById('primaryMarket');
        const secondaryMarketsInput = document.getElementById('secondaryMarkets');
        const marketEntryStrategyInput = document.getElementById('marketEntryStrategy');
        const localizationLevelInput = document.getElementById('localizationLevel');
        const culturalSensitivityInput = document.getElementById('culturalSensitivity');

        // 跨國溝通策略 UI 元素
        const communicationStrategyInput = document.getElementById('communicationStrategy');
        const languageStrategyInput = document.getElementById('languageStrategy');
        const toneStrategyInput = document.getElementById('toneStrategy');
        const channelStrategyInput = document.getElementById('channelStrategy');
        const timingStrategyInput = document.getElementById('timingStrategy');
        const crisisManagementInput = document.getElementById('crisisManagement');
        const culturalConsiderationsInput = document.getElementById('culturalConsiderations');
        const regulatoryRequirementsInput = document.getElementById('regulatoryRequirements');

        // B2B 專業市場分析 UI 元素
        const targetCompanySizeInput = document.getElementById('targetCompanySize');
        const decisionMakerRoleInput = document.getElementById('decisionMakerRole');
        const purchaseCycleInput = document.getElementById('purchaseCycle');
        const budgetRangeInput = document.getElementById('budgetRange');
        const painPointsInput = document.getElementById('painPoints');
        const successMetricsInput = document.getElementById('successMetrics');
        const competitiveAdvantageInput = document.getElementById('competitiveAdvantage');
        const industryChallengesInput = document.getElementById('industryChallenges');

        // 檢查必要元素是否存在
        if (!apiKeyInput || !projectIdInput || !generateBtn || !targetBrandInput || 
            !competitorBrandInput || !industryInput || !businessModelInput || 
            !salesChannelsInput || !targetAudienceInput || !advertisingBudgetInput || 
            !statusContainer || !proposalOutput || !targetMarketsInput || 
            !primaryMarketInput || !secondaryMarketsInput || !marketEntryStrategyInput ||
            !localizationLevelInput || !culturalSensitivityInput || !communicationStrategyInput ||
            !languageStrategyInput || !toneStrategyInput || !channelStrategyInput ||
            !timingStrategyInput || !crisisManagementInput || !culturalConsiderationsInput ||
            !regulatoryRequirementsInput || !targetCompanySizeInput || !decisionMakerRoleInput ||
            !purchaseCycleInput || !budgetRangeInput || !painPointsInput || !successMetricsInput ||
            !competitiveAdvantageInput || !industryChallengesInput) {
            console.error('某些必要的 UI 元素未找到，請檢查 HTML 結構');
            // 顯示錯誤訊息給用戶
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-50 flex items-center justify-center">
                    <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-6">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <h3 class="mt-4 text-lg font-medium text-gray-900">頁面載入錯誤</h3>
                            <p class="mt-2 text-sm text-gray-500">某些必要的 UI 元素未找到，請重新整理頁面或聯繫技術支援。</p>
                            <button onclick="location.reload()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                                重新整理頁面
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 全域變數儲存 project ID
        let currentProjectId = null;

        // 新增：集中化資料夾管理變數
        let folderStructure = {
            centralFolder: 'iStaging_專案管理',
            mediaplanSubfolder: '02_媒體提案'
        };
        let folderIds = {
            central: null,
            project: null,
            mediaplan: null
        };
        let isGoogleDriveEnabled = false;

        // 新增：從 URL 參數讀取 project ID
        function loadProjectIdFromUrl() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('projectId');
                if (projectId && projectIdInput) {
                    projectIdInput.value = projectId;
                    currentProjectId = projectId;
                    console.log('從 URL 讀取到專案 ID:', projectId);
                }
            } catch (error) {
                console.warn('讀取 URL 參數失敗:', error);
            }
        }

        // 頁面載入時讀取 project ID
        loadProjectIdFromUrl();

        // 綁定事件監聽器（只有在元素存在時才綁定）
        if (generateBtn) {
            generateBtn.addEventListener('click', handleGenerateClick);
        } else {
            console.error('生成按鈕未找到，無法綁定事件');
        }

        // 目標市場選擇的動態功能
        if (targetMarketsInput) {
            targetMarketsInput.addEventListener('change', function() {
                const selectedMarket = this.value;
                updateMarketFields(selectedMarket);
            });
        }

        // 更新市場相關欄位的顯示和預設值
        function updateMarketFields(selectedMarket) {
            const secondaryMarketsField = document.getElementById('secondaryMarkets');
            const primaryMarketField = document.getElementById('primaryMarket');
            const localizationField = document.getElementById('localizationLevel');
            const culturalSensitivityField = document.getElementById('culturalSensitivity');

            if (selectedMarket === 'single') {
                // 單一市場：隱藏次要市場，設定本地化為中度
                if (secondaryMarketsField) {
                    secondaryMarketsField.value = '';
                    secondaryMarketsField.parentElement.style.display = 'none';
                }
                if (localizationField) {
                    localizationField.value = 'moderate';
                }
                if (culturalSensitivityField) {
                    culturalSensitivityField.value = 'medium';
                }
            } else if (selectedMarket === 'multi-asia') {
                // 多國亞洲市場：顯示次要市場，設定本地化為高度
                if (secondaryMarketsField) {
                    secondaryMarketsField.parentElement.style.display = 'block';
                    secondaryMarketsField.placeholder = '例如：日本、新加坡、香港、馬來西亞';
                }
                if (localizationField) {
                    localizationField.value = 'high';
                }
                if (culturalSensitivityField) {
                    culturalSensitivityField.value = 'high';
                }
            } else if (selectedMarket === 'global') {
                // 全球市場：顯示次要市場，設定本地化為完全
                if (secondaryMarketsField) {
                    secondaryMarketsField.parentElement.style.display = 'block';
                    secondaryMarketsField.placeholder = '例如：美國、歐洲、日本、東南亞';
                }
                if (localizationField) {
                    localizationField.value = 'full';
                }
                if (culturalSensitivityField) {
                    culturalSensitivityField.value = 'critical';
                }
            } else if (selectedMarket === 'custom') {
                // 自訂市場：顯示次要市場，保持預設值
                if (secondaryMarketsField) {
                    secondaryMarketsField.parentElement.style.display = 'block';
                    secondaryMarketsField.placeholder = '請輸入自訂的次要市場';
                }
            }
        }

        // --- Module 2: AI 任務協調與執行核心 ('融合中樞') ---
        async function callGeminiAPI(prompt, apiKey, isJsonMode = false) {
            if (!apiKey) {
                throw new Error("Google Gemini API 金鑰為空，請在介面上方輸入。");
            }
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };
            if (isJsonMode) {
                payload.generationConfig = { responseMimeType: "application/json" };
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`AI API 請求失敗 (狀態 ${response.status}): ${errorBody}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                const rawText = result.candidates[0].content.parts[0].text;
                
                if (isJsonMode) {
                    try {
                        // 嘗試直接解析
                        return JSON.parse(rawText);
                    } catch (parseError) {
                        console.warn('直接 JSON 解析失敗，嘗試清理文字:', parseError);
                        
                        // 清理文字，移除可能的 markdown 標記和額外文字
                        let cleanedText = rawText.trim();
                        
                        // 移除可能的 ```json 和 ``` 標記
                        cleanedText = cleanedText.replace(/```json\s*/gi, '').replace(/```\s*$/gi, '');
                        
                        // 尋找 JSON 物件開始和結束的位置
                        const jsonStart = cleanedText.indexOf('{');
                        const jsonEnd = cleanedText.lastIndexOf('}');
                        
                        if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
                            cleanedText = cleanedText.substring(jsonStart, jsonEnd + 1);
                        }
                        
                        try {
                            return JSON.parse(cleanedText);
                        } catch (secondError) {
                            console.error('清理後的 JSON 解析仍然失敗:', secondError);
                            console.error('原始文字:', rawText);
                            console.error('清理後文字:', cleanedText);
                            throw new Error(`JSON 解析失敗: ${secondError.message}。請檢查主控台查看詳細資訊。`);
                        }
                    }
                } else {
                    return rawText;
                }
            } else {
                console.error("AI 回應格式不符:", result);
                throw new Error("AI 未能生成有效的分析報告，請檢查主控台。");
            }
        }
        
        function updateStatus(text, state = 'running') {
            if (!statusContainer) {
                console.error('狀態容器未找到');
                return null;
            }

            const statusId = `status-${Date.now()}`;
            const icon = {
                running: `<svg class="animate-spin h-5 w-5 mr-3 text-indigo-500" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`,
                done: `<svg class="h-5 w-5 mr-3 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`,
                error: `<svg class="h-5 w-5 mr-3 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`,
            };
            const div = document.createElement('div');
            div.id = statusId;
            div.className = 'status-update flex items-center p-3 bg-gray-100 rounded-lg';
            div.innerHTML = `${icon[state]}<p class="text-gray-700">${text}</p>`;
            statusContainer.appendChild(div);
            setTimeout(() => div.classList.add('active'), 10);
            return statusId;
        }

        function markStatusDone(statusId) {
            if (!statusId) return;
            
            const statusElement = document.getElementById(statusId);
            if (statusElement) {
                statusElement.innerHTML = statusElement.innerHTML.replace(/<svg.*?<\/svg>/, 
                    `<svg class="h-5 w-5 mr-3 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`
                );
            }
        }
        
        // --- 分析任務定義 ---
        async function analyzeForumSentiment(context, apiKey) {
            const prompt = `
                你是一位專精台灣市場的資深市場分析師。請你根據以下品牌情境，在台灣主流論壇 Dcard 和 PTT 上進行輿情分析。

                **品牌情境:**
                - **目標品牌:** ${context.target}
                - **競爭品牌:** ${context.competitor}
                - **所屬產業:** ${context.industry}
                - **商業模式:** ${context.businessModel}
                - **主要銷售通路:** ${context.salesChannels}
                - **核心目標人群:** ${context.targetAudience}

                你的任務是總結比較的結果，並以一個 JSON 物件的格式回傳。JSON 物件必須包含以下幾個 key: 
                "target_profile", "target_pros", "target_cons", "competitor_pros", "competitor_cons", "market_opportunity"。

                - **target_profile:** 在論壇中，最接近「${context.targetAudience}」這個輪廓的討論者是誰？他們有什麼特徵？
                - **target_pros:** 這些目標人群讚賞目標品牌的優點是什麼？ (至少 2 點)。
                - **target_cons:** 這些目標人群抱怨目標品牌的缺點是什麼？ (至少 2 點)。
                - **competitor_pros:** 競爭品牌吸引這些目標人群的優點。
                - **competitor_cons:** 競爭品牌讓這些目標人群卻步的缺點。
                - **market_opportunity:** 根據以上分析，找出一個能精準打動「${context.targetAudience}」的市場溝通機會點。

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeSeoStrategy(context, apiKey) {
            const prompt = `
                你是一位頂尖的 SEO 策略顧問，特別熟悉台灣的 google.com.tw 搜尋引擎生態。
                請模擬「${context.targetAudience}」這個目標人群，在搜尋與「${context.target}」相關的關鍵字時，他們會看到什麼樣的搜尋結果頁面 (SERP)。

                **品牌情境:**
                - **目標品牌:** ${context.target}
                - **商業模式:** ${context.businessModel}
                - **核心目標人群:** ${context.targetAudience}

                你的任務是總結你的發現，並以一個 JSON 物件的格式回傳。JSON 物件必須包含以下幾個 key: 
                "main_competitors_in_serp", "dominant_content_format", "user_intent", "content_gap_opportunity"。

                - **main_competitors_in_serp:** 除了「${context.competitor}」之外，在自然搜尋結果中還常出現哪些競爭者？
                - **dominant_content_format:** 排名靠前的內容主要是長篇文章、產品比較頁、新聞稿，還是 YouTube 影片？
                - **user_intent:** 「${context.targetAudience}」在搜尋時，其主要的「搜尋意圖」是什麼？請根據 ${context.businessModel} 的特性來分析。
                - **content_gap_opportunity:** 根據 Google 的「其他人也問了」或「相關搜尋」，找出一個能解決「${context.targetAudience}」痛點，但市場上還沒有優質內容回答的問題，作為內容策略切入點。

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function estimateKpiAndBudget(context, opportunity, apiKey) {
            if (!context.budget || context.budget <= 0) {
                 return { budget_allocation: [], kpi_estimations: [], rationale: "未提供預算，無法進行估算。" };
            }
            const prompt = `
                你是一位經驗豐富的數位媒體規劃師 (Media Planner)，擅長台灣市場的媒體投資與成效預估。
                根據以下客戶情境與你已知的市場機會點，規劃一份初步的預算分配與 KPI 預估。

                **客戶情境:**
                - **產業:** ${context.industry}
                - **商業模式:** ${context.businessModel}
                - **目標人群:** ${context.targetAudience}
                - **總預算 (TWD):** ${context.budget.toLocaleString()}
                - **核心策略機會點:** ${opportunity}

                你的任務是產出一個 JSON 物件，包含 "budget_allocation", "kpi_estimations", "rationale" 三個 key。

                1.  **budget_allocation:** 一個陣列。根據「核心策略機會點」，建議將預算分配到 2-3 個最相關的媒體渠道 (例如：付費搜尋, 社群廣告, 內容行銷, 影音廣告)，並給出每個渠道的**百分比**和**金額**。
                2.  **kpi_estimations:** 一個陣列。為每個建議的渠道，提供**可量化的 KPI 預估**。請使用台灣市場的典型 benchmarks (基準)。
                    -   **對於 B2C:** 需包含 "Impressions" (曝光), "CTR" (點擊率), "Clicks" (點擊), "CPC" (單次點擊成本), "Est_Conversions" (預估訂單數，請自訂一個合理的轉換率)。
                    -   **對於 B2B:** 需包含 "Impressions", "CTR", "Clicks", "CPC", "Est_Leads" (預估潛在客戶數，請自訂一個合理的轉換率)。
                3.  **rationale:** 一段簡短文字，說明你這樣規劃預算優先級的理由。

                請確保回傳的內容是純粹的 JSON 格式。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        // 跨國市場策略分析
        async function analyzeInternationalMarketStrategy(context, apiKey) {
            const prompt = `
                你是一位資深的國際市場策略顧問，專精於跨國市場進入策略和本地化策略。
                請根據以下品牌情境，分析跨國市場策略和溝通策略。

                **品牌情境:**
                - **目標品牌:** ${context.target}
                - **競爭品牌:** ${context.competitor}
                - **產業:** ${context.industry}
                - **商業模式:** ${context.businessModel}
                - **目標人群:** ${context.targetAudience}
                - **目標市場:** ${context.targetMarkets}
                - **主要市場:** ${context.primaryMarket}
                - **次要市場:** ${context.secondaryMarkets}
                - **市場進入策略:** ${context.marketEntryStrategy}
                - **本地化程度:** ${context.localizationLevel}
                - **文化敏感度:** ${context.culturalSensitivity}
                - **溝通策略類型:** ${context.communicationStrategy}
                - **語言策略:** ${context.languageStrategy}
                - **語調策略:** ${context.toneStrategy}
                - **通路策略:** ${context.channelStrategy}
                - **時機策略:** ${context.timingStrategy}
                - **危機管理策略:** ${context.crisisManagement}
                - **文化考量重點:** ${context.culturalConsiderations}
                - **法規要求:** ${context.regulatoryRequirements}

                你的任務是產出一個 JSON 物件，包含以下 key：

                1. **market_analysis:** 包含 "market_opportunities", "market_challenges", "competitive_landscape", "entry_timing"
                2. **localization_strategy:** 包含 "product_adaptation", "communication_adaptation", "cultural_considerations", "regulatory_compliance"
                3. **communication_framework:** 包含 "global_message", "local_messages", "channel_mix", "timing_strategy"
                4. **risk_management:** 包含 "cultural_risks", "regulatory_risks", "competitive_risks", "mitigation_strategies"
                5. **success_metrics:** 包含 "market_penetration", "brand_awareness", "cultural_acceptance", "regulatory_compliance"

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        // 跨國文化適應性分析
        async function analyzeCulturalAdaptation(context, apiKey) {
            const prompt = `
                你是一位跨文化溝通專家，專精於亞洲市場的文化適應策略。
                請根據以下情境，分析在不同目標市場的文化適應策略。

                **分析情境:**
                - **目標品牌:** ${context.target}
                - **主要市場:** ${context.primaryMarket}
                - **次要市場:** ${context.secondaryMarkets}
                - **文化敏感度:** ${context.culturalSensitivity}
                - **文化考量重點:** ${context.culturalConsiderations}

                你的任務是產出一個 JSON 物件，包含以下 key：

                1. **cultural_insights:** 包含 "primary_market_culture", "secondary_markets_culture", "cultural_differences", "shared_values"
                2. **adaptation_strategies:** 包含 "visual_adaptation", "message_adaptation", "tone_adaptation", "timing_adaptation"
                3. **cultural_taboos:** 包含 "visual_taboos", "language_taboos", "concept_taboos", "timing_taboos"
                4. **localization_priorities:** 包含 "high_priority", "medium_priority", "low_priority", "not_required"
                5. **success_indicators:** 包含 "cultural_acceptance", "local_relevance", "brand_authenticity", "market_resonance"

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        // B2B 專業市場分析
        async function analyzeB2BMarketStrategy(context, apiKey) {
            const prompt = `
                你是一位資深的 B2B 市場策略顧問，專精於企業級市場分析和銷售策略。
                請根據以下 B2B 情境，進行專業的市場分析。

                **B2B 情境分析:**
                - **目標品牌:** ${context.target}
                - **競爭品牌:** ${context.competitor}
                - **產業:** ${context.industry}
                - **商業模式:** ${context.businessModel}
                - **目標企業規模:** ${context.targetCompanySize}
                - **主要決策者角色:** ${context.decisionMakerRole}
                - **採購週期:** ${context.purchaseCycle}
                - **預算範圍:** ${context.budgetRange}
                - **主要痛點:** ${context.painPoints}
                - **成功指標:** ${context.successMetrics}
                - **競爭優勢:** ${context.competitiveAdvantage}
                - **產業挑戰:** ${context.industryChallenges}

                你的任務是產出一個 JSON 物件，包含以下 key：

                1. **buyer_persona_analysis:** 包含 "decision_maker_profile", "influencer_network", "pain_points_analysis", "success_criteria"
                2. **sales_funnel_strategy:** 包含 "awareness_stage", "consideration_stage", "decision_stage", "conversion_tactics"
                3. **competitive_positioning:** 包含 "differentiation_strategy", "value_proposition", "competitive_advantages", "market_positioning"
                4. **content_marketing_strategy:** 包含 "thought_leadership", "educational_content", "case_studies", "technical_documentation"
                5. **lead_generation_tactics:** 包含 "inbound_strategies", "outbound_strategies", "partnership_opportunities", "referral_programs"
                6. **account_based_marketing:** 包含 "target_account_selection", "personalization_strategy", "multi_touch_campaigns", "success_metrics"

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        // B2B 當地市場深度分析
        async function analyzeLocalB2BMarket(context, apiKey) {
            const prompt = `
                你是一位專精台灣 B2B 市場的資深分析師，對台灣企業生態、採購習慣、決策流程有深入理解。
                請根據以下情境，分析台灣 B2B 市場的特殊性和機會。

                **台灣 B2B 市場分析情境:**
                - **目標品牌:** ${context.target}
                - **產業:** ${context.industry}
                - **目標企業規模:** ${context.targetCompanySize}
                - **主要決策者角色:** ${context.decisionMakerRole}
                - **採購週期:** ${context.purchaseCycle}
                - **預算範圍:** ${context.budgetRange}
                - **主要痛點:** ${context.painPoints}
                - **競爭優勢:** ${context.competitiveAdvantage}

                你的任務是產出一個 JSON 物件，包含以下 key：

                1. **taiwan_b2b_landscape:** 包含 "market_characteristics", "industry_clusters", "regional_distribution", "business_culture"
                2. **decision_making_process:** 包含 "decision_hierarchy", "approval_process", "evaluation_criteria", "timeline_factors"
                3. **local_competition_analysis:** 包含 "domestic_competitors", "international_players", "competitive_dynamics", "market_gaps"
                4. **relationship_building:** 包含 "guanxi_importance", "trust_building", "long_term_relationships", "local_partnerships"
                5. **regulatory_environment:** 包含 "compliance_requirements", "industry_regulations", "tax_considerations", "legal_framework"
                6. **success_factors:** 包含 "local_adaptation", "service_quality", "price_positioning", "after_sales_support"

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        // 當地市場商業模式分析
        async function analyzeLocalBusinessModel(context, apiKey) {
            const prompt = `
                你是一位專精亞洲市場的商業模式分析師，對不同地區的商業生態、消費習慣、企業文化有深入理解。
                請根據以下情境，分析目標市場的商業模式特點和機會。

                **當地市場商業模式分析情境:**
                - **目標品牌:** ${context.target}
                - **產業:** ${context.industry}
                - **商業模式:** ${context.businessModel}
                - **主要市場:** ${context.primaryMarket}
                - **次要市場:** ${context.secondaryMarkets}
                - **目標受眾:** ${context.targetAudience}
                - **銷售通路:** ${context.salesChannels}

                你的任務是產出一個 JSON 物件，包含以下 key：

                1. **local_business_ecosystem:** 包含 "market_maturity", "competitive_landscape", "regulatory_environment", "business_culture"
                2. **consumer_behavior_analysis:** 包含 "purchase_habits", "decision_factors", "brand_preferences", "price_sensitivity"
                3. **business_model_adaptation:** 包含 "local_opportunities", "challenges", "adaptation_strategies", "success_factors"
                4. **market_segmentation:** 包含 "demographic_segments", "psychographic_profiles", "behavioral_patterns", "value_propositions"
                5. **competitive_advantages:** 包含 "local_differentiation", "cultural_advantages", "operational_efficiencies", "innovation_potential"
                6. **growth_opportunities:** 包含 "market_gaps", "emerging_trends", "expansion_potential", "partnership_opportunities"

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        // 當地媒體偏好分析
        async function analyzeLocalMediaPreferences(context, apiKey) {
            const prompt = `
                你是一位專精亞洲媒體市場的資深分析師，對不同地區的媒體生態、用戶習慣、廣告效果有深入理解。
                請根據以下情境，分析目標市場的媒體偏好和廣告策略。

                **當地媒體偏好分析情境:**
                - **目標品牌:** ${context.target}
                - **產業:** ${context.industry}
                - **商業模式:** ${context.businessModel}
                - **主要市場:** ${context.primaryMarket}
                - **次要市場:** ${context.secondaryMarkets}
                - **目標受眾:** ${context.targetAudience}
                - **預算:** ${context.budget}

                你的任務是產出一個 JSON 物件，包含以下 key：

                1. **media_landscape_analysis:** 包含 "traditional_media", "digital_media", "social_media", "emerging_platforms"
                2. **audience_media_habits:** 包含 "media_consumption_patterns", "platform_preferences", "content_preferences", "engagement_metrics"
                3. **advertising_effectiveness:** 包含 "cost_performance", "reach_efficiency", "engagement_rates", "conversion_metrics"
                4. **local_media_strategy:** 包含 "primary_channels", "secondary_channels", "content_strategy", "timing_strategy"
                5. **cultural_media_factors:** 包含 "cultural_sensitivity", "local_content_preferences", "communication_style", "taboo_topics"
                6. **competitive_media_analysis:** 包含 "competitor_channels", "advertising_trends", "market_gaps", "opportunity_areas"

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        // 當地人群深度分析
        async function analyzeLocalAudienceInsights(context, apiKey) {
            const prompt = `
                你是一位專精亞洲消費者行為的資深分析師，對不同地區的人群特徵、消費心理、生活方式有深入理解。
                請根據以下情境，分析目標市場的人群特點和洞察。

                **當地人群深度分析情境:**
                - **目標品牌:** ${context.target}
                - **產業:** ${context.industry}
                - **商業模式:** ${context.businessModel}
                - **主要市場:** ${context.primaryMarket}
                - **次要市場:** ${context.secondaryMarkets}
                - **目標受眾:** ${context.targetAudience}
                - **預算範圍:** ${context.budgetRange}

                你的任務是產出一個 JSON 物件，包含以下 key：

                1. **demographic_analysis:** 包含 "age_distribution", "income_levels", "education_background", "occupation_patterns"
                2. **psychographic_profiles:** 包含 "lifestyle_preferences", "values_beliefs", "personality_traits", "aspirations"
                3. **behavioral_insights:** 包含 "purchase_behavior", "brand_loyalty", "decision_process", "influence_factors"
                4. **cultural_influences:** 包含 "cultural_values", "social_norms", "family_structure", "community_impact"
                5. **digital_adoption:** 包含 "technology_usage", "online_behavior", "social_media_habits", "e_commerce_preferences"
                6. **communication_preferences:** 包含 "language_preferences", "communication_style", "content_format", "channel_preferences"

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        // --- Module 3: 提案生成引擎 ('合成引擎') ---
        async function synthesizeFinalReport(context, forumAnalysis, seoAnalysis, kpiEstimation, internationalData, culturalData, b2bData, localB2bData, localBusinessData, localMediaData, localAudienceData, apiKey) {
             const prompt = `
                你是一位首席媒體策略總監，你的任務是將下屬分析師提交的所有 JSON 資料，整合成一份給客戶看的、專業且有說服力的「市場機會與初步策略建議」報告。報告需以 HTML 格式呈現。

                **客戶資料:**
                - **目標品牌:** ${context.target}
                - **核心目標人群:** ${context.targetAudience}
                - **總預算 (TWD):** ${context.budget > 0 ? context.budget.toLocaleString() : '未提供'}
                - **商業模式:** ${context.businessModel}
                - **目標市場:** ${context.targetMarkets}
                - **主要市場:** ${context.primaryMarket}
                - **次要市場:** ${context.secondaryMarkets}
                ${context.businessModel === 'B2B' ? `
                - **目標企業規模:** ${context.targetCompanySize}
                - **主要決策者角色:** ${context.decisionMakerRole}
                - **採購週期:** ${context.purchaseCycle}
                - **預算範圍:** ${context.budgetRange}
                - **主要痛點:** ${context.painPoints}
                - **成功指標:** ${context.successMetrics}
                ` : ''}

                **分析師提交的資料:**
                1.  **論壇輿情分析:** ${JSON.stringify(forumAnalysis, null, 2)}
                2.  **SEO 與內容策略分析:** ${JSON.stringify(seoAnalysis, null, 2)}
                3.  **預算規劃與 KPI 估算:** ${JSON.stringify(kpiEstimation, null, 2)}
                4.  **跨國市場策略分析:** ${JSON.stringify(internationalData, null, 2)}
                5.  **跨國文化適應性分析:** ${JSON.stringify(culturalData, null, 2)}
                6.  **當地市場商業模式分析:** ${JSON.stringify(localBusinessData, null, 2)}
                7.  **當地媒體偏好分析:** ${JSON.stringify(localMediaData, null, 2)}
                8.  **當地人群深度分析:** ${JSON.stringify(localAudienceData, null, 2)}
                ${context.businessModel === 'B2B' ? `
                9.  **B2B 專業市場分析:** ${JSON.stringify(b2bData, null, 2)}
                ${context.primaryMarket === 'taiwan' ? `
                10. **台灣 B2B 市場深度分析:** ${JSON.stringify(localB2bData, null, 2)}
                ` : ''}
                ` : ''}

                請產出一份結構化的 HTML 報告，包含以下章節：

                ## 1. 執行摘要
                - 市場機會概述
                - 核心策略建議
                - 預期成效

                ## 2. 當地市場分析
                - 目標市場概況
                - 當地商業生態分析
                - 競爭環境分析
                - 當地人群洞察
                ${context.businessModel === 'B2B' ? `
                - B2B 買家角色分析
                - 決策流程分析
                - 採購行為洞察
                ` : ''}

                ## 3. 當地媒體策略
                - 媒體生態分析
                - 當地媒體偏好
                - 廣告效果評估
                - 媒體選擇建議
                - 內容策略建議

                ## 4. 商業模式適應策略
                - 當地商業模式分析
                - 消費者行為洞察
                - 市場細分策略
                - 競爭優勢分析
                - 成長機會識別

                ## 5. 跨國策略
                - 市場進入策略
                - 本地化策略
                - 文化適應策略
                - 溝通策略

                ## 6. 預算分配與 KPI
                - 預算分配建議
                - KPI 設定
                - 成效追蹤方法

                ## 7. 執行時程
                - 短期行動計畫 (1-3個月)
                - 中期發展計畫 (3-6個月)
                - 長期策略規劃 (6-12個月)

                ## 8. 風險管理
                - 潛在風險識別
                - 風險緩解策略
                - 危機管理計畫

                請使用專業的 HTML 格式，包含適當的標題、段落、列表和強調元素。報告應該具有說服力且易於閱讀。
                特別注意整合當地市場的商業模式判斷、人群分析，以及當地媒體偏好考量。
            `;
            return await callGeminiAPI(prompt, apiKey, false);
        }

        // --- 主執行流程 ---
        async function handleGenerateClick() {
            try {
                // 檢查必要元素是否存在
                if (!apiKeyInput || !projectIdInput || !targetBrandInput || 
                    !competitorBrandInput || !industryInput || !businessModelInput || 
                    !salesChannelsInput || !targetAudienceInput || !advertisingBudgetInput) {
                    throw new Error('某些必要的 UI 元素未找到，請重新整理頁面');
                }

                // 專案 ID 變成可選的
                const projectId = projectIdInput.value?.trim() || '';
                if (projectId) {
                    // 如果有輸入專案ID，儲存到全域變數
                    currentProjectId = projectId;
                    console.log('使用專案ID:', projectId);
                } else {
                    // 如果沒有專案ID，使用時間戳作為臨時ID
                    currentProjectId = `temp_${Date.now()}`;
                    console.log('使用臨時ID:', currentProjectId);
                }
                
                const userApiKey = apiKeyInput.value?.trim() || '';
                if (!userApiKey) {
                    alert('請在最上方輸入您的 Google Gemini API 金鑰。');
                    return;
                }

                const analysisContext = {
                    target: targetBrandInput.value?.trim() || '',
                    competitor: competitorBrandInput.value?.trim() || '',
                    industry: industryInput.value || '',
                    businessModel: businessModelInput.value || '',
                    salesChannels: salesChannelsInput.value?.trim() || '未提供',
                    targetAudience: targetAudienceInput.value?.trim() || '未指定',
                    budget: parseInt(advertisingBudgetInput.value, 10) || 0,
                    projectId: currentProjectId, // 加入 project ID 到分析上下文
                    // 跨國市場策略參數
                    targetMarkets: targetMarketsInput.value || 'single',
                    primaryMarket: primaryMarketInput.value || 'taiwan',
                    secondaryMarkets: secondaryMarketsInput.value?.trim() || '',
                    marketEntryStrategy: marketEntryStrategyInput.value || 'organic',
                    localizationLevel: localizationLevelInput.value || 'medium',
                    culturalSensitivity: culturalSensitivityInput.value || 'medium',
                    // 跨國溝通策略參數
                    communicationStrategy: communicationStrategyInput.value || 'global_local',
                    languageStrategy: languageStrategyInput.value || 'local_language',
                    toneStrategy: toneStrategyInput.value || 'professional',
                    channelStrategy: channelStrategyInput.value || 'digital_first',
                    timingStrategy: timingStrategyInput.value || 'phased',
                    crisisManagement: crisisManagementInput.value || 'centralized',
                    culturalConsiderations: culturalConsiderationsInput.value?.trim() || '',
                    regulatoryRequirements: regulatoryRequirementsInput.value?.trim() || '',
                    // B2B 專業市場分析參數
                    targetCompanySize: targetCompanySizeInput.value || 'sme',
                    decisionMakerRole: decisionMakerRoleInput.value || 'ceo',
                    purchaseCycle: purchaseCycleInput.value || 'medium',
                    budgetRange: budgetRangeInput.value || 'medium',
                    painPoints: painPointsInput.value?.trim() || '',
                    successMetrics: successMetricsInput.value?.trim() || '',
                    competitiveAdvantage: competitiveAdvantageInput.value?.trim() || '',
                    industryChallenges: industryChallengesInput.value?.trim() || ''
                };

                if (!analysisContext.target || !analysisContext.competitor) {
                    alert('請務必輸入目標品牌和競爭對手。');
                    return;
                }

                if (!generateBtn || !statusContainer || !proposalOutput) {
                    throw new Error('UI 元素未正確載入，請重新整理頁面');
                }

                generateBtn.disabled = true;
                generateBtn.innerHTML = `分析中...`;
                statusContainer.innerHTML = '';
                proposalOutput.innerHTML = '';

                try {
                    const status1 = updateStatus(`分析 **${analysisContext.target}** 在目標人群中的論壇輿情...`);
                    const forumData = await analyzeForumSentiment(analysisContext, userApiKey);
                    markStatusDone(status1);

                    const status2 = updateStatus(`分析 **${analysisContext.target}** 的 SEO 與內容策略...`);
                    const seoData = await analyzeSeoStrategy(analysisContext, userApiKey);
                    markStatusDone(status2);
                    
                    const opportunity = forumData.market_opportunity || seoData.content_gap_opportunity;
                    
                    const status3 = updateStatus(`進行預算規劃與 KPI 估算...`);
                    const kpiData = await estimateKpiAndBudget(analysisContext, opportunity, userApiKey);
                    markStatusDone(status3);

                    // 跨國策略分析（僅在選擇多市場時執行）
                    let internationalData = null;
                    let culturalData = null;
                    
                    if (analysisContext.targetMarkets !== 'single') {
                        const status4 = updateStatus(`分析跨國市場策略與進入策略...`);
                        internationalData = await analyzeInternationalMarketStrategy(analysisContext, userApiKey);
                        markStatusDone(status4);

                        const status5 = updateStatus(`分析跨國文化適應策略...`);
                        culturalData = await analyzeCulturalAdaptation(analysisContext, userApiKey);
                        markStatusDone(status5);
                    }

                    // B2B 專業分析（僅在 B2B 模式下執行）
                    let b2bData = null;
                    let localB2bData = null;
                    
                    if (analysisContext.businessModel === 'B2B') {
                        const status6 = updateStatus(`進行 B2B 專業市場分析...`);
                        b2bData = await analyzeB2BMarketStrategy(analysisContext, userApiKey);
                        markStatusDone(status6);

                        // 當地 B2B 市場分析（僅在台灣市場時執行）
                        if (analysisContext.primaryMarket === 'taiwan') {
                            const status7 = updateStatus(`分析台灣 B2B 市場特殊性...`);
                            localB2bData = await analyzeLocalB2BMarket(analysisContext, userApiKey);
                            markStatusDone(status7);
                        }
                    }

                    // 當地市場深度分析（所有模式都執行）
                    const status8 = updateStatus(`分析當地市場商業模式...`);
                    const localBusinessData = await analyzeLocalBusinessModel(analysisContext, userApiKey);
                    markStatusDone(status8);

                    const status9 = updateStatus(`分析當地媒體偏好...`);
                    const localMediaData = await analyzeLocalMediaPreferences(analysisContext, userApiKey);
                    markStatusDone(status9);

                    const status10 = updateStatus(`分析當地人群洞察...`);
                    const localAudienceData = await analyzeLocalAudienceInsights(analysisContext, userApiKey);
                    markStatusDone(status10);

                    // 生成最終報告
                    const status11 = updateStatus(`整合分析結果，生成專業報告...`);
                    const finalReport = await synthesizeFinalReport(
                        analysisContext, 
                        forumData, 
                        seoData, 
                        kpiData, 
                        internationalData, 
                        culturalData, 
                        b2bData, 
                        localB2bData, 
                        localBusinessData,
                        localMediaData,
                        localAudienceData,
                        userApiKey
                    );
                    markStatusDone(status11);

                    // 在報告開頭加入 project ID 資訊
                    const projectInfoHtml = `
                        <div style="background-color: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                            <h3 style="color: #0c4a6e; margin: 0 0 8px 0; font-size: 18px;">📋 專案資訊</h3>
                            <p style="color: #0369a1; margin: 0; font-weight: 500;">專案 ID: <strong>${currentProjectId}</strong></p>
                            <p style="color: #0369a1; margin: 4px 0 0 0; font-size: 14px;">生成時間: ${new Date().toLocaleString('zh-TW')}</p>
                        </div>
                    `;
                    
                    proposalOutput.innerHTML = projectInfoHtml + finalReport;

                } catch (error) {
                    console.error('生成提案時發生錯誤:', error);
                    updateStatus(`生成報告時發生錯誤: ${error.message}`, 'error');
                    
                    // 提供更詳細的錯誤訊息
                    let errorMessage = `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h3 class="text-red-800 font-bold mb-2">❌ 處理過程中發生錯誤</h3>
                        <p class="text-red-700 mb-2"><strong>錯誤訊息:</strong> ${error.message}</p>`;
                    
                    // 如果是 JSON 解析錯誤，提供特別的建議
                    if (error.message.includes('JSON') || error.message.includes('SyntaxError')) {
                        errorMessage += `<p class="text-red-700 mb-2"><strong>可能原因:</strong> AI 回應格式不正確，可能是因為：</p>
                        <ul class="text-red-700 list-disc list-inside mb-2">
                            <li>API 金鑰無效或已過期</li>
                            <li>網路連線問題</li>
                            <li>AI 服務暫時不可用</li>
                        </ul>
                        <p class="text-red-700"><strong>建議:</strong> 請檢查您的 API 金鑰是否正確，或稍後再試。</p>`;
                    } else {
                        errorMessage += `<p class="text-red-700"><strong>建議:</strong> 請檢查瀏覽器的主控台以獲取詳細技術資訊，然後再試一次。</p>`;
                    }
                    
                    errorMessage += `</div>`;
                    proposalOutput.innerHTML = errorMessage;
                } finally {
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.innerHTML = `重新生成 AI 分析報告`;
                    }
                }
            } catch (error) {
                console.error('主函數執行錯誤:', error);
                alert(`執行錯誤: ${error.message}\n請重新整理頁面或聯繫技術支援。`);
            }
        }

        // 新增：Google Drive 相關函數
        async function setupGoogleDrive() {
            try {
                // 載入 Google Drive API
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://apis.google.com/js/api.js';
                    script.onload = () => {
                        gapi.load('client', async () => {
                            try {
                                await gapi.client.init({});
                                await gapi.client.load('drive', 'v3');
                                resolve();
                            } catch (error) {
                                reject(error);
                            }
                        });
                    };
                    script.onerror = reject;
                    document.head.appendChild(script);
                });

                // 讀取資料夾設定（添加 null 檢查）
                const centralFolderElement = document.getElementById('centralFolderName');
                const mediaplanSubfolderElement = document.getElementById('mediaplanSubfolder');
                
                folderStructure.centralFolder = centralFolderElement?.value || 'iStaging_專案管理';
                folderStructure.mediaplanSubfolder = mediaplanSubfolderElement?.value || '02_媒體提案';

                // 建立資料夾結構
                await setupCentralizedFolderStructure();
                isGoogleDriveEnabled = true;
                
                console.log('Google Drive 設定完成');
                return true;
            } catch (error) {
                console.error('Google Drive 設定失敗:', error);
                return false;
            }
        }

        async function setupCentralizedFolderStructure() {
            try {
                // 1. 建立或找到主要專案資料夾
                const centralFolderId = await findOrCreateFolder(folderStructure.centralFolder, null);
                folderIds.central = centralFolderId;
                
                // 2. 建立或找到專案子資料夾
                if (currentProjectId) {
                    const projectFolderName = `[${currentProjectId}]_專案資料`;
                    const projectFolderId = await findOrCreateFolder(projectFolderName, centralFolderId);
                    folderIds.project = projectFolderId;
                    
                    // 3. 建立或找到媒體提案子資料夾
                    const mediaplanFolderId = await findOrCreateFolder(folderStructure.mediaplanSubfolder, projectFolderId);
                    folderIds.mediaplan = mediaplanFolderId;
                    
                    console.log('集中化資料夾結構建立完成:', {
                        central: centralFolderId,
                        project: projectFolderId,
                        mediaplan: mediaplanFolderId
                    });
                    
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('建立資料夾結構失敗:', error);
                throw error;
            }
        }

        async function findOrCreateFolder(folderName, parentId) {
            try {
                let query = `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`;
                if (parentId) {
                    query += ` and '${parentId}' in parents`;
                }
                
                const response = await gapi.client.drive.files.list({ 
                    q: query, 
                    fields: 'files(id)' 
                });
                
                if (response.result.files && response.result.files.length > 0) {
                    return response.result.files[0].id;
                } else {
                    const folderMetadata = {
                        name: folderName,
                        mimeType: 'application/vnd.google-apps.folder'
                    };
                    
                    if (parentId) {
                        folderMetadata.parents = [parentId];
                    }
                    
                    const createResponse = await gapi.client.drive.files.create({ 
                        resource: folderMetadata, 
                        fields: 'id' 
                    });
                    
                    return createResponse.result.id;
                }
            } catch (error) {
                console.error(`建立資料夾 ${folderName} 失敗:`, error);
                throw error;
            }
        }

        async function saveToGoogleDrive(content, fileName) {
            try {
                if (!isGoogleDriveEnabled) {
                    const driveEnabled = await setupGoogleDrive();
                    if (!driveEnabled) {
                        console.log('Google Drive 未啟用，跳過儲存');
                        return false;
                    }
                }

                // 確保資料夾結構已建立
                if (!folderIds.mediaplan) {
                    await setupCentralizedFolderStructure();
                }

                // 建立檔案內容
                const fileContent = {
                    projectId: currentProjectId,
                    content: content,
                    generatedAt: new Date().toISOString(),
                    tool: 'mediaplan'
                };

                const blob = new Blob([JSON.stringify(fileContent, null, 2)], { type: 'application/json' });
                const metadata = { 
                    name: fileName, 
                    mimeType: 'application/json', 
                    parents: [folderIds.mediaplan] 
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);
                
                // 需要用戶授權才能上傳
                console.log('需要用戶授權才能上傳到 Google Drive');
                return false;
                
            } catch (error) {
                console.error('儲存到 Google Drive 失敗:', error);
                return false;
            }
        }

        // B2B 商業模式的動態功能
        if (businessModelInput) {
            businessModelInput.addEventListener('change', function() {
                const selectedModel = this.value;
                updateB2BFields(selectedModel);
            });
        }

        // 更新 B2B 相關欄位的顯示
        function updateB2BFields(selectedModel) {
            const b2bSection = document.querySelector('.border-t.border-gray-200.pt-6');
            if (!b2bSection) return;

            if (selectedModel === 'B2B') {
                b2bSection.style.display = 'block';
                // 添加專業提示
                showB2BProfessionalTips();
            } else {
                b2bSection.style.display = 'none';
                // 隱藏專業提示
                hideB2BProfessionalTips();
            }
        }

        // 顯示 B2B 專業提示
        function showB2BProfessionalTips() {
            const tipsHtml = `
                <div id="b2b-tips" class="mt-4 p-4 bg-purple-50 border-l-4 border-purple-400 rounded-lg">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-medium text-purple-800">B2B 專業分析提示</h4>
                            <div class="mt-2 text-sm text-purple-700">
                                <p><strong>企業規模：</strong>不同規模企業的採購流程和決策週期差異很大</p>
                                <p><strong>決策者角色：</strong>了解誰是最終決策者，誰是影響者</p>
                                <p><strong>採購週期：</strong>B2B 採購通常需要 3-12 個月的決策週期</p>
                                <p><strong>痛點分析：</strong>精準識別企業面臨的具體業務挑戰</p>
                                <p><strong>成功指標：</strong>企業客戶更關注 ROI、效率提升、成本節省</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existingTips = document.getElementById('b2b-tips');
            if (!existingTips) {
                const b2bSection = document.querySelector('.border-t.border-gray-200.pt-6');
                if (b2bSection) {
                    b2bSection.insertAdjacentHTML('afterend', tipsHtml);
                }
            }
        }

        // 隱藏 B2B 專業提示
        function hideB2BProfessionalTips() {
            const tips = document.getElementById('b2b-tips');
            if (tips) {
                tips.remove();
            }
        }

        // 主要市場選擇的動態功能
        if (primaryMarketInput) {
            primaryMarketInput.addEventListener('change', function() {
                const selectedMarket = this.value;
                updateMarketAnalysisFocus(selectedMarket);
            });
        }

        // 更新市場分析重點
        function updateMarketAnalysisFocus(selectedMarket) {
            const marketInsights = getMarketInsights(selectedMarket);
            showMarketInsights(marketInsights);
        }

        // 獲取市場洞察
        function getMarketInsights(market) {
            const insights = {
                'taiwan': {
                    title: '台灣市場洞察',
                    characteristics: [
                        '高度數位化，行動裝置普及率高',
                        '社群媒體使用頻繁，LINE、Facebook、Instagram 為主',
                        '重視品質和服務，價格敏感度中等',
                        'B2B 市場重視關係建立和長期合作',
                        '法規環境相對完善，合規要求高'
                    ],
                    media_preferences: [
                        '數位媒體佔主導地位',
                        '社群媒體廣告效果佳',
                        'KOL 和網紅行銷盛行',
                        '傳統媒體仍有影響力（電視、廣播）',
                        '搜尋引擎行銷（Google、Yahoo）重要'
                    ],
                    business_culture: [
                        '重視誠信和專業',
                        '決策過程相對謹慎',
                        '關係導向的商業文化',
                        '重視售後服務和支援',
                        '創新接受度中等'
                    ]
                },
                'japan': {
                    title: '日本市場洞察',
                    characteristics: [
                        '高度成熟的消費市場',
                        '品質要求極高，品牌忠誠度強',
                        '決策過程謹慎，需要詳細資訊',
                        '重視禮貌和細節',
                        '人口老齡化趨勢明顯'
                    ],
                    media_preferences: [
                        '傳統媒體仍具影響力',
                        'LINE 是主要社群平台',
                        '電視廣告效果顯著',
                        '印刷媒體在 B2B 市場重要',
                        '行動裝置使用率高'
                    ],
                    business_culture: [
                        '極度重視品質和服務',
                        '決策層級多，流程複雜',
                        '關係建立需要時間',
                        '重視長期合作關係',
                        '創新接受度相對保守'
                    ]
                },
                'us': {
                    title: '美國市場洞察',
                    characteristics: [
                        '高度競爭的市場環境',
                        '創新接受度高，願意嘗試新產品',
                        '價格敏感度中等，重視價值',
                        '決策過程相對快速',
                        '多元文化背景'
                    ],
                    media_preferences: [
                        '數位媒體佔絕對主導',
                        'Google、Facebook、Instagram 重要',
                        '內容行銷效果顯著',
                        '影音內容（YouTube、TikTok）流行',
                        '電子郵件行銷有效'
                    ],
                    business_culture: [
                        '結果導向，重視 ROI',
                        '決策過程相對直接',
                        '創新和效率並重',
                        '競爭激烈，差異化重要',
                        '數據驅動的決策'
                    ]
                },
                'india': {
                    title: '印度市場洞察',
                    characteristics: [
                        '快速成長的新興市場',
                        '價格敏感度高，重視性價比',
                        '年輕人口占比高，數位化程度快速提升',
                        '家庭和社區影響決策重要',
                        '多語言、多文化的複雜市場'
                    ],
                    media_preferences: [
                        'WhatsApp 是主要溝通平台',
                        'Facebook、Instagram 使用率高',
                        'YouTube 影音內容受歡迎',
                        '行動優先的媒體消費習慣',
                        '本地語言內容需求高'
                    ],
                    business_culture: [
                        '關係導向，重視信任建立',
                        '決策過程較長，需多方考量',
                        '價格談判是常態',
                        '家族企業文化濃厚',
                        '重視長期合作和忠誠度'
                    ]
                },
                'germany': {
                    title: '德國市場深度洞察',
                    characteristics: [
                        '高度成熟的工業化經濟體，GDP 全球第四',
                        '品質要求極高，重視技術標準和認證',
                        '決策過程嚴謹，需要詳細技術文件和數據支持',
                        '價格敏感度中等，重視長期價值和投資回報',
                        '環保意識強，永續發展和綠色技術優先',
                        '高度數位化，但傳統媒體仍有影響力',
                        '區域差異明顯，南北經濟發展不平衡',
                        '中小企業 (Mittelstand) 是經濟支柱',
                        '創新接受度中等，但重視實用性和可靠性',
                        '人口老齡化，但技術人才充足'
                    ],
                    media_preferences: [
                        'LinkedIn 在 B2B 市場佔主導地位',
                        '專業媒體和行業雜誌影響力大 (如 Handelsblatt, Wirtschaftswoche)',
                        'Google 搜尋引擎使用率高，SEO 策略重要',
                        '電子郵件行銷效果顯著，但需要個人化',
                        '內容行銷重視專業性和深度，技術白皮書受歡迎',
                        'Facebook 和 Instagram 在 B2C 市場使用率高',
                        'YouTube 用於教育內容和產品展示',
                        '播客 (Podcasts) 在專業領域受歡迎',
                        '傳統媒體 (電視、廣播) 仍有影響力',
                        '戶外廣告在主要城市效果良好'
                    ],
                    business_culture: [
                        '極度重視品質和技術標準，ISO 認證是基本要求',
                        '決策過程需要詳細分析和論證，不喜歡快速決策',
                        '重視合規性和法規要求，法律文件必須完整',
                        '長期合作關係，信任建立需要時間，但一旦建立很穩固',
                        '創新接受度中等，但重視實用性和投資回報',
                        '溝通風格直接但禮貌，重視準確性和專業性',
                        '時間觀念嚴格，會議準時開始和結束',
                        '階級觀念較強，職位和學歷很重要',
                        '重視可持續發展和企業社會責任',
                        '談判過程需要耐心，不喜歡高壓銷售'
                    ],
                    b2b_strategy: [
                        '建立技術權威形象，提供詳細的技術文檔',
                        '重視長期關係建立，不要期待快速成交',
                        '準備充分的數據和案例研究來支持提案',
                        '強調品質、可靠性和技術優勢',
                        '考慮當地合作夥伴或代理商',
                        '重視售後服務和技術支持',
                        '準備德語版本的營銷材料',
                        '參加德國重要的行業展覽會',
                        '建立當地的技術支持團隊',
                        '重視合規性和法規要求'
                    ],
                    localization_recommendations: [
                        '所有材料必須有德語版本，英語可作為輔助',
                        '適應德國的數據保護法規 (GDPR)',
                        '考慮德國的稅務和會計要求',
                        '適應德國的勞動法規和工會文化',
                        '重視德國的環保標準和認證',
                        '適應德國的商業禮儀和溝通習慣',
                        '考慮德國的節假日和休假文化',
                        '適應德國的支付習慣和財務流程',
                        '重視德國的品質標準和認證要求',
                        '考慮德國的區域差異和文化多樣性'
                    ],
                    regulatory_compliance: [
                        '嚴格遵守歐盟 GDPR 數據保護法規',
                        '符合德國產品安全法 (ProdSG) 要求',
                        '遵守德國競爭法 (GWB) 和反壟斷法',
                        '符合德國稅法要求，包括 VAT 和企業稅',
                        '遵守德國勞動法規和工會協議',
                        '符合德國環保法規和永續發展要求',
                        '遵守德國金融服務法規 (KWG)',
                        '符合德國醫療設備法規 (MPG)',
                        '遵守德國化學品法規 (ChemG)',
                        '符合德國建築法規和標準 (DIN)'
                    ],
                    competitive_analysis_template: {
                        'direct_competitors': [
                            '分析德國本土競爭對手',
                            '評估歐洲其他國家的競爭對手',
                            '分析全球性企業在德國的表現',
                            '評估新興科技公司的威脅'
                        ],
                        'competitive_advantages': [
                            '技術優勢和專利分析',
                            '品質和可靠性優勢',
                            '服務和支援優勢',
                            '價格和成本優勢',
                            '創新和研發能力'
                        ],
                        'market_positioning': [
                            '高端品質定位',
                            '技術領先定位',
                            '可持續發展定位',
                            '成本效益定位',
                            '創新解決方案定位'
                        ]
                    },
                    success_case_database: [
                        'SAP 在德國的成功案例',
                        '西門子在工業 4.0 的領導地位',
                        '寶馬在電動車市場的轉型',
                        '拜耳在醫療科技領域的創新',
                        '阿迪達斯在數位化轉型的成功',
                        '大眾汽車在電動化轉型的策略',
                        '博世在物聯網領域的發展',
                        '默克在生物科技領域的突破'
                    ],
                    roi_prediction_model: {
                        'short_term_roi': '6-12 個月，預期 ROI: 15-25%',
                        'medium_term_roi': '1-2 年，預期 ROI: 30-45%',
                        'long_term_roi': '3-5 年，預期 ROI: 50-80%',
                        'key_factors': [
                            '市場進入時機和策略',
                            '本地化程度和適應性',
                            '競爭環境和差異化優勢',
                            '法規合規性和風險管理',
                            '長期關係建立和信任度'
                        ]
                    }
                }
            };

            return insights[market] || insights['taiwan'];
        }

        // 顯示市場洞察
        function showMarketInsights(insights) {
            const existingInsights = document.getElementById('market-insights');
            if (existingInsights) {
                existingInsights.remove();
            }

            // 檢查是否為德國市場，如果是則顯示完整深度分析
            const isGermanyMarket = insights.title && insights.title.includes('德國');
            
            let insightsHtml = `
                <div id="market-insights" class="mt-4 p-4 bg-indigo-50 border-l-4 border-indigo-400 rounded-lg">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="text-sm font-medium text-indigo-800">${insights.title}</h4>
                            <div class="mt-2 text-sm text-indigo-700">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <h5 class="font-medium mb-1">市場特徵</h5>
                                        <ul class="list-disc list-inside space-y-1">
                                            ${insights.characteristics.map(char => `<li>${char}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div>
                                        <h5 class="font-medium mb-1">媒體偏好</h5>
                                        <ul class="list-disc list-inside space-y-1">
                                            ${insights.media_preferences.map(pref => `<li>${pref}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div>
                                        <h5 class="font-medium mb-1">商業文化</h5>
                                        <ul class="list-disc list-inside space-y-1">
                                            ${insights.business_culture.map(culture => `<li>${culture}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 如果是德國市場，添加額外的深度分析內容
            if (isGermanyMarket && insights.b2b_strategy) {
                insightsHtml += `
                    <div id="germany-deep-insights" class="mt-4 space-y-4">
                        <!-- B2B 策略建議 -->
                        <div class="p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg">
                            <h5 class="font-medium text-blue-800 mb-2">🇩🇪 德國市場 B2B 策略建議</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <ul class="list-disc list-inside space-y-1 text-sm text-blue-700">
                                    ${insights.b2b_strategy.slice(0, 5).map(strategy => `<li>${strategy}</li>`).join('')}
                                </ul>
                                <ul class="list-disc list-inside space-y-1 text-sm text-blue-700">
                                    ${insights.b2b_strategy.slice(5).map(strategy => `<li>${strategy}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <!-- 本地化建議 -->
                        <div class="p-4 bg-green-50 border-l-4 border-green-400 rounded-lg">
                            <h5 class="font-medium text-green-800 mb-2">🌍 德國市場本地化建議</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <ul class="list-disc list-inside space-y-1 text-sm text-green-700">
                                    ${insights.localization_recommendations.slice(0, 5).map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                                <ul class="list-disc list-inside space-y-1 text-sm text-green-700">
                                    ${insights.localization_recommendations.slice(5).map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <!-- 法規合規性 -->
                        <div class="p-4 bg-red-50 border-l-4 border-red-400 rounded-lg">
                            <h5 class="font-medium text-red-800 mb-2">⚖️ 德國法規合規性要求</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <ul class="list-disc list-inside space-y-1 text-sm text-red-700">
                                    ${insights.regulatory_compliance.slice(0, 5).map(compliance => `<li>${compliance}</li>`).join('')}
                                </ul>
                                <ul class="list-disc list-inside space-y-1 text-sm text-red-700">
                                    ${insights.regulatory_compliance.slice(5).map(compliance => `<li>${compliance}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <!-- 競爭分析模板 -->
                        <div class="p-4 bg-purple-50 border-l-4 border-purple-400 rounded-lg">
                            <h5 class="font-medium text-purple-800 mb-2">🎯 德國市場競爭分析模板</h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <h6 class="font-medium text-purple-700 mb-1">直接競爭對手</h6>
                                    <ul class="list-disc list-inside space-y-1 text-sm text-purple-600">
                                        ${insights.competitive_analysis_template.direct_competitors.map(comp => `<li>${comp}</li>`).join('')}
                                    </ul>
                                </div>
                                <div>
                                    <h6 class="font-medium text-purple-700 mb-1">競爭優勢</h6>
                                    <ul class="list-disc list-inside space-y-1 text-sm text-purple-600">
                                        ${insights.competitive_analysis_template.competitive_advantages.map(adv => `<li>${adv}</li>`).join('')}
                                    </ul>
                                </div>
                                <div>
                                    <h6 class="font-medium text-purple-700 mb-1">市場定位</h6>
                                    <ul class="list-disc list-inside space-y-1 text-sm text-purple-600">
                                        ${insights.competitive_analysis_template.market_positioning.map(pos => `<li>${pos}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 成功案例資料庫 -->
                        <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg">
                            <h5 class="font-medium text-yellow-800 mb-2">🏆 德國市場成功案例資料庫</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <ul class="list-disc list-inside space-y-1 text-sm text-yellow-700">
                                    ${insights.success_case_database.slice(0, 4).map(case_study => `<li>${case_study}</li>`).join('')}
                                </ul>
                                <ul class="list-disc list-inside space-y-1 text-sm text-yellow-700">
                                    ${insights.success_case_database.slice(4).map(case_study => `<li>${case_study}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <!-- ROI 預測模型 -->
                        <div class="p-4 bg-indigo-50 border-l-4 border-indigo-400 rounded-lg">
                            <h5 class="font-medium text-indigo-800 mb-2">📊 德國市場 ROI 預測模型</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h6 class="font-medium text-indigo-700 mb-2">預期投資回報</h6>
                                    <ul class="space-y-2 text-sm text-indigo-600">
                                        <li><strong>短期 (6-12個月):</strong> ${insights.roi_prediction_model.short_term_roi}</li>
                                        <li><strong>中期 (1-2年):</strong> ${insights.roi_prediction_model.medium_term_roi}</li>
                                        <li><strong>長期 (3-5年):</strong> ${insights.roi_prediction_model.long_term_roi}</li>
                                    </ul>
                                </div>
                                <div>
                                    <h6 class="font-medium text-indigo-700 mb-2">關鍵影響因素</h6>
                                    <ul class="list-disc list-inside space-y-1 text-sm text-indigo-600">
                                        ${insights.roi_prediction_model.key_factors.map(factor => `<li>${factor}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 德國市場專用工具 -->
                        <div class="p-4 bg-gray-50 border-l-4 border-gray-400 rounded-lg">
                            <h5 class="font-medium text-gray-800 mb-3">🛠️ 德國市場專用分析工具</h5>
                            
                            <!-- 策略建議生成器 -->
                            <div class="mb-4">
                                <h6 class="font-medium text-gray-700 mb-2">🎯 策略建議生成器</h6>
                                <div class="flex gap-2 mb-2">
                                    <select id="german-strategy-type" class="px-3 py-1 text-sm border border-gray-300 rounded">
                                        <option value="b2b">B2B 策略</option>
                                        <option value="localization">本地化策略</option>
                                        <option value="compliance">合規策略</option>
                                        <option value="marketing">行銷策略</option>
                                    </select>
                                    <button onclick="generateGermanStrategy()" class="px-4 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                        生成建議
                                    </button>
                                </div>
                                <div id="german-strategy-output" class="p-3 bg-white border border-gray-200 rounded text-sm text-gray-700 min-h-[60px]">
                                    選擇策略類型並點擊生成建議...
                                </div>
                            </div>

                            <!-- 德國市場分析檢查清單 -->
                            <div class="mb-4">
                                <h6 class="font-medium text-gray-700 mb-2">✅ 德國市場進入檢查清單</h6>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="german-checklist" value="legal"> 
                                        <span class="text-sm">法律合規性確認</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="german-checklist" value="localization"> 
                                        <span class="text-sm">德文本地化完成</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="german-checklist" value="certification"> 
                                        <span class="text-sm">技術認證取得</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="german-checklist" value="partnership"> 
                                        <span class="text-sm">本地合作夥伴</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="german-checklist" value="cultural"> 
                                        <span class="text-sm">文化適應性評估</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="german-checklist" value="pricing"> 
                                        <span class="text-sm">定價策略調整</span>
                                    </label>
                                </div>
                                <button onclick="checkGermanMarketReadiness()" class="mt-2 px-4 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                                    檢查準備度
                                </button>
                                <div id="german-readiness-score" class="mt-2 text-sm"></div>
                            </div>

                            <!-- 德國市場趨勢分析 -->
                            <div>
                                <h6 class="font-medium text-gray-700 mb-2">📈 德國市場趨勢分析</h6>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                                    <div class="p-2 bg-blue-100 rounded">
                                        <div class="font-medium text-blue-800">數位化趨勢</div>
                                        <div class="text-blue-600">工業4.0 加速</div>
                                    </div>
                                    <div class="p-2 bg-green-100 rounded">
                                        <div class="font-medium text-green-800">永續發展</div>
                                        <div class="text-green-600">碳中和目標</div>
                                    </div>
                                    <div class="p-2 bg-purple-100 rounded">
                                        <div class="font-medium text-purple-800">創新投資</div>
                                        <div class="text-purple-600">研發支出增加</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 德國市場進入策略規劃器 -->
                            <div class="mt-4 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
                                <h6 class="font-medium text-blue-800 mb-3">🚀 德國市場進入策略規劃器</h6>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium text-blue-700 mb-1">產品/服務類型</label>
                                        <select id="german-product-type" class="w-full px-2 py-1 text-xs border border-blue-300 rounded">
                                            <option value="b2b-software">B2B 軟體/技術</option>
                                            <option value="manufacturing">製造業設備</option>
                                            <option value="consulting">諮詢服務</option>
                                            <option value="ecommerce">電子商務</option>
                                            <option value="healthcare">醫療健康</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-blue-700 mb-1">進入模式</label>
                                        <select id="german-entry-mode" class="w-full px-2 py-1 text-xs border border-blue-300 rounded">
                                            <option value="direct">直接進入</option>
                                            <option value="partnership">合資/合作</option>
                                            <option value="acquisition">收購現有企業</option>
                                            <option value="licensing">授權經營</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-blue-700 mb-1">時間框架</label>
                                        <select id="german-timeline" class="w-full px-2 py-1 text-xs border border-blue-300 rounded">
                                            <option value="6months">6個月內</option>
                                            <option value="1year">1年內</option>
                                            <option value="2years">2年內</option>
                                            <option value="3years">3年內</option>
                                        </select>
                                    </div>
                                    <button onclick="generateGermanEntryStrategy()" class="w-full px-3 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                        生成進入策略
                                    </button>
                                </div>
                                <div id="german-entry-strategy-output" class="mt-3 p-3 bg-white border border-blue-200 rounded text-xs text-blue-700 min-h-[80px]">
                                    填寫參數並點擊生成進入策略...
                                </div>
                            </div>

                            <!-- 德國市場報告生成器 -->
                            <div class="mt-4 p-3 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg">
                                <h6 class="font-medium text-green-800 mb-3">📊 德國市場報告生成器</h6>
                                <div class="space-y-3">
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="flex items-center space-x-2">
                                            <input type="checkbox" id="german-report-market" value="market" checked> 
                                            <span class="text-xs">市場分析</span>
                                        </label>
                                        <label class="flex items-center space-x-2">
                                            <input type="checkbox" id="german-report-competition" value="competition" checked> 
                                            <span class="text-xs">競爭分析</span>
                                        </label>
                                        <label class="flex items-center space-x-2">
                                            <input type="checkbox" id="german-report-strategy" value="strategy" checked> 
                                            <span class="text-xs">策略建議</span>
                                        </label>
                                        <label class="flex items-center space-x-2">
                                            <input type="checkbox" id="german-report-compliance" value="compliance" checked> 
                                            <span class="text-xs">合規要求</span>
                                        </label>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="generateGermanReport()" class="flex-1 px-3 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                                            生成報告
                                        </button>
                                        <button onclick="exportGermanReport()" class="px-3 py-2 bg-emerald-600 text-white text-sm rounded hover:bg-emerald-700">
                                            導出PDF
                                        </button>
                                    </div>
                                </div>
                                <div id="german-report-output" class="mt-3 p-3 bg-white border border-green-200 rounded text-xs text-green-700 min-h-[100px] max-h-[200px] overflow-y-auto">
                                    選擇報告內容並點擊生成報告...
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            const primaryMarketField = document.getElementById('primaryMarket');
            if (primaryMarketField) {
                primaryMarketField.parentElement.insertAdjacentHTML('afterend', insightsHtml);
            }
        }

        // 德國市場策略建議生成器
        function generateGermanStrategy() {
            const strategyType = document.getElementById('german-strategy-type').value;
            const output = document.getElementById('german-strategy-output');
            
            const strategies = {
                b2b: [
                    '建立技術專家團隊，提供深度技術支援',
                    '參與德國工業展覽會 (如 Hannover Messe)',
                    '與德國技術大學建立合作關係',
                    '提供德語技術文檔和培訓材料',
                    '建立本地技術支援中心'
                ],
                localization: [
                    '聘請德語母語者進行內容審核',
                    '適應德國文化習俗和商業禮儀',
                    '調整產品包裝符合德國標準',
                    '提供德語客戶服務和支援',
                    '考慮德國區域差異 (南北差異)'
                ],
                compliance: [
                    '確保符合 EU GDPR 數據保護法規',
                    '取得德國技術認證 (如 TÜV, VDE)',
                    '遵守德國勞動法和稅務規定',
                    '符合德國環保標準和法規',
                    '建立合規性監控機制'
                ],
                marketing: [
                    '使用 LinkedIn 進行 B2B 行銷',
                    '在專業媒體投放廣告',
                    '建立德國本地社群媒體存在',
                    '舉辦德國本地活動和研討會',
                    '與德國影響者合作推廣'
                ]
            };
            
            const selectedStrategies = strategies[strategyType];
            const randomStrategies = selectedStrategies.sort(() => 0.5 - Math.random()).slice(0, 3);
            
            output.innerHTML = `
                <div class="font-medium text-gray-800 mb-2">🎯 ${strategyType.toUpperCase()} 策略建議:</div>
                <ul class="list-disc list-inside space-y-1">
                    ${randomStrategies.map(strategy => `<li>${strategy}</li>`).join('')}
                </ul>
            `;
        }

        // 檢查德國市場準備度
        function checkGermanMarketReadiness() {
            const checkboxes = document.querySelectorAll('.german-checklist:checked');
            const totalCheckboxes = document.querySelectorAll('.german-checklist').length;
            const readinessScore = Math.round((checkboxes.length / totalCheckboxes) * 100);
            
            const scoreElement = document.getElementById('german-readiness-score');
            let scoreClass = 'text-red-600';
            let scoreText = '需要更多準備';
            
            if (readinessScore >= 80) {
                scoreClass = 'text-green-600';
                scoreText = '準備充分，可以進入市場';
            } else if (readinessScore >= 60) {
                scoreClass = 'text-yellow-600';
                scoreText = '基本準備完成，建議進一步完善';
            }
            
            scoreElement.innerHTML = `
                <div class="font-medium ${scoreClass}">
                    準備度: ${readinessScore}% - ${scoreText}
                </div>
                <div class="text-xs text-gray-600 mt-1">
                    已完成 ${checkboxes.length}/${totalCheckboxes} 項檢查
                </div>
            `;
        }

        // 生成德國市場進入策略
        function generateGermanEntryStrategy() {
            const productType = document.getElementById('german-product-type').value;
            const entryMode = document.getElementById('german-entry-mode').value;
            const timeline = document.getElementById('german-timeline').value;
            const output = document.getElementById('german-entry-strategy-output');
            
            const strategies = {
                'b2b-software': {
                    'direct': '建立德國子公司，組建本地銷售和技術團隊',
                    'partnership': '與德國系統整合商合作，提供本地化支援',
                    'acquisition': '收購德國本土軟體公司，快速獲得市場份額',
                    'licensing': '授權德國合作夥伴進行本地化開發和銷售'
                },
                'manufacturing': {
                    'direct': '在德國建立生產基地，符合德國製造標準',
                    'partnership': '與德國製造商合作，共享技術和市場資源',
                    'acquisition': '收購德國製造企業，獲得技術和認證',
                    'licensing': '授權德國製造商使用技術，收取授權費'
                },
                'consulting': {
                    'direct': '建立德國諮詢辦公室，聘請本地專家',
                    'partnership': '與德國諮詢公司合作，提供專業服務',
                    'acquisition': '收購德國諮詢公司，快速進入市場',
                    'licensing': '授權德國合作夥伴使用諮詢方法和工具'
                },
                'ecommerce': {
                    'direct': '建立德國電商平台，提供本地化服務',
                    'partnership': '與德國電商平台合作，共享用戶基礎',
                    'acquisition': '收購德國電商企業，獲得用戶和品牌',
                    'licensing': '授權德國合作夥伴使用電商技術和品牌'
                },
                'healthcare': {
                    'direct': '建立德國醫療設備公司，符合歐盟標準',
                    'partnership': '與德國醫療機構合作，進行臨床試驗',
                    'acquisition': '收購德國醫療企業，獲得認證和渠道',
                    'licensing': '授權德國醫療企業使用技術和專利'
                }
            };
            
            const timelineStrategies = {
                '6months': '快速進入策略：建立代表處，尋找合作夥伴',
                '1year': '穩健進入策略：完成法律註冊，組建核心團隊',
                '2years': '全面進入策略：建立完整業務體系，開展本地行銷',
                '3years': '長期發展策略：建立研發中心，進行深度本地化'
            };
            
            const selectedStrategy = strategies[productType][entryMode];
            const timelineStrategy = timelineStrategies[timeline];
            
            output.innerHTML = `
                <div class="font-medium text-blue-800 mb-2">🚀 德國市場進入策略:</div>
                <div class="space-y-2">
                    <div><strong>產品類型:</strong> ${document.getElementById('german-product-type').options[document.getElementById('german-product-type').selectedIndex].text}</div>
                    <div><strong>進入模式:</strong> ${selectedStrategy}</div>
                    <div><strong>時間框架:</strong> ${timelineStrategy}</div>
                </div>
                <div class="mt-2 p-2 bg-blue-50 rounded text-xs">
                    <strong>建議:</strong> 根據選擇的參數，建議優先考慮 ${entryMode === 'partnership' ? '建立戰略合作關係' : entryMode === 'acquisition' ? '尋找合適的收購目標' : entryMode === 'licensing' ? '發展授權合作夥伴' : '直接建立本地團隊'}，並在 ${timeline} 內完成市場進入準備。
                </div>
            `;
        }

        // 生成德國市場報告
        function generateGermanReport() {
            const output = document.getElementById('german-report-output');
            const marketChecked = document.getElementById('german-report-market').checked;
            const competitionChecked = document.getElementById('german-report-competition').checked;
            const strategyChecked = document.getElementById('german-report-strategy').checked;
            const complianceChecked = document.getElementById('german-report-compliance').checked;
            
            let reportContent = '<div class="space-y-3">';
            reportContent += '<div class="font-medium text-green-800">📊 德國市場分析報告</div>';
            reportContent += '<div class="text-xs text-gray-600">生成時間: ' + new Date().toLocaleString('zh-TW') + '</div>';
            
            if (marketChecked) {
                reportContent += `
                    <div class="p-2 bg-green-50 rounded">
                        <div class="font-medium text-green-700">🏭 市場特性</div>
                        <ul class="text-xs text-green-600 mt-1 space-y-1">
                            <li>• 高度成熟的工業化經濟體，GDP 全球第四</li>
                            <li>• 品質要求極高，重視技術標準和認證</li>
                            <li>• 決策過程嚴謹，需要詳細技術文件和數據支持</li>
                            <li>• 環保意識強，永續發展和綠色技術優先</li>
                        </ul>
                    </div>
                `;
            }
            
            if (competitionChecked) {
                reportContent += `
                    <div class="p-2 bg-blue-50 rounded">
                        <div class="font-medium text-blue-700">🎯 競爭分析</div>
                        <ul class="text-xs text-blue-600 mt-1 space-y-1">
                            <li>• 直接競爭對手：Siemens, Bosch, SAP</li>
                            <li>• 競爭優勢：技術創新、品質保證、本地化服務</li>
                            <li>• 市場定位：高端技術解決方案提供商</li>
                        </ul>
                    </div>
                `;
            }
            
            if (strategyChecked) {
                reportContent += `
                    <div class="p-2 bg-purple-50 rounded">
                        <div class="font-medium text-purple-700">💡 策略建議</div>
                        <ul class="text-xs text-purple-600 mt-1 space-y-1">
                            <li>• 建立技術專家團隊，提供深度技術支援</li>
                            <li>• 參與德國工業展覽會，建立品牌知名度</li>
                            <li>• 與德國技術大學建立合作關係</li>
                            <li>• 提供德語技術文檔和培訓材料</li>
                        </ul>
                    </div>
                `;
            }
            
            if (complianceChecked) {
                reportContent += `
                    <div class="p-2 bg-red-50 rounded">
                        <div class="font-medium text-red-700">⚖️ 合規要求</div>
                        <ul class="text-xs text-red-600 mt-1 space-y-1">
                            <li>• 符合 EU GDPR 數據保護法規</li>
                            <li>• 取得德國技術認證 (TÜV, VDE)</li>
                            <li>• 遵守德國勞動法和稅務規定</li>
                            <li>• 符合德國環保標準和法規</li>
                        </ul>
                    </div>
                `;
            }
            
            reportContent += '</div>';
            output.innerHTML = reportContent;
        }

        // 導出德國市場報告為PDF
        function exportGermanReport() {
            const output = document.getElementById('german-report-output');
            if (output.innerHTML.includes('選擇報告內容並點擊生成報告')) {
                alert('請先生成報告內容');
                return;
            }
            
            // 創建可列印的報告內容
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>德國市場分析報告</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .section { margin-bottom: 20px; }
                        .section-title { font-weight: bold; color: #1f2937; margin-bottom: 10px; }
                        .content { margin-left: 20px; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>🇩🇪 德國市場分析報告</h1>
                        <p>生成時間: ${new Date().toLocaleString('zh-TW')}</p>
                    </div>
                    ${output.innerHTML.replace(/<[^>]*>/g, '').replace(/•/g, '• ')}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>

