<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自動化媒體提案引擎 (台灣市場特化版 MVP)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.1);
        }
        .btn-primary:disabled {
            background: #a5b4fc;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        #proposalOutput h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #60a5fa;
            padding-bottom: 0.5rem;
        }
        #proposalOutput h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1d4ed8;
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
        }
        #proposalOutput p, #proposalOutput li, #proposalOutput td, #proposalOutput th {
            color: #374151;
            line-height: 1.7;
        }
        #proposalOutput p, #proposalOutput ul {
             margin-bottom: 1rem;
        }
        #proposalOutput ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        #proposalOutput strong {
            color: #1e40af;
            font-weight: 600;
        }
        .status-update {
            transition: all 0.5s ease;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
        }
        .status-update.active {
            max-height: 100px; /* or a suitable max-height */
            opacity: 1;
            margin-top: 1rem;
        }
        .input-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .input-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        #proposalOutput table {
            width: 100%;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border-collapse: collapse;
        }
        #proposalOutput th, #proposalOutput td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
        }
        #proposalOutput th {
            background-color: #f9fafb;
            font-weight: 600;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-6xl mx-auto">
        <div class="card p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">自動化媒體提案引擎</h1>
                <p class="mt-2 text-gray-600">v2.5 安全金鑰版 (MVP)</p>
            </div>

            <!-- Module 1: 使用者與配置介面 ('駕駛艙') -->
            <div class="space-y-6">
                 <!-- API 金鑰輸入 -->
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <label for="apiKeyInput" class="block text-sm font-medium text-yellow-800 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 8a6 6 0 11-12 0 6 6 0 0112 0zM7 8a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd"></path></svg>
                        Google Gemini API 金鑰 <span class="text-red-500 ml-1">*</span>
                    </label>
                    <input type="password" id="apiKeyInput" class="mt-1 block w-full px-3 py-2 border border-yellow-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="請在此貼上您的 API 金鑰">
                    <p class="mt-2 text-xs text-yellow-700">此金鑰僅存於您目前的瀏覽器分頁，關閉後即消失，不會被儲存。</p>
                </div>
                
                <!-- Project ID 輸入 -->
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <label for="projectIdInput" class="block text-sm font-medium text-blue-800 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v2a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                        專案 ID <span class="text-gray-500 ml-1">(可選)</span>
                    </label>
                    <input type="text" id="projectIdInput" class="mt-1 block w-full px-3 py-2 border border-blue-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="請輸入專案 ID (可選)">
                    <p class="mt-2 text-xs text-blue-700">如無專案ID，系統將自動產生臨時ID用於檔案命名</p>
                </div>
                
                <!-- 集中化資料夾管理設定 -->
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <label class="block text-sm font-medium text-green-800 flex items-center mb-3">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H8a3 3 0 00-3 3v1.5a1.5 1.5 0 01-3 0V6z" clip-rule="evenodd"></path><path d="M6 12a2 2 0 012-2h8a2 2 0 012 2v2a2 2 0 01-2 2H2h2a2 2 0 01-2-2v-2z"></path></svg>
                        集中化資料夾管理 <span class="text-gray-500 ml-1">(可選)</span>
                    </label>
                    <div class="space-y-3">
                        <div>
                            <label for="centralFolderName" class="block text-xs font-medium text-green-700">主要專案資料夾名稱</label>
                            <input type="text" id="centralFolderName" class="mt-1 block w-full px-3 py-2 border border-green-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" value="iStaging_專案管理" placeholder="例如: iStaging_專案管理">
                        </div>
                        <div>
                            <label for="mediaplanSubfolder" class="block text-xs font-medium text-green-700">媒體提案子資料夾名稱</label>
                            <input type="text" id="mediaplanSubfolder" class="mt-1 block w-full px-3 py-2 border border-green-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" value="02_媒體提案" placeholder="例如: 02_媒體提案">
                        </div>
                    </div>
                    <p class="mt-2 text-xs text-green-700">設定後將自動建立專案資料夾結構並儲存結果</p>
                </div>

                <div class="border-t border-gray-200 pt-6">
                    <div class="input-grid">
                        <div>
                            <label for="targetBrand" class="block text-sm font-medium text-gray-700">目標品牌 / 產品 <span class="text-red-500">*</span></label>
                            <input type="text" id="targetBrand" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：gogoro, 星宇航空">
                        </div>
                        <div>
                            <label for="competitorBrand" class="block text-sm font-medium text-gray-700">主要競爭對手 <span class="text-red-500">*</span></label>
                            <input type="text" id="competitorBrand" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：光陽, 長榮航空">
                        </div>
                         <div>
                            <label for="industry" class="block text-sm font-medium text-gray-700">目標市場 / 產業 <span class="text-red-500">*</span></label>
                            <select id="industry" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option>消費性電子產品</option>
                                <option>時尚服飾與配件</option>
                                <option>美妝保養</option>
                                <option>旅遊與航空服務</option>
                                <option>餐飲業</option>
                                <option>B2B 軟體服務</option>
                                <option>金融與保險服務</option>
                                <option>其他</option>
                            </select>
                        </div>
                        <div>
                            <label for="businessModel" class="block text-sm font-medium text-gray-700">商業模式 <span class="text-red-500">*</span></label>
                             <select id="businessModel" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="B2C">B2C (企業對消費者)</option>
                                <option value="B2B">B2B (企業對企業)</option>
                            </select>
                        </div>
                         <div>
                            <label for="salesChannels" class="block text-sm font-medium text-gray-700">主要銷售通路</label>
                            <input type="text" id="salesChannels" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：線上官網、MOMO、實體門市">
                        </div>
                        <div>
                            <label for="targetAudience" class="block text-sm font-medium text-gray-700">目標人群描述</label>
                            <input type="text" id="targetAudience" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：25-35歲都會女性、科技業採購主管">
                        </div>
                         <div class="md:col-span-3">
                            <label for="advertisingBudget" class="block text-sm font-medium text-gray-700">預計廣告預算 (台幣)</label>
                            <input type="number" id="advertisingBudget" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：300000">
                        </div>
                    </div>
                </div>

                <!-- 跨國市場策略設定 -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        跨國市場策略設定
                    </h3>
                    <div class="input-grid">
                        <div>
                            <label for="targetMarkets" class="block text-sm font-medium text-gray-700">目標市場 <span class="text-red-500">*</span></label>
                            <select id="targetMarkets" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="single">單一市場 (台灣)</option>
                                <option value="multi-asia">多國亞洲市場</option>
                                <option value="global">全球市場</option>
                                <option value="custom">自訂市場組合</option>
                            </select>
                        </div>
                        <div>
                            <label for="primaryMarket" class="block text-sm font-medium text-gray-700">主要市場</label>
                            <select id="primaryMarket" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="taiwan">台灣</option>
                                <option value="japan">日本</option>
                                <option value="korea">韓國</option>
                                <option value="singapore">新加坡</option>
                                <option value="hongkong">香港</option>
                                <option value="malaysia">馬來西亞</option>
                                <option value="thailand">泰國</option>
                                <option value="vietnam">越南</option>
                                <option value="philippines">菲律賓</option>
                                <option value="indonesia">印尼</option>
                                <option value="china">中國</option>
                                <option value="usa">美國</option>
                                <option value="europe">歐洲</option>
                            </select>
                        </div>
                        <div>
                            <label for="secondaryMarkets" class="block text-sm font-medium text-gray-700">次要市場</label>
                            <input type="text" id="secondaryMarkets" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：日本、新加坡、香港">
                        </div>
                        <div>
                            <label for="marketEntryStrategy" class="block text-sm font-medium text-gray-700">市場進入策略</label>
                            <select id="marketEntryStrategy" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="organic">有機成長</option>
                                <option value="aggressive">積極擴張</option>
                                <option value="partnership">策略聯盟</option>
                                <option value="acquisition">併購進入</option>
                                <option value="franchise">特許經營</option>
                            </select>
                        </div>
                        <div>
                            <label for="localizationLevel" class="block text-sm font-medium text-gray-700">本地化程度</label>
                            <select id="localizationLevel" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="minimal">最小本地化</option>
                                <option value="moderate">中度本地化</option>
                                <option value="high">高度本地化</option>
                                <option value="full">完全本地化</option>
                            </select>
                        </div>
                        <div>
                            <label for="culturalSensitivity" class="block text-sm font-medium text-gray-700">文化敏感度</label>
                            <select id="culturalSensitivity" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="low">低 (標準化策略)</option>
                                <option value="medium">中 (適度調整)</option>
                                <option value="high">高 (深度文化適應)</option>
                                <option value="critical">關鍵 (文化優先)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 跨國溝通策略設定 -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        跨國溝通策略設定
                    </h3>
                    <div class="input-grid">
                        <div>
                            <label for="communicationStrategy" class="block text-sm font-medium text-gray-700">溝通策略類型</label>
                            <select id="communicationStrategy" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="global">全球統一策略</option>
                                <option value="glocal">全球在地化</option>
                                <option value="local">完全在地化</option>
                                <option value="hybrid">混合策略</option>
                            </select>
                        </div>
                        <div>
                            <label for="languageStrategy" class="block text-sm font-medium text-gray-700">語言策略</label>
                            <select id="languageStrategy" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="english">英語為主</option>
                                <option value="local">當地語言</option>
                                <option value="multilingual">多語言並行</option>
                                <option value="translation">翻譯策略</option>
                            </select>
                        </div>
                        <div>
                            <label for="toneStrategy" class="block text-sm font-medium text-gray-700">語調策略</label>
                            <select id="toneStrategy" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="formal">正式專業</option>
                                <option value="casual">輕鬆親切</option>
                                <option value="luxury">奢華高端</option>
                                <option value="youthful">年輕活力</option>
                                <option value="adaptive">適應性語調</option>
                            </select>
                        </div>
                        <div>
                            <label for="channelStrategy" class="block text-sm font-medium text-gray-700">通路策略</label>
                            <select id="channelStrategy" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="digital">數位優先</option>
                                <option value="traditional">傳統媒體</option>
                                <option value="omnichannel">全通路整合</option>
                                <option value="social">社群媒體</option>
                                <option value="influencer">網紅行銷</option>
                            </select>
                        </div>
                        <div>
                            <label for="timingStrategy" class="block text-sm font-medium text-gray-700">時機策略</label>
                            <select id="timingStrategy" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="simultaneous">同步發布</option>
                                <option value="staggered">分階段發布</option>
                                <option value="localized">當地時機</option>
                                <option value="event-driven">事件驅動</option>
                            </select>
                        </div>
                        <div>
                            <label for="crisisManagement" class="block text-sm font-medium text-gray-700">危機管理策略</label>
                            <select id="crisisManagement" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="centralized">中央化處理</option>
                                <option value="decentralized">分散化處理</option>
                                <option value="hybrid">混合處理</option>
                                <option value="localized">當地處理</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label for="culturalConsiderations" class="block text-sm font-medium text-gray-700">文化考量重點</label>
                            <textarea id="culturalConsiderations" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="請描述需要特別注意的文化敏感議題，例如：宗教禁忌、顏色象徵、數字禁忌等"></textarea>
                        </div>
                        <div class="md:col-span-3">
                            <label for="regulatoryRequirements" class="block text-sm font-medium text-gray-700">法規要求</label>
                            <textarea id="regulatoryRequirements" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="請描述各目標市場的廣告法規要求，例如：標示規定、內容限制、審查流程等"></textarea>
                        </div>
                    </div>
                </div>

                <button id="generateBtn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg flex items-center justify-center text-lg">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    生成 AI 分析報告
                </button>
            </div>

            <!-- 動態狀態更新區域 -->
            <div id="statusContainer" class="mt-4 space-y-2"></div>

            <!-- Module 4: 輸出與交付模組 ('渲染層') -->
            <div id="proposalOutput" class="mt-8 border-t-2 border-gray-200 pt-6">
                <!-- AI 生成的內容將會顯示在這裡 -->
            </div>
        </div>
        <footer class="text-center mt-4 text-sm text-gray-500">
            <p>本原型由 Google Gemini 驅動，所有分析皆為即時生成。</p>
        </footer>
    </div>

    <script type="module">
        // --- UI 元素 ---
        const apiKeyInput = document.getElementById('apiKeyInput');
        const projectIdInput = document.getElementById('projectIdInput');
        const generateBtn = document.getElementById('generateBtn');
        const targetBrandInput = document.getElementById('targetBrand');
        const competitorBrandInput = document.getElementById('competitorBrand');
        const industryInput = document.getElementById('industry');
        const businessModelInput = document.getElementById('businessModel');
        const salesChannelsInput = document.getElementById('salesChannels');
        const targetAudienceInput = document.getElementById('targetAudience');
        const advertisingBudgetInput = document.getElementById('advertisingBudget');
        const statusContainer = document.getElementById('statusContainer');
        const proposalOutput = document.getElementById('proposalOutput');

        // 跨國市場策略 UI 元素
        const targetMarketsInput = document.getElementById('targetMarkets');
        const primaryMarketInput = document.getElementById('primaryMarket');
        const secondaryMarketsInput = document.getElementById('secondaryMarkets');
        const marketEntryStrategyInput = document.getElementById('marketEntryStrategy');
        const localizationLevelInput = document.getElementById('localizationLevel');
        const culturalSensitivityInput = document.getElementById('culturalSensitivity');

        // 跨國溝通策略 UI 元素
        const communicationStrategyInput = document.getElementById('communicationStrategy');
        const languageStrategyInput = document.getElementById('languageStrategy');
        const toneStrategyInput = document.getElementById('toneStrategy');
        const channelStrategyInput = document.getElementById('channelStrategy');
        const timingStrategyInput = document.getElementById('timingStrategy');
        const crisisManagementInput = document.getElementById('crisisManagement');
        const culturalConsiderationsInput = document.getElementById('culturalConsiderations');
        const regulatoryRequirementsInput = document.getElementById('regulatoryRequirements');

        // 檢查必要元素是否存在
        if (!apiKeyInput || !projectIdInput || !generateBtn || !targetBrandInput || 
            !competitorBrandInput || !industryInput || !businessModelInput || 
            !salesChannelsInput || !targetAudienceInput || !advertisingBudgetInput || 
            !statusContainer || !proposalOutput || !targetMarketsInput || 
            !primaryMarketInput || !secondaryMarketsInput || !marketEntryStrategyInput ||
            !localizationLevelInput || !culturalSensitivityInput || !communicationStrategyInput ||
            !languageStrategyInput || !toneStrategyInput || !channelStrategyInput ||
            !timingStrategyInput || !crisisManagementInput || !culturalConsiderationsInput ||
            !regulatoryRequirementsInput) {
            console.error('某些必要的 UI 元素未找到，請檢查 HTML 結構');
            // 顯示錯誤訊息給用戶
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-50 flex items-center justify-center">
                    <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-6">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <h3 class="mt-4 text-lg font-medium text-gray-900">頁面載入錯誤</h3>
                            <p class="mt-2 text-sm text-gray-500">某些必要的 UI 元素未找到，請重新整理頁面或聯繫技術支援。</p>
                            <button onclick="location.reload()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                                重新整理頁面
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 全域變數儲存 project ID
        let currentProjectId = null;

        // 新增：集中化資料夾管理變數
        let folderStructure = {
            centralFolder: 'iStaging_專案管理',
            mediaplanSubfolder: '02_媒體提案'
        };
        let folderIds = {
            central: null,
            project: null,
            mediaplan: null
        };
        let isGoogleDriveEnabled = false;

        // 新增：從 URL 參數讀取 project ID
        function loadProjectIdFromUrl() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('projectId');
                if (projectId && projectIdInput) {
                    projectIdInput.value = projectId;
                    currentProjectId = projectId;
                    console.log('從 URL 讀取到專案 ID:', projectId);
                }
            } catch (error) {
                console.warn('讀取 URL 參數失敗:', error);
            }
        }

        // 頁面載入時讀取 project ID
        loadProjectIdFromUrl();

        // 綁定事件監聽器（只有在元素存在時才綁定）
        if (generateBtn) {
            generateBtn.addEventListener('click', handleGenerateClick);
        } else {
            console.error('生成按鈕未找到，無法綁定事件');
        }

        // 目標市場選擇的動態功能
        if (targetMarketsInput) {
            targetMarketsInput.addEventListener('change', function() {
                const selectedMarket = this.value;
                updateMarketFields(selectedMarket);
            });
        }

        // 更新市場相關欄位的顯示和預設值
        function updateMarketFields(selectedMarket) {
            const secondaryMarketsField = document.getElementById('secondaryMarkets');
            const primaryMarketField = document.getElementById('primaryMarket');
            const localizationField = document.getElementById('localizationLevel');
            const culturalSensitivityField = document.getElementById('culturalSensitivity');

            if (selectedMarket === 'single') {
                // 單一市場：隱藏次要市場，設定本地化為中度
                if (secondaryMarketsField) {
                    secondaryMarketsField.value = '';
                    secondaryMarketsField.parentElement.style.display = 'none';
                }
                if (localizationField) {
                    localizationField.value = 'moderate';
                }
                if (culturalSensitivityField) {
                    culturalSensitivityField.value = 'medium';
                }
            } else if (selectedMarket === 'multi-asia') {
                // 多國亞洲市場：顯示次要市場，設定本地化為高度
                if (secondaryMarketsField) {
                    secondaryMarketsField.parentElement.style.display = 'block';
                    secondaryMarketsField.placeholder = '例如：日本、新加坡、香港、馬來西亞';
                }
                if (localizationField) {
                    localizationField.value = 'high';
                }
                if (culturalSensitivityField) {
                    culturalSensitivityField.value = 'high';
                }
            } else if (selectedMarket === 'global') {
                // 全球市場：顯示次要市場，設定本地化為完全
                if (secondaryMarketsField) {
                    secondaryMarketsField.parentElement.style.display = 'block';
                    secondaryMarketsField.placeholder = '例如：美國、歐洲、日本、東南亞';
                }
                if (localizationField) {
                    localizationField.value = 'full';
                }
                if (culturalSensitivityField) {
                    culturalSensitivityField.value = 'critical';
                }
            } else if (selectedMarket === 'custom') {
                // 自訂市場：顯示次要市場，保持預設值
                if (secondaryMarketsField) {
                    secondaryMarketsField.parentElement.style.display = 'block';
                    secondaryMarketsField.placeholder = '請輸入自訂的次要市場';
                }
            }
        }

        // --- Module 2: AI 任務協調與執行核心 ('融合中樞') ---
        async function callGeminiAPI(prompt, apiKey, isJsonMode = false) {
            if (!apiKey) {
                throw new Error("Google Gemini API 金鑰為空，請在介面上方輸入。");
            }
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };
            if (isJsonMode) {
                payload.generationConfig = { responseMimeType: "application/json" };
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`AI API 請求失敗 (狀態 ${response.status}): ${errorBody}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                const rawText = result.candidates[0].content.parts[0].text;
                
                if (isJsonMode) {
                    try {
                        // 嘗試直接解析
                        return JSON.parse(rawText);
                    } catch (parseError) {
                        console.warn('直接 JSON 解析失敗，嘗試清理文字:', parseError);
                        
                        // 清理文字，移除可能的 markdown 標記和額外文字
                        let cleanedText = rawText.trim();
                        
                        // 移除可能的 ```json 和 ``` 標記
                        cleanedText = cleanedText.replace(/```json\s*/gi, '').replace(/```\s*$/gi, '');
                        
                        // 尋找 JSON 物件開始和結束的位置
                        const jsonStart = cleanedText.indexOf('{');
                        const jsonEnd = cleanedText.lastIndexOf('}');
                        
                        if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
                            cleanedText = cleanedText.substring(jsonStart, jsonEnd + 1);
                        }
                        
                        try {
                            return JSON.parse(cleanedText);
                        } catch (secondError) {
                            console.error('清理後的 JSON 解析仍然失敗:', secondError);
                            console.error('原始文字:', rawText);
                            console.error('清理後文字:', cleanedText);
                            throw new Error(`JSON 解析失敗: ${secondError.message}。請檢查主控台查看詳細資訊。`);
                        }
                    }
                } else {
                    return rawText;
                }
            } else {
                console.error("AI 回應格式不符:", result);
                throw new Error("AI 未能生成有效的分析報告，請檢查主控台。");
            }
        }
        
        function updateStatus(text, state = 'running') {
            if (!statusContainer) {
                console.error('狀態容器未找到');
                return null;
            }

            const statusId = `status-${Date.now()}`;
            const icon = {
                running: `<svg class="animate-spin h-5 w-5 mr-3 text-indigo-500" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`,
                done: `<svg class="h-5 w-5 mr-3 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`,
                error: `<svg class="h-5 w-5 mr-3 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`,
            };
            const div = document.createElement('div');
            div.id = statusId;
            div.className = 'status-update flex items-center p-3 bg-gray-100 rounded-lg';
            div.innerHTML = `${icon[state]}<p class="text-gray-700">${text}</p>`;
            statusContainer.appendChild(div);
            setTimeout(() => div.classList.add('active'), 10);
            return statusId;
        }

        function markStatusDone(statusId) {
            if (!statusId) return;
            
            const statusElement = document.getElementById(statusId);
            if (statusElement) {
                statusElement.innerHTML = statusElement.innerHTML.replace(/<svg.*?<\/svg>/, 
                    `<svg class="h-5 w-5 mr-3 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`
                );
            }
        }
        
        // --- 分析任務定義 ---
        async function analyzeForumSentiment(context, apiKey) {
            const prompt = `
                你是一位專精台灣市場的資深市場分析師。請你根據以下品牌情境，在台灣主流論壇 Dcard 和 PTT 上進行輿情分析。

                **品牌情境:**
                - **目標品牌:** ${context.target}
                - **競爭品牌:** ${context.competitor}
                - **所屬產業:** ${context.industry}
                - **商業模式:** ${context.businessModel}
                - **主要銷售通路:** ${context.salesChannels}
                - **核心目標人群:** ${context.targetAudience}

                你的任務是總結比較的結果，並以一個 JSON 物件的格式回傳。JSON 物件必須包含以下幾個 key: 
                "target_profile", "target_pros", "target_cons", "competitor_pros", "competitor_cons", "market_opportunity"。

                - **target_profile:** 在論壇中，最接近「${context.targetAudience}」這個輪廓的討論者是誰？他們有什麼特徵？
                - **target_pros:** 這些目標人群讚賞目標品牌的優點是什麼？ (至少 2 點)。
                - **target_cons:** 這些目標人群抱怨目標品牌的缺點是什麼？ (至少 2 點)。
                - **competitor_pros:** 競爭品牌吸引這些目標人群的優點。
                - **competitor_cons:** 競爭品牌讓這些目標人群卻步的缺點。
                - **market_opportunity:** 根據以上分析，找出一個能精準打動「${context.targetAudience}」的市場溝通機會點。

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function analyzeSeoStrategy(context, apiKey) {
            const prompt = `
                你是一位頂尖的 SEO 策略顧問，特別熟悉台灣的 google.com.tw 搜尋引擎生態。
                請模擬「${context.targetAudience}」這個目標人群，在搜尋與「${context.target}」相關的關鍵字時，他們會看到什麼樣的搜尋結果頁面 (SERP)。

                **品牌情境:**
                - **目標品牌:** ${context.target}
                - **商業模式:** ${context.businessModel}
                - **核心目標人群:** ${context.targetAudience}

                你的任務是總結你的發現，並以一個 JSON 物件的格式回傳。JSON 物件必須包含以下幾個 key: 
                "main_competitors_in_serp", "dominant_content_format", "user_intent", "content_gap_opportunity"。

                - **main_competitors_in_serp:** 除了「${context.competitor}」之外，在自然搜尋結果中還常出現哪些競爭者？
                - **dominant_content_format:** 排名靠前的內容主要是長篇文章、產品比較頁、新聞稿，還是 YouTube 影片？
                - **user_intent:** 「${context.targetAudience}」在搜尋時，其主要的「搜尋意圖」是什麼？請根據 ${context.businessModel} 的特性來分析。
                - **content_gap_opportunity:** 根據 Google 的「其他人也問了」或「相關搜尋」，找出一個能解決「${context.targetAudience}」痛點，但市場上還沒有優質內容回答的問題，作為內容策略切入點。

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        async function estimateKpiAndBudget(context, opportunity, apiKey) {
            if (!context.budget || context.budget <= 0) {
                 return { budget_allocation: [], kpi_estimations: [], rationale: "未提供預算，無法進行估算。" };
            }
            const prompt = `
                你是一位經驗豐富的數位媒體規劃師 (Media Planner)，擅長台灣市場的媒體投資與成效預估。
                根據以下客戶情境與你已知的市場機會點，規劃一份初步的預算分配與 KPI 預估。

                **客戶情境:**
                - **產業:** ${context.industry}
                - **商業模式:** ${context.businessModel}
                - **目標人群:** ${context.targetAudience}
                - **總預算 (TWD):** ${context.budget.toLocaleString()}
                - **核心策略機會點:** ${opportunity}

                你的任務是產出一個 JSON 物件，包含 "budget_allocation", "kpi_estimations", "rationale" 三個 key。

                1.  **budget_allocation:** 一個陣列。根據「核心策略機會點」，建議將預算分配到 2-3 個最相關的媒體渠道 (例如：付費搜尋, 社群廣告, 內容行銷, 影音廣告)，並給出每個渠道的**百分比**和**金額**。
                2.  **kpi_estimations:** 一個陣列。為每個建議的渠道，提供**可量化的 KPI 預估**。請使用台灣市場的典型 benchmarks (基準)。
                    -   **對於 B2C:** 需包含 "Impressions" (曝光), "CTR" (點擊率), "Clicks" (點擊), "CPC" (單次點擊成本), "Est_Conversions" (預估訂單數，請自訂一個合理的轉換率)。
                    -   **對於 B2B:** 需包含 "Impressions", "CTR", "Clicks", "CPC", "Est_Leads" (預估潛在客戶數，請自訂一個合理的轉換率)。
                3.  **rationale:** 一段簡短文字，說明你這樣規劃預算優先級的理由。

                請確保回傳的內容是純粹的 JSON 格式。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        // 跨國市場策略分析
        async function analyzeInternationalMarketStrategy(context, apiKey) {
            const prompt = `
                你是一位資深的國際市場策略顧問，專精於跨國市場進入策略和本地化策略。
                請根據以下品牌情境，分析跨國市場策略和溝通策略。

                **品牌情境:**
                - **目標品牌:** ${context.target}
                - **競爭品牌:** ${context.competitor}
                - **產業:** ${context.industry}
                - **商業模式:** ${context.businessModel}
                - **目標人群:** ${context.targetAudience}
                - **目標市場:** ${context.targetMarkets}
                - **主要市場:** ${context.primaryMarket}
                - **次要市場:** ${context.secondaryMarkets}
                - **市場進入策略:** ${context.marketEntryStrategy}
                - **本地化程度:** ${context.localizationLevel}
                - **文化敏感度:** ${context.culturalSensitivity}
                - **溝通策略類型:** ${context.communicationStrategy}
                - **語言策略:** ${context.languageStrategy}
                - **語調策略:** ${context.toneStrategy}
                - **通路策略:** ${context.channelStrategy}
                - **時機策略:** ${context.timingStrategy}
                - **危機管理策略:** ${context.crisisManagement}
                - **文化考量重點:** ${context.culturalConsiderations}
                - **法規要求:** ${context.regulatoryRequirements}

                你的任務是產出一個 JSON 物件，包含以下 key：

                1. **market_analysis:** 包含 "market_opportunities", "market_challenges", "competitive_landscape", "entry_timing"
                2. **localization_strategy:** 包含 "product_adaptation", "communication_adaptation", "cultural_considerations", "regulatory_compliance"
                3. **communication_framework:** 包含 "global_message", "local_messages", "channel_mix", "timing_strategy"
                4. **risk_management:** 包含 "cultural_risks", "regulatory_risks", "competitive_risks", "mitigation_strategies"
                5. **success_metrics:** 包含 "market_penetration", "brand_awareness", "cultural_acceptance", "regulatory_compliance"

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        // 跨國文化適應性分析
        async function analyzeCulturalAdaptation(context, apiKey) {
            const prompt = `
                你是一位跨文化溝通專家，專精於亞洲市場的文化適應策略。
                請根據以下情境，分析在不同目標市場的文化適應策略。

                **分析情境:**
                - **目標品牌:** ${context.target}
                - **主要市場:** ${context.primaryMarket}
                - **次要市場:** ${context.secondaryMarkets}
                - **文化敏感度:** ${context.culturalSensitivity}
                - **文化考量重點:** ${context.culturalConsiderations}

                你的任務是產出一個 JSON 物件，包含以下 key：

                1. **cultural_insights:** 包含 "primary_market_culture", "secondary_markets_culture", "cultural_differences", "shared_values"
                2. **adaptation_strategies:** 包含 "visual_adaptation", "message_adaptation", "tone_adaptation", "timing_adaptation"
                3. **cultural_taboos:** 包含 "visual_taboos", "language_taboos", "concept_taboos", "timing_taboos"
                4. **localization_priorities:** 包含 "high_priority", "medium_priority", "low_priority", "not_required"
                5. **success_indicators:** 包含 "cultural_acceptance", "local_relevance", "brand_authenticity", "market_resonance"

                請確保回傳的內容是純粹的 JSON 格式，沒有任何額外的文字或註解。
            `;
            return await callGeminiAPI(prompt, apiKey, true);
        }

        // --- Module 3: 提案生成引擎 ('合成引擎') ---
        async function synthesizeFinalReport(context, forumAnalysis, seoAnalysis, kpiEstimation, internationalData, culturalData, apiKey) {
             const prompt = `
                你是一位首席媒體策略總監，你的任務是將下屬分析師提交的所有 JSON 資料，整合成一份給客戶看的、專業且有說服力的「市場機會與初步策略建議」報告。報告需以 HTML 格式呈現。

                **客戶資料:**
                - **目標品牌:** ${context.target}
                - **核心目標人群:** ${context.targetAudience}
                - **總預算 (TWD):** ${context.budget > 0 ? context.budget.toLocaleString() : '未提供'}
                - **目標市場:** ${context.targetMarkets}
                - **主要市場:** ${context.primaryMarket}
                - **次要市場:** ${context.secondaryMarkets}

                **分析師提交的資料:**
                1.  **論壇輿情分析:** ${JSON.stringify(forumAnalysis, null, 2)}
                2.  **SEO 與內容策略分析:** ${JSON.stringify(seoAnalysis, null, 2)}
                3.  **預算與 KPI 預估:** ${JSON.stringify(kpiEstimation, null, 2)}
                ${internationalData ? `4.  **跨國市場策略分析:** ${JSON.stringify(internationalData, null, 2)}` : ''}
                ${culturalData ? `5.  **跨國文化適應分析:** ${JSON.stringify(culturalData, null, 2)}` : ''}

                **你的任務:**
                請根據以上所有資訊，撰寫一份包含以下章節的 HTML 報告，並在你的分析與建議中，**始終緊扣如何打動「${context.targetAudience}」這個核心目標人群**：

                1.  **<h2>市場總體印象</h2>**
                    - 一段簡短總結，點出 ${context.target} 目前在「${context.targetAudience}」心中的形象與挑戰。

                2.  **<h2>核心洞察與機會點</h2>**
                    -   <h3>洞察一：目標人群的真實心聲</h3>
                    -   <h3>洞察二：搜尋戰場的內容缺口</h3>
                    -   <h3>策略機會點：我們該從何處切入？</h3>

                3.  **<h2>初步策略建議</h2>**
                    -   <h3>建議一：內容策略方向</h3>
                    -   <h3>建議二：溝通訊息切角</h3>
                
                4.  **<h2>預算規劃與預期效益</h2>**
                    -   <p>基於台幣 **${context.budget > 0 ? context.budget.toLocaleString() : '未提供'}** 的預算，我們建議初步的資源分配與效益預估如下：</p>
                    -   <h3>預算分配建議</h3>
                    -   (此處使用 HTML table 呈現 kpiEstimation.budget_allocation 的內容)
                    -   <h3>預期效益 (KPI) 估算</h3>
                    -   (此處使用 HTML table 呈現 kpiEstimation.kpi_estimations 的內容)
                    -   <h3>規劃說明</h3>
                    -   (此處用 <p> 呈現 kpiEstimation.rationale 的內容)
                
                ${internationalData ? `
                5.  **<h2>跨國市場策略分析</h2>**
                    -   <h3>市場機會與挑戰</h3>
                    -   <h3>本地化策略建議</h3>
                    -   <h3>溝通框架設計</h3>
                    -   <h3>風險管理策略</h3>
                    -   <h3>成功指標設定</h3>
                ` : ''}
                
                ${culturalData ? `
                6.  **<h2>跨國文化適應策略</h2>**
                    -   <h3>文化洞察分析</h3>
                    -   <h3>適應策略建議</h3>
                    -   <h3>文化禁忌提醒</h3>
                    -   <h3>本地化優先級</h3>
                    -   <h3>成功指標</h3>
                ` : ''}
                
                **格式要求:**
                -   請嚴格使用 <h2> 和 <h3> 作為標題。
                -   段落使用 <p>，列表使用 <ul> 和 <li>。表格使用 <table>, <th>, <tr>, <td>。
                -   對於品牌名稱或關鍵字詞，使用 <strong> 標籤強調。
                -   回應內容**僅包含 HTML**，不要包含 \`\`\`html, \`\`\`, <html>, <body> 等標籤。
            `;
             return await callGeminiAPI(prompt, apiKey, false);
        }

        // --- 主執行流程 ---
        async function handleGenerateClick() {
            try {
                // 檢查必要元素是否存在
                if (!apiKeyInput || !projectIdInput || !targetBrandInput || 
                    !competitorBrandInput || !industryInput || !businessModelInput || 
                    !salesChannelsInput || !targetAudienceInput || !advertisingBudgetInput) {
                    throw new Error('某些必要的 UI 元素未找到，請重新整理頁面');
                }

                // 專案 ID 變成可選的
                const projectId = projectIdInput.value?.trim() || '';
                if (projectId) {
                    // 如果有輸入專案ID，儲存到全域變數
                    currentProjectId = projectId;
                    console.log('使用專案ID:', projectId);
                } else {
                    // 如果沒有專案ID，使用時間戳作為臨時ID
                    currentProjectId = `temp_${Date.now()}`;
                    console.log('使用臨時ID:', currentProjectId);
                }
                
                const userApiKey = apiKeyInput.value?.trim() || '';
                if (!userApiKey) {
                    alert('請在最上方輸入您的 Google Gemini API 金鑰。');
                    return;
                }

                const analysisContext = {
                    target: targetBrandInput.value?.trim() || '',
                    competitor: competitorBrandInput.value?.trim() || '',
                    industry: industryInput.value || '',
                    businessModel: businessModelInput.value || '',
                    salesChannels: salesChannelsInput.value?.trim() || '未提供',
                    targetAudience: targetAudienceInput.value?.trim() || '未指定',
                    budget: parseInt(advertisingBudgetInput.value, 10) || 0,
                    projectId: currentProjectId, // 加入 project ID 到分析上下文
                    // 跨國市場策略參數
                    targetMarkets: targetMarketsInput.value || 'single',
                    primaryMarket: primaryMarketInput.value || 'taiwan',
                    secondaryMarkets: secondaryMarketsInput.value?.trim() || '',
                    marketEntryStrategy: marketEntryStrategyInput.value || 'organic',
                    localizationLevel: localizationLevelInput.value || 'moderate',
                    culturalSensitivity: culturalSensitivityInput.value || 'medium',
                    // 跨國溝通策略參數
                    communicationStrategy: communicationStrategyInput.value || 'glocal',
                    languageStrategy: languageStrategyInput.value || 'local',
                    toneStrategy: toneStrategyInput.value || 'adaptive',
                    channelStrategy: channelStrategyInput.value || 'digital',
                    timingStrategy: timingStrategyInput.value || 'staggered',
                    crisisManagement: crisisManagementInput.value || 'hybrid',
                    culturalConsiderations: culturalConsiderationsInput.value?.trim() || '',
                    regulatoryRequirements: regulatoryRequirementsInput.value?.trim() || ''
                };

                if (!analysisContext.target || !analysisContext.competitor) {
                    alert('請務必輸入目標品牌和競爭對手。');
                    return;
                }

                if (!generateBtn || !statusContainer || !proposalOutput) {
                    throw new Error('UI 元素未正確載入，請重新整理頁面');
                }

                generateBtn.disabled = true;
                generateBtn.innerHTML = `分析中...`;
                statusContainer.innerHTML = '';
                proposalOutput.innerHTML = '';

                try {
                    const status1 = updateStatus(`分析 **${analysisContext.target}** 在目標人群中的論壇輿情...`);
                    const forumData = await analyzeForumSentiment(analysisContext, userApiKey);
                    markStatusDone(status1);

                    const status2 = updateStatus(`分析 **${analysisContext.target}** 的 SEO 與內容策略...`);
                    const seoData = await analyzeSeoStrategy(analysisContext, userApiKey);
                    markStatusDone(status2);
                    
                    const opportunity = forumData.market_opportunity || seoData.content_gap_opportunity;
                    
                    const status3 = updateStatus(`進行預算規劃與 KPI 估算...`);
                    const kpiData = await estimateKpiAndBudget(analysisContext, opportunity, userApiKey);
                    markStatusDone(status3);

                    // 跨國策略分析（僅在選擇多市場時執行）
                    let internationalData = null;
                    let culturalData = null;
                    
                    if (analysisContext.targetMarkets !== 'single') {
                        const status4 = updateStatus(`分析跨國市場策略與進入策略...`);
                        internationalData = await analyzeInternationalMarketStrategy(analysisContext, userApiKey);
                        markStatusDone(status4);

                        const status5 = updateStatus(`分析跨國文化適應策略...`);
                        culturalData = await analyzeCulturalAdaptation(analysisContext, userApiKey);
                        markStatusDone(status5);
                    }

                    const status6 = updateStatus(`綜合所有洞察，生成最終報告...`);
                    const finalReportHtml = await synthesizeFinalReport(analysisContext, forumData, seoData, kpiData, internationalData, culturalData, userApiKey);
                    markStatusDone(status6);

                    // 在報告開頭加入 project ID 資訊
                    const projectInfoHtml = `
                        <div style="background-color: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                            <h3 style="color: #0c4a6e; margin: 0 0 8px 0; font-size: 18px;">📋 專案資訊</h3>
                            <p style="color: #0369a1; margin: 0; font-weight: 500;">專案 ID: <strong>${currentProjectId}</strong></p>
                            <p style="color: #0369a1; margin: 4px 0 0 0; font-size: 14px;">生成時間: ${new Date().toLocaleString('zh-TW')}</p>
                        </div>
                    `;
                    
                    proposalOutput.innerHTML = projectInfoHtml + finalReportHtml;

                } catch (error) {
                    console.error('生成提案時發生錯誤:', error);
                    updateStatus(`生成報告時發生錯誤: ${error.message}`, 'error');
                    
                    // 提供更詳細的錯誤訊息
                    let errorMessage = `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h3 class="text-red-800 font-bold mb-2">❌ 處理過程中發生錯誤</h3>
                        <p class="text-red-700 mb-2"><strong>錯誤訊息:</strong> ${error.message}</p>`;
                    
                    // 如果是 JSON 解析錯誤，提供特別的建議
                    if (error.message.includes('JSON') || error.message.includes('SyntaxError')) {
                        errorMessage += `<p class="text-red-700 mb-2"><strong>可能原因:</strong> AI 回應格式不正確，可能是因為：</p>
                        <ul class="text-red-700 list-disc list-inside mb-2">
                            <li>API 金鑰無效或已過期</li>
                            <li>網路連線問題</li>
                            <li>AI 服務暫時不可用</li>
                        </ul>
                        <p class="text-red-700"><strong>建議:</strong> 請檢查您的 API 金鑰是否正確，或稍後再試。</p>`;
                    } else {
                        errorMessage += `<p class="text-red-700"><strong>建議:</strong> 請檢查瀏覽器的主控台以獲取詳細技術資訊，然後再試一次。</p>`;
                    }
                    
                    errorMessage += `</div>`;
                    proposalOutput.innerHTML = errorMessage;
                } finally {
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.innerHTML = `重新生成 AI 分析報告`;
                    }
                }
            } catch (error) {
                console.error('主函數執行錯誤:', error);
                alert(`執行錯誤: ${error.message}\n請重新整理頁面或聯繫技術支援。`);
            }
        }

        // 新增：Google Drive 相關函數
        async function setupGoogleDrive() {
            try {
                // 載入 Google Drive API
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://apis.google.com/js/api.js';
                    script.onload = () => {
                        gapi.load('client', async () => {
                            try {
                                await gapi.client.init({});
                                await gapi.client.load('drive', 'v3');
                                resolve();
                            } catch (error) {
                                reject(error);
                            }
                        });
                    };
                    script.onerror = reject;
                    document.head.appendChild(script);
                });

                // 讀取資料夾設定（添加 null 檢查）
                const centralFolderElement = document.getElementById('centralFolderName');
                const mediaplanSubfolderElement = document.getElementById('mediaplanSubfolder');
                
                folderStructure.centralFolder = centralFolderElement?.value || 'iStaging_專案管理';
                folderStructure.mediaplanSubfolder = mediaplanSubfolderElement?.value || '02_媒體提案';

                // 建立資料夾結構
                await setupCentralizedFolderStructure();
                isGoogleDriveEnabled = true;
                
                console.log('Google Drive 設定完成');
                return true;
            } catch (error) {
                console.error('Google Drive 設定失敗:', error);
                return false;
            }
        }

        async function setupCentralizedFolderStructure() {
            try {
                // 1. 建立或找到主要專案資料夾
                const centralFolderId = await findOrCreateFolder(folderStructure.centralFolder, null);
                folderIds.central = centralFolderId;
                
                // 2. 建立或找到專案子資料夾
                if (currentProjectId) {
                    const projectFolderName = `[${currentProjectId}]_專案資料`;
                    const projectFolderId = await findOrCreateFolder(projectFolderName, centralFolderId);
                    folderIds.project = projectFolderId;
                    
                    // 3. 建立或找到媒體提案子資料夾
                    const mediaplanFolderId = await findOrCreateFolder(folderStructure.mediaplanSubfolder, projectFolderId);
                    folderIds.mediaplan = mediaplanFolderId;
                    
                    console.log('集中化資料夾結構建立完成:', {
                        central: centralFolderId,
                        project: projectFolderId,
                        mediaplan: mediaplanFolderId
                    });
                    
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('建立資料夾結構失敗:', error);
                throw error;
            }
        }

        async function findOrCreateFolder(folderName, parentId) {
            try {
                let query = `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`;
                if (parentId) {
                    query += ` and '${parentId}' in parents`;
                }
                
                const response = await gapi.client.drive.files.list({ 
                    q: query, 
                    fields: 'files(id)' 
                });
                
                if (response.result.files && response.result.files.length > 0) {
                    return response.result.files[0].id;
                } else {
                    const folderMetadata = {
                        name: folderName,
                        mimeType: 'application/vnd.google-apps.folder'
                    };
                    
                    if (parentId) {
                        folderMetadata.parents = [parentId];
                    }
                    
                    const createResponse = await gapi.client.drive.files.create({ 
                        resource: folderMetadata, 
                        fields: 'id' 
                    });
                    
                    return createResponse.result.id;
                }
            } catch (error) {
                console.error(`建立資料夾 ${folderName} 失敗:`, error);
                throw error;
            }
        }

        async function saveToGoogleDrive(content, fileName) {
            try {
                if (!isGoogleDriveEnabled) {
                    const driveEnabled = await setupGoogleDrive();
                    if (!driveEnabled) {
                        console.log('Google Drive 未啟用，跳過儲存');
                        return false;
                    }
                }

                // 確保資料夾結構已建立
                if (!folderIds.mediaplan) {
                    await setupCentralizedFolderStructure();
                }

                // 建立檔案內容
                const fileContent = {
                    projectId: currentProjectId,
                    content: content,
                    generatedAt: new Date().toISOString(),
                    tool: 'mediaplan'
                };

                const blob = new Blob([JSON.stringify(fileContent, null, 2)], { type: 'application/json' });
                const metadata = { 
                    name: fileName, 
                    mimeType: 'application/json', 
                    parents: [folderIds.mediaplan] 
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);
                
                // 需要用戶授權才能上傳
                console.log('需要用戶授權才能上傳到 Google Drive');
                return false;
                
            } catch (error) {
                console.error('儲存到 Google Drive 失敗:', error);
                return false;
            }
        }
    </script>
</body>
</html>

