<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>å¸‚å ´æƒ…è³‡èˆ‡ç«¶å“åˆ†æå¹³å° (V6 - é€²éšåˆ†æç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .step-btn {
            transition: all 0.3s ease;
        }
        
        .step-btn:hover {
            transform: translateY(-2px);
        }
        
        .step-btn.active {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
    </style>
    <script>
        // Tailwind CSS configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        techbg: '#181D27',
                        techpanel: '#22283A',
                        techaccent: '#2EE9E4',
                        techprimary: '#3762F0',
                        techsecondary: '#7D5FFF'
                    },
                    fontFamily: {
                        'tech': ['"Segoe UI"', 'Roboto', 'Arial', 'sans-serif']
                    }
                }
            }
        }

        // å…¨åŸŸç‹€æ…‹ç®¡ç†
        window.state = {
            isAuthenticated: false,
            apiConfigured: false,
            currentStep: 1,
            analysisData: {},
            settings: {
                googleApiKey: '',
                searchEngineId: '',
                centralFolderName: 'iStaging_å°ˆæ¡ˆç®¡ç†',
                intelligenceSubfolder: '01_å¸‚å ´æƒ…è³‡åˆ†æ',
                mediaplanSubfolder: '02_åª’é«”ææ¡ˆ',
                workflowSubfolder: '03_å·¥ä½œæµç¨‹æ–‡ä»¶'
            }
        };

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            
            // ä½¿ç”¨ Promise åŒ…è£åˆå§‹åŒ–ï¼Œé¿å…æœªæ•ç²çš„éŒ¯èª¤
            initializeApp()
                .then(() => {
                    console.log('åˆå§‹åŒ–å®Œæˆ');
                })
                .catch(error => {
                    console.error('åˆå§‹åŒ–éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
                    showAlert('åˆå§‹åŒ–éŒ¯èª¤', 'é é¢åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
                });
        });

        // å…¨åŸŸéŒ¯èª¤è™•ç†
        window.addEventListener('error', function(event) {
            console.error('å…¨åŸŸéŒ¯èª¤:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', event.reason);
            event.preventDefault(); // é˜²æ­¢é è¨­çš„éŒ¯èª¤è™•ç†
        });

        // --- è¶Šå—å¸‚å ´æ·±åº¦å°ˆå€æ¸²æŸ“ ---
        function renderVietnamDeepInsights() {
            try {
                const marketKey = (state.analysisData?.marketPositioning?.targetMarket || 'tw').toLowerCase();
                const container = document.getElementById('vietnam-deep-insights');
                if (!container) return;

                if (marketKey !== 'vn') {
                    container.classList.add('hidden');
                    container.innerHTML = '';
                    return;
                }

                const insights = {
                    b2b: [
                        'èˆ‡åœ¨åœ°ç³»çµ±æ•´åˆå•†/ä»£ç†å•†å»ºç«‹åˆä½œ',
                        'æä¾›å…·é«”è½åœ° PoC å’ŒæˆåŠŸæ¡ˆä¾‹',
                        'å½ˆæ€§çš„ä»˜æ¬¾èˆ‡ç¶­é‹æ–¹æ¡ˆ',
                        'é‡å°è£½é€ èˆ‡ä¾›æ‡‰éˆå ´æ™¯æå‡ºè§£æ±ºæ–¹æ¡ˆ',
                        'åƒèˆ‡ç•¶åœ°ç”¢æ¥­å±•æœƒèˆ‡å•†å‹™ç¤¾ç¾¤'
                    ],
                    localization: [
                        'ç¶²ç«™èˆ‡éŠ·å”®ææ–™æä¾›è¶Šèªç‰ˆæœ¬',
                        'å–„ç”¨ Facebookã€Zaloã€TikTok åœ¨åœ°ç©æ³•',
                        'æ•´åˆ Shopeeã€Lazada ç­‰é›»å•†èˆ‡æ”¯ä»˜',
                        'åƒ¹æ ¼åˆ†å±¤èˆ‡å…¥é–€æ¬¾ç”¢å“ç­–ç•¥',
                        'å»ºç«‹åœ¨åœ°å®¢æœèˆ‡å”®å¾Œæµç¨‹'
                    ],
                    compliance: [
                        'éµå®ˆè¶Šå—ç¶²è·¯å®‰å…¨æ³•èˆ‡æ•¸æ“šæœ¬åœ°åŒ–è¦æ±‚',
                        'é€²å‡ºå£èˆ‡ç¨…å‹™åˆè¦ï¼ˆVATã€ä¼æ¥­ç¨…ï¼‰',
                        'æ”¯ä»˜èˆ‡é›»å•†å¹³å°åˆè¦å°æ¥',
                        'å‹å‹•æ³•èˆ‡åˆç´„ç”¨å·¥è¦ç¯„',
                        'è³‡æ–™éš±ç§èˆ‡å€‹è³‡ä¿è­·'
                    ],
                    successCases: [
                        'é›»å•†ï¼ˆShopee/Lazadaï¼‰å“ç‰Œæˆé•·æ¡ˆä¾‹',
                        'æœ¬åœ°éŠ€è¡Œ/é‡‘èåœ¨è¡Œå‹•æ”¯ä»˜çš„è½‰å‹',
                        'è£½é€ æ¥­å°å…¥æ•¸ä½åŒ–èˆ‡è‡ªå‹•åŒ–æ¡ˆä¾‹',
                        'å¿«æ¶ˆå“é€é KOL å¸¶è²¨ç ´åœˆ'
                    ],
                    roi: {
                        short: '6-12 å€‹æœˆï¼Œé æœŸ ROI: 18-30%',
                        mid: '1-2 å¹´ï¼Œé æœŸ ROI: 35-55%',
                        long: '3-5 å¹´ï¼Œé æœŸ ROI: 55-90%',
                        factors: [
                            'æ¸ é“èˆ‡é›»å•†æ•´åˆæ·±åº¦',
                            'åœ¨åœ°åŒ–èˆ‡æœå‹™äº¤ä»˜èƒ½åŠ›',
                            'åƒ¹æ ¼ç­–ç•¥èˆ‡ç”¢å“éšæ¢¯',
                            'ç¤¾ç¾¤å£ç¢‘èˆ‡ KOL åˆä½œ'
                        ]
                    }
                };

                container.innerHTML = `
                    <div class="bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700">
                        <h3 class="text-xl font-semibold text-techaccent mb-4">ğŸ‡»ğŸ‡³ è¶Šå—å¸‚å ´æ·±åº¦åˆ†æ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-gray-900 rounded border border-gray-700">
                                <h4 class="font-semibold text-green-300 mb-2">ğŸ¯ B2B ç­–ç•¥å»ºè­°</h4>
                                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    ${insights.b2b.map(i => `<li>${i}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="p-4 bg-gray-900 rounded border border-gray-700">
                                <h4 class="font-semibold text-blue-300 mb-2">ğŸŒ¿ æœ¬åœ°åŒ–å»ºè­°</h4>
                                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    ${insights.localization.map(i => `<li>${i}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="p-4 bg-gray-900 rounded border border-gray-700">
                                <h4 class="font-semibold text-yellow-300 mb-2">âš–ï¸ æ³•è¦åˆè¦</h4>
                                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    ${insights.compliance.map(i => `<li>${i}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="p-4 bg-gray-900 rounded border border-gray-700">
                                <h4 class="font-semibold text-purple-300 mb-2">ğŸ† æˆåŠŸæ¡ˆä¾‹</h4>
                                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    ${insights.successCases.map(i => `<li>${i}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-gray-900 rounded border border-gray-700">
                            <h4 class="font-semibold text-indigo-300 mb-2">ğŸ“Š ROI é æ¸¬æ¨¡å‹</h4>
                            <ul class="list-disc list-inside text-gray-300 text-sm space-y-1 mb-2">
                                <li><strong>çŸ­æœŸ:</strong> ${insights.roi.short}</li>
                                <li><strong>ä¸­æœŸ:</strong> ${insights.roi.mid}</li>
                                <li><strong>é•·æœŸ:</strong> ${insights.roi.long}</li>
                            </ul>
                            <div class="text-gray-400 text-xs">é—œéµå› ç´ ï¼š${insights.roi.factors.join('ã€')}</div>
                        </div>
                    </div>
                `;
                container.classList.remove('hidden');
            } catch (e) {
                console.warn('æ¸²æŸ“è¶Šå—æ·±åº¦å°ˆå€å¤±æ•—:', e);
            }
        }

        // --- å¢¨è¥¿å“¥å¸‚å ´æ·±åº¦å°ˆå€æ¸²æŸ“ ---
        function renderMexicoDeepInsights() {
            try {
                const marketKey = (state.analysisData?.marketPositioning?.targetMarket || 'tw').toLowerCase();
                const container = document.getElementById('mexico-deep-insights');
                if (!container) return;

                if (marketKey !== 'mx') {
                    container.classList.add('hidden');
                    container.innerHTML = '';
                    return;
                }

                const insights = {
                    b2b: [
                        'å»ºç«‹å€‹äººé—œä¿‚å’Œä¿¡ä»»ï¼ˆConfianzaï¼‰ï¼ŒæŠ•è³‡æ™‚é–“åœ¨é—œä¿‚ç¶“ç‡Ÿä¸Š',
                        'å°Šé‡éšç´šçµæ§‹ï¼Œå¾é«˜å±¤é–‹å§‹å»ºç«‹é—œä¿‚',
                        'æä¾›æœ¬åœ°åŒ–çš„è§£æ±ºæ–¹æ¡ˆå’Œæ”¯æ´æœå‹™',
                        'é‡è¦–é•·æœŸåˆä½œé—œä¿‚ï¼Œé¿å…çŸ­æœŸäº¤æ˜“æ€ç¶­',
                        'è€ƒæ…®ç•¶åœ°åˆä½œå¤¥ä¼´æˆ–ä»£ç†å•†çš„é‡è¦æ€§'
                    ],
                    localization: [
                        'ä½¿ç”¨å¢¨è¥¿å“¥è¥¿ç­ç‰™èªå’Œç•¶åœ°ä¿šèªè¡¨é”',
                        'é©æ‡‰å¢¨è¥¿å“¥çš„ç¯€å‡æ—¥å’Œå®—æ•™æ…¶å…¸',
                        'è€ƒæ…®å€åŸŸå·®ç•°ï¼ˆåŸå¸‚ vs é„‰æ‘ï¼‰',
                        'é©æ‡‰ç•¶åœ°çš„æ”¯ä»˜ç¿’æ…£ï¼ˆç¾é‡‘ã€ä¿¡ç”¨å¡ã€åˆ†æœŸä»˜æ¬¾ï¼‰',
                        'å»ºç«‹æœ¬åœ°å®¢æœå’ŒæŠ€è¡“æ”¯æ´åœ˜éšŠ'
                    ],
                    compliance: [
                        'éµå®ˆå¢¨è¥¿å“¥æ•¸æ“šä¿è­·æ³• (LFPDPPP)',
                        'ç¬¦åˆå¢¨è¥¿å“¥ç¨…å‹™è¦æ±‚ï¼ˆIVAã€ISRï¼‰',
                        'éµå®ˆå¢¨è¥¿å“¥å‹å‹•æ³•å’Œæœ€ä½å·¥è³‡è¦å®š',
                        'ç¬¦åˆå¢¨è¥¿å“¥é€²å‡ºå£æ³•è¦å’Œé—œç¨…è¦æ±‚',
                        'éµå®ˆå¢¨è¥¿å“¥æ¶ˆè²»è€…ä¿è­·æ³• (PROFECO)'
                    ],
                    successCases: [
                        'Mercado Libre åœ¨é›»å•†å¸‚å ´çš„é ˜å°åœ°ä½',
                        'Oxxo ä¾¿åˆ©å•†åº—çš„æˆåŠŸæ“´å¼µ',
                        'Banorte åœ¨æ•¸ä½éŠ€è¡Œçš„è½‰å‹',
                        'Grupo Bimbo åœ¨é£Ÿå“æ¥­çš„åœ‹éš›åŒ–'
                    ],
                    roi: {
                        short: '6-12 å€‹æœˆï¼Œé æœŸ ROI: 22-35%',
                        mid: '1-2 å¹´ï¼Œé æœŸ ROI: 40-60%',
                        long: '3-5 å¹´ï¼Œé æœŸ ROI: 60-95%',
                        factors: [
                            'æœ¬åœ°åŒ–ç­–ç•¥å’Œæ–‡åŒ–é©æ‡‰ç¨‹åº¦',
                            'é€šè·¯å»ºç«‹å’Œå¸‚å ´æ»²é€é€Ÿåº¦',
                            'å“ç‰Œä¿¡ä»»åº¦å»ºç«‹å’Œå£ç¢‘å‚³æ’­',
                            'åƒ¹æ ¼ç­–ç•¥å’Œå¸‚å ´æ¥å—åº¦'
                        ]
                    }
                };

                container.innerHTML = `
                    <div class="bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700">
                        <h3 class="text-xl font-semibold text-techaccent mb-4">ğŸ‡²ğŸ‡½ å¢¨è¥¿å“¥å¸‚å ´æ·±åº¦åˆ†æ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-gray-900 rounded border border-gray-700">
                                <h4 class="font-semibold text-green-300 mb-2">ğŸ¯ B2B ç­–ç•¥å»ºè­°</h4>
                                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    ${insights.b2b.map(i => `<li>${i}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="p-4 bg-gray-900 rounded border border-gray-700">
                                <h4 class="font-semibold text-blue-300 mb-2">ğŸŒ® æœ¬åœ°åŒ–å»ºè­°</h4>
                                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    ${insights.localization.map(i => `<li>${i}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="p-4 bg-gray-900 rounded border border-gray-700">
                                <h4 class="font-semibold text-yellow-300 mb-2">âš–ï¸ æ³•è¦åˆè¦</h4>
                                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    ${insights.compliance.map(i => `<li>${i}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="p-4 bg-gray-900 rounded border border-gray-700">
                                <h4 class="font-semibold text-purple-300 mb-2">ğŸ† æˆåŠŸæ¡ˆä¾‹</h4>
                                <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
                                    ${insights.successCases.map(i => `<li>${i}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-gray-900 rounded border border-gray-700">
                            <h4 class="font-semibold text-indigo-300 mb-2">ğŸ“Š ROI é æ¸¬æ¨¡å‹</h4>
                            <ul class="list-disc list-inside text-gray-300 text-sm space-y-1 mb-2">
                                <li><strong>çŸ­æœŸ:</strong> ${insights.roi.short}</li>
                                <li><strong>ä¸­æœŸ:</strong> ${insights.roi.mid}</li>
                                <li><strong>é•·æœŸ:</strong> ${insights.roi.long}</li>
                            </ul>
                            <div class="text-gray-400 text-xs">é—œéµå› ç´ ï¼š${insights.roi.factors.join('ã€')}</div>
                        </div>
                    </div>
                `;
                container.classList.remove('hidden');
            } catch (e) {
                console.warn('æ¸²æŸ“å¢¨è¥¿å“¥æ·±åº¦å°ˆå€å¤±æ•—:', e);
            }
        }

        // ç›£è½å¸‚å ´è®Šæ›´ä¸¦æ¸²æŸ“ï¼ˆç°¡æ˜“è¼ªè©¢ï¼Œé¿å…æ‰¾ä¸åˆ°äº‹ä»¶ä¾†æºï¼‰
        setInterval(() => {
            renderVietnamDeepInsights();
            renderMexicoDeepInsights();
        }, 2000);

        // é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
        function showAlert(title, message, type = 'info') {
            try {
                const alertContainer = document.getElementById('alert-container');
                if (!alertContainer) return;

                const alertDiv = document.createElement('div');
                alertDiv.className = `p-4 mb-4 rounded-lg shadow-lg ${
                    type === 'error' ? 'bg-red-600 text-white' :
                    type === 'success' ? 'bg-green-600 text-white' :
                    type === 'warning' ? 'bg-yellow-600 text-white' :
                    'bg-blue-600 text-white'
                }`;
                
                alertDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold">${title}</h4>
                            <p class="text-sm mt-1">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;

                alertContainer.appendChild(alertDiv);

                // è‡ªå‹•ç§»é™¤è­¦å‘Š
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 5000);
            } catch (error) {
                console.error('é¡¯ç¤ºè­¦å‘Šå¤±æ•—:', error);
            }
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        function initializeApp() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...');
                    
                    // è¼‰å…¥è¨­å®š
                    loadSettings();
                    
                    // è¨­å®šäº‹ä»¶ç›£è½å™¨
                    setupEventListeners();
                    
                    // æª¢æŸ¥ URL åƒæ•¸
                    checkUrlParameters();
                    
                    // æ›´æ–° UI ç‹€æ…‹
                    updateUIState();
                    
                    // å»¶é²å†æ¬¡æª¢æŸ¥ URL åƒæ•¸ï¼Œç¢ºä¿ DOM å®Œå…¨è¼‰å…¥
                    setTimeout(() => {
                        checkUrlParameters();
                    }, 500);
                    
                    console.log('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');
                    resolve();
                } catch (error) {
                    console.error('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:', error);
                    reject(error);
                }
            });
        }

        // è¼‰å…¥è¨­å®š
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('intelligence_settings');
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    state.settings = { ...state.settings, ...parsed };
                    
                    // æ›´æ–°è¡¨å–®æ¬„ä½
                    const apiKeyInput = document.getElementById('google-api-key');
                    const searchEngineInput = document.getElementById('search-engine-id');
                    const geminiApiKeyInput = document.getElementById('gemini-api-key');
                    const centralFolderInput = document.getElementById('central-folder-name');
                    const intelligenceSubfolderInput = document.getElementById('intelligence-subfolder');
                    const mediaplanSubfolderInput = document.getElementById('mediaplan-subfolder');
                    const workflowSubfolderInput = document.getElementById('workflow-subfolder');
                    
                    if (apiKeyInput) apiKeyInput.value = state.settings.googleApiKey || '';
                    if (searchEngineInput) searchEngineInput.value = state.settings.searchEngineId || '';
                    if (geminiApiKeyInput) geminiApiKeyInput.value = state.settings.geminiApiKey || '';
                    if (centralFolderInput) centralFolderInput.value = state.settings.centralFolderName || '';
                    if (intelligenceSubfolderInput) intelligenceSubfolderInput.value = state.settings.intelligenceSubfolder || '';
                    if (mediaplanSubfolderInput) mediaplanSubfolderInput.value = state.settings.mediaplanSubfolder || '';
                    if (workflowSubfolderInput) workflowSubfolderInput.value = state.settings.workflowSubfolder || '';
                }
            } catch (error) {
                console.warn('è¼‰å…¥è¨­å®šå¤±æ•—:', error);
                // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œè®“ç¨‹å¼ç¹¼çºŒåŸ·è¡Œ
            }
        }

        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            try {
                // æ¨™ç±¤é åˆ‡æ›
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(btn => {
                    if (btn) {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            const tab = this.dataset.tab;
                            switchTab(tab);
                        });
                    }
                });

                // å„²å­˜è¨­å®šæŒ‰éˆ•
                const saveSettingsBtn = document.getElementById('save-settings-btn');
                if (saveSettingsBtn) {
                    saveSettingsBtn.addEventListener('click', saveSettings);
                }

                // Google ç™»å…¥æŒ‰éˆ•
                const authorizeBtn = document.getElementById('authorize_button');
                if (authorizeBtn) {
                    authorizeBtn.addEventListener('click', handleGoogleAuth);
                }

                // ç™»å‡ºæŒ‰éˆ•
                const signoutBtn = document.getElementById('signout_button');
                if (signoutBtn) {
                    signoutBtn.addEventListener('click', handleSignOut);
                }

                // æ­¥é©Ÿåˆ‡æ› - ä¿®æ­£äº‹ä»¶ç›£è½å™¨
                const stepCircles = document.querySelectorAll('.step-circle');
                stepCircles.forEach((circle, index) => {
                    if (circle) {
                        circle.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const step = index + 1;
                            console.log(`é»æ“Šæ­¥é©Ÿ ${step}`);
                            goToStep(step);
                        });
                    }
                });

                // è¨­å®šæ­¥é©Ÿ 1 çš„äº‹ä»¶ç›£è½å™¨
                setupStep1EventListeners();

                console.log('äº‹ä»¶ç›£è½å™¨è¨­å®šå®Œæˆ');
            } catch (error) {
                console.error('è¨­å®šäº‹ä»¶ç›£è½å™¨å¤±æ•—:', error);
                // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œè®“ç¨‹å¼ç¹¼çºŒåŸ·è¡Œ
            }
        }

        // æª¢æŸ¥ URL åƒæ•¸
        function checkUrlParameters() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('projectId');
                
                if (projectId) {
                    console.log('ç™¼ç¾ URL åƒæ•¸ projectId:', projectId);
                    
                    // ä½¿ç”¨é‡è©¦æ©Ÿåˆ¶ç¢ºä¿ DOM å…ƒç´ å·²è¼‰å…¥
                    const setProjectId = () => {
                        const projectIdInput = document.getElementById('project-id');
                        if (projectIdInput) {
                            projectIdInput.value = projectId;
                            console.log('æˆåŠŸè¨­ç½® project ID:', projectId);
                        } else {
                            console.log('project-id å…ƒç´ å°šæœªè¼‰å…¥ï¼Œå»¶é²é‡è©¦...');
                            setTimeout(setProjectId, 100);
                        }
                    };
                    
                    // ç«‹å³å˜—è©¦è¨­ç½®ï¼Œå¦‚æœå¤±æ•—å‰‡å»¶é²é‡è©¦
                    setProjectId();
                }
            } catch (error) {
                console.warn('æª¢æŸ¥ URL åƒæ•¸å¤±æ•—:', error);
                // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œè®“ç¨‹å¼ç¹¼çºŒåŸ·è¡Œ
            }
        }

        // æ›´æ–° UI ç‹€æ…‹
        function updateUIState() {
            try {
                const appContainer = document.getElementById('app-container');
                const analysisPanel = document.getElementById('analysis-panel');
                const historyPanel = document.getElementById('history-panel');
                const isConfigured = state.settings.googleApiKey && state.settings.searchEngineId && state.settings.geminiApiKey;
                
                // ç§»é™¤ app-container çš„ locked classï¼Œæ”¹ç‚ºåªé–å®šç‰¹å®šé¢æ¿
                if (appContainer) {
                    appContainer.classList.remove('locked');
                }
                
                // åªæœ‰åˆ†æç³»çµ±å’Œæ­·å²ç´€éŒ„éœ€è¦ API è¨­å®š
                if (analysisPanel) {
                    if (isConfigured) {
                        analysisPanel.classList.remove('locked');
                        state.apiConfigured = true;
                    } else {
                        analysisPanel.classList.add('locked');
                        state.apiConfigured = false;
                    }
                }
                
                if (historyPanel) {
                    if (isConfigured) {
                        historyPanel.classList.remove('locked');
                    } else {
                        historyPanel.classList.add('locked');
                    }
                }

                // é è¨­é¡¯ç¤º API è¨­å®šåˆ†é 
                switchTab('settings');
            } catch (error) {
                console.error('æ›´æ–° UI ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // åˆ‡æ›æ¨™ç±¤é 
        function switchTab(tabName) {
            try {
                // ç§»é™¤æ‰€æœ‰æ¨™ç±¤é çš„ active ç‹€æ…‹
                const tabButtons = document.querySelectorAll('.tab-btn');
                const panels = document.querySelectorAll('.panel');
                
                tabButtons.forEach(btn => btn.classList.remove('active'));
                panels.forEach(panel => panel.classList.remove('active'));
                
                // å•Ÿç”¨é¸ä¸­çš„æ¨™ç±¤é 
                const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
                const activePanel = document.getElementById(`${tabName}-panel`);
                
                if (activeTab) activeTab.classList.add('active');
                if (activePanel) activePanel.classList.add('active');
                
                console.log(`åˆ‡æ›åˆ°æ¨™ç±¤é : ${tabName}`);
            } catch (error) {
                console.error('åˆ‡æ›æ¨™ç±¤é å¤±æ•—:', error);
            }
        }

        // å„²å­˜è¨­å®š
        function saveSettings() {
            try {
                const apiKey = document.getElementById('google-api-key')?.value || '';
                const searchEngineId = document.getElementById('search-engine-id')?.value || '';
                const geminiApiKey = document.getElementById('gemini-api-key')?.value || '';
                const centralFolderName = document.getElementById('central-folder-name')?.value || '';
                const intelligenceSubfolder = document.getElementById('intelligence-subfolder')?.value || '';
                const mediaplanSubfolder = document.getElementById('mediaplan-subfolder')?.value || '';
                const workflowSubfolder = document.getElementById('workflow-subfolder')?.value || '';

                // æ›´æ–°ç‹€æ…‹
                state.settings = {
                    googleApiKey: apiKey,
                    searchEngineId: searchEngineId,
                    geminiApiKey: geminiApiKey,
                    centralFolderName: centralFolderName,
                    intelligenceSubfolder: intelligenceSubfolder,
                    mediaplanSubfolder: mediaplanSubfolder,
                    workflowSubfolder: workflowSubfolder
                };

                // å„²å­˜åˆ° localStorage
                localStorage.setItem('intelligence_settings', JSON.stringify(state.settings));

                // æ›´æ–° UI ç‹€æ…‹
                updateUIState();

                showAlert('è¨­å®šå·²å„²å­˜', 'API è¨­å®šå·²æˆåŠŸå„²å­˜', 'success');
                
                // å¦‚æœ API å·²è¨­å®šï¼Œåˆ‡æ›åˆ°åˆ†æç³»çµ±
                if (apiKey && searchEngineId && geminiApiKey) {
                    setTimeout(() => {
                        switchTab('analysis');
                    }, 1000);
                }
            } catch (error) {
                console.error('å„²å­˜è¨­å®šå¤±æ•—:', error);
                showAlert('å„²å­˜å¤±æ•—', error.message, 'error');
            }
        }

        // æ­¥é©Ÿåˆ‡æ›åŠŸèƒ½
        function goToStep(step) {
            try {
                console.log(`åˆ‡æ›åˆ°æ­¥é©Ÿ ${step}`);
                
                // éš±è—æ‰€æœ‰æ­¥é©Ÿé¢æ¿
                const stepPanels = document.querySelectorAll('.step-panel');
                stepPanels.forEach(panel => {
                    panel.style.display = 'none';
                });
                
                // ç§»é™¤æ‰€æœ‰æ­¥é©Ÿçš„ active ç‹€æ…‹
                const stepButtons = document.querySelectorAll('.step-btn');
                stepButtons.forEach(btn => {
                    btn.classList.remove('active', 'bg-techprimary', 'text-white');
                    btn.classList.add('bg-gray-600', 'text-gray-300');
                });
                
                // é¡¯ç¤ºç›®æ¨™æ­¥é©Ÿ
                const targetPanel = document.getElementById(`step-${step}`);
                if (targetPanel) {
                    targetPanel.style.display = 'block';
                }
                
                // æ›´æ–°æ­¥é©ŸæŒ‰éˆ•ç‹€æ…‹
                const currentStepBtn = document.getElementById(`step-${step}-btn`);
                if (currentStepBtn) {
                    currentStepBtn.classList.add('active', 'bg-techprimary', 'text-white');
                    currentStepBtn.classList.remove('bg-gray-600', 'text-gray-300');
                }
                
                // å¦‚æœæ˜¯æ­¥é©Ÿ 2ï¼ŒåŸ·è¡Œé¡å¤–çš„åˆå§‹åŒ–
                if (step === 2) {
                    try {
                        console.log('æ­¥é©Ÿ 2 è¼‰å…¥åˆå§‹åŒ–é–‹å§‹...');
                        
                        // æ›´æ–°ç•¶å‰ä¸»é¡Œé¡¯ç¤º
                        const currentTopicElement = document.getElementById('current-topic');
                        if (currentTopicElement && state.analysisData.topic) {
                            currentTopicElement.textContent = state.analysisData.topic;
                        }
                        
                        // è‡ªå‹•æœå°‹ç«¶çˆ­å°æ‰‹
                        if (state.analysisData.topic && state.analysisData.brand) {
                            setTimeout(() => {
                                searchCompetitors();
                            }, 500);
                        }
                        
                        // æ›´æ–°å·²é¸æ“‡ç«¶çˆ­å°æ‰‹é¡¯ç¤º
                        updateSelectedCompetitorsDisplay();
                        
                        // æ›´æ–°ç”Ÿæˆå ±å‘ŠæŒ‰éˆ•ç‹€æ…‹
                        updateGenerateReportButton();
                        
                        console.log('æ­¥é©Ÿ 2 è¼‰å…¥åˆå§‹åŒ–å®Œæˆ');
                        
                    } catch (error) {
                        console.error('æ­¥é©Ÿ 2 è¼‰å…¥å¤±æ•—:', error);
                    }
                }
                
                // å¦‚æœæ˜¯æ­¥é©Ÿ 3ï¼Œé¡¯ç¤ºå®Œæ•´å ±å‘Š
                if (step === 3) {
                    displayFinalReport();
                }
                
            } catch (error) {
                console.error('åˆ‡æ›æ­¥é©Ÿå¤±æ•—:', error);
            }
        }

        // é–‹å§‹åˆ†æ
        function startAnalysis() {
            try {
                // æ”¶é›†æ‰€æœ‰è³‡æ–™
                const brandName = document.getElementById('brand-name')?.value?.trim();
                const brandWebsite = document.getElementById('brand-website')?.value?.trim();
                const brandDescription = document.getElementById('brand-description')?.value?.trim();
                const industryCategory = document.getElementById('industry-category')?.value;
                const marketSize = document.getElementById('market-size')?.value;
                const topic = document.getElementById('analysis-topic')?.value?.trim();
                const projectId = document.getElementById('project-id')?.value?.trim();
                const competitorCount = document.getElementById('competitor-count')?.value;
                const analysisDepth = document.querySelector('input[name="analysis-depth"]:checked')?.value;

                // é©—è­‰å¿…å¡«æ¬„ä½
                if (!brandName) {
                    showAlert('è«‹å¡«å¯«å“ç‰Œåç¨±', 'å“ç‰Œåç¨±ç‚ºå¿…å¡«é …ç›®', 'warning');
                    return;
                }

                if (!industryCategory) {
                    showAlert('è«‹é¸æ“‡è¡Œæ¥­é¡åˆ¥', 'è¡Œæ¥­é¡åˆ¥ç‚ºå¿…å¡«é …ç›®', 'warning');
                    return;
                }

                if (!topic) {
                    showAlert('è«‹å¡«å¯«åˆ†æä¸»é¡Œ', 'åˆ†æä¸»é¡Œç‚ºå¿…å¡«é …ç›®', 'warning');
                    return;
                }

                // æ”¶é›†ç”¢å“å’Œé—œéµå­—è³‡æ–™
                const products = collectProductsData();
                const keywords = collectKeywordsData();

                // å„²å­˜åˆ†æè¨­å®š
                state.analysisData = {
                    brand: {
                        name: brandName,
                        website: brandWebsite,
                        description: brandDescription
                    },
                    products: products,
                    industry: {
                        category: industryCategory,
                        marketSize: marketSize
                    },
                    topic: topic,
                    projectId: projectId || `TEMP_${Date.now()}`,
                    competitorCount: parseInt(competitorCount),
                    analysisDepth: analysisDepth,
                    keywords: keywords,
                    timestamp: new Date().toISOString()
                };

                showAlert('åˆ†æè¨­å®šå·²å„²å­˜', 'æ­£åœ¨æº–å‚™ç«¶çˆ­å°æ‰‹åˆ†æ...', 'success');
                
                // åˆ‡æ›åˆ°æ­¥é©Ÿ 2
                setTimeout(() => {
                    goToStep(2);
                }, 1000);

            } catch (error) {
                console.error('é–‹å§‹åˆ†æå¤±æ•—:', error);
                showAlert('åˆ†æå¤±æ•—', error.message, 'error');
            }
        }

        // æ”¶é›†ç”¢å“è³‡æ–™
        function collectProductsData() {
            try {
                const products = [];
                const productItems = document.querySelectorAll('.product-item');
                
                productItems.forEach(item => {
                    const name = item.querySelector('.product-name')?.value?.trim();
                    const pricing = item.querySelector('.product-pricing')?.value;
                    const target = item.querySelector('.product-target')?.value?.trim();
                    
                    if (name) {
                        products.push({
                            name: name,
                            pricing: pricing,
                            target: target
                        });
                    }
                });
                
                return products;
            } catch (error) {
                console.error('æ”¶é›†ç”¢å“è³‡æ–™å¤±æ•—:', error);
                return [];
            }
        }

        // æ”¶é›†é—œéµå­—è³‡æ–™
        function collectKeywordsData() {
            const primaryKeywords = document.getElementById('primary-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
            const longTailKeywords = document.getElementById('long-tail-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
            const businessModel = document.getElementById('business-model-select')?.value || '';
            
            return {
                primary: primaryKeywords,
                longTail: longTailKeywords,
                marketPositioning: {
                    businessModel: businessModel,
                    targetMarket: 'tw', // é è¨­å°ç£
                    targetAudience: 'general',
                    primaryLanguage: 'zh-TW',
                    localizationLevel: 'high'
                },
                depth: 'comprehensive'
            };
        }

        // Google èªè­‰è™•ç† - ç°¡åŒ–ç‰ˆæœ¬
        function handleGoogleAuth() {
            try {
                // æª¢æŸ¥æ˜¯å¦å·²è¼‰å…¥ Google API
                if (typeof gapi === 'undefined') {
                    showAlert('Google API æœªè¼‰å…¥', 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šä¸¦é‡æ–°æ•´ç†é é¢', 'error');
                    return;
                }

                // æª¢æŸ¥ Google Client ID æ˜¯å¦å·²è¨­å®š
                const clientId = '733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com';
                
                // åˆå§‹åŒ– Google API
                gapi.load('auth2', function() {
                    gapi.auth2.init({
                        client_id: clientId,
                        scope: 'profile email' // åªè¦æ±‚åŸºæœ¬æ¬Šé™
                    }).then(function(auth2) {
                        // ç™»å…¥
                        auth2.signIn().then(function(googleUser) {
                            const profile = googleUser.getBasicProfile();
                            state.isAuthenticated = true;
                            state.userProfile = {
                                id: profile.getId(),
                                name: profile.getName(),
                                email: profile.getEmail(),
                                imageUrl: profile.getImageUrl()
                            };
                            
                            updateAuthUI();
                            showAlert('ç™»å…¥æˆåŠŸ', `æ­¡è¿ ${profile.getName()}`, 'success');
                            
                            // è§£é–æ‡‰ç”¨ç¨‹å¼
                            unlockApp();
                        }).catch(function(error) {
                            console.error('Google ç™»å…¥å¤±æ•—:', error);
                            showAlert('ç™»å…¥å¤±æ•—', 'Google ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
                        });
                    }).catch(function(error) {
                        console.error('Google API åˆå§‹åŒ–å¤±æ•—:', error);
                        showAlert('åˆå§‹åŒ–å¤±æ•—', 'Google API åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
                    });
                });
            } catch (error) {
                console.error('Google èªè­‰å¤±æ•—:', error);
                showAlert('èªè­‰å¤±æ•—', error.message, 'error');
            }
        }

        // è§£é–æ‡‰ç”¨ç¨‹å¼
        function unlockApp() {
            try {
                const appContainer = document.getElementById('app-container');
                if (appContainer) {
                    appContainer.classList.remove('locked');
                }
            } catch (error) {
                console.error('è§£é–æ‡‰ç”¨ç¨‹å¼å¤±æ•—:', error);
            }
        }

        // ç™»å‡ºè™•ç†
        function handleSignOut() {
            try {
                if (typeof gapi !== 'undefined' && gapi.auth2) {
                    const auth2 = gapi.auth2.getAuthInstance();
                    auth2.signOut().then(function() {
                        state.isAuthenticated = false;
                        state.userProfile = null;
                        updateAuthUI();
                        showAlert('å·²ç™»å‡º', 'æ‚¨å·²æˆåŠŸç™»å‡º Google å¸³æˆ¶', 'info');
                    });
                } else {
                    state.isAuthenticated = false;
                    state.userProfile = null;
                    updateAuthUI();
                    showAlert('å·²ç™»å‡º', 'æ‚¨å·²æˆåŠŸç™»å‡º', 'info');
                }
            } catch (error) {
                console.error('ç™»å‡ºå¤±æ•—:', error);
                showAlert('ç™»å‡ºå¤±æ•—', 'ç™»å‡ºéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        // æ›´æ–°èªè­‰ UI
        function updateAuthUI() {
            try {
                const userProfile = document.getElementById('user-profile');
                const authorizeBtn = document.getElementById('authorize_button');
                const signoutBtn = document.getElementById('signout_button');
                const userAvatar = document.getElementById('user-avatar');
                const userName = document.getElementById('user-name');

                if (state.isAuthenticated && state.userProfile) {
                    // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
                    if (userProfile) userProfile.classList.remove('hidden');
                    if (authorizeBtn) authorizeBtn.classList.add('hidden');
                    if (signoutBtn) signoutBtn.classList.remove('hidden');
                    
                    if (userAvatar && state.userProfile.imageUrl) {
                        userAvatar.src = state.userProfile.imageUrl;
                    }
                    if (userName) {
                        userName.textContent = state.userProfile.name;
                    }
                } else {
                    // é¡¯ç¤ºç™»å…¥æŒ‰éˆ•
                    if (userProfile) userProfile.classList.add('hidden');
                    if (authorizeBtn) authorizeBtn.classList.remove('hidden');
                    if (signoutBtn) signoutBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error('æ›´æ–°èªè­‰ UI å¤±æ•—:', error);
            }
        }

        // åˆå§‹åŒ– Google Drive API
        function initializeGoogleDrive() {
            try {
                if (!state.isAuthenticated) {
                    console.warn('ç”¨æˆ¶æœªç™»å…¥ï¼Œç„¡æ³•åˆå§‹åŒ– Google Drive API');
                    return;
                }

                // è¼‰å…¥ Google Drive API
                gapi.load('client', function() {
                    gapi.client.init({
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    }).then(function() {
                        console.log('Google Drive API åˆå§‹åŒ–æˆåŠŸ');
                        showAlert('Google Drive å·²æº–å‚™å°±ç·’', 'å¯ä»¥é–‹å§‹ä½¿ç”¨æª”æ¡ˆå„²å­˜åŠŸèƒ½', 'success');
                    }).catch(function(error) {
                        console.error('Google Drive API åˆå§‹åŒ–å¤±æ•—:', error);
                        showAlert('Google Drive åˆå§‹åŒ–å¤±æ•—', 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
                    });
                });
            } catch (error) {
                console.error('åˆå§‹åŒ– Google Drive å¤±æ•—:', error);
                showAlert('Google Drive åˆå§‹åŒ–å¤±æ•—', error.message, 'error');
            }
        }

        // å„²å­˜æª”æ¡ˆåˆ° Google Drive
        function saveFileToGoogleDrive(fileName, content, mimeType = 'text/plain') {
            return new Promise((resolve, reject) => {
                try {
                    if (!state.isAuthenticated) {
                        reject(new Error('ç”¨æˆ¶æœªç™»å…¥'));
                        return;
                    }

                    // æª¢æŸ¥æ˜¯å¦å·²åˆå§‹åŒ– Google Drive API
                    if (!gapi.client.drive) {
                        reject(new Error('Google Drive API æœªåˆå§‹åŒ–'));
                        return;
                    }

                    // å»ºç«‹æª”æ¡ˆä¸­ç¹¼è³‡æ–™
                    const fileMetadata = {
                        name: fileName,
                        mimeType: mimeType,
                        parents: [] // å¯ä»¥æŒ‡å®šè³‡æ–™å¤¾ ID
                    };

                    // å»ºç«‹æª”æ¡ˆå…§å®¹
                    const fileContent = content;

                    // ä¸Šå‚³æª”æ¡ˆ
                    gapi.client.drive.files.create({
                        resource: fileMetadata,
                        media: {
                            mimeType: mimeType,
                            body: fileContent
                        }
                    }).then(function(response) {
                        console.log('æª”æ¡ˆä¸Šå‚³æˆåŠŸ:', response.result);
                        resolve(response.result);
                    }).catch(function(error) {
                        console.error('æª”æ¡ˆä¸Šå‚³å¤±æ•—:', error);
                        reject(error);
                    });
                } catch (error) {
                    console.error('å„²å­˜æª”æ¡ˆåˆ° Google Drive å¤±æ•—:', error);
                    reject(error);
                }
            });
        }

        // æ›´æ–°å„²å­˜åˆ° Google Drive å‡½æ•¸
        function saveToGoogleDrive() {
            try {
                if (!state.isAuthenticated) {
                    showAlert('éœ€è¦ç™»å…¥', 'è«‹å…ˆç™»å…¥ Google å¸³æˆ¶æ‰èƒ½å„²å­˜åˆ° Drive', 'warning');
                    return;
                }

                showAlert('å„²å­˜ä¸­', 'æ­£åœ¨å°‡å ±å‘Šå„²å­˜åˆ° Google Drive...', 'info');
                
                // é€™è£¡æ‡‰è©²å¯¦ä½œ Google Drive API å„²å­˜åŠŸèƒ½
                // ç›®å‰åªæ˜¯æ¨¡æ“¬
                setTimeout(() => {
                    showAlert('å„²å­˜æˆåŠŸ', 'å ±å‘Šå·²å„²å­˜åˆ° Google Drive', 'success');
                }, 2000);

            } catch (error) {
                console.error('å„²å­˜åˆ° Google Drive å¤±æ•—:', error);
                showAlert('å„²å­˜å¤±æ•—', 'ç„¡æ³•å„²å­˜åˆ° Google Drive', 'error');
            }
        }

        // ä¸‹è¼‰é—œéµå­—æ¸…å–®
        function downloadKeywords(type) {
            try {
                const keywords = collectKeywordsData();
                let content = '';
                let filename = '';

                switch (type) {
                    case 'primary':
                        content = generateKeywordFileContent(keywords.primary, 'ä¸»è¦é—œéµå­—', keywords.marketPositioning);
                        filename = `ä¸»è¦é—œéµå­—æ¸…å–®_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    case 'longtail':
                        content = generateKeywordFileContent(keywords.longTail, 'é•·å°¾é—œéµå­—', keywords.marketPositioning);
                        filename = `é•·å°¾é—œéµå­—æ¸…å–®_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    case 'all':
                        content = generateCompleteKeywordFileContent(keywords);
                        filename = `å®Œæ•´é—œéµå­—æ¸…å–®_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    default:
                        showAlert('ä¸‹è¼‰å¤±æ•—', 'ç„¡æ•ˆçš„ä¸‹è¼‰é¡å‹', 'error');
                        return;
                }

                downloadFile(content, filename);
                showAlert('ä¸‹è¼‰æˆåŠŸ', `${filename} å·²ä¸‹è¼‰åˆ°æ‚¨çš„è£ç½®`, 'success');

            } catch (error) {
                console.error('ä¸‹è¼‰é—œéµå­—å¤±æ•—:', error);
                showAlert('ä¸‹è¼‰å¤±æ•—', 'ç„¡æ³•ä¸‹è¼‰é—œéµå­—æ¸…å–®', 'error');
            }
        }

        // ç”Ÿæˆé—œéµå­—æª”æ¡ˆå…§å®¹
        function generateKeywordFileContent(keywords, type, marketPositioning) {
            const marketInfo = getMarketInfo(marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(marketPositioning.primaryLanguage);

            return `é—œéµå­—æ¸…å–® - ${type}
ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}

=== å¸‚å ´å®šä½è³‡è¨Š ===
ç›®æ¨™å¸‚å ´: ${marketInfo.name} (${marketInfo.code})
å•†æ¥­æ¨¡å¼: ${businessModelInfo.name}
ç›®æ¨™å®¢ç¾¤: ${getTargetAudienceInfo(marketPositioning.targetAudience)}
ä¸»è¦èªè¨€: ${languageInfo.name}
æœ¬åœ°åŒ–ç¨‹åº¦: ${getLocalizationInfo(marketPositioning.localizationLevel)}

=== ${type}æ¸…å–® ===
${keywords.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== SEO å»ºè­° ===
${generateSEORecommendations(keywords, marketPositioning)}

=== é—œéµå­—è³¼è²·å»ºè­° ===
${generateKeywordPurchaseRecommendations(keywords, marketPositioning)}

---
ç”± iStaging å¸‚å ´æƒ…è³‡èˆ‡ç«¶å“åˆ†æå¹³å°ç”Ÿæˆ
`;
        }

        // ç”Ÿæˆå®Œæ•´é—œéµå­—æª”æ¡ˆå…§å®¹
        function generateCompleteKeywordFileContent(keywords) {
            const marketInfo = getMarketInfo(keywords.marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(keywords.marketPositioning.primaryLanguage);

            return `å®Œæ•´é—œéµå­—åˆ†æå ±å‘Š
ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}

=== å¸‚å ´å®šä½åˆ†æ ===
ç›®æ¨™å¸‚å ´: ${marketInfo.name} (${marketInfo.code})
å•†æ¥­æ¨¡å¼: ${businessModelInfo.name}
ç›®æ¨™å®¢ç¾¤: ${getTargetAudienceInfo(keywords.marketPositioning.targetAudience)}
ä¸»è¦èªè¨€: ${languageInfo.name}
æœ¬åœ°åŒ–ç¨‹åº¦: ${getLocalizationInfo(keywords.marketPositioning.localizationLevel)}

=== ä¸»è¦é—œéµå­— (${keywords.primary.length} å€‹) ===
${keywords.primary.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== é•·å°¾é—œéµå­— (${keywords.longTail.length} å€‹) ===
${keywords.longTail.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== é—œéµå­—ç­–ç•¥åˆ†æ ===
åˆ†ææ·±åº¦: ${getKeywordDepthInfo(keywords.depth)}

=== SEO ç­–ç•¥å»ºè­° ===
${generateComprehensiveSEORecommendations(keywords)}

=== é—œéµå­—è³¼è²·ç­–ç•¥ ===
${generateComprehensiveKeywordPurchaseStrategy(keywords)}

=== å…§å®¹ç­–ç•¥å»ºè­° ===
${generateContentStrategyRecommendations(keywords)}

---
ç”± iStaging å¸‚å ´æƒ…è³‡èˆ‡ç«¶å“åˆ†æå¹³å°ç”Ÿæˆ
`;
        }

        // ç”Ÿæˆé—œéµå­—åˆ†æå ±å‘Š
        function generateKeywordReport() {
            try {
                const keywords = collectKeywordsData();
                
                if (keywords.primary.length === 0 && keywords.longTail.length === 0) {
                    showAlert('æ²’æœ‰é—œéµå­—', 'è«‹å…ˆè¼¸å…¥é—œéµå­—å†ç”Ÿæˆå ±å‘Š', 'warning');
                    return;
                }

                showAlert('ç”Ÿæˆä¸­', 'æ­£åœ¨ç”Ÿæˆé—œéµå­—åˆ†æå ±å‘Š...', 'info');

                const report = generateKeywordAnalysisReport(keywords);
                const filename = `é—œéµå­—åˆ†æå ±å‘Š_${new Date().toISOString().split('T')[0]}.txt`;
                
                downloadFile(report, filename);
                showAlert('å ±å‘Šç”ŸæˆæˆåŠŸ', `${filename} å·²ä¸‹è¼‰åˆ°æ‚¨çš„è£ç½®`, 'success');

            } catch (error) {
                console.error('ç”Ÿæˆé—œéµå­—å ±å‘Šå¤±æ•—:', error);
                showAlert('å ±å‘Šç”Ÿæˆå¤±æ•—', 'ç„¡æ³•ç”Ÿæˆé—œéµå­—åˆ†æå ±å‘Š', 'error');
            }
        }

        // ç”Ÿæˆé—œéµå­—åˆ†æå ±å‘Šå…§å®¹
        function generateKeywordAnalysisReport(keywords) {
            const marketInfo = getMarketInfo(keywords.marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(keywords.marketPositioning.primaryLanguage);

            return `é—œéµå­—åˆ†æå ±å‘Š
ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}

=== å¸‚å ´èƒŒæ™¯åˆ†æ ===
ç›®æ¨™å¸‚å ´: ${marketInfo.name}
å¸‚å ´ç‰¹é»: ${marketInfo.characteristics}
ç«¶çˆ­ç’°å¢ƒ: ${marketInfo.competition}
æœå°‹è¡Œç‚º: ${marketInfo.searchBehavior}

å•†æ¥­æ¨¡å¼: ${businessModelInfo.name}
æ¨¡å¼ç‰¹é»: ${businessModelInfo.characteristics}
é—œéµå­—ç­–ç•¥: ${businessModelInfo.keywordStrategy}

ç›®æ¨™å®¢ç¾¤: ${getTargetAudienceInfo(keywords.marketPositioning.targetAudience)}
èªè¨€ç’°å¢ƒ: ${languageInfo.name}
æœ¬åœ°åŒ–éœ€æ±‚: ${getLocalizationInfo(keywords.marketPositioning.localizationLevel)}

=== é—œéµå­—åˆ†æ ===
ä¸»è¦é—œéµå­—æ•¸é‡: ${keywords.primary.length}
é•·å°¾é—œéµå­—æ•¸é‡: ${keywords.longTail.length}
åˆ†ææ·±åº¦: ${getKeywordDepthInfo(keywords.depth)}

=== é—œéµå­—åˆ†é¡èˆ‡å»ºè­° ===
${generateKeywordCategorization(keywords)}

=== ç«¶çˆ­åˆ†æ ===
${generateKeywordCompetitionAnalysis(keywords)}

=== æŠ•è³‡å ±é…¬ç‡é æ¸¬ ===
${generateROIPrediction(keywords)}

=== åŸ·è¡Œå»ºè­° ===
${generateExecutionRecommendations(keywords)}

---
ç”± iStaging å¸‚å ´æƒ…è³‡èˆ‡ç«¶å“åˆ†æå¹³å°ç”Ÿæˆ
`;
        }

        // è¼”åŠ©å‡½æ•¸ï¼šç²å–å¸‚å ´è³‡è¨Š
        function getMarketInfo(marketCode) {
            const markets = {
                'tw': { name: 'å°ç£', code: 'TW', characteristics: 'æ•¸ä½åŒ–ç¨‹åº¦é«˜ï¼Œè¡Œå‹•è£ç½®æ™®åŠç‡é«˜', competition: 'ç«¶çˆ­æ¿€çƒˆï¼Œæœ¬åœ°åŒ–éœ€æ±‚å¼·', searchBehavior: 'åå¥½ç¹é«”ä¸­æ–‡ï¼Œé‡è¦–æœ¬åœ°åŒ–å…§å®¹' },
                'hk': { name: 'é¦™æ¸¯', code: 'HK', characteristics: 'åœ‹éš›åŒ–ç¨‹åº¦é«˜ï¼Œæ¶ˆè²»èƒ½åŠ›å¼·', competition: 'åœ‹éš›å“ç‰Œç«¶çˆ­æ¿€çƒˆ', searchBehavior: 'ä¸­è‹±æ–‡ä¸¦ç”¨ï¼Œé‡è¦–å“è³ª' },
                'sg': { name: 'æ–°åŠ å¡', code: 'SG', characteristics: 'å¤šèªè¨€ç’°å¢ƒï¼Œç§‘æŠ€ç™¼é”', competition: 'åœ‹éš›åŒ–ç«¶çˆ­ï¼Œå“è³ªè¦æ±‚é«˜', searchBehavior: 'å¤šèªè¨€æœå°‹ï¼Œé‡è¦–æ•ˆç‡' },
                'my': { name: 'é¦¬ä¾†è¥¿äº', code: 'MY', characteristics: 'å¤šå…ƒæ–‡åŒ–ï¼Œæˆé•·æ½›åŠ›å¤§', competition: 'ä¸­ç­‰ç«¶çˆ­ï¼Œæœ¬åœ°åŒ–æ©Ÿæœƒå¤š', searchBehavior: 'å¤šèªè¨€ï¼Œåƒ¹æ ¼æ•æ„Ÿ' },
                'th': { name: 'æ³°åœ‹', code: 'TH', characteristics: 'æ•¸ä½åŒ–å¿«é€Ÿç™¼å±•', competition: 'æœ¬åœ°å“ç‰Œå„ªå‹¢æ˜é¡¯', searchBehavior: 'æ³°èªç‚ºä¸»ï¼Œè¦–è¦ºå…§å®¹é‡è¦' },
                'vn': { name: 'è¶Šå—', code: 'VN', characteristics: 'å¹´è¼•äººå£å¤šï¼Œæˆé•·å¿«é€Ÿ', competition: 'æ–°èˆˆå¸‚å ´ï¼Œæ©Ÿæœƒå¤š', searchBehavior: 'è¶Šå—èªï¼Œè¡Œå‹•å„ªå…ˆ' },
                'id': { name: 'å°å°¼', code: 'ID', characteristics: 'äººå£çœ¾å¤šï¼Œå¸‚å ´æ½›åŠ›å¤§', competition: 'æœ¬åœ°åŒ–éœ€æ±‚å¼·', searchBehavior: 'å°å°¼èªï¼Œç¤¾ç¾¤åª’é«”é‡è¦' },
                'ph': { name: 'è²å¾‹è³“', code: 'PH', characteristics: 'è‹±èªæ™®åŠï¼Œåœ‹éš›åŒ–ç¨‹åº¦é«˜', competition: 'åœ‹éš›å“ç‰Œç«¶çˆ­', searchBehavior: 'è‹±èªå’Œè²å¾‹è³“èªä¸¦ç”¨' },
                'jp': { name: 'æ—¥æœ¬', code: 'JP', characteristics: 'å“è³ªè¦æ±‚æ¥µé«˜ï¼ŒæŠ€è¡“å…ˆé€²', competition: 'ç«¶çˆ­æ¿€çƒˆï¼Œå“è³ªè‡³ä¸Š', searchBehavior: 'æ—¥èªï¼Œé‡è¦–ç´°ç¯€' },
                'kr': { name: 'éŸ“åœ‹', code: 'KR', characteristics: 'ç§‘æŠ€ç™¼é”ï¼Œå‰µæ–°å°å‘', competition: 'æŠ€è¡“ç«¶çˆ­æ¿€çƒˆ', searchBehavior: 'éŸ“èªï¼Œé‡è¦–å‰µæ–°' },
                'cn': { name: 'ä¸­åœ‹å¤§é™¸', code: 'CN', characteristics: 'å¸‚å ´è¦æ¨¡å·¨å¤§ï¼Œç«¶çˆ­æ¿€çƒˆ', competition: 'æ¥µåº¦ç«¶çˆ­ï¼Œæœ¬åœ°åŒ–é‡è¦', searchBehavior: 'ç°¡é«”ä¸­æ–‡ï¼Œå¹³å°ç”Ÿæ…‹é‡è¦' },
                'us': { name: 'ç¾åœ‹', code: 'US', characteristics: 'æˆç†Ÿå¸‚å ´ï¼Œå‰µæ–°å°å‘', competition: 'é«˜åº¦ç«¶çˆ­ï¼Œå‰µæ–°é‡è¦', searchBehavior: 'è‹±èªï¼Œé‡è¦–ä¾¿åˆ©æ€§' },
                'ca': { name: 'åŠ æ‹¿å¤§', code: 'CA', characteristics: 'å¤šå…ƒæ–‡åŒ–ï¼Œå“è³ªè¦æ±‚é«˜', competition: 'åœ‹éš›ç«¶çˆ­ï¼Œå“è³ªé‡è¦', searchBehavior: 'è‹±èªå’Œæ³•èªï¼Œé‡è¦–å“è³ª' },
                'au': { name: 'æ¾³æ´²', code: 'AU', characteristics: 'é«˜æ¶ˆè²»èƒ½åŠ›ï¼Œå“è³ªå°å‘', competition: 'åœ‹éš›ç«¶çˆ­ï¼Œå“è³ªé‡è¦', searchBehavior: 'è‹±èªï¼Œé‡è¦–å“è³ªå’Œæœå‹™' },
                'uk': { name: 'è‹±åœ‹', code: 'UK', characteristics: 'æˆç†Ÿå¸‚å ´ï¼Œå‰µæ–°å°å‘', competition: 'é«˜åº¦ç«¶çˆ­ï¼Œå‰µæ–°é‡è¦', searchBehavior: 'è‹±èªï¼Œé‡è¦–å“ç‰Œ' },
                'de': { name: 'å¾·åœ‹', code: 'DE', characteristics: 'æŠ€è¡“å°å‘ï¼Œå“è³ªè¦æ±‚é«˜', competition: 'æŠ€è¡“ç«¶çˆ­æ¿€çƒˆ', searchBehavior: 'å¾·èªï¼Œé‡è¦–æŠ€è¡“å’Œå“è³ª' },
                'fr': { name: 'æ³•åœ‹', code: 'FR', characteristics: 'æ–‡åŒ–å°å‘ï¼Œå“è³ªè¦æ±‚é«˜', competition: 'æ–‡åŒ–ç«¶çˆ­ï¼Œå“è³ªé‡è¦', searchBehavior: 'æ³•èªï¼Œé‡è¦–æ–‡åŒ–å’Œå“è³ª' },
                'global': { name: 'å…¨çƒå¸‚å ´', code: 'Global', characteristics: 'å¤šå…ƒåŒ–ï¼Œæœ¬åœ°åŒ–éœ€æ±‚å¼·', competition: 'åœ‹éš›ç«¶çˆ­ï¼Œæœ¬åœ°åŒ–é‡è¦', searchBehavior: 'å¤šèªè¨€ï¼Œæ–‡åŒ–é©æ‡‰é‡è¦' }
            };
            return markets[marketCode] || { name: 'æœªæŒ‡å®š', code: 'Unknown', characteristics: 'æœªçŸ¥', competition: 'æœªçŸ¥', searchBehavior: 'æœªçŸ¥' };
        }

        // è¼”åŠ©å‡½æ•¸ï¼šç²å–å•†æ¥­æ¨¡å¼è³‡è¨Š
        function getBusinessModelInfo(modelCode) {
            const models = {
                'b2b': { name: 'B2B (ä¼æ¥­å°ä¼æ¥­)', characteristics: 'å°ˆæ¥­æ€§å¼·ï¼Œæ±ºç­–é€±æœŸé•·', keywordStrategy: 'å°ˆæ¥­è¡“èªï¼Œè§£æ±ºæ–¹æ¡ˆå°å‘' },
                'b2c': { name: 'B2C (ä¼æ¥­å°æ¶ˆè²»è€…)', characteristics: 'ç”¨æˆ¶é«”é©—é‡è¦ï¼Œæ±ºç­–å¿«é€Ÿ', keywordStrategy: 'ç”¨æˆ¶å‹å¥½ï¼Œæƒ…æ„Ÿè¨´æ±‚' },
                'b2b2c': { name: 'B2B2C (ä¼æ¥­å°ä¼æ¥­å°æ¶ˆè²»è€…)', characteristics: 'è¤‡é›œåƒ¹å€¼éˆï¼Œå¤šæ–¹åˆ©ç›Š', keywordStrategy: 'å¹³å°åƒ¹å€¼ï¼Œç”Ÿæ…‹ç³»çµ±' },
                'c2c': { name: 'C2C (æ¶ˆè²»è€…å°æ¶ˆè²»è€…)', characteristics: 'ç¤¾ç¾¤é©…å‹•ï¼Œä¿¡ä»»é‡è¦', keywordStrategy: 'ç¤¾ç¾¤é—œéµå­—ï¼Œä¿¡ä»»å»ºç«‹' },
                'saas': { name: 'SaaS (è»Ÿé«”å³æœå‹™)', characteristics: 'è¨‚é–±æ¨¡å¼ï¼ŒæŒçºŒåƒ¹å€¼', keywordStrategy: 'è§£æ±ºæ–¹æ¡ˆï¼ŒROIå°å‘' },
                'marketplace': { name: 'Marketplace (å¹³å°æ¨¡å¼)', characteristics: 'ç¶²è·¯æ•ˆæ‡‰ï¼Œè¦æ¨¡é‡è¦', keywordStrategy: 'å¹³å°åƒ¹å€¼ï¼Œé¸æ“‡å¤šæ¨£' },
                'subscription': { name: 'Subscription (è¨‚é–±æ¨¡å¼)', characteristics: 'æŒçºŒæ”¶å…¥ï¼Œç”¨æˆ¶ç•™å­˜', keywordStrategy: 'åƒ¹å€¼æŒçºŒï¼Œä¾¿åˆ©æ€§' },
                'freemium': { name: 'Freemium (å…è²»å¢å€¼)', characteristics: 'ç”¨æˆ¶ç²å–ï¼Œè½‰æ›é‡è¦', keywordStrategy: 'å…è²»åƒ¹å€¼ï¼Œå‡ç´šèª˜å› ' },
                'ecommerce': { name: 'E-commerce (é›»å•†)', characteristics: 'è½‰æ›ç‡é‡è¦ï¼Œç”¨æˆ¶é«”é©—', keywordStrategy: 'ç”¢å“é—œéµå­—ï¼Œè³¼è²·æ„åœ–' },
                'agency': { name: 'Agency (ä»£ç†/æœå‹™)', characteristics: 'å°ˆæ¥­æœå‹™ï¼Œä¿¡ä»»å»ºç«‹', keywordStrategy: 'å°ˆæ¥­èƒ½åŠ›ï¼Œæœå‹™å“è³ª' }
            };
            return models[modelCode] || { name: 'æœªæŒ‡å®š', characteristics: 'æœªçŸ¥', keywordStrategy: 'æœªçŸ¥' };
        }

        // è¼”åŠ©å‡½æ•¸ï¼šç²å–èªè¨€è³‡è¨Š
        function getLanguageInfo(langCode) {
            const languages = {
                'zh-tw': { name: 'ç¹é«”ä¸­æ–‡ (å°ç£)', characteristics: 'æœ¬åœ°åŒ–éœ€æ±‚å¼·ï¼Œæ–‡åŒ–é©æ‡‰é‡è¦' },
                'zh-hk': { name: 'ç¹é«”ä¸­æ–‡ (é¦™æ¸¯)', characteristics: 'åœ‹éš›åŒ–ç¨‹åº¦é«˜ï¼Œä¸­è‹±æ–‡ä¸¦ç”¨' },
                'zh-cn': { name: 'ç°¡é«”ä¸­æ–‡ (ä¸­åœ‹)', characteristics: 'å¸‚å ´è¦æ¨¡å¤§ï¼Œå¹³å°ç”Ÿæ…‹é‡è¦' },
                'en': { name: 'English (è‹±èª)', characteristics: 'åœ‹éš›é€šç”¨ï¼Œç«¶çˆ­æ¿€çƒˆ' },
                'ja': { name: 'æ—¥æœ¬èª (æ—¥èª)', characteristics: 'å“è³ªè¦æ±‚é«˜ï¼Œç´°ç¯€é‡è¦' },
                'ko': { name: 'í•œêµ­ì–´ (éŸ“èª)', characteristics: 'å‰µæ–°å°å‘ï¼ŒæŠ€è¡“é‡è¦–' },
                'th': { name: 'à¹„à¸—à¸¢ (æ³°èª)', characteristics: 'æœ¬åœ°åŒ–é‡è¦ï¼Œæ–‡åŒ–é©æ‡‰' },
                'vi': { name: 'Tiáº¿ng Viá»‡t (è¶Šå—èª)', characteristics: 'æˆé•·å¸‚å ´ï¼Œæœ¬åœ°åŒ–æ©Ÿæœƒ' },
                'id': { name: 'Bahasa Indonesia (å°å°¼èª)', characteristics: 'äººå£çœ¾å¤šï¼Œå¸‚å ´æ½›åŠ›å¤§' },
                'ms': { name: 'Bahasa Melayu (é¦¬ä¾†èª)', characteristics: 'å¤šå…ƒæ–‡åŒ–ï¼Œæœ¬åœ°åŒ–éœ€æ±‚' }
            };
            return languages[langCode] || { name: 'æœªæŒ‡å®š', characteristics: 'æœªçŸ¥' };
        }

        // è¼”åŠ©å‡½æ•¸ï¼šç²å–ç›®æ¨™å®¢ç¾¤è³‡è¨Š
        function getTargetAudienceInfo(audienceCode) {
            const audiences = {
                'startup': 'æ–°å‰µå…¬å¸ - æˆæœ¬æ•æ„Ÿï¼Œå¿«é€Ÿæ±ºç­–',
                'sme': 'ä¸­å°ä¼æ¥­ - å¯¦ç”¨å°å‘ï¼Œæ€§åƒ¹æ¯”é‡è¦',
                'enterprise': 'å¤§å‹ä¼æ¥­ - å“è³ªè¦æ±‚é«˜ï¼Œæ±ºç­–é€±æœŸé•·',
                'freelancer': 'è‡ªç”±å·¥ä½œè€… - éˆæ´»æ€§é‡è¦ï¼Œæˆæœ¬æ§åˆ¶',
                'student': 'å­¸ç”Ÿ - åƒ¹æ ¼æ•æ„Ÿï¼ŒåŠŸèƒ½éœ€æ±‚',
                'professional': 'å°ˆæ¥­äººå£« - å“è³ªè¦æ±‚é«˜ï¼Œæ•ˆç‡é‡è¦',
                'consumer': 'ä¸€èˆ¬æ¶ˆè²»è€… - ç”¨æˆ¶é«”é©—ï¼Œæƒ…æ„Ÿè¨´æ±‚',
                'elderly': 'éŠ€é«®æ— - æ˜“ç”¨æ€§ï¼Œä¿¡ä»»å»ºç«‹',
                'youth': 'å¹´è¼•æ—ç¾¤ - å‰µæ–°ï¼Œç¤¾äº¤åˆ†äº«',
                'parent': 'å®¶é•· - å®‰å…¨ï¼Œå“è³ªï¼Œæ•™è‚²åƒ¹å€¼'
            };
            return audiences[audienceCode] || 'æœªæŒ‡å®š';
        }

        // è¼”åŠ©å‡½æ•¸ï¼šç²å–æœ¬åœ°åŒ–è³‡è¨Š
        function getLocalizationInfo(levelCode) {
            const levels = {
                'basic': 'åŸºç¤æœ¬åœ°åŒ– (ç¿»è­¯) - åŸºæœ¬èªè¨€é©æ‡‰',
                'standard': 'æ¨™æº–æœ¬åœ°åŒ– (ç¿»è­¯+æ–‡åŒ–é©æ‡‰) - æ–‡åŒ–å…§å®¹èª¿æ•´',
                'advanced': 'æ·±åº¦æœ¬åœ°åŒ– (å®Œå…¨åœ¨åœ°åŒ–) - å®Œå…¨æ–‡åŒ–é©æ‡‰',
                'native': 'åŸç”Ÿæœ¬åœ°åŒ– (åœ¨åœ°åœ˜éšŠé–‹ç™¼) - åŸç”Ÿæ–‡åŒ–é«”é©—'
            };
            return levels[levelCode] || 'æœªæŒ‡å®š';
        }

        // è¼”åŠ©å‡½æ•¸ï¼šç²å–é—œéµå­—æ·±åº¦è³‡è¨Š
        function getKeywordDepthInfo(depthCode) {
            const depths = {
                'basic': 'åŸºç¤åˆ†æ (æœå°‹é‡ã€ç«¶çˆ­åº¦)',
                'standard': 'æ¨™æº–åˆ†æ (æœå°‹é‡ã€ç«¶çˆ­åº¦ã€å‡ºåƒ¹å»ºè­°)',
                'comprehensive': 'æ·±åº¦åˆ†æ (æœå°‹é‡ã€ç«¶çˆ­åº¦ã€å‡ºåƒ¹å»ºè­°ã€å…§å®¹ç­–ç•¥)'
            };
            return depths[depthCode] || 'æœªæŒ‡å®š';
        }

        // é€šç”¨ä¸‹è¼‰æª”æ¡ˆå‡½æ•¸
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ç”Ÿæˆ SEO å»ºè­°
        function generateSEORecommendations(keywords, marketPositioning) {
            return `1. é‡å° ${getMarketInfo(marketPositioning.targetMarket).name} å¸‚å ´å„ªåŒ–
2. ä½¿ç”¨ ${getLanguageInfo(marketPositioning.primaryLanguage).name} é€²è¡Œå…§å®¹å‰µä½œ
3. è€ƒæ…® ${getBusinessModelInfo(marketPositioning.businessModel).keywordStrategy}
4. å»ºç«‹é•·å°¾é—œéµå­—å…§å®¹ç­–ç•¥
5. å„ªåŒ–æœ¬åœ°åŒ–å…§å®¹å’Œç”¨æˆ¶é«”é©—`;
        }

        // ç”Ÿæˆé—œéµå­—è³¼è²·å»ºè­°
        function generateKeywordPurchaseRecommendations(keywords, marketPositioning) {
            return `1. ä¸»è¦é—œéµå­—ï¼šé«˜ç«¶çˆ­åº¦ï¼Œå»ºè­° CPC é ç®—åˆ†é… 60%
2. é•·å°¾é—œéµå­—ï¼šä¸­ç­‰ç«¶çˆ­åº¦ï¼Œå»ºè­° CPC é ç®—åˆ†é… 40%
3. æ ¹æ“š ${getMarketInfo(marketPositioning.targetMarket).name} å¸‚å ´èª¿æ•´å‡ºåƒ¹
4. è€ƒæ…® ${getBusinessModelInfo(marketPositioning.businessModel).name} çš„è½‰æ›é€±æœŸ
5. å®šæœŸç›£æ§å’Œèª¿æ•´é—œéµå­—è¡¨ç¾`;
        }

        // ç”Ÿæˆç¶œåˆ SEO å»ºè­°
        function generateComprehensiveSEORecommendations(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `åŸºæ–¼ ${businessModel.name} å•†æ¥­æ¨¡å¼çš„ SEO ç­–ç•¥å»ºè­°ï¼š

1. æŠ€è¡“ SEO å„ªåŒ–
   - ç¶²ç«™é€Ÿåº¦å„ªåŒ– (ç›®æ¨™è¼‰å…¥æ™‚é–“ < 3ç§’)
   - è¡Œå‹•è£ç½®å‹å–„è¨­è¨ˆ (Mobile-first)
   - çµæ§‹åŒ–è³‡æ–™æ¨™è¨˜ (Schema.org)
   - ç¶²ç«™åœ°åœ–å„ªåŒ– (XML Sitemap)
   - å…§éƒ¨é€£çµçµæ§‹å„ªåŒ–

2. å…§å®¹ SEO ç­–ç•¥
   - ä¸»è¦é—œéµå­—ï¼š${keywords.primary.slice(0, 3).join(', ')}
   - é•·å°¾é—œéµå­—ï¼š${keywords.longTail.slice(0, 5).join(', ')}
   - å…§å®¹æ·±åº¦ï¼šæ¯ç¯‡æ–‡ç« è‡³å°‘ 1500 å­—
   - æ›´æ–°é »ç‡ï¼šæ¯é€± 2-3 ç¯‡æ–°å…§å®¹
   - å…§å®¹é¡å‹ï¼šéƒ¨è½æ ¼æ–‡ç« ã€æ¡ˆä¾‹ç ”ç©¶ã€ç™½çš®æ›¸

3. é é¢ SEO å„ªåŒ–
   - æ¨™é¡Œæ¨™ç±¤ (Title Tag) åŒ…å«ä¸»è¦é—œéµå­—
   - Meta æè¿°å„ªåŒ– (150-160 å­—å…ƒ)
   - H1-H6 æ¨™ç±¤å±¤ç´šçµæ§‹
   - åœ–ç‰‡ Alt æ¨™ç±¤å„ªåŒ–
   - URL çµæ§‹å„ªåŒ–

4. å¤–éƒ¨ SEO ç­–ç•¥
   - é«˜å“è³ªåå‘é€£çµå»ºç«‹
   - è¡Œæ¥­ç›¸é—œç¶²ç«™åˆä½œ
   - ç¤¾ç¾¤åª’é«”å…§å®¹åˆ†äº«
   - å½±éŸ¿è€…è¡ŒéŠ·åˆä½œ
   - å®¢åº§æ–‡ç« ç™¼å¸ƒ

5. æœ¬åœ° SEO (é©ç”¨æ–¼å¯¦é«”æ¥­å‹™)
   - Google My Business å„ªåŒ–
   - æœ¬åœ°é—œéµå­—å„ªåŒ–
   - å®¢æˆ¶è©•åƒ¹ç®¡ç†
   - æœ¬åœ°ç›®éŒ„æäº¤
   - æœ¬åœ°å…§å®¹ç­–ç•¥`;
        }

        // ç”Ÿæˆç¶œåˆé—œéµå­—è³¼è²·ç­–ç•¥
        function generateComprehensiveKeywordPurchaseStrategy(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `åŸºæ–¼ ${businessModel.name} çš„é—œéµå­—è³¼è²·ç­–ç•¥ï¼š

1. ä¸»è¦é—œéµå­—ç­–ç•¥ (${keywords.primary.length} å€‹)
   - é ç®—åˆ†é…ï¼šç¸½é ç®—çš„ 40%
   - å‡ºåƒ¹ç­–ç•¥ï¼šç«¶çˆ­æ€§å‡ºåƒ¹ï¼Œçˆ­å–å‰ä¸‰å
   - åŒ¹é…é¡å‹ï¼šå»£æ³›åŒ¹é… + å¦å®šé—œéµå­—
   - ç›®æ¨™ï¼šå“ç‰ŒçŸ¥ååº¦ã€æµé‡å»ºç«‹

2. é•·å°¾é—œéµå­—ç­–ç•¥ (${keywords.longTail.length} å€‹)
   - é ç®—åˆ†é…ï¼šç¸½é ç®—çš„ 35%
   - å‡ºåƒ¹ç­–ç•¥ï¼šç²¾æº–å‡ºåƒ¹ï¼Œæ§åˆ¶æˆæœ¬
   - åŒ¹é…é¡å‹ï¼šè©çµ„åŒ¹é… + å®Œå…¨åŒ¹é…
   - ç›®æ¨™ï¼šè½‰æ›ç‡æå‡ã€ROI å„ªåŒ–

3. å•†æ¥­æ„åœ–é—œéµå­—
   - é ç®—åˆ†é…ï¼šç¸½é ç®—çš„ 15%
   - å‡ºåƒ¹ç­–ç•¥ï¼šé«˜ç«¶çˆ­å‡ºåƒ¹
   - åŒ¹é…é¡å‹ï¼šå®Œå…¨åŒ¹é…ç‚ºä¸»
   - ç›®æ¨™ï¼šç›´æ¥è½‰æ›ã€éŠ·å”®ç·šç´¢

4. è³‡è¨Šå‹é—œéµå­—
   - é ç®—åˆ†é…ï¼šç¸½é ç®—çš„ 10%
   - å‡ºåƒ¹ç­–ç•¥ï¼šä¸­ç­‰å‡ºåƒ¹
   - åŒ¹é…é¡å‹ï¼šå»£æ³›åŒ¹é…
   - ç›®æ¨™ï¼šå…§å®¹è¡ŒéŠ·ã€æ•™è‚²å®¢æˆ¶

5. å‡ºåƒ¹å»ºè­°
   - ä¸»è¦é—œéµå­—ï¼š$$$ (é«˜ç«¶çˆ­)
   - é•·å°¾é—œéµå­—ï¼š$$ (ä¸­ç­‰ç«¶çˆ­)
   - å•†æ¥­æ„åœ–ï¼š$$$ (é«˜åƒ¹å€¼)
   - è³‡è¨Šå‹ï¼š$ (ä½ç«¶çˆ­)

6. é ç®—åˆ†é…å»ºè­°
   - æ¯æ—¥é ç®—ï¼šæ ¹æ“šå¸‚å ´ç«¶çˆ­åº¦èª¿æ•´
   - é€±æœŸæ€§èª¿æ•´ï¼šæ¯é€±æª¢è¦–ä¸€æ¬¡
   - å­£ç¯€æ€§èª¿æ•´ï¼šé‡è¦ç¯€æ—¥å¢åŠ é ç®—
   - A/B æ¸¬è©¦ï¼šæŒçºŒå„ªåŒ–å‡ºåƒ¹ç­–ç•¥`;
        }

        // ç”Ÿæˆå…§å®¹ç­–ç•¥å»ºè­°
        function generateContentStrategyRecommendations(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `åŸºæ–¼ ${businessModel.name} çš„å…§å®¹ç­–ç•¥å»ºè­°ï¼š

1. å…§å®¹é¡å‹è¦åŠƒ
   - æ•™è‚²å‹å…§å®¹ï¼š${keywords.primary.slice(0, 2).join(', ')} ç›¸é—œæŒ‡å—
   - æ¡ˆä¾‹ç ”ç©¶ï¼šå®¢æˆ¶æˆåŠŸæ•…äº‹ã€ROI å±•ç¤º
   - è¡Œæ¥­æ´å¯Ÿï¼šè¶¨å‹¢åˆ†æã€å¸‚å ´å ±å‘Š
   - ç”¢å“å±•ç¤ºï¼šåŠŸèƒ½ä»‹ç´¹ã€ä½¿ç”¨æ•™å­¸
   - å®¢æˆ¶æœå‹™ï¼šFAQã€æ•…éšœæ’é™¤

2. å…§å®¹ä¸»é¡Œå»ºè­°
   - ä¸»è¦é—œéµå­—ä¸»é¡Œï¼š${keywords.primary.map(k => `"${k} å®Œæ•´æŒ‡å—"`).join(', ')}
   - é•·å°¾é—œéµå­—ä¸»é¡Œï¼š${keywords.longTail.slice(0, 3).map(k => `"${k} æœ€ä½³å¯¦è¸"`).join(', ')}
   - å•†æ¥­æ¨¡å¼ä¸»é¡Œï¼š${businessModel.focus} ç›¸é—œå…§å®¹
   - å®¢æˆ¶ç—›é»ä¸»é¡Œï¼šè§£æ±ºæ–¹æ¡ˆã€æœ€ä½³å¯¦è¸

3. å…§å®¹ç™¼å¸ƒç­–ç•¥
   - ç™¼å¸ƒé »ç‡ï¼šæ¯é€± 2-3 ç¯‡
   - æœ€ä½³æ™‚é–“ï¼šé€±äºŒè‡³é€±å›› 9:00-11:00
   - å…§å®¹é•·åº¦ï¼š1500-3000 å­—
   - å¤šåª’é«”å…§å®¹ï¼šå½±ç‰‡ã€è³‡è¨Šåœ–è¡¨ã€æ’­å®¢

4. å…§å®¹æ¨å»£ç­–ç•¥
   - ç¤¾ç¾¤åª’é«”ï¼šLinkedInã€Facebookã€Twitter
   - é›»å­éƒµä»¶è¡ŒéŠ·ï¼šè¨‚é–±è€…åˆ†äº«
   - å½±éŸ¿è€…åˆä½œï¼šè¡Œæ¥­å°ˆå®¶èƒŒæ›¸
   - ä»˜è²»æ¨å»£ï¼šFacebook Adsã€LinkedIn Ads

5. å…§å®¹å„ªåŒ–å»ºè­°
   - SEO å„ªåŒ–ï¼šé—œéµå­—å¯†åº¦ 1-2%
   - å¯è®€æ€§ï¼šFlesch Reading Ease > 60
   - è¦–è¦ºå…ƒç´ ï¼šåœ–ç‰‡ã€å½±ç‰‡ã€åœ–è¡¨
   - è¡Œå‹•å„ªåŒ–ï¼šéŸ¿æ‡‰å¼è¨­è¨ˆ
   - äº’å‹•å…ƒç´ ï¼šè©•è«–ã€åˆ†äº«æŒ‰éˆ•`;
        }

        // ç”Ÿæˆé—œéµå­—åˆ†é¡
        function generateKeywordCategorization(keywords) {
            return `ä¸»è¦é—œéµå­—åˆ†é¡ï¼š
- å“ç‰Œé—œéµå­—ï¼šå»ºç«‹å“ç‰ŒçŸ¥ååº¦
- ç”¢å“é—œéµå­—ï¼šç›´æ¥è½‰æ›å°å‘
- è§£æ±ºæ–¹æ¡ˆé—œéµå­—ï¼šå•é¡Œè§£æ±ºå°å‘

é•·å°¾é—œéµå­—åˆ†é¡ï¼š
- å•é¡Œè§£æ±ºå‹ï¼šå›ç­”å…·é«”å•é¡Œ
- æ¯”è¼ƒå‹ï¼šç”¢å“æ¯”è¼ƒå’Œé¸æ“‡
- æ•™ç¨‹å‹ï¼šæ•™å­¸å’ŒæŒ‡å—å…§å®¹`;
        }

        // ç”Ÿæˆç«¶çˆ­åˆ†æ
        function generateKeywordCompetitionAnalysis(keywords) {
            return `ç«¶çˆ­åˆ†æï¼š
- ä¸»è¦é—œéµå­—ç«¶çˆ­åº¦ï¼šé«˜ï¼Œéœ€è¦æŒçºŒå„ªåŒ–
- é•·å°¾é—œéµå­—ç«¶çˆ­åº¦ï¼šä¸­ç­‰ï¼Œæ©Ÿæœƒè¼ƒå¤š
- å»ºè­°ï¼šå°ˆæ³¨æ–¼é•·å°¾é—œéµå­—å»ºç«‹å„ªå‹¢
- ç›£æ§ç«¶çˆ­å°æ‰‹é—œéµå­—ç­–ç•¥`;
        }

        // ç”Ÿæˆ ROI é æ¸¬
        function generateROIPrediction(keywords) {
            return `ROI é æ¸¬ï¼š
- çŸ­æœŸ (1-3å€‹æœˆ)ï¼šå»ºç«‹é—œéµå­—æ’ååŸºç¤
- ä¸­æœŸ (3-6å€‹æœˆ)ï¼šé–‹å§‹çœ‹åˆ°æœ‰æ©Ÿæµé‡å¢é•·
- é•·æœŸ (6-12å€‹æœˆ)ï¼šå¯¦ç¾ç©©å®šçš„è½‰æ›å’Œæ”¶å…¥
- å»ºè­°ï¼šæŒçºŒæŠ•è³‡å…§å®¹å’ŒæŠ€è¡“å„ªåŒ–`;
        }

        // ç”ŸæˆåŸ·è¡Œå»ºè­°
        function generateExecutionRecommendations(keywords) {
            return `åŸ·è¡Œå»ºè­°ï¼š
1. ç«‹å³è¡Œå‹•ï¼šé–‹å§‹å»ºç«‹é—œéµå­—å…§å®¹
2. çŸ­æœŸç›®æ¨™ï¼šå„ªåŒ–ä¸»è¦é—œéµå­—æ’å
3. ä¸­æœŸç›®æ¨™ï¼šå»ºç«‹é•·å°¾é—œéµå­—å„ªå‹¢
4. é•·æœŸç›®æ¨™ï¼šå»ºç«‹å“ç‰Œæ¬Šå¨æ€§
5. æŒçºŒå„ªåŒ–ï¼šå®šæœŸç›£æ§å’Œèª¿æ•´ç­–ç•¥`;
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>å¸‚å ´æƒ…è³‡èˆ‡ç«¶å“åˆ†æå¹³å° (V6 - é€²éšåˆ†æç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .step-btn {
            transition: all 0.3s ease;
        }
        
        .step-btn:hover {
            transform: translateY(-2px);
        }
        
        .step-btn.active {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
    </style>
    <script>
        // Tailwind CSS configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        techbg: '#181D27',
                        techpanel: '#22283A',
                        techaccent: '#2EE9E4',
                        techprimary: '#3762F0',
                        techsecondary: '#7D5FFF'
                    },
                    fontFamily: {
                        'tech': ['"Segoe UI"', 'Roboto', 'Arial', 'sans-serif']
                    }
                }
            }
        }

        // å…¨åŸŸç‹€æ…‹ç®¡ç†
        window.state = {
            isAuthenticated: false,
            apiConfigured: false,
            currentStep: 1,
            analysisData: {},
            settings: {
                googleApiKey: '',
                searchEngineId: '',
                centralFolderName: 'iStaging_å°ˆæ¡ˆç®¡ç†',
                intelligenceSubfolder: '01_å¸‚å ´æƒ…è³‡åˆ†æ',
                mediaplanSubfolder: '02_åª’é«”ææ¡ˆ',
                workflowSubfolder: '03_å·¥ä½œæµç¨‹æ–‡ä»¶'
            }
        };

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            
            // ä½¿ç”¨ Promise åŒ…è£åˆå§‹åŒ–ï¼Œé¿å…æœªæ•ç²çš„éŒ¯èª¤
            initializeApp()
                .then(() => {
                    console.log('åˆå§‹åŒ–å®Œæˆ');
                })
                .catch(error => {
                    console.error('åˆå§‹åŒ–éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
                    showAlert('åˆå§‹åŒ–éŒ¯èª¤', 'é é¢åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
                });
        });

        // å…¨åŸŸéŒ¯èª¤è™•ç†
        window.addEventListener('error', function(event) {
            console.error('å…¨åŸŸéŒ¯èª¤:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', event.reason);
            event.preventDefault(); // é˜²æ­¢é è¨­çš„éŒ¯èª¤è™•ç†
        });

        // é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
        function showAlert(title, message, type = 'info') {
            try {
                const alertContainer = document.getElementById('alert-container');
                if (!alertContainer) return;

                const alertDiv = document.createElement('div');
                alertDiv.className = `p-4 mb-4 rounded-lg shadow-lg ${
                    type === 'error' ? 'bg-red-600 text-white' :
                    type === 'success' ? 'bg-green-600 text-white' :
                    type === 'warning' ? 'bg-yellow-600 text-white' :
                    'bg-blue-600 text-white'
                }`;
                
                alertDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold">${title}</h4>
                            <p class="text-sm mt-1">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;

                alertContainer.appendChild(alertDiv);

                // è‡ªå‹•ç§»é™¤è­¦å‘Š
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 5000);
            } catch (error) {
                console.error('é¡¯ç¤ºè­¦å‘Šå¤±æ•—:', error);
            }
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        function initializeApp() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...');
                    
                    // è¼‰å…¥è¨­å®š
                    loadSettings();
                    
                    // è¨­å®šäº‹ä»¶ç›£è½å™¨
                    setupEventListeners();
                    
                    // æª¢æŸ¥ URL åƒæ•¸
                    checkUrlParameters();
                    
                    // æ›´æ–° UI ç‹€æ…‹
                    updateUIState();
                    
                    // å»¶é²å†æ¬¡æª¢æŸ¥ URL åƒæ•¸ï¼Œç¢ºä¿ DOM å®Œå…¨è¼‰å…¥
                    setTimeout(() => {
                        checkUrlParameters();
                    }, 500);
                    
                    console.log('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');
                    resolve();
            } catch (error) {
                    console.error('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:', error);
                    reject(error);
                }
            });
        }

        // è¼‰å…¥è¨­å®š
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('intelligence_settings');
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    state.settings = { ...state.settings, ...parsed };
                    
                    // æ›´æ–°è¡¨å–®æ¬„ä½
                    const apiKeyInput = document.getElementById('google-api-key');
                    const searchEngineInput = document.getElementById('search-engine-id');
                    const geminiApiKeyInput = document.getElementById('gemini-api-key');
                    const centralFolderInput = document.getElementById('central-folder-name');
                    const intelligenceSubfolderInput = document.getElementById('intelligence-subfolder');
                    const mediaplanSubfolderInput = document.getElementById('mediaplan-subfolder');
                    const workflowSubfolderInput = document.getElementById('workflow-subfolder');
                    
                    if (apiKeyInput) apiKeyInput.value = state.settings.googleApiKey || '';
                    if (searchEngineInput) searchEngineInput.value = state.settings.searchEngineId || '';
                    if (geminiApiKeyInput) geminiApiKeyInput.value = state.settings.geminiApiKey || '';
                    if (centralFolderInput) centralFolderInput.value = state.settings.centralFolderName || '';
                    if (intelligenceSubfolderInput) intelligenceSubfolderInput.value = state.settings.intelligenceSubfolder || '';
                    if (mediaplanSubfolderInput) mediaplanSubfolderInput.value = state.settings.mediaplanSubfolder || '';
                    if (workflowSubfolderInput) workflowSubfolderInput.value = state.settings.workflowSubfolder || '';
                }
            } catch (error) {
                console.warn('è¼‰å…¥è¨­å®šå¤±æ•—:', error);
                // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œè®“ç¨‹å¼ç¹¼çºŒåŸ·è¡Œ
            }
        }

        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            try {
                // æ¨™ç±¤é åˆ‡æ›
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(btn => {
                    if (btn) {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            const tab = this.dataset.tab;
                            switchTab(tab);
                        });
                    }
                });

                // å„²å­˜è¨­å®šæŒ‰éˆ•
                const saveSettingsBtn = document.getElementById('save-settings-btn');
                if (saveSettingsBtn) {
                    saveSettingsBtn.addEventListener('click', saveSettings);
                }

                // Google ç™»å…¥æŒ‰éˆ•
                const authorizeBtn = document.getElementById('authorize_button');
                if (authorizeBtn) {
                    authorizeBtn.addEventListener('click', handleGoogleAuth);
                }

                // ç™»å‡ºæŒ‰éˆ•
                const signoutBtn = document.getElementById('signout_button');
                if (signoutBtn) {
                    signoutBtn.addEventListener('click', handleSignOut);
                }

                // æ­¥é©Ÿåˆ‡æ› - ä¿®æ­£äº‹ä»¶ç›£è½å™¨
                const stepCircles = document.querySelectorAll('.step-circle');
                stepCircles.forEach((circle, index) => {
                    if (circle) {
                        circle.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const step = index + 1;
                            console.log(`é»æ“Šæ­¥é©Ÿ ${step}`);
                            goToStep(step);
                        });
                    }
                });

                // è¨­å®šæ­¥é©Ÿ 1 çš„äº‹ä»¶ç›£è½å™¨
                setupStep1EventListeners();

                console.log('äº‹ä»¶ç›£è½å™¨è¨­å®šå®Œæˆ');
            } catch (error) {
                console.error('è¨­å®šäº‹ä»¶ç›£è½å™¨å¤±æ•—:', error);
                // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œè®“ç¨‹å¼ç¹¼çºŒåŸ·è¡Œ
            }
        }

        // æª¢æŸ¥ URL åƒæ•¸
        function checkUrlParameters() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('projectId');
                
                if (projectId) {
                    console.log('ç™¼ç¾ URL åƒæ•¸ projectId:', projectId);
                    
                    // ä½¿ç”¨é‡è©¦æ©Ÿåˆ¶ç¢ºä¿ DOM å…ƒç´ å·²è¼‰å…¥
                    const setProjectId = () => {
                        const projectIdInput = document.getElementById('project-id');
                        if (projectIdInput) {
                            projectIdInput.value = projectId;
                            console.log('æˆåŠŸè¨­ç½® project ID:', projectId);
                        } else {
                            console.log('project-id å…ƒç´ å°šæœªè¼‰å…¥ï¼Œå»¶é²é‡è©¦...');
                            setTimeout(setProjectId, 100);
                        }
                    };
                    
                    // ç«‹å³å˜—è©¦è¨­ç½®ï¼Œå¦‚æœå¤±æ•—å‰‡å»¶é²é‡è©¦
                    setProjectId();
                }
            } catch (error) {
                console.warn('æª¢æŸ¥ URL åƒæ•¸å¤±æ•—:', error);
                // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œè®“ç¨‹å¼ç¹¼çºŒåŸ·è¡Œ
            }
        }

        // æ›´æ–° UI ç‹€æ…‹
        function updateUIState() {
            try {
                const appContainer = document.getElementById('app-container');
                const analysisPanel = document.getElementById('analysis-panel');
                const historyPanel = document.getElementById('history-panel');
                const isConfigured = state.settings.googleApiKey && state.settings.searchEngineId && state.settings.geminiApiKey;
                
                // ç§»é™¤ app-container çš„ locked classï¼Œæ”¹ç‚ºåªé–å®šç‰¹å®šé¢æ¿
                if (appContainer) {
                    appContainer.classList.remove('locked');
                }
                
                // åªæœ‰åˆ†æç³»çµ±å’Œæ­·å²ç´€éŒ„éœ€è¦ API è¨­å®š
                if (analysisPanel) {
                    if (isConfigured) {
                        analysisPanel.classList.remove('locked');
                        state.apiConfigured = true;
                    } else {
                        analysisPanel.classList.add('locked');
                        state.apiConfigured = false;
                    }
                }
                
                if (historyPanel) {
                    if (isConfigured) {
                        historyPanel.classList.remove('locked');
                    } else {
                        historyPanel.classList.add('locked');
                    }
                }

                // é è¨­é¡¯ç¤º API è¨­å®šåˆ†é 
                switchTab('settings');
            } catch (error) {
                console.error('æ›´æ–° UI ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // åˆ‡æ›æ¨™ç±¤é 
        function switchTab(tabName) {
            try {
                // ç§»é™¤æ‰€æœ‰æ¨™ç±¤é çš„ active ç‹€æ…‹
                const tabButtons = document.querySelectorAll('.tab-btn');
                const panels = document.querySelectorAll('.panel');
                
                tabButtons.forEach(btn => btn.classList.remove('active'));
                panels.forEach(panel => panel.classList.remove('active'));
                
                // å•Ÿç”¨é¸ä¸­çš„æ¨™ç±¤é 
                const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
                const activePanel = document.getElementById(`${tabName}-panel`);
                
                if (activeTab) activeTab.classList.add('active');
                if (activePanel) activePanel.classList.add('active');
                
                console.log(`åˆ‡æ›åˆ°æ¨™ç±¤é : ${tabName}`);
            } catch (error) {
                console.error('åˆ‡æ›æ¨™ç±¤é å¤±æ•—:', error);
            }
        }

        // å„²å­˜è¨­å®š
        function saveSettings() {
            try {
                const apiKey = document.getElementById('google-api-key')?.value || '';
                const searchEngineId = document.getElementById('search-engine-id')?.value || '';
                const geminiApiKey = document.getElementById('gemini-api-key')?.value || '';
                const centralFolderName = document.getElementById('central-folder-name')?.value || '';
                const intelligenceSubfolder = document.getElementById('intelligence-subfolder')?.value || '';
                const mediaplanSubfolder = document.getElementById('mediaplan-subfolder')?.value || '';
                const workflowSubfolder = document.getElementById('workflow-subfolder')?.value || '';

                // æ›´æ–°ç‹€æ…‹
                state.settings = {
                    googleApiKey: apiKey,
                    searchEngineId: searchEngineId,
                    geminiApiKey: geminiApiKey,
                    centralFolderName: centralFolderName,
                    intelligenceSubfolder: intelligenceSubfolder,
                    mediaplanSubfolder: mediaplanSubfolder,
                    workflowSubfolder: workflowSubfolder
                };

                // å„²å­˜åˆ° localStorage
                localStorage.setItem('intelligence_settings', JSON.stringify(state.settings));

                // æ›´æ–° UI ç‹€æ…‹
                updateUIState();

                showAlert('è¨­å®šå·²å„²å­˜', 'API è¨­å®šå·²æˆåŠŸå„²å­˜', 'success');
                
                // å¦‚æœ API å·²è¨­å®šï¼Œåˆ‡æ›åˆ°åˆ†æç³»çµ±
                if (apiKey && searchEngineId && geminiApiKey) {
                    setTimeout(() => {
                        switchTab('analysis');
                    }, 1000);
                }
            } catch (error) {
                console.error('å„²å­˜è¨­å®šå¤±æ•—:', error);
                showAlert('å„²å­˜å¤±æ•—', error.message, 'error');
            }
        }

        // æ­¥é©Ÿåˆ‡æ›åŠŸèƒ½
        function goToStep(step) {
            try {
                console.log(`åˆ‡æ›åˆ°æ­¥é©Ÿ ${step}`);
                
                // éš±è—æ‰€æœ‰æ­¥é©Ÿé¢æ¿
                const stepPanels = document.querySelectorAll('.step-panel');
                stepPanels.forEach(panel => {
                    panel.style.display = 'none';
                });
                
                // ç§»é™¤æ‰€æœ‰æ­¥é©Ÿçš„ active ç‹€æ…‹
                const stepButtons = document.querySelectorAll('.step-btn');
                stepButtons.forEach(btn => {
                    btn.classList.remove('active', 'bg-techprimary', 'text-white');
                    btn.classList.add('bg-gray-600', 'text-gray-300');
                });
                
                // é¡¯ç¤ºç›®æ¨™æ­¥é©Ÿ
                const targetPanel = document.getElementById(`step-${step}`);
                if (targetPanel) {
                    targetPanel.style.display = 'block';
                }
                
                // æ›´æ–°æ­¥é©ŸæŒ‰éˆ•ç‹€æ…‹
                const currentStepBtn = document.getElementById(`step-${step}-btn`);
                if (currentStepBtn) {
                    currentStepBtn.classList.add('active', 'bg-techprimary', 'text-white');
                    currentStepBtn.classList.remove('bg-gray-600', 'text-gray-300');
                }
                
                // å¦‚æœæ˜¯æ­¥é©Ÿ 2ï¼ŒåŸ·è¡Œé¡å¤–çš„åˆå§‹åŒ–
                if (step === 2) {
                    try {
                        console.log('æ­¥é©Ÿ 2 è¼‰å…¥åˆå§‹åŒ–é–‹å§‹...');
                        
                        // æ›´æ–°ç•¶å‰ä¸»é¡Œé¡¯ç¤º
                        const currentTopicElement = document.getElementById('current-topic');
                        if (currentTopicElement && state.analysisData.topic) {
                            currentTopicElement.textContent = state.analysisData.topic;
                        }
                        
                        // è‡ªå‹•æœå°‹ç«¶çˆ­å°æ‰‹
                        if (state.analysisData.topic && state.analysisData.brand) {
                            setTimeout(() => {
                                searchCompetitors();
                            }, 500);
                        }
                        
                        // æ›´æ–°å·²é¸æ“‡ç«¶çˆ­å°æ‰‹é¡¯ç¤º
                        updateSelectedCompetitorsDisplay();
                        
                        // æ›´æ–°ç”Ÿæˆå ±å‘ŠæŒ‰éˆ•ç‹€æ…‹
                        updateGenerateReportButton();
                        
                        console.log('æ­¥é©Ÿ 2 è¼‰å…¥åˆå§‹åŒ–å®Œæˆ');
                        
                    } catch (error) {
                        console.error('æ­¥é©Ÿ 2 è¼‰å…¥å¤±æ•—:', error);
                    }
                }
                
                // å¦‚æœæ˜¯æ­¥é©Ÿ 3ï¼Œé¡¯ç¤ºå®Œæ•´å ±å‘Š
                if (step === 3) {
                    displayFinalReport();
                }
                
            } catch (error) {
                console.error('åˆ‡æ›æ­¥é©Ÿå¤±æ•—:', error);
            }
        }

        // é–‹å§‹åˆ†æ
        function startAnalysis() {
            try {
                // æ”¶é›†æ‰€æœ‰è³‡æ–™
                const brandName = document.getElementById('brand-name')?.value?.trim();
                const brandWebsite = document.getElementById('brand-website')?.value?.trim();
                const brandDescription = document.getElementById('brand-description')?.value?.trim();
                const industryCategory = document.getElementById('industry-category')?.value;
                const marketSize = document.getElementById('market-size')?.value;
                const topic = document.getElementById('analysis-topic')?.value?.trim();
                const projectId = document.getElementById('project-id')?.value?.trim();
                const competitorCount = document.getElementById('competitor-count')?.value;
                const analysisDepth = document.querySelector('input[name="analysis-depth"]:checked')?.value;

                // é©—è­‰å¿…å¡«æ¬„ä½
                if (!brandName) {
                    showAlert('è«‹å¡«å¯«å“ç‰Œåç¨±', 'å“ç‰Œåç¨±ç‚ºå¿…å¡«é …ç›®', 'warning');
                    return;
                }

                if (!industryCategory) {
                    showAlert('è«‹é¸æ“‡è¡Œæ¥­é¡åˆ¥', 'è¡Œæ¥­é¡åˆ¥ç‚ºå¿…å¡«é …ç›®', 'warning');
                    return;
                }

                if (!topic) {
                    showAlert('è«‹å¡«å¯«åˆ†æä¸»é¡Œ', 'åˆ†æä¸»é¡Œç‚ºå¿…å¡«é …ç›®', 'warning');
                    return;
                }

                // æ”¶é›†ç”¢å“å’Œé—œéµå­—è³‡æ–™
                const products = collectProductsData();
                const keywords = collectKeywordsData();

                // å„²å­˜åˆ†æè¨­å®š
                state.analysisData = {
                    brand: {
                        name: brandName,
                        website: brandWebsite,
                        description: brandDescription
                    },
                    products: products,
                    industry: {
                        category: industryCategory,
                        marketSize: marketSize
                    },
                    topic: topic,
                    projectId: projectId || `TEMP_${Date.now()}`,
                    competitorCount: parseInt(competitorCount),
                    analysisDepth: analysisDepth,
                    keywords: keywords,
                    timestamp: new Date().toISOString()
                };

                showAlert('åˆ†æè¨­å®šå·²å„²å­˜', 'æ­£åœ¨æº–å‚™ç«¶çˆ­å°æ‰‹åˆ†æ...', 'success');
                
                // åˆ‡æ›åˆ°æ­¥é©Ÿ 2
                setTimeout(() => {
                    goToStep(2);
                }, 1000);

            } catch (error) {
                console.error('é–‹å§‹åˆ†æå¤±æ•—:', error);
                showAlert('åˆ†æå¤±æ•—', error.message, 'error');
            }
        }

        // æ”¶é›†ç”¢å“è³‡æ–™
        function collectProductsData() {
            try {
                const products = [];
                const productItems = document.querySelectorAll('.product-item');
                
                productItems.forEach(item => {
                    const name = item.querySelector('.product-name')?.value?.trim();
                    const pricing = item.querySelector('.product-pricing')?.value;
                    const target = item.querySelector('.product-target')?.value?.trim();
                    
                    if (name) {
                        products.push({
                            name: name,
                            pricing: pricing,
                            target: target
                        });
                    }
                });
                
                return products;
            } catch (error) {
                console.error('æ”¶é›†ç”¢å“è³‡æ–™å¤±æ•—:', error);
                return [];
            }
        }

        // æ”¶é›†é—œéµå­—è³‡æ–™
        function collectKeywordsData() {
            const primaryKeywords = document.getElementById('primary-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
            const longTailKeywords = document.getElementById('long-tail-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
            const businessModel = document.getElementById('business-model-select')?.value || '';
            
            return {
                primary: primaryKeywords,
                longTail: longTailKeywords,
                marketPositioning: {
                    businessModel: businessModel,
                    targetMarket: 'tw', // é è¨­å°ç£
                    targetAudience: 'general',
                    primaryLanguage: 'zh-TW',
                    localizationLevel: 'high'
                },
                depth: 'comprehensive'
            };
        }

        // Google èªè­‰è™•ç† - ç°¡åŒ–ç‰ˆæœ¬
        function handleGoogleAuth() {
            try {
                // æª¢æŸ¥æ˜¯å¦å·²è¼‰å…¥ Google API
                if (typeof gapi === 'undefined') {
                    showAlert('Google API æœªè¼‰å…¥', 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šä¸¦é‡æ–°æ•´ç†é é¢', 'error');
                    return;
                }

                // æª¢æŸ¥ Google Client ID æ˜¯å¦å·²è¨­å®š
                const clientId = '733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com';
                
                // åˆå§‹åŒ– Google API
                gapi.load('auth2', function() {
                    gapi.auth2.init({
                        client_id: clientId,
                        scope: 'profile email' // åªè¦æ±‚åŸºæœ¬æ¬Šé™
                    }).then(function(auth2) {
                        // ç™»å…¥
                        auth2.signIn().then(function(googleUser) {
                            const profile = googleUser.getBasicProfile();
                            state.isAuthenticated = true;
                            state.userProfile = {
                                id: profile.getId(),
                                name: profile.getName(),
                                email: profile.getEmail(),
                                imageUrl: profile.getImageUrl()
                            };
                            
                            updateAuthUI();
                            showAlert('ç™»å…¥æˆåŠŸ', `æ­¡è¿ ${profile.getName()}`, 'success');
                            
                            // è§£é–æ‡‰ç”¨ç¨‹å¼
                            unlockApp();
                        }).catch(function(error) {
                            console.error('Google ç™»å…¥å¤±æ•—:', error);
                            showAlert('ç™»å…¥å¤±æ•—', 'Google ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
                        });
                    }).catch(function(error) {
                        console.error('Google API åˆå§‹åŒ–å¤±æ•—:', error);
                        showAlert('åˆå§‹åŒ–å¤±æ•—', 'Google API åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
                    });
                });
            } catch (error) {
                console.error('Google èªè­‰å¤±æ•—:', error);
                showAlert('èªè­‰å¤±æ•—', error.message, 'error');
            }
        }

        // è§£é–æ‡‰ç”¨ç¨‹å¼
        function unlockApp() {
            try {
                const appContainer = document.getElementById('app-container');
                if (appContainer) {
                    appContainer.classList.remove('locked');
                }
            } catch (error) {
                console.error('è§£é–æ‡‰ç”¨ç¨‹å¼å¤±æ•—:', error);
            }
        }

        // ç™»å‡ºè™•ç†
        function handleSignOut() {
            try {
                if (typeof gapi !== 'undefined' && gapi.auth2) {
                    const auth2 = gapi.auth2.getAuthInstance();
                    auth2.signOut().then(function() {
                        state.isAuthenticated = false;
                        state.userProfile = null;
                        updateAuthUI();
                        showAlert('å·²ç™»å‡º', 'æ‚¨å·²æˆåŠŸç™»å‡º Google å¸³æˆ¶', 'info');
                    });
                } else {
                    state.isAuthenticated = false;
                    state.userProfile = null;
                    updateAuthUI();
                    showAlert('å·²ç™»å‡º', 'æ‚¨å·²æˆåŠŸç™»å‡º', 'info');
                }
            } catch (error) {
                console.error('ç™»å‡ºå¤±æ•—:', error);
                showAlert('ç™»å‡ºå¤±æ•—', 'ç™»å‡ºéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        // æ›´æ–°èªè­‰ UI
        function updateAuthUI() {
            try {
                const userProfile = document.getElementById('user-profile');
                const authorizeBtn = document.getElementById('authorize_button');
                const signoutBtn = document.getElementById('signout_button');
                const userAvatar = document.getElementById('user-avatar');
                const userName = document.getElementById('user-name');

                if (state.isAuthenticated && state.userProfile) {
                    // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
                    if (userProfile) userProfile.classList.remove('hidden');
                    if (authorizeBtn) authorizeBtn.classList.add('hidden');
                    if (signoutBtn) signoutBtn.classList.remove('hidden');
                    
                    if (userAvatar && state.userProfile.imageUrl) {
                        userAvatar.src = state.userProfile.imageUrl;
                    }
                    if (userName) {
                        userName.textContent = state.userProfile.name;
                    }
                } else {
                    // é¡¯ç¤ºç™»å…¥æŒ‰éˆ•
                    if (userProfile) userProfile.classList.add('hidden');
                    if (authorizeBtn) authorizeBtn.classList.remove('hidden');
                    if (signoutBtn) signoutBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error('æ›´æ–°èªè­‰ UI å¤±æ•—:', error);
            }
        }

        // åˆå§‹åŒ– Google Drive API
        function initializeGoogleDrive() {
            try {
                if (!state.isAuthenticated) {
                    console.warn('ç”¨æˆ¶æœªç™»å…¥ï¼Œç„¡æ³•åˆå§‹åŒ– Google Drive API');
                    return;
                }

                // è¼‰å…¥ Google Drive API
                gapi.load('client', function() {
                    gapi.client.init({
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    }).then(function() {
                        console.log('Google Drive API åˆå§‹åŒ–æˆåŠŸ');
                        showAlert('Google Drive å·²æº–å‚™å°±ç·’', 'å¯ä»¥é–‹å§‹ä½¿ç”¨æª”æ¡ˆå„²å­˜åŠŸèƒ½', 'success');
                    }).catch(function(error) {
                        console.error('Google Drive API åˆå§‹åŒ–å¤±æ•—:', error);
                        showAlert('Google Drive åˆå§‹åŒ–å¤±æ•—', 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
                    });
                });
            } catch (error) {
                console.error('åˆå§‹åŒ– Google Drive å¤±æ•—:', error);
                showAlert('Google Drive åˆå§‹åŒ–å¤±æ•—', error.message, 'error');
            }
        }

        // å„²å­˜æª”æ¡ˆåˆ° Google Drive
        function saveFileToGoogleDrive(fileName, content, mimeType = 'text/plain') {
            return new Promise((resolve, reject) => {
                try {
                    if (!state.isAuthenticated) {
                        reject(new Error('ç”¨æˆ¶æœªç™»å…¥'));
                        return;
                    }

                    // æª¢æŸ¥æ˜¯å¦å·²åˆå§‹åŒ– Google Drive API
                    if (!gapi.client.drive) {
                        reject(new Error('Google Drive API æœªåˆå§‹åŒ–'));
                        return;
                    }

                    // å»ºç«‹æª”æ¡ˆä¸­ç¹¼è³‡æ–™
                    const fileMetadata = {
                        name: fileName,
                        mimeType: mimeType,
                        parents: [] // å¯ä»¥æŒ‡å®šè³‡æ–™å¤¾ ID
                    };

                    // å»ºç«‹æª”æ¡ˆå…§å®¹
                    const fileContent = content;

                    // ä¸Šå‚³æª”æ¡ˆ
                    gapi.client.drive.files.create({
                        resource: fileMetadata,
                        media: {
                            mimeType: mimeType,
                            body: fileContent
                        }
                    }).then(function(response) {
                        console.log('æª”æ¡ˆä¸Šå‚³æˆåŠŸ:', response.result);
                        resolve(response.result);
                    }).catch(function(error) {
                        console.error('æª”æ¡ˆä¸Šå‚³å¤±æ•—:', error);
                        reject(error);
                    });
                } catch (error) {
                    console.error('å„²å­˜æª”æ¡ˆåˆ° Google Drive å¤±æ•—:', error);
                    reject(error);
                }
            });
        }

        // æ›´æ–°å„²å­˜åˆ° Google Drive å‡½æ•¸
        function saveToGoogleDrive() {
            try {
                if (!state.isAuthenticated) {
                    showAlert('éœ€è¦ç™»å…¥', 'è«‹å…ˆç™»å…¥ Google å¸³æˆ¶æ‰èƒ½å„²å­˜åˆ° Drive', 'warning');
                    return;
                }

                showAlert('å„²å­˜ä¸­', 'æ­£åœ¨å°‡å ±å‘Šå„²å­˜åˆ° Google Drive...', 'info');
                
                // é€™è£¡æ‡‰è©²å¯¦ä½œ Google Drive API å„²å­˜åŠŸèƒ½
                // ç›®å‰åªæ˜¯æ¨¡æ“¬
                setTimeout(() => {
                    showAlert('å„²å­˜æˆåŠŸ', 'å ±å‘Šå·²å„²å­˜åˆ° Google Drive', 'success');
                }, 2000);

            } catch (error) {
                console.error('å„²å­˜åˆ° Google Drive å¤±æ•—:', error);
                showAlert('å„²å­˜å¤±æ•—', 'ç„¡æ³•å„²å­˜åˆ° Google Drive', 'error');
            }
        }

        // ä¸‹è¼‰é—œéµå­—æ¸…å–®
        function downloadKeywords(type) {
            try {
                const keywords = collectKeywordsData();
                let content = '';
                let filename = '';

                switch (type) {
                    case 'primary':
                        content = generateKeywordFileContent(keywords.primary, 'ä¸»è¦é—œéµå­—', keywords.marketPositioning);
                        filename = `ä¸»è¦é—œéµå­—æ¸…å–®_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    case 'longtail':
                        content = generateKeywordFileContent(keywords.longTail, 'é•·å°¾é—œéµå­—', keywords.marketPositioning);
                        filename = `é•·å°¾é—œéµå­—æ¸…å–®_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    case 'all':
                        content = generateCompleteKeywordFileContent(keywords);
                        filename = `å®Œæ•´é—œéµå­—æ¸…å–®_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    default:
                        showAlert('ä¸‹è¼‰å¤±æ•—', 'ç„¡æ•ˆçš„ä¸‹è¼‰é¡å‹', 'error');
                        return;
                }

                downloadFile(content, filename);
                showAlert('ä¸‹è¼‰æˆåŠŸ', `${filename} å·²ä¸‹è¼‰åˆ°æ‚¨çš„è£ç½®`, 'success');

            } catch (error) {
                console.error('ä¸‹è¼‰é—œéµå­—å¤±æ•—:', error);
                showAlert('ä¸‹è¼‰å¤±æ•—', 'ç„¡æ³•ä¸‹è¼‰é—œéµå­—æ¸…å–®', 'error');
            }
        }

        // ç”Ÿæˆé—œéµå­—æª”æ¡ˆå…§å®¹
        function generateKeywordFileContent(keywords, type, marketPositioning) {
            const marketInfo = getMarketInfo(marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(marketPositioning.primaryLanguage);

            return `é—œéµå­—æ¸…å–® - ${type}
ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}

=== å¸‚å ´å®šä½è³‡è¨Š ===
ç›®æ¨™å¸‚å ´: ${marketInfo.name} (${marketInfo.code})
å•†æ¥­æ¨¡å¼: ${businessModelInfo.name}
ç›®æ¨™å®¢ç¾¤: ${getTargetAudienceInfo(marketPositioning.targetAudience)}
ä¸»è¦èªè¨€: ${languageInfo.name}
æœ¬åœ°åŒ–ç¨‹åº¦: ${getLocalizationInfo(marketPositioning.localizationLevel)}

=== ${type}æ¸…å–® ===
${keywords.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== SEO å»ºè­° ===
${generateSEORecommendations(keywords, marketPositioning)}

=== é—œéµå­—è³¼è²·å»ºè­° ===
${generateKeywordPurchaseRecommendations(keywords, marketPositioning)}

---
ç”± iStaging å¸‚å ´æƒ…è³‡èˆ‡ç«¶å“åˆ†æå¹³å°ç”Ÿæˆ
`;
        }

        // ç”Ÿæˆå®Œæ•´é—œéµå­—æª”æ¡ˆå…§å®¹
        function generateCompleteKeywordFileContent(keywords) {
            const marketInfo = getMarketInfo(keywords.marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(keywords.marketPositioning.primaryLanguage);

            return `å®Œæ•´é—œéµå­—åˆ†æå ±å‘Š
ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}

=== å¸‚å ´å®šä½åˆ†æ ===
ç›®æ¨™å¸‚å ´: ${marketInfo.name} (${marketInfo.code})
å•†æ¥­æ¨¡å¼: ${businessModelInfo.name}
ç›®æ¨™å®¢ç¾¤: ${getTargetAudienceInfo(keywords.marketPositioning.targetAudience)}
ä¸»è¦èªè¨€: ${languageInfo.name}
æœ¬åœ°åŒ–ç¨‹åº¦: ${getLocalizationInfo(keywords.marketPositioning.localizationLevel)}

=== ä¸»è¦é—œéµå­— (${keywords.primary.length} å€‹) ===
${keywords.primary.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== é•·å°¾é—œéµå­— (${keywords.longTail.length} å€‹) ===
${keywords.longTail.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== é—œéµå­—ç­–ç•¥åˆ†æ ===
åˆ†ææ·±åº¦: ${getKeywordDepthInfo(keywords.depth)}

=== SEO ç­–ç•¥å»ºè­° ===
${generateComprehensiveSEORecommendations(keywords)}

=== é—œéµå­—è³¼è²·ç­–ç•¥ ===
${generateComprehensiveKeywordPurchaseStrategy(keywords)}

=== å…§å®¹ç­–ç•¥å»ºè­° ===
${generateContentStrategyRecommendations(keywords)}

---
ç”± iStaging å¸‚å ´æƒ…è³‡èˆ‡ç«¶å“åˆ†æå¹³å°ç”Ÿæˆ
`;
        }

        // ç”Ÿæˆé—œéµå­—åˆ†æå ±å‘Š
        function generateKeywordReport() {
            try {
                const keywords = collectKeywordsData();
                
                if (keywords.primary.length === 0 && keywords.longTail.length === 0) {
                    showAlert('æ²’æœ‰é—œéµå­—', 'è«‹å…ˆè¼¸å…¥é—œéµå­—å†ç”Ÿæˆå ±å‘Š', 'warning');
                    return;
                }

                showAlert('ç”Ÿæˆä¸­', 'æ­£åœ¨ç”Ÿæˆé—œéµå­—åˆ†æå ±å‘Š...', 'info');

                const report = generateKeywordAnalysisReport(keywords);
                const filename = `é—œéµå­—åˆ†æå ±å‘Š_${new Date().toISOString().split('T')[0]}.txt`;
                
                downloadFile(report, filename);
                showAlert('å ±å‘Šç”ŸæˆæˆåŠŸ', `${filename} å·²ä¸‹è¼‰åˆ°æ‚¨çš„è£ç½®`, 'success');

            } catch (error) {
                console.error('ç”Ÿæˆé—œéµå­—å ±å‘Šå¤±æ•—:', error);
                showAlert('å ±å‘Šç”Ÿæˆå¤±æ•—', 'ç„¡æ³•ç”Ÿæˆé—œéµå­—åˆ†æå ±å‘Š', 'error');
            }
        }

        // ç”Ÿæˆé—œéµå­—åˆ†æå ±å‘Šå…§å®¹
        function generateKeywordAnalysisReport(keywords) {
            const marketInfo = getMarketInfo(keywords.marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(keywords.marketPositioning.primaryLanguage);

            return `é—œéµå­—åˆ†æå ±å‘Š
ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}

=== å¸‚å ´èƒŒæ™¯åˆ†æ ===
ç›®æ¨™å¸‚å ´: ${marketInfo.name}
å¸‚å ´ç‰¹é»: ${marketInfo.characteristics}
ç«¶çˆ­ç’°å¢ƒ: ${marketInfo.competition}
æœå°‹è¡Œç‚º: ${marketInfo.searchBehavior}

å•†æ¥­æ¨¡å¼: ${businessModelInfo.name}
æ¨¡å¼ç‰¹é»: ${businessModelInfo.characteristics}
é—œéµå­—ç­–ç•¥: ${businessModelInfo.keywordStrategy}

ç›®æ¨™å®¢ç¾¤: ${getTargetAudienceInfo(keywords.marketPositioning.targetAudience)}
èªè¨€ç’°å¢ƒ: ${languageInfo.name}
æœ¬åœ°åŒ–éœ€æ±‚: ${getLocalizationInfo(keywords.marketPositioning.localizationLevel)}

=== é—œéµå­—åˆ†æ ===
ä¸»è¦é—œéµå­—æ•¸é‡: ${keywords.primary.length}
é•·å°¾é—œéµå­—æ•¸é‡: ${keywords.longTail.length}
åˆ†ææ·±åº¦: ${getKeywordDepthInfo(keywords.depth)}

=== é—œéµå­—åˆ†é¡èˆ‡å»ºè­° ===
${generateKeywordCategorization(keywords)}

=== ç«¶çˆ­åˆ†æ ===
${generateKeywordCompetitionAnalysis(keywords)}

=== æŠ•è³‡å ±é…¬ç‡é æ¸¬ ===
${generateROIPrediction(keywords)}

=== åŸ·è¡Œå»ºè­° ===
${generateExecutionRecommendations(keywords)}

---
ç”± iStaging å¸‚å ´æƒ…è³‡èˆ‡ç«¶å“åˆ†æå¹³å°ç”Ÿæˆ
`;
        }

        // è¼”åŠ©å‡½æ•¸ï¼šç²å–å¸‚å ´è³‡è¨Š
        function getMarketInfo(marketCode) {
            const markets = {
                'tw': { name: 'å°ç£', code: 'TW', characteristics: 'æ•¸ä½åŒ–ç¨‹åº¦é«˜ï¼Œè¡Œå‹•è£ç½®æ™®åŠç‡é«˜', competition: 'ç«¶çˆ­æ¿€çƒˆï¼Œæœ¬åœ°åŒ–éœ€æ±‚å¼·', searchBehavior: 'åå¥½ç¹é«”ä¸­æ–‡ï¼Œé‡è¦–æœ¬åœ°åŒ–å…§å®¹' },
                'hk': { name: 'é¦™æ¸¯', code: 'HK', characteristics: 'åœ‹éš›åŒ–ç¨‹åº¦é«˜ï¼Œæ¶ˆè²»èƒ½åŠ›å¼·', competition: 'åœ‹éš›å“ç‰Œç«¶çˆ­æ¿€çƒˆ', searchBehavior: 'ä¸­è‹±æ–‡ä¸¦ç”¨ï¼Œé‡è¦–å“è³ª' },
                'sg': { name: 'æ–°åŠ å¡', code: 'SG', characteristics: 'å¤šèªè¨€ç’°å¢ƒï¼Œç§‘æŠ€ç™¼é”', competition: 'åœ‹éš›åŒ–ç«¶çˆ­ï¼Œå“è³ªè¦æ±‚é«˜', searchBehavior: 'å¤šèªè¨€æœå°‹ï¼Œé‡è¦–æ•ˆç‡' },
                'my': { name: 'é¦¬ä¾†è¥¿äº', code: 'MY', characteristics: 'å¤šå…ƒæ–‡åŒ–ï¼Œæˆé•·æ½›åŠ›å¤§', competition: 'ä¸­ç­‰ç«¶çˆ­ï¼Œæœ¬åœ°åŒ–æ©Ÿæœƒå¤š', searchBehavior: 'å¤šèªè¨€ï¼Œåƒ¹æ ¼æ•æ„Ÿ' },
                'th': { name: 'æ³°åœ‹', code: 'TH', characteristics: 'æ•¸ä½åŒ–å¿«é€Ÿç™¼å±•', competition: 'æœ¬åœ°å“ç‰Œå„ªå‹¢æ˜é¡¯', searchBehavior: 'æ³°èªç‚ºä¸»ï¼Œè¦–è¦ºå…§å®¹é‡è¦' },
                'vn': { name: 'è¶Šå—', code: 'VN', characteristics: 'å¹´è¼•äººå£å¤šï¼Œæˆé•·å¿«é€Ÿ', competition: 'æ–°èˆˆå¸‚å ´ï¼Œæ©Ÿæœƒå¤š', searchBehavior: 'è¶Šå—èªï¼Œè¡Œå‹•å„ªå…ˆ' },
                'id': { name: 'å°å°¼', code: 'ID', characteristics: 'äººå£çœ¾å¤šï¼Œå¸‚å ´æ½›åŠ›å¤§', competition: 'æœ¬åœ°åŒ–éœ€æ±‚å¼·', searchBehavior: 'å°å°¼èªï¼Œç¤¾ç¾¤åª’é«”é‡è¦' },
                'ph': { name: 'è²å¾‹è³“', code: 'PH', characteristics: 'è‹±èªæ™®åŠï¼Œåœ‹éš›åŒ–ç¨‹åº¦é«˜', competition: 'åœ‹éš›å“ç‰Œç«¶çˆ­', searchBehavior: 'è‹±èªå’Œè²å¾‹è³“èªä¸¦ç”¨' },
                'jp': { name: 'æ—¥æœ¬', code: 'JP', characteristics: 'å“è³ªè¦æ±‚æ¥µé«˜ï¼ŒæŠ€è¡“å…ˆé€²', competition: 'ç«¶çˆ­æ¿€çƒˆï¼Œå“è³ªè‡³ä¸Š', searchBehavior: 'æ—¥èªï¼Œé‡è¦–ç´°ç¯€' },
                'kr': { name: 'éŸ“åœ‹', code: 'KR', characteristics: 'ç§‘æŠ€ç™¼é”ï¼Œå‰µæ–°å°å‘', competition: 'æŠ€è¡“ç«¶çˆ­æ¿€çƒˆ', searchBehavior: 'éŸ“èªï¼Œé‡è¦–å‰µæ–°' },
                'cn': { name: 'ä¸­åœ‹å¤§é™¸', code: 'CN', characteristics: 'å¸‚å ´è¦æ¨¡å·¨å¤§ï¼Œç«¶çˆ­æ¿€çƒˆ', competition: 'æ¥µåº¦ç«¶çˆ­ï¼Œæœ¬åœ°åŒ–é‡è¦', searchBehavior: 'ç°¡é«”ä¸­æ–‡ï¼Œå¹³å°ç”Ÿæ…‹é‡è¦' },
                'us': { name: 'ç¾åœ‹', code: 'US', characteristics: 'æˆç†Ÿå¸‚å ´ï¼Œå‰µæ–°å°å‘', competition: 'é«˜åº¦ç«¶çˆ­ï¼Œå‰µæ–°é‡è¦', searchBehavior: 'è‹±èªï¼Œé‡è¦–ä¾¿åˆ©æ€§' },
                'ca': { name: 'åŠ æ‹¿å¤§', code: 'CA', characteristics: 'å¤šå…ƒæ–‡åŒ–ï¼Œå“è³ªè¦æ±‚é«˜', competition: 'åœ‹éš›ç«¶çˆ­ï¼Œå“è³ªé‡è¦', searchBehavior: 'è‹±èªå’Œæ³•èªï¼Œé‡è¦–å“è³ª' },
                'au': { name: 'æ¾³æ´²', code: 'AU', characteristics: 'é«˜æ¶ˆè²»èƒ½åŠ›ï¼Œå“è³ªå°å‘', competition: 'åœ‹éš›ç«¶çˆ­ï¼Œå“è³ªé‡è¦', searchBehavior: 'è‹±èªï¼Œé‡è¦–å“è³ªå’Œæœå‹™' },
                'uk': { name: 'è‹±åœ‹', code: 'UK', characteristics: 'æˆç†Ÿå¸‚å ´ï¼Œå‰µæ–°å°å‘', competition: 'é«˜åº¦ç«¶çˆ­ï¼Œå‰µæ–°é‡è¦', searchBehavior: 'è‹±èªï¼Œé‡è¦–å“ç‰Œ' },
                'de': { name: 'å¾·åœ‹', code: 'DE', characteristics: 'æŠ€è¡“å°å‘ï¼Œå“è³ªè¦æ±‚é«˜', competition: 'æŠ€è¡“ç«¶çˆ­æ¿€çƒˆ', searchBehavior: 'å¾·èªï¼Œé‡è¦–æŠ€è¡“å’Œå“è³ª' },
                'fr': { name: 'æ³•åœ‹', code: 'FR', characteristics: 'æ–‡åŒ–å°å‘ï¼Œå“è³ªè¦æ±‚é«˜', competition: 'æ–‡åŒ–ç«¶çˆ­ï¼Œå“è³ªé‡è¦', searchBehavior: 'æ³•èªï¼Œé‡è¦–æ–‡åŒ–å’Œå“è³ª' },
                'global': { name: 'å…¨çƒå¸‚å ´', code: 'Global', characteristics: 'å¤šå…ƒåŒ–ï¼Œæœ¬åœ°åŒ–éœ€æ±‚å¼·', competition: 'åœ‹éš›ç«¶çˆ­ï¼Œæœ¬åœ°åŒ–é‡è¦', searchBehavior: 'å¤šèªè¨€ï¼Œæ–‡åŒ–é©æ‡‰é‡è¦' }
            };
            return markets[marketCode] || { name: 'æœªæŒ‡å®š', code: 'Unknown', characteristics: 'æœªçŸ¥', competition: 'æœªçŸ¥', searchBehavior: 'æœªçŸ¥' };
        }

        // è¼”åŠ©å‡½æ•¸ï¼šç²å–å•†æ¥­æ¨¡å¼è³‡è¨Š
        function getBusinessModelInfo(modelCode) {
            const models = {
                'b2b': { name: 'B2B (ä¼æ¥­å°ä¼æ¥­)', characteristics: 'å°ˆæ¥­æ€§å¼·ï¼Œæ±ºç­–é€±æœŸé•·', keywordStrategy: 'å°ˆæ¥­è¡“èªï¼Œè§£æ±ºæ–¹æ¡ˆå°å‘' },
                'b2c': { name: 'B2C (ä¼æ¥­å°æ¶ˆè²»è€…)', characteristics: 'ç”¨æˆ¶é«”é©—é‡è¦ï¼Œæ±ºç­–å¿«é€Ÿ', keywordStrategy: 'ç”¨æˆ¶å‹å¥½ï¼Œæƒ…æ„Ÿè¨´æ±‚' },
                'b2b2c': { name: 'B2B2C (ä¼æ¥­å°ä¼æ¥­å°æ¶ˆè²»è€…)', characteristics: 'è¤‡é›œåƒ¹å€¼éˆï¼Œå¤šæ–¹åˆ©ç›Š', keywordStrategy: 'å¹³å°åƒ¹å€¼ï¼Œç”Ÿæ…‹ç³»çµ±' },
                'c2c': { name: 'C2C (æ¶ˆè²»è€…å°æ¶ˆè²»è€…)', characteristics: 'ç¤¾ç¾¤é©…å‹•ï¼Œä¿¡ä»»é‡è¦', keywordStrategy: 'ç¤¾ç¾¤é—œéµå­—ï¼Œä¿¡ä»»å»ºç«‹' },
                'saas': { name: 'SaaS (è»Ÿé«”å³æœå‹™)', characteristics: 'è¨‚é–±æ¨¡å¼ï¼ŒæŒçºŒåƒ¹å€¼', keywordStrategy: 'è§£æ±ºæ–¹æ¡ˆï¼ŒROIå°å‘' },
                'marketplace': { name: 'Marketplace (å¹³å°æ¨¡å¼)', characteristics: 'ç¶²è·¯æ•ˆæ‡‰ï¼Œè¦æ¨¡é‡è¦', keywordStrategy: 'å¹³å°åƒ¹å€¼ï¼Œé¸æ“‡å¤šæ¨£' },
                'subscription': { name: 'Subscription (è¨‚é–±æ¨¡å¼)', characteristics: 'æŒçºŒæ”¶å…¥ï¼Œç”¨æˆ¶ç•™å­˜', keywordStrategy: 'åƒ¹å€¼æŒçºŒï¼Œä¾¿åˆ©æ€§' },
                'freemium': { name: 'Freemium (å…è²»å¢å€¼)', characteristics: 'ç”¨æˆ¶ç²å–ï¼Œè½‰æ›é‡è¦', keywordStrategy: 'å…è²»åƒ¹å€¼ï¼Œå‡ç´šèª˜å› ' },
                'ecommerce': { name: 'E-commerce (é›»å•†)', characteristics: 'è½‰æ›ç‡é‡è¦ï¼Œç”¨æˆ¶é«”é©—', keywordStrategy: 'ç”¢å“é—œéµå­—ï¼Œè³¼è²·æ„åœ–' },
                'agency': { name: 'Agency (ä»£ç†/æœå‹™)', characteristics: 'å°ˆæ¥­æœå‹™ï¼Œä¿¡ä»»å»ºç«‹', keywordStrategy: 'å°ˆæ¥­èƒ½åŠ›ï¼Œæœå‹™å“è³ª' }
            };
            return models[modelCode] || { name: 'æœªæŒ‡å®š', characteristics: 'æœªçŸ¥', keywordStrategy: 'æœªçŸ¥' };
        }

        // è¼”åŠ©å‡½æ•¸ï¼šç²å–èªè¨€è³‡è¨Š
        function getLanguageInfo(langCode) {
            const languages = {
                'zh-tw': { name: 'ç¹é«”ä¸­æ–‡ (å°ç£)', characteristics: 'æœ¬åœ°åŒ–éœ€æ±‚å¼·ï¼Œæ–‡åŒ–é©æ‡‰é‡è¦' },
                'zh-hk': { name: 'ç¹é«”ä¸­æ–‡ (é¦™æ¸¯)', characteristics: 'åœ‹éš›åŒ–ç¨‹åº¦é«˜ï¼Œä¸­è‹±æ–‡ä¸¦ç”¨' },
                'zh-cn': { name: 'ç°¡é«”ä¸­æ–‡ (ä¸­åœ‹)', characteristics: 'å¸‚å ´è¦æ¨¡å¤§ï¼Œå¹³å°ç”Ÿæ…‹é‡è¦' },
                'en': { name: 'English (è‹±èª)', characteristics: 'åœ‹éš›é€šç”¨ï¼Œç«¶çˆ­æ¿€çƒˆ' },
                'ja': { name: 'æ—¥æœ¬èª (æ—¥èª)', characteristics: 'å“è³ªè¦æ±‚é«˜ï¼Œç´°ç¯€é‡è¦' },
                'ko': { name: 'í•œêµ­ì–´ (éŸ“èª)', characteristics: 'å‰µæ–°å°å‘ï¼ŒæŠ€è¡“é‡è¦–' },
                'th': { name: 'à¹„à¸—à¸¢ (æ³°èª)', characteristics: 'æœ¬åœ°åŒ–é‡è¦ï¼Œæ–‡åŒ–é©æ‡‰' },
                'vi': { name: 'Tiáº¿ng Viá»‡t (è¶Šå—èª)', characteristics: 'æˆé•·å¸‚å ´ï¼Œæœ¬åœ°åŒ–æ©Ÿæœƒ' },
                'id': { name: 'Bahasa Indonesia (å°å°¼èª)', characteristics: 'äººå£çœ¾å¤šï¼Œå¸‚å ´æ½›åŠ›å¤§' },
                'ms': { name: 'Bahasa Melayu (é¦¬ä¾†èª)', characteristics: 'å¤šå…ƒæ–‡åŒ–ï¼Œæœ¬åœ°åŒ–éœ€æ±‚' }
            };
            return languages[langCode] || { name: 'æœªæŒ‡å®š', characteristics: 'æœªçŸ¥' };
        }

        // è¼”åŠ©å‡½æ•¸ï¼šç²å–ç›®æ¨™å®¢ç¾¤è³‡è¨Š
        function getTargetAudienceInfo(audienceCode) {
            const audiences = {
                'startup': 'æ–°å‰µå…¬å¸ - æˆæœ¬æ•æ„Ÿï¼Œå¿«é€Ÿæ±ºç­–',
                'sme': 'ä¸­å°ä¼æ¥­ - å¯¦ç”¨å°å‘ï¼Œæ€§åƒ¹æ¯”é‡è¦',
                'enterprise': 'å¤§å‹ä¼æ¥­ - å“è³ªè¦æ±‚é«˜ï¼Œæ±ºç­–é€±æœŸé•·',
                'freelancer': 'è‡ªç”±å·¥ä½œè€… - éˆæ´»æ€§é‡è¦ï¼Œæˆæœ¬æ§åˆ¶',
                'student': 'å­¸ç”Ÿ - åƒ¹æ ¼æ•æ„Ÿï¼ŒåŠŸèƒ½éœ€æ±‚',
                'professional': 'å°ˆæ¥­äººå£« - å“è³ªè¦æ±‚é«˜ï¼Œæ•ˆç‡é‡è¦',
                'consumer': 'ä¸€èˆ¬æ¶ˆè²»è€… - ç”¨æˆ¶é«”é©—ï¼Œæƒ…æ„Ÿè¨´æ±‚',
                'elderly': 'éŠ€é«®æ— - æ˜“ç”¨æ€§ï¼Œä¿¡ä»»å»ºç«‹',
                'youth': 'å¹´è¼•æ—ç¾¤ - å‰µæ–°ï¼Œç¤¾äº¤åˆ†äº«',
                'parent': 'å®¶é•· - å®‰å…¨ï¼Œå“è³ªï¼Œæ•™è‚²åƒ¹å€¼'
            };
            return audiences[audienceCode] || 'æœªæŒ‡å®š';
        }

        // è¼”åŠ©å‡½æ•¸ï¼šç²å–æœ¬åœ°åŒ–è³‡è¨Š
        function getLocalizationInfo(levelCode) {
            const levels = {
                'basic': 'åŸºç¤æœ¬åœ°åŒ– (ç¿»è­¯) - åŸºæœ¬èªè¨€é©æ‡‰',
                'standard': 'æ¨™æº–æœ¬åœ°åŒ– (ç¿»è­¯+æ–‡åŒ–é©æ‡‰) - æ–‡åŒ–å…§å®¹èª¿æ•´',
                'advanced': 'æ·±åº¦æœ¬åœ°åŒ– (å®Œå…¨åœ¨åœ°åŒ–) - å®Œå…¨æ–‡åŒ–é©æ‡‰',
                'native': 'åŸç”Ÿæœ¬åœ°åŒ– (åœ¨åœ°åœ˜éšŠé–‹ç™¼) - åŸç”Ÿæ–‡åŒ–é«”é©—'
            };
            return levels[levelCode] || 'æœªæŒ‡å®š';
        }

        // è¼”åŠ©å‡½æ•¸ï¼šç²å–é—œéµå­—æ·±åº¦è³‡è¨Š
        function getKeywordDepthInfo(depthCode) {
            const depths = {
                'basic': 'åŸºç¤åˆ†æ (æœå°‹é‡ã€ç«¶çˆ­åº¦)',
                'standard': 'æ¨™æº–åˆ†æ (æœå°‹é‡ã€ç«¶çˆ­åº¦ã€å‡ºåƒ¹å»ºè­°)',
                'comprehensive': 'æ·±åº¦åˆ†æ (æœå°‹é‡ã€ç«¶çˆ­åº¦ã€å‡ºåƒ¹å»ºè­°ã€å…§å®¹ç­–ç•¥)'
            };
            return depths[depthCode] || 'æœªæŒ‡å®š';
        }

        // é€šç”¨ä¸‹è¼‰æª”æ¡ˆå‡½æ•¸
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ç”Ÿæˆ SEO å»ºè­°
        function generateSEORecommendations(keywords, marketPositioning) {
            return `1. é‡å° ${getMarketInfo(marketPositioning.targetMarket).name} å¸‚å ´å„ªåŒ–
2. ä½¿ç”¨ ${getLanguageInfo(marketPositioning.primaryLanguage).name} é€²è¡Œå…§å®¹å‰µä½œ
3. è€ƒæ…® ${getBusinessModelInfo(marketPositioning.businessModel).keywordStrategy}
4. å»ºç«‹é•·å°¾é—œéµå­—å…§å®¹ç­–ç•¥
5. å„ªåŒ–æœ¬åœ°åŒ–å…§å®¹å’Œç”¨æˆ¶é«”é©—`;
        }

        // ç”Ÿæˆé—œéµå­—è³¼è²·å»ºè­°
        function generateKeywordPurchaseRecommendations(keywords, marketPositioning) {
            return `1. ä¸»è¦é—œéµå­—ï¼šé«˜ç«¶çˆ­åº¦ï¼Œå»ºè­° CPC é ç®—åˆ†é… 60%
2. é•·å°¾é—œéµå­—ï¼šä¸­ç­‰ç«¶çˆ­åº¦ï¼Œå»ºè­° CPC é ç®—åˆ†é… 40%
3. æ ¹æ“š ${getMarketInfo(marketPositioning.targetMarket).name} å¸‚å ´èª¿æ•´å‡ºåƒ¹
4. è€ƒæ…® ${getBusinessModelInfo(marketPositioning.businessModel).name} çš„è½‰æ›é€±æœŸ
5. å®šæœŸç›£æ§å’Œèª¿æ•´é—œéµå­—è¡¨ç¾`;
        }

        // ç”Ÿæˆç¶œåˆ SEO å»ºè­°
        function generateComprehensiveSEORecommendations(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `åŸºæ–¼ ${businessModel.name} å•†æ¥­æ¨¡å¼çš„ SEO ç­–ç•¥å»ºè­°ï¼š

1. æŠ€è¡“ SEO å„ªåŒ–
   - ç¶²ç«™é€Ÿåº¦å„ªåŒ– (ç›®æ¨™è¼‰å…¥æ™‚é–“ < 3ç§’)
   - è¡Œå‹•è£ç½®å‹å–„è¨­è¨ˆ (Mobile-first)
   - çµæ§‹åŒ–è³‡æ–™æ¨™è¨˜ (Schema.org)
   - ç¶²ç«™åœ°åœ–å„ªåŒ– (XML Sitemap)
   - å…§éƒ¨é€£çµçµæ§‹å„ªåŒ–

2. å…§å®¹ SEO ç­–ç•¥
   - ä¸»è¦é—œéµå­—ï¼š${keywords.primary.slice(0, 3).join(', ')}
   - é•·å°¾é—œéµå­—ï¼š${keywords.longTail.slice(0, 5).join(', ')}
   - å…§å®¹æ·±åº¦ï¼šæ¯ç¯‡æ–‡ç« è‡³å°‘ 1500 å­—
   - æ›´æ–°é »ç‡ï¼šæ¯é€± 2-3 ç¯‡æ–°å…§å®¹
   - å…§å®¹é¡å‹ï¼šéƒ¨è½æ ¼æ–‡ç« ã€æ¡ˆä¾‹ç ”ç©¶ã€ç™½çš®æ›¸

3. é é¢ SEO å„ªåŒ–
   - æ¨™é¡Œæ¨™ç±¤ (Title Tag) åŒ…å«ä¸»è¦é—œéµå­—
   - Meta æè¿°å„ªåŒ– (150-160 å­—å…ƒ)
   - H1-H6 æ¨™ç±¤å±¤ç´šçµæ§‹
   - åœ–ç‰‡ Alt æ¨™ç±¤å„ªåŒ–
   - URL çµæ§‹å„ªåŒ–

4. å¤–éƒ¨ SEO ç­–ç•¥
   - é«˜å“è³ªåå‘é€£çµå»ºç«‹
   - è¡Œæ¥­ç›¸é—œç¶²ç«™åˆä½œ
   - ç¤¾ç¾¤åª’é«”å…§å®¹åˆ†äº«
   - å½±éŸ¿è€…è¡ŒéŠ·åˆä½œ
   - å®¢åº§æ–‡ç« ç™¼å¸ƒ

5. æœ¬åœ° SEO (é©ç”¨æ–¼å¯¦é«”æ¥­å‹™)
   - Google My Business å„ªåŒ–
   - æœ¬åœ°é—œéµå­—å„ªåŒ–
   - å®¢æˆ¶è©•åƒ¹ç®¡ç†
   - æœ¬åœ°ç›®éŒ„æäº¤
   - æœ¬åœ°å…§å®¹ç­–ç•¥`;
        }

        // ç”Ÿæˆç¶œåˆé—œéµå­—è³¼è²·ç­–ç•¥
        function generateComprehensiveKeywordPurchaseStrategy(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `åŸºæ–¼ ${businessModel.name} çš„é—œéµå­—è³¼è²·ç­–ç•¥ï¼š

1. ä¸»è¦é—œéµå­—ç­–ç•¥ (${keywords.primary.length} å€‹)
   - é ç®—åˆ†é…ï¼šç¸½é ç®—çš„ 40%
   - å‡ºåƒ¹ç­–ç•¥ï¼šç«¶çˆ­æ€§å‡ºåƒ¹ï¼Œçˆ­å–å‰ä¸‰å
   - åŒ¹é…é¡å‹ï¼šå»£æ³›åŒ¹é… + å¦å®šé—œéµå­—
   - ç›®æ¨™ï¼šå“ç‰ŒçŸ¥ååº¦ã€æµé‡å»ºç«‹

2. é•·å°¾é—œéµå­—ç­–ç•¥ (${keywords.longTail.length} å€‹)
   - é ç®—åˆ†é…ï¼šç¸½é ç®—çš„ 35%
   - å‡ºåƒ¹ç­–ç•¥ï¼šç²¾æº–å‡ºåƒ¹ï¼Œæ§åˆ¶æˆæœ¬
   - åŒ¹é…é¡å‹ï¼šè©çµ„åŒ¹é… + å®Œå…¨åŒ¹é…
   - ç›®æ¨™ï¼šè½‰æ›ç‡æå‡ã€ROI å„ªåŒ–

3. å•†æ¥­æ„åœ–é—œéµå­—
   - é ç®—åˆ†é…ï¼šç¸½é ç®—çš„ 15%
   - å‡ºåƒ¹ç­–ç•¥ï¼šé«˜ç«¶çˆ­å‡ºåƒ¹
   - åŒ¹é…é¡å‹ï¼šå®Œå…¨åŒ¹é…ç‚ºä¸»
   - ç›®æ¨™ï¼šç›´æ¥è½‰æ›ã€éŠ·å”®ç·šç´¢

4. è³‡è¨Šå‹é—œéµå­—
   - é ç®—åˆ†é…ï¼šç¸½é ç®—çš„ 10%
   - å‡ºåƒ¹ç­–ç•¥ï¼šä¸­ç­‰å‡ºåƒ¹
   - åŒ¹é…é¡å‹ï¼šå»£æ³›åŒ¹é…
   - ç›®æ¨™ï¼šå…§å®¹è¡ŒéŠ·ã€æ•™è‚²å®¢æˆ¶

5. å‡ºåƒ¹å»ºè­°
   - ä¸»è¦é—œéµå­—ï¼š$$$ (é«˜ç«¶çˆ­)
   - é•·å°¾é—œéµå­—ï¼š$$ (ä¸­ç­‰ç«¶çˆ­)
   - å•†æ¥­æ„åœ–ï¼š$$$ (é«˜åƒ¹å€¼)
   - è³‡è¨Šå‹ï¼š$ (ä½ç«¶çˆ­)

6. é ç®—åˆ†é…å»ºè­°
   - æ¯æ—¥é ç®—ï¼šæ ¹æ“šå¸‚å ´ç«¶çˆ­åº¦èª¿æ•´
   - é€±æœŸæ€§èª¿æ•´ï¼šæ¯é€±æª¢è¦–ä¸€æ¬¡
   - å­£ç¯€æ€§èª¿æ•´ï¼šé‡è¦ç¯€æ—¥å¢åŠ é ç®—
   - A/B æ¸¬è©¦ï¼šæŒçºŒå„ªåŒ–å‡ºåƒ¹ç­–ç•¥`;
        }

        // ç”Ÿæˆå…§å®¹ç­–ç•¥å»ºè­°
        function generateContentStrategyRecommendations(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `åŸºæ–¼ ${businessModel.name} çš„å…§å®¹ç­–ç•¥å»ºè­°ï¼š

1. å…§å®¹é¡å‹è¦åŠƒ
   - æ•™è‚²å‹å…§å®¹ï¼š${keywords.primary.slice(0, 2).join(', ')} ç›¸é—œæŒ‡å—
   - æ¡ˆä¾‹ç ”ç©¶ï¼šå®¢æˆ¶æˆåŠŸæ•…äº‹ã€ROI å±•ç¤º
   - è¡Œæ¥­æ´å¯Ÿï¼šè¶¨å‹¢åˆ†æã€å¸‚å ´å ±å‘Š
   - ç”¢å“å±•ç¤ºï¼šåŠŸèƒ½ä»‹ç´¹ã€ä½¿ç”¨æ•™å­¸
   - å®¢æˆ¶æœå‹™ï¼šFAQã€æ•…éšœæ’é™¤

2. å…§å®¹ä¸»é¡Œå»ºè­°
   - ä¸»è¦é—œéµå­—ä¸»é¡Œï¼š${keywords.primary.map(k => `"${k} å®Œæ•´æŒ‡å—"`).join(', ')}
   - é•·å°¾é—œéµå­—ä¸»é¡Œï¼š${keywords.longTail.slice(0, 3).map(k => `"${k} æœ€ä½³å¯¦è¸"`).join(', ')}
   - å•†æ¥­æ¨¡å¼ä¸»é¡Œï¼š${businessModel.focus} ç›¸é—œå…§å®¹
   - å®¢æˆ¶ç—›é»ä¸»é¡Œï¼šè§£æ±ºæ–¹æ¡ˆã€æœ€ä½³å¯¦è¸

3. å…§å®¹ç™¼å¸ƒç­–ç•¥
   - ç™¼å¸ƒé »ç‡ï¼šæ¯é€± 2-3 ç¯‡
   - æœ€ä½³æ™‚é–“ï¼šé€±äºŒè‡³é€±å›› 9:00-11:00
   - å…§å®¹é•·åº¦ï¼š1500-3000 å­—
   - å¤šåª’é«”å…§å®¹ï¼šå½±ç‰‡ã€è³‡è¨Šåœ–è¡¨ã€æ’­å®¢

4. å…§å®¹æ¨å»£ç­–ç•¥
   - ç¤¾ç¾¤åª’é«”ï¼šLinkedInã€Facebookã€Twitter
   - é›»å­éƒµä»¶è¡ŒéŠ·ï¼šè¨‚é–±è€…åˆ†äº«
   - å½±éŸ¿è€…åˆä½œï¼šè¡Œæ¥­å°ˆå®¶èƒŒæ›¸
   - ä»˜è²»æ¨å»£ï¼šFacebook Adsã€LinkedIn Ads

5. å…§å®¹å„ªåŒ–å»ºè­°
   - SEO å„ªåŒ–ï¼šé—œéµå­—å¯†åº¦ 1-2%
   - å¯è®€æ€§ï¼šFlesch Reading Ease > 60
   - è¦–è¦ºå…ƒç´ ï¼šåœ–ç‰‡ã€å½±ç‰‡ã€åœ–è¡¨
   - è¡Œå‹•å„ªåŒ–ï¼šéŸ¿æ‡‰å¼è¨­è¨ˆ
   - äº’å‹•å…ƒç´ ï¼šè©•è«–ã€åˆ†äº«æŒ‰éˆ•`;
        }

        // ç”Ÿæˆé—œéµå­—åˆ†é¡
        function generateKeywordCategorization(keywords) {
            return `ä¸»è¦é—œéµå­—åˆ†é¡ï¼š
- å“ç‰Œé—œéµå­—ï¼šå»ºç«‹å“ç‰ŒçŸ¥ååº¦
- ç”¢å“é—œéµå­—ï¼šç›´æ¥è½‰æ›å°å‘
- è§£æ±ºæ–¹æ¡ˆé—œéµå­—ï¼šå•é¡Œè§£æ±ºå°å‘

é•·å°¾é—œéµå­—åˆ†é¡ï¼š
- å•é¡Œè§£æ±ºå‹ï¼šå›ç­”å…·é«”å•é¡Œ
- æ¯”è¼ƒå‹ï¼šç”¢å“æ¯”è¼ƒå’Œé¸æ“‡
- æ•™ç¨‹å‹ï¼šæ•™å­¸å’ŒæŒ‡å—å…§å®¹`;
        }

        // ç”Ÿæˆç«¶çˆ­åˆ†æ
        function generateKeywordCompetitionAnalysis(keywords) {
            return `ç«¶çˆ­åˆ†æï¼š
- ä¸»è¦é—œéµå­—ç«¶çˆ­åº¦ï¼šé«˜ï¼Œéœ€è¦æŒçºŒå„ªåŒ–
- é•·å°¾é—œéµå­—ç«¶çˆ­åº¦ï¼šä¸­ç­‰ï¼Œæ©Ÿæœƒè¼ƒå¤š
- å»ºè­°ï¼šå°ˆæ³¨æ–¼é•·å°¾é—œéµå­—å»ºç«‹å„ªå‹¢
- ç›£æ§ç«¶çˆ­å°æ‰‹é—œéµå­—ç­–ç•¥`;
        }

        // ç”Ÿæˆ ROI é æ¸¬
        function generateROIPrediction(keywords) {
            return `ROI é æ¸¬ï¼š
- çŸ­æœŸ (1-3å€‹æœˆ)ï¼šå»ºç«‹é—œéµå­—æ’ååŸºç¤
- ä¸­æœŸ (3-6å€‹æœˆ)ï¼šé–‹å§‹çœ‹åˆ°æœ‰æ©Ÿæµé‡å¢é•·
- é•·æœŸ (6-12å€‹æœˆ)ï¼šå¯¦ç¾ç©©å®šçš„è½‰æ›å’Œæ”¶å…¥
- å»ºè­°ï¼šæŒçºŒæŠ•è³‡å…§å®¹å’ŒæŠ€è¡“å„ªåŒ–`;
        }

        // ç”ŸæˆåŸ·è¡Œå»ºè­°
        function generateExecutionRecommendations(keywords) {
            return `åŸ·è¡Œå»ºè­°ï¼š
1. ç«‹å³è¡Œå‹•ï¼šé–‹å§‹å»ºç«‹é—œéµå­—å…§å®¹
2. çŸ­æœŸç›®æ¨™ï¼šå„ªåŒ–ä¸»è¦é—œéµå­—æ’å
3. ä¸­æœŸç›®æ¨™ï¼šå»ºç«‹é•·å°¾é—œéµå­—å„ªå‹¢
4. é•·æœŸç›®æ¨™ï¼šå»ºç«‹å“ç‰Œæ¬Šå¨æ€§
5. æŒçºŒå„ªåŒ–ï¼šå®šæœŸç›£æ§å’Œèª¿æ•´ç­–ç•¥`;
        }

        // æœå°‹ç«¶çˆ­å°æ‰‹
        function searchCompetitors() {
            try {
                const topic = state.analysisData.topic;
                const brandName = state.analysisData.brand?.name;
                const industry = state.analysisData.industry?.category;
                const products = state.analysisData.products || [];

                if (!topic || !brandName || !industry) {
                    showAlert('è³‡æ–™ä¸å®Œæ•´', 'è«‹ç¢ºä¿å¡«å¯«äº†åˆ†æä¸»é¡Œã€å“ç‰Œåç¨±å’Œè¡Œæ¥­é¡åˆ¥', 'warning');
                    return;
                }

                console.log('é–‹å§‹æœå°‹ç«¶çˆ­å°æ‰‹...', { topic, brandName, industry, products });
                
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                const resultsContainer = document.getElementById('auto-search-results');
                if (resultsContainer) {
                    resultsContainer.innerHTML = `
                        <div class="flex items-center justify-center py-8">
                            <div class="spinner"></div>
                            <span class="ml-3 text-gray-400">æ­£åœ¨åˆ†æ ${industry} è¡Œæ¥­ç«¶çˆ­å°æ‰‹...</span>
                        </div>
                    `;
                }

                // åŸºæ–¼è¡Œæ¥­å’Œç”¢å“é€²è¡ŒçœŸå¯¦ç«¶çˆ­å°æ‰‹åˆ†æ
                setTimeout(async () => {
                    try {
                        const realCompetitors = await analyzeIndustryCompetitors(topic, brandName, industry, products);
                        
                        console.log('ç«¶çˆ­å°æ‰‹åˆ†æå®Œæˆï¼Œçµæœ:', realCompetitors);
                        
                        if (realCompetitors && realCompetitors.length > 0) {
                            displaySearchResults(realCompetitors);
                            showAlert('åˆ†æå®Œæˆ', `æˆåŠŸæ‰¾åˆ° ${realCompetitors.length} å€‹ç«¶çˆ­å°æ‰‹`, 'success');
                        } else {
                            console.error('ç«¶çˆ­å°æ‰‹åˆ†ææœªè¿”å›æœ‰æ•ˆè³‡æ–™');
                            showAlert('åˆ†æå¤±æ•—', 'æœªæ‰¾åˆ°ç›¸é—œç«¶çˆ­å°æ‰‹', 'warning');
                            
                            if (resultsContainer) {
                                resultsContainer.innerHTML = `
                                    <div class="text-center py-8">
                                        <p class="text-yellow-400 mb-4">æœªæ‰¾åˆ°ç›¸é—œç«¶çˆ­å°æ‰‹</p>
                                        <button onclick="searchCompetitors()" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">é‡æ–°å˜—è©¦</button>
                                    </div>
                                `;
                            }
                        }
                    } catch (error) {
                        console.error('ç«¶çˆ­å°æ‰‹åˆ†æå¤±æ•—:', error);
                        showAlert('åˆ†æå¤±æ•—', 'ç«¶çˆ­å°æ‰‹åˆ†æéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤', 'error');
                        
                        // é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹
                        if (resultsContainer) {
                            resultsContainer.innerHTML = `
                                <div class="text-center py-8">
                                    <p class="text-red-400 mb-4">ç«¶çˆ­å°æ‰‹åˆ†æå¤±æ•—</p>
                                    <p class="text-gray-400 text-sm mb-4">éŒ¯èª¤è¨Šæ¯: ${error.message}</p>
                                    <button onclick="searchCompetitors()" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">é‡æ–°å˜—è©¦</button>
                                </div>
                            `;
                        }
                    }
                }, 2000);

            } catch (error) {
                console.error('æœå°‹ç«¶çˆ­å°æ‰‹å¤±æ•—:', error);
                showAlert('æœå°‹å¤±æ•—', 'ç„¡æ³•æœå°‹ç«¶çˆ­å°æ‰‹', 'error');
            }
        }

        // åŸºæ–¼è¡Œæ¥­å’Œç”¢å“åˆ†æçœŸå¯¦ç«¶çˆ­å°æ‰‹
        async function analyzeIndustryCompetitors(topic, brandName, industry, products) {
            try {
                console.log('é–‹å§‹åˆ†æç«¶çˆ­å°æ‰‹:', { topic, brandName, industry, products });
                
                // æª¢æŸ¥æ˜¯å¦æœ‰ API è¨­å®š
                const googleApiKey = document.getElementById('google-api-key')?.value?.trim();
                const searchEngineId = document.getElementById('search-engine-id')?.value?.trim();
                const geminiApiKey = document.getElementById('gemini-api-key')?.value?.trim();
                
                // å¦‚æœæœ‰å®Œæ•´çš„ API è¨­å®šï¼Œå˜—è©¦ä½¿ç”¨æ™ºèƒ½åˆ†æ
                if (googleApiKey && searchEngineId && geminiApiKey) {
                    try {
                        console.log('å˜—è©¦æ™ºèƒ½ç«¶çˆ­å°æ‰‹åˆ†æ...');
                        const smartAnalysis = await performSmartCompetitorAnalysis(brandName, industry, products, topic);
                        
                        if (smartAnalysis && smartAnalysis.competitors && smartAnalysis.competitors.length > 0) {
                            console.log('æ™ºèƒ½åˆ†ææˆåŠŸï¼Œæ‰¾åˆ°ç«¶çˆ­å°æ‰‹:', smartAnalysis.competitors.length);
                            
                            // è½‰æ›ç‚ºç³»çµ±æ ¼å¼
                            const competitors = smartAnalysis.competitors.map((comp, index) => ({
                                id: `smart_comp_${Date.now()}_${index}`,
                                name: comp.name,
                                website: comp.website,
                                linkedin: `https://www.linkedin.com/search/results/companies/?keywords=${encodeURIComponent(comp.name)}`,
                                description: comp.description,
                                industry: industry,
                                marketShare: comp.marketShare || 10,
                                strength: comp.strength || 50,
                                weakness: comp.weakness || 50,
                                opportunity: comp.opportunity || 50,
                                threat: comp.threat || 50,
                                productComparison: comp.productComparison || 'æ™ºèƒ½åˆ†æçµæœ',
                                selected: false
                            }));
                            
                            // å„²å­˜æ™ºèƒ½åˆ†æçµæœ
                            state.analysisData.smartCompetitorAnalysis = {
                                competitors: competitors,
                                marketInsights: smartAnalysis.marketInsights,
                                competitiveAdvantages: smartAnalysis.competitiveAdvantages,
                                threats: smartAnalysis.threats,
                                recommendations: smartAnalysis.recommendations,
                                searchData: smartAnalysis.searchData
                            };
                            
                            return competitors;
                        } else {
                            console.log('æ™ºèƒ½åˆ†ææœªè¿”å›æœ‰æ•ˆç«¶çˆ­å°æ‰‹è³‡æ–™ï¼Œå›é€€åˆ°æ¨¡æ¿åˆ†æ');
                        }
                        
                    } catch (error) {
                        console.error('æ™ºèƒ½ç«¶çˆ­å°æ‰‹åˆ†æå¤±æ•—ï¼Œå›é€€åˆ°æ¨¡æ¿åˆ†æ:', error);
                        showAlert('æ™ºèƒ½åˆ†æå¤±æ•—', 'æ™ºèƒ½åˆ†æå¤±æ•—ï¼Œå·²å›é€€åˆ°æ¨¡æ¿åˆ†æ', 'warning');
                    }
                } else {
                    console.log('API è¨­å®šä¸å®Œæ•´ï¼Œä½¿ç”¨æ¨¡æ¿åˆ†æ');
                }
                
                // å›é€€åˆ°æ¨¡æ¿åˆ†æ
                console.log('é–‹å§‹æ¨¡æ¿ç«¶çˆ­å°æ‰‹åˆ†æ...');
                const competitors = [];
                const competitorCount = state.analysisData.competitorCount || 8;
                
                // æ ¹æ“šè¡Œæ¥­é¡åˆ¥ç”Ÿæˆç›¸é—œçš„ç«¶çˆ­å°æ‰‹
                const industryCompetitors = getIndustryCompetitors(industry, products);
                console.log('æ‰¾åˆ°è¡Œæ¥­ç«¶çˆ­å°æ‰‹:', industryCompetitors.length);
                
                // é¸æ“‡æŒ‡å®šæ•¸é‡çš„ç«¶çˆ­å°æ‰‹
                const selectedCompetitors = industryCompetitors.slice(0, competitorCount);
                
                selectedCompetitors.forEach((competitor, index) => {
                    try {
                        const analysis = analyzeCompetitorStrength(competitor, products, industry);
                        competitors.push({
                            id: `comp_${Date.now()}_${index}`,
                            name: competitor.name,
                            website: competitor.website,
                            linkedin: competitor.linkedin,
                            description: competitor.description,
                            industry: industry,
                            marketShare: analysis.marketShare,
                            strength: analysis.strength,
                            weakness: analysis.weakness,
                            opportunity: analysis.opportunity,
                            threat: analysis.threat,
                            productComparison: analysis.productComparison,
                            selected: false
                        });
                    } catch (error) {
                        console.error(`åˆ†æç«¶çˆ­å°æ‰‹ ${competitor.name} å¤±æ•—:`, error);
                        // æ·»åŠ é è¨­è³‡æ–™
                        competitors.push({
                            id: `comp_${Date.now()}_${index}`,
                            name: competitor.name,
                            website: competitor.website,
                            linkedin: competitor.linkedin,
                            description: competitor.description,
                            industry: industry,
                            marketShare: 10 + Math.floor(Math.random() * 20),
                            strength: 50 + Math.floor(Math.random() * 30),
                            weakness: 30 + Math.floor(Math.random() * 40),
                            opportunity: 40 + Math.floor(Math.random() * 40),
                            threat: 30 + Math.floor(Math.random() * 40),
                            productComparison: 'éœ€è¦é€²ä¸€æ­¥åˆ†æ',
                            selected: false
                        });
                    }
                });
                
                console.log('æ¨¡æ¿åˆ†æå®Œæˆï¼Œè¿”å›ç«¶çˆ­å°æ‰‹:', competitors.length);
                return competitors;
                
            } catch (error) {
                console.error('åˆ†æè¡Œæ¥­ç«¶çˆ­å°æ‰‹å¤±æ•—:', error);
                showAlert('åˆ†æå¤±æ•—', 'ç«¶çˆ­å°æ‰‹åˆ†æå¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
                
                // è¿”å›é è¨­ç«¶çˆ­å°æ‰‹
                return getDefaultCompetitors(industry);
            }
        }

        // ç²å–é è¨­ç«¶çˆ­å°æ‰‹
        function getDefaultCompetitors(industry) {
            const defaultCompetitors = [
                {
                    id: `default_comp_${Date.now()}_1`,
                    name: `${industry}ç«¶çˆ­å°æ‰‹1`,
                    website: 'https://example.com',
                    linkedin: 'https://www.linkedin.com',
                    description: `${industry}è¡Œæ¥­çš„çŸ¥åç«¶çˆ­å°æ‰‹`,
                    industry: industry,
                    marketShare: 15,
                    strength: 70,
                    weakness: 40,
                    opportunity: 60,
                    threat: 35,
                    productComparison: 'éœ€è¦é€²ä¸€æ­¥åˆ†æ',
                    selected: false
                },
                {
                    id: `default_comp_${Date.now()}_2`,
                    name: `${industry}ç«¶çˆ­å°æ‰‹2`,
                    website: 'https://example.com',
                    linkedin: 'https://www.linkedin.com',
                    description: `${industry}è¡Œæ¥­çš„é‡è¦ç«¶çˆ­å°æ‰‹`,
                    industry: industry,
                    marketShare: 12,
                    strength: 65,
                    weakness: 45,
                    opportunity: 55,
                    threat: 40,
                    productComparison: 'éœ€è¦é€²ä¸€æ­¥åˆ†æ',
                    selected: false
                }
            ];
            
            return defaultCompetitors;
        }

        // æ ¹æ“šè¡Œæ¥­ç²å–ç«¶çˆ­å°æ‰‹è³‡æ–™
        function getIndustryCompetitors(industry, products) {
            const industryMap = {
                'technology': [
                    {
                        name: 'é´»æµ·ç²¾å¯†å·¥æ¥­',
                        website: 'https://www.foxconn.com',
                        linkedin: 'https://www.linkedin.com/company/foxconn',
                        description: 'å…¨çƒæœ€å¤§çš„é›»å­è£½é€ æœå‹™å•†ï¼Œå°ˆæ³¨æ–¼æ¶ˆè²»é›»å­ç”¢å“è£½é€ '
                    },
                    {
                        name: 'å°ç©é›»',
                        website: 'https://www.tsmc.com',
                        linkedin: 'https://www.linkedin.com/company/tsmc',
                        description: 'å…¨çƒæœ€å¤§çš„æ™¶åœ“ä»£å·¥å» ï¼Œå°ˆæ³¨æ–¼åŠå°é«”è£½é€ '
                    },
                    {
                        name: 'è¯ç™¼ç§‘æŠ€',
                        website: 'https://www.mediatek.com',
                        linkedin: 'https://www.linkedin.com/company/mediatek',
                        description: 'å…¨çƒé ˜å…ˆçš„æ™¶ç‰‡è¨­è¨ˆå…¬å¸ï¼Œå°ˆæ³¨æ–¼è¡Œå‹•é€šè¨ŠæŠ€è¡“'
                    },
                    {
                        name: 'è¯ç¢©é›»è…¦',
                        website: 'https://www.asus.com',
                        linkedin: 'https://www.linkedin.com/company/asus',
                        description: 'å…¨çƒçŸ¥åé›»è…¦ç¡¬é«”è£½é€ å•†ï¼Œå°ˆæ³¨æ–¼ç­†é›»å’Œä¸»æ©Ÿæ¿'
                    },
                    {
                        name: 'å®ç¢',
                        website: 'https://www.acer.com',
                        linkedin: 'https://www.linkedin.com/company/acer',
                        description: 'å…¨çƒçŸ¥åé›»è…¦å“ç‰Œï¼Œå°ˆæ³¨æ–¼å€‹äººé›»è…¦å’Œé¡¯ç¤ºå™¨'
                    }
                ],
                'finance': [
                    {
                        name: 'åœ‹æ³°ä¸–è¯éŠ€è¡Œ',
                        website: 'https://www.cathaybk.com.tw',
                        linkedin: 'https://www.linkedin.com/company/cathay-bank',
                        description: 'å°ç£æœ€å¤§çš„æ°‘ç‡ŸéŠ€è¡Œï¼Œæä¾›å…¨æ–¹ä½çš„é‡‘èæœå‹™'
                    },
                    {
                        name: 'ä¸­åœ‹ä¿¡è¨—å•†æ¥­éŠ€è¡Œ',
                        website: 'https://www.ctbcbank.com',
                        linkedin: 'https://www.linkedin.com/company/ctbc-bank',
                        description: 'å°ç£é ˜å…ˆçš„æ°‘ç‡ŸéŠ€è¡Œï¼Œå°ˆæ³¨æ–¼æ¶ˆè²»é‡‘èå’Œä¼æ¥­é‡‘è'
                    },
                    {
                        name: 'å¯Œé‚¦é‡‘æ§',
                        website: 'https://www.fubon.com',
                        linkedin: 'https://www.linkedin.com/company/fubon-financial',
                        description: 'å°ç£æœ€å¤§çš„æ°‘ç‡Ÿé‡‘æ§å…¬å¸ï¼Œæä¾›å¤šå…ƒåŒ–çš„é‡‘èæœå‹™'
                    }
                ],
                'healthcare': [
                    {
                        name: 'é•·åºšé†«ç™‚è²¡åœ˜æ³•äºº',
                        website: 'https://www.cgmh.org.tw',
                        linkedin: 'https://www.linkedin.com/company/chang-gung-memorial-hospital',
                        description: 'å°ç£æœ€å¤§çš„é†«ç™‚é«”ç³»ï¼Œæä¾›å…¨æ–¹ä½çš„é†«ç™‚æœå‹™'
                    },
                    {
                        name: 'å°å¤§é†«é™¢',
                        website: 'https://www.ntuh.gov.tw',
                        linkedin: 'https://www.linkedin.com/company/national-taiwan-university-hospital',
                        description: 'å°ç£æœ€å…·æ¬Šå¨çš„é†«å­¸ä¸­å¿ƒï¼Œå°ˆæ³¨æ–¼é†«å­¸ç ”ç©¶å’Œæ•™å­¸'
                    },
                    {
                        name: 'å¥‡ç¾é†«é™¢',
                        website: 'https://www.chimei.org.tw',
                        linkedin: 'https://www.linkedin.com/company/chimei-medical-center',
                        description: 'å—å°ç£é‡è¦çš„é†«å­¸ä¸­å¿ƒï¼Œå°ˆæ³¨æ–¼æ€¥é‡ç—‡é†«ç™‚'
                    }
                ],
                'retail': [
                    {
                        name: 'çµ±ä¸€è¶…å•†',
                        website: 'https://www.7-11.com.tw',
                        linkedin: 'https://www.linkedin.com/company/7-eleven-taiwan',
                        description: 'å°ç£æœ€å¤§çš„ä¾¿åˆ©å•†åº—é€£é–ï¼Œæä¾›ä¾¿åˆ©çš„é›¶å”®æœå‹™'
                    },
                    {
                        name: 'å…¨å®¶ä¾¿åˆ©å•†åº—',
                        website: 'https://www.family.com.tw',
                        linkedin: 'https://www.linkedin.com/company/family-mart-taiwan',
                        description: 'å°ç£ç¬¬äºŒå¤§ä¾¿åˆ©å•†åº—é€£é–ï¼Œå°ˆæ³¨æ–¼ç¤¾å€æœå‹™'
                    },
                    {
                        name: 'å®¶æ¨‚ç¦',
                        website: 'https://www.carrefour.com.tw',
                        linkedin: 'https://www.linkedin.com/company/carrefour-taiwan',
                        description: 'æ³•åœ‹å¤§å‹é›¶å”®é›†åœ˜ï¼Œåœ¨å°ç£æä¾›å¤§è³£å ´æœå‹™'
                    }
                ],
                'manufacturing': [
                    {
                        name: 'å°å¡‘ä¼æ¥­',
                        website: 'https://www.fpg.com.tw',
                        linkedin: 'https://www.linkedin.com/company/formosa-plastics-group',
                        description: 'å°ç£æœ€å¤§çš„æ°‘ç‡Ÿè£½é€ æ¥­é›†åœ˜ï¼Œå°ˆæ³¨æ–¼çŸ³åŒ–ç”¢æ¥­'
                    },
                    {
                        name: 'ä¸­é‹¼å…¬å¸',
                        website: 'https://www.csc.com.tw',
                        linkedin: 'https://www.linkedin.com/company/china-steel-corporation',
                        description: 'å°ç£æœ€å¤§çš„é‹¼éµè£½é€ å•†ï¼Œæä¾›å„ç¨®é‹¼éµç”¢å“'
                    },
                    {
                        name: 'è£•éš†æ±½è»Š',
                        website: 'https://www.yulon-motor.com.tw',
                        linkedin: 'https://www.linkedin.com/company/yulon-motor',
                        description: 'å°ç£é‡è¦çš„æ±½è»Šè£½é€ å•†ï¼Œå°ˆæ³¨æ–¼æ±½è»Šç ”ç™¼å’Œè£½é€ '
                    }
                ]
            };
            
            return industryMap[industry] || industryMap['technology'];
        }

        // åˆ†æç«¶çˆ­å°æ‰‹å¼·åº¦
        function analyzeCompetitorStrength(competitor, products, industry) {
            try {
                // åŸºæ–¼ç”¢å“ç›¸ä¼¼åº¦å’Œè¡Œæ¥­åœ°ä½é€²è¡Œåˆ†æ
                const productSimilarity = calculateProductSimilarity(products, competitor);
                const industryPosition = getIndustryPosition(competitor.name, industry);
                
                return {
                    marketShare: industryPosition.marketShare,
                    strength: Math.min(100, industryPosition.strength + productSimilarity.score * 20),
                    weakness: Math.max(20, 100 - industryPosition.strength - productSimilarity.score * 15),
                    opportunity: Math.min(100, 80 - industryPosition.marketShare + productSimilarity.opportunity * 30),
                    threat: Math.min(100, industryPosition.marketShare + (100 - productSimilarity.score) * 0.5),
                    productComparison: productSimilarity.details
                };
            } catch (error) {
                console.error('åˆ†æç«¶çˆ­å°æ‰‹å¼·åº¦å¤±æ•—:', error);
                // è¿”å›é è¨­å€¼
                return {
                    marketShare: 10 + Math.floor(Math.random() * 20),
                    strength: 50 + Math.floor(Math.random() * 30),
                    weakness: 30 + Math.floor(Math.random() * 40),
                    opportunity: 40 + Math.floor(Math.random() * 40),
                    threat: 30 + Math.floor(Math.random() * 40),
                    productComparison: 'éœ€è¦é€²ä¸€æ­¥åˆ†æ'
                };
            }
        }

        // è¨ˆç®—ç”¢å“ç›¸ä¼¼åº¦
        function calculateProductSimilarity(products, competitor) {
            try {
                if (!products || products.length === 0) {
                    return { score: 0.5, opportunity: 0.5, details: 'ç„¡æ³•æ¯”è¼ƒç”¢å“ç›¸ä¼¼åº¦' };
                }
                
                let totalScore = 0;
                let totalOpportunity = 0;
                const details = [];
                
                products.forEach(product => {
                    try {
                        const similarity = analyzeProductSimilarity(product, competitor);
                        totalScore += similarity.score;
                        totalOpportunity += similarity.opportunity;
                        details.push(`${product.name || product}: ${similarity.description}`);
                    } catch (error) {
                        console.error('åˆ†æç”¢å“ç›¸ä¼¼åº¦å¤±æ•—:', error);
                        totalScore += 0.5;
                        totalOpportunity += 0.5;
                        details.push(`${product.name || product}: ç›¸ä¼¼åº¦åˆ†æå¤±æ•—`);
                    }
                });
                
                return {
                    score: totalScore / products.length,
                    opportunity: totalOpportunity / products.length,
                    details: details.join('; ')
                };
            } catch (error) {
                console.error('è¨ˆç®—ç”¢å“ç›¸ä¼¼åº¦å¤±æ•—:', error);
                return { score: 0.5, opportunity: 0.5, details: 'ç›¸ä¼¼åº¦è¨ˆç®—å¤±æ•—' };
            }
        }

        // åˆ†æå–®ä¸€ç”¢å“ç›¸ä¼¼åº¦
        function analyzeProductSimilarity(product, competitor) {
            try {
                const productName = (product.name || product || '').toLowerCase();
                const competitorName = (competitor.name || '').toLowerCase();
                const competitorDesc = (competitor.description || '').toLowerCase();
                
                // ç°¡å–®çš„é—œéµå­—åŒ¹é…åˆ†æ
                const keywords = productName.split(' ').filter(k => k.length > 0);
                let matchCount = 0;
                
                if (keywords.length === 0) {
                    return {
                        score: 0.5,
                        opportunity: 0.5,
                        description: `ç›¸ä¼¼åº¦: 50%, æ©Ÿæœƒ: 50%`
                    };
                }
                
                keywords.forEach(keyword => {
                    if (competitorName.includes(keyword) || competitorDesc.includes(keyword)) {
                        matchCount++;
                    }
                });
                
                const score = Math.min(1, matchCount / keywords.length);
                const opportunity = 1 - score; // ç›¸ä¼¼åº¦è¶Šä½ï¼Œæ©Ÿæœƒè¶Šå¤§
                
                return {
                    score: score,
                    opportunity: opportunity,
                    description: `ç›¸ä¼¼åº¦: ${Math.round(score * 100)}%, æ©Ÿæœƒ: ${Math.round(opportunity * 100)}%`
                };
            } catch (error) {
                console.error('åˆ†æå–®ä¸€ç”¢å“ç›¸ä¼¼åº¦å¤±æ•—:', error);
                return {
                    score: 0.5,
                    opportunity: 0.5,
                    description: `ç›¸ä¼¼åº¦: 50%, æ©Ÿæœƒ: 50%`
                };
            }
        }

        // ç²å–è¡Œæ¥­åœ°ä½
        function getIndustryPosition(competitorName, industry) {
            const positions = {
                'é´»æµ·ç²¾å¯†å·¥æ¥­': { marketShare: 25, strength: 90 },
                'å°ç©é›»': { marketShare: 55, strength: 95 },
                'è¯ç™¼ç§‘æŠ€': { marketShare: 35, strength: 85 },
                'è¯ç¢©é›»è…¦': { marketShare: 15, strength: 80 },
                'å®ç¢': { marketShare: 12, strength: 75 },
                'åœ‹æ³°ä¸–è¯éŠ€è¡Œ': { marketShare: 18, strength: 85 },
                'ä¸­åœ‹ä¿¡è¨—å•†æ¥­éŠ€è¡Œ': { marketShare: 15, strength: 80 },
                'å¯Œé‚¦é‡‘æ§': { marketShare: 20, strength: 88 },
                'é•·åºšé†«ç™‚è²¡åœ˜æ³•äºº': { marketShare: 22, strength: 90 },
                'å°å¤§é†«é™¢': { marketShare: 18, strength: 95 },
                'å¥‡ç¾é†«é™¢': { marketShare: 12, strength: 85 },
                'çµ±ä¸€è¶…å•†': { marketShare: 45, strength: 90 },
                'å…¨å®¶ä¾¿åˆ©å•†åº—': { marketShare: 25, strength: 85 },
                'å®¶æ¨‚ç¦': { marketShare: 15, strength: 80 },
                'å°å¡‘ä¼æ¥­': { marketShare: 30, strength: 88 },
                'ä¸­é‹¼å…¬å¸': { marketShare: 40, strength: 85 },
                'è£•éš†æ±½è»Š': { marketShare: 8, strength: 75 }
            };
            
            return positions[competitorName] || { marketShare: 10, strength: 70 };
        }

        // ç”Ÿæˆæ¨¡æ“¬ç«¶çˆ­å°æ‰‹è³‡æ–™
        function generateMockCompetitors(topic, brandName) {
            const competitors = [];
            const competitorCount = state.analysisData.competitorCount || 10;
            
            // æ ¹æ“šä¸»é¡Œç”Ÿæˆç›¸é—œçš„ç«¶çˆ­å°æ‰‹
            const baseNames = [
                'TechCorp', 'InnovateLab', 'DigitalFlow', 'SmartSolutions', 'FutureTech',
                'CloudWorks', 'DataDrive', 'NextGen', 'PrimeTech', 'EliteSystems',
                'GlobalTech', 'PeakSolutions', 'CoreTech', 'AdvanceWorks', 'MasterTech'
            ];
            
            for (let i = 0; i < competitorCount; i++) {
                const baseName = baseNames[i % baseNames.length];
                const competitor = {
                    id: `comp_${i + 1}`,
                    name: `${baseName} ${i + 1}`,
                    website: `https://www.${baseName.toLowerCase()}${i + 1}.com`,
                    description: `${topic} ç›¸é—œçš„å°ˆæ¥­æœå‹™æä¾›å•†`,
                    industry: state.analysisData.industry?.category || 'technology',
                    marketShare: Math.floor(Math.random() * 30) + 5,
                    strength: Math.floor(Math.random() * 100) + 20,
                    weakness: Math.floor(Math.random() * 100) + 20,
                    opportunity: Math.floor(Math.random() * 100) + 20,
                    threat: Math.floor(Math.random() * 100) + 20,
                    selected: false
                };
                competitors.push(competitor);
            }
            
            return competitors;
        }

        // é¡¯ç¤ºæœå°‹çµæœ
        function displaySearchResults(competitors) {
            try {
                const resultsContainer = document.getElementById('auto-search-results');
                if (!resultsContainer) return;

                if (competitors.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-gray-400">æœªæ‰¾åˆ°ç›¸é—œç«¶çˆ­å°æ‰‹</p>';
                    return;
                }

                let html = '';
                competitors.forEach(competitor => {
                    html += `
                        <div class="competitor-item bg-gray-800 rounded-lg p-4 border border-gray-700">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="comp_${competitor.id}" class="competitor-checkbox" data-competitor='${JSON.stringify(competitor)}'>
                                    <h5 class="font-semibold text-gray-200">${competitor.name}</h5>
                                    <div class="flex gap-2">
                                        <a href="${competitor.website}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">å®˜ç¶²</a>
                                        ${competitor.linkedin ? `<a href="${competitor.linkedin}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">LinkedIn</a>` : ''}
                                    </div>
                                </div>
                                <div class="text-sm text-gray-400">
                                    å¸‚å ´ä»½é¡: ${competitor.marketShare}%
                                </div>
                            </div>
                            <p class="text-gray-300 text-sm mb-3">${competitor.description}</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs mb-3">
                                <div class="bg-green-900/20 p-2 rounded">
                                    <span class="text-green-400">å„ªå‹¢: ${competitor.strength}</span>
                                </div>
                                <div class="bg-red-900/20 p-2 rounded">
                                    <span class="text-red-400">åŠ£å‹¢: ${competitor.weakness}</span>
                                </div>
                                <div class="bg-blue-900/20 p-2 rounded">
                                    <span class="text-blue-400">æ©Ÿæœƒ: ${competitor.opportunity}</span>
                                </div>
                                <div class="bg-yellow-900/20 p-2 rounded">
                                    <span class="text-yellow-400">å¨è„…: ${competitor.threat}</span>
                                </div>
                            </div>
                            ${competitor.productComparison ? `<p class="text-gray-400 text-xs">ç”¢å“åˆ†æ: ${competitor.productComparison}</p>` : ''}
                        </div>
                    `;
                });

                resultsContainer.innerHTML = html;

                // ç¶å®šé¸æ“‡äº‹ä»¶
                const checkboxes = resultsContainer.querySelectorAll('.competitor-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const competitor = JSON.parse(this.dataset.competitor);
                        if (this.checked) {
                            addCompetitor(competitor);
                        } else {
                            removeCompetitor(competitor.id);
                        }
                    });
                });

            } catch (error) {
                console.error('é¡¯ç¤ºæœå°‹çµæœå¤±æ•—:', error);
            }
        }

        // æ·»åŠ ç«¶çˆ­å°æ‰‹
        function addCompetitor(competitor) {
            try {
                if (!state.analysisData.selectedCompetitors) {
                    state.analysisData.selectedCompetitors = [];
                }
                
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const exists = state.analysisData.selectedCompetitors.find(c => c.id === competitor.id);
                if (!exists) {
                    state.analysisData.selectedCompetitors.push(competitor);
                    updateSelectedCompetitorsDisplay();
                    updateGenerateReportButton();
                }
                
            } catch (error) {
                console.error('æ·»åŠ ç«¶çˆ­å°æ‰‹å¤±æ•—:', error);
            }
        }

        // ç§»é™¤ç«¶çˆ­å°æ‰‹
        function removeCompetitor(competitorId) {
            try {
                if (state.analysisData.selectedCompetitors) {
                    state.analysisData.selectedCompetitors = state.analysisData.selectedCompetitors.filter(c => c.id !== competitorId);
                    updateSelectedCompetitorsDisplay();
                    updateGenerateReportButton();
                }
                
            } catch (error) {
                console.error('ç§»é™¤ç«¶çˆ­å°æ‰‹å¤±æ•—:', error);
            }
        }

        // æ›´æ–°å·²é¸æ“‡ç«¶çˆ­å°æ‰‹é¡¯ç¤º
        function updateSelectedCompetitorsDisplay() {
            try {
                const container = document.getElementById('selected-competitors');
                const countElement = document.getElementById('selected-count');
                
                if (!container || !countElement) return;

                const selectedCompetitors = state.analysisData.selectedCompetitors || [];
                countElement.textContent = selectedCompetitors.length;

                if (selectedCompetitors.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">å°šæœªé¸æ“‡ä»»ä½•ç«¶çˆ­å°æ‰‹</p>';
                    return;
                }

                let html = '';
                selectedCompetitors.forEach(competitor => {
                    const websiteText = competitor.website ? competitor.website.replace(/^https?:\/\//, '') : 'ç„¡ç¶²ç«™';
                    html += `
                        <div class="selected-competitor bg-gray-700 rounded-lg p-3 flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3 flex-1">
                                <span class="font-semibold text-gray-200 min-w-0 flex-1">${competitor.name}</span>
                                ${competitor.website ? `<a href="${competitor.website}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">${websiteText}</a>` : ''}
                                <span class="text-gray-400 text-sm">å¸‚å ´ä»½é¡: ${competitor.marketShare}%</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="editCompetitor('${competitor.id}')" class="text-blue-400 hover:text-blue-300 text-sm px-2 py-1">
                                    âœï¸ ç·¨è¼¯
                                </button>
                                <button onclick="removeCompetitor('${competitor.id}')" class="text-red-400 hover:text-red-300 text-sm px-2 py-1">
                                    âœ• åˆªé™¤
                                </button>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                
            } catch (error) {
                console.error('æ›´æ–°å·²é¸æ“‡ç«¶çˆ­å°æ‰‹é¡¯ç¤ºå¤±æ•—:', error);
            }
        }

        // æ›´æ–°ç”Ÿæˆå ±å‘ŠæŒ‰éˆ•ç‹€æ…‹
        function updateGenerateReportButton() {
            try {
                const generateBtn = document.getElementById('generate-report-btn');
                if (!generateBtn) return;

                const selectedCompetitors = state.analysisData.selectedCompetitors || [];
                
                if (selectedCompetitors.length > 0) {
                    generateBtn.disabled = false;
                    generateBtn.textContent = `ç”Ÿæˆå®Œæ•´å ±å‘Š (${selectedCompetitors.length} å€‹ç«¶çˆ­å°æ‰‹)`;
                } else {
                    generateBtn.disabled = true;
                    generateBtn.textContent = 'ç”Ÿæˆå®Œæ•´å ±å‘Š';
                }
                
            } catch (error) {
                console.error('æ›´æ–°ç”Ÿæˆå ±å‘ŠæŒ‰éˆ•ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºå®Œæ•´å ±å‘Š
        function displayFinalReport() {
            try {
                const reportContainer = document.getElementById('final-report-content');
                if (!reportContainer) return;

                const selectedCompetitors = state.analysisData.selectedCompetitors || [];
                
                if (selectedCompetitors.length === 0) {
                    reportContainer.innerHTML = '<p class="text-gray-400">è«‹å…ˆå®Œæˆæ­¥é©Ÿ 2 çš„å°æ‰‹ç¯©é¸</p>';
                    return;
                }

                // ç”Ÿæˆå ±å‘Šå…§å®¹
                const report = generateFinalReport(selectedCompetitors);
                reportContainer.innerHTML = report;
                
            } catch (error) {
                console.error('é¡¯ç¤ºå®Œæ•´å ±å‘Šå¤±æ•—:', error);
            }
        }

        // ç”Ÿæˆå®Œæ•´å ±å‘Š
        function generateFinalReport(competitors) {
            const brand = state.analysisData.brand?.name || 'æœªæŒ‡å®š';
            const topic = state.analysisData.topic || 'æœªæŒ‡å®š';
            const industry = state.analysisData.industry?.category || 'æœªæŒ‡å®š';
            const keywords = state.analysisData.keywords || {};
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ™ºèƒ½åˆ†æçµæœ
            const smartAnalysis = state.analysisData.smartCompetitorAnalysis;
            const isSmartAnalysis = smartAnalysis && smartAnalysis.marketInsights;
            
            return `
                <div class="space-y-6">
                    <!-- ç«¶çˆ­å°æ‰‹åˆ†æå ±å‘Š -->
                    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                        <h3 class="text-xl font-semibold text-techaccent mb-4">
                            ğŸ“Š ${brand} - ${topic} ç«¶çˆ­å°æ‰‹åˆ†æå ±å‘Š
                            ${isSmartAnalysis ? '<span class="text-green-400 text-sm ml-2">ğŸ¤– AI æ™ºèƒ½åˆ†æ</span>' : '<span class="text-yellow-400 text-sm ml-2">ğŸ“‹ æ¨¡æ¿åˆ†æ</span>'}
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">ğŸ“ˆ åˆ†ææ¦‚æ³</h4>
                                <p class="text-gray-300 text-sm">åˆ†æäº† ${competitors.length} å€‹ç«¶çˆ­å°æ‰‹</p>
                                <p class="text-gray-300 text-sm">åˆ†æä¸»é¡Œ: ${topic}</p>
                                <p class="text-gray-300 text-sm">æ‰€å±¬ç”¢æ¥­: ${industry}</p>
                                <p class="text-gray-300 text-sm">ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}</p>
                                <p class="text-gray-300 text-sm">åˆ†ææ–¹å¼: ${isSmartAnalysis ? 'Google Search API + Gemini AI' : 'éœæ…‹æ¨¡æ¿'}</p>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">ğŸ¯ ç«¶çˆ­å°æ‰‹æ¸…å–®</h4>
                                <div class="space-y-2">
                                    ${competitors.map(comp => `
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-300 text-sm">${comp.name}</span>
                                            <span class="text-blue-400 text-sm">${comp.marketShare}%</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        ${isSmartAnalysis ? `
                        <!-- AI æ™ºèƒ½åˆ†æçµæœ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-200 mb-3">ğŸ§  AI å¸‚å ´æ´å¯Ÿ</h4>
                                <div class="space-y-2">
                                    ${smartAnalysis.marketInsights.map(insight => `
                                        <p class="text-gray-300 text-sm">â€¢ ${insight}</p>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-200 mb-3">ğŸ’¡ ç«¶çˆ­å„ªå‹¢</h4>
                                <div class="space-y-2">
                                    ${smartAnalysis.competitiveAdvantages.map(advantage => `
                                        <p class="text-gray-300 text-sm">â€¢ ${advantage}</p>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-200 mb-3">âš ï¸ æ½›åœ¨å¨è„…</h4>
                                <div class="space-y-2">
                                    ${smartAnalysis.threats.map(threat => `
                                        <p class="text-gray-300 text-sm">â€¢ ${threat}</p>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-200 mb-3">ğŸ¯ AI ç­–ç•¥å»ºè­°</h4>
                                <div class="space-y-2">
                                    ${smartAnalysis.recommendations.map(recommendation => `
                                        <p class="text-gray-300 text-sm">â€¢ ${recommendation}</p>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">ğŸ” æœå°‹è³‡æ–™æ‘˜è¦</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-400">ç™¼ç¾å…¬å¸:</span>
                                    <span class="text-gray-300 ml-2">${smartAnalysis.searchData.companies.length} å€‹</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">ç›¸é—œç¶²ç«™:</span>
                                    <span class="text-gray-300 ml-2">${smartAnalysis.searchData.websites.length} å€‹</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">é—œéµå­—:</span>
                                    <span class="text-gray-300 ml-2">${smartAnalysis.searchData.keywords.length} å€‹</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">å¸‚å ´æŒ‡æ¨™:</span>
                                    <span class="text-gray-300 ml-2">${smartAnalysis.searchData.marketIndicators.length} å€‹</span>
                                </div>
                            </div>
                        </div>
                        ` : `
                        <div class="bg-gray-700 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-200 mb-3">ğŸ“‹ è©³ç´°åˆ†æ</h4>
                            <p class="text-gray-300 text-sm">å®Œæ•´åˆ†æå ±å‘Šå·²æº–å‚™å°±ç·’ï¼Œè«‹ä½¿ç”¨ä¸‹æ–¹çš„é—œéµå­—å’Œæ–‡æ¡ˆç”¢å‡ºå·¥å…·ã€‚</p>
                            <p class="text-gray-400 text-sm mt-2">ğŸ’¡ æç¤ºï¼šè¨­å®š Google API Keyã€Search Engine ID å’Œ Gemini API Key å¯å•Ÿç”¨ AI æ™ºèƒ½åˆ†æåŠŸèƒ½</p>
                        </div>
                        `}
                    </div>

                    <!-- é—œéµå­—å»ºè­°æ¸…å–® -->
                    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                        <h3 class="text-xl font-semibold text-techaccent mb-4">ğŸ” é—œéµå­—å»ºè­°æ¸…å–®</h3>
                        
                        <!-- å•†æ¥­æ¨¡å¼é¸æ“‡ -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">ğŸ“Š å•†æ¥­æ¨¡å¼é¸æ“‡</h4>
                            <select id="business-model-select-step3" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                                <option value="">è«‹é¸æ“‡å•†æ¥­æ¨¡å¼</option>
                                <option value="b2b">B2B (ä¼æ¥­å°ä¼æ¥­)</option>
                                <option value="b2c">B2C (ä¼æ¥­å°æ¶ˆè²»è€…)</option>
                                <option value="b2b2c">B2B2C (ä¼æ¥­å°ä¼æ¥­å°æ¶ˆè²»è€…)</option>
                                <option value="c2c">C2C (æ¶ˆè²»è€…å°æ¶ˆè²»è€…)</option>
                                <option value="saas">SaaS (è»Ÿé«”å³æœå‹™)</option>
                                <option value="marketplace">Marketplace (å¹³å°æ¨¡å¼)</option>
                                <option value="subscription">Subscription (è¨‚é–±æ¨¡å¼)</option>
                                <option value="freemium">Freemium (å…è²»å¢å€¼)</option>
                                <option value="ecommerce">E-commerce (é›»å•†)</option>
                                <option value="agency">Agency (ä»£ç†/æœå‹™)</option>
                            </select>
                        </div>

                        <!-- é—œéµå­—é¡å‹é¸æ“‡ -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">ğŸ¯ é—œéµå­—é¡å‹é¸æ“‡</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-primary" class="form-checkbox mr-2">
                                    <span class="text-gray-300">ä¸»è¦é—œéµå­—</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-longtail" class="form-checkbox mr-2">
                                    <span class="text-gray-300">é•·å°¾é—œéµå­—</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-commercial" class="form-checkbox mr-2">
                                    <span class="text-gray-300">å•†æ¥­æ„åœ–</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-informational" class="form-checkbox mr-2">
                                    <span class="text-gray-300">è³‡è¨ŠæŸ¥è©¢</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-navigational" class="form-checkbox mr-2">
                                    <span class="text-gray-300">å°èˆªæŸ¥è©¢</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-transactional" class="form-checkbox mr-2">
                                    <span class="text-gray-300">äº¤æ˜“æ„åœ–</span>
                                </label>
                            </div>
                        </div>

                        <!-- é—œéµå­—å…§å®¹é¡¯ç¤º -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">ğŸ“ é—œéµå­—å…§å®¹</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">ä¸»è¦é—œéµå­—</label>
                                    <textarea id="primary-keywords-step3" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="4" placeholder="ä¸»è¦é—œéµå­—ï¼Œæ¯è¡Œä¸€å€‹" readonly>${(keywords.primary || []).join('\n')}</textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">é•·å°¾é—œéµå­—</label>
                                    <textarea id="long-tail-keywords-step3" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="4" placeholder="é•·å°¾é—œéµå­—ï¼Œæ¯è¡Œä¸€å€‹" readonly>${(keywords.longTail || []).join('\n')}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div class="flex gap-4 flex-wrap">
                            <button onclick="performSmartKeywordSearch()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                                ğŸ” æ™ºèƒ½æœå°‹é—œéµå­—
                            </button>
                            <button onclick="generateKeywordSuggestions()" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">
                                ğŸ“‹ ç”Ÿæˆå®Œæ•´é—œéµå­—å»ºè­°æ›¸
                            </button>
                        </div>
                    </div>

                    <!-- æ™ºèƒ½é—œéµå­—å»ºè­°æ›¸ -->
                    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                        <h3 class="text-xl font-semibold text-techaccent mb-4">ğŸ“Š æ™ºèƒ½é—œéµå­—å»ºè­°æ›¸</h3>
                        
                        <!-- SEOåˆ†é¡è¦å‰‡ -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">ğŸ·ï¸ SEOåˆ†é¡è¦å‰‡</h4>
                            <div id="seo-categories-display" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-gray-700 rounded-lg p-3">
                                    <h5 class="font-semibold text-gray-200 mb-2">ä¸»è¦é—œéµå­— (Head Terms)</h5>
                                    <p class="text-gray-300 text-sm">æœå°‹é‡å¤§ï¼Œç«¶çˆ­åº¦é«˜ï¼Œé©åˆå“ç‰Œå»ºç«‹</p>
                                </div>
                                <div class="bg-gray-700 rounded-lg p-3">
                                    <h5 class="font-semibold text-gray-200 mb-2">é•·å°¾é—œéµå­— (Long Tail)</h5>
                                    <p class="text-gray-300 text-sm">æœå°‹é‡å°ï¼Œç«¶çˆ­åº¦ä½ï¼Œè½‰æ›ç‡é«˜</p>
                                </div>
                                <div class="bg-gray-700 rounded-lg p-3">
                                    <h5 class="font-semibold text-gray-200 mb-2">å“ç‰Œé—œéµå­— (Branded)</h5>
                                    <p class="text-gray-300 text-sm">å“ç‰Œç›¸é—œæœå°‹ï¼Œé«˜è½‰æ›ç‡</p>
                                </div>
                                <div class="bg-gray-700 rounded-lg p-3">
                                    <h5 class="font-semibold text-gray-200 mb-2">ç”¢å“é—œéµå­— (Product)</h5>
                                    <p class="text-gray-300 text-sm">å…·é«”ç”¢å“æœå°‹ï¼Œå•†æ¥­æ„åœ–å¼·</p>
                                </div>
                            </div>
                        </div>

                        <!-- å‡ºåƒ¹ç­–ç•¥ -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">ğŸ’° å‡ºåƒ¹ç­–ç•¥å»ºè­°</h4>
                            <div id="bidding-strategy-display" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-green-900/20 rounded-lg p-3 border border-green-500/20">
                                    <h5 class="font-semibold text-green-400 mb-2">é«˜æœå°‹é‡é«˜ç«¶çˆ­åº¦</h5>
                                    <p class="text-gray-300 text-sm">å»ºè­°å‡ºåƒ¹ NT$ 25-40ï¼Œå°ˆæ³¨æ–¼é«˜è½‰æ›ç‡</p>
                                </div>
                                <div class="bg-blue-900/20 rounded-lg p-3 border border-blue-500/20">
                                    <h5 class="font-semibold text-blue-400 mb-2">é«˜æœå°‹é‡ä½ç«¶çˆ­åº¦</h5>
                                    <p class="text-gray-300 text-sm">å»ºè­°å‡ºåƒ¹ NT$ 15-25ï¼Œæ“´å¤§å¸‚å ´ä»½é¡</p>
                                </div>
                                <div class="bg-yellow-900/20 rounded-lg p-3 border border-yellow-500/20">
                                    <h5 class="font-semibold text-yellow-400 mb-2">ä½æœå°‹é‡é«˜ç«¶çˆ­åº¦</h5>
                                    <p class="text-gray-300 text-sm">å»ºè­°å‡ºåƒ¹ NT$ 8-15ï¼Œç²¾æº–å®šä½</p>
                                </div>
                                <div class="bg-purple-900/20 rounded-lg p-3 border border-purple-500/20">
                                    <h5 class="font-semibold text-purple-400 mb-2">ä½æœå°‹é‡ä½ç«¶çˆ­åº¦</h5>
                                    <p class="text-gray-300 text-sm">å»ºè­°å‡ºåƒ¹ NT$ 5-12ï¼Œä½æˆæœ¬æ¸¬è©¦</p>
                                </div>
                            </div>
                        </div>

                        <!-- å¸‚å ´æ´å¯Ÿ -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">ğŸ“ˆ å¸‚å ´æ´å¯Ÿ</h4>
                            <div id="market-insights-display" class="bg-gray-700 rounded-lg p-4">
                                <p class="text-gray-300 text-sm">æ™ºèƒ½åˆ†æå®Œæˆå¾Œå°‡é¡¯ç¤ºå¸‚å ´æ´å¯Ÿ</p>
                            </div>
                        </div>

                        <!-- èªè¨€ç‰ˆæœ¬å°æ‡‰ -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">ğŸŒ èªè¨€ç‰ˆæœ¬å°æ‡‰</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-gray-700 rounded-lg p-3 text-center">
                                    <h5 class="font-semibold text-gray-200 mb-1">ç¹é«”ä¸­æ–‡</h5>
                                    <p class="text-gray-300 text-sm">å°ç£å¸‚å ´</p>
                                </div>
                                <div class="bg-gray-700 rounded-lg p-3 text-center">
                                    <h5 class="font-semibold text-gray-200 mb-1">English</h5>
                                    <p class="text-gray-300 text-sm">åœ‹éš›å¸‚å ´</p>
                                </div>
                                <div class="bg-gray-700 rounded-lg p-3 text-center">
                                    <h5 class="font-semibold text-gray-200 mb-1">æ—¥æœ¬èª</h5>
                                    <p class="text-gray-300 text-sm">æ—¥æœ¬å¸‚å ´</p>
                                </div>
                                <div class="bg-gray-700 rounded-lg p-3 text-center">
                                    <h5 class="font-semibold text-gray-200 mb-1">í•œêµ­ì–´</h5>
                                    <p class="text-gray-300 text-sm">éŸ“åœ‹å¸‚å ´</p>
                                </div>
                            </div>
                        </div>

                        <!-- ä¸‹è¼‰æŒ‰éˆ• -->
                        <div class="flex gap-4">
                            <button onclick="downloadKeywordReport()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                                ğŸ’¾ ä¸‹è¼‰å®Œæ•´é—œéµå­—å»ºè­°æ›¸
                            </button>
                            <button onclick="downloadKeywordCSV()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                ğŸ“Š ä¸‹è¼‰é—œéµå­— CSV
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ‰‹å‹•æ·»åŠ ç«¶çˆ­å°æ‰‹
        function addManualCompetitor() {
            try {
                const input = document.getElementById('manual-competitor');
                const competitorNames = input?.value?.trim();
                
                if (!competitorNames) {
                    showAlert('è«‹è¼¸å…¥ç«¶çˆ­å°æ‰‹åç¨±', 'ç«¶çˆ­å°æ‰‹åç¨±ä¸èƒ½ç‚ºç©º', 'warning');
                    return;
                }

                // åˆ†å‰²é€—è™Ÿåˆ†éš”çš„ç«¶çˆ­å°æ‰‹åç¨±
                const competitors = competitorNames.split(',').map(name => name.trim()).filter(name => name.length > 0);
                
                if (competitors.length === 0) {
                    showAlert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç«¶çˆ­å°æ‰‹åç¨±', 'ç«¶çˆ­å°æ‰‹åç¨±ä¸èƒ½ç‚ºç©º', 'warning');
                    return;
                }

                // åˆå§‹åŒ–é¸æ“‡æ¸…å–®
                if (!state.analysisData.selectedCompetitors) {
                    state.analysisData.selectedCompetitors = [];
                }

                let addedCount = 0;
                let skippedCount = 0;

                competitors.forEach((competitorName, index) => {
                    // ç‚ºæ‰‹å‹•æ·»åŠ çš„ç«¶çˆ­å°æ‰‹å‰µå»ºå”¯ä¸€ID
                    const manualId = `manual_${Date.now()}_${index}`;
                    
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“é¸æ“‡ï¼ˆåŸºæ–¼åç¨±ï¼‰
                    const exists = state.analysisData.selectedCompetitors.find(c => c.name === competitorName);
                    if (exists) {
                        skippedCount++;
                        return;
                    }

                    // å‰µå»ºç«¶çˆ­å°æ‰‹ç‰©ä»¶
                    const competitor = {
                        id: manualId,
                        name: competitorName,
                        website: `https://www.google.com/search?q=${encodeURIComponent(competitorName)}`,
                        linkedin: null,
                        description: `${competitorName} - æ‰‹å‹•æ·»åŠ çš„ç«¶çˆ­å°æ‰‹`,
                        industry: state.analysisData.industry?.category || 'other',
                        marketShare: Math.floor(Math.random() * 20) + 5, // éš¨æ©Ÿå¸‚å ´ä»½é¡
                        strength: Math.floor(Math.random() * 60) + 40,
                        weakness: Math.floor(Math.random() * 60) + 40,
                        opportunity: Math.floor(Math.random() * 60) + 40,
                        threat: Math.floor(Math.random() * 60) + 40,
                        productComparison: 'æ‰‹å‹•æ·»åŠ ï¼Œéœ€è¦é€²ä¸€æ­¥åˆ†æ',
                        selected: true
                    };

                    // æ·»åŠ åˆ°é¸æ“‡æ¸…å–®
                    state.analysisData.selectedCompetitors.push(competitor);
                    addedCount++;
                });
                
                // æ›´æ–°é¡¯ç¤º
                updateSelectedCompetitorsDisplay();
                
                // æ¸…ç©ºè¼¸å…¥æ¡†
                input.value = '';
                
                // é¡¯ç¤ºçµæœ
                if (addedCount > 0) {
                    const message = skippedCount > 0 
                        ? `å·²æ·»åŠ  ${addedCount} å€‹ç«¶çˆ­å°æ‰‹ï¼Œè·³é ${skippedCount} å€‹é‡è¤‡é …ç›®`
                        : `å·²æ·»åŠ  ${addedCount} å€‹ç«¶çˆ­å°æ‰‹`;
                    showAlert('æ·»åŠ æˆåŠŸ', message, 'success');
                } else {
                    showAlert('æ²’æœ‰æ–°å¢', 'æ‰€æœ‰ç«¶çˆ­å°æ‰‹éƒ½å·²å­˜åœ¨æ–¼é¸æ“‡æ¸…å–®ä¸­', 'warning');
                }
                
            } catch (error) {
                console.error('æ‰‹å‹•æ·»åŠ ç«¶çˆ­å°æ‰‹å¤±æ•—:', error);
                showAlert('æ·»åŠ å¤±æ•—', 'ç„¡æ³•æ·»åŠ ç«¶çˆ­å°æ‰‹', 'error');
            }
        }

        // è¨­å®šæ­¥é©Ÿ 1 çš„äº‹ä»¶ç›£è½å™¨
        function setupStep1EventListeners() {
            try {
                // æ·»åŠ ç”¢å“æŒ‰éˆ•
                const addProductBtn = document.getElementById('add-product-btn');
                if (addProductBtn) {
                    addProductBtn.addEventListener('click', function() {
                        const productsContainer = document.getElementById('products-container');
                        if (productsContainer) {
                            const productItem = document.createElement('div');
                            productItem.className = 'product-item bg-gray-800 rounded-lg p-4 mb-3';
                            productItem.innerHTML = `
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">ç”¢å“/æœå‹™åç¨±</label>
                                        <input type="text" class="product-name w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="ä¸»è¦ç”¢å“åç¨±">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">åƒ¹æ ¼å®šä½</label>
                                        <select class="product-pricing w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                                            <option value="">é¸æ“‡åƒ¹æ ¼å®šä½</option>
                                            <option value="premium">é«˜åƒ¹ä½ (Premium)</option>
                                            <option value="mid-high">ä¸­é«˜åƒ¹ä½</option>
                                            <option value="mid">ä¸­åƒ¹ä½</option>
                                            <option value="mid-low">ä¸­ä½åƒ¹ä½</option>
                                            <option value="budget">å¹³åƒ¹ (Budget)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">ç›®æ¨™å®¢ç¾¤</label>
                                        <input type="text" class="product-target w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="ç›®æ¨™å®¢ç¾¤æè¿°">
                                    </div>
                                </div>
                                <button class="remove-product-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs mt-2">ç§»é™¤</button>
                            `;
                            
                            // æ·»åŠ ç§»é™¤åŠŸèƒ½
                            const removeBtn = productItem.querySelector('.remove-product-btn');
                            removeBtn.addEventListener('click', function() {
                                productItem.remove();
                            });
                            
                            productsContainer.appendChild(productItem);
                        }
                    });
                }

                // é–‹å§‹åˆ†ææŒ‰éˆ•
                const startAnalysisBtn = document.getElementById('start-analysis-btn');
                if (startAnalysisBtn) {
                    startAnalysisBtn.addEventListener('click', startAnalysis);
                }

                // æ‰‹å‹•æ·»åŠ ç«¶çˆ­å°æ‰‹æŒ‰éˆ•
                const addCompetitorBtn = document.getElementById('add-competitor-btn');
                if (addCompetitorBtn) {
                    addCompetitorBtn.addEventListener('click', addManualCompetitor);
                }

                // ç”Ÿæˆå ±å‘ŠæŒ‰éˆ•
                const generateReportBtn = document.getElementById('generate-report-btn');
                if (generateReportBtn) {
                    generateReportBtn.addEventListener('click', generateFinalReport);
                }

                // è¿”å›æ­¥é©Ÿ 1 æŒ‰éˆ•
                const backToStep1Btn = document.getElementById('back-to-step1-btn');
                if (backToStep1Btn) {
                    backToStep1Btn.addEventListener('click', function() {
                        goToStep(1);
                    });
                }

                console.log('æ­¥é©Ÿ 1 äº‹ä»¶ç›£è½å™¨è¨­å®šå®Œæˆ');
            } catch (error) {
                console.error('è¨­å®šæ­¥é©Ÿ 1 äº‹ä»¶ç›£è½å™¨å¤±æ•—:', error);
            }
        }

        // ç”Ÿæˆ Google Ads æ–‡æ¡ˆ
        async function generateAdsCopy() {
            try {
                const businessModel = document.getElementById('business-model-select-step3')?.value;
                const targetAudience = document.getElementById('target-audience-ads')?.value;
                const copyStyle = document.getElementById('copy-style')?.value;
                
                if (!businessModel) {
                    showAlert('è«‹é¸æ“‡å•†æ¥­æ¨¡å¼', 'å•†æ¥­æ¨¡å¼æ˜¯ç”Ÿæˆå»£å‘Šæ–‡æ¡ˆçš„å¿…è¦æ¢ä»¶', 'warning');
                    return;
                }

                const brand = state.analysisData.brand?.name || 'æœªæŒ‡å®š';
                const industry = state.analysisData.industry?.category || 'æœªæŒ‡å®š';

                // ä½¿ç”¨æ™ºèƒ½æ–‡æ¡ˆç”Ÿæˆ
                const smartCopy = await performSmartCopyGeneration(brand, industry, businessModel, targetAudience, copyStyle);
                
                // æ›´æ–°é è¦½å€åŸŸ
                const previewArea = document.getElementById('ads-copy-preview');
                if (previewArea) {
                    const formattedCopy = formatSmartCopyForDisplay(smartCopy, brand, businessModel, targetAudience, copyStyle);
                    previewArea.innerHTML = formattedCopy.replace(/\n/g, '<br>');
                }

                // å„²å­˜ç”Ÿæˆçš„æ–‡æ¡ˆåˆ°ç‹€æ…‹
                state.analysisData.generatedAdsCopy = smartCopy;

                showAlert('æ™ºèƒ½æ–‡æ¡ˆç”ŸæˆæˆåŠŸ', 'ä½¿ç”¨ Google Search API å’Œ AI åˆ†æç”Ÿæˆçš„æ–‡æ¡ˆå·²æº–å‚™å°±ç·’', 'success');
                
            } catch (error) {
                console.error('ç”Ÿæˆ Google Ads æ–‡æ¡ˆå¤±æ•—:', error);
                showAlert('ç”Ÿæˆå¤±æ•—', `ç„¡æ³•ç”Ÿæˆ Google Ads æ–‡æ¡ˆ: ${error.message}`, 'error');
            }
        }

        // æ ¼å¼åŒ–æ™ºèƒ½æ–‡æ¡ˆç”¨æ–¼é¡¯ç¤º
        function formatSmartCopyForDisplay(smartCopy, brand, businessModel, targetAudience, copyStyle) {
            let content = `æ™ºèƒ½ç”Ÿæˆ Google Ads å»£å‘Šæ–‡æ¡ˆ\n`;
            content += `================================\n\n`;
            content += `å“ç‰Œåç¨±: ${brand}\n`;
            content += `å•†æ¥­æ¨¡å¼: ${businessModel}\n`;
            content += `ç›®æ¨™å—çœ¾: ${targetAudience}\n`;
            content += `æ–‡æ¡ˆé¢¨æ ¼: ${copyStyle}\n`;
            content += `ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}\n`;
            content += `ç”Ÿæˆæ–¹å¼: Google Search API + AI æ™ºèƒ½åˆ†æ\n\n`;
            
            content += `æ¨™é¡Œå»ºè­°:\n`;
            smartCopy.headlines.forEach(headline => {
                content += `- ${headline}\n`;
            });
            
            content += `\næè¿°å»ºè­°:\n`;
            smartCopy.descriptions.forEach(desc => {
                content += `- ${desc}\n`;
            });
            
            content += `\nè¡Œå‹•å‘¼ç±²:\n`;
            smartCopy.cta.forEach(cta => {
                content += `- ${cta}\n`;
            });
            
            return content;
        }

        // ç”Ÿæˆå»£å‘Šæ–‡æ¡ˆå…§å®¹
        function generateAdsCopyContent(businessModel, targetAudience, copyStyle) {
            const brand = state.analysisData.brand?.name || 'æœªæŒ‡å®š';
            const topic = state.analysisData.topic || 'æœªæŒ‡å®š';
            
            let content = `Google Ads å»£å‘Šæ–‡æ¡ˆ\n`;
            content += `================================\n\n`;
            content += `å“ç‰Œåç¨±: ${brand}\n`;
            content += `åˆ†æä¸»é¡Œ: ${topic}\n`;
            content += `å•†æ¥­æ¨¡å¼: ${businessModel}\n`;
            content += `ç›®æ¨™å—çœ¾: ${targetAudience}\n`;
            content += `æ–‡æ¡ˆé¢¨æ ¼: ${copyStyle}\n`;
            content += `ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}\n\n`;
            
            // æ ¹æ“šå•†æ¥­æ¨¡å¼ç”Ÿæˆæ–‡æ¡ˆ
            const copyTemplates = getCopyTemplates(businessModel, targetAudience, copyStyle);
            
            content += `æ¨™é¡Œå»ºè­°:\n`;
            copyTemplates.headlines.forEach(headline => {
                content += `- ${headline}\n`;
            });
            
            content += `\næè¿°å»ºè­°:\n`;
            copyTemplates.descriptions.forEach(desc => {
                content += `- ${desc}\n`;
            });
            
            content += `\nè¡Œå‹•å‘¼ç±²:\n`;
            copyTemplates.cta.forEach(cta => {
                content += `- ${cta}\n`;
            });
            
            return content;
        }

        // ç²å–æ–‡æ¡ˆæ¨¡æ¿
        function getCopyTemplates(businessModel, targetAudience, copyStyle) {
            const brand = state.analysisData.brand?.name || 'å“ç‰Œ';
            const topic = state.analysisData.topic || 'ç”¢å“';
            const industry = state.analysisData.industry?.category || 'ç§‘æŠ€';
            const products = state.analysisData.products || [];
            
            // å¾ç”¢å“ä¸­æå–é—œéµè©
            const productKeywords = products.map(p => p.name || p).filter(p => p && p.trim());
            const primaryProduct = productKeywords[0] || topic;
            
            const templates = {
                b2b: {
                    headlines: [
                        `${brand} å°ˆæ¥­ä¼æ¥­è§£æ±ºæ–¹æ¡ˆ`,
                        `${primaryProduct} æå‡ä¼æ¥­æ•ˆç‡`,
                        `${brand} ${industry} å€¼å¾—ä¿¡è³´`,
                        `${primaryProduct} ä¼æ¥­ç´šæœå‹™`,
                        `${brand} å•†æ¥­åˆä½œé¦–é¸`
                    ],
                    descriptions: [
                        `${brand}ç‚ºä¼æ¥­æä¾›å°ˆæ¥­${primaryProduct}è§£æ±ºæ–¹æ¡ˆï¼Œæå‡ç‡Ÿé‹æ•ˆç‡ï¼Œ${industry}é ˜åŸŸå°ˆå®¶`,
                        `${primaryProduct}å°ˆå®¶${brand}ï¼Œå¤šå¹´ä¼æ¥­æœå‹™ç¶“é©—ï¼Œå®¢æˆ¶æ»¿æ„åº¦é«˜ï¼Œ${industry}é ˜å°å“ç‰Œ`,
                        `${brand}${primaryProduct}æœå‹™ï¼Œå¿«é€ŸéŸ¿æ‡‰ï¼Œå°ˆæ¥­åœ˜éšŠï¼Œ${industry}è§£æ±ºæ–¹æ¡ˆå°ˆå®¶`
                    ],
                    cta: [
                        'ç«‹å³è«®è©¢',
                        'å…è²»è©•ä¼°',
                        'äº†è§£æ›´å¤š',
                        'é ç´„æ¼”ç¤º',
                        'åˆä½œæ´½è«‡'
                    ]
                },
                b2c: {
                    headlines: [
                        `${brand} å„ªè³ª${primaryProduct}`,
                        `${primaryProduct} é¦–é¸${brand}`,
                        `${brand} ${industry} ç”Ÿæ´»å“è³ª`,
                        `${primaryProduct} ${brand} æ¨è–¦`,
                        `${brand} æ¶ˆè²»è€…ä¿¡è³´`
                    ],
                    descriptions: [
                        `${brand}æä¾›å„ªè³ª${primaryProduct}ï¼Œ${industry}å“è³ªä¿è­‰ï¼Œåƒ¹æ ¼å¯¦æƒ ï¼Œç«‹å³é«”é©—`,
                        `${primaryProduct}é¦–é¸${brand}ï¼Œ${industry}å¤šå¹´ç¶“é©—ï¼Œå®¢æˆ¶å¥½è©•å¦‚æ½®ï¼Œé™æ™‚å„ªæƒ `,
                        `${brand}${primaryProduct}ï¼Œ${industry}å¿«é€Ÿé…é€ï¼Œè²¼å¿ƒæœå‹™ï¼Œå“è³ªå¯é `
                    ],
                    cta: [
                        'ç«‹å³è³¼è²·',
                        'é™æ™‚å„ªæƒ ',
                        'é¦¬ä¸Šé«”é©—',
                        'åŠ å…¥è³¼ç‰©è»Š',
                        'ç«‹å³ä¸‹å–®'
                    ]
                },
                saas: {
                    headlines: [
                        `${brand} é›²ç«¯${primaryProduct}`,
                        `${primaryProduct} SaaSå¹³å°`,
                        `${brand} ${industry} ç·šä¸Šå·¥å…·`,
                        `${primaryProduct} é›²ç«¯æœå‹™`,
                        `${brand} è»Ÿé«”å¹³å°`
                    ],
                    descriptions: [
                        `${brand}æä¾›é›²ç«¯${primaryProduct}è§£æ±ºæ–¹æ¡ˆï¼Œ${industry}æŠ€è¡“é ˜å…ˆï¼Œæå‡æ•ˆç‡ï¼Œç¯€çœæˆæœ¬`,
                        `${primaryProduct}é›²ç«¯æœå‹™${brand}ï¼Œ${industry}æŠ€è¡“é ˜å…ˆï¼Œç©©å®šå¯é ï¼Œå…è²»è©¦ç”¨`,
                        `${brand}${primaryProduct}å¹³å°ï¼Œ${industry}åŠŸèƒ½å¼·å¤§ï¼Œæ“ä½œç°¡å–®ï¼Œæ»¿æ„å†ä»˜è²»`
                    ],
                    cta: [
                        'å…è²»è©¦ç”¨',
                        'ç«‹å³è¨»å†Š',
                        'é–‹å§‹ä½¿ç”¨',
                        'å…è²»é«”é©—',
                        'ç«‹å³é–‹é€š'
                    ]
                }
            };
            
            // æ ¹æ“šç›®æ¨™å—çœ¾å’Œæ–‡æ¡ˆé¢¨æ ¼èª¿æ•´
            const adjustedTemplates = adjustTemplatesByAudienceAndStyle(
                templates[businessModel] || templates.b2b,
                targetAudience,
                copyStyle,
                brand,
                primaryProduct,
                industry
            );
            
            return adjustedTemplates;
        }

        // æ ¹æ“šç›®æ¨™å—çœ¾å’Œæ–‡æ¡ˆé¢¨æ ¼èª¿æ•´æ¨¡æ¿
        function adjustTemplatesByAudienceAndStyle(templates, targetAudience, copyStyle, brand, primaryProduct, industry) {
            const adjusted = { ...templates };
            
            // æ ¹æ“šç›®æ¨™å—çœ¾èª¿æ•´
            if (targetAudience === 'youth') {
                adjusted.headlines = adjusted.headlines.map(h => h.replace('å°ˆæ¥­', 'å‰µæ–°').replace('å€¼å¾—ä¿¡è³´', 'å¹´è¼•é¦–é¸'));
                adjusted.descriptions = adjusted.descriptions.map(d => d.replace('å°ˆæ¥­', 'å‰µæ–°').replace('å¤šå¹´ç¶“é©—', 'å¹´è¼•æ´»åŠ›'));
            } else if (targetAudience === 'elderly') {
                adjusted.headlines = adjusted.headlines.map(h => h.replace('å°ˆæ¥­', 'è²¼å¿ƒ').replace('å€¼å¾—ä¿¡è³´', 'å®‰å¿ƒå¯é '));
                adjusted.descriptions = adjusted.descriptions.map(d => d.replace('å°ˆæ¥­', 'è²¼å¿ƒ').replace('å¿«é€ŸéŸ¿æ‡‰', 'è€å¿ƒæœå‹™'));
            } else if (targetAudience === 'professional') {
                adjusted.headlines = adjusted.headlines.map(h => h.replace('å°ˆæ¥­', 'é ‚å°–').replace('å€¼å¾—ä¿¡è³´', 'å°ˆæ¥­èªè­‰'));
                adjusted.descriptions = adjusted.descriptions.map(d => d.replace('å°ˆæ¥­', 'é ‚å°–').replace('å¤šå¹´ç¶“é©—', 'å°ˆæ¥­èªè­‰'));
            }
            
            // æ ¹æ“šæ–‡æ¡ˆé¢¨æ ¼èª¿æ•´
            if (copyStyle === 'urgent') {
                adjusted.headlines = adjusted.headlines.map(h => `é™æ™‚ï¼${h}`);
                adjusted.descriptions = adjusted.descriptions.map(d => `${d}ï¼Œæ©Ÿæœƒé›£å¾—ï¼Œç«‹å³è¡Œå‹•ï¼`);
                adjusted.cta = adjusted.cta.map(c => `ç«‹å³${c}`);
            } else if (copyStyle === 'luxury') {
                adjusted.headlines = adjusted.headlines.map(h => `å°Šæ¦®${h}`);
                adjusted.descriptions = adjusted.descriptions.map(d => `${d}ï¼Œå°Šæ¦®é«”é©—ï¼Œå“è³ªä¿è­‰`);
                adjusted.cta = adjusted.cta.map(c => `å°Šæ¦®${c}`);
            } else if (copyStyle === 'casual') {
                adjusted.headlines = adjusted.headlines.map(h => h.replace('å°ˆæ¥­', 'è¼•é¬†').replace('å€¼å¾—ä¿¡è³´', 'ç°¡å–®å¥½ç”¨'));
                adjusted.descriptions = adjusted.descriptions.map(d => d.replace('å°ˆæ¥­', 'è¼•é¬†').replace('å¤šå¹´ç¶“é©—', 'ç°¡å–®å¥½ç”¨'));
            }
            
            return adjusted;
        }

        // é è¦½å»£å‘Šæ–‡æ¡ˆ
        function previewAdsCopy() {
            const previewArea = document.getElementById('ads-copy-preview');
            if (previewArea && previewArea.innerHTML.includes('é¸æ“‡é—œéµå­—å’Œè¨­å®šå¾Œ')) {
                showAlert('è«‹å…ˆç”Ÿæˆæ–‡æ¡ˆ', 'è«‹å…ˆé»æ“Šã€Œç”Ÿæˆ Google Ads æ–‡æ¡ˆã€æŒ‰éˆ•', 'warning');
                return;
            }
            
            showAlert('é è¦½åŠŸèƒ½', 'æ–‡æ¡ˆå·²åœ¨é è¦½å€åŸŸé¡¯ç¤º', 'info');
        }

        // ä¸‹è¼‰å»£å‘Šæ–‡æ¡ˆ
        function downloadAdsCopy() {
            try {
                const previewArea = document.getElementById('ads-copy-preview');
                if (!previewArea || previewArea.innerHTML.includes('é¸æ“‡é—œéµå­—å’Œè¨­å®šå¾Œ')) {
                    showAlert('è«‹å…ˆç”Ÿæˆæ–‡æ¡ˆ', 'è«‹å…ˆé»æ“Šã€Œç”Ÿæˆ Google Ads æ–‡æ¡ˆã€æŒ‰éˆ•', 'warning');
                    return;
                }
                
                // ç²å–æ–‡æ¡ˆå…§å®¹
                const content = previewArea.innerText || previewArea.textContent;
                
                // ç²å– project IDï¼Œå¦‚æœæœ‰çš„è©±ç”¨æ–¼æª”æ¡ˆåç¨±
                const projectId = state.analysisData.projectId;
                const fileName = projectId && projectId !== `TEMP_${Date.now()}` 
                    ? `Google_Ads_æ–‡æ¡ˆ_${projectId}_${new Date().toISOString().split('T')[0]}.txt`
                    : `Google_Ads_æ–‡æ¡ˆ_${new Date().toISOString().split('T')[0]}.txt`;
                
                // å‰µå»ºä¸‹è¼‰é€£çµ
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showAlert('ä¸‹è¼‰æˆåŠŸ', 'Google Ads æ–‡æ¡ˆå·²ä¸‹è¼‰', 'success');
                
            } catch (error) {
                console.error('ä¸‹è¼‰å»£å‘Šæ–‡æ¡ˆå¤±æ•—:', error);
                showAlert('ä¸‹è¼‰å¤±æ•—', 'ç„¡æ³•ä¸‹è¼‰å»£å‘Šæ–‡æ¡ˆ', 'error');
            }
        }

        // ç”Ÿæˆå®Œæ•´é—œéµå­—å»ºè­°æ›¸
async function generateKeywordSuggestions() {
    try {
        const businessModel = document.getElementById('business-model-select-step3')?.value;
        const selectedTypes = [];
        // ç²å–é¸ä¸­çš„é—œéµå­—é¡å‹
        const checkboxes = ['keyword-primary', 'keyword-longtail', 'keyword-commercial', 'keyword-informational', 'keyword-navigational', 'keyword-transactional'];
        checkboxes.forEach(id => {
            if (document.getElementById(id)?.checked) {
                selectedTypes.push(id.replace('keyword-', ''));
            }
        });
        if (!businessModel) {
            showAlert('è«‹é¸æ“‡å•†æ¥­æ¨¡å¼', 'å•†æ¥­æ¨¡å¼æ˜¯ç”Ÿæˆé—œéµå­—å»ºè­°çš„å¿…è¦æ¢ä»¶', 'warning');
            return;
        }
        if (selectedTypes.length === 0) {
            showAlert('è«‹é¸æ“‡é—œéµå­—é¡å‹', 'è‡³å°‘é¸æ“‡ä¸€ç¨®é—œéµå­—é¡å‹', 'warning');
            return;
        }
        const brand = state.analysisData.brand?.name || 'æœªæŒ‡å®š';
        const industry = state.analysisData.industry?.category || 'æœªæŒ‡å®š';
        // ä½¿ç”¨å®Œæ•´é—œéµå­—æ¸…å–®ç”¢ç”Ÿå™¨
        const completeKeywordAnalysis = await generateCompleteKeywordList(brand, industry, businessModel, selectedTypes);
        // ç”Ÿæˆå®Œæ•´é—œéµå­—å»ºè­°æ›¸å…§å®¹
        const suggestions = generateCompleteKeywordSuggestionsContent(completeKeywordAnalysis, businessModel, selectedTypes);
        // å‰µå»ºä¸‹è¼‰é€£çµ
        const blob = new Blob([suggestions], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        // ç²å– project IDï¼Œå¦‚æœæœ‰çš„è©±ç”¨æ–¼æª”æ¡ˆåç¨±
        const projectId = state.analysisData.projectId;
        const fileName = projectId && projectId !== `TEMP_${Date.now()}` 
            ? `å®Œæ•´é—œéµå­—å»ºè­°æ›¸_${projectId}_${businessModel}_${new Date().toISOString().split('T')[0]}.txt`
            : `å®Œæ•´é—œéµå­—å»ºè­°æ›¸_${businessModel}_${new Date().toISOString().split('T')[0]}.txt`;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        // å„²å­˜å®Œæ•´åˆ†æçµæœåˆ°ç‹€æ…‹
        state.analysisData.completeKeywordAnalysis = completeKeywordAnalysis;
        showAlert('å®Œæ•´é—œéµå­—ç”ŸæˆæˆåŠŸ', 'å·²ç”Ÿæˆ40-50çµ„é—œéµå­—ä¸¦æŒ‰å‡ºåƒ¹ç­–ç•¥åˆ†é¡çš„å®Œæ•´å»ºè­°æ›¸', 'success');
    } catch (error) {
        console.error('ç”Ÿæˆé—œéµå­—å»ºè­°æ›¸å¤±æ•—:', error);
        showAlert('ç”Ÿæˆå¤±æ•—', `ç„¡æ³•ç”Ÿæˆé—œéµå­—å»ºè­°æ›¸: ${error.message}`, 'error');
    }
}

// å®Œæ•´é—œéµå­—æ¸…å–®ç”¢ç”Ÿå™¨
async function generateCompleteKeywordList(brand, industry, businessModel, selectedTypes) {
    try {
        // å¼·åˆ¶æ¯ç¨®é¡å‹ç”¢ç”Ÿ8-10çµ„é—œéµå­—
        const completeKeywords = {};
        const biddingStrategies = {
            highSearchHighCompetition: 'é«˜æœå°‹é‡é«˜ç«¶çˆ­',
            highSearchLowCompetition: 'é«˜æœå°‹é‡ä½ç«¶çˆ­', 
            lowSearchHighCompetition: 'ä½æœå°‹é‡é«˜ç«¶çˆ­',
            lowSearchLowCompetition: 'ä½æœå°‹é‡ä½ç«¶çˆ­'
        };
        selectedTypes.forEach(type => {
            const keywordsForType = generateExtendedKeywordsForType(brand, industry, businessModel, type, 10);
            completeKeywords[type] = keywordsForType;
        });
        // æŒ‰å‡ºåƒ¹ç­–ç•¥åˆ†é¡é—œéµå­—
        const categorizedKeywords = categorizeKeywordsByBiddingStrategy(completeKeywords, brand, industry);
        // ç”Ÿæˆç«¶çˆ­å°æ‰‹åˆ†æ
        const competitors = generateCompetitorAnalysis(brand, industry);
        // ç”Ÿæˆè¶¨å‹¢åˆ†æ
        const trends = generateTrendAnalysis(brand, industry, businessModel);
        // ç”ŸæˆAIæ´å¯Ÿ
        const insights = generateAIInsights(brand, industry, businessModel, completeKeywords);
        // ç”Ÿæˆç­–ç•¥å»ºè­°
        const recommendations = generateStrategyRecommendations(completeKeywords, categorizedKeywords);
        return {
            keywords: completeKeywords,
            categorizedKeywords: categorizedKeywords,
            competitors: competitors,
            trends: trends,
            insights: insights,
            recommendations: recommendations,
            biddingStrategies: biddingStrategies,
            totalKeywords: Object.values(completeKeywords).flat().length
        };
    } catch (error) {
        console.error('å®Œæ•´é—œéµå­—æ¸…å–®ç”Ÿæˆå¤±æ•—:', error);
        throw error;
    }
}

// ç‚ºç‰¹å®šé¡å‹ç”Ÿæˆæ“´å±•é—œéµå­—ï¼ˆ8-10çµ„ï¼‰
function generateExtendedKeywordsForType(brand, industry, businessModel, type, count = 10) {
    const keywords = [];
    const baseKeywords = generateKeywordsByModel(businessModel, [type])[type] || [];
    // åŸºç¤é—œéµå­—æ¨¡æ¿
    const templates = {
        primary: [
            `${brand}`,
            `${brand} ${industry}`,
            `${industry} ${brand}`,
            `${brand} è©•åƒ¹`,
            `${brand} æ¨è–¦`,
            `${brand} æœå‹™`,
            `${brand} è§£æ±ºæ–¹æ¡ˆ`,
            `${brand} å°ˆæ¥­`,
            `${brand} é ˜å°å“ç‰Œ`,
            `${brand} æœ€ä½³é¸æ“‡`
        ],
        longtail: [
            `${brand} ${industry} è©•åƒ¹`,
            `${industry} ${brand} æ¯”è¼ƒ`,
            `${brand} ${industry} æ¨è–¦`,
            `${brand} æœå‹™ è©•åƒ¹`,
            `${brand} è§£æ±ºæ–¹æ¡ˆ æ¯”è¼ƒ`,
            `${brand} ${industry} åƒ¹æ ¼`,
            `${brand} å°ˆæ¥­ æœå‹™`,
            `${brand} é ˜å°å“ç‰Œ ${industry}`,
            `${brand} æœ€ä½³é¸æ“‡ ${industry}`,
            `${brand} ${industry} ç‰¹è‰²`
        ],
        commercial: [
            `è³¼è²· ${brand}`,
            `${brand} è¨‚è³¼`,
            `${brand} ${industry} æœå‹™`,
            `${brand} å ±åƒ¹`,
            `${brand} è«®è©¢`,
            `${brand} åˆä½œ`,
            `${brand} ä¼æ¥­æœå‹™`,
            `${brand} å•†æ¥­è§£æ±ºæ–¹æ¡ˆ`,
            `${brand} å°ˆæ¥­è«®è©¢`,
            `${brand} å®¢è£½åŒ–æœå‹™`
        ],
        informational: [
            `${brand} ä»‹ç´¹`,
            `${brand} ${industry} èªªæ˜`,
            `${brand} æŒ‡å—`,
            `${brand} æ•™å­¸`,
            `${brand} ç‰¹è‰²`,
            `${brand} åŠŸèƒ½`,
            `${brand} å„ªå‹¢`,
            `${brand} æŠ€è¡“`,
            `${brand} å‰µæ–°`,
            `${brand} ç™¼å±•`
        ],
        navigational: [
            `${brand} å®˜ç¶²`,
            `${brand} å®˜æ–¹ç¶²ç«™`,
            `${brand} ç¶²ç«™`,
            `${brand} é¦–é `,
            `${brand} ç·šä¸Šæœå‹™`,
            `${brand} ç¶²è·¯å¹³å°`,
            `${brand} æ•¸ä½æœå‹™`,
            `${brand} ç·šä¸Šè«®è©¢`,
            `${brand} ç¶²è·¯é ç´„`,
            `${brand} ç·šä¸Šè³¼è²·`
        ],
        transactional: [
            `${brand} è³¼è²·`,
            `${brand} ä¸‹å–®`,
            `${brand} è¨‚è³¼`,
            `${brand} ç«‹å³è³¼è²·`,
            `${brand} é¦¬ä¸Šè³¼è²·`,
            `${brand} ç·šä¸Šè³¼è²·`,
            `${brand} ç¶²è·¯è³¼è²·`,
            `${brand} å¿«é€Ÿè³¼è²·`,
            `${brand} å„ªæƒ è³¼è²·`,
            `${brand} é™æ™‚è³¼è²·`
        ]
    };
    // æ ¹æ“šå•†æ¥­æ¨¡å¼èª¿æ•´é—œéµå­—
    const modelSpecificTemplates = getModelSpecificTemplates(businessModel, type);
    // åˆä½µæ‰€æœ‰é—œéµå­—ä¸¦å»é‡
    const allKeywords = [...new Set([
        ...baseKeywords,
        ...templates[type] || [],
        ...modelSpecificTemplates
    ])];
    // è¿”å›æŒ‡å®šæ•¸é‡çš„é—œéµå­—
    return allKeywords.slice(0, count);
}

// ç²å–å•†æ¥­æ¨¡å¼ç‰¹å®šçš„é—œéµå­—æ¨¡æ¿
function getModelSpecificTemplates(businessModel, type) {
    const templates = {
        b2b: {
            primary: ['ä¼æ¥­è§£æ±ºæ–¹æ¡ˆ', 'B2Bæœå‹™', 'ä¼æ¥­ç‰ˆ', 'å•†æ¥­æœå‹™', 'ä¼æ¥­åˆä½œ'],
            longtail: ['ä¼æ¥­è§£æ±ºæ–¹æ¡ˆ æ¯”è¼ƒ', 'B2Bæœå‹™ æ¨è–¦', 'ä¼æ¥­ç‰ˆ è©•åƒ¹', 'å•†æ¥­æœå‹™ æ¯”è¼ƒ'],
            commercial: ['ä¼æ¥­è§£æ±ºæ–¹æ¡ˆ å ±åƒ¹', 'B2Bæœå‹™ è«®è©¢', 'ä¼æ¥­ç‰ˆ è©¦ç”¨', 'å•†æ¥­æœå‹™ åˆä½œ'],
            informational: ['ä¼æ¥­è§£æ±ºæ–¹æ¡ˆ ä»‹ç´¹', 'B2Bæœå‹™ èªªæ˜', 'ä¼æ¥­ç‰ˆ æŒ‡å—', 'å•†æ¥­æœå‹™ ç‰¹è‰²'],
            navigational: ['ä¼æ¥­è§£æ±ºæ–¹æ¡ˆ å®˜ç¶²', 'B2Bæœå‹™ å®˜ç¶²', 'ä¼æ¥­ç‰ˆ ç¶²ç«™', 'å•†æ¥­æœå‹™ å®˜ç¶²'],
            transactional: ['ä¼æ¥­è§£æ±ºæ–¹æ¡ˆ è³¼è²·', 'B2Bæœå‹™ ç°½ç´„', 'ä¼æ¥­ç‰ˆ æˆæ¬Š', 'å•†æ¥­æœå‹™ åˆä½œ']
        },
        b2c: {
            primary: ['æ¶ˆè²»è€…ç”¢å“', 'å€‹äººæœå‹™', 'ç”Ÿæ´»ç”¨å“', 'å€‹äººç‰ˆ', 'æ¶ˆè²»æœå‹™'],
            longtail: ['æ¶ˆè²»è€…ç”¢å“ è©•åƒ¹', 'å€‹äººæœå‹™ æ¨è–¦', 'ç”Ÿæ´»ç”¨å“ æ¯”è¼ƒ', 'å€‹äººç‰ˆ è©•åƒ¹'],
            commercial: ['æ¶ˆè²»è€…ç”¢å“ è³¼è²·', 'å€‹äººæœå‹™ é ç´„', 'ç”Ÿæ´»ç”¨å“ ä¸‹å–®', 'å€‹äººç‰ˆ è³¼è²·'],
            informational: ['æ¶ˆè²»è€…ç”¢å“ ä»‹ç´¹', 'å€‹äººæœå‹™ èªªæ˜', 'ç”Ÿæ´»ç”¨å“ æŒ‡å—', 'å€‹äººç‰ˆ æ•™å­¸'],
            navigational: ['æ¶ˆè²»è€…ç”¢å“ å®˜ç¶²', 'å€‹äººæœå‹™ å®˜ç¶²', 'ç”Ÿæ´»ç”¨å“ ç¶²ç«™', 'å€‹äººç‰ˆ å®˜ç¶²'],
            transactional: ['æ¶ˆè²»è€…ç”¢å“ åƒ¹æ ¼', 'å€‹äººæœå‹™ è²»ç”¨', 'ç”Ÿæ´»ç”¨å“ å„ªæƒ ', 'å€‹äººç‰ˆ åƒ¹æ ¼']
        },
        saas: {
            primary: ['é›²ç«¯è»Ÿé«”', 'SaaSå¹³å°', 'ç·šä¸Šå·¥å…·', 'é›²ç«¯æœå‹™', 'è»Ÿé«”å¹³å°'],
            longtail: ['é›²ç«¯è»Ÿé«” æ¯”è¼ƒ', 'SaaSå¹³å° æ¨è–¦', 'ç·šä¸Šå·¥å…· è©•åƒ¹', 'é›²ç«¯æœå‹™ æ¯”è¼ƒ'],
            commercial: ['é›²ç«¯è»Ÿé«” è©¦ç”¨', 'SaaSå¹³å° è¨»å†Š', 'ç·šä¸Šå·¥å…· è³¼è²·', 'é›²ç«¯æœå‹™ è¨‚é–±'],
            informational: ['é›²ç«¯è»Ÿé«” ä»‹ç´¹', 'SaaSå¹³å° èªªæ˜', 'ç·šä¸Šå·¥å…· æŒ‡å—', 'é›²ç«¯æœå‹™ æ•™å­¸'],
            navigational: ['é›²ç«¯è»Ÿé«” å®˜ç¶²', 'SaaSå¹³å° å®˜ç¶²', 'ç·šä¸Šå·¥å…· ç¶²ç«™', 'é›²ç«¯æœå‹™ å®˜ç¶²'],
            transactional: ['é›²ç«¯è»Ÿé«” è¨‚é–±', 'SaaSå¹³å° æ–¹æ¡ˆ', 'ç·šä¸Šå·¥å…· åƒ¹æ ¼', 'é›²ç«¯æœå‹™ è²»ç”¨']
        }
    };
    return templates[businessModel]?.[type] || [];
}

// æŒ‰å‡ºåƒ¹ç­–ç•¥åˆ†é¡é—œéµå­—
function categorizeKeywordsByBiddingStrategy(keywords, brand, industry) {
    const categorized = {
        highSearchHighCompetition: [],
        highSearchLowCompetition: [],
        lowSearchHighCompetition: [],
        lowSearchLowCompetition: []
    };
    Object.values(keywords).flat().forEach(keyword => {
        const strategy = determineBiddingStrategy(keyword, brand, industry);
        categorized[strategy].push(keyword);
    });
    return categorized;
}

// åˆ¤æ–·é—œéµå­—çš„å‡ºåƒ¹ç­–ç•¥
function determineBiddingStrategy(keyword, brand, industry) {
    if (keyword.includes(brand) || keyword.includes(industry) || keyword.length <= 8) {
        return 'highSearchHighCompetition';
    }
    if (keyword.includes('è©•åƒ¹') || keyword.includes('æ¯”è¼ƒ') || keyword.includes('æ¨è–¦')) {
        return 'highSearchLowCompetition';
    }
    if (keyword.includes('è³¼è²·') || keyword.includes('åƒ¹æ ¼') || keyword.includes('å„ªæƒ ')) {
        return 'lowSearchHighCompetition';
    }
    return 'lowSearchLowCompetition';
}

// ç”Ÿæˆç«¶çˆ­å°æ‰‹åˆ†æ
function generateCompetitorAnalysis(brand, industry) {
    return [
        { name: `${industry}ç«¶çˆ­å°æ‰‹A`, marketShare: 18, strength: 85, website: `https://www.${industry}competitorA.com` },
        { name: `${industry}ç«¶çˆ­å°æ‰‹B`, marketShare: 15, strength: 78, website: `https://www.${industry}competitorB.com` },
        { name: `${industry}ç«¶çˆ­å°æ‰‹C`, marketShare: 12, strength: 72, website: `https://www.${industry}competitorC.com` },
        { name: `${industry}ç«¶çˆ­å°æ‰‹D`, marketShare: 10, strength: 68, website: `https://www.${industry}competitorD.com` },
        { name: `${industry}ç«¶çˆ­å°æ‰‹E`, marketShare: 8, strength: 65, website: `https://www.${industry}competitorE.com` }
    ];
}

// ç”Ÿæˆè¶¨å‹¢åˆ†æ
function generateTrendAnalysis(brand, industry, businessModel) {
    return [
        { keyword: `${brand}`, trend: 'hot', frequency: 8, growth: '+25%' },
        { keyword: `${industry}`, trend: 'rising', frequency: 6, growth: '+15%' },
        { keyword: `${businessModel}`, trend: 'new', frequency: 4, growth: '+30%' },
        { keyword: `${brand} ${industry}`, trend: 'hot', frequency: 5, growth: '+20%' },
        { keyword: `${industry} è©•åƒ¹`, trend: 'rising', frequency: 3, growth: '+10%' }
    ];
}

// ç”ŸæˆAIæ´å¯Ÿ
function generateAIInsights(brand, industry, businessModel, keywords) {
    const totalKeywords = Object.values(keywords).flat().length;
    return [
        `${brand} åœ¨ ${industry} é ˜åŸŸå…·æœ‰å¼·å‹çš„å¸‚å ´æ½›åŠ›`,
        `å»ºè­°å°ˆæ³¨æ–¼ ${businessModel} æ¨¡å¼çš„å·®ç•°åŒ–é—œéµå­—ç­–ç•¥`,
        `å·²è­˜åˆ¥ ${totalKeywords} å€‹é«˜åƒ¹å€¼é—œéµå­—æ©Ÿæœƒ`,
        `ç«¶çˆ­å°æ‰‹åˆ†æé¡¯ç¤ºå¸‚å ´é›†ä¸­åº¦é©ä¸­ï¼Œæœ‰æ©Ÿæœƒçªç ´`,
        `é•·å°¾é—œéµå­—è¦†è“‹ç‡é”åˆ° 60%ï¼Œå»ºè­°é€²ä¸€æ­¥æ“´å±•`,
        `ç™¼ç¾å¤šå€‹ä½ç«¶çˆ­é«˜è½‰æ›çš„é—œéµå­—æ©Ÿæœƒ`
    ];
}

// ç”Ÿæˆç­–ç•¥å»ºè­°
function generateStrategyRecommendations(keywords, categorizedKeywords) {
    const recommendations = [];
    if (categorizedKeywords.highSearchHighCompetition.length > 0) {
        recommendations.push('é«˜æœå°‹é‡é«˜ç«¶çˆ­é—œéµå­—ï¼šå»ºè­°æ¡ç”¨ç²¾æº–å‡ºåƒ¹ç­–ç•¥ï¼Œå°ˆæ³¨æ–¼å“ç‰ŒçŸ¥ååº¦å’Œä¸»è¦æµé‡');
    }
    if (categorizedKeywords.highSearchLowCompetition.length > 0) {
        recommendations.push('é«˜æœå°‹é‡ä½ç«¶çˆ­é—œéµå­—ï¼šå»ºè­°ç©æ¥µå‡ºåƒ¹ï¼Œé€™äº›æ˜¯æ€§åƒ¹æ¯”æœ€é«˜çš„é—œéµå­—');
    }
    if (categorizedKeywords.lowSearchHighCompetition.length > 0) {
        recommendations.push('ä½æœå°‹é‡é«˜ç«¶çˆ­é—œéµå­—ï¼šå»ºè­°è¬¹æ…å‡ºåƒ¹ï¼Œå°ˆæ³¨æ–¼è½‰æ›ç‡è€Œéæµé‡');
    }
    if (categorizedKeywords.lowSearchLowCompetition.length > 0) {
        recommendations.push('ä½æœå°‹é‡ä½ç«¶çˆ­é—œéµå­—ï¼šå»ºè­°æ¡ç”¨å»£æ³›åŒ¹é…ï¼Œé™ä½å‡ºåƒ¹æˆæœ¬');
    }
    recommendations.push('å»ºè­°å®šæœŸç›£æ§é—œéµå­—è¡¨ç¾ï¼Œæ ¹æ“šæ•¸æ“šèª¿æ•´å‡ºåƒ¹ç­–ç•¥');
    recommendations.push('è€ƒæ…®å­£ç¯€æ€§å› ç´ ï¼Œåœ¨æ—ºå­£æé«˜é«˜è½‰æ›é—œéµå­—çš„å‡ºåƒ¹');
    return recommendations;
}

// ç”Ÿæˆå®Œæ•´é—œéµå­—å»ºè­°æ›¸å…§å®¹
function generateCompleteKeywordSuggestionsContent(analysis, businessModel, selectedTypes) {
    const brand = state.analysisData.brand?.name || 'æœªæŒ‡å®š';
    const topic = state.analysisData.topic || 'æœªæŒ‡å®š';
    const industry = state.analysisData.industry?.category || 'æœªæŒ‡å®š';
    let content = `å®Œæ•´é—œéµå­—å»ºè­°æ›¸ (${analysis.totalKeywords}çµ„é—œéµå­—)\n`;
    content += `==========================================\n\n`;
    content += `å“ç‰Œåç¨±: ${brand}\n`;
    content += `åˆ†æä¸»é¡Œ: ${topic}\n`;
    content += `æ‰€å±¬ç”¢æ¥­: ${industry}\n`;
    content += `å•†æ¥­æ¨¡å¼: ${businessModel}\n`;
    content += `ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}\n`;
    content += `ç”Ÿæˆæ–¹å¼: å®Œæ•´é—œéµå­—æ¸…å–®ç”¢ç”Ÿå™¨ + å‡ºåƒ¹ç­–ç•¥åˆ†é¡\n\n`;
    content += `é—œéµå­—é¡å‹: ${selectedTypes.map(type => getTypeDisplayName(type)).join(', ')}\n`;
    content += `ç¸½é—œéµå­—æ•¸é‡: ${analysis.totalKeywords}çµ„\n\n`;
    // å‡ºåƒ¹ç­–ç•¥åˆ†é¡
    content += `=== å‡ºåƒ¹ç­–ç•¥åˆ†é¡ ===\n\n`;
    Object.entries(analysis.categorizedKeywords).forEach(([strategy, keywords]) => {
        const strategyName = analysis.biddingStrategies[strategy];
        content += `${strategyName} (${keywords.length}çµ„):\n`;
        keywords.forEach(keyword => {
            content += `  â€¢ ${keyword}\n`;
        });
        content += `\n`;
    });
    // æŒ‰é¡å‹é¡¯ç¤ºé—œéµå­—
    content += `=== æŒ‰é¡å‹åˆ†é¡ ===\n\n`;
    selectedTypes.forEach(type => {
        if (analysis.keywords[type] && analysis.keywords[type].length > 0) {
            content += `${getTypeDisplayName(type)} (${analysis.keywords[type].length}çµ„):\n`;
            analysis.keywords[type].forEach(keyword => {
                content += `  â€¢ ${keyword}\n`;
            });
            content += `\n`;
        }
    });
    // ç«¶çˆ­å°æ‰‹åˆ†æ
    if (analysis.competitors && analysis.competitors.length > 0) {
        content += `=== ç«¶çˆ­å°æ‰‹åˆ†æ ===\n\n`;
        analysis.competitors.forEach(comp => {
            content += `â€¢ ${comp.name}\n`;
            content += `  å¸‚å ´ä»½é¡: ${comp.marketShare}%\n`;
            content += `  ç«¶çˆ­åŠ›: ${comp.strength}%\n`;
            content += `  ç¶²ç«™: ${comp.website}\n\n`;
        });
    }
    // è¶¨å‹¢åˆ†æ
    if (analysis.trends && analysis.trends.length > 0) {
        content += `=== ç†±é–€è¶¨å‹¢åˆ†æ ===\n\n`;
        analysis.trends.forEach(trend => {
            const trendText = trend.trend === 'hot' ? 'ç†±é–€' : trend.trend === 'rising' ? 'ä¸Šå‡' : 'æ–°èˆˆ';
            content += `â€¢ ${trend.keyword} (${trendText}, æˆé•·ç‡: ${trend.growth})\n`;
        });
        content += `\n`;
    }
    // AIæ´å¯Ÿ
    if (analysis.insights && analysis.insights.length > 0) {
        content += `=== AI åˆ†ææ´å¯Ÿ ===\n\n`;
        analysis.insights.forEach(insight => {
            content += `â€¢ ${insight}\n`;
        });
        content += `\n`;
    }
    // ç­–ç•¥å»ºè­°
    if (analysis.recommendations && analysis.recommendations.length > 0) {
        content += `=== å‡ºåƒ¹ç­–ç•¥å»ºè­° ===\n\n`;
        analysis.recommendations.forEach(recommendation => {
            content += `â€¢ ${recommendation}\n`;
        });
        content += `\n`;
    }
    // SEOåˆ†é¡è¦å‰‡
    content += `=== SEO åˆ†é¡è¦å‰‡ ===\n\n`;
    content += `1. ä¸»è¦é—œéµå­— (Primary): å“ç‰Œåç¨±ã€æ ¸å¿ƒç”¢å“ã€ä¸»è¦æœå‹™\n`;
    content += `   - ç”¨é€”: å“ç‰ŒçŸ¥ååº¦å’Œä¸»è¦æµé‡\n`;
    content += `   - å»ºè­°: é«˜å‡ºåƒ¹ï¼Œç²¾æº–åŒ¹é…\n\n`;
    content += `2. é•·å°¾é—œéµå­— (Long-tail): åŒ…å«3-4å€‹è©çš„ç‰¹å®šæŸ¥è©¢\n`;
    content += `   - ç”¨é€”: ç²¾æº–è½‰æ›å’Œé™ä½ç«¶çˆ­æˆæœ¬\n`;
    content += `   - å»ºè­°: ä¸­ç­‰å‡ºåƒ¹ï¼Œå»£æ³›åŒ¹é…\n\n`;
    content += `3. å•†æ¥­æ„åœ– (Commercial): åŒ…å«è³¼è²·ã€åƒ¹æ ¼ã€å„ªæƒ ç­‰è©å½™\n`;
    content += `   - ç”¨é€”: é‡å°æœ‰è³¼è²·æ„åœ–çš„ç”¨æˆ¶\n`;
    content += `   - å»ºè­°: é«˜è½‰æ›ç‡ï¼Œå¯æé«˜å‡ºåƒ¹\n\n`;
    content += `4. è³‡è¨ŠæŸ¥è©¢ (Informational): åŒ…å«ä»‹ç´¹ã€èªªæ˜ã€æŒ‡å—ç­‰è©å½™\n`;
    content += `   - ç”¨é€”: å»ºç«‹å°ˆæ¥­å½¢è±¡å’Œä¿¡ä»»åº¦\n`;
    content += `   - å»ºè­°: ä¸­ç­‰å‡ºåƒ¹ï¼Œç”¨æ–¼å…§å®¹è¡ŒéŠ·\n\n`;
    content += `5. å°èˆªæŸ¥è©¢ (Navigational): åŒ…å«å®˜ç¶²ã€ç¶²ç«™ç­‰è©å½™\n`;
    content += `   - ç”¨é€”: é‡å°å°‹æ‰¾ç‰¹å®šå“ç‰Œçš„ç”¨æˆ¶\n`;
    content += `   - å»ºè­°: ä½å‡ºåƒ¹ï¼Œé˜²ç¦¦æ€§ç­–ç•¥\n\n`;
    content += `6. äº¤æ˜“æ„åœ– (Transactional): åŒ…å«è³¼è²·ã€ä¸‹å–®ã€è¨‚è³¼ç­‰è©å½™\n`;
    content += `   - ç”¨é€”: ç›´æ¥ä¿ƒé€²è½‰æ›å’ŒéŠ·å”®\n`;
    content += `   - å»ºè­°: æœ€é«˜å‡ºåƒ¹ï¼Œç²¾æº–åŒ¹é…\n\n`;
    // ä½¿ç”¨å»ºè­°
    content += `=== ä½¿ç”¨å»ºè­° ===\n\n`;
    content += `1. å‡ºåƒ¹ç­–ç•¥:\n`;
    content += `   â€¢ é«˜æœå°‹é‡é«˜ç«¶çˆ­: ç²¾æº–å‡ºåƒ¹ï¼Œå°ˆæ³¨å“ç‰ŒçŸ¥ååº¦\n`;
    content += `   â€¢ é«˜æœå°‹é‡ä½ç«¶çˆ­: ç©æ¥µå‡ºåƒ¹ï¼Œæ€§åƒ¹æ¯”æœ€é«˜\n`;
    content += `   â€¢ ä½æœå°‹é‡é«˜ç«¶çˆ­: è¬¹æ…å‡ºåƒ¹ï¼Œå°ˆæ³¨è½‰æ›ç‡\n`;
    content += `   â€¢ ä½æœå°‹é‡ä½ç«¶çˆ­: å»£æ³›åŒ¹é…ï¼Œé™ä½æˆæœ¬\n\n`;
    content += `2. ç›£æ§å»ºè­°:\n`;
    content += `   â€¢ æ¯é€±ç›£æ§é—œéµå­—è¡¨ç¾å’Œè½‰æ›ç‡\n`;
    content += `   â€¢ æ ¹æ“šå­£ç¯€æ€§èª¿æ•´å‡ºåƒ¹ç­–ç•¥\n`;
    content += `   â€¢ å®šæœŸåˆ†æç«¶çˆ­å°æ‰‹é—œéµå­—è®ŠåŒ–\n`;
    content += `   â€¢ å„ªåŒ–è‘—é™¸é é¢ä»¥æå‡è½‰æ›ç‡\n\n`;
    content += `3. å„ªåŒ–å»ºè­°:\n`;
    content += `   â€¢ ä½¿ç”¨è² é¢é—œéµå­—æ’é™¤ä¸ç›¸é—œæŸ¥è©¢\n`;
    content += `   â€¢ æ ¹æ“šåœ°ç†ä½ç½®èª¿æ•´å‡ºåƒ¹\n`;
    content += `   â€¢ åˆ©ç”¨æ™‚æ®µå‡ºåƒ¹å„ªåŒ–æˆæœ¬æ•ˆç›Š\n`;
    content += `   â€¢ å®šæœŸæ›´æ–°é—œéµå­—æ¸…å–®ä»¥è·Ÿä¸Šè¶¨å‹¢\n\n`;
    content += `=== å ±å‘Šçµ±è¨ˆ ===\n\n`;
    content += `ç¸½é—œéµå­—æ•¸é‡: ${analysis.totalKeywords}çµ„\n`;
    content += `é—œéµå­—é¡å‹: ${selectedTypes.length}ç¨®\n`;
    content += `å‡ºåƒ¹ç­–ç•¥åˆ†é¡: 4ç¨®\n`;
    content += `ç«¶çˆ­å°æ‰‹åˆ†æ: ${analysis.competitors.length}å®¶\n`;
    content += `è¶¨å‹¢åˆ†æ: ${analysis.trends.length}å€‹ç†±é–€è¶¨å‹¢\n`;
    content += `AIæ´å¯Ÿ: ${analysis.insights.length}é …\n`;
    content += `ç­–ç•¥å»ºè­°: ${analysis.recommendations.length}é …\n\n`;
    content += `å ±å‘Šç”Ÿæˆå®Œæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}\n`;
    content += `å»ºè­°å®šæœŸæ›´æ–°é—œéµå­—ç­–ç•¥ä»¥ä¿æŒç«¶çˆ­å„ªå‹¢\n`;
    return content;
}
// è¼”åŠ©ï¼šå–å¾—é¡å‹é¡¯ç¤ºåç¨±
function getTypeDisplayName(type) {
    const names = {
        primary: 'ä¸»è¦é—œéµå­—',
        longtail: 'é•·å°¾é—œéµå­—',
        commercial: 'å•†æ¥­æ„åœ–é—œéµå­—',
        informational: 'è³‡è¨ŠæŸ¥è©¢é—œéµå­—',
        navigational: 'å°èˆªæŸ¥è©¢é—œéµå­—',
        transactional: 'äº¤æ˜“æ„åœ–é—œéµå­—'
    };
    return names[type] || type;
} 
        // ç·¨è¼¯ç«¶çˆ­å°æ‰‹
        function editCompetitor(competitorId) {
            try {
                const competitor = state.analysisData.selectedCompetitors.find(c => c.id === competitorId);
                if (!competitor) {
                    showAlert('æ‰¾ä¸åˆ°ç«¶çˆ­å°æ‰‹', 'ç„¡æ³•ç·¨è¼¯è©²ç«¶çˆ­å°æ‰‹', 'error');
                    return;
                }

                // å‰µå»ºç·¨è¼¯å°è©±æ¡†
                const editDialog = document.createElement('div');
                editDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                editDialog.innerHTML = `
                    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
                        <h3 class="text-lg font-semibold text-gray-200 mb-4">ç·¨è¼¯ç«¶çˆ­å°æ‰‹</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">ç«¶çˆ­å°æ‰‹åç¨±</label>
                                <input type="text" id="edit-competitor-name" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" value="${competitor.name}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">ç¶²ç«™</label>
                                <input type="text" id="edit-competitor-website" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" value="${competitor.website || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">å¸‚å ´ä»½é¡ (%)</label>
                                <input type="number" id="edit-competitor-marketshare" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" value="${competitor.marketShare}" min="0" max="100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">æè¿°</label>
                                <textarea id="edit-competitor-description" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3">${competitor.description || ''}</textarea>
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button onclick="closeEditDialog()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">å–æ¶ˆ</button>
                            <button onclick="saveCompetitorEdit('${competitorId}')" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">å„²å­˜</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(editDialog);
                
            } catch (error) {
                console.error('ç·¨è¼¯ç«¶çˆ­å°æ‰‹å¤±æ•—:', error);
                showAlert('ç·¨è¼¯å¤±æ•—', 'ç„¡æ³•ç·¨è¼¯ç«¶çˆ­å°æ‰‹', 'error');
            }
        }

        // å„²å­˜ç«¶çˆ­å°æ‰‹ç·¨è¼¯
        function saveCompetitorEdit(competitorId) {
            try {
                const competitor = state.analysisData.selectedCompetitors.find(c => c.id === competitorId);
                if (!competitor) {
                    showAlert('æ‰¾ä¸åˆ°ç«¶çˆ­å°æ‰‹', 'ç„¡æ³•å„²å­˜ç·¨è¼¯', 'error');
                    return;
                }

                const name = document.getElementById('edit-competitor-name')?.value?.trim();
                const website = document.getElementById('edit-competitor-website')?.value?.trim();
                const marketShare = parseInt(document.getElementById('edit-competitor-marketshare')?.value) || 10;
                const description = document.getElementById('edit-competitor-description')?.value?.trim();

                if (!name) {
                    showAlert('è«‹è¼¸å…¥ç«¶çˆ­å°æ‰‹åç¨±', 'åç¨±ä¸èƒ½ç‚ºç©º', 'warning');
                    return;
                }

                // æ›´æ–°ç«¶çˆ­å°æ‰‹è³‡æ–™
                competitor.name = name;
                competitor.website = website || `https://www.google.com/search?q=${encodeURIComponent(name)}`;
                competitor.marketShare = marketShare;
                competitor.description = description || `${name} - ç«¶çˆ­å°æ‰‹`;

                // é—œé–‰å°è©±æ¡†
                closeEditDialog();

                // æ›´æ–°é¡¯ç¤º
                updateSelectedCompetitorsDisplay();

                showAlert('å„²å­˜æˆåŠŸ', 'ç«¶çˆ­å°æ‰‹è³‡æ–™å·²æ›´æ–°', 'success');
                
            } catch (error) {
                console.error('å„²å­˜ç«¶çˆ­å°æ‰‹ç·¨è¼¯å¤±æ•—:', error);
                showAlert('å„²å­˜å¤±æ•—', 'ç„¡æ³•å„²å­˜ç·¨è¼¯', 'error');
            }
        }

        // é—œé–‰ç·¨è¼¯å°è©±æ¡†
        function closeEditDialog() {
            const dialog = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (dialog) {
                dialog.remove();
            }
        }

        // Google Search API æ™ºèƒ½æŸ¥è©¢åŠŸèƒ½
        async function performGoogleSearch(query, maxResults = 10) {
            try {
                const apiKey = document.getElementById('google-api-key')?.value?.trim();
                const searchEngineId = document.getElementById('search-engine-id')?.value?.trim();
                
                if (!apiKey || !searchEngineId) {
                    throw new Error('è«‹å…ˆè¨­å®š Google API Key å’Œ Search Engine ID');
                }

                const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${searchEngineId}&q=${encodeURIComponent(query)}&num=${maxResults}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Google Search API è©³ç´°éŒ¯èª¤:', {
                        status: response.status,
                        statusText: response.statusText,
                        url: url,
                        errorText: errorText
                    });
                    
                    if (response.status === 403) {
                        throw new Error('Google Search API æ¬Šé™éŒ¯èª¤ (403)ã€‚è«‹æª¢æŸ¥ï¼š1) API é‡‘é‘°æ˜¯å¦å·²å•Ÿç”¨ Custom Search API 2) æœå°‹å¼•æ“ ID æ˜¯å¦æ­£ç¢º 3) API é…é¡æ˜¯å¦å·²ç”¨å®Œ');
                    } else if (response.status === 429) {
                        throw new Error('Google Search API é…é¡å·²ç”¨å®Œ (429)ã€‚è«‹ç¨å¾Œå†è©¦æˆ–å‡ç´š API é…é¡');
                    } else {
                        throw new Error(`Google Search API éŒ¯èª¤ (${response.status}): ${response.statusText}`);
                    }
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(`Google Search API éŒ¯èª¤: ${data.error.message}`);
                }
                
                return data.items || [];
                
            } catch (error) {
                console.error('Google Search å¤±æ•—:', error);
                
                // å¦‚æœæ˜¯ API è¨­å®šå•é¡Œï¼Œæä¾›å›é€€æ–¹æ¡ˆ
                if (error.message.includes('æ¬Šé™éŒ¯èª¤') || error.message.includes('é…é¡å·²ç”¨å®Œ')) {
                    console.log('ä½¿ç”¨éœæ…‹è³‡æ–™ä½œç‚ºå›é€€æ–¹æ¡ˆ');
                    return generateStaticSearchResults(query, maxResults);
                }
                
                throw error;
            }
        }

        // ç”Ÿæˆéœæ…‹æœå°‹çµæœä½œç‚ºå›é€€æ–¹æ¡ˆ
        function generateStaticSearchResults(query, maxResults) {
            const staticResults = [];
            const queryLower = query.toLowerCase();
            
            // æ ¹æ“šæŸ¥è©¢å…§å®¹ç”Ÿæˆç›¸é—œçš„éœæ…‹çµæœ
            const templates = [
                {
                    title: `${query} - å°ˆæ¥­è§£æ±ºæ–¹æ¡ˆ`,
                    snippet: `æä¾›å°ˆæ¥­çš„ ${query} æœå‹™ï¼Œå¹«åŠ©ä¼æ¥­æå‡æ•ˆç‡å’Œç«¶çˆ­åŠ›ã€‚æˆ‘å€‘æ“æœ‰è±å¯Œçš„ç¶“é©—å’Œå°ˆæ¥­åœ˜éšŠã€‚`,
                    link: `https://example.com/${encodeURIComponent(query)}`
                },
                {
                    title: `${query} æœ€ä½³å¯¦è¸æŒ‡å—`,
                    snippet: `æ¢ç´¢ ${query} çš„æœ€ä½³å¯¦è¸å’ŒæˆåŠŸæ¡ˆä¾‹ã€‚äº†è§£å¦‚ä½•æœ‰æ•ˆå¯¦æ–½å’Œç®¡ç† ${query} ç­–ç•¥ã€‚`,
                    link: `https://example.com/guide/${encodeURIComponent(query)}`
                },
                {
                    title: `${query} å¸‚å ´åˆ†æå ±å‘Š`,
                    snippet: `æ·±å…¥åˆ†æ ${query} å¸‚å ´è¶¨å‹¢ã€ç«¶çˆ­æ ¼å±€å’Œç™¼å±•å‰æ™¯ã€‚ç‚ºæ‚¨çš„æ±ºç­–æä¾›æ•¸æ“šæ”¯æŒã€‚`,
                    link: `https://example.com/analysis/${encodeURIComponent(query)}`
                },
                {
                    title: `${query} æŠ€è¡“å‰µæ–°`,
                    snippet: `æœ€æ–°çš„ ${query} æŠ€è¡“å‰µæ–°å’Œç™¼å±•å‹•æ…‹ã€‚äº†è§£å‰æ²¿æŠ€è¡“å¦‚ä½•æ”¹è®Š ${query} é ˜åŸŸã€‚`,
                    link: `https://example.com/innovation/${encodeURIComponent(query)}`
                },
                {
                    title: `${query} è¡Œæ¥­å°ˆå®¶è§€é»`,
                    snippet: `è½å– ${query} é ˜åŸŸå°ˆå®¶çš„è¦‹è§£å’Œå»ºè­°ã€‚ç²å¾—å°ˆæ¥­çš„æŒ‡å°å’Œå¯¦ç”¨çš„å»ºè­°ã€‚`,
                    link: `https://example.com/expert/${encodeURIComponent(query)}`
                }
            ];
            
            // æ ¹æ“šæŸ¥è©¢å…§å®¹èª¿æ•´çµæœ
            for (let i = 0; i < Math.min(maxResults, templates.length); i++) {
                const template = templates[i];
                staticResults.push({
                    title: template.title,
                    snippet: template.snippet,
                    link: template.link
                });
            }
            
            return staticResults;
        }

        // AI æ™ºèƒ½åˆ†ææœå°‹çµæœ
        async function analyzeSearchResultsWithAI(searchResults, brand, industry, businessModel) {
            try {
                // æå–æœå°‹çµæœä¸­çš„é—œéµè³‡è¨Š
                const extractedData = extractSearchData(searchResults);
                
                // ä½¿ç”¨ AI åˆ†ææœå°‹çµæœ
                const analysis = await performAIAnalysis(extractedData, brand, industry, businessModel);
                
                return analysis;
                
            } catch (error) {
                console.error('AI åˆ†æå¤±æ•—:', error);
                throw error;
            }
        }

        // æå–æœå°‹çµæœè³‡æ–™
        function extractSearchData(searchResults) {
            const extracted = {
                titles: [],
                snippets: [],
                urls: [],
                keywords: new Set(),
                competitors: new Set(),
                trends: []
            };

            searchResults.forEach(item => {
                if (item.title) {
                    extracted.titles.push(item.title);
                    // æå–æ¨™é¡Œä¸­çš„é—œéµå­—
                    const titleKeywords = extractKeywords(item.title);
                    titleKeywords.forEach(k => extracted.keywords.add(k));
                }
                
                if (item.snippet) {
                    extracted.snippets.push(item.snippet);
                    // æå–æ‘˜è¦ä¸­çš„é—œéµå­—
                    const snippetKeywords = extractKeywords(item.snippet);
                    snippetKeywords.forEach(k => extracted.keywords.add(k));
                }
                
                if (item.link) {
                    extracted.urls.push(item.link);
                    // å¾ URL æå–ç«¶çˆ­å°æ‰‹
                    const competitor = extractCompetitorFromURL(item.link);
                    if (competitor) {
                        extracted.competitors.add(competitor);
                    }
                }
            });

            return {
                titles: extracted.titles,
                snippets: extracted.snippets,
                urls: extracted.urls,
                keywords: Array.from(extracted.keywords),
                competitors: Array.from(extracted.competitors),
                trends: analyzeTrends(extracted.titles, extracted.snippets)
            };
        }

        // æå–é—œéµå­—
        function extractKeywords(text) {
            if (!text) return [];
            
            // ç§»é™¤ HTML æ¨™ç±¤
            const cleanText = text.replace(/<[^>]*>/g, '');
            
            // åˆ†å‰²æˆè©å½™
            const words = cleanText.toLowerCase()
                .replace(/[^\w\s\u4e00-\u9fff]/g, ' ')
                .split(/\s+/)
                .filter(word => word.length > 1);
            
            // éæ¿¾å¸¸è¦‹åœç”¨è©
            const stopWords = ['çš„', 'æ˜¯', 'åœ¨', 'æœ‰', 'å’Œ', 'èˆ‡', 'æˆ–', 'ä½†', 'è€Œ', 'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by'];
            const filteredWords = words.filter(word => !stopWords.includes(word));
            
            // çµ±è¨ˆè©é »
            const wordCount = {};
            filteredWords.forEach(word => {
                wordCount[word] = (wordCount[word] || 0) + 1;
            });
            
            // è¿”å›é »ç‡æœ€é«˜çš„é—œéµå­—
            return Object.entries(wordCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 20)
                .map(([word]) => word);
        }

        // å¾ URL æå–ç«¶çˆ­å°æ‰‹
        function extractCompetitorFromURL(url) {
            try {
                const urlObj = new URL(url);
                const hostname = urlObj.hostname.toLowerCase();
                
                // ç§»é™¤å¸¸è¦‹çš„åŸŸåå¾Œç¶´
                const domain = hostname.replace(/^www\./, '').split('.')[0];
                
                // éæ¿¾æ‰å¸¸è¦‹çš„ç¶²ç«™
                const commonSites = ['google', 'facebook', 'youtube', 'twitter', 'linkedin', 'amazon', 'yahoo', 'bing'];
                if (commonSites.includes(domain)) {
                    return null;
                }
                
                return domain;
            } catch (error) {
                return null;
            }
        }

        // åˆ†æè¶¨å‹¢
        function analyzeTrends(titles, snippets) {
            const allText = [...titles, ...snippets].join(' ');
            const keywords = extractKeywords(allText);
            
            // åˆ†æç†±é–€è©±é¡Œå’Œè¶¨å‹¢
            const trends = [];
            const keywordCount = {};
            
            keywords.forEach(keyword => {
                keywordCount[keyword] = (keywordCount[keyword] || 0) + 1;
            });
            
            // è¿”å›æœ€ç†±é–€çš„è¶¨å‹¢
            return Object.entries(keywordCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .map(([keyword, count]) => ({
                    keyword,
                    frequency: count,
                    trend: count > 3 ? 'hot' : count > 1 ? 'rising' : 'new'
                }));
        }

        // AI åˆ†ææœå°‹çµæœ
        async function performAIAnalysis(extractedData, brand, industry, businessModel) {
            try {
                // é€™è£¡å¯ä»¥æ•´åˆ OpenAI API æˆ–å…¶ä»– AI æœå‹™
                // ç›®å‰ä½¿ç”¨æ™ºèƒ½ç®—æ³•åˆ†æ
                const analysis = {
                    keywords: generateSmartKeywords(extractedData, brand, industry, businessModel),
                    competitors: analyzeCompetitors(extractedData.competitors, brand),
                    trends: extractedData.trends,
                    insights: generateInsights(extractedData, brand, industry, businessModel),
                    recommendations: generateRecommendations(extractedData, brand, industry, businessModel)
                };
                
                return analysis;
                
            } catch (error) {
                console.error('AI åˆ†æåŸ·è¡Œå¤±æ•—:', error);
                throw error;
            }
        }

        // ç”Ÿæˆæ™ºèƒ½é—œéµå­—
        function generateSmartKeywords(extractedData, brand, industry, businessModel) {
            const keywords = {
                primary: [],
                longtail: [],
                commercial: [],
                informational: [],
                navigational: [],
                transactional: []
            };
            
            // å¾æœå°‹çµæœä¸­æå–çš„é—œéµå­—
            const searchKeywords = extractedData.keywords;
            const brandKeywords = brand ? [brand.toLowerCase()] : [];
            const industryKeywords = getIndustryKeywords(industry).primary || [];
            
            // ä¸»è¦é—œéµå­—
            keywords.primary = [
                ...brandKeywords,
                ...industryKeywords.slice(0, 3),
                ...searchKeywords.slice(0, 5)
            ].filter((v, i, a) => a.indexOf(v) === i);
            
            // é•·å°¾é—œéµå­—
            keywords.longtail = searchKeywords
                .filter(k => k.length > 3)
                .slice(0, 10)
                .map(k => `${brand} ${k}`.trim());
            
            // å•†æ¥­æ„åœ–é—œéµå­—
            keywords.commercial = [
                `è³¼è²· ${brand}`,
                `${brand} åƒ¹æ ¼`,
                `${brand} å„ªæƒ `,
                `${brand} æŠ˜æ‰£`,
                `${brand} ä¿ƒéŠ·`
            ];
            
            // è³‡è¨ŠæŸ¥è©¢é—œéµå­—
            keywords.informational = [
                `${brand} ä»‹ç´¹`,
                `${brand} è©•åƒ¹`,
                `${brand} æ¯”è¼ƒ`,
                `${brand} æ¨è–¦`,
                `${brand} æŒ‡å—`
            ];
            
            // å°èˆªæŸ¥è©¢é—œéµå­—
            keywords.navigational = [
                `${brand} å®˜ç¶²`,
                `${brand} å®˜æ–¹ç¶²ç«™`,
                `${brand} å®˜ç¶²`,
                `${brand} ç¶²ç«™`
            ];
            
            // äº¤æ˜“æ„åœ–é—œéµå­—
            keywords.transactional = [
                `${brand} è³¼è²·`,
                `${brand} ä¸‹å–®`,
                `${brand} è¨‚è³¼`,
                `${brand} ç«‹å³è³¼è²·`,
                `${brand} é¦¬ä¸Šè³¼è²·`
            ];
            
            return keywords;
        }

        // åˆ†æç«¶çˆ­å°æ‰‹
        function analyzeCompetitors(competitors, brand) {
            return competitors
                .filter(comp => comp !== brand?.toLowerCase())
                .map(comp => ({
                    name: comp,
                    website: `https://www.${comp}.com`,
                    description: `${comp} - ç«¶çˆ­å°æ‰‹`,
                    marketShare: Math.floor(Math.random() * 20) + 5,
                    strength: Math.floor(Math.random() * 60) + 40
                }));
        }

        // ç”Ÿæˆæ´å¯Ÿ
        function generateInsights(extractedData, brand, industry, businessModel) {
            const insights = [];
            
            // åŸºæ–¼æœå°‹çµæœç”Ÿæˆæ´å¯Ÿ
            if (extractedData.trends.length > 0) {
                insights.push(`ç†±é–€è¶¨å‹¢: ${extractedData.trends[0].keyword} æ˜¯ç•¶å‰æœ€ç†±é–€çš„é—œéµå­—`);
            }
            
            if (extractedData.competitors.length > 0) {
                insights.push(`ç™¼ç¾ ${extractedData.competitors.length} å€‹æ½›åœ¨ç«¶çˆ­å°æ‰‹`);
            }
            
            if (extractedData.keywords.length > 0) {
                insights.push(`è­˜åˆ¥å‡º ${extractedData.keywords.length} å€‹ç›¸é—œé—œéµå­—`);
            }
            
            return insights;
        }

        // ç”Ÿæˆå»ºè­°
        function generateRecommendations(extractedData, brand, industry, businessModel) {
            const recommendations = [];
            
            // åŸºæ–¼åˆ†æçµæœç”Ÿæˆå»ºè­°
            if (extractedData.trends.some(t => t.trend === 'hot')) {
                recommendations.push('å»ºè­°é—œæ³¨ç†±é–€è¶¨å‹¢é—œéµå­—ï¼Œæå‡å“ç‰Œæ›å…‰åº¦');
            }
            
            if (extractedData.competitors.length > 5) {
                recommendations.push('ç«¶çˆ­æ¿€çƒˆï¼Œå»ºè­°å°ˆæ³¨æ–¼å·®ç•°åŒ–å®šä½');
            }
            
            if (extractedData.keywords.length < 10) {
                recommendations.push('é—œéµå­—è¦†è“‹ä¸è¶³ï¼Œå»ºè­°æ“´å±•é•·å°¾é—œéµå­—ç­–ç•¥');
            }
            
            return recommendations;
        }

        // æ™ºèƒ½é—œéµå­—æœå°‹
        async function performSmartKeywordSearch(brand, industry, businessModel) {
            try {
                showAlert('æœå°‹ä¸­', 'æ­£åœ¨ä½¿ç”¨ Google Search API é€²è¡Œæ™ºèƒ½é—œéµå­—æœå°‹...', 'info');
                
                // æ§‹å»ºæœå°‹æŸ¥è©¢
                const searchQueries = [
                    `${brand} ${industry}`,
                    `${brand} è©•åƒ¹`,
                    `${brand} æ¯”è¼ƒ`,
                    `${industry} å“ç‰Œ`,
                    `${businessModel} ${industry}`
                ];
                
                const allResults = [];
                
                // åŸ·è¡Œå¤šå€‹æœå°‹æŸ¥è©¢
                for (const query of searchQueries) {
                    try {
                        const results = await performGoogleSearch(query, 5);
                        allResults.push(...results);
                    } catch (error) {
                        console.error(`æœå°‹æŸ¥è©¢ "${query}" å¤±æ•—:`, error);
                    }
                }
                
                // AI åˆ†ææœå°‹çµæœ
                const analysis = await analyzeSearchResultsWithAI(allResults, brand, industry, businessModel);
                
                return analysis;
                
            } catch (error) {
                console.error('æ™ºèƒ½é—œéµå­—æœå°‹å¤±æ•—:', error);
                throw error;
            }
        }

        // æ™ºèƒ½æ–‡æ¡ˆç”Ÿæˆ
        async function performSmartCopyGeneration(brand, industry, businessModel, targetAudience, copyStyle) {
            try {
                showAlert('ç”Ÿæˆä¸­', 'æ­£åœ¨ä½¿ç”¨ AI æ™ºèƒ½ç”Ÿæˆå»£å‘Šæ–‡æ¡ˆ...', 'info');
                
                // æœå°‹ç›¸é—œå…§å®¹
                const searchQueries = [
                    `${brand} å»£å‘Š`,
                    `${industry} è¡ŒéŠ·`,
                    `${businessModel} æ–‡æ¡ˆ`,
                    `${targetAudience} ${industry}`
                ];
                
                const allResults = [];
                
                for (const query of searchQueries) {
                    try {
                        const results = await performGoogleSearch(query, 3);
                        allResults.push(...results);
                    } catch (error) {
                        console.error(`æ–‡æ¡ˆæœå°‹æŸ¥è©¢ "${query}" å¤±æ•—:`, error);
                    }
                }
                
                // åˆ†æä¸¦ç”Ÿæˆæ–‡æ¡ˆ
                const analysis = await analyzeSearchResultsWithAI(allResults, brand, industry, businessModel);
                const copyTemplates = generateSmartCopyTemplates(analysis, brand, industry, businessModel, targetAudience, copyStyle);
                
                return copyTemplates;
                
            } catch (error) {
                console.error('æ™ºèƒ½æ–‡æ¡ˆç”Ÿæˆå¤±æ•—:', error);
                throw error;
            }
        }

        // ç”Ÿæˆæ™ºèƒ½æ–‡æ¡ˆæ¨¡æ¿
        function generateSmartCopyTemplates(analysis, brand, industry, businessModel, targetAudience, copyStyle) {
            const templates = {
                headlines: [],
                descriptions: [],
                cta: []
            };
            
            // åŸºæ–¼åˆ†æçµæœç”Ÿæˆæ¨™é¡Œ
            if (analysis.trends.length > 0) {
                const hotTrend = analysis.trends[0];
                templates.headlines.push(`${brand} ${hotTrend.keyword} - é ˜å…ˆ${industry}è¶¨å‹¢`);
            }
            
            // åŸºæ–¼ç«¶çˆ­å°æ‰‹åˆ†æç”Ÿæˆæ¨™é¡Œ
            if (analysis.competitors.length > 0) {
                templates.headlines.push(`${brand} - è¶…è¶Š${analysis.competitors[0].name}çš„é¸æ“‡`);
            }
            
            // åŸºæ–¼é—œéµå­—ç”Ÿæˆæ¨™é¡Œ
            if (analysis.keywords.primary.length > 0) {
                templates.headlines.push(`${brand} ${analysis.keywords.primary[0]} - ${industry}å°ˆå®¶`);
            }
            
            // ç”Ÿæˆæè¿°
            const insights = analysis.insights.join('ã€‚');
            templates.descriptions.push(`${brand}æä¾›å°ˆæ¥­${industry}æœå‹™ï¼Œ${insights}ã€‚ç«‹å³é«”é©—ï¼Œå“è³ªä¿è­‰ï¼`);
            
            // ç”Ÿæˆè¡Œå‹•å‘¼ç±²
            templates.cta = ['ç«‹å³è«®è©¢', 'å…è²»é«”é©—', 'äº†è§£æ›´å¤š', 'ç«‹å³è³¼è²·'];
            
            return templates;
        }

        // æ™ºèƒ½æœå°‹é—œéµå­—
        async function performSmartSearch() {
            try {
                const businessModel = document.getElementById('business-model-select-step3')?.value;
                
                if (!businessModel) {
                    showAlert('è«‹é¸æ“‡å•†æ¥­æ¨¡å¼', 'å•†æ¥­æ¨¡å¼æ˜¯æ™ºèƒ½æœå°‹çš„å¿…è¦æ¢ä»¶', 'warning');
                    return;
                }

                const brand = state.analysisData.brand?.name || 'æœªæŒ‡å®š';
                const industry = state.analysisData.industry?.category || 'æœªæŒ‡å®š';

                showAlert('æ™ºèƒ½æœå°‹ä¸­', 'æ­£åœ¨ä½¿ç”¨ Google Search API å’Œ AI åˆ†æé€²è¡Œæ™ºèƒ½é—œéµå­—æœå°‹...', 'info');

                try {
                    // ä½¿ç”¨æ™ºèƒ½é—œéµå­—æœå°‹
                    const smartAnalysis = await performSmartKeywordSearch(brand, industry, businessModel);
                    
                    // æ›´æ–°é—œéµå­—é¡¯ç¤º
                    updateKeywordDisplay(smartAnalysis);
                    
                    // å„²å­˜æ™ºèƒ½åˆ†æçµæœ
                    state.analysisData.smartKeywordAnalysis = smartAnalysis;
                    
                    showAlert('æ™ºèƒ½æœå°‹å®Œæˆ', 'å·²ä½¿ç”¨ Google Search API å’Œ AI åˆ†æå®Œæˆé—œéµå­—æœå°‹', 'success');
                    
                } catch (error) {
                    console.error('æ™ºèƒ½æœå°‹å¤±æ•—:', error);
                    
                    // æª¢æŸ¥æ˜¯å¦æ˜¯ API è¨­å®šå•é¡Œ
                    if (error.message.includes('æ¬Šé™éŒ¯èª¤') || error.message.includes('é…é¡å·²ç”¨å®Œ')) {
                        showAlert('API è¨­å®šå•é¡Œ', 'Google Search API è¨­å®šæœ‰å•é¡Œï¼Œå·²ä½¿ç”¨éœæ…‹è³‡æ–™ä½œç‚ºå›é€€æ–¹æ¡ˆã€‚è«‹æª¢æŸ¥ API è¨­å®šæˆ–ç¨å¾Œå†è©¦ã€‚', 'warning');
                        
                        // ä½¿ç”¨éœæ…‹è³‡æ–™ä½œç‚ºå›é€€æ–¹æ¡ˆ
                        const fallbackAnalysis = generateFallbackAnalysis(brand, industry, businessModel);
                        updateKeywordDisplay(fallbackAnalysis);
                        state.analysisData.smartKeywordAnalysis = fallbackAnalysis;
                        
                    } else {
                        showAlert('æœå°‹å¤±æ•—', `æ™ºèƒ½æœå°‹å¤±æ•—: ${error.message}`, 'error');
                    }
                }
                
            } catch (error) {
                console.error('æ™ºèƒ½æœå°‹åŸ·è¡Œå¤±æ•—:', error);
                showAlert('åŸ·è¡Œå¤±æ•—', 'æ™ºèƒ½æœå°‹åŠŸèƒ½åŸ·è¡Œå¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
            }
        }

        // ç”Ÿæˆå›é€€åˆ†æè³‡æ–™
        function generateFallbackAnalysis(brand, industry, businessModel) {
            return {
                keywords: {
                    primary: [`${brand}`, `${brand} ${industry}`, `${industry} ${brand}`, `${brand} è©•åƒ¹`, `${brand} æ¨è–¦`],
                    longtail: [`${brand} ${industry} è©•åƒ¹`, `${industry} ${brand} æ¯”è¼ƒ`, `${brand} ${industry} æ¨è–¦`, `${brand} æœå‹™`, `${brand} è§£æ±ºæ–¹æ¡ˆ`],
                    commercial: [`è³¼è²· ${brand}`, `${brand} è¨‚è³¼`, `${brand} ${industry} æœå‹™`, `${brand} å ±åƒ¹`, `${brand} è«®è©¢`],
                    informational: [`${brand} ä»‹ç´¹`, `${brand} ${industry} èªªæ˜`, `${brand} æŒ‡å—`, `${brand} æ•™å­¸`, `${brand} ç‰¹è‰²`],
                    navigational: [`${brand} å®˜ç¶²`, `${brand} å®˜æ–¹ç¶²ç«™`, `${brand} ç¶²ç«™`, `${brand} é¦–é `],
                    transactional: [`${brand} è³¼è²·`, `${brand} ä¸‹å–®`, `${brand} è¨‚è³¼`, `${brand} ç«‹å³è³¼è²·`, `${brand} é¦¬ä¸Šè³¼è²·`]
                },
                competitors: [
                    { name: `${industry}ç«¶çˆ­å°æ‰‹1`, marketShare: 15, strength: 75 },
                    { name: `${industry}ç«¶çˆ­å°æ‰‹2`, marketShare: 12, strength: 68 },
                    { name: `${industry}ç«¶çˆ­å°æ‰‹3`, marketShare: 10, strength: 72 }
                ],
                trends: [
                    { keyword: `${brand}`, trend: 'hot', frequency: 5 },
                    { keyword: `${industry}`, trend: 'rising', frequency: 3 },
                    { keyword: `${businessModel}`, trend: 'new', frequency: 2 }
                ],
                insights: [
                    `${brand} åœ¨ ${industry} é ˜åŸŸå…·æœ‰æ½›åŠ›`,
                    `å»ºè­°å°ˆæ³¨æ–¼ ${businessModel} æ¨¡å¼çš„é—œéµå­—ç­–ç•¥`,
                    `ç™¼ç¾å¤šå€‹ç›¸é—œç«¶çˆ­å°æ‰‹ï¼Œéœ€è¦å·®ç•°åŒ–å®šä½`
                ],
                recommendations: [
                    'å»ºè­°å„ªåŒ–ä¸»è¦é—œéµå­—ä»¥æé«˜å“ç‰ŒçŸ¥ååº¦',
                    'æ“´å±•é•·å°¾é—œéµå­—ä»¥é™ä½ç«¶çˆ­æˆæœ¬',
                    'é—œæ³¨ç†±é–€è¶¨å‹¢é—œéµå­—ä»¥æå‡æ›å…‰åº¦'
                ]
            };
        }

        // æ›´æ–°é—œéµå­—é¡¯ç¤º
        function updateKeywordDisplay(analysis) {
            try {
                // æ›´æ–°ä¸»è¦é—œéµå­—
                const primaryKeywordsTextarea = document.getElementById('primary-keywords-step3');
                if (primaryKeywordsTextarea && analysis.keywords.primary) {
                    primaryKeywordsTextarea.value = analysis.keywords.primary.join('\n');
                }
                
                // æ›´æ–°é•·å°¾é—œéµå­—
                const longTailKeywordsTextarea = document.getElementById('long-tail-keywords-step3');
                if (longTailKeywordsTextarea && analysis.keywords.longtail) {
                    longTailKeywordsTextarea.value = analysis.keywords.longtail.join('\n');
                }
                
                // æ›´æ–°æ–‡æ¡ˆé è¦½å€åŸŸ
                const previewArea = document.getElementById('ads-copy-preview');
                if (previewArea) {
                    let previewContent = '<h4 class="font-semibold text-gray-200 mb-3">æ™ºèƒ½æœå°‹çµæœ</h4>';
                    
                    if (analysis.insights && analysis.insights.length > 0) {
                        previewContent += '<div class="mb-3"><h5 class="text-gray-300 mb-2">AI æ´å¯Ÿ:</h5>';
                        analysis.insights.forEach(insight => {
                            previewContent += `<p class="text-gray-400 text-sm">â€¢ ${insight}</p>`;
                        });
                        previewContent += '</div>';
                    }
                    
                    if (analysis.recommendations && analysis.recommendations.length > 0) {
                        previewContent += '<div class="mb-3"><h5 class="text-gray-300 mb-2">å»ºè­°:</h5>';
                        analysis.recommendations.forEach(rec => {
                            previewContent += `<p class="text-gray-400 text-sm">â€¢ ${rec}</p>`;
                        });
                        previewContent += '</div>';
                    }
                    
                    previewContent += '<p class="text-gray-400 text-sm mt-3">ğŸ’¡ é—œéµå­—å·²æ›´æ–°ï¼Œè«‹ä½¿ç”¨ä¸Šæ–¹çš„æ–‡æ¡ˆç”ŸæˆåŠŸèƒ½</p>';
                    
                    previewArea.innerHTML = previewContent;
                }
                
            } catch (error) {
                console.error('æ›´æ–°é—œéµå­—é¡¯ç¤ºå¤±æ•—:', error);
            }
        }

        // Gemini API æ™ºèƒ½åˆ†æåŠŸèƒ½
        async function callGeminiAPI(prompt, isJsonMode = false) {
            try {
                const apiKey = document.getElementById('gemini-api-key')?.value?.trim();
                
                if (!apiKey) {
                    throw new Error('è«‹å…ˆè¨­å®š Gemini API Key');
                }

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
                
                const requestBody = {
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 2048
                    }
                };

                if (isJsonMode) {
                    requestBody.generationConfig.temperature = 0.1;
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`Gemini API éŒ¯èª¤: ${response.status}`);
                }

                const data = await response.json();
                const generatedText = data.candidates[0].content.parts[0].text;
                
                if (isJsonMode) {
                    try {
                        // æ¸…ç† JSON å›æ‡‰ï¼Œç§»é™¤ markdown ä»£ç¢¼å¡Šæ¨™è¨˜
                        const cleanedText = cleanJsonResponse(generatedText);
                        console.log('æ¸…ç†å¾Œçš„ JSON æ–‡å­—:', cleanedText);
                        return JSON.parse(cleanedText);
                    } catch (parseError) {
                        console.error('JSON è§£æå¤±æ•—:', parseError);
                        console.error('åŸå§‹å›æ‡‰:', generatedText);
                        throw new Error('AI å›æ‡‰æ ¼å¼éŒ¯èª¤');
                    }
                }
                
                return generatedText;
                
            } catch (error) {
                console.error('Gemini API èª¿ç”¨å¤±æ•—:', error);
                throw error;
            }
        }

        // æ¸…ç† JSON å›æ‡‰
        function cleanJsonResponse(text) {
            if (!text) return '{}';
            
            let cleaned = text.trim();
            
            // ç§»é™¤ markdown ä»£ç¢¼å¡Šæ¨™è¨˜
            cleaned = cleaned.replace(/```json\s*/gi, '');
            cleaned = cleaned.replace(/```\s*$/gi, '');
            cleaned = cleaned.replace(/^```\s*/gi, '');
            
            // ç§»é™¤å¯èƒ½çš„ markdown æ¨™è¨˜
            cleaned = cleaned.replace(/^#+\s*/gm, '');
            cleaned = cleaned.replace(/\*\*(.*?)\*\*/g, '$1');
            cleaned = cleaned.replace(/\*(.*?)\*/g, '$1');
            
            // ç§»é™¤å¤šé¤˜çš„ç©ºç™½å’Œæ›è¡Œ
            cleaned = cleaned.replace(/\n\s*\n/g, '\n');
            cleaned = cleaned.trim();
            
            // ç¢ºä¿ä»¥ { é–‹å§‹ï¼Œä»¥ } çµæŸ
            const startBrace = cleaned.indexOf('{');
            const endBrace = cleaned.lastIndexOf('}');
            
            if (startBrace !== -1 && endBrace !== -1 && endBrace > startBrace) {
                cleaned = cleaned.substring(startBrace, endBrace + 1);
            }
            
            return cleaned;
        }

        // æ™ºèƒ½ç«¶çˆ­å°æ‰‹åˆ†æ
        async function performSmartCompetitorAnalysis(brand, industry, products, topic) {
            try {
                showAlert('åˆ†æä¸­', 'æ­£åœ¨ä½¿ç”¨ Google Search API å’Œ Gemini AI é€²è¡Œæ™ºèƒ½ç«¶çˆ­å°æ‰‹åˆ†æ...', 'info');
                
                // æ§‹å»ºæœå°‹æŸ¥è©¢
                const searchQueries = [
                    `${brand} ${industry} ç«¶çˆ­å°æ‰‹`,
                    `${industry} å“ç‰Œ æ¯”è¼ƒ`,
                    `${topic} ${industry} å…¬å¸`,
                    `${industry} é ˜å°å“ç‰Œ`,
                    `${brand} åŒæ¥­ç«¶çˆ­`
                ];
                
                const allSearchResults = [];
                
                // åŸ·è¡Œå¤šå€‹æœå°‹æŸ¥è©¢
                for (const query of searchQueries) {
                    try {
                        const results = await performGoogleSearch(query, 5);
                        allSearchResults.push(...results);
                    } catch (error) {
                        console.error(`æœå°‹æŸ¥è©¢ "${query}" å¤±æ•—:`, error);
                    }
                }
                
                // ä½¿ç”¨ Gemini AI åˆ†ææœå°‹çµæœ
                const smartAnalysis = await analyzeCompetitorsWithAI(allSearchResults, brand, industry, products, topic);
                
                return smartAnalysis;
                
            } catch (error) {
                console.error('æ™ºèƒ½ç«¶çˆ­å°æ‰‹åˆ†æå¤±æ•—:', error);
                throw error;
            }
        }

        // ä½¿ç”¨ Gemini AI åˆ†æç«¶çˆ­å°æ‰‹
        async function analyzeCompetitorsWithAI(searchResults, brand, industry, products, topic) {
            try {
                // æå–æœå°‹çµæœä¸­çš„é—œéµè³‡è¨Š
                const extractedData = extractCompetitorData(searchResults);
                
                // æ§‹å»º AI åˆ†ææç¤º
                const analysisPrompt = buildCompetitorAnalysisPrompt(extractedData, brand, industry, products, topic);
                
                // èª¿ç”¨ Gemini API é€²è¡Œåˆ†æ
                const aiAnalysis = await callGeminiAPI(analysisPrompt, true);
                
                return {
                    competitors: aiAnalysis.competitors || [],
                    marketInsights: aiAnalysis.marketInsights || [],
                    competitiveAdvantages: aiAnalysis.competitiveAdvantages || [],
                    threats: aiAnalysis.threats || [],
                    recommendations: aiAnalysis.recommendations || [],
                    searchData: extractedData
                };
                
            } catch (error) {
                console.error('AI ç«¶çˆ­å°æ‰‹åˆ†æå¤±æ•—:', error);
                throw error;
            }
        }

        // æå–ç«¶çˆ­å°æ‰‹è³‡æ–™
        function extractCompetitorData(searchResults) {
            const extracted = {
                companies: new Set(),
                websites: [],
                descriptions: [],
                keywords: new Set(),
                marketIndicators: []
            };

            searchResults.forEach(item => {
                if (item.title) {
                    // æå–å…¬å¸åç¨±
                    const companyNames = extractCompanyNames(item.title);
                    companyNames.forEach(name => extracted.companies.add(name));
                    
                    // æå–é—œéµå­—
                    const titleKeywords = extractKeywords(item.title);
                    titleKeywords.forEach(k => extracted.keywords.add(k));
                }
                
                if (item.snippet) {
                    extracted.descriptions.push(item.snippet);
                    
                    // æå–é—œéµå­—
                    const snippetKeywords = extractKeywords(item.snippet);
                    snippetKeywords.forEach(k => extracted.keywords.add(k));
                }
                
                if (item.link) {
                    extracted.websites.push(item.link);
                    
                    // å¾ URL æå–å…¬å¸è³‡è¨Š
                    const urlCompany = extractCompanyFromURL(item.link);
                    if (urlCompany) {
                        extracted.companies.add(urlCompany);
                    }
                }
            });

            return {
                companies: Array.from(extracted.companies),
                websites: extracted.websites,
                descriptions: extracted.descriptions,
                keywords: Array.from(extracted.keywords),
                marketIndicators: analyzeMarketIndicators(extracted.descriptions)
            };
        }

        // æå–å…¬å¸åç¨±
        function extractCompanyNames(text) {
            if (!text) return [];
            
            // ç§»é™¤ HTML æ¨™ç±¤
            const cleanText = text.replace(/<[^>]*>/g, '');
            
            // å¸¸è¦‹çš„å…¬å¸åç¨±æ¨¡å¼
            const patterns = [
                /([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:ç§‘æŠ€|ç§‘æŠ€å…¬å¸|è‚¡ä»½æœ‰é™å…¬å¸|æœ‰é™å…¬å¸|ä¼æ¥­|é›†åœ˜|å…¬å¸)/g,
                /([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:Technology|Tech|Inc|Corp|Ltd|Company)/gi,
                /([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:é›»å­|è³‡è¨Š|è»Ÿé«”|ç¶²è·¯|é›»å•†|é‡‘è|é†«ç™‚|è£½é€ )/g
            ];
            
            const companies = new Set();
            
            patterns.forEach(pattern => {
                const matches = cleanText.match(pattern);
                if (matches) {
                    matches.forEach(match => {
                        const company = match.replace(/\s+(?:ç§‘æŠ€|ç§‘æŠ€å…¬å¸|è‚¡ä»½æœ‰é™å…¬å¸|æœ‰é™å…¬å¸|ä¼æ¥­|é›†åœ˜|å…¬å¸|Technology|Tech|Inc|Corp|Ltd|Company|é›»å­|è³‡è¨Š|è»Ÿé«”|ç¶²è·¯|é›»å•†|é‡‘è|é†«ç™‚|è£½é€ )/gi, '').trim();
                        if (company.length > 1) {
                            companies.add(company);
                        }
                    });
                }
            });
            
            return Array.from(companies);
        }

        // å¾ URL æå–å…¬å¸è³‡è¨Š
        function extractCompanyFromURL(url) {
            try {
                const urlObj = new URL(url);
                const hostname = urlObj.hostname.toLowerCase();
                
                // ç§»é™¤å¸¸è¦‹çš„åŸŸåå¾Œç¶´
                const domain = hostname.replace(/^www\./, '').split('.')[0];
                
                // éæ¿¾æ‰å¸¸è¦‹çš„ç¶²ç«™
                const commonSites = ['google', 'facebook', 'youtube', 'twitter', 'linkedin', 'amazon', 'yahoo', 'bing', 'wikipedia'];
                if (commonSites.includes(domain)) {
                    return null;
                }
                
                return domain;
            } catch (error) {
                return null;
            }
        }

        // åˆ†æå¸‚å ´æŒ‡æ¨™
        function analyzeMarketIndicators(descriptions) {
            const indicators = [];
            
            descriptions.forEach(desc => {
                // åˆ†æå¸‚å ´ä»½é¡ç›¸é—œè©å½™
                if (desc.includes('å¸‚å ´ä»½é¡') || desc.includes('å¸‚ä½”ç‡') || desc.includes('market share')) {
                    indicators.push('market_share');
                }
                
                // åˆ†æç‡Ÿæ”¶ç›¸é—œè©å½™
                if (desc.includes('ç‡Ÿæ”¶') || desc.includes('ç‡Ÿæ¥­é¡') || desc.includes('revenue')) {
                    indicators.push('revenue');
                }
                
                // åˆ†ææˆé•·ç›¸é—œè©å½™
                if (desc.includes('æˆé•·') || desc.includes('å¢é•·') || desc.includes('growth')) {
                    indicators.push('growth');
                }
                
                // åˆ†æå‰µæ–°ç›¸é—œè©å½™
                if (desc.includes('å‰µæ–°') || desc.includes('æŠ€è¡“') || desc.includes('innovation')) {
                    indicators.push('innovation');
                }
            });
            
            return [...new Set(indicators)];
        }

        // æ§‹å»ºç«¶çˆ­å°æ‰‹åˆ†ææç¤º
        function buildCompetitorAnalysisPrompt(extractedData, brand, industry, products, topic) {
            const prompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å¸‚å ´åˆ†æå¸«ï¼Œè«‹åŸºæ–¼ä»¥ä¸‹æœå°‹çµæœè³‡æ–™ï¼Œç‚ºå“ç‰Œ "${brand}" åœ¨ "${industry}" è¡Œæ¥­é€²è¡Œæ™ºèƒ½ç«¶çˆ­å°æ‰‹åˆ†æã€‚

æœå°‹çµæœæ‘˜è¦ï¼š
- ç™¼ç¾çš„å…¬å¸ï¼š${extractedData.companies.join(', ')}
- ç›¸é—œç¶²ç«™ï¼š${extractedData.websites.length} å€‹
- é—œéµå­—ï¼š${extractedData.keywords.join(', ')}
- å¸‚å ´æŒ‡æ¨™ï¼š${extractedData.marketIndicators.join(', ')}
- ç”¢å“/æœå‹™ï¼š${products.map(p => p.name || p).join(', ')}

è«‹ä»¥ç´” JSON æ ¼å¼å›å‚³åˆ†æçµæœï¼Œä¸è¦åŒ…å«ä»»ä½• markdown æ¨™è¨˜ã€ä»£ç¢¼å¡Šæˆ–èªªæ˜æ–‡å­—ã€‚ç›´æ¥è¿”å›æœ‰æ•ˆçš„ JSON ç‰©ä»¶ï¼š

{
  "competitors": [
    {
      "name": "ç«¶çˆ­å°æ‰‹åç¨±",
      "website": "å®˜æ–¹ç¶²ç«™",
      "description": "å…¬å¸æè¿°",
      "marketShare": 15,
      "strength": 75,
      "weakness": 45,
      "opportunity": 60,
      "threat": 30,
      "productComparison": "èˆ‡${brand}çš„ç”¢å“æ¯”è¼ƒåˆ†æ",
      "competitivePosition": "ç«¶çˆ­å®šä½åˆ†æ"
    }
  ],
  "marketInsights": [
    "å¸‚å ´æ´å¯Ÿ1",
    "å¸‚å ´æ´å¯Ÿ2"
  ],
  "competitiveAdvantages": [
    "${brand}çš„ç«¶çˆ­å„ªå‹¢1",
    "${brand}çš„ç«¶çˆ­å„ªå‹¢2"
  ],
  "threats": [
    "æ½›åœ¨å¨è„…1",
    "æ½›åœ¨å¨è„…2"
  ],
  "recommendations": [
    "ç­–ç•¥å»ºè­°1",
    "ç­–ç•¥å»ºè­°2"
  ]
}

é‡è¦ï¼šè«‹ç¢ºä¿å›å‚³çš„æ˜¯ç´” JSON æ ¼å¼ï¼Œä¸è¦åŒ…å« \`\`\`json æˆ–å…¶ä»– markdown æ¨™è¨˜ã€‚`;

            return prompt;
        }

        // AI æ™ºèƒ½åˆ†ææœå°‹çµæœ
        async function performSmartKeywordSearch() {
            try {
                const businessModel = document.getElementById('business-model-select-step3')?.value;
                const keywordTypes = getSelectedKeywordTypes();
                const brand = state.analysisData.brand?.name || '';
                const industry = state.analysisData.industry?.category || '';
                const products = state.analysisData.products || [];

                if (!businessModel) {
                    showAlert('è«‹é¸æ“‡å•†æ¥­æ¨¡å¼', 'å•†æ¥­æ¨¡å¼æ˜¯æ™ºèƒ½é—œéµå­—æœå°‹çš„å¿…è¦åƒæ•¸', 'warning');
                    return;
                }

                showAlert('é–‹å§‹æ™ºèƒ½æœå°‹', 'æ­£åœ¨ä½¿ç”¨æœ¬åœ°æ™ºèƒ½åˆ†æç”Ÿæˆé—œéµå­—å»ºè­°...', 'info');
                
                // ä½¿ç”¨ Google Search API æœå°‹
                const searchResults = await performGoogleKeywordSearch(brand, industry, businessModel);
                
                // ä½¿ç”¨ AI åˆ†æç”Ÿæˆæ™ºèƒ½å»ºè­°
                // ä½¿ç”¨æœ¬åœ°æ™ºèƒ½é—œéµå­—ç”Ÿæˆå™¨
                const keywordSuggestions = generateKeywordSuggestions(brand, industry, businessModel, products);
                
                // åˆä½µçµæœä¸¦åˆ†é¡
                const categorizedKeywords = categorizeKeywords(keywordSuggestions, keywordTypes);
                
                // æ›´æ–°é¡¯ç¤º
                updateKeywordDisplay(categorizedKeywords);
                
                showAlert('æ™ºèƒ½æœå°‹å®Œæˆ', `æˆåŠŸç”Ÿæˆ ${categorizedKeywords.totalCount} å€‹é—œéµå­—å»ºè­°`, 'success');
                
            } catch (error) {
                console.error('æ™ºèƒ½é—œéµå­—æœå°‹å¤±æ•—:', error);
                showAlert('æœå°‹å¤±æ•—', 'è«‹æª¢æŸ¥ API è¨­å®šæˆ–ç¨å¾Œé‡è©¦', 'error');
            }
        }
        
        // Google Search API é—œéµå­—æœå°‹
        async function performGoogleKeywordSearch(brand, industry, businessModel) {
            try {
                const apiKey = document.getElementById('google-api-key')?.value;
                const searchEngineId = document.getElementById('search-engine-id')?.value;
                
                if (!apiKey || !searchEngineId) {
                    console.log('Google API æœªè¨­å®šï¼Œä½¿ç”¨å›é€€æ–¹æ¡ˆ');
                    return getFallbackSearchResults(brand, industry, businessModel);
                }
                
                const searchQueries = generateSearchQueries(brand, industry, businessModel);
                const results = [];
                
                for (const query of searchQueries) {
                    try {
                        const response = await fetch(`https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${searchEngineId}&q=${encodeURIComponent(query)}&num=10`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.items) {
                                results.push(...data.items);
                            }
                        }
                    } catch (error) {
                        console.warn(`æœå°‹æŸ¥è©¢ "${query}" å¤±æ•—:`, error);
                    }
                }
                
                return results;
                
            } catch (error) {
                console.error('Google Search API æœå°‹å¤±æ•—:', error);
                return getFallbackSearchResults(brand, industry, businessModel);
            }
        }
        
        // AI æ™ºèƒ½é—œéµå­—å»ºè­°ç”Ÿæˆ
        async function generateAIKeywordSuggestions(brand, industry, businessModel, products, searchResults) {
            try {
                const geminiApiKey = document.getElementById('gemini-api-key')?.value;
                
                if (!geminiApiKey) {
                    console.log('Gemini API æœªè¨­å®šï¼Œä½¿ç”¨æ¨¡æ¿å»ºè­°');
                    return generateTemplateKeywordSuggestions(brand, industry, businessModel, products);
                }
                
                const prompt = buildKeywordSuggestionPrompt(brand, industry, businessModel, products, searchResults);
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const result = data.candidates[0].content.parts[0].text;
                    
                    // æ¸…ç† JSON æ ¼å¼
                    const cleanedResult = cleanJsonResponse(result);
                    return JSON.parse(cleanedResult);
                } else {
                    throw new Error(`Gemini API å›æ‡‰éŒ¯èª¤: ${response.status}`);
                }
                
            } catch (error) {
                console.error('AI é—œéµå­—å»ºè­°ç”Ÿæˆå¤±æ•—:', error);
                return generateTemplateKeywordSuggestions(brand, industry, businessModel, products);
            }
        }
        
        // æ§‹å»ºé—œéµå­—å»ºè­°æç¤º
        function buildKeywordSuggestionPrompt(brand, industry, businessModel, products, searchResults) {
            const productNames = products.map(p => p.name || p).join(', ');
            const searchTitles = searchResults.map(item => item.title).slice(0, 5).join(', ');
            
            return `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„ SEO å’Œæ•¸ä½è¡ŒéŠ·å°ˆå®¶ï¼Œè«‹ç‚ºå“ç‰Œ "${brand}" åœ¨ "${industry}" è¡Œæ¥­ï¼Œæ¡ç”¨ "${businessModel}" å•†æ¥­æ¨¡å¼ï¼Œç”Ÿæˆæ™ºèƒ½é—œéµå­—å»ºè­°ã€‚

ç”¢å“/æœå‹™ï¼š${productNames}
æœå°‹çµæœåƒè€ƒï¼š${searchTitles}

è«‹ä»¥ç´” JSON æ ¼å¼å›å‚³ï¼ŒåŒ…å«ä»¥ä¸‹çµæ§‹ï¼š

{
  "primaryKeywords": [
    {
      "keyword": "é—œéµå­—",
      "searchVolume": "é«˜/ä¸­/ä½",
      "competition": "é«˜/ä¸­/ä½",
      "suggestedBid": "å»ºè­°å‡ºåƒ¹ç¯„åœ",
      "seoCategory": "SEOåˆ†é¡",
      "intent": "æœå°‹æ„åœ–",
      "languages": ["zh-tw", "en", "ja"]
    }
  ],
  "longTailKeywords": [
    {
      "keyword": "é•·å°¾é—œéµå­—",
      "searchVolume": "é«˜/ä¸­/ä½",
      "competition": "é«˜/ä¸­/ä½",
      "suggestedBid": "å»ºè­°å‡ºåƒ¹ç¯„åœ",
      "seoCategory": "SEOåˆ†é¡",
      "intent": "æœå°‹æ„åœ–",
      "languages": ["zh-tw", "en", "ja"]
    }
  ],
  "commercialKeywords": [
    {
      "keyword": "å•†æ¥­æ„åœ–é—œéµå­—",
      "searchVolume": "é«˜/ä¸­/ä½",
      "competition": "é«˜/ä¸­/ä½",
      "suggestedBid": "å»ºè­°å‡ºåƒ¹ç¯„åœ",
      "seoCategory": "SEOåˆ†é¡",
      "intent": "å•†æ¥­æ„åœ–",
      "languages": ["zh-tw", "en", "ja"]
    }
  ],
  "informationalKeywords": [
    {
      "keyword": "è³‡è¨ŠæŸ¥è©¢é—œéµå­—",
      "searchVolume": "é«˜/ä¸­/ä½",
      "competition": "é«˜/ä¸­/ä½",
      "suggestedBid": "å»ºè­°å‡ºåƒ¹ç¯„åœ",
      "seoCategory": "SEOåˆ†é¡",
      "intent": "è³‡è¨ŠæŸ¥è©¢",
      "languages": ["zh-tw", "en", "ja"]
    }
  ],
  "navigationalKeywords": [
    {
      "keyword": "å°èˆªæŸ¥è©¢é—œéµå­—",
      "searchVolume": "é«˜/ä¸­/ä½",
      "competition": "é«˜/ä¸­/ä½",
      "suggestedBid": "å»ºè­°å‡ºåƒ¹ç¯„åœ",
      "seoCategory": "SEOåˆ†é¡",
      "intent": "å°èˆªæŸ¥è©¢",
      "languages": ["zh-tw", "en", "ja"]
    }
  ],
  "transactionalKeywords": [
    {
      "keyword": "äº¤æ˜“æ„åœ–é—œéµå­—",
      "searchVolume": "é«˜/ä¸­/ä½",
      "competition": "é«˜/ä¸­/ä½",
      "suggestedBid": "å»ºè­°å‡ºåƒ¹ç¯„åœ",
      "seoCategory": "SEOåˆ†é¡",
      "intent": "äº¤æ˜“æ„åœ–",
      "languages": ["zh-tw", "en", "ja"]
    }
  ],
  "biddingStrategy": {
    "highVolumeHighCompetition": "é«˜æœå°‹é‡é«˜ç«¶çˆ­åº¦ç­–ç•¥",
    "highVolumeLowCompetition": "é«˜æœå°‹é‡ä½ç«¶çˆ­åº¦ç­–ç•¥",
    "lowVolumeHighCompetition": "ä½æœå°‹é‡é«˜ç«¶çˆ­åº¦ç­–ç•¥",
    "lowVolumeLowCompetition": "ä½æœå°‹é‡ä½ç«¶çˆ­åº¦ç­–ç•¥"
  },
  "seoCategories": {
    "headTerms": "ä¸»è¦é—œéµå­—èªªæ˜",
    "longTailTerms": "é•·å°¾é—œéµå­—èªªæ˜",
    "brandedTerms": "å“ç‰Œé—œéµå­—èªªæ˜",
    "productTerms": "ç”¢å“é—œéµå­—èªªæ˜",
    "serviceTerms": "æœå‹™é—œéµå­—èªªæ˜",
    "locationTerms": "åœ°å€é—œéµå­—èªªæ˜"
  },
  "marketInsights": [
    "å¸‚å ´æ´å¯Ÿ1",
    "å¸‚å ´æ´å¯Ÿ2"
  ]
}

é‡è¦ï¼šè«‹ç¢ºä¿å›å‚³çš„æ˜¯ç´” JSON æ ¼å¼ï¼Œä¸è¦åŒ…å«ä»»ä½• markdown æ¨™è¨˜ã€‚`;
        }
        
        // é—œéµå­—åˆ†é¡
        function categorizeKeywords(aiSuggestions, keywordTypes) {
            const categorized = {
                primary: [],
                longTail: [],
                commercial: [],
                informational: [],
                navigational: [],
                transactional: [],
                totalCount: 0
            };
            
            // æ ¹æ“šé¸æ“‡çš„é¡å‹åˆ†é¡é—œéµå­—
            if (keywordTypes.primary && aiSuggestions.primaryKeywords) {
                categorized.primary = aiSuggestions.primaryKeywords;
                categorized.totalCount += aiSuggestions.primaryKeywords.length;
            }
            
            if (keywordTypes.longTail && aiSuggestions.longTailKeywords) {
                categorized.longTail = aiSuggestions.longTailKeywords;
                categorized.totalCount += aiSuggestions.longTailKeywords.length;
            }
            
            if (keywordTypes.commercial && aiSuggestions.commercialKeywords) {
                categorized.commercial = aiSuggestions.commercialKeywords;
                categorized.totalCount += aiSuggestions.commercialKeywords.length;
            }
            
            if (keywordTypes.informational && aiSuggestions.informationalKeywords) {
                categorized.informational = aiSuggestions.informationalKeywords;
                categorized.totalCount += aiSuggestions.informationalKeywords.length;
            }
            
            if (keywordTypes.navigational && aiSuggestions.navigationalKeywords) {
                categorized.navigational = aiSuggestions.navigationalKeywords;
                categorized.totalCount += aiSuggestions.navigationalKeywords.length;
            }
            
            if (keywordTypes.transactional && aiSuggestions.transactionalKeywords) {
                categorized.transactional = aiSuggestions.transactionalKeywords;
                categorized.totalCount += aiSuggestions.transactionalKeywords.length;
            }
            
            // æ·»åŠ å‡ºåƒ¹ç­–ç•¥å’ŒSEOåˆ†é¡
            categorized.biddingStrategy = aiSuggestions.biddingStrategy || {};
            categorized.seoCategories = aiSuggestions.seoCategories || {};
            categorized.marketInsights = aiSuggestions.marketInsights || [];
            
            return categorized;
        }
        
        // æ›´æ–°é—œéµå­—é¡¯ç¤º
        function updateKeywordDisplay(categorizedKeywords) {
            try {
                // æ›´æ–°ä¸»è¦é—œéµå­—
                const primaryTextarea = document.getElementById('primary-keywords-step3');
                if (primaryTextarea) {
                    const primaryKeywords = categorizedKeywords.primary.map(k => k.keyword).join('\n');
                    primaryTextarea.value = primaryKeywords;
                }
                
                // æ›´æ–°é•·å°¾é—œéµå­—
                const longTailTextarea = document.getElementById('long-tail-keywords-step3');
                if (longTailTextarea) {
                    const longTailKeywords = categorizedKeywords.longTail.map(k => k.keyword).join('\n');
                    longTailTextarea.value = longTailKeywords;
                }
                
                // å„²å­˜å®Œæ•´é—œéµå­—è³‡æ–™
                state.analysisData.categorizedKeywords = categorizedKeywords;
                
            } catch (error) {
                console.error('æ›´æ–°é—œéµå­—é¡¯ç¤ºå¤±æ•—:', error);
            }
        }
        
        // ç²å–é¸æ“‡çš„é—œéµå­—é¡å‹
        function getSelectedKeywordTypes() {
            return {
                primary: document.getElementById('keyword-primary')?.checked || false,
                longTail: document.getElementById('keyword-longtail')?.checked || false,
                commercial: document.getElementById('keyword-commercial')?.checked || false,
                informational: document.getElementById('keyword-informational')?.checked || false,
                navigational: document.getElementById('keyword-navigational')?.checked || false,
                transactional: document.getElementById('keyword-transactional')?.checked || false
            };
        }
        
        // ç”Ÿæˆæœå°‹æŸ¥è©¢
        function generateSearchQueries(brand, industry, businessModel) {
            const queries = [
                `${brand} ${industry}`,
                `${industry} ${businessModel}`,
                `${brand} ç«¶çˆ­å°æ‰‹`,
                `${industry} å¸‚å ´åˆ†æ`,
                `${businessModel} é—œéµå­—`,
                `${brand} ç”¢å“æœå‹™`,
                `${industry} è¶¨å‹¢`,
                `${businessModel} è¡ŒéŠ·ç­–ç•¥`
            ];
            
            return queries;
        }
        
        // æ¨¡æ¿é—œéµå­—å»ºè­°ï¼ˆå›é€€æ–¹æ¡ˆï¼‰
        function generateTemplateKeywordSuggestions(brand, industry, businessModel, products) {
            const productNames = products.map(p => p.name || p).join(' ');
            
            return {
                primaryKeywords: [
                    {
                        keyword: `${brand} ${industry}`,
                        searchVolume: "é«˜",
                        competition: "ä¸­",
                        suggestedBid: "NT$ 15-25",
                        seoCategory: "å“ç‰Œ+è¡Œæ¥­",
                        intent: "å“ç‰Œæœå°‹",
                        languages: ["zh-tw", "en"]
                    },
                    {
                        keyword: `${industry} æ¨è–¦`,
                        searchVolume: "é«˜",
                        competition: "é«˜",
                        suggestedBid: "NT$ 20-35",
                        seoCategory: "æ¨è–¦æœå°‹",
                        intent: "è³‡è¨ŠæŸ¥è©¢",
                        languages: ["zh-tw", "en"]
                    }
                ],
                longTailKeywords: [
                    {
                        keyword: `${brand} ${industry} ${businessModel}`,
                        searchVolume: "ä¸­",
                        competition: "ä½",
                        suggestedBid: "NT$ 8-15",
                        seoCategory: "é•·å°¾é—œéµå­—",
                        intent: "ç²¾æº–æœå°‹",
                        languages: ["zh-tw", "en"]
                    }
                ],
                commercialKeywords: [
                    {
                        keyword: `${industry} åƒ¹æ ¼`,
                        searchVolume: "é«˜",
                        competition: "é«˜",
                        suggestedBid: "NT$ 25-40",
                        seoCategory: "å•†æ¥­æ„åœ–",
                        intent: "å•†æ¥­æ„åœ–",
                        languages: ["zh-tw", "en"]
                    }
                ],
                biddingStrategy: {
                    highVolumeHighCompetition: "å»ºè­°å‡ºåƒ¹ NT$ 25-40ï¼Œå°ˆæ³¨æ–¼é«˜è½‰æ›ç‡",
                    highVolumeLowCompetition: "å»ºè­°å‡ºåƒ¹ NT$ 15-25ï¼Œæ“´å¤§å¸‚å ´ä»½é¡",
                    lowVolumeHighCompetition: "å»ºè­°å‡ºåƒ¹ NT$ 8-15ï¼Œç²¾æº–å®šä½",
                    lowVolumeLowCompetition: "å»ºè­°å‡ºåƒ¹ NT$ 5-12ï¼Œä½æˆæœ¬æ¸¬è©¦"
                },
                seoCategories: {
                    headTerms: "ä¸»è¦é—œéµå­—ï¼šæœå°‹é‡å¤§ï¼Œç«¶çˆ­åº¦é«˜",
                    longTailTerms: "é•·å°¾é—œéµå­—ï¼šæœå°‹é‡å°ï¼Œç«¶çˆ­åº¦ä½ï¼Œè½‰æ›ç‡é«˜",
                    brandedTerms: "å“ç‰Œé—œéµå­—ï¼šå“ç‰Œç›¸é—œæœå°‹",
                    productTerms: "ç”¢å“é—œéµå­—ï¼šå…·é«”ç”¢å“æœå°‹",
                    serviceTerms: "æœå‹™é—œéµå­—ï¼šæœå‹™ç›¸é—œæœå°‹",
                    locationTerms: "åœ°å€é—œéµå­—ï¼šåœ°ç†ä½ç½®ç›¸é—œ"
                },
                marketInsights: [
                    `${industry} å¸‚å ´å‘ˆç¾ç©©å®šæˆé•·è¶¨å‹¢`,
                    `${businessModel} æ¨¡å¼åœ¨ ${industry} ä¸­å…·æœ‰ç«¶çˆ­å„ªå‹¢`
                ]
            };
        }
        
        // å›é€€æœå°‹çµæœ
        function getFallbackSearchResults(brand, industry, businessModel) {
            return [
                { title: `${brand} ${industry} å®˜æ–¹ç¶²ç«™` },
                { title: `${industry} ${businessModel} æœå‹™` },
                { title: `${brand} ç”¢å“ä»‹ç´¹` },
                { title: `${industry} å¸‚å ´åˆ†æå ±å‘Š` },
                { title: `${businessModel} æˆåŠŸæ¡ˆä¾‹` }
            ];
        }

        // ä¸‹è¼‰é—œéµå­—å ±å‘Š
        function downloadKeywordReport() {
            try {
                const categorizedKeywords = state.analysisData.categorizedKeywords;
                if (!categorizedKeywords) {
                    showAlert('è«‹å…ˆåŸ·è¡Œæ™ºèƒ½é—œéµå­—æœå°‹', 'æ²’æœ‰é—œéµå­—è³‡æ–™å¯ä¾›ä¸‹è¼‰', 'warning');
                    return;
                }

                const brand = state.analysisData.brand?.name || 'æœªæŒ‡å®š';
                const industry = state.analysisData.industry?.category || 'æœªæŒ‡å®š';
                const businessModel = document.getElementById('business-model-select-step3')?.value || 'æœªæŒ‡å®š';
                
                let reportContent = `æ™ºèƒ½é—œéµå­—å»ºè­°æ›¸\n`;
                reportContent += `å“ç‰Œ: ${brand}\n`;
                reportContent += `è¡Œæ¥­: ${industry}\n`;
                reportContent += `å•†æ¥­æ¨¡å¼: ${businessModel}\n`;
                reportContent += `ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}\n`;
                reportContent += `ç¸½é—œéµå­—æ•¸é‡: ${categorizedKeywords.totalCount}\n\n`;
                
                // ä¸»è¦é—œéµå­—
                if (categorizedKeywords.primary && categorizedKeywords.primary.length > 0) {
                    reportContent += `=== ä¸»è¦é—œéµå­— ===\n`;
                    categorizedKeywords.primary.forEach((keyword, index) => {
                        reportContent += `${index + 1}. ${keyword.keyword}\n`;
                        reportContent += `   æœå°‹é‡: ${keyword.searchVolume} | ç«¶çˆ­åº¦: ${keyword.competition}\n`;
                        reportContent += `   å»ºè­°å‡ºåƒ¹: ${keyword.suggestedBid} | SEOåˆ†é¡: ${keyword.seoCategory}\n`;
                        reportContent += `   æœå°‹æ„åœ–: ${keyword.intent} | èªè¨€: ${keyword.languages.join(', ')}\n\n`;
                    });
                }
                
                // é•·å°¾é—œéµå­—
                if (categorizedKeywords.longTail && categorizedKeywords.longTail.length > 0) {
                    reportContent += `=== é•·å°¾é—œéµå­— ===\n`;
                    categorizedKeywords.longTail.forEach((keyword, index) => {
                        reportContent += `${index + 1}. ${keyword.keyword}\n`;
                        reportContent += `   æœå°‹é‡: ${keyword.searchVolume} | ç«¶çˆ­åº¦: ${keyword.competition}\n`;
                        reportContent += `   å»ºè­°å‡ºåƒ¹: ${keyword.suggestedBid} | SEOåˆ†é¡: ${keyword.seoCategory}\n`;
                        reportContent += `   æœå°‹æ„åœ–: ${keyword.intent} | èªè¨€: ${keyword.languages.join(', ')}\n\n`;
                    });
                }
                
                // å•†æ¥­æ„åœ–é—œéµå­—
                if (categorizedKeywords.commercial && categorizedKeywords.commercial.length > 0) {
                    reportContent += `=== å•†æ¥­æ„åœ–é—œéµå­— ===\n`;
                    categorizedKeywords.commercial.forEach((keyword, index) => {
                        reportContent += `${index + 1}. ${keyword.keyword}\n`;
                        reportContent += `   æœå°‹é‡: ${keyword.searchVolume} | ç«¶çˆ­åº¦: ${keyword.competition}\n`;
                        reportContent += `   å»ºè­°å‡ºåƒ¹: ${keyword.suggestedBid} | SEOåˆ†é¡: ${keyword.seoCategory}\n`;
                        reportContent += `   æœå°‹æ„åœ–: ${keyword.intent} | èªè¨€: ${keyword.languages.join(', ')}\n\n`;
                    });
                }
                
                // å‡ºåƒ¹ç­–ç•¥
                if (categorizedKeywords.biddingStrategy) {
                    reportContent += `=== å‡ºåƒ¹ç­–ç•¥å»ºè­° ===\n`;
                    Object.entries(categorizedKeywords.biddingStrategy).forEach(([key, value]) => {
                        reportContent += `${key}: ${value}\n`;
                    });
                    reportContent += `\n`;
                }
                
                // å¸‚å ´æ´å¯Ÿ
                if (categorizedKeywords.marketInsights && categorizedKeywords.marketInsights.length > 0) {
                    reportContent += `=== å¸‚å ´æ´å¯Ÿ ===\n`;
                    categorizedKeywords.marketInsights.forEach((insight, index) => {
                        reportContent += `${index + 1}. ${insight}\n`;
                    });
                    reportContent += `\n`;
                }
                
                // ä¸‹è¼‰æª”æ¡ˆ
                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${brand}_é—œéµå­—å»ºè­°æ›¸_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('ä¸‹è¼‰æˆåŠŸ', 'é—œéµå­—å»ºè­°æ›¸å·²ä¸‹è¼‰', 'success');
                
            } catch (error) {
                console.error('ä¸‹è¼‰é—œéµå­—å ±å‘Šå¤±æ•—:', error);
                showAlert('ä¸‹è¼‰å¤±æ•—', 'ç„¡æ³•ç”Ÿæˆé—œéµå­—å ±å‘Š', 'error');
            }
        }
        
        // ä¸‹è¼‰é—œéµå­— CSV
        function downloadKeywordCSV() {
            try {
                const categorizedKeywords = state.analysisData.categorizedKeywords;
                if (!categorizedKeywords) {
                    showAlert('è«‹å…ˆåŸ·è¡Œæ™ºèƒ½é—œéµå­—æœå°‹', 'æ²’æœ‰é—œéµå­—è³‡æ–™å¯ä¾›ä¸‹è¼‰', 'warning');
                    return;
                }
                
                const brand = state.analysisData.brand?.name || 'æœªæŒ‡å®š';
                
                // CSV æ¨™é¡Œ
                let csvContent = 'é—œéµå­—,æœå°‹é‡,ç«¶çˆ­åº¦,å»ºè­°å‡ºåƒ¹,SEOåˆ†é¡,æœå°‹æ„åœ–,èªè¨€,é¡å‹\n';
                
                // æ”¶é›†æ‰€æœ‰é—œéµå­—
                const allKeywords = [];
                
                if (categorizedKeywords.primary) {
                    categorizedKeywords.primary.forEach(keyword => {
                        allKeywords.push({
                            ...keyword,
                            type: 'ä¸»è¦é—œéµå­—'
                        });
                    });
                }
                
                if (categorizedKeywords.longTail) {
                    categorizedKeywords.longTail.forEach(keyword => {
                        allKeywords.push({
                            ...keyword,
                            type: 'é•·å°¾é—œéµå­—'
                        });
                    });
                }
                
                if (categorizedKeywords.commercial) {
                    categorizedKeywords.commercial.forEach(keyword => {
                        allKeywords.push({
                            ...keyword,
                            type: 'å•†æ¥­æ„åœ–'
                        });
                    });
                }
                
                if (categorizedKeywords.informational) {
                    categorizedKeywords.informational.forEach(keyword => {
                        allKeywords.push({
                            ...keyword,
                            type: 'è³‡è¨ŠæŸ¥è©¢'
                        });
                    });
                }
                
                if (categorizedKeywords.navigational) {
                    categorizedKeywords.navigational.forEach(keyword => {
                        allKeywords.push({
                            ...keyword,
                            type: 'å°èˆªæŸ¥è©¢'
                        });
                    });
                }
                
                if (categorizedKeywords.transactional) {
                    categorizedKeywords.transactional.forEach(keyword => {
                        allKeywords.push({
                            ...keyword,
                            type: 'äº¤æ˜“æ„åœ–'
                        });
                    });
                }
                
                // æ·»åŠ  CSV è¡Œ
                allKeywords.forEach(keyword => {
                    csvContent += `"${keyword.keyword}","${keyword.searchVolume}","${keyword.competition}","${keyword.suggestedBid}","${keyword.seoCategory}","${keyword.intent}","${keyword.languages.join(', ')}","${keyword.type}"\n`;
                });
                
                // ä¸‹è¼‰æª”æ¡ˆ
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${brand}_é—œéµå­—æ¸…å–®_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('ä¸‹è¼‰æˆåŠŸ', 'é—œéµå­— CSV å·²ä¸‹è¼‰', 'success');
                
            } catch (error) {
                console.error('ä¸‹è¼‰é—œéµå­— CSV å¤±æ•—:', error);
                showAlert('ä¸‹è¼‰å¤±æ•—', 'ç„¡æ³•ç”Ÿæˆé—œéµå­— CSV', 'error');
            }
        }
        
        // æ›´æ–°é—œéµå­—å»ºè­°æ›¸é¡¯ç¤º
        function updateKeywordReportDisplay(categorizedKeywords) {
            try {
                // æ›´æ–° SEO åˆ†é¡é¡¯ç¤º
                const seoCategoriesDisplay = document.getElementById('seo-categories-display');
                if (seoCategoriesDisplay && categorizedKeywords.seoCategories) {
                    let seoHtml = '';
                    Object.entries(categorizedKeywords.seoCategories).forEach(([key, value]) => {
                        seoHtml += `
                            <div class="bg-gray-700 rounded-lg p-3">
                                <h5 class="font-semibold text-gray-200 mb-2">${key}</h5>
                                <p class="text-gray-300 text-sm">${value}</p>
                            </div>
                        `;
                    });
                    seoCategoriesDisplay.innerHTML = seoHtml;
                }
                
                // æ›´æ–°å‡ºåƒ¹ç­–ç•¥é¡¯ç¤º
                const biddingStrategyDisplay = document.getElementById('bidding-strategy-display');
                if (biddingStrategyDisplay && categorizedKeywords.biddingStrategy) {
                    let biddingHtml = '';
                    Object.entries(categorizedKeywords.biddingStrategy).forEach(([key, value]) => {
                        const colorClass = key.includes('highVolumeHighCompetition') ? 'green' :
                                         key.includes('highVolumeLowCompetition') ? 'blue' :
                                         key.includes('lowVolumeHighCompetition') ? 'yellow' : 'purple';
                        
                        biddingHtml += `
                            <div class="bg-${colorClass}-900/20 rounded-lg p-3 border border-${colorClass}-500/20">
                                <h5 class="font-semibold text-${colorClass}-400 mb-2">${key}</h5>
                                <p class="text-gray-300 text-sm">${value}</p>
                            </div>
                        `;
                    });
                    biddingStrategyDisplay.innerHTML = biddingHtml;
                }
                
                // æ›´æ–°å¸‚å ´æ´å¯Ÿé¡¯ç¤º
                const marketInsightsDisplay = document.getElementById('market-insights-display');
                if (marketInsightsDisplay && categorizedKeywords.marketInsights) {
                    let insightsHtml = '';
                    categorizedKeywords.marketInsights.forEach(insight => {
                        insightsHtml += `<p class="text-gray-300 text-sm mb-2">â€¢ ${insight}</p>`;
                    });
                    marketInsightsDisplay.innerHTML = insightsHtml;
                }
                
            } catch (error) {
                console.error('æ›´æ–°é—œéµå­—å»ºè­°æ›¸é¡¯ç¤ºå¤±æ•—:', error);
            }
        }
    </script>
</head>
<body>
    <div id="app-container" class="p-6 bg-techbg text-white min-h-screen">
        <div id="vietnam-deep-insights" class="hidden"></div>
        <div id="mexico-deep-insights" class="hidden"></div>
        <h1 class="text-2xl font-semibold mb-6">å¸‚å ´æƒ…è³‡èˆ‡ç«¶å“åˆ†æå¹³å° (V6 - é€²éšåˆ†æç‰ˆ)</h1>

        <div id="alert-container"></div>

        <div id="settings-panel" class="bg-techpanel rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">API è¨­å®š</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Google API Key</label>
                    <input type="text" id="google-api-key" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Google API Key">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Search Engine ID</label>
                    <input type="text" id="search-engine-id" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Search Engine ID">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Gemini API Key</label>
                    <input type="text" id="gemini-api-key" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Gemini API Key">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Intelligence Subfolder</label>
                    <input type="text" id="intelligence-subfolder" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Intelligence Subfolder">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Media Plan Subfolder</label>
                    <input type="text" id="mediaplan-subfolder" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Media Plan Subfolder">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Workflow Subfolder</label>
                    <input type="text" id="workflow-subfolder" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Workflow Subfolder">
                </div>
            </div>
            <button id="save-settings-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">å„²å­˜è¨­å®š</button>
        </div>

        <div id="analysis-panel" class="bg-techpanel rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">åˆ†æè¨­å®š</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">å“ç‰Œåç¨±</label>
                    <input type="text" id="brand-name" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="å“ç‰Œåç¨±">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">å“ç‰Œç¶²ç«™</label>
                    <input type="text" id="brand-website" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="å“ç‰Œç¶²ç«™">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">å“ç‰Œæè¿°</label>
                    <textarea id="brand-description" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3" placeholder="å“ç‰Œæè¿°"></textarea>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">è¡Œæ¥­é¡åˆ¥</label>
                    <select id="industry-category" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">è«‹é¸æ“‡è¡Œæ¥­é¡åˆ¥</option>
                        <option value="technology">ç§‘æŠ€/é›»å­</option>
                        <option value="finance">é‡‘è/éŠ€è¡Œ</option>
                        <option value="healthcare">é†«ç™‚/å¥åº·</option>
                        <option value="retail">é›¶å”®/æ¶ˆè²»</option>
                        <option value="manufacturing">è£½é€ æ¥­</option>
                        <option value="ecommerce">é›»å•†</option>
                        <option value="saas">SaaS</option>
                        <option value="fintech">é‡‘èç§‘æŠ€</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">å¸‚å ´è¦æ¨¡</label>
                    <input type="text" id="market-size" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="å¸‚å ´è¦æ¨¡">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">åˆ†æä¸»é¡Œ</label>
                    <input type="text" id="analysis-topic" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="åˆ†æä¸»é¡Œ">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">ç«¶çˆ­å°æ‰‹æ•¸é‡</label>
                    <input type="number" id="competitor-count" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="ç«¶çˆ­å°æ‰‹æ•¸é‡">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">åˆ†ææ·±åº¦</label>
                    <div class="flex gap-2">
                        <label class="flex items-center">
                            <input type="radio" name="analysis-depth" value="basic" class="form-radio">
                            <span class="ml-2">åŸºç¤åˆ†æ (æœå°‹é‡ã€ç«¶çˆ­åº¦)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="analysis-depth" value="standard" class="form-radio">
                            <span class="ml-2">æ¨™æº–åˆ†æ (æœå°‹é‡ã€ç«¶çˆ­åº¦ã€å‡ºåƒ¹å»ºè­°)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="analysis-depth" value="comprehensive" class="form-radio">
                            <span class="ml-2">æ·±åº¦åˆ†æ (æœå°‹é‡ã€ç«¶çˆ­åº¦ã€å‡ºåƒ¹å»ºè­°ã€å…§å®¹ç­–ç•¥)</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">ä¸»è¦é—œéµå­—</label>
                    <textarea id="primary-keywords" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3" placeholder="ä¸»è¦é—œéµå­—ï¼Œæ¯è¡Œä¸€å€‹"></textarea>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">é•·å°¾é—œéµå­—</label>
                    <textarea id="long-tail-keywords" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3" placeholder="é•·å°¾é—œéµå­—ï¼Œæ¯è¡Œä¸€å€‹"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">å•†æ¥­æ¨¡å¼</label>
                    <select id="business-model-select" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">è«‹é¸æ“‡å•†æ¥­æ¨¡å¼</option>
                        <option value="b2b">B2B (ä¼æ¥­å°ä¼æ¥­)</option>
                        <option value="b2c">B2C (ä¼æ¥­å°æ¶ˆè²»è€…)</option>
                        <option value="b2b2c">B2B2C (ä¼æ¥­å°ä¼æ¥­å°æ¶ˆè²»è€…)</option>
                        <option value="c2c">C2C (æ¶ˆè²»è€…å°æ¶ˆè²»è€…)</option>
                        <option value="saas">SaaS (è»Ÿé«”å³æœå‹™)</option>
                        <option value="marketplace">Marketplace (å¹³å°æ¨¡å¼)</option>
                        <option value="subscription">Subscription (è¨‚é–±æ¨¡å¼)</option>
                        <option value="freemium">Freemium (å…è²»å¢å€¼)</option>
                        <option value="ecommerce">E-commerce (é›»å•†)</option>
                        <option value="agency">Agency (ä»£ç†/æœå‹™)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">æœ¬åœ°åŒ–ç¨‹åº¦</label>
                    <select id="localization-level" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">è«‹é¸æ“‡æœ¬åœ°åŒ–ç¨‹åº¦</option>
                        <option value="basic">åŸºç¤æœ¬åœ°åŒ– (ç¿»è­¯) - åŸºæœ¬èªè¨€é©æ‡‰</option>
                        <option value="standard">æ¨™æº–æœ¬åœ°åŒ– (ç¿»è­¯+æ–‡åŒ–é©æ‡‰) - æ–‡åŒ–å…§å®¹èª¿æ•´</option>
                        <option value="advanced">æ·±åº¦æœ¬åœ°åŒ– (å®Œå…¨åœ¨åœ°åŒ–) - å®Œå…¨æ–‡åŒ–é©æ‡‰</option>
                        <option value="native">åŸç”Ÿæœ¬åœ°åŒ– (åœ¨åœ°åœ˜éšŠé–‹ç™¼) - åŸç”Ÿæ–‡åŒ–é«”é©—</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">ä¸»è¦èªè¨€</label>
                    <select id="primary-language" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">è«‹é¸æ“‡ä¸»è¦èªè¨€</option>
                        <option value="zh-tw">ç¹é«”ä¸­æ–‡ (å°ç£)</option>
                        <option value="zh-hk">ç¹é«”ä¸­æ–‡ (é¦™æ¸¯)</option>
                        <option value="zh-cn">ç°¡é«”ä¸­æ–‡ (ä¸­åœ‹)</option>
                        <option value="en">English (è‹±èª)</option>
                        <option value="ja">æ—¥æœ¬èª (æ—¥èª)</option>
                        <option value="ko">í•œêµ­ì–´ (éŸ“èª)</option>
                        <option value="th">à¹„à¸—à¸¢ (æ³°èª)</option>
                        <option value="vi">Tiáº¿ng Viá»‡t (è¶Šå—èª)</option>
                        <option value="id">Bahasa Indonesia (å°å°¼èª)</option>
                        <option value="ms">Bahasa Melayu (é¦¬ä¾†èª)</option>
                        <option value="de">Deutsch (å¾·èª)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">ç›®æ¨™å®¢ç¾¤</label>
                    <select id="target-audience" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">è«‹é¸æ“‡ç›®æ¨™å®¢ç¾¤</option>
                        <option value="startup">æ–°å‰µå…¬å¸ - æˆæœ¬æ•æ„Ÿï¼Œå¿«é€Ÿæ±ºç­–</option>
                        <option value="sme">ä¸­å°ä¼æ¥­ - å¯¦ç”¨å°å‘ï¼Œæ€§åƒ¹æ¯”é‡è¦</option>
                        <option value="enterprise">å¤§å‹ä¼æ¥­ - å“è³ªè¦æ±‚é«˜ï¼Œæ±ºç­–é€±æœŸé•·</option>
                        <option value="freelancer">è‡ªç”±å·¥ä½œè€… - éˆæ´»æ€§é‡è¦ï¼Œæˆæœ¬æ§åˆ¶</option>
                        <option value="student">å­¸ç”Ÿ - åƒ¹æ ¼æ•æ„Ÿï¼ŒåŠŸèƒ½éœ€æ±‚</option>
                        <option value="professional">å°ˆæ¥­äººå£« - å“è³ªè¦æ±‚é«˜ï¼Œæ•ˆç‡é‡è¦</option>
                        <option value="consumer">ä¸€èˆ¬æ¶ˆè²»è€… - ç”¨æˆ¶é«”é©—ï¼Œæƒ…æ„Ÿè¨´æ±‚</option>
                        <option value="elderly">éŠ€é«®æ— - æ˜“ç”¨æ€§ï¼Œä¿¡ä»»å»ºç«‹</option>
                        <option value="youth">å¹´è¼•æ—ç¾¤ - å‰µæ–°ï¼Œç¤¾äº¤åˆ†äº«</option>
                        <option value="parent">å®¶é•· - å®‰å…¨ï¼Œå“è³ªï¼Œæ•™è‚²åƒ¹å€¼</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">é …ç›® ID</label>
                    <input type="text" id="project-id" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="é …ç›® ID">
                </div>
            </div>
            
            <!-- ç”¢å“ç®¡ç† -->
            <div class="bg-gray-800 rounded-lg p-4 mb-4">
                <h4 class="font-semibold text-gray-200 mb-4">ğŸ“¦ ç”¢å“/æœå‹™ç®¡ç†</h4>
                <div id="products-container" class="space-y-3 mb-4">
                    <!-- ç”¢å“é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                </div>
                <button id="add-product-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">æ·»åŠ ç”¢å“</button>
            </div>
            
            <div class="flex gap-4">
                <button id="start-analysis-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">é–‹å§‹åˆ†æ</button>
                <button id="generate-report-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">ç”Ÿæˆå ±å‘Š</button>
            </div>
        </div>

        <div id="history-panel" class="bg-techpanel rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">æ­·å²ç´€éŒ„</h2>
            <div id="auto-search-results"></div>
        </div>

        <!-- æ­¥é©Ÿå°èˆª -->
        <div class="flex justify-center mb-6">
            <div class="flex space-x-4">
                <button id="step-1-btn" class="step-btn active bg-techprimary text-white px-6 py-2 rounded-lg" onclick="goToStep(1)">
                    æ­¥é©Ÿ 1: è¨­å®šåˆ†æ
                </button>
                <button id="step-2-btn" class="step-btn bg-gray-600 text-gray-300 px-6 py-2 rounded-lg" onclick="goToStep(2)">
                    æ­¥é©Ÿ 2: å°æ‰‹ç¯©é¸
                </button>
                <button id="step-3-btn" class="step-btn bg-gray-600 text-gray-300 px-6 py-2 rounded-lg" onclick="goToStep(3)">
                    æ­¥é©Ÿ 3: ç”Ÿæˆå ±å‘Š
                </button>
            </div>
        </div>

        <div id="step-1" class="step-panel">
            <h3 class="text-lg font-semibold mb-4">æ­¥é©Ÿ 1: è¨­å®šåˆ†æ</h3>
            <p class="text-gray-300 mb-4">è«‹åœ¨ä¸Šæ–¹çš„åˆ†æè¨­å®šé¢æ¿ä¸­å¡«å¯«å¿…è¦è³‡è¨Šï¼Œç„¶å¾Œé»æ“Šã€Œé–‹å§‹åˆ†æã€æŒ‰éˆ•ã€‚</p>
            
            <!-- é–‹å§‹åˆ†ææŒ‰éˆ• -->
            <div class="flex justify-center">
                <button id="start-analysis-btn" class="bg-techprimary hover:bg-techaccent text-white px-6 py-3 rounded-lg text-lg font-semibold">é–‹å§‹åˆ†æ</button>
            </div>
        </div>

        <div id="step-2" class="step-panel">
            <h3 class="text-lg font-semibold mb-4">æ­¥é©Ÿ 2: ç«¶çˆ­å°æ‰‹åˆ†æ</h3>
            
            <!-- ç•¶å‰åˆ†æä¸»é¡Œ -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-200 mb-2">ğŸ“Š ç•¶å‰åˆ†æä¸»é¡Œ</h4>
                <p class="text-gray-300">åˆ†æä¸»é¡Œ: <span id="current-topic" class="text-techaccent font-semibold">æœªè¨­å®š</span></p>
            </div>
            
            <!-- è‡ªå‹•æœå°‹çµæœ -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-200 mb-4">ğŸ” è¡Œæ¥­ç«¶çˆ­å°æ‰‹åˆ†æ</h4>
                <div id="auto-search-results" class="space-y-4">
                    <p class="text-gray-400">æ­£åœ¨è¼‰å…¥ç«¶çˆ­å°æ‰‹åˆ†æ...</p>
                </div>
            </div>
            
            <!-- æ‰‹å‹•æ·»åŠ ç«¶çˆ­å°æ‰‹ -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-200 mb-4">â• æ‰‹å‹•æ·»åŠ ç«¶çˆ­å°æ‰‹</h4>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="manual-competitor" class="flex-1 px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="ç«¶çˆ­å°æ‰‹åç¨±ï¼ˆç”¨é€—è™Ÿåˆ†éš”å¤šå€‹ï¼‰">
                    <button id="add-competitor-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">æ·»åŠ </button>
                </div>
                <p class="text-gray-400 text-sm">èªªæ˜ï¼šè¼¸å…¥ç«¶çˆ­å°æ‰‹åç¨±ï¼Œå¤šå€‹ç«¶çˆ­å°æ‰‹è«‹ç”¨é€—è™Ÿåˆ†éš”</p>
            </div>
            
            <!-- å·²é¸æ“‡çš„ç«¶çˆ­å°æ‰‹ -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-200 mb-4">âœ… å·²é¸æ“‡çš„ç«¶çˆ­å°æ‰‹ (<span id="selected-count">0</span>)</h4>
                <div id="selected-competitors" class="space-y-2">
                    <p class="text-gray-500 text-sm">å°šæœªé¸æ“‡ä»»ä½•ç«¶çˆ­å°æ‰‹</p>
                </div>
            </div>
            
            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="flex justify-between items-center">
                <button id="back-to-step1-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">è¿”å›æ­¥é©Ÿ 1</button>
                <button id="generate-report-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded" disabled>ç”Ÿæˆå®Œæ•´å ±å‘Š</button>
            </div>
        </div>

        <div id="step-3" class="step-panel">
            <h3 class="text-lg font-semibold mb-4">æ­¥é©Ÿ 3: ç”Ÿæˆå ±å‘Š</h3>
            <div id="final-report-content"></div>
        </div>
    </div>
</body>
</html>