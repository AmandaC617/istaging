<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>å¸‚å ´æƒ…è³‡èˆ‡ç«¶å“åˆ†æå¹³å° (V5 - å®Œæ•´ç¶­åº¦ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // Tailwind CSS configuration for a modern, tech-themed UI
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        techbg: '#181D27',
                        techpanel: '#22283A',
                        techaccent: '#2EE9E4',
                        techprimary: '#3762F0',
                        techsecondary: '#7D5FFF'
                    },
                    fontFamily: {
                        'tech': ['"Segoe UI"', 'Roboto', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styling and animations */
        body { font-family: "Segoe UI", Roboto, Arial, sans-serif; }
        .tab-main.active { border-color: #2EE9E4; background-color: #181D27; color: #2EE9E4; }
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.5s ease; }
        .locked { opacity: 0.5; pointer-events: none; }
        .spinner { border: 4px solid rgba(59,130,246,.2); width: 36px; height: 36px; border-radius: 50%; border-left-color: #2EE9E4; animation: spin 1s ease infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Table and result panel styling */
        th, td { padding: 12px 15px; }
        .result-panel { max-height: 65vh; overflow-y: auto; }
        .overflow-x-auto { overflow-x: auto; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #181D27; }
        ::-webkit-scrollbar-thumb { background: #3762F0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #7D5FFF; }

        /* Stepper UI */
        .stepper-container { display: flex; justify-content: space-between; margin-bottom: 1.5rem; }
        .step { flex: 1; text-align: center; position: relative; }
        .step-circle { width: 32px; height: 32px; line-height: 30px; border-radius: 50%; background-color: #22283A; color: #fff; display: inline-block; border: 2px solid #3762F0; font-weight: bold; cursor: pointer; transition: all .3s ease; }
        .step-title { margin-top: 0.5rem; font-size: 0.875rem; color: #9ca3af; }
        .step-line { position: absolute; top: 16px; left: 50%; width: 100%; height: 2px; background-color: #3762F0; z-index: -1; }
        .step:first-child .step-line { left: 50%; width: 50%; }
        .step:last-child .step-line { left: 0; width: 50%;}
        
        .step.active .step-circle { background-color: #3762F0; color: #fff; border-color: #2EE9E4; transform: scale(1.1); }
        .step.active .step-title { color: #2EE9E4; font-weight: bold; }
        .step.completed .step-circle { background-color: #2EE9E4; color: #181D27; border-color: #2EE9E4; }
        .step.completed .step-title { color: #d1d5db; }

        /* Badge Styles */
        .badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-weight: 600; font-size: 0.75rem; }
        .badge-high { background-color: #ef4444; color: white; }
        .badge-mid { background-color: #f97316; color: white; }
        .badge-low { background-color: #22c55e; color: white; }
        .badge-unknown { background-color: #6b7280; color: white; }
    </style>
</head>
<body class="bg-techbg font-tech text-gray-100 min-h-screen">
    <!-- Header Section -->
    <header class="bg-techpanel shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold tracking-wide text-techaccent flex items-center gap-2">
                <svg class="w-8 h-8 text-techprimary inline-block" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364-7.364l-1.414 1.414M6.05 17.95l-1.414 1.414m12.728 0l1.414-1.414M6.05 6.05L4.636 4.636" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                å¸‚å ´æƒ…è³‡èˆ‡ç«¶å“åˆ†æå¹³å°
            </h1>
            <div id="auth-container">
                <div class="flex items-center gap-4">
                    <div id="user-profile" class="hidden items-center gap-3">
                        <img id="user-avatar" class="w-10 h-10 rounded-full" src="" alt="User Avatar">
                        <span id="user-name" class="font-semibold text-gray-200"></span>
                        <button id="signout_button" class="text-sm text-gray-400 hover:text-techaccent">ç™»å‡º</button>
                    </div>
                     <button id="authorize_button" class="hidden bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-5 py-2 rounded-lg shadow-lg">ç™»å…¥ Google</button>
                </div>
                <div class="text-xs text-yellow-400 mt-2">â€» éœ€æˆæ¬Š Google Drive å…¨æ¬Šé™æ‰èƒ½æ­£ç¢ºå„²å­˜è³‡æ–™</div>
            </div>
        </div>
    </header>

    <div id="alert-container" class="fixed top-24 right-6 z-50"></div>

    <main class="container mx-auto px-6 py-8">
        <div id="app-container" class="locked">
            <div class="flex border-b border-techprimary/20 mb-6">
                <button data-tab="analysis" class="tab-main tab-btn active flex-1 p-4 font-semibold">åˆ†ææµç¨‹</button>
                <button data-tab="settings" class="tab-main tab-btn flex-1 p-4 font-semibold">API è¨­å®š</button>
                <button data-tab="history" class="tab-main tab-btn flex-1 p-4 font-semibold">æ­·å²ç´€éŒ„</button>
            </div>

            <!-- Main Panels -->
            <div id="analysis-panel" class="panel active">
                <!-- Stepper -->
                <div class="stepper-container mb-8">
                    <div id="step-1" class="step active">
                        <div class="step-circle" onclick="goToStep(1)">1</div>
                        <div class="step-title">åˆ†æè¨­å®š</div>
                        <div class="step-line"></div>
                    </div>
                    <div id="step-2" class="step">
                        <div class="step-circle" onclick="goToStep(2)">2</div>
                        <div class="step-title">å°æ‰‹ç¯©é¸èˆ‡è£œå……</div>
                        <div class="step-line"></div>
                    </div>
                    <div id="step-3" class="step">
                        <div class="step-circle" onclick="goToStep(3)">3</div>
                        <div class="step-title">å®Œæ•´å ±å‘Š</div>
                    </div>
                </div>

                <!-- Step Content -->
                <div id="step-content">
                    <!-- Step 1: Analysis Inputs -->
                    <div id="step-1-content" class="step-panel active">
                        <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8 max-w-3xl mx-auto">
                            <h2 class="text-2xl font-bold mb-6 text-techaccent text-center">è¨­å®šåˆ†æç›®æ¨™</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="project-id" class="block text-sm font-medium text-gray-300">å°ˆæ¡ˆ ID <span class="text-yellow-400">*</span></label>
                                    <input type="text" id="project-id" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-gray-100" placeholder="è«‹è¼¸å…¥å¾ Workflow ç³»çµ±å–å¾—çš„å°ˆæ¡ˆ ID">
                                    <p class="text-xs text-gray-400 mt-1">è«‹å¾ Workflow ç³»çµ±è¤‡è£½å°ˆæ¡ˆç·¨è™Ÿä¸¦è²¼ä¸Šæ­¤è™•</p>
                                </div>
                                <div>
                                    <label for="topic" class="block text-sm font-medium text-gray-300">åˆ†æä¸»é¡Œ</label>
                                    <input type="text" id="topic" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-gray-100" placeholder="å¦‚: è¡Œå‹•é›»æº">
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium text-gray-300">å•†æ¥­æ¨¡å¼</label>
                                    <div class="mt-2 grid grid-cols-3 gap-4 text-gray-300">
                                        <label class="p-3 bg-techbg rounded-lg text-center border-2 border-transparent has-[:checked]:border-techaccent cursor-pointer"><input type="radio" name="business-model" value="B2C" checked class="sr-only">B2C</label>
                                        <label class="p-3 bg-techbg rounded-lg text-center border-2 border-transparent has-[:checked]:border-techaccent cursor-pointer"><input type="radio" name="business-model" value="B2B" class="sr-only">B2B</label>
                                        <label class="p-3 bg-techbg rounded-lg text-center border-2 border-transparent has-[:checked]:border-techaccent cursor-pointer"><input type="radio" name="business-model" value="B2B2C" class="sr-only">B2B2C</label>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="country" class="block text-sm font-medium text-gray-300">åœ‹å®¶/åœ°å€</label>
                                        <select id="country" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-gray-100"><option value="TW">å°ç£</option><option value="CN">ä¸­åœ‹</option><option value="HK">é¦™æ¸¯</option><option value="JP">æ—¥æœ¬</option><option value="KR">éŸ“åœ‹</option><option value="US">ç¾åœ‹</option><option value="SG">æ–°åŠ å¡</option><option value="DE">å¾·åœ‹</option><option value="GB">è‹±åœ‹</option><option value="FR">æ³•åœ‹</option></select>
                                    </div>
                                    <div>
                                        <label for="language" class="block text-sm font-medium text-gray-300">èªè¨€</label>
                                        <select id="language" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-gray-100"><option value="zh-TW">ç¹é«”ä¸­æ–‡</option><option value="zh-CN">ç°¡é«”ä¸­æ–‡</option><option value="en">è‹±æ–‡</option><option value="ja">æ—¥æ–‡</option><option value="ko">éŸ“æ–‡</option><option value="de">å¾·æ–‡</option><option value="fr">æ³•æ–‡</option></select>
                                    </div>
                                </div>
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="industry" class="block text-sm font-medium text-gray-300">ç”¢æ¥­åç¨±</label><input type="text" id="industry" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="å¦‚: æ¶ˆè²»æ€§é›»å­"></div>
                                    <div><label for="sector" class="block text-sm font-medium text-gray-300">è¡Œæ¥­åç¨±</label><input type="text" id="sector" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="å¦‚: é€šè¨Šè¨­å‚™"></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="product" class="block text-sm font-medium text-gray-300">ç”¢å“åç¨±</label><input type="text" id="product" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="å¦‚: è¡Œå‹•é›»æº"></div>
                                    <div><label for="company" class="block text-sm font-medium text-gray-300">å…¬å¸åç¨± (å¯é¸)</label><input type="text" id="company" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="å¦‚: å°ç±³"></div>
                                </div>
                                <button id="start-analysis-btn" class="w-full bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-5 py-3 rounded-lg shadow-lg mt-6">ç”¢ç”Ÿå»ºè­°åˆ—è¡¨</button>
                            </div>
                        </section>
                    </div>

                    <!-- Step 2: Competitor Selection & Supplement -->
                    <div id="step-2-content" class="step-panel hidden">
                        <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8 max-w-4xl mx-auto">
                            <h2 class="text-2xl font-bold mb-2 text-techaccent text-center">ç¯©é¸èˆ‡è£œå……ç«¶çˆ­å°æ‰‹</h2>
                            <p class="text-center text-gray-400 mb-6">è«‹å‹¾é¸ AI å»ºè­°çš„å°æ‰‹ï¼Œä¸¦å¯æ‰‹å‹•è£œå……é¡å¤–åå–®ã€‚</p>
                            
                            <h3 class="font-semibold text-lg text-techaccent mb-3">AI å»ºè­°åˆ—è¡¨</h3>
                            <div id="competitor-checkbox-list" class="mb-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                            
                            <div class="mt-6 border-t border-techprimary/30 pt-6">
                                <label for="supplemental-competitors" class="font-semibold text-lg text-techaccent mb-3 block">è£œå……è‡ªå®šç¾©å°æ‰‹ (éå¿…è¦)</label>
                                <textarea id="supplemental-competitors" rows="3" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="è«‹è¼¸å…¥é¡å¤–çš„å…¬å¸æˆ–å“ç‰Œåç¨±ï¼Œæ¯è¡Œä¸€å€‹æˆ–ç”¨é€—è™Ÿåˆ†éš”"></textarea>
                            </div>

                            <div class="flex justify-between items-center mt-8">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="select-all-competitors" class="mr-2 accent-techaccent scale-125">
                                    <span class="font-semibold">å…¨é¸/å…¨ä¸é¸ (AI åˆ—è¡¨)</span>
                                </label>
                                <button id="analyze-selected-btn" class="bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-8 py-3 rounded-lg shadow-lg">æ•´åˆä¸¦åˆ†ææœ€çµ‚åˆ—è¡¨</button>
                            </div>
                        </section>
                    </div>

                    <!-- Step 3: Full Report -->
                    <div id="step-3-content" class="step-panel hidden">
                         <div id="loading-indicator" class="flex-col items-center justify-center h-full hidden">
                            <div class="spinner"></div>
                            <p id="loading-status" class="mt-4 text-techaccent font-medium"></p>
                        </div>
                        <div id="results-container">
                            <div class="flex justify-end gap-4 mb-4">
                                <button id="save-analysis-btn" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 font-bold text-white px-4 py-2 rounded-lg shadow-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a10 10 0 0 0 10-10c0-2.3-1.1-4.6-2.6-6.1-1.5-1.5-3.8-2.6-6.1-2.6-2.5 0-4.8.9-6.6 2.5-1.8 1.6-2.9 3.8-2.9 6.2 0 5.5 4.5 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>
                                    å„²å­˜è‡³ Drive
                                </button>
                                <button id="export-excel-btn" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 font-bold text-white px-4 py-2 rounded-lg shadow-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                                    åŒ¯å‡º Excel
                                </button>
                            </div>
                            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                                <div id="competitors-result-card" class="bg-techpanel rounded-xl shadow-2xl p-6"></div>
                                <div id="keywords-result-card" class="bg-techpanel rounded-xl shadow-2xl p-6"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings-panel" class="panel hidden">
                <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8 max-w-lg mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-techaccent text-center">API èˆ‡æ‡‰ç”¨ç¨‹å¼è¨­å®š</h2>
                    <div class="space-y-4">
                        <div><label for="google-api-key" class="block text-sm font-medium text-gray-300">Google API é‡‘é‘°</label><input type="password" id="google-api-key" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="å¡«å¯« Gemini/Custom Search API Key"></div>
                        <div><label for="search-engine-id" class="block text-sm font-medium text-gray-300">å¯ç¨‹å¼åŒ–æœå°‹å¼•æ“ ID (CX)</label><input type="text" id="search-engine-id" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="å¡«å¯« Custom Search Engine ID"></div>
                        
                        <!-- é›†ä¸­åŒ–è³‡æ–™å¤¾ç®¡ç†è¨­å®š -->
                        <div class="border-t border-techprimary/30 pt-4 mt-6">
                            <h3 class="text-lg font-semibold text-techaccent mb-4">ğŸ“ é›†ä¸­åŒ–è³‡æ–™å¤¾ç®¡ç†</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="central-folder-name" class="block text-sm font-medium text-gray-300">ä¸»è¦å°ˆæ¡ˆè³‡æ–™å¤¾åç¨±</label>
                                    <input type="text" id="central-folder-name" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="iStaging_å°ˆæ¡ˆç®¡ç†" placeholder="ä¾‹å¦‚: iStaging_å°ˆæ¡ˆç®¡ç†">
                                    <p class="text-xs text-gray-400 mt-1">æ­¤è³‡æ–™å¤¾å°‡åŒ…å«æ‰€æœ‰å°ˆæ¡ˆçš„å­è³‡æ–™å¤¾</p>
                                </div>
                                <div>
                                    <label for="intelligence-subfolder" class="block text-sm font-medium text-gray-300">å¸‚å ´æƒ…è³‡å­è³‡æ–™å¤¾åç¨±</label>
                                    <input type="text" id="intelligence-subfolder" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="01_å¸‚å ´æƒ…è³‡åˆ†æ" placeholder="ä¾‹å¦‚: 01_å¸‚å ´æƒ…è³‡åˆ†æ">
                                </div>
                                <div>
                                    <label for="mediaplan-subfolder" class="block text-sm font-medium text-gray-300">åª’é«”ææ¡ˆå­è³‡æ–™å¤¾åç¨±</label>
                                    <input type="text" id="mediaplan-subfolder" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="02_åª’é«”ææ¡ˆ" placeholder="ä¾‹å¦‚: 02_åª’é«”ææ¡ˆ">
                                </div>
                                <div>
                                    <label for="workflow-subfolder" class="block text-sm font-medium text-gray-300">å·¥ä½œæµç¨‹å­è³‡æ–™å¤¾åç¨±</label>
                                    <input type="text" id="workflow-subfolder" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="03_å·¥ä½œæµç¨‹æ–‡ä»¶" placeholder="ä¾‹å¦‚: 03_å·¥ä½œæµç¨‹æ–‡ä»¶">
                                </div>
                            </div>
                        </div>
                        
                        <button id="save-settings-btn" class="w-full bg-gradient-to-tr from-techprimary to-techaccent font-bold text-white px-5 py-3 rounded-lg shadow-lg mt-6">å„²å­˜è¨­å®š</button>
                    </div>
                </section>
            </div>
            <div id="history-panel" class="panel hidden">
                 <div class="text-center text-gray-500 py-16">æ­·å²ç´€éŒ„åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</div>
            </div>
        </div>
    </main>

<script>
// --- GLOBAL STATE AND CONFIGURATION ---
const GOOGLE_CLIENT_ID = "733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com";
const GOOGLE_SCOPES = "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.profile";

const state = {
    gapiReady: false,
    gisReady: false,
    tokenClient: null,
    accessToken: null,
    userProfile: null,
    driveFolderId: null,
    projectId: null,
    apiKeys: {
        google: null, searchEngineId: null, driveFolderName: 'Market_Analysis_Data'
    },
    folderStructure: {
        centralFolder: 'iStaging_å°ˆæ¡ˆç®¡ç†',
        intelligenceSubfolder: '01_å¸‚å ´æƒ…è³‡åˆ†æ',
        mediaplanSubfolder: '02_åª’é«”ææ¡ˆ',
        workflowSubfolder: '03_å·¥ä½œæµç¨‹æ–‡ä»¶'
    },
    folderIds: {
        central: null,
        intelligence: null,
        mediaplan: null,
        workflow: null
    },
    isApiReady: false,
    currentStep: 1,
    analysisData: {
        context: null,
        initialCompetitors: [],
        keywords: [],
        finalCompetitors: []
    },
    sortState: {
        keywords: { key: 'volume', order: 'desc' },
        competitors: { key: 'brandName', order: 'asc' }
    }
};

const ui = {
    authorizeButton: document.getElementById('authorize_button'),
    signOutButton: document.getElementById('signout_button'),
    userProfileDiv: document.getElementById('user-profile'),
    userNameSpan: document.getElementById('user-name'),
    userAvatarImg: document.getElementById('user-avatar'),
    appContainer: document.getElementById('app-container'),
    projectIdInput: document.getElementById('project-id'),
    saveSettingsBtn: document.getElementById('save-settings-btn'),
    startAnalysisBtn: document.getElementById('start-analysis-btn'),
    analyzeSelectedBtn: document.getElementById('analyze-selected-btn'),
    selectAllCompetitors: document.getElementById('select-all-competitors'),
    loadingIndicator: document.getElementById('loading-indicator'),
    spinner: document.querySelector('.spinner'),
    loadingStatus: document.getElementById('loading-status'),
    resultsContainer: document.getElementById('results-container'),
    saveAnalysisBtn: document.getElementById('save-analysis-btn'),
    exportExcelBtn: document.getElementById('export-excel-btn'),
};

// --- INITIALIZATION ---
window.onload = function() {
    setupGapi();
    setupEventListeners();
    loadProjectIdFromUrl();
};

function setupGapi() {
    const gapiScript = document.createElement('script');
    gapiScript.src = 'https://apis.google.com/js/api.js';
    gapiScript.onload = () => gapi.load('client', () => {
        state.gapiReady = true;
        updateUIState();
    });
    document.body.appendChild(gapiScript);

    const gisScript = document.createElement('script');
    gisScript.src = 'https://accounts.google.com/gsi/client';
    gisScript.async = true;
    gisScript.defer = true;
    gisScript.onload = () => {
        state.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: GOOGLE_SCOPES,
            callback: gisInCallback,
        });
        state.gisReady = true;
        updateUIState();
    };
    document.body.appendChild(gisScript);
}

function setupEventListeners() {
    ui.authorizeButton.onclick = () => state.tokenClient.requestAccessToken();
    ui.signOutButton.onclick = handleSignOut;
    ui.saveSettingsBtn.onclick = handleSaveSettings;
    ui.startAnalysisBtn.onclick = startInitialAnalysis;
    ui.analyzeSelectedBtn.onclick = processAndAnalyzeCompetitors;
    ui.selectAllCompetitors.onchange = (e) => {
        document.querySelectorAll('.competitor-checkbox').forEach(cb => cb.checked = e.target.checked);
    };
    document.querySelectorAll('.tab-main').forEach(btn => btn.addEventListener('click', handleMainTabSwitch));
    ui.saveAnalysisBtn.onclick = saveAnalysisToDrive;
    ui.exportExcelBtn.onclick = exportToExcel;
}

// --- UI & STATE MANAGEMENT ---
function updateUIState() {
    const loggedIn = !!state.accessToken;
    ui.authorizeButton.classList.toggle('hidden', loggedIn);
    ui.userProfileDiv.classList.toggle('hidden', !loggedIn);
    ui.appContainer.classList.toggle('locked', !loggedIn);

    if (!loggedIn) {
        goToStep(1); // Reset to first step on logout
        showAlert('è«‹å…ˆç™»å…¥', 'ç™»å…¥ Google å¸³è™Ÿä»¥é–‹å§‹ä½¿ç”¨ã€‚', 'info');
    } else if (!state.isApiReady) {
        handleMainTabSwitch({ target: document.querySelector('[data-tab="settings"]') });
        showAlert('è«‹å…ˆè¨­å®š API', 'è«‹åœ¨ API è¨­å®šé é¢å¡«å¯«å¿…è¦çš„é‡‘é‘°ã€‚', 'warning');
    }
}

function showAlert(title, message, type = 'info') {
    const alertContainer = document.getElementById('alert-container');
    const colors = {
        success: { bg: 'bg-green-500', text: 'text-white' },
        error: { bg: 'bg-red-500', text: 'text-white' },
        warning: { bg: 'bg-yellow-400', text: 'text-black' },
        info: { bg: 'bg-blue-500', text: 'text-white' }
    };
    const alertDiv = document.createElement('div');
    alertDiv.className = `rounded-lg shadow-lg px-5 py-3 mb-2 font-bold ${colors[type].bg} ${colors[type].text} transition-all duration-300 opacity-0 transform translate-x-10`;
    alertDiv.innerHTML = `<strong>${title}</strong> <span class="font-normal">${message}</span>`;
    alertContainer.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.opacity = '1';
        alertDiv.style.transform = 'translateX(0)';
    }, 10);
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        alertDiv.style.transform = 'translateX(10px)';
        alertDiv.addEventListener('transitionend', () => alertDiv.remove());
    }, 5000);
}

function handleMainTabSwitch(event) {
    const btn = event.target.closest('.tab-main');
    if (!btn || btn.classList.contains('active')) return;

    document.querySelectorAll('.tab-main').forEach(tab => tab.classList.remove('active'));
    btn.classList.add('active');

    const tabName = btn.dataset.tab;
    document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
    document.getElementById(`${tabName}-panel`).classList.add('active');
}

function setLoadingState(isLoading, message = '') {
    ui.loadingIndicator.classList.toggle('hidden', !isLoading);
    ui.loadingIndicator.classList.toggle('flex', isLoading);
    ui.resultsContainer.classList.toggle('hidden', isLoading);

    ui.loadingStatus.textContent = message;

    ui.startAnalysisBtn.disabled = isLoading;
    ui.analyzeSelectedBtn.disabled = isLoading;
    document.querySelectorAll('.step-circle').forEach(c => c.style.pointerEvents = isLoading ? 'none' : 'auto');
}

// --- STEPPER NAVIGATION ---
window.goToStep = function(step) {
    if (step > state.currentStep) return;
    if (step === 3 && state.analysisData.finalCompetitors.length === 0) return;
    if (step === 2 && state.analysisData.initialCompetitors.length === 0) return;

    document.querySelectorAll('.step-panel').forEach(p => p.classList.add('hidden'));
    document.getElementById(`step-${step}-content`).classList.remove('hidden');

    document.querySelectorAll('.step').forEach((s) => {
        s.classList.remove('active', 'completed');
        const currentStepNum = parseInt(s.id.split('-')[1]);
        if (currentStepNum < step) {
            s.classList.add('completed');
        } else if (currentStepNum === step) {
            s.classList.add('active');
        }
    });
    if(step < state.currentStep) state.currentStep = step;
}

function advanceStep(step) {
    state.currentStep = step;
    goToStep(step);
}

// --- AUTHENTICATION & SETTINGS ---
async function gisInCallback(response) {
    if (response.error) { showAlert('ç™»å…¥å¤±æ•—', response.error, 'error'); return; }
    state.accessToken = response.access_token;
    gapi.client.setToken({ access_token: state.accessToken });
    await updateUserInfo();
    updateUIState();
    if (state.isApiReady) await findOrCreateDriveFolder();
}

async function updateUserInfo() {
    try {
        const res = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', { headers: { 'Authorization': `Bearer ${state.accessToken}` } });
        if (!res.ok) throw new Error('ç„¡æ³•ç²å–ç”¨æˆ¶è³‡è¨Š');
        const profile = await res.json();
        state.userProfile = profile;
        ui.userNameSpan.textContent = profile.name;
        ui.userAvatarImg.src = profile.picture;
        showAlert('ç™»å…¥æˆåŠŸ', `æ­¡è¿æ‚¨ï¼Œ${profile.name}ï¼`, 'success');
    } catch (error) {
        showAlert('éŒ¯èª¤', 'ç„¡æ³•ç²å–ç”¨æˆ¶å€‹äººè³‡æ–™ã€‚', 'error');
        handleSignOut();
    }
}

function handleSignOut() {
    state.accessToken = null; state.userProfile = null; state.driveFolderId = null;
    gapi.client.setToken(null);
    updateUIState();
    showAlert('å·²ç™»å‡º', 'æ‚¨å·²æˆåŠŸç™»å‡ºã€‚');
}

async function handleSaveSettings() {
    state.apiKeys.google = document.getElementById('google-api-key').value.trim();
    state.apiKeys.searchEngineId = document.getElementById('search-engine-id').value.trim();
    
    // è®€å–é›†ä¸­åŒ–è³‡æ–™å¤¾è¨­å®š
    state.folderStructure.centralFolder = document.getElementById('central-folder-name').value.trim() || 'iStaging_å°ˆæ¡ˆç®¡ç†';
    state.folderStructure.intelligenceSubfolder = document.getElementById('intelligence-subfolder').value.trim() || '01_å¸‚å ´æƒ…è³‡åˆ†æ';
    state.folderStructure.mediaplanSubfolder = document.getElementById('mediaplan-subfolder').value.trim() || '02_åª’é«”ææ¡ˆ';
    state.folderStructure.workflowSubfolder = document.getElementById('workflow-subfolder').value.trim() || '03_å·¥ä½œæµç¨‹æ–‡ä»¶';

    if (state.apiKeys.google && state.apiKeys.searchEngineId) {
        state.isApiReady = true;
        showAlert('è¨­å®šå·²å„²å­˜', 'API èˆ‡è³‡æ–™å¤¾è¨­å®šå·²å„²å­˜å®Œæˆã€‚', 'success');
        handleMainTabSwitch({ target: document.querySelector('[data-tab="analysis"]') });
        if (state.accessToken) await setupCentralizedFolderStructure();
    } else {
        state.isApiReady = false;
        showAlert('è¨­å®šä¸å®Œæ•´', 'è«‹å¡«å¯« Google API é‡‘é‘°å’Œæœå°‹å¼•æ“ IDã€‚', 'warning');
    }
}

// --- CORE ANALYSIS WORKFLOW ---
function validateInputFields() {
    const context = getSearchContext();
    const hasInput = context.topic || context.industry || context.product;
    if (!hasInput) {
        showAlert('è¼¸å…¥ä¸è¶³', 'è«‹è‡³å°‘å¡«å¯«åˆ†æä¸»é¡Œã€ç”¢å“æˆ–ç”¢æ¥­åç¨±ã€‚', 'warning');
    }
    return hasInput;
}

function getSearchContext() {
    return {
        topic: document.getElementById('topic')?.value.trim(),
        businessModel: document.querySelector('input[name="business-model"]:checked').value,
        country: document.getElementById('country').value,
        language: document.getElementById('language').value,
        industry: document.getElementById('industry').value.trim(),
        sector: document.getElementById('sector').value.trim(),
        product: document.getElementById('product').value.trim(),
        company: document.getElementById('company').value.trim(),
    };
}

async function startInitialAnalysis() {
    // é©—è­‰ project ID
    const projectId = ui.projectIdInput.value.trim();
    if (!projectId) {
        showAlert('å°ˆæ¡ˆ ID å¿…å¡«', 'è«‹è¼¸å…¥å¾ Workflow ç³»çµ±å–å¾—çš„å°ˆæ¡ˆ IDã€‚', 'warning');
        return;
    }
    
    // å„²å­˜ project ID åˆ° state
    state.projectId = projectId;
    
    if (!validateInputFields()) return;
    
    state.analysisData = { context: getSearchContext(), initialCompetitors: [], keywords: [], finalCompetitors: [] };
    
    setLoadingState(true, 'æ­£åœ¨ç”¢ç”Ÿ AI å»ºè­°åˆ—è¡¨...');
    
    try {
        const [keywords, competitorNames] = await Promise.all([
            getAiKeywordSuggestions(state.analysisData.context),
            getAiCompetitorNames(state.analysisData.context)
        ]);

        state.analysisData.keywords = keywords || [];
        state.analysisData.initialCompetitors = competitorNames || [];

        if (competitorNames.length === 0) {
            showAlert('æŸ¥ç„¡ç«¶çˆ­å°æ‰‹', 'AI æœªèƒ½æ‰¾åˆ°ç›¸é—œå°æ‰‹ï¼Œè«‹ç›´æ¥é€²å…¥å ±å‘Šé é¢æŸ¥çœ‹é—œéµå­—ã€‚', 'info');
            renderFullReport(); 
            advanceStep(3);
        } else {
            renderCompetitorSelection(competitorNames);
            advanceStep(2);
        }
    } catch (error) {
        showAlert('åˆ†æå¤±æ•—', `æ­¥é©Ÿä¸€å¤±æ•—: ${error.message}`, 'error');
    } finally {
        setLoadingState(false);
    }
}

function processAndAnalyzeCompetitors() {
    const selectedAINames = Array.from(document.querySelectorAll('.competitor-checkbox:checked')).map(cb => cb.value);
    const supplementalInput = document.getElementById('supplemental-competitors').value;
    const supplementalNames = supplementalInput.split(/[\n,]/).map(name => name.trim()).filter(Boolean);
    const finalCompetitorList = [...new Set([...selectedAINames, ...supplementalNames])];
    
    if (finalCompetitorList.length === 0) {
        showAlert("æœªæŒ‡å®šå°æ‰‹", "è«‹è‡³å°‘å‹¾é¸æˆ–è£œå……ä¸€å€‹ç«¶çˆ­å°æ‰‹é€²è¡Œåˆ†æã€‚", "warning");
        return;
    }

    analyzeCompetitors(finalCompetitorList);
}


async function analyzeCompetitors(competitorNames) {
    advanceStep(3);
    setLoadingState(true, `æ­£åœ¨åˆ†æ ${competitorNames.length} å€‹ç«¶çˆ­å°æ‰‹...`);

    try {
        const competitorPromises = competitorNames.map(name => getFullCompetitorDetails(name, state.analysisData.context));
        const competitorDetails = await Promise.all(competitorPromises);
        
        state.analysisData.finalCompetitors = competitorDetails.filter(Boolean);
        
        renderFullReport();
        showAlert('åˆ†æå®Œæˆ', `å·²æˆåŠŸå–å¾— ${state.analysisData.finalCompetitors.length} å®¶ç«¶çˆ­å°æ‰‹çš„è©³ç´°è³‡æ–™ã€‚`, 'success');

    } catch (error) {
        showAlert('åˆ†æå¤±æ•—', `æ­¥é©ŸäºŒå¤±æ•—: ${error.message}`, 'error');
    } finally {
        setLoadingState(false);
    }
}

// --- GOOGLE API & AI PROMPTS ---
async function callGemini(prompt) {
    const apiKey = state.apiKeys.google;
    if (!apiKey) throw new Error('Google API é‡‘é‘°æœªè¨­å®šã€‚');
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
    const body = { contents: [{ parts: [{ text: prompt }] }] };
    const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`Gemini API éŒ¯èª¤: ${errorData.error?.message || response.statusText}`);
    }
    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) throw new Error('Gemini å›å‚³å…§å®¹ç‚ºç©ºã€‚');
    try {
        const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```|(\[.*\])|(\{.*\})/s);
        if (!jsonMatch) throw new Error('å›å‚³çš„å…§å®¹ä¸åŒ…å«æœ‰æ•ˆçš„ JSON æ ¼å¼ã€‚');
        return JSON.parse(jsonMatch[1] || jsonMatch[2] || jsonMatch[3]);
    } catch (e) {
        console.error("Gemini JSON parsing error:", e, "\nOriginal text:", text);
        throw new Error('Gemini å›å‚³æ ¼å¼è§£æå¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°æ—¥èªŒã€‚');
    }
}

async function searchGoogle(query) {
    const apiKey = state.apiKeys.google;
    const cx = state.apiKeys.searchEngineId;
    if (!apiKey || !cx) throw new Error('Google API é‡‘é‘°æˆ–æœå°‹å¼•æ“ ID æœªè¨­å®šã€‚');
    const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=${encodeURIComponent(query)}`;
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Custom Search API éŒ¯èª¤: ${response.statusText}`);
        const data = await response.json();
        return data.items?.[0]?.link || null;
    } catch (error) {
        console.error(`Google Search for "${query}" failed:`, error);
        return null;
    }
}

async function getAiKeywordSuggestions(context) {
    const prompt = `You are a world-class SEO expert. Based on the following criteria, generate as many relevant SEO keywords as possible, aiming for 40-50, in the specified language. Critically, tailor keywords to the "businessModel". Also provide estimated search volume (é«˜/ä¸­/ä½), type, and bidding competition (é«˜/ä¸­/ä½). Output MUST be a valid JSON array of objects, with NO other text. Criteria: ${JSON.stringify(context)}. Format: [{"keyword": "...", "volume": "...", "type": "...", "biddingCompetition": "..."}, ...].`;
    return callGemini(prompt);
}

async function getAiCompetitorNames(context) {
    const prompt = `You are a market analysis expert. Based on the criteria below, identify the top 10 competitors. Output MUST be a valid JSON array of strings, with NO other text. Criteria: ${JSON.stringify(context)}. Format: ["Competitor A", "Competitor B", ...].`;
    return callGemini(prompt);
}

async function getFullCompetitorDetails(name, context) {
    const prompt = `Analyze the company "${name}", a competitor in the market of "${context.topic}". Find its official stock ticker, headquarters state/province, and postal code. Output MUST be a single valid JSON object. If a value isn't found, use null. Criteria: ${JSON.stringify(context)}. Format: {"brandName": "${name}", "country": "...", "summary": "...", "companyType": "...", "stockTicker": "e.g., AAPL", "state": "e.g., California", "postalCode": "e.g., 95014"}`;
    const detailPromise = callGemini(prompt);
    const websitePromise = searchGoogle(`${name} ${context.industry || ''} official website`);
    const linkedinPromise = searchGoogle(`site:linkedin.com/company/ ${name}`);
    const [details, websiteUrl, linkedinUrl] = await Promise.all([detailPromise.catch(e => ({ brandName: name })), websitePromise, linkedinPromise]);
    return { ...details, websiteUrl, linkedinUrl };
}

// --- RESULT RENDERING ---
function renderCompetitorSelection(competitorNames) {
    const listEl = document.getElementById('competitor-checkbox-list');
    listEl.innerHTML = competitorNames.map(name => `
        <label class="block p-3 rounded-lg hover:bg-techprimary/20 transition-colors bg-techbg cursor-pointer">
            <input type="checkbox" class="competitor-checkbox mr-3 accent-techaccent" value="${name}" checked>
            <span>${name}</span>
        </label>
    `).join('');
    document.getElementById('supplemental-competitors').value = '';
}

function renderFullReport() {
    renderCompetitorResults();
    renderKeywordResults();
}

function renderCompetitorResults() {
    const card = document.getElementById('competitors-result-card');
    const data = state.analysisData.finalCompetitors || [];
    let content = `<h3 class="text-xl font-bold mb-4 text-techaccent">A. ç«¶çˆ­å°æ‰‹åˆ†æ</h3>`;

    if (data.length === 0) {
        card.innerHTML = content + '<p class="text-gray-500">æ²’æœ‰è¦é¡¯ç¤ºçš„ç«¶çˆ­å°æ‰‹è³‡æ–™ã€‚</p>';
        return;
    }
    const headers = ['å“ç‰Œ', 'åœ‹å®¶', 'è‚¡ç¥¨ä»£è™Ÿ', 'å·åˆ¥', 'éƒµéå€è™Ÿ', 'é€£çµ'];
    const keys = ['brandName', 'country', 'stockTicker', 'state', 'postalCode', 'links'];
    const sortedData = sortData('competitors', data);

    content += `<div class="overflow-x-auto result-panel">
        <table class="w-full text-left text-sm">
        <thead class="bg-gray-900 sticky top-0 z-10"><tr class="border-b border-techprimary/30">
        ${headers.map((h, i) => `<th class="py-3 px-3 cursor-pointer" onclick="sortTable('competitors', '${keys[i]}')">${h}${getSortIcon('competitors', keys[i])}</th>`).join('')}
        </tr></thead><tbody>
        ${sortedData.map(item => `
            <tr class="border-b border-techprimary/20 hover:bg-techprimary/10">
                <td class="font-semibold">${item.brandName || '-'}</td>
                <td>${item.country || '-'}</td>
                <td>${item.stockTicker || '-'}</td>
                <td>${item.state || '-'}</td>
                <td>${item.postalCode || '-'}</td>
                <td class="flex gap-4 items-center">
                    ${item.websiteUrl ? `<a href="${item.websiteUrl}" target="_blank" title="å®˜æ–¹ç¶²ç«™" class="text-gray-400 hover:text-techaccent"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></a>` : ''}
                    ${item.linkedinUrl ? `<a href="${item.linkedinUrl}" target="_blank" title="LinkedIn" class="text-gray-400 hover:text-techaccent"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a>` : ''}
                </td>
            </tr>
        `).join('')}
        </tbody></table></div>`;
    card.innerHTML = content;
}

function renderKeywordResults() {
    const card = document.getElementById('keywords-result-card');
    const data = state.analysisData.keywords || [];
    let content = `<h3 class="text-xl font-bold mb-4 text-techaccent">B. é—œéµå­—å»ºè­°</h3>`;
    if (data.length === 0) {
        card.innerHTML = content + '<p class="text-gray-500">æ²’æœ‰è¦é¡¯ç¤ºçš„é—œéµå­—è³‡æ–™ã€‚</p>'; return;
    }
    const headers = ['é—œéµå­—', 'æœå°‹é‡ç´š', 'å‡ºåƒ¹ç«¶çˆ­', 'é¡å‹'];
    const keys = ['keyword', 'volume', 'biddingCompetition', 'type'];
    const sortedData = sortData('keywords', data);
    const getBadgeClass = (value) => {
        const lower = String(value).toLowerCase();
        if (lower === 'é«˜' || lower === 'high') return 'badge-high';
        if (lower === 'ä¸­' || lower === 'medium') return 'badge-mid';
        if (lower === 'ä½' || lower === 'low') return 'badge-low';
        return 'badge-unknown';
    };
    content += `<div class="overflow-x-auto result-panel"><table class="w-full text-left text-sm">
        <thead class="bg-gray-900 sticky top-0 z-10"><tr class="border-b border-techprimary/30">
        ${headers.map((h, i) => `<th class="py-3 px-3 cursor-pointer" onclick="sortTable('keywords', '${keys[i]}')">${h}${getSortIcon('keywords', keys[i])}</th>`).join('')}
        </tr></thead><tbody>
        ${sortedData.map(item => `
            <tr class="border-b border-techprimary/20 hover:bg-techprimary/10">
                <td>${item.keyword || '-'}</td>
                <td><span class="badge ${getBadgeClass(item.volume)}">${item.volume || 'N/A'}</span></td>
                <td><span class="badge ${getBadgeClass(item.biddingCompetition)}">${item.biddingCompetition || 'N/A'}</span></td>
                <td>${item.type || '-'}</td>
            </tr>
        `).join('')}
        </tbody></table></div>`;
    card.innerHTML = content;
}

// --- DATA SORTING & UTILS ---
function getSortIcon(type, key) {
    if (state.sortState[type].key !== key) return '';
    return state.sortState[type].order === 'asc' ? ' â–²' : ' â–¼';
}
window.sortTable = function(type, key) {
    const sortState = state.sortState[type];
    if (sortState.key === key) {
        sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
    } else {
        sortState.key = key;
        sortState.order = (key === 'volume' || key === 'biddingCompetition') ? 'desc' : 'asc';
    }
    if (type === 'keywords') renderKeywordResults();
    if (type === 'competitors') renderCompetitorResults();
};
function sortData(type, data) {
    const { key, order } = state.sortState[type];
    if (!key || !data) return data;
    const competitionMap = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
    return [...data].sort((a, b) => {
        let aVal = a[key] || '', bVal = b[key] || '';
        if (key === 'volume' || key === 'biddingCompetition') {
            aVal = competitionMap[aVal] || 0;
            bVal = competitionMap[bVal] || 0;
            return order === 'asc' ? aVal - bVal : bVal - aVal;
        }
        return order === 'asc' ? String(aVal).localeCompare(String(bVal)) : String(bVal).localeCompare(String(aVal));
    });
}

// --- ACTIONS (SAVE, EXPORT) ---
function exportToExcel() {
    if (state.analysisData.finalCompetitors.length === 0 && state.analysisData.keywords.length === 0) {
        return showAlert("ç„¡æ³•åŒ¯å‡º", "ç›®å‰æ²’æœ‰å¯åŒ¯å‡ºçš„åˆ†æçµæœã€‚", "warning");
    }
    const wb = XLSX.utils.book_new();
    if (state.analysisData.finalCompetitors.length > 0) {
        const sheetData = state.analysisData.finalCompetitors.map(c => ({
            'å“ç‰Œåç¨±': c.brandName, 'åœ‹å®¶': c.country, 'æ‘˜è¦': c.summary, 'å…¬å¸é¡å‹': c.companyType,
            'è‚¡ç¥¨ä»£è™Ÿ': c.stockTicker, 'å·åˆ¥': c.state, 'éƒµéå€è™Ÿ': c.postalCode,
            'å®˜æ–¹ç¶²ç«™': c.websiteUrl, 'LinkedIn': c.linkedinUrl
        }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetData), "A_ç«¶çˆ­å°æ‰‹åˆ†æ");
    }
    if (state.analysisData.keywords.length > 0) {
        const sheetData = state.analysisData.keywords.map(k => ({ 'é—œéµå­—': k.keyword, 'æœå°‹é‡ç´š': k.volume, 'å‡ºåƒ¹ç«¶çˆ­': k.biddingCompetition, 'é¡å‹': k.type }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetData), "B_é—œéµå­—å»ºè­°");
    }
    const fileName = `${state.analysisData.context.topic || 'å¸‚å ´åˆ†æ'}_${new Date().toISOString().slice(0, 10)}.xlsx`;
    XLSX.writeFile(wb, fileName);
    showAlert('åŒ¯å‡ºæˆåŠŸ', `å·²ç”¢ç”Ÿæª”æ¡ˆ ${fileName}`, 'success');
}

async function saveAnalysisToDrive() {
    if (!state.projectId) return showAlert('å°ˆæ¡ˆ ID ç¼ºå¤±', 'è«‹å…ˆè¼¸å…¥å°ˆæ¡ˆ IDã€‚', 'warning');
    if (state.analysisData.finalCompetitors.length === 0 && state.analysisData.keywords.length === 0) return showAlert('å°šç„¡çµæœ', 'è«‹å…ˆåŸ·è¡Œåˆ†æã€‚', 'warning');
    
    setLoadingState(true, 'æ­£åœ¨å»ºç«‹è³‡æ–™å¤¾çµæ§‹ä¸¦å„²å­˜...');
    try {
        // ç¢ºä¿è³‡æ–™å¤¾çµæ§‹å·²å»ºç«‹
        if (!state.folderIds.intelligence) {
            await setupCentralizedFolderStructure();
        }
        
        // åœ¨åˆ†æè³‡æ–™ä¸­åŠ å…¥ project ID
        const analysisDataWithProject = {
            ...state.analysisData,
            projectId: state.projectId,
            savedAt: new Date().toISOString(),
            savedBy: state.userProfile?.name || 'Unknown',
            tool: 'intelligence'
        };
        
        const fileContent = JSON.stringify(analysisDataWithProject, null, 2);
        const blob = new Blob([fileContent], { type: 'application/json' });
        const fileName = `[${state.projectId}]_å¸‚å ´æƒ…è³‡åˆ†æ_${state.analysisData.context.topic || 'å¸‚å ´'}_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
        
        // å„²å­˜åˆ° intelligence å­è³‡æ–™å¤¾
        const targetFolderId = state.folderIds.intelligence || state.driveFolderId;
        const metadata = { 
            name: fileName, 
            mimeType: 'application/json', 
            parents: [targetFolderId] 
        };
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', blob);
        
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${state.accessToken}` },
            body: form
        });
        
        if (!response.ok) throw new Error((await response.json()).error?.message || 'æœªçŸ¥ä¸Šå‚³éŒ¯èª¤');
        
        showAlert('å„²å­˜æˆåŠŸ', `åˆ†æçµæœå·²å„²å­˜è‡³å°ˆæ¡ˆè³‡æ–™å¤¾ã€‚å°ˆæ¡ˆ ID: ${state.projectId}`, 'success');
        
    } catch (error) {
        showAlert('å­˜æª”å¤±æ•—', error.message, 'error');
    } finally {
        setLoadingState(false);
    }
}

async function findOrCreateDriveFolder() {
    try {
        await gapi.client.load('drive', 'v3');
        const folderName = state.apiKeys.driveFolderName;
        const response = await gapi.client.drive.files.list({ q: `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`, fields: 'files(id)' });
        if (response.result.files && response.result.files.length > 0) {
            state.driveFolderId = response.result.files[0].id;
        } else {
            const createResponse = await gapi.client.drive.files.create({ resource: { 'name': folderName, 'mimeType': 'application/vnd.google-apps.folder' }, fields: 'id' });
            state.driveFolderId = createResponse.result.id;
        }
    } catch (error) {
        console.error('Drive folder error:', error);
        showAlert('Drive éŒ¯èª¤', `å­˜å–è³‡æ–™å¤¾å¤±æ•—: ${error.result?.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
    }
}

// æ–°å¢ï¼šå»ºç«‹é›†ä¸­åŒ–è³‡æ–™å¤¾çµæ§‹
async function setupCentralizedFolderStructure() {
    try {
        await gapi.client.load('drive', 'v3');
        
        // 1. å»ºç«‹æˆ–æ‰¾åˆ°ä¸»è¦å°ˆæ¡ˆè³‡æ–™å¤¾
        const centralFolderId = await findOrCreateFolder(state.folderStructure.centralFolder, null);
        state.folderIds.central = centralFolderId;
        
        // 2. å»ºç«‹æˆ–æ‰¾åˆ°å°ˆæ¡ˆå­è³‡æ–™å¤¾
        if (state.projectId) {
            const projectFolderName = `[${state.projectId}]_å°ˆæ¡ˆè³‡æ–™`;
            const projectFolderId = await findOrCreateFolder(projectFolderName, centralFolderId);
            
            // 3. å»ºç«‹æˆ–æ‰¾åˆ°å„é¡åˆ¥å­è³‡æ–™å¤¾
            const intelligenceFolderId = await findOrCreateFolder(state.folderStructure.intelligenceSubfolder, projectFolderId);
            const mediaplanFolderId = await findOrCreateFolder(state.folderStructure.mediaplanSubfolder, projectFolderId);
            const workflowFolderId = await findOrCreateFolder(state.folderStructure.workflowSubfolder, projectFolderId);
            
            state.folderIds.intelligence = intelligenceFolderId;
            state.folderIds.mediaplan = mediaplanFolderId;
            state.folderIds.workflow = workflowFolderId;
            
            // è¨­å®š intelligence çš„é è¨­å„²å­˜è³‡æ–™å¤¾
            state.driveFolderId = intelligenceFolderId;
            
            console.log('é›†ä¸­åŒ–è³‡æ–™å¤¾çµæ§‹å»ºç«‹å®Œæˆ:', {
                central: centralFolderId,
                project: projectFolderId,
                intelligence: intelligenceFolderId,
                mediaplan: mediaplanFolderId,
                workflow: workflowFolderId
            });
            
            showAlert('è³‡æ–™å¤¾çµæ§‹å»ºç«‹å®Œæˆ', `å°ˆæ¡ˆ ${state.projectId} çš„è³‡æ–™å¤¾çµæ§‹å·²æº–å‚™å°±ç·’`, 'success');
        }
        
    } catch (error) {
        console.error('å»ºç«‹è³‡æ–™å¤¾çµæ§‹å¤±æ•—:', error);
        showAlert('è³‡æ–™å¤¾å»ºç«‹å¤±æ•—', `å»ºç«‹é›†ä¸­åŒ–è³‡æ–™å¤¾çµæ§‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
    }
}

// è¼”åŠ©å‡½æ•¸ï¼šå»ºç«‹æˆ–æ‰¾åˆ°è³‡æ–™å¤¾
async function findOrCreateFolder(folderName, parentId) {
    try {
        let query = `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`;
        if (parentId) {
            query += ` and '${parentId}' in parents`;
        }
        
        const response = await gapi.client.drive.files.list({ 
            q: query, 
            fields: 'files(id)' 
        });
        
        if (response.result.files && response.result.files.length > 0) {
            return response.result.files[0].id;
        } else {
            const folderMetadata = {
                name: folderName,
                mimeType: 'application/vnd.google-apps.folder'
            };
            
            if (parentId) {
                folderMetadata.parents = [parentId];
            }
            
            const createResponse = await gapi.client.drive.files.create({ 
                resource: folderMetadata, 
                fields: 'id' 
            });
            
            return createResponse.result.id;
        }
    } catch (error) {
        console.error(`å»ºç«‹è³‡æ–™å¤¾ ${folderName} å¤±æ•—:`, error);
        throw error;
    }
}

// æ–°å¢ï¼šå¾ URL åƒæ•¸è®€å– project ID
function loadProjectIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('projectId');
    if (projectId) {
        ui.projectIdInput.value = projectId;
        state.projectId = projectId;
        console.log('å¾ URL è®€å–åˆ°å°ˆæ¡ˆ ID:', projectId);
    }
}
</script>
</body>
</html>
