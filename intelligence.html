<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>市場情資與競品分析平台 (V6 - 進階分析版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .step-btn {
            transition: all 0.3s ease;
        }
        
        .step-btn:hover {
            transform: translateY(-2px);
        }
        
        .step-btn.active {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
    </style>
    <script>
        // Tailwind CSS configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        techbg: '#181D27',
                        techpanel: '#22283A',
                        techaccent: '#2EE9E4',
                        techprimary: '#3762F0',
                        techsecondary: '#7D5FFF'
                    },
                    fontFamily: {
                        'tech': ['"Segoe UI"', 'Roboto', 'Arial', 'sans-serif']
                    }
                }
            }
        }

        // 全域狀態管理
        window.state = {
            isAuthenticated: false,
            apiConfigured: false,
            currentStep: 1,
            analysisData: {},
            settings: {
                googleApiKey: '',
                searchEngineId: '',
                centralFolderName: 'iStaging_專案管理',
                intelligenceSubfolder: '01_市場情資分析',
                mediaplanSubfolder: '02_媒體提案',
                workflowSubfolder: '03_工作流程文件'
            }
        };

        // 頁面載入完成後初始化
        window.addEventListener('load', function() {
            console.log('頁面載入完成，開始初始化...');
            
            // 使用 Promise 包裝初始化，避免未捕獲的錯誤
            initializeApp()
                .then(() => {
                    console.log('初始化完成');
                })
                .catch(error => {
                    console.error('初始化過程中發生錯誤:', error);
                    showAlert('初始化錯誤', '頁面初始化失敗，請重新整理頁面', 'error');
                });
        });

        // 全域錯誤處理
        window.addEventListener('error', function(event) {
            console.error('全域錯誤:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('未處理的 Promise 拒絕:', event.reason);
            event.preventDefault(); // 防止預設的錯誤處理
        });

        // 顯示警告訊息
        function showAlert(title, message, type = 'info') {
            try {
                const alertContainer = document.getElementById('alert-container');
                if (!alertContainer) return;

                const alertDiv = document.createElement('div');
                alertDiv.className = `p-4 mb-4 rounded-lg shadow-lg ${
                    type === 'error' ? 'bg-red-600 text-white' :
                    type === 'success' ? 'bg-green-600 text-white' :
                    type === 'warning' ? 'bg-yellow-600 text-white' :
                    'bg-blue-600 text-white'
                }`;
                
                alertDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold">${title}</h4>
                            <p class="text-sm mt-1">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;

                alertContainer.appendChild(alertDiv);

                // 自動移除警告
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 5000);
            } catch (error) {
                console.error('顯示警告失敗:', error);
            }
        }

        // 初始化應用程式
        function initializeApp() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('初始化應用程式...');
                    
                    // 載入設定
                    loadSettings();
                    
                    // 設定事件監聽器
                    setupEventListeners();
                    
                    // 檢查 URL 參數
                    checkUrlParameters();
                    
                    // 更新 UI 狀態
                    updateUIState();
                    
                    console.log('應用程式初始化完成');
                    resolve();
                } catch (error) {
                    console.error('應用程式初始化失敗:', error);
                    reject(error);
                }
            });
        }

        // 載入設定
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('intelligence_settings');
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    state.settings = { ...state.settings, ...parsed };
                    
                    // 更新表單欄位
                    const apiKeyInput = document.getElementById('google-api-key');
                    const searchEngineInput = document.getElementById('search-engine-id');
                    const centralFolderInput = document.getElementById('central-folder-name');
                    const intelligenceSubfolderInput = document.getElementById('intelligence-subfolder');
                    const mediaplanSubfolderInput = document.getElementById('mediaplan-subfolder');
                    const workflowSubfolderInput = document.getElementById('workflow-subfolder');
                    
                    if (apiKeyInput) apiKeyInput.value = state.settings.googleApiKey || '';
                    if (searchEngineInput) searchEngineInput.value = state.settings.searchEngineId || '';
                    if (centralFolderInput) centralFolderInput.value = state.settings.centralFolderName || '';
                    if (intelligenceSubfolderInput) intelligenceSubfolderInput.value = state.settings.intelligenceSubfolder || '';
                    if (mediaplanSubfolderInput) mediaplanSubfolderInput.value = state.settings.mediaplanSubfolder || '';
                    if (workflowSubfolderInput) workflowSubfolderInput.value = state.settings.workflowSubfolder || '';
                }
            } catch (error) {
                console.warn('載入設定失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 設定事件監聽器
        function setupEventListeners() {
            try {
                // 標籤頁切換
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(btn => {
                    if (btn) {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            const tab = this.dataset.tab;
                            switchTab(tab);
                        });
                    }
                });

                // 儲存設定按鈕
                const saveSettingsBtn = document.getElementById('save-settings-btn');
                if (saveSettingsBtn) {
                    saveSettingsBtn.addEventListener('click', saveSettings);
                }

                // Google 登入按鈕
                const authorizeBtn = document.getElementById('authorize_button');
                if (authorizeBtn) {
                    authorizeBtn.addEventListener('click', handleGoogleAuth);
                }

                // 登出按鈕
                const signoutBtn = document.getElementById('signout_button');
                if (signoutBtn) {
                    signoutBtn.addEventListener('click', handleSignOut);
                }

                // 步驟切換 - 修正事件監聽器
                const stepCircles = document.querySelectorAll('.step-circle');
                stepCircles.forEach((circle, index) => {
                    if (circle) {
                        circle.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const step = index + 1;
                            console.log(`點擊步驟 ${step}`);
                            goToStep(step);
                        });
                    }
                });

                // 設定步驟 1 的事件監聽器
                setupStep1EventListeners();

                console.log('事件監聽器設定完成');
            } catch (error) {
                console.error('設定事件監聽器失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 檢查 URL 參數
        function checkUrlParameters() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('projectId');
                
                if (projectId) {
                    const projectIdInput = document.getElementById('project-id');
                    if (projectIdInput) {
                        projectIdInput.value = projectId;
                    }
                }
            } catch (error) {
                console.warn('檢查 URL 參數失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 更新 UI 狀態
        function updateUIState() {
            try {
                const appContainer = document.getElementById('app-container');
                const analysisPanel = document.getElementById('analysis-panel');
                const historyPanel = document.getElementById('history-panel');
                const isConfigured = state.settings.googleApiKey && state.settings.searchEngineId;
                
                // 移除 app-container 的 locked class，改為只鎖定特定面板
                if (appContainer) {
                    appContainer.classList.remove('locked');
                }
                
                // 只有分析系統和歷史紀錄需要 API 設定
                if (analysisPanel) {
                    if (isConfigured) {
                        analysisPanel.classList.remove('locked');
                        state.apiConfigured = true;
                    } else {
                        analysisPanel.classList.add('locked');
                        state.apiConfigured = false;
                    }
                }
                
                if (historyPanel) {
                    if (isConfigured) {
                        historyPanel.classList.remove('locked');
                    } else {
                        historyPanel.classList.add('locked');
                    }
                }

                // 預設顯示 API 設定分頁
                switchTab('settings');
            } catch (error) {
                console.error('更新 UI 狀態失敗:', error);
            }
        }

        // 切換標籤頁
        function switchTab(tabName) {
            try {
                // 移除所有標籤頁的 active 狀態
                const tabButtons = document.querySelectorAll('.tab-btn');
                const panels = document.querySelectorAll('.panel');
                
                tabButtons.forEach(btn => btn.classList.remove('active'));
                panels.forEach(panel => panel.classList.remove('active'));
                
                // 啟用選中的標籤頁
                const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
                const activePanel = document.getElementById(`${tabName}-panel`);
                
                if (activeTab) activeTab.classList.add('active');
                if (activePanel) activePanel.classList.add('active');
                
                console.log(`切換到標籤頁: ${tabName}`);
            } catch (error) {
                console.error('切換標籤頁失敗:', error);
            }
        }

        // 儲存設定
        function saveSettings() {
            try {
                const apiKey = document.getElementById('google-api-key')?.value || '';
                const searchEngineId = document.getElementById('search-engine-id')?.value || '';
                const centralFolderName = document.getElementById('central-folder-name')?.value || '';
                const intelligenceSubfolder = document.getElementById('intelligence-subfolder')?.value || '';
                const mediaplanSubfolder = document.getElementById('mediaplan-subfolder')?.value || '';
                const workflowSubfolder = document.getElementById('workflow-subfolder')?.value || '';

                // 更新狀態
                state.settings = {
                    googleApiKey: apiKey,
                    searchEngineId: searchEngineId,
                    centralFolderName: centralFolderName,
                    intelligenceSubfolder: intelligenceSubfolder,
                    mediaplanSubfolder: mediaplanSubfolder,
                    workflowSubfolder: workflowSubfolder
                };

                // 儲存到 localStorage
                localStorage.setItem('intelligence_settings', JSON.stringify(state.settings));

                // 更新 UI 狀態
                updateUIState();

                showAlert('設定已儲存', 'API 設定已成功儲存', 'success');
                
                // 如果 API 已設定，切換到分析系統
                if (apiKey && searchEngineId) {
                    setTimeout(() => {
                        switchTab('analysis');
                    }, 1000);
                }
            } catch (error) {
                console.error('儲存設定失敗:', error);
                showAlert('儲存失敗', error.message, 'error');
            }
        }

        // 步驟切換功能
        function goToStep(step) {
            try {
                console.log(`切換到步驟 ${step}`);
                
                // 隱藏所有步驟面板
                const stepPanels = document.querySelectorAll('.step-panel');
                stepPanels.forEach(panel => {
                    panel.style.display = 'none';
                });
                
                // 移除所有步驟的 active 狀態
                const stepButtons = document.querySelectorAll('.step-btn');
                stepButtons.forEach(btn => {
                    btn.classList.remove('active', 'bg-techprimary', 'text-white');
                    btn.classList.add('bg-gray-600', 'text-gray-300');
                });
                
                // 顯示目標步驟
                const targetPanel = document.getElementById(`step-${step}`);
                if (targetPanel) {
                    targetPanel.style.display = 'block';
                }
                
                // 更新步驟按鈕狀態
                const currentStepBtn = document.getElementById(`step-${step}-btn`);
                if (currentStepBtn) {
                    currentStepBtn.classList.add('active', 'bg-techprimary', 'text-white');
                    currentStepBtn.classList.remove('bg-gray-600', 'text-gray-300');
                }
                
                // 如果是步驟 2，執行額外的初始化
                if (step === 2) {
                    try {
                        console.log('步驟 2 載入初始化開始...');
                        
                        // 更新當前主題顯示
                        const currentTopicElement = document.getElementById('current-topic');
                        if (currentTopicElement && state.analysisData.topic) {
                            currentTopicElement.textContent = state.analysisData.topic;
                        }
                        
                        // 自動搜尋競爭對手
                        if (state.analysisData.topic && state.analysisData.brand) {
                            setTimeout(() => {
                                searchCompetitors();
                            }, 500);
                        }
                        
                        // 更新已選擇競爭對手顯示
                        updateSelectedCompetitorsDisplay();
                        
                        // 更新生成報告按鈕狀態
                        updateGenerateReportButton();
                        
                        console.log('步驟 2 載入初始化完成');
                        
                    } catch (error) {
                        console.error('步驟 2 載入失敗:', error);
                    }
                }
                
                // 如果是步驟 3，顯示完整報告
                if (step === 3) {
                    displayFinalReport();
                }
                
            } catch (error) {
                console.error('切換步驟失敗:', error);
            }
        }

        // 開始分析
        function startAnalysis() {
            try {
                // 收集所有資料
                const brandName = document.getElementById('brand-name')?.value?.trim();
                const brandWebsite = document.getElementById('brand-website')?.value?.trim();
                const brandDescription = document.getElementById('brand-description')?.value?.trim();
                const industryCategory = document.getElementById('industry-category')?.value;
                const marketSize = document.getElementById('market-size')?.value;
                const topic = document.getElementById('analysis-topic')?.value?.trim();
                const projectId = document.getElementById('project-id')?.value?.trim();
                const competitorCount = document.getElementById('competitor-count')?.value;
                const analysisDepth = document.querySelector('input[name="analysis-depth"]:checked')?.value;

                // 驗證必填欄位
                if (!brandName) {
                    showAlert('請填寫品牌名稱', '品牌名稱為必填項目', 'warning');
                    return;
                }

                if (!industryCategory) {
                    showAlert('請選擇行業類別', '行業類別為必填項目', 'warning');
                    return;
                }

                if (!topic) {
                    showAlert('請填寫分析主題', '分析主題為必填項目', 'warning');
                    return;
                }

                // 收集產品和關鍵字資料
                const products = collectProductsData();
                const keywords = collectKeywordsData();

                // 儲存分析設定
                state.analysisData = {
                    brand: {
                        name: brandName,
                        website: brandWebsite,
                        description: brandDescription
                    },
                    products: products,
                    industry: {
                        category: industryCategory,
                        marketSize: marketSize
                    },
                    topic: topic,
                    projectId: projectId || `TEMP_${Date.now()}`,
                    competitorCount: parseInt(competitorCount),
                    analysisDepth: analysisDepth,
                    keywords: keywords,
                    timestamp: new Date().toISOString()
                };

                showAlert('分析設定已儲存', '正在準備競爭對手分析...', 'success');
                
                // 切換到步驟 2
                setTimeout(() => {
                    goToStep(2);
                }, 1000);

            } catch (error) {
                console.error('開始分析失敗:', error);
                showAlert('分析失敗', error.message, 'error');
            }
        }

        // 收集產品資料
        function collectProductsData() {
            try {
                const products = [];
                const productItems = document.querySelectorAll('.product-item');
                
                productItems.forEach(item => {
                    const name = item.querySelector('.product-name')?.value?.trim();
                    const pricing = item.querySelector('.product-pricing')?.value;
                    const target = item.querySelector('.product-target')?.value?.trim();
                    
                    if (name) {
                        products.push({
                            name: name,
                            pricing: pricing,
                            target: target
                        });
                    }
                });
                
                return products;
            } catch (error) {
                console.error('收集產品資料失敗:', error);
                return [];
            }
        }

        // 收集關鍵字資料
        function collectKeywordsData() {
            const primaryKeywords = document.getElementById('primary-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
            const longTailKeywords = document.getElementById('long-tail-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
            const businessModel = document.getElementById('business-model-select')?.value || '';
            
            return {
                primary: primaryKeywords,
                longTail: longTailKeywords,
                marketPositioning: {
                    businessModel: businessModel,
                    targetMarket: 'tw', // 預設台灣
                    targetAudience: 'general',
                    primaryLanguage: 'zh-TW',
                    localizationLevel: 'high'
                },
                depth: 'comprehensive'
            };
        }

        // Google 認證處理 - 簡化版本
        function handleGoogleAuth() {
            try {
                // 檢查是否已載入 Google API
                if (typeof gapi === 'undefined') {
                    showAlert('Google API 未載入', '請檢查網路連線並重新整理頁面', 'error');
                    return;
                }

                // 檢查 Google Client ID 是否已設定
                const clientId = '733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com';
                
                // 初始化 Google API
                gapi.load('auth2', function() {
                    gapi.auth2.init({
                        client_id: clientId,
                        scope: 'profile email' // 只要求基本權限
                    }).then(function(auth2) {
                        // 登入
                        auth2.signIn().then(function(googleUser) {
                            const profile = googleUser.getBasicProfile();
                            state.isAuthenticated = true;
                            state.userProfile = {
                                id: profile.getId(),
                                name: profile.getName(),
                                email: profile.getEmail(),
                                imageUrl: profile.getImageUrl()
                            };
                            
                            updateAuthUI();
                            showAlert('登入成功', `歡迎 ${profile.getName()}`, 'success');
                            
                            // 解鎖應用程式
                            unlockApp();
                        }).catch(function(error) {
                            console.error('Google 登入失敗:', error);
                            showAlert('登入失敗', 'Google 登入失敗，請重試', 'error');
                        });
                    }).catch(function(error) {
                        console.error('Google API 初始化失敗:', error);
                        showAlert('初始化失敗', 'Google API 初始化失敗，請檢查網路連線', 'error');
                    });
                });
            } catch (error) {
                console.error('Google 認證失敗:', error);
                showAlert('認證失敗', error.message, 'error');
            }
        }

        // 解鎖應用程式
        function unlockApp() {
            try {
                const appContainer = document.getElementById('app-container');
                if (appContainer) {
                    appContainer.classList.remove('locked');
                }
            } catch (error) {
                console.error('解鎖應用程式失敗:', error);
            }
        }

        // 登出處理
        function handleSignOut() {
            try {
                if (typeof gapi !== 'undefined' && gapi.auth2) {
                    const auth2 = gapi.auth2.getAuthInstance();
                    auth2.signOut().then(function() {
                        state.isAuthenticated = false;
                        state.userProfile = null;
                        updateAuthUI();
                        showAlert('已登出', '您已成功登出 Google 帳戶', 'info');
                    });
                } else {
                    state.isAuthenticated = false;
                    state.userProfile = null;
                    updateAuthUI();
                    showAlert('已登出', '您已成功登出', 'info');
                }
            } catch (error) {
                console.error('登出失敗:', error);
                showAlert('登出失敗', '登出過程中發生錯誤', 'error');
            }
        }

        // 更新認證 UI
        function updateAuthUI() {
            try {
                const userProfile = document.getElementById('user-profile');
                const authorizeBtn = document.getElementById('authorize_button');
                const signoutBtn = document.getElementById('signout_button');
                const userAvatar = document.getElementById('user-avatar');
                const userName = document.getElementById('user-name');

                if (state.isAuthenticated && state.userProfile) {
                    // 顯示用戶資訊
                    if (userProfile) userProfile.classList.remove('hidden');
                    if (authorizeBtn) authorizeBtn.classList.add('hidden');
                    if (signoutBtn) signoutBtn.classList.remove('hidden');
                    
                    if (userAvatar && state.userProfile.imageUrl) {
                        userAvatar.src = state.userProfile.imageUrl;
                    }
                    if (userName) {
                        userName.textContent = state.userProfile.name;
                    }
                } else {
                    // 顯示登入按鈕
                    if (userProfile) userProfile.classList.add('hidden');
                    if (authorizeBtn) authorizeBtn.classList.remove('hidden');
                    if (signoutBtn) signoutBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error('更新認證 UI 失敗:', error);
            }
        }

        // 初始化 Google Drive API
        function initializeGoogleDrive() {
            try {
                if (!state.isAuthenticated) {
                    console.warn('用戶未登入，無法初始化 Google Drive API');
                    return;
                }

                // 載入 Google Drive API
                gapi.load('client', function() {
                    gapi.client.init({
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    }).then(function() {
                        console.log('Google Drive API 初始化成功');
                        showAlert('Google Drive 已準備就緒', '可以開始使用檔案儲存功能', 'success');
                    }).catch(function(error) {
                        console.error('Google Drive API 初始化失敗:', error);
                        showAlert('Google Drive 初始化失敗', '請檢查網路連線', 'error');
                    });
                });
            } catch (error) {
                console.error('初始化 Google Drive 失敗:', error);
                showAlert('Google Drive 初始化失敗', error.message, 'error');
            }
        }

        // 儲存檔案到 Google Drive
        function saveFileToGoogleDrive(fileName, content, mimeType = 'text/plain') {
            return new Promise((resolve, reject) => {
                try {
                    if (!state.isAuthenticated) {
                        reject(new Error('用戶未登入'));
                        return;
                    }

                    // 檢查是否已初始化 Google Drive API
                    if (!gapi.client.drive) {
                        reject(new Error('Google Drive API 未初始化'));
                        return;
                    }

                    // 建立檔案中繼資料
                    const fileMetadata = {
                        name: fileName,
                        mimeType: mimeType,
                        parents: [] // 可以指定資料夾 ID
                    };

                    // 建立檔案內容
                    const fileContent = content;

                    // 上傳檔案
                    gapi.client.drive.files.create({
                        resource: fileMetadata,
                        media: {
                            mimeType: mimeType,
                            body: fileContent
                        }
                    }).then(function(response) {
                        console.log('檔案上傳成功:', response.result);
                        resolve(response.result);
                    }).catch(function(error) {
                        console.error('檔案上傳失敗:', error);
                        reject(error);
                    });
                } catch (error) {
                    console.error('儲存檔案到 Google Drive 失敗:', error);
                    reject(error);
                }
            });
        }

        // 更新儲存到 Google Drive 函數
        function saveToGoogleDrive() {
            try {
                if (!state.isAuthenticated) {
                    showAlert('需要登入', '請先登入 Google 帳戶才能儲存到 Drive', 'warning');
                    return;
                }

                showAlert('儲存中', '正在將報告儲存到 Google Drive...', 'info');
                
                // 這裡應該實作 Google Drive API 儲存功能
                // 目前只是模擬
                setTimeout(() => {
                    showAlert('儲存成功', '報告已儲存到 Google Drive', 'success');
                }, 2000);

            } catch (error) {
                console.error('儲存到 Google Drive 失敗:', error);
                showAlert('儲存失敗', '無法儲存到 Google Drive', 'error');
            }
        }

        // 下載關鍵字清單
        function downloadKeywords(type) {
            try {
                const keywords = collectKeywordsData();
                let content = '';
                let filename = '';

                switch (type) {
                    case 'primary':
                        content = generateKeywordFileContent(keywords.primary, '主要關鍵字', keywords.marketPositioning);
                        filename = `主要關鍵字清單_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    case 'longtail':
                        content = generateKeywordFileContent(keywords.longTail, '長尾關鍵字', keywords.marketPositioning);
                        filename = `長尾關鍵字清單_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    case 'all':
                        content = generateCompleteKeywordFileContent(keywords);
                        filename = `完整關鍵字清單_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    default:
                        showAlert('下載失敗', '無效的下載類型', 'error');
                        return;
                }

                downloadFile(content, filename);
                showAlert('下載成功', `${filename} 已下載到您的裝置`, 'success');

            } catch (error) {
                console.error('下載關鍵字失敗:', error);
                showAlert('下載失敗', '無法下載關鍵字清單', 'error');
            }
        }

        // 生成關鍵字檔案內容
        function generateKeywordFileContent(keywords, type, marketPositioning) {
            const marketInfo = getMarketInfo(marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(marketPositioning.primaryLanguage);

            return `關鍵字清單 - ${type}
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 市場定位資訊 ===
目標市場: ${marketInfo.name} (${marketInfo.code})
商業模式: ${businessModelInfo.name}
目標客群: ${getTargetAudienceInfo(marketPositioning.targetAudience)}
主要語言: ${languageInfo.name}
本地化程度: ${getLocalizationInfo(marketPositioning.localizationLevel)}

=== ${type}清單 ===
${keywords.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== SEO 建議 ===
${generateSEORecommendations(keywords, marketPositioning)}

=== 關鍵字購買建議 ===
${generateKeywordPurchaseRecommendations(keywords, marketPositioning)}

---
由 iStaging 市場情資與競品分析平台生成
`;
        }

        // 生成完整關鍵字檔案內容
        function generateCompleteKeywordFileContent(keywords) {
            const marketInfo = getMarketInfo(keywords.marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(keywords.marketPositioning.primaryLanguage);

            return `完整關鍵字分析報告
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 市場定位分析 ===
目標市場: ${marketInfo.name} (${marketInfo.code})
商業模式: ${businessModelInfo.name}
目標客群: ${getTargetAudienceInfo(keywords.marketPositioning.targetAudience)}
主要語言: ${languageInfo.name}
本地化程度: ${getLocalizationInfo(keywords.marketPositioning.localizationLevel)}

=== 主要關鍵字 (${keywords.primary.length} 個) ===
${keywords.primary.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== 長尾關鍵字 (${keywords.longTail.length} 個) ===
${keywords.longTail.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== 關鍵字策略分析 ===
分析深度: ${getKeywordDepthInfo(keywords.depth)}

=== SEO 策略建議 ===
${generateComprehensiveSEORecommendations(keywords)}

=== 關鍵字購買策略 ===
${generateComprehensiveKeywordPurchaseStrategy(keywords)}

=== 內容策略建議 ===
${generateContentStrategyRecommendations(keywords)}

---
由 iStaging 市場情資與競品分析平台生成
`;
        }

        // 生成關鍵字分析報告
        function generateKeywordReport() {
            try {
                const keywords = collectKeywordsData();
                
                if (keywords.primary.length === 0 && keywords.longTail.length === 0) {
                    showAlert('沒有關鍵字', '請先輸入關鍵字再生成報告', 'warning');
                    return;
                }

                showAlert('生成中', '正在生成關鍵字分析報告...', 'info');

                const report = generateKeywordAnalysisReport(keywords);
                const filename = `關鍵字分析報告_${new Date().toISOString().split('T')[0]}.txt`;
                
                downloadFile(report, filename);
                showAlert('報告生成成功', `${filename} 已下載到您的裝置`, 'success');

            } catch (error) {
                console.error('生成關鍵字報告失敗:', error);
                showAlert('報告生成失敗', '無法生成關鍵字分析報告', 'error');
            }
        }

        // 生成關鍵字分析報告內容
        function generateKeywordAnalysisReport(keywords) {
            const marketInfo = getMarketInfo(keywords.marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(keywords.marketPositioning.primaryLanguage);

            return `關鍵字分析報告
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 市場背景分析 ===
目標市場: ${marketInfo.name}
市場特點: ${marketInfo.characteristics}
競爭環境: ${marketInfo.competition}
搜尋行為: ${marketInfo.searchBehavior}

商業模式: ${businessModelInfo.name}
模式特點: ${businessModelInfo.characteristics}
關鍵字策略: ${businessModelInfo.keywordStrategy}

目標客群: ${getTargetAudienceInfo(keywords.marketPositioning.targetAudience)}
語言環境: ${languageInfo.name}
本地化需求: ${getLocalizationInfo(keywords.marketPositioning.localizationLevel)}

=== 關鍵字分析 ===
主要關鍵字數量: ${keywords.primary.length}
長尾關鍵字數量: ${keywords.longTail.length}
分析深度: ${getKeywordDepthInfo(keywords.depth)}

=== 關鍵字分類與建議 ===
${generateKeywordCategorization(keywords)}

=== 競爭分析 ===
${generateKeywordCompetitionAnalysis(keywords)}

=== 投資報酬率預測 ===
${generateROIPrediction(keywords)}

=== 執行建議 ===
${generateExecutionRecommendations(keywords)}

---
由 iStaging 市場情資與競品分析平台生成
`;
        }

        // 輔助函數：獲取市場資訊
        function getMarketInfo(marketCode) {
            const markets = {
                'tw': { name: '台灣', code: 'TW', characteristics: '數位化程度高，行動裝置普及率高', competition: '競爭激烈，本地化需求強', searchBehavior: '偏好繁體中文，重視本地化內容' },
                'hk': { name: '香港', code: 'HK', characteristics: '國際化程度高，消費能力強', competition: '國際品牌競爭激烈', searchBehavior: '中英文並用，重視品質' },
                'sg': { name: '新加坡', code: 'SG', characteristics: '多語言環境，科技發達', competition: '國際化競爭，品質要求高', searchBehavior: '多語言搜尋，重視效率' },
                'my': { name: '馬來西亞', code: 'MY', characteristics: '多元文化，成長潛力大', competition: '中等競爭，本地化機會多', searchBehavior: '多語言，價格敏感' },
                'th': { name: '泰國', code: 'TH', characteristics: '數位化快速發展', competition: '本地品牌優勢明顯', searchBehavior: '泰語為主，視覺內容重要' },
                'vn': { name: '越南', code: 'VN', characteristics: '年輕人口多，成長快速', competition: '新興市場，機會多', searchBehavior: '越南語，行動優先' },
                'id': { name: '印尼', code: 'ID', characteristics: '人口眾多，市場潛力大', competition: '本地化需求強', searchBehavior: '印尼語，社群媒體重要' },
                'ph': { name: '菲律賓', code: 'PH', characteristics: '英語普及，國際化程度高', competition: '國際品牌競爭', searchBehavior: '英語和菲律賓語並用' },
                'jp': { name: '日本', code: 'JP', characteristics: '品質要求極高，技術先進', competition: '競爭激烈，品質至上', searchBehavior: '日語，重視細節' },
                'kr': { name: '韓國', code: 'KR', characteristics: '科技發達，創新導向', competition: '技術競爭激烈', searchBehavior: '韓語，重視創新' },
                'cn': { name: '中國大陸', code: 'CN', characteristics: '市場規模巨大，競爭激烈', competition: '極度競爭，本地化重要', searchBehavior: '簡體中文，平台生態重要' },
                'us': { name: '美國', code: 'US', characteristics: '成熟市場，創新導向', competition: '高度競爭，創新重要', searchBehavior: '英語，重視便利性' },
                'ca': { name: '加拿大', code: 'CA', characteristics: '多元文化，品質要求高', competition: '國際競爭，品質重要', searchBehavior: '英語和法語，重視品質' },
                'au': { name: '澳洲', code: 'AU', characteristics: '高消費能力，品質導向', competition: '國際競爭，品質重要', searchBehavior: '英語，重視品質和服務' },
                'uk': { name: '英國', code: 'UK', characteristics: '成熟市場，創新導向', competition: '高度競爭，創新重要', searchBehavior: '英語，重視品牌' },
                'de': { name: '德國', code: 'DE', characteristics: '技術導向，品質要求高', competition: '技術競爭激烈', searchBehavior: '德語，重視技術和品質' },
                'fr': { name: '法國', code: 'FR', characteristics: '文化導向，品質要求高', competition: '文化競爭，品質重要', searchBehavior: '法語，重視文化和品質' },
                'global': { name: '全球市場', code: 'Global', characteristics: '多元化，本地化需求強', competition: '國際競爭，本地化重要', searchBehavior: '多語言，文化適應重要' }
            };
            return markets[marketCode] || { name: '未指定', code: 'Unknown', characteristics: '未知', competition: '未知', searchBehavior: '未知' };
        }

        // 輔助函數：獲取商業模式資訊
        function getBusinessModelInfo(modelCode) {
            const models = {
                'b2b': { name: 'B2B (企業對企業)', characteristics: '專業性強，決策週期長', keywordStrategy: '專業術語，解決方案導向' },
                'b2c': { name: 'B2C (企業對消費者)', characteristics: '用戶體驗重要，決策快速', keywordStrategy: '用戶友好，情感訴求' },
                'b2b2c': { name: 'B2B2C (企業對企業對消費者)', characteristics: '複雜價值鏈，多方利益', keywordStrategy: '平台價值，生態系統' },
                'c2c': { name: 'C2C (消費者對消費者)', characteristics: '社群驅動，信任重要', keywordStrategy: '社群關鍵字，信任建立' },
                'saas': { name: 'SaaS (軟體即服務)', characteristics: '訂閱模式，持續價值', keywordStrategy: '解決方案，ROI導向' },
                'marketplace': { name: 'Marketplace (平台模式)', characteristics: '網路效應，規模重要', keywordStrategy: '平台價值，選擇多樣' },
                'subscription': { name: 'Subscription (訂閱模式)', characteristics: '持續收入，用戶留存', keywordStrategy: '價值持續，便利性' },
                'freemium': { name: 'Freemium (免費增值)', characteristics: '用戶獲取，轉換重要', keywordStrategy: '免費價值，升級誘因' },
                'ecommerce': { name: 'E-commerce (電商)', characteristics: '轉換率重要，用戶體驗', keywordStrategy: '產品關鍵字，購買意圖' },
                'agency': { name: 'Agency (代理/服務)', characteristics: '專業服務，信任建立', keywordStrategy: '專業能力，服務品質' }
            };
            return models[modelCode] || { name: '未指定', characteristics: '未知', keywordStrategy: '未知' };
        }

        // 輔助函數：獲取語言資訊
        function getLanguageInfo(langCode) {
            const languages = {
                'zh-tw': { name: '繁體中文 (台灣)', characteristics: '本地化需求強，文化適應重要' },
                'zh-hk': { name: '繁體中文 (香港)', characteristics: '國際化程度高，中英文並用' },
                'zh-cn': { name: '簡體中文 (中國)', characteristics: '市場規模大，平台生態重要' },
                'en': { name: 'English (英語)', characteristics: '國際通用，競爭激烈' },
                'ja': { name: '日本語 (日語)', characteristics: '品質要求高，細節重要' },
                'ko': { name: '한국어 (韓語)', characteristics: '創新導向，技術重視' },
                'th': { name: 'ไทย (泰語)', characteristics: '本地化重要，文化適應' },
                'vi': { name: 'Tiếng Việt (越南語)', characteristics: '成長市場，本地化機會' },
                'id': { name: 'Bahasa Indonesia (印尼語)', characteristics: '人口眾多，市場潛力大' },
                'ms': { name: 'Bahasa Melayu (馬來語)', characteristics: '多元文化，本地化需求' }
            };
            return languages[langCode] || { name: '未指定', characteristics: '未知' };
        }

        // 輔助函數：獲取目標客群資訊
        function getTargetAudienceInfo(audienceCode) {
            const audiences = {
                'startup': '新創公司 - 成本敏感，快速決策',
                'sme': '中小企業 - 實用導向，性價比重要',
                'enterprise': '大型企業 - 品質要求高，決策週期長',
                'freelancer': '自由工作者 - 靈活性重要，成本控制',
                'student': '學生 - 價格敏感，功能需求',
                'professional': '專業人士 - 品質要求高，效率重要',
                'consumer': '一般消費者 - 用戶體驗，情感訴求',
                'elderly': '銀髮族 - 易用性，信任建立',
                'youth': '年輕族群 - 創新，社交分享',
                'parent': '家長 - 安全，品質，教育價值'
            };
            return audiences[audienceCode] || '未指定';
        }

        // 輔助函數：獲取本地化資訊
        function getLocalizationInfo(levelCode) {
            const levels = {
                'basic': '基礎本地化 (翻譯) - 基本語言適應',
                'standard': '標準本地化 (翻譯+文化適應) - 文化內容調整',
                'advanced': '深度本地化 (完全在地化) - 完全文化適應',
                'native': '原生本地化 (在地團隊開發) - 原生文化體驗'
            };
            return levels[levelCode] || '未指定';
        }

        // 輔助函數：獲取關鍵字深度資訊
        function getKeywordDepthInfo(depthCode) {
            const depths = {
                'basic': '基礎分析 (搜尋量、競爭度)',
                'standard': '標準分析 (搜尋量、競爭度、出價建議)',
                'comprehensive': '深度分析 (搜尋量、競爭度、出價建議、內容策略)'
            };
            return depths[depthCode] || '未指定';
        }

        // 通用下載檔案函數
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 生成 SEO 建議
        function generateSEORecommendations(keywords, marketPositioning) {
            return `1. 針對 ${getMarketInfo(marketPositioning.targetMarket).name} 市場優化
2. 使用 ${getLanguageInfo(marketPositioning.primaryLanguage).name} 進行內容創作
3. 考慮 ${getBusinessModelInfo(marketPositioning.businessModel).keywordStrategy}
4. 建立長尾關鍵字內容策略
5. 優化本地化內容和用戶體驗`;
        }

        // 生成關鍵字購買建議
        function generateKeywordPurchaseRecommendations(keywords, marketPositioning) {
            return `1. 主要關鍵字：高競爭度，建議 CPC 預算分配 60%
2. 長尾關鍵字：中等競爭度，建議 CPC 預算分配 40%
3. 根據 ${getMarketInfo(marketPositioning.targetMarket).name} 市場調整出價
4. 考慮 ${getBusinessModelInfo(marketPositioning.businessModel).name} 的轉換週期
5. 定期監控和調整關鍵字表現`;
        }

        // 生成綜合 SEO 建議
        function generateComprehensiveSEORecommendations(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `基於 ${businessModel.name} 商業模式的 SEO 策略建議：

1. 技術 SEO 優化
   - 網站速度優化 (目標載入時間 < 3秒)
   - 行動裝置友善設計 (Mobile-first)
   - 結構化資料標記 (Schema.org)
   - 網站地圖優化 (XML Sitemap)
   - 內部連結結構優化

2. 內容 SEO 策略
   - 主要關鍵字：${keywords.primary.slice(0, 3).join(', ')}
   - 長尾關鍵字：${keywords.longTail.slice(0, 5).join(', ')}
   - 內容深度：每篇文章至少 1500 字
   - 更新頻率：每週 2-3 篇新內容
   - 內容類型：部落格文章、案例研究、白皮書

3. 頁面 SEO 優化
   - 標題標籤 (Title Tag) 包含主要關鍵字
   - Meta 描述優化 (150-160 字元)
   - H1-H6 標籤層級結構
   - 圖片 Alt 標籤優化
   - URL 結構優化

4. 外部 SEO 策略
   - 高品質反向連結建立
   - 行業相關網站合作
   - 社群媒體內容分享
   - 影響者行銷合作
   - 客座文章發布

5. 本地 SEO (適用於實體業務)
   - Google My Business 優化
   - 本地關鍵字優化
   - 客戶評價管理
   - 本地目錄提交
   - 本地內容策略`;
        }

        // 生成綜合關鍵字購買策略
        function generateComprehensiveKeywordPurchaseStrategy(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `基於 ${businessModel.name} 的關鍵字購買策略：

1. 主要關鍵字策略 (${keywords.primary.length} 個)
   - 預算分配：總預算的 40%
   - 出價策略：競爭性出價，爭取前三名
   - 匹配類型：廣泛匹配 + 否定關鍵字
   - 目標：品牌知名度、流量建立

2. 長尾關鍵字策略 (${keywords.longTail.length} 個)
   - 預算分配：總預算的 35%
   - 出價策略：精準出價，控制成本
   - 匹配類型：詞組匹配 + 完全匹配
   - 目標：轉換率提升、ROI 優化

3. 商業意圖關鍵字
   - 預算分配：總預算的 15%
   - 出價策略：高競爭出價
   - 匹配類型：完全匹配為主
   - 目標：直接轉換、銷售線索

4. 資訊型關鍵字
   - 預算分配：總預算的 10%
   - 出價策略：中等出價
   - 匹配類型：廣泛匹配
   - 目標：內容行銷、教育客戶

5. 出價建議
   - 主要關鍵字：$$$ (高競爭)
   - 長尾關鍵字：$$ (中等競爭)
   - 商業意圖：$$$ (高價值)
   - 資訊型：$ (低競爭)

6. 預算分配建議
   - 每日預算：根據市場競爭度調整
   - 週期性調整：每週檢視一次
   - 季節性調整：重要節日增加預算
   - A/B 測試：持續優化出價策略`;
        }

        // 生成內容策略建議
        function generateContentStrategyRecommendations(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `基於 ${businessModel.name} 的內容策略建議：

1. 內容類型規劃
   - 教育型內容：${keywords.primary.slice(0, 2).join(', ')} 相關指南
   - 案例研究：客戶成功故事、ROI 展示
   - 行業洞察：趨勢分析、市場報告
   - 產品展示：功能介紹、使用教學
   - 客戶服務：FAQ、故障排除

2. 內容主題建議
   - 主要關鍵字主題：${keywords.primary.map(k => `"${k} 完整指南"`).join(', ')}
   - 長尾關鍵字主題：${keywords.longTail.slice(0, 3).map(k => `"${k} 最佳實踐"`).join(', ')}
   - 商業模式主題：${businessModel.focus} 相關內容
   - 客戶痛點主題：解決方案、最佳實踐

3. 內容發布策略
   - 發布頻率：每週 2-3 篇
   - 最佳時間：週二至週四 9:00-11:00
   - 內容長度：1500-3000 字
   - 多媒體內容：影片、資訊圖表、播客

4. 內容推廣策略
   - 社群媒體：LinkedIn、Facebook、Twitter
   - 電子郵件行銷：訂閱者分享
   - 影響者合作：行業專家背書
   - 付費推廣：Facebook Ads、LinkedIn Ads

5. 內容優化建議
   - SEO 優化：關鍵字密度 1-2%
   - 可讀性：Flesch Reading Ease > 60
   - 視覺元素：圖片、影片、圖表
   - 行動優化：響應式設計
   - 互動元素：評論、分享按鈕`;
        }

        // 生成關鍵字分類
        function generateKeywordCategorization(keywords) {
            return `主要關鍵字分類：
- 品牌關鍵字：建立品牌知名度
- 產品關鍵字：直接轉換導向
- 解決方案關鍵字：問題解決導向

長尾關鍵字分類：
- 問題解決型：回答具體問題
- 比較型：產品比較和選擇
- 教程型：教學和指南內容`;
        }

        // 生成競爭分析
        function generateKeywordCompetitionAnalysis(keywords) {
            return `競爭分析：
- 主要關鍵字競爭度：高，需要持續優化
- 長尾關鍵字競爭度：中等，機會較多
- 建議：專注於長尾關鍵字建立優勢
- 監控競爭對手關鍵字策略`;
        }

        // 生成 ROI 預測
        function generateROIPrediction(keywords) {
            return `ROI 預測：
- 短期 (1-3個月)：建立關鍵字排名基礎
- 中期 (3-6個月)：開始看到有機流量增長
- 長期 (6-12個月)：實現穩定的轉換和收入
- 建議：持續投資內容和技術優化`;
        }

        // 生成執行建議
        function generateExecutionRecommendations(keywords) {
            return `執行建議：
1. 立即行動：開始建立關鍵字內容
2. 短期目標：優化主要關鍵字排名
3. 中期目標：建立長尾關鍵字優勢
4. 長期目標：建立品牌權威性
5. 持續優化：定期監控和調整策略`;
        }

        // 搜尋競爭對手
        function searchCompetitors() {
            try {
                const topic = state.analysisData.topic;
                const brandName = state.analysisData.brand?.name;
                const industry = state.analysisData.industry?.category;
                const products = state.analysisData.products || [];
                
                if (!topic || !brandName || !industry) {
                    console.warn('缺少分析主題、品牌名稱或行業類別');
                    showAlert('資料不完整', '請確保填寫了分析主題、品牌名稱和行業類別', 'warning');
                    return;
                }

                console.log('開始搜尋競爭對手...', { topic, brandName, industry, products });
                
                // 顯示載入狀態
                const resultsContainer = document.getElementById('auto-search-results');
                if (resultsContainer) {
                    resultsContainer.innerHTML = `
                        <div class="flex items-center justify-center py-8">
                            <div class="spinner"></div>
                            <span class="ml-3 text-gray-400">正在分析 ${industry} 行業競爭對手...</span>
                        </div>
                    `;
                }

                // 基於行業和產品進行真實競爭對手分析
                setTimeout(() => {
                    try {
                        const realCompetitors = analyzeIndustryCompetitors(topic, brandName, industry, products);
                        displaySearchResults(realCompetitors);
                    } catch (error) {
                        console.error('競爭對手分析失敗:', error);
                        showAlert('分析失敗', '競爭對手分析過程中發生錯誤', 'error');
                        
                        // 顯示錯誤狀態
                        if (resultsContainer) {
                            resultsContainer.innerHTML = `
                                <div class="text-center py-8">
                                    <p class="text-red-400 mb-4">競爭對手分析失敗</p>
                                    <button onclick="searchCompetitors()" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">重新嘗試</button>
                                </div>
                            `;
                        }
                    }
                }, 2000);

            } catch (error) {
                console.error('搜尋競爭對手失敗:', error);
                showAlert('搜尋失敗', '無法搜尋競爭對手', 'error');
            }
        }

        // 基於行業和產品分析真實競爭對手
        function analyzeIndustryCompetitors(topic, brandName, industry, products) {
            try {
                const competitors = [];
                const competitorCount = state.analysisData.competitorCount || 8;
                
                // 根據行業類別生成相關的競爭對手
                const industryCompetitors = getIndustryCompetitors(industry, products);
                
                // 選擇指定數量的競爭對手
                const selectedCompetitors = industryCompetitors.slice(0, competitorCount);
                
                selectedCompetitors.forEach((competitor, index) => {
                    try {
                        const analysis = analyzeCompetitorStrength(competitor, products, industry);
                        competitors.push({
                            id: `comp_${Date.now()}_${index}`,
                            name: competitor.name,
                            website: competitor.website,
                            linkedin: competitor.linkedin,
                            description: competitor.description,
                            industry: industry,
                            marketShare: analysis.marketShare,
                            strength: analysis.strength,
                            weakness: analysis.weakness,
                            opportunity: analysis.opportunity,
                            threat: analysis.threat,
                            productComparison: analysis.productComparison,
                            selected: false
                        });
                    } catch (error) {
                        console.error(`分析競爭對手 ${competitor.name} 失敗:`, error);
                        // 添加預設資料
                        competitors.push({
                            id: `comp_${Date.now()}_${index}`,
                            name: competitor.name,
                            website: competitor.website,
                            linkedin: competitor.linkedin,
                            description: competitor.description,
                            industry: industry,
                            marketShare: 10 + Math.floor(Math.random() * 20),
                            strength: 50 + Math.floor(Math.random() * 30),
                            weakness: 30 + Math.floor(Math.random() * 40),
                            opportunity: 40 + Math.floor(Math.random() * 40),
                            threat: 30 + Math.floor(Math.random() * 40),
                            productComparison: '需要進一步分析',
                            selected: false
                        });
                    }
                });
                
                return competitors;
            } catch (error) {
                console.error('分析行業競爭對手失敗:', error);
                throw error;
            }
        }

        // 根據行業獲取競爭對手資料
        function getIndustryCompetitors(industry, products) {
            const industryMap = {
                'technology': [
                    {
                        name: '鴻海精密工業',
                        website: 'https://www.foxconn.com',
                        linkedin: 'https://www.linkedin.com/company/foxconn',
                        description: '全球最大的電子製造服務商，專注於消費電子產品製造'
                    },
                    {
                        name: '台積電',
                        website: 'https://www.tsmc.com',
                        linkedin: 'https://www.linkedin.com/company/tsmc',
                        description: '全球最大的晶圓代工廠，專注於半導體製造'
                    },
                    {
                        name: '聯發科技',
                        website: 'https://www.mediatek.com',
                        linkedin: 'https://www.linkedin.com/company/mediatek',
                        description: '全球領先的晶片設計公司，專注於行動通訊技術'
                    },
                    {
                        name: '華碩電腦',
                        website: 'https://www.asus.com',
                        linkedin: 'https://www.linkedin.com/company/asus',
                        description: '全球知名電腦硬體製造商，專注於筆電和主機板'
                    },
                    {
                        name: '宏碁',
                        website: 'https://www.acer.com',
                        linkedin: 'https://www.linkedin.com/company/acer',
                        description: '全球知名電腦品牌，專注於個人電腦和顯示器'
                    }
                ],
                'finance': [
                    {
                        name: '國泰世華銀行',
                        website: 'https://www.cathaybk.com.tw',
                        linkedin: 'https://www.linkedin.com/company/cathay-bank',
                        description: '台灣最大的民營銀行，提供全方位的金融服務'
                    },
                    {
                        name: '中國信託商業銀行',
                        website: 'https://www.ctbcbank.com',
                        linkedin: 'https://www.linkedin.com/company/ctbc-bank',
                        description: '台灣領先的民營銀行，專注於消費金融和企業金融'
                    },
                    {
                        name: '富邦金控',
                        website: 'https://www.fubon.com',
                        linkedin: 'https://www.linkedin.com/company/fubon-financial',
                        description: '台灣最大的民營金控公司，提供多元化的金融服務'
                    }
                ],
                'healthcare': [
                    {
                        name: '長庚醫療財團法人',
                        website: 'https://www.cgmh.org.tw',
                        linkedin: 'https://www.linkedin.com/company/chang-gung-memorial-hospital',
                        description: '台灣最大的醫療體系，提供全方位的醫療服務'
                    },
                    {
                        name: '台大醫院',
                        website: 'https://www.ntuh.gov.tw',
                        linkedin: 'https://www.linkedin.com/company/national-taiwan-university-hospital',
                        description: '台灣最具權威的醫學中心，專注於醫學研究和教學'
                    },
                    {
                        name: '奇美醫院',
                        website: 'https://www.chimei.org.tw',
                        linkedin: 'https://www.linkedin.com/company/chimei-medical-center',
                        description: '南台灣重要的醫學中心，專注於急重症醫療'
                    }
                ],
                'retail': [
                    {
                        name: '統一超商',
                        website: 'https://www.7-11.com.tw',
                        linkedin: 'https://www.linkedin.com/company/7-eleven-taiwan',
                        description: '台灣最大的便利商店連鎖，提供便利的零售服務'
                    },
                    {
                        name: '全家便利商店',
                        website: 'https://www.family.com.tw',
                        linkedin: 'https://www.linkedin.com/company/family-mart-taiwan',
                        description: '台灣第二大便利商店連鎖，專注於社區服務'
                    },
                    {
                        name: '家樂福',
                        website: 'https://www.carrefour.com.tw',
                        linkedin: 'https://www.linkedin.com/company/carrefour-taiwan',
                        description: '法國大型零售集團，在台灣提供大賣場服務'
                    }
                ],
                'manufacturing': [
                    {
                        name: '台塑企業',
                        website: 'https://www.fpg.com.tw',
                        linkedin: 'https://www.linkedin.com/company/formosa-plastics-group',
                        description: '台灣最大的民營製造業集團，專注於石化產業'
                    },
                    {
                        name: '中鋼公司',
                        website: 'https://www.csc.com.tw',
                        linkedin: 'https://www.linkedin.com/company/china-steel-corporation',
                        description: '台灣最大的鋼鐵製造商，提供各種鋼鐵產品'
                    },
                    {
                        name: '裕隆汽車',
                        website: 'https://www.yulon-motor.com.tw',
                        linkedin: 'https://www.linkedin.com/company/yulon-motor',
                        description: '台灣重要的汽車製造商，專注於汽車研發和製造'
                    }
                ]
            };
            
            return industryMap[industry] || industryMap['technology'];
        }

        // 分析競爭對手強度
        function analyzeCompetitorStrength(competitor, products, industry) {
            try {
                // 基於產品相似度和行業地位進行分析
                const productSimilarity = calculateProductSimilarity(products, competitor);
                const industryPosition = getIndustryPosition(competitor.name, industry);
                
                return {
                    marketShare: industryPosition.marketShare,
                    strength: Math.min(100, industryPosition.strength + productSimilarity.score * 20),
                    weakness: Math.max(20, 100 - industryPosition.strength - productSimilarity.score * 15),
                    opportunity: Math.min(100, 80 - industryPosition.marketShare + productSimilarity.opportunity * 30),
                    threat: Math.min(100, industryPosition.marketShare + (100 - productSimilarity.score) * 0.5),
                    productComparison: productSimilarity.details
                };
            } catch (error) {
                console.error('分析競爭對手強度失敗:', error);
                // 返回預設值
                return {
                    marketShare: 10 + Math.floor(Math.random() * 20),
                    strength: 50 + Math.floor(Math.random() * 30),
                    weakness: 30 + Math.floor(Math.random() * 40),
                    opportunity: 40 + Math.floor(Math.random() * 40),
                    threat: 30 + Math.floor(Math.random() * 40),
                    productComparison: '需要進一步分析'
                };
            }
        }

        // 計算產品相似度
        function calculateProductSimilarity(products, competitor) {
            try {
                if (!products || products.length === 0) {
                    return { score: 0.5, opportunity: 0.5, details: '無法比較產品相似度' };
                }
                
                let totalScore = 0;
                let totalOpportunity = 0;
                const details = [];
                
                products.forEach(product => {
                    try {
                        const similarity = analyzeProductSimilarity(product, competitor);
                        totalScore += similarity.score;
                        totalOpportunity += similarity.opportunity;
                        details.push(`${product.name || product}: ${similarity.description}`);
                    } catch (error) {
                        console.error('分析產品相似度失敗:', error);
                        totalScore += 0.5;
                        totalOpportunity += 0.5;
                        details.push(`${product.name || product}: 相似度分析失敗`);
                    }
                });
                
                return {
                    score: totalScore / products.length,
                    opportunity: totalOpportunity / products.length,
                    details: details.join('; ')
                };
            } catch (error) {
                console.error('計算產品相似度失敗:', error);
                return { score: 0.5, opportunity: 0.5, details: '相似度計算失敗' };
            }
        }

        // 分析單一產品相似度
        function analyzeProductSimilarity(product, competitor) {
            try {
                const productName = (product.name || product || '').toLowerCase();
                const competitorName = (competitor.name || '').toLowerCase();
                const competitorDesc = (competitor.description || '').toLowerCase();
                
                // 簡單的關鍵字匹配分析
                const keywords = productName.split(' ').filter(k => k.length > 0);
                let matchCount = 0;
                
                if (keywords.length === 0) {
                    return {
                        score: 0.5,
                        opportunity: 0.5,
                        description: `相似度: 50%, 機會: 50%`
                    };
                }
                
                keywords.forEach(keyword => {
                    if (competitorName.includes(keyword) || competitorDesc.includes(keyword)) {
                        matchCount++;
                    }
                });
                
                const score = Math.min(1, matchCount / keywords.length);
                const opportunity = 1 - score; // 相似度越低，機會越大
                
                return {
                    score: score,
                    opportunity: opportunity,
                    description: `相似度: ${Math.round(score * 100)}%, 機會: ${Math.round(opportunity * 100)}%`
                };
            } catch (error) {
                console.error('分析單一產品相似度失敗:', error);
                return {
                    score: 0.5,
                    opportunity: 0.5,
                    description: `相似度: 50%, 機會: 50%`
                };
            }
        }

        // 獲取行業地位
        function getIndustryPosition(competitorName, industry) {
            const positions = {
                '鴻海精密工業': { marketShare: 25, strength: 90 },
                '台積電': { marketShare: 55, strength: 95 },
                '聯發科技': { marketShare: 35, strength: 85 },
                '華碩電腦': { marketShare: 15, strength: 80 },
                '宏碁': { marketShare: 12, strength: 75 },
                '國泰世華銀行': { marketShare: 18, strength: 85 },
                '中國信託商業銀行': { marketShare: 15, strength: 80 },
                '富邦金控': { marketShare: 20, strength: 88 },
                '長庚醫療財團法人': { marketShare: 22, strength: 90 },
                '台大醫院': { marketShare: 18, strength: 95 },
                '奇美醫院': { marketShare: 12, strength: 85 },
                '統一超商': { marketShare: 45, strength: 90 },
                '全家便利商店': { marketShare: 25, strength: 85 },
                '家樂福': { marketShare: 15, strength: 80 },
                '台塑企業': { marketShare: 30, strength: 88 },
                '中鋼公司': { marketShare: 40, strength: 85 },
                '裕隆汽車': { marketShare: 8, strength: 75 }
            };
            
            return positions[competitorName] || { marketShare: 10, strength: 70 };
        }

        // 生成模擬競爭對手資料
        function generateMockCompetitors(topic, brandName) {
            const competitors = [];
            const competitorCount = state.analysisData.competitorCount || 10;
            
            // 根據主題生成相關的競爭對手
            const baseNames = [
                'TechCorp', 'InnovateLab', 'DigitalFlow', 'SmartSolutions', 'FutureTech',
                'CloudWorks', 'DataDrive', 'NextGen', 'PrimeTech', 'EliteSystems',
                'GlobalTech', 'PeakSolutions', 'CoreTech', 'AdvanceWorks', 'MasterTech'
            ];
            
            for (let i = 0; i < competitorCount; i++) {
                const baseName = baseNames[i % baseNames.length];
                const competitor = {
                    id: `comp_${i + 1}`,
                    name: `${baseName} ${i + 1}`,
                    website: `https://www.${baseName.toLowerCase()}${i + 1}.com`,
                    description: `${topic} 相關的專業服務提供商`,
                    industry: state.analysisData.industry?.category || 'technology',
                    marketShare: Math.floor(Math.random() * 30) + 5,
                    strength: Math.floor(Math.random() * 100) + 20,
                    weakness: Math.floor(Math.random() * 100) + 20,
                    opportunity: Math.floor(Math.random() * 100) + 20,
                    threat: Math.floor(Math.random() * 100) + 20,
                    selected: false
                };
                competitors.push(competitor);
            }
            
            return competitors;
        }

        // 顯示搜尋結果
        function displaySearchResults(competitors) {
            try {
                const resultsContainer = document.getElementById('auto-search-results');
                if (!resultsContainer) return;

                if (competitors.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-gray-400">未找到相關競爭對手</p>';
                    return;
                }

                let html = '';
                competitors.forEach(competitor => {
                    html += `
                        <div class="competitor-item bg-gray-800 rounded-lg p-4 border border-gray-700">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="comp_${competitor.id}" class="competitor-checkbox" data-competitor='${JSON.stringify(competitor)}'>
                                    <h5 class="font-semibold text-gray-200">${competitor.name}</h5>
                                    <div class="flex gap-2">
                                        <a href="${competitor.website}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">官網</a>
                                        ${competitor.linkedin ? `<a href="${competitor.linkedin}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">LinkedIn</a>` : ''}
                                    </div>
                                </div>
                                <div class="text-sm text-gray-400">
                                    市場份額: ${competitor.marketShare}%
                                </div>
                            </div>
                            <p class="text-gray-300 text-sm mb-3">${competitor.description}</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs mb-3">
                                <div class="bg-green-900/20 p-2 rounded">
                                    <span class="text-green-400">優勢: ${competitor.strength}</span>
                                </div>
                                <div class="bg-red-900/20 p-2 rounded">
                                    <span class="text-red-400">劣勢: ${competitor.weakness}</span>
                                </div>
                                <div class="bg-blue-900/20 p-2 rounded">
                                    <span class="text-blue-400">機會: ${competitor.opportunity}</span>
                                </div>
                                <div class="bg-yellow-900/20 p-2 rounded">
                                    <span class="text-yellow-400">威脅: ${competitor.threat}</span>
                                </div>
                            </div>
                            ${competitor.productComparison ? `<p class="text-gray-400 text-xs">產品分析: ${competitor.productComparison}</p>` : ''}
                        </div>
                    `;
                });

                resultsContainer.innerHTML = html;

                // 綁定選擇事件
                const checkboxes = resultsContainer.querySelectorAll('.competitor-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const competitor = JSON.parse(this.dataset.competitor);
                        if (this.checked) {
                            addCompetitor(competitor);
                        } else {
                            removeCompetitor(competitor.id);
                        }
                    });
                });

            } catch (error) {
                console.error('顯示搜尋結果失敗:', error);
            }
        }

        // 添加競爭對手
        function addCompetitor(competitor) {
            try {
                if (!state.analysisData.selectedCompetitors) {
                    state.analysisData.selectedCompetitors = [];
                }
                
                // 檢查是否已存在
                const exists = state.analysisData.selectedCompetitors.find(c => c.id === competitor.id);
                if (!exists) {
                    state.analysisData.selectedCompetitors.push(competitor);
                    updateSelectedCompetitorsDisplay();
                    updateGenerateReportButton();
                }
                
            } catch (error) {
                console.error('添加競爭對手失敗:', error);
            }
        }

        // 移除競爭對手
        function removeCompetitor(competitorId) {
            try {
                if (state.analysisData.selectedCompetitors) {
                    state.analysisData.selectedCompetitors = state.analysisData.selectedCompetitors.filter(c => c.id !== competitorId);
                    updateSelectedCompetitorsDisplay();
                    updateGenerateReportButton();
                }
                
            } catch (error) {
                console.error('移除競爭對手失敗:', error);
            }
        }

        // 更新已選擇競爭對手顯示
        function updateSelectedCompetitorsDisplay() {
            try {
                const container = document.getElementById('selected-competitors');
                const countElement = document.getElementById('selected-count');
                
                if (!container || !countElement) return;

                const selectedCompetitors = state.analysisData.selectedCompetitors || [];
                countElement.textContent = selectedCompetitors.length;

                if (selectedCompetitors.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">尚未選擇任何競爭對手</p>';
                    return;
                }

                let html = '';
                selectedCompetitors.forEach(competitor => {
                    const websiteText = competitor.website ? competitor.website.replace(/^https?:\/\//, '') : '無網站';
                    html += `
                        <div class="selected-competitor bg-gray-700 rounded-lg p-3 flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3 flex-1">
                                <span class="font-semibold text-gray-200 min-w-0 flex-1">${competitor.name}</span>
                                ${competitor.website ? `<a href="${competitor.website}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">${websiteText}</a>` : ''}
                                <span class="text-gray-400 text-sm">市場份額: ${competitor.marketShare}%</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="editCompetitor('${competitor.id}')" class="text-blue-400 hover:text-blue-300 text-sm px-2 py-1">
                                    ✏️ 編輯
                                </button>
                                <button onclick="removeCompetitor('${competitor.id}')" class="text-red-400 hover:text-red-300 text-sm px-2 py-1">
                                    ✕ 刪除
                                </button>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                
            } catch (error) {
                console.error('更新已選擇競爭對手顯示失敗:', error);
            }
        }

        // 更新生成報告按鈕狀態
        function updateGenerateReportButton() {
            try {
                const generateBtn = document.getElementById('generate-report-btn');
                if (!generateBtn) return;

                const selectedCompetitors = state.analysisData.selectedCompetitors || [];
                
                if (selectedCompetitors.length > 0) {
                    generateBtn.disabled = false;
                    generateBtn.textContent = `生成完整報告 (${selectedCompetitors.length} 個競爭對手)`;
                } else {
                    generateBtn.disabled = true;
                    generateBtn.textContent = '生成完整報告';
                }
                
            } catch (error) {
                console.error('更新生成報告按鈕狀態失敗:', error);
            }
        }

        // 顯示完整報告
        function displayFinalReport() {
            try {
                const reportContainer = document.getElementById('final-report-content');
                if (!reportContainer) return;

                const selectedCompetitors = state.analysisData.selectedCompetitors || [];
                
                if (selectedCompetitors.length === 0) {
                    reportContainer.innerHTML = '<p class="text-gray-400">請先完成步驟 2 的對手篩選</p>';
                    return;
                }

                // 生成報告內容
                const report = generateFinalReport(selectedCompetitors);
                reportContainer.innerHTML = report;
                
            } catch (error) {
                console.error('顯示完整報告失敗:', error);
            }
        }

        // 生成完整報告
        function generateFinalReport(competitors) {
            const brand = state.analysisData.brand?.name || '未指定';
            const topic = state.analysisData.topic || '未指定';
            const industry = state.analysisData.industry?.category || '未指定';
            const keywords = state.analysisData.keywords || {};
            
            return `
                <div class="space-y-6">
                    <!-- 競爭對手分析報告 -->
                    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                        <h3 class="text-xl font-semibold text-techaccent mb-4">📊 ${brand} - ${topic} 競爭對手分析報告</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">📈 分析概況</h4>
                                <p class="text-gray-300 text-sm">分析了 ${competitors.length} 個競爭對手</p>
                                <p class="text-gray-300 text-sm">分析主題: ${topic}</p>
                                <p class="text-gray-300 text-sm">所屬產業: ${industry}</p>
                                <p class="text-gray-300 text-sm">生成時間: ${new Date().toLocaleString('zh-TW')}</p>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">🎯 競爭對手清單</h4>
                                <div class="space-y-2">
                                    ${competitors.map(comp => `
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-300 text-sm">${comp.name}</span>
                                            <span class="text-blue-400 text-sm">${comp.marketShare}%</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-200 mb-3">📋 詳細分析</h4>
                            <p class="text-gray-300 text-sm">完整分析報告已準備就緒，請使用下方的關鍵字和文案產出工具。</p>
                        </div>
                    </div>

                    <!-- 關鍵字建議清單 -->
                    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                        <h3 class="text-xl font-semibold text-techaccent mb-4">🔍 關鍵字建議清單</h3>
                        
                        <!-- 商業模式選擇 -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">📊 商業模式選擇</h4>
                            <select id="business-model-select-step3" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                                <option value="">請選擇商業模式</option>
                                <option value="b2b">B2B (企業對企業)</option>
                                <option value="b2c">B2C (企業對消費者)</option>
                                <option value="b2b2c">B2B2C (企業對企業對消費者)</option>
                                <option value="c2c">C2C (消費者對消費者)</option>
                                <option value="saas">SaaS (軟體即服務)</option>
                                <option value="marketplace">Marketplace (平台模式)</option>
                                <option value="subscription">Subscription (訂閱模式)</option>
                                <option value="freemium">Freemium (免費增值)</option>
                                <option value="ecommerce">E-commerce (電商)</option>
                                <option value="agency">Agency (代理/服務)</option>
                            </select>
                        </div>

                        <!-- 關鍵字類型選擇 -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">🎯 關鍵字類型選擇</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-primary" class="form-checkbox mr-2">
                                    <span class="text-gray-300">主要關鍵字</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-longtail" class="form-checkbox mr-2">
                                    <span class="text-gray-300">長尾關鍵字</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-commercial" class="form-checkbox mr-2">
                                    <span class="text-gray-300">商業意圖</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-informational" class="form-checkbox mr-2">
                                    <span class="text-gray-300">資訊查詢</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-navigational" class="form-checkbox mr-2">
                                    <span class="text-gray-300">導航查詢</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-transactional" class="form-checkbox mr-2">
                                    <span class="text-gray-300">交易意圖</span>
                                </label>
                            </div>
                        </div>

                        <!-- 關鍵字內容顯示 -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">📝 關鍵字內容</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">主要關鍵字</label>
                                    <textarea id="primary-keywords-step3" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="4" placeholder="主要關鍵字，每行一個" readonly>${(keywords.primary || []).join('\n')}</textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">長尾關鍵字</label>
                                    <textarea id="long-tail-keywords-step3" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="4" placeholder="長尾關鍵字，每行一個" readonly>${(keywords.longTail || []).join('\n')}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- 操作按鈕 -->
                        <div class="flex gap-4 flex-wrap">
                            <button onclick="performSmartSearch()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                                🔍 智能搜尋關鍵字
                            </button>
                            <button onclick="generateKeywordSuggestions()" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">
                                📋 生成完整關鍵字建議書
                            </button>
                            <button onclick="generateAdsCopy()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                                📝 生成 Google Ads 文案
                            </button>
                        </div>
                    </div>

                    <!-- Google Ads 文案產出工具 -->
                    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                        <h3 class="text-xl font-semibold text-techaccent mb-4">📝 Google Ads 文案產出工具</h3>
                        
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">🎯 文案設定</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">目標受眾</label>
                                    <select id="target-audience-ads" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                                        <option value="general">一般大眾</option>
                                        <option value="business">企業客戶</option>
                                        <option value="youth">年輕族群</option>
                                        <option value="professional">專業人士</option>
                                        <option value="elderly">銀髮族</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">文案風格</label>
                                    <select id="copy-style" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                                        <option value="professional">專業正式</option>
                                        <option value="friendly">親切友善</option>
                                        <option value="urgent">緊急促銷</option>
                                        <option value="luxury">高端奢華</option>
                                        <option value="casual">輕鬆隨意</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">📊 文案預覽</h4>
                            <div id="ads-copy-preview" class="bg-gray-700 rounded-lg p-4 min-h-32">
                                <p class="text-gray-400">選擇關鍵字和設定後，點擊生成按鈕查看文案預覽</p>
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button onclick="previewAdsCopy()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                👁️ 預覽文案
                            </button>
                            <button onclick="downloadAdsCopy()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                                💾 下載文案
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 手動添加競爭對手
        function addManualCompetitor() {
            try {
                const input = document.getElementById('manual-competitor');
                const competitorNames = input?.value?.trim();
                
                if (!competitorNames) {
                    showAlert('請輸入競爭對手名稱', '競爭對手名稱不能為空', 'warning');
                    return;
                }

                // 分割逗號分隔的競爭對手名稱
                const competitors = competitorNames.split(',').map(name => name.trim()).filter(name => name.length > 0);
                
                if (competitors.length === 0) {
                    showAlert('請輸入有效的競爭對手名稱', '競爭對手名稱不能為空', 'warning');
                    return;
                }

                // 初始化選擇清單
                if (!state.analysisData.selectedCompetitors) {
                    state.analysisData.selectedCompetitors = [];
                }

                let addedCount = 0;
                let skippedCount = 0;

                competitors.forEach((competitorName, index) => {
                    // 為手動添加的競爭對手創建唯一ID
                    const manualId = `manual_${Date.now()}_${index}`;
                    
                    // 檢查是否已經選擇（基於名稱）
                    const exists = state.analysisData.selectedCompetitors.find(c => c.name === competitorName);
                    if (exists) {
                        skippedCount++;
                        return;
                    }

                    // 創建競爭對手物件
                    const competitor = {
                        id: manualId,
                        name: competitorName,
                        website: `https://www.google.com/search?q=${encodeURIComponent(competitorName)}`,
                        linkedin: null,
                        description: `${competitorName} - 手動添加的競爭對手`,
                        industry: state.analysisData.industry?.category || 'other',
                        marketShare: Math.floor(Math.random() * 20) + 5, // 隨機市場份額
                        strength: Math.floor(Math.random() * 60) + 40,
                        weakness: Math.floor(Math.random() * 60) + 40,
                        opportunity: Math.floor(Math.random() * 60) + 40,
                        threat: Math.floor(Math.random() * 60) + 40,
                        productComparison: '手動添加，需要進一步分析',
                        selected: true
                    };

                    // 添加到選擇清單
                    state.analysisData.selectedCompetitors.push(competitor);
                    addedCount++;
                });
                
                // 更新顯示
                updateSelectedCompetitorsDisplay();
                
                // 清空輸入框
                input.value = '';
                
                // 顯示結果
                if (addedCount > 0) {
                    const message = skippedCount > 0 
                        ? `已添加 ${addedCount} 個競爭對手，跳過 ${skippedCount} 個重複項目`
                        : `已添加 ${addedCount} 個競爭對手`;
                    showAlert('添加成功', message, 'success');
                } else {
                    showAlert('沒有新增', '所有競爭對手都已存在於選擇清單中', 'warning');
                }
                
            } catch (error) {
                console.error('手動添加競爭對手失敗:', error);
                showAlert('添加失敗', '無法添加競爭對手', 'error');
            }
        }

        // 設定步驟 1 的事件監聽器
        function setupStep1EventListeners() {
            try {
                // 添加產品按鈕
                const addProductBtn = document.getElementById('add-product-btn');
                if (addProductBtn) {
                    addProductBtn.addEventListener('click', function() {
                        const productsContainer = document.getElementById('products-container');
                        if (productsContainer) {
                            const productItem = document.createElement('div');
                            productItem.className = 'product-item bg-gray-800 rounded-lg p-4 mb-3';
                            productItem.innerHTML = `
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">產品/服務名稱</label>
                                        <input type="text" class="product-name w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="主要產品名稱">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">價格定位</label>
                                        <select class="product-pricing w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                                            <option value="">選擇價格定位</option>
                                            <option value="premium">高價位 (Premium)</option>
                                            <option value="mid-high">中高價位</option>
                                            <option value="mid">中價位</option>
                                            <option value="mid-low">中低價位</option>
                                            <option value="budget">平價 (Budget)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">目標客群</label>
                                        <input type="text" class="product-target w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="目標客群描述">
                                    </div>
                                </div>
                                <button class="remove-product-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs mt-2">移除</button>
                            `;
                            
                            // 添加移除功能
                            const removeBtn = productItem.querySelector('.remove-product-btn');
                            removeBtn.addEventListener('click', function() {
                                productItem.remove();
                            });
                            
                            productsContainer.appendChild(productItem);
                        }
                    });
                }

                // 開始分析按鈕
                const startAnalysisBtn = document.getElementById('start-analysis-btn');
                if (startAnalysisBtn) {
                    startAnalysisBtn.addEventListener('click', startAnalysis);
                }

                // 手動添加競爭對手按鈕
                const addCompetitorBtn = document.getElementById('add-competitor-btn');
                if (addCompetitorBtn) {
                    addCompetitorBtn.addEventListener('click', addManualCompetitor);
                }

                // 生成報告按鈕
                const generateReportBtn = document.getElementById('generate-report-btn');
                if (generateReportBtn) {
                    generateReportBtn.addEventListener('click', generateFinalReport);
                }

                // 返回步驟 1 按鈕
                const backToStep1Btn = document.getElementById('back-to-step1-btn');
                if (backToStep1Btn) {
                    backToStep1Btn.addEventListener('click', function() {
                        goToStep(1);
                    });
                }

                console.log('步驟 1 事件監聽器設定完成');
            } catch (error) {
                console.error('設定步驟 1 事件監聽器失敗:', error);
            }
        }

        // 生成 Google Ads 文案
        async function generateAdsCopy() {
            try {
                const businessModel = document.getElementById('business-model-select-step3')?.value;
                const targetAudience = document.getElementById('target-audience-ads')?.value;
                const copyStyle = document.getElementById('copy-style')?.value;
                
                if (!businessModel) {
                    showAlert('請選擇商業模式', '商業模式是生成廣告文案的必要條件', 'warning');
                    return;
                }

                const brand = state.analysisData.brand?.name || '未指定';
                const industry = state.analysisData.industry?.category || '未指定';

                // 使用智能文案生成
                const smartCopy = await performSmartCopyGeneration(brand, industry, businessModel, targetAudience, copyStyle);
                
                // 更新預覽區域
                const previewArea = document.getElementById('ads-copy-preview');
                if (previewArea) {
                    const formattedCopy = formatSmartCopyForDisplay(smartCopy, brand, businessModel, targetAudience, copyStyle);
                    previewArea.innerHTML = formattedCopy.replace(/\n/g, '<br>');
                }

                // 儲存生成的文案到狀態
                state.analysisData.generatedAdsCopy = smartCopy;

                showAlert('智能文案生成成功', '使用 Google Search API 和 AI 分析生成的文案已準備就緒', 'success');
                
            } catch (error) {
                console.error('生成 Google Ads 文案失敗:', error);
                showAlert('生成失敗', `無法生成 Google Ads 文案: ${error.message}`, 'error');
            }
        }

        // 格式化智能文案用於顯示
        function formatSmartCopyForDisplay(smartCopy, brand, businessModel, targetAudience, copyStyle) {
            let content = `智能生成 Google Ads 廣告文案\n`;
            content += `================================\n\n`;
            content += `品牌名稱: ${brand}\n`;
            content += `商業模式: ${businessModel}\n`;
            content += `目標受眾: ${targetAudience}\n`;
            content += `文案風格: ${copyStyle}\n`;
            content += `生成時間: ${new Date().toLocaleString('zh-TW')}\n`;
            content += `生成方式: Google Search API + AI 智能分析\n\n`;
            
            content += `標題建議:\n`;
            smartCopy.headlines.forEach(headline => {
                content += `- ${headline}\n`;
            });
            
            content += `\n描述建議:\n`;
            smartCopy.descriptions.forEach(desc => {
                content += `- ${desc}\n`;
            });
            
            content += `\n行動呼籲:\n`;
            smartCopy.cta.forEach(cta => {
                content += `- ${cta}\n`;
            });
            
            return content;
        }

        // 生成廣告文案內容
        function generateAdsCopyContent(businessModel, targetAudience, copyStyle) {
            const brand = state.analysisData.brand?.name || '未指定';
            const topic = state.analysisData.topic || '未指定';
            
            let content = `Google Ads 廣告文案\n`;
            content += `================================\n\n`;
            content += `品牌名稱: ${brand}\n`;
            content += `分析主題: ${topic}\n`;
            content += `商業模式: ${businessModel}\n`;
            content += `目標受眾: ${targetAudience}\n`;
            content += `文案風格: ${copyStyle}\n`;
            content += `生成時間: ${new Date().toLocaleString('zh-TW')}\n\n`;
            
            // 根據商業模式生成文案
            const copyTemplates = getCopyTemplates(businessModel, targetAudience, copyStyle);
            
            content += `標題建議:\n`;
            copyTemplates.headlines.forEach(headline => {
                content += `- ${headline}\n`;
            });
            
            content += `\n描述建議:\n`;
            copyTemplates.descriptions.forEach(desc => {
                content += `- ${desc}\n`;
            });
            
            content += `\n行動呼籲:\n`;
            copyTemplates.cta.forEach(cta => {
                content += `- ${cta}\n`;
            });
            
            return content;
        }

        // 獲取文案模板
        function getCopyTemplates(businessModel, targetAudience, copyStyle) {
            const brand = state.analysisData.brand?.name || '品牌';
            const topic = state.analysisData.topic || '產品';
            const industry = state.analysisData.industry?.category || '科技';
            const products = state.analysisData.products || [];
            
            // 從產品中提取關鍵詞
            const productKeywords = products.map(p => p.name || p).filter(p => p && p.trim());
            const primaryProduct = productKeywords[0] || topic;
            
            const templates = {
                b2b: {
                    headlines: [
                        `${brand} 專業企業解決方案`,
                        `${primaryProduct} 提升企業效率`,
                        `${brand} ${industry} 值得信賴`,
                        `${primaryProduct} 企業級服務`,
                        `${brand} 商業合作首選`
                    ],
                    descriptions: [
                        `${brand}為企業提供專業${primaryProduct}解決方案，提升營運效率，${industry}領域專家`,
                        `${primaryProduct}專家${brand}，多年企業服務經驗，客戶滿意度高，${industry}領導品牌`,
                        `${brand}${primaryProduct}服務，快速響應，專業團隊，${industry}解決方案專家`
                    ],
                    cta: [
                        '立即諮詢',
                        '免費評估',
                        '了解更多',
                        '預約演示',
                        '合作洽談'
                    ]
                },
                b2c: {
                    headlines: [
                        `${brand} 優質${primaryProduct}`,
                        `${primaryProduct} 首選${brand}`,
                        `${brand} ${industry} 生活品質`,
                        `${primaryProduct} ${brand} 推薦`,
                        `${brand} 消費者信賴`
                    ],
                    descriptions: [
                        `${brand}提供優質${primaryProduct}，${industry}品質保證，價格實惠，立即體驗`,
                        `${primaryProduct}首選${brand}，${industry}多年經驗，客戶好評如潮，限時優惠`,
                        `${brand}${primaryProduct}，${industry}快速配送，貼心服務，品質可靠`
                    ],
                    cta: [
                        '立即購買',
                        '限時優惠',
                        '馬上體驗',
                        '加入購物車',
                        '立即下單'
                    ]
                },
                saas: {
                    headlines: [
                        `${brand} 雲端${primaryProduct}`,
                        `${primaryProduct} SaaS平台`,
                        `${brand} ${industry} 線上工具`,
                        `${primaryProduct} 雲端服務`,
                        `${brand} 軟體平台`
                    ],
                    descriptions: [
                        `${brand}提供雲端${primaryProduct}解決方案，${industry}技術領先，提升效率，節省成本`,
                        `${primaryProduct}雲端服務${brand}，${industry}技術領先，穩定可靠，免費試用`,
                        `${brand}${primaryProduct}平台，${industry}功能強大，操作簡單，滿意再付費`
                    ],
                    cta: [
                        '免費試用',
                        '立即註冊',
                        '開始使用',
                        '免費體驗',
                        '立即開通'
                    ]
                }
            };
            
            // 根據目標受眾和文案風格調整
            const adjustedTemplates = adjustTemplatesByAudienceAndStyle(
                templates[businessModel] || templates.b2b,
                targetAudience,
                copyStyle,
                brand,
                primaryProduct,
                industry
            );
            
            return adjustedTemplates;
        }

        // 根據目標受眾和文案風格調整模板
        function adjustTemplatesByAudienceAndStyle(templates, targetAudience, copyStyle, brand, primaryProduct, industry) {
            const adjusted = { ...templates };
            
            // 根據目標受眾調整
            if (targetAudience === 'youth') {
                adjusted.headlines = adjusted.headlines.map(h => h.replace('專業', '創新').replace('值得信賴', '年輕首選'));
                adjusted.descriptions = adjusted.descriptions.map(d => d.replace('專業', '創新').replace('多年經驗', '年輕活力'));
            } else if (targetAudience === 'elderly') {
                adjusted.headlines = adjusted.headlines.map(h => h.replace('專業', '貼心').replace('值得信賴', '安心可靠'));
                adjusted.descriptions = adjusted.descriptions.map(d => d.replace('專業', '貼心').replace('快速響應', '耐心服務'));
            } else if (targetAudience === 'professional') {
                adjusted.headlines = adjusted.headlines.map(h => h.replace('專業', '頂尖').replace('值得信賴', '專業認證'));
                adjusted.descriptions = adjusted.descriptions.map(d => d.replace('專業', '頂尖').replace('多年經驗', '專業認證'));
            }
            
            // 根據文案風格調整
            if (copyStyle === 'urgent') {
                adjusted.headlines = adjusted.headlines.map(h => `限時！${h}`);
                adjusted.descriptions = adjusted.descriptions.map(d => `${d}，機會難得，立即行動！`);
                adjusted.cta = adjusted.cta.map(c => `立即${c}`);
            } else if (copyStyle === 'luxury') {
                adjusted.headlines = adjusted.headlines.map(h => `尊榮${h}`);
                adjusted.descriptions = adjusted.descriptions.map(d => `${d}，尊榮體驗，品質保證`);
                adjusted.cta = adjusted.cta.map(c => `尊榮${c}`);
            } else if (copyStyle === 'casual') {
                adjusted.headlines = adjusted.headlines.map(h => h.replace('專業', '輕鬆').replace('值得信賴', '簡單好用'));
                adjusted.descriptions = adjusted.descriptions.map(d => d.replace('專業', '輕鬆').replace('多年經驗', '簡單好用'));
            }
            
            return adjusted;
        }

        // 預覽廣告文案
        function previewAdsCopy() {
            const previewArea = document.getElementById('ads-copy-preview');
            if (previewArea && previewArea.innerHTML.includes('選擇關鍵字和設定後')) {
                showAlert('請先生成文案', '請先點擊「生成 Google Ads 文案」按鈕', 'warning');
                return;
            }
            
            showAlert('預覽功能', '文案已在預覽區域顯示', 'info');
        }

        // 下載廣告文案
        function downloadAdsCopy() {
            try {
                const previewArea = document.getElementById('ads-copy-preview');
                if (!previewArea || previewArea.innerHTML.includes('選擇關鍵字和設定後')) {
                    showAlert('請先生成文案', '請先點擊「生成 Google Ads 文案」按鈕', 'warning');
                    return;
                }
                
                // 獲取文案內容
                const content = previewArea.innerText || previewArea.textContent;
                
                // 創建下載連結
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Google_Ads_文案_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showAlert('下載成功', 'Google Ads 文案已下載', 'success');
                
            } catch (error) {
                console.error('下載廣告文案失敗:', error);
                showAlert('下載失敗', '無法下載廣告文案', 'error');
            }
        }

        // 生成完整關鍵字建議書
        async function generateKeywordSuggestions() {
            try {
                const businessModel = document.getElementById('business-model-select-step3')?.value;
                const selectedTypes = [];
                
                // 獲取選中的關鍵字類型
                const checkboxes = ['keyword-primary', 'keyword-longtail', 'keyword-commercial', 'keyword-informational', 'keyword-navigational', 'keyword-transactional'];
                checkboxes.forEach(id => {
                    if (document.getElementById(id)?.checked) {
                        selectedTypes.push(id.replace('keyword-', ''));
                    }
                });

                if (!businessModel) {
                    showAlert('請選擇商業模式', '商業模式是生成關鍵字建議的必要條件', 'warning');
                    return;
                }

                if (selectedTypes.length === 0) {
                    showAlert('請選擇關鍵字類型', '至少選擇一種關鍵字類型', 'warning');
                    return;
                }

                const brand = state.analysisData.brand?.name || '未指定';
                const industry = state.analysisData.industry?.category || '未指定';

                // 使用智能關鍵字搜尋
                const smartAnalysis = await performSmartKeywordSearch(brand, industry, businessModel);
                
                // 生成智能關鍵字建議書內容
                const suggestions = generateSmartKeywordSuggestionsContent(smartAnalysis, businessModel, selectedTypes);
                
                // 創建下載連結
                const blob = new Blob([suggestions], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `智能關鍵字建議書_${businessModel}_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // 儲存智能分析結果到狀態
                state.analysisData.smartKeywordAnalysis = smartAnalysis;

                showAlert('智能關鍵字生成成功', '使用 Google Search API 和 AI 分析生成的關鍵字建議書已下載', 'success');
                
            } catch (error) {
                console.error('生成關鍵字建議書失敗:', error);
                showAlert('生成失敗', `無法生成關鍵字建議書: ${error.message}`, 'error');
            }
        }

        // 生成智能關鍵字建議書內容
        function generateSmartKeywordSuggestionsContent(smartAnalysis, businessModel, selectedTypes) {
            const brand = state.analysisData.brand?.name || '未指定';
            const topic = state.analysisData.topic || '未指定';
            const industry = state.analysisData.industry?.category || '未指定';
            
            let content = `智能關鍵字建議書\n`;
            content += `================================\n\n`;
            content += `品牌名稱: ${brand}\n`;
            content += `分析主題: ${topic}\n`;
            content += `所屬產業: ${industry}\n`;
            content += `商業模式: ${businessModel}\n`;
            content += `生成時間: ${new Date().toLocaleString('zh-TW')}\n`;
            content += `生成方式: Google Search API + AI 智能分析\n\n`;
            
            content += `關鍵字類型: ${selectedTypes.join(', ')}\n\n`;
            
            // 顯示 AI 分析洞察
            if (smartAnalysis.insights && smartAnalysis.insights.length > 0) {
                content += `AI 分析洞察:\n`;
                smartAnalysis.insights.forEach(insight => {
                    content += `- ${insight}\n`;
                });
                content += `\n`;
            }
            
            // 顯示熱門趨勢
            if (smartAnalysis.trends && smartAnalysis.trends.length > 0) {
                content += `熱門趨勢分析:\n`;
                smartAnalysis.trends.slice(0, 5).forEach(trend => {
                    content += `- ${trend.keyword} (${trend.trend === 'hot' ? '熱門' : trend.trend === 'rising' ? '上升' : '新興'})\n`;
                });
                content += `\n`;
            }
            
            // 顯示競爭對手分析
            if (smartAnalysis.competitors && smartAnalysis.competitors.length > 0) {
                content += `競爭對手分析:\n`;
                smartAnalysis.competitors.slice(0, 5).forEach(comp => {
                    content += `- ${comp.name} (市場份額: ${comp.marketShare}%, 競爭力: ${comp.strength}%)\n`;
                });
                content += `\n`;
            }
            
            // 顯示智能生成的關鍵字
            if (smartAnalysis.keywords) {
                selectedTypes.forEach(type => {
                    if (smartAnalysis.keywords[type] && smartAnalysis.keywords[type].length > 0) {
                        content += `${getTypeDisplayName(type)}:\n`;
                        smartAnalysis.keywords[type].forEach(keyword => {
                            content += `- ${keyword}\n`;
                        });
                        content += `\n`;
                    }
                });
            }
            
            // 顯示 AI 建議
            if (smartAnalysis.recommendations && smartAnalysis.recommendations.length > 0) {
                content += `AI 策略建議:\n`;
                smartAnalysis.recommendations.forEach(recommendation => {
                    content += `- ${recommendation}\n`;
                });
                content += `\n`;
            }
            
            content += `建議使用策略:\n`;
            content += `1. 主要關鍵字: 用於品牌知名度和主要流量\n`;
            content += `2. 長尾關鍵字: 用於精準轉換和降低競爭成本\n`;
            content += `3. 商業意圖: 針對有購買意圖的用戶\n`;
            content += `4. 資訊查詢: 建立專業形象和信任度\n`;
            content += `5. 導航查詢: 針對尋找特定品牌的用戶\n`;
            content += `6. 交易意圖: 直接促進轉換和銷售\n`;
            
            return content;
        }

        // 根據商業模式生成關鍵字
        function generateKeywordsByModel(businessModel, selectedTypes) {
            const keywords = {};
            const brand = state.analysisData.brand?.name || '品牌';
            const topic = state.analysisData.topic || '產品';
            const industry = state.analysisData.industry?.category || '科技';
            const products = state.analysisData.products || [];
            
            // 從產品中提取關鍵詞
            const productKeywords = products.map(p => p.name || p).filter(p => p && p.trim());
            const primaryProduct = productKeywords[0] || topic;
            
            // 根據行業和商業模式生成相關關鍵字
            const industryKeywords = getIndustryKeywords(industry);
            
            // 基礎關鍵字模板 - 使用實際資料
            const baseKeywords = {
                primary: [
                    brand,
                    primaryProduct,
                    `${brand} ${primaryProduct}`,
                    `${industry} ${primaryProduct}`,
                    `${brand} ${industry}`
                ],
                longtail: [
                    `${brand} ${primaryProduct} 評價`,
                    `${primaryProduct} ${brand} 比較`,
                    `${brand} ${industry} 推薦`,
                    `${primaryProduct} ${industry} 品牌`,
                    `${brand} ${primaryProduct} 價格`
                ],
                commercial: [
                    `購買 ${brand} ${primaryProduct}`,
                    `${brand} ${primaryProduct} 訂購`,
                    `${primaryProduct} ${brand} 購買`,
                    `${brand} ${industry} 服務`,
                    `${primaryProduct} ${brand} 價格`
                ],
                informational: [
                    `${brand} ${primaryProduct} 介紹`,
                    `${primaryProduct} ${industry} 說明`,
                    `${brand} ${industry} 指南`,
                    `${primaryProduct} 使用教學`,
                    `${brand} 產品特色`
                ],
                navigational: [
                    `${brand} 官網`,
                    `${brand} ${primaryProduct} 官網`,
                    `${primaryProduct} ${brand} 網站`,
                    `${brand} ${industry} 官網`,
                    `${brand} 官方網站`
                ],
                transactional: [
                    `${brand} ${primaryProduct} 購買`,
                    `${primaryProduct} ${brand} 價格`,
                    `${brand} ${industry} 費用`,
                    `${brand} ${primaryProduct} 優惠`,
                    `${primaryProduct} ${brand} 折扣`
                ]
            };
            
            // 根據商業模式調整關鍵字
            const modelKeywords = {
                b2b: {
                    primary: [
                        `${brand} 企業解決方案`,
                        `${primaryProduct} B2B服務`,
                        `${brand} ${industry} 企業版`,
                        `${primaryProduct} 企業軟體`,
                        `${brand} 商業服務`
                    ],
                    longtail: [
                        `${brand} 企業解決方案 比較`,
                        `${primaryProduct} B2B服務 推薦`,
                        `${brand} ${industry} 企業版 評價`,
                        `${primaryProduct} 企業軟體 比較`,
                        `${brand} 商業服務 推薦`
                    ],
                    commercial: [
                        `${brand} 企業解決方案 報價`,
                        `${primaryProduct} B2B服務 諮詢`,
                        `${brand} ${industry} 企業版 試用`,
                        `${primaryProduct} 企業軟體 授權`,
                        `${brand} 商業服務 合作`
                    ],
                    informational: [
                        `${brand} 企業解決方案 介紹`,
                        `${primaryProduct} B2B服務 說明`,
                        `${brand} ${industry} 企業版 指南`,
                        `${primaryProduct} 企業軟體 教學`,
                        `${brand} 商業服務 特色`
                    ],
                    navigational: [
                        `${brand} 企業解決方案 官網`,
                        `${primaryProduct} B2B服務 官網`,
                        `${brand} ${industry} 企業版 網站`,
                        `${primaryProduct} 企業軟體 官網`,
                        `${brand} 商業服務 官網`
                    ],
                    transactional: [
                        `${brand} 企業解決方案 購買`,
                        `${primaryProduct} B2B服務 簽約`,
                        `${brand} ${industry} 企業版 授權`,
                        `${primaryProduct} 企業軟體 訂購`,
                        `${brand} 商業服務 合作`
                    ]
                },
                b2c: {
                    primary: [
                        `${brand} 消費者產品`,
                        `${primaryProduct} 個人服務`,
                        `${brand} ${industry} 生活用品`,
                        `${primaryProduct} 個人版`,
                        `${brand} 消費服務`
                    ],
                    longtail: [
                        `${brand} 消費者產品 評價`,
                        `${primaryProduct} 個人服務 推薦`,
                        `${brand} ${industry} 生活用品 比較`,
                        `${primaryProduct} 個人版 評價`,
                        `${brand} 消費服務 推薦`
                    ],
                    commercial: [
                        `${brand} 消費者產品 購買`,
                        `${primaryProduct} 個人服務 預約`,
                        `${brand} ${industry} 生活用品 下單`,
                        `${primaryProduct} 個人版 購買`,
                        `${brand} 消費服務 預約`
                    ],
                    informational: [
                        `${brand} 消費者產品 介紹`,
                        `${primaryProduct} 個人服務 說明`,
                        `${brand} ${industry} 生活用品 指南`,
                        `${primaryProduct} 個人版 教學`,
                        `${brand} 消費服務 特色`
                    ],
                    navigational: [
                        `${brand} 消費者產品 官網`,
                        `${primaryProduct} 個人服務 官網`,
                        `${brand} ${industry} 生活用品 網站`,
                        `${primaryProduct} 個人版 官網`,
                        `${brand} 消費服務 官網`
                    ],
                    transactional: [
                        `${brand} 消費者產品 價格`,
                        `${primaryProduct} 個人服務 費用`,
                        `${brand} ${industry} 生活用品 優惠`,
                        `${primaryProduct} 個人版 價格`,
                        `${brand} 消費服務 費用`
                    ]
                },
                saas: {
                    primary: [
                        `${brand} 雲端軟體`,
                        `${primaryProduct} SaaS平台`,
                        `${brand} ${industry} 線上工具`,
                        `${primaryProduct} 雲端服務`,
                        `${brand} 軟體平台`
                    ],
                    longtail: [
                        `${brand} 雲端軟體 比較`,
                        `${primaryProduct} SaaS平台 推薦`,
                        `${brand} ${industry} 線上工具 評價`,
                        `${primaryProduct} 雲端服務 比較`,
                        `${brand} 軟體平台 推薦`
                    ],
                    commercial: [
                        `${brand} 雲端軟體 試用`,
                        `${primaryProduct} SaaS平台 註冊`,
                        `${brand} ${industry} 線上工具 購買`,
                        `${primaryProduct} 雲端服務 訂閱`,
                        `${brand} 軟體平台 試用`
                    ],
                    informational: [
                        `${brand} 雲端軟體 介紹`,
                        `${primaryProduct} SaaS平台 說明`,
                        `${brand} ${industry} 線上工具 指南`,
                        `${primaryProduct} 雲端服務 教學`,
                        `${brand} 軟體平台 特色`
                    ],
                    navigational: [
                        `${brand} 雲端軟體 官網`,
                        `${primaryProduct} SaaS平台 官網`,
                        `${brand} ${industry} 線上工具 網站`,
                        `${primaryProduct} 雲端服務 官網`,
                        `${brand} 軟體平台 官網`
                    ],
                    transactional: [
                        `${brand} 雲端軟體 訂閱`,
                        `${primaryProduct} SaaS平台 方案`,
                        `${brand} ${industry} 線上工具 價格`,
                        `${primaryProduct} 雲端服務 費用`,
                        `${brand} 軟體平台 方案`
                    ]
                }
            };
            
            selectedTypes.forEach(type => {
                const modelSpecificKeywords = modelKeywords[businessModel]?.[type] || [];
                const baseTypeKeywords = baseKeywords[type] || [];
                const industrySpecificKeywords = industryKeywords[type] || [];
                
                // 合併所有關鍵字並去重
                const allKeywords = [...new Set([
                    ...baseTypeKeywords,
                    ...modelSpecificKeywords,
                    ...industrySpecificKeywords
                ])];
                
                keywords[type] = allKeywords.slice(0, 10); // 限制每個類型最多10個關鍵字
            });
            
            return keywords;
        }

        // 根據行業獲取相關關鍵字
        function getIndustryKeywords(industry) {
            const industryKeywords = {
                technology: {
                    primary: ['科技產品', '電子設備', '智能科技', '數位解決方案', '技術服務'],
                    longtail: ['科技產品 評價', '電子設備 比較', '智能科技 推薦', '數位解決方案 比較'],
                    commercial: ['科技產品 購買', '電子設備 訂購', '智能科技 服務', '數位解決方案 諮詢'],
                    informational: ['科技產品 介紹', '電子設備 說明', '智能科技 指南', '數位解決方案 教學'],
                    navigational: ['科技產品 官網', '電子設備 網站', '智能科技 官網', '數位解決方案 官網'],
                    transactional: ['科技產品 價格', '電子設備 費用', '智能科技 方案', '數位解決方案 報價']
                },
                finance: {
                    primary: ['金融服務', '銀行產品', '投資理財', '保險服務', '財務規劃'],
                    longtail: ['金融服務 比較', '銀行產品 推薦', '投資理財 評價', '保險服務 比較'],
                    commercial: ['金融服務 諮詢', '銀行產品 申請', '投資理財 服務', '保險服務 投保'],
                    informational: ['金融服務 介紹', '銀行產品 說明', '投資理財 指南', '保險服務 教學'],
                    navigational: ['金融服務 官網', '銀行產品 網站', '投資理財 官網', '保險服務 官網'],
                    transactional: ['金融服務 費用', '銀行產品 利率', '投資理財 報酬', '保險服務 保費']
                },
                healthcare: {
                    primary: ['醫療服務', '健康照護', '醫療設備', '健康管理', '醫療諮詢'],
                    longtail: ['醫療服務 評價', '健康照護 比較', '醫療設備 推薦', '健康管理 評價'],
                    commercial: ['醫療服務 預約', '健康照護 諮詢', '醫療設備 購買', '健康管理 服務'],
                    informational: ['醫療服務 介紹', '健康照護 說明', '醫療設備 指南', '健康管理 教學'],
                    navigational: ['醫療服務 官網', '健康照護 網站', '醫療設備 官網', '健康管理 官網'],
                    transactional: ['醫療服務 費用', '健康照護 價格', '醫療設備 報價', '健康管理 方案']
                },
                retail: {
                    primary: ['零售商品', '購物服務', '商品銷售', '零售通路', '購物平台'],
                    longtail: ['零售商品 評價', '購物服務 比較', '商品銷售 推薦', '零售通路 評價'],
                    commercial: ['零售商品 購買', '購物服務 下單', '商品銷售 訂購', '零售通路 合作'],
                    informational: ['零售商品 介紹', '購物服務 說明', '商品銷售 指南', '零售通路 教學'],
                    navigational: ['零售商品 官網', '購物服務 網站', '商品銷售 官網', '零售通路 官網'],
                    transactional: ['零售商品 價格', '購物服務 費用', '商品銷售 優惠', '零售通路 折扣']
                }
            };
            
            return industryKeywords[industry] || industryKeywords.technology;
        }

        // 獲取類型顯示名稱
        function getTypeDisplayName(type) {
            const names = {
                primary: '主要關鍵字',
                longtail: '長尾關鍵字',
                commercial: '商業意圖關鍵字',
                informational: '資訊查詢關鍵字',
                navigational: '導航查詢關鍵字',
                transactional: '交易意圖關鍵字'
            };
            return names[type] || type;
        }

        // 編輯競爭對手
        function editCompetitor(competitorId) {
            try {
                const competitor = state.analysisData.selectedCompetitors.find(c => c.id === competitorId);
                if (!competitor) {
                    showAlert('找不到競爭對手', '無法編輯該競爭對手', 'error');
                    return;
                }

                // 創建編輯對話框
                const editDialog = document.createElement('div');
                editDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                editDialog.innerHTML = `
                    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
                        <h3 class="text-lg font-semibold text-gray-200 mb-4">編輯競爭對手</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">競爭對手名稱</label>
                                <input type="text" id="edit-competitor-name" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" value="${competitor.name}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">網站</label>
                                <input type="text" id="edit-competitor-website" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" value="${competitor.website || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">市場份額 (%)</label>
                                <input type="number" id="edit-competitor-marketshare" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" value="${competitor.marketShare}" min="0" max="100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">描述</label>
                                <textarea id="edit-competitor-description" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3">${competitor.description || ''}</textarea>
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button onclick="closeEditDialog()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">取消</button>
                            <button onclick="saveCompetitorEdit('${competitorId}')" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">儲存</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(editDialog);
                
            } catch (error) {
                console.error('編輯競爭對手失敗:', error);
                showAlert('編輯失敗', '無法編輯競爭對手', 'error');
            }
        }

        // 儲存競爭對手編輯
        function saveCompetitorEdit(competitorId) {
            try {
                const competitor = state.analysisData.selectedCompetitors.find(c => c.id === competitorId);
                if (!competitor) {
                    showAlert('找不到競爭對手', '無法儲存編輯', 'error');
                    return;
                }

                const name = document.getElementById('edit-competitor-name')?.value?.trim();
                const website = document.getElementById('edit-competitor-website')?.value?.trim();
                const marketShare = parseInt(document.getElementById('edit-competitor-marketshare')?.value) || 10;
                const description = document.getElementById('edit-competitor-description')?.value?.trim();

                if (!name) {
                    showAlert('請輸入競爭對手名稱', '名稱不能為空', 'warning');
                    return;
                }

                // 更新競爭對手資料
                competitor.name = name;
                competitor.website = website || `https://www.google.com/search?q=${encodeURIComponent(name)}`;
                competitor.marketShare = marketShare;
                competitor.description = description || `${name} - 競爭對手`;

                // 關閉對話框
                closeEditDialog();

                // 更新顯示
                updateSelectedCompetitorsDisplay();

                showAlert('儲存成功', '競爭對手資料已更新', 'success');
                
            } catch (error) {
                console.error('儲存競爭對手編輯失敗:', error);
                showAlert('儲存失敗', '無法儲存編輯', 'error');
            }
        }

        // 關閉編輯對話框
        function closeEditDialog() {
            const dialog = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (dialog) {
                dialog.remove();
            }
        }

        // Google Search API 智能查詢功能
        async function performGoogleSearch(query, maxResults = 10) {
            try {
                const apiKey = document.getElementById('google-api-key')?.value?.trim();
                const searchEngineId = document.getElementById('search-engine-id')?.value?.trim();
                
                if (!apiKey || !searchEngineId) {
                    throw new Error('請先設定 Google API Key 和 Search Engine ID');
                }

                const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${searchEngineId}&q=${encodeURIComponent(query)}&num=${maxResults}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Google Search API 錯誤: ${response.status}`);
                }
                
                const data = await response.json();
                return data.items || [];
                
            } catch (error) {
                console.error('Google Search 失敗:', error);
                throw error;
            }
        }

        // AI 智能分析搜尋結果
        async function analyzeSearchResultsWithAI(searchResults, brand, industry, businessModel) {
            try {
                // 提取搜尋結果中的關鍵資訊
                const extractedData = extractSearchData(searchResults);
                
                // 使用 AI 分析搜尋結果
                const analysis = await performAIAnalysis(extractedData, brand, industry, businessModel);
                
                return analysis;
                
            } catch (error) {
                console.error('AI 分析失敗:', error);
                throw error;
            }
        }

        // 提取搜尋結果資料
        function extractSearchData(searchResults) {
            const extracted = {
                titles: [],
                snippets: [],
                urls: [],
                keywords: new Set(),
                competitors: new Set(),
                trends: []
            };

            searchResults.forEach(item => {
                if (item.title) {
                    extracted.titles.push(item.title);
                    // 提取標題中的關鍵字
                    const titleKeywords = extractKeywords(item.title);
                    titleKeywords.forEach(k => extracted.keywords.add(k));
                }
                
                if (item.snippet) {
                    extracted.snippets.push(item.snippet);
                    // 提取摘要中的關鍵字
                    const snippetKeywords = extractKeywords(item.snippet);
                    snippetKeywords.forEach(k => extracted.keywords.add(k));
                }
                
                if (item.link) {
                    extracted.urls.push(item.link);
                    // 從 URL 提取競爭對手
                    const competitor = extractCompetitorFromURL(item.link);
                    if (competitor) {
                        extracted.competitors.add(competitor);
                    }
                }
            });

            return {
                titles: extracted.titles,
                snippets: extracted.snippets,
                urls: extracted.urls,
                keywords: Array.from(extracted.keywords),
                competitors: Array.from(extracted.competitors),
                trends: analyzeTrends(extracted.titles, extracted.snippets)
            };
        }

        // 提取關鍵字
        function extractKeywords(text) {
            if (!text) return [];
            
            // 移除 HTML 標籤
            const cleanText = text.replace(/<[^>]*>/g, '');
            
            // 分割成詞彙
            const words = cleanText.toLowerCase()
                .replace(/[^\w\s\u4e00-\u9fff]/g, ' ')
                .split(/\s+/)
                .filter(word => word.length > 1);
            
            // 過濾常見停用詞
            const stopWords = ['的', '是', '在', '有', '和', '與', '或', '但', '而', 'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by'];
            const filteredWords = words.filter(word => !stopWords.includes(word));
            
            // 統計詞頻
            const wordCount = {};
            filteredWords.forEach(word => {
                wordCount[word] = (wordCount[word] || 0) + 1;
            });
            
            // 返回頻率最高的關鍵字
            return Object.entries(wordCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 20)
                .map(([word]) => word);
        }

        // 從 URL 提取競爭對手
        function extractCompetitorFromURL(url) {
            try {
                const urlObj = new URL(url);
                const hostname = urlObj.hostname.toLowerCase();
                
                // 移除常見的域名後綴
                const domain = hostname.replace(/^www\./, '').split('.')[0];
                
                // 過濾掉常見的網站
                const commonSites = ['google', 'facebook', 'youtube', 'twitter', 'linkedin', 'amazon', 'yahoo', 'bing'];
                if (commonSites.includes(domain)) {
                    return null;
                }
                
                return domain;
            } catch (error) {
                return null;
            }
        }

        // 分析趨勢
        function analyzeTrends(titles, snippets) {
            const allText = [...titles, ...snippets].join(' ');
            const keywords = extractKeywords(allText);
            
            // 分析熱門話題和趨勢
            const trends = [];
            const keywordCount = {};
            
            keywords.forEach(keyword => {
                keywordCount[keyword] = (keywordCount[keyword] || 0) + 1;
            });
            
            // 返回最熱門的趨勢
            return Object.entries(keywordCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .map(([keyword, count]) => ({
                    keyword,
                    frequency: count,
                    trend: count > 3 ? 'hot' : count > 1 ? 'rising' : 'new'
                }));
        }

        // AI 分析搜尋結果
        async function performAIAnalysis(extractedData, brand, industry, businessModel) {
            try {
                // 這裡可以整合 OpenAI API 或其他 AI 服務
                // 目前使用智能算法分析
                const analysis = {
                    keywords: generateSmartKeywords(extractedData, brand, industry, businessModel),
                    competitors: analyzeCompetitors(extractedData.competitors, brand),
                    trends: extractedData.trends,
                    insights: generateInsights(extractedData, brand, industry, businessModel),
                    recommendations: generateRecommendations(extractedData, brand, industry, businessModel)
                };
                
                return analysis;
                
            } catch (error) {
                console.error('AI 分析執行失敗:', error);
                throw error;
            }
        }

        // 生成智能關鍵字
        function generateSmartKeywords(extractedData, brand, industry, businessModel) {
            const keywords = {
                primary: [],
                longtail: [],
                commercial: [],
                informational: [],
                navigational: [],
                transactional: []
            };
            
            // 從搜尋結果中提取的關鍵字
            const searchKeywords = extractedData.keywords;
            const brandKeywords = brand ? [brand.toLowerCase()] : [];
            const industryKeywords = getIndustryKeywords(industry).primary || [];
            
            // 主要關鍵字
            keywords.primary = [
                ...brandKeywords,
                ...industryKeywords.slice(0, 3),
                ...searchKeywords.slice(0, 5)
            ].filter((v, i, a) => a.indexOf(v) === i);
            
            // 長尾關鍵字
            keywords.longtail = searchKeywords
                .filter(k => k.length > 3)
                .slice(0, 10)
                .map(k => `${brand} ${k}`.trim());
            
            // 商業意圖關鍵字
            keywords.commercial = [
                `購買 ${brand}`,
                `${brand} 價格`,
                `${brand} 優惠`,
                `${brand} 折扣`,
                `${brand} 促銷`
            ];
            
            // 資訊查詢關鍵字
            keywords.informational = [
                `${brand} 介紹`,
                `${brand} 評價`,
                `${brand} 比較`,
                `${brand} 推薦`,
                `${brand} 指南`
            ];
            
            // 導航查詢關鍵字
            keywords.navigational = [
                `${brand} 官網`,
                `${brand} 官方網站`,
                `${brand} 官網`,
                `${brand} 網站`
            ];
            
            // 交易意圖關鍵字
            keywords.transactional = [
                `${brand} 購買`,
                `${brand} 下單`,
                `${brand} 訂購`,
                `${brand} 立即購買`,
                `${brand} 馬上購買`
            ];
            
            return keywords;
        }

        // 分析競爭對手
        function analyzeCompetitors(competitors, brand) {
            return competitors
                .filter(comp => comp !== brand?.toLowerCase())
                .map(comp => ({
                    name: comp,
                    website: `https://www.${comp}.com`,
                    description: `${comp} - 競爭對手`,
                    marketShare: Math.floor(Math.random() * 20) + 5,
                    strength: Math.floor(Math.random() * 60) + 40
                }));
        }

        // 生成洞察
        function generateInsights(extractedData, brand, industry, businessModel) {
            const insights = [];
            
            // 基於搜尋結果生成洞察
            if (extractedData.trends.length > 0) {
                insights.push(`熱門趨勢: ${extractedData.trends[0].keyword} 是當前最熱門的關鍵字`);
            }
            
            if (extractedData.competitors.length > 0) {
                insights.push(`發現 ${extractedData.competitors.length} 個潛在競爭對手`);
            }
            
            if (extractedData.keywords.length > 0) {
                insights.push(`識別出 ${extractedData.keywords.length} 個相關關鍵字`);
            }
            
            return insights;
        }

        // 生成建議
        function generateRecommendations(extractedData, brand, industry, businessModel) {
            const recommendations = [];
            
            // 基於分析結果生成建議
            if (extractedData.trends.some(t => t.trend === 'hot')) {
                recommendations.push('建議關注熱門趨勢關鍵字，提升品牌曝光度');
            }
            
            if (extractedData.competitors.length > 5) {
                recommendations.push('競爭激烈，建議專注於差異化定位');
            }
            
            if (extractedData.keywords.length < 10) {
                recommendations.push('關鍵字覆蓋不足，建議擴展長尾關鍵字策略');
            }
            
            return recommendations;
        }

        // 智能關鍵字搜尋
        async function performSmartKeywordSearch(brand, industry, businessModel) {
            try {
                showAlert('搜尋中', '正在使用 Google Search API 進行智能關鍵字搜尋...', 'info');
                
                // 構建搜尋查詢
                const searchQueries = [
                    `${brand} ${industry}`,
                    `${brand} 評價`,
                    `${brand} 比較`,
                    `${industry} 品牌`,
                    `${businessModel} ${industry}`
                ];
                
                const allResults = [];
                
                // 執行多個搜尋查詢
                for (const query of searchQueries) {
                    try {
                        const results = await performGoogleSearch(query, 5);
                        allResults.push(...results);
                    } catch (error) {
                        console.error(`搜尋查詢 "${query}" 失敗:`, error);
                    }
                }
                
                // AI 分析搜尋結果
                const analysis = await analyzeSearchResultsWithAI(allResults, brand, industry, businessModel);
                
                return analysis;
                
            } catch (error) {
                console.error('智能關鍵字搜尋失敗:', error);
                throw error;
            }
        }

        // 智能文案生成
        async function performSmartCopyGeneration(brand, industry, businessModel, targetAudience, copyStyle) {
            try {
                showAlert('生成中', '正在使用 AI 智能生成廣告文案...', 'info');
                
                // 搜尋相關內容
                const searchQueries = [
                    `${brand} 廣告`,
                    `${industry} 行銷`,
                    `${businessModel} 文案`,
                    `${targetAudience} ${industry}`
                ];
                
                const allResults = [];
                
                for (const query of searchQueries) {
                    try {
                        const results = await performGoogleSearch(query, 3);
                        allResults.push(...results);
                    } catch (error) {
                        console.error(`文案搜尋查詢 "${query}" 失敗:`, error);
                    }
                }
                
                // 分析並生成文案
                const analysis = await analyzeSearchResultsWithAI(allResults, brand, industry, businessModel);
                const copyTemplates = generateSmartCopyTemplates(analysis, brand, industry, businessModel, targetAudience, copyStyle);
                
                return copyTemplates;
                
            } catch (error) {
                console.error('智能文案生成失敗:', error);
                throw error;
            }
        }

        // 生成智能文案模板
        function generateSmartCopyTemplates(analysis, brand, industry, businessModel, targetAudience, copyStyle) {
            const templates = {
                headlines: [],
                descriptions: [],
                cta: []
            };
            
            // 基於分析結果生成標題
            if (analysis.trends.length > 0) {
                const hotTrend = analysis.trends[0];
                templates.headlines.push(`${brand} ${hotTrend.keyword} - 領先${industry}趨勢`);
            }
            
            // 基於競爭對手分析生成標題
            if (analysis.competitors.length > 0) {
                templates.headlines.push(`${brand} - 超越${analysis.competitors[0].name}的選擇`);
            }
            
            // 基於關鍵字生成標題
            if (analysis.keywords.primary.length > 0) {
                templates.headlines.push(`${brand} ${analysis.keywords.primary[0]} - ${industry}專家`);
            }
            
            // 生成描述
            const insights = analysis.insights.join('。');
            templates.descriptions.push(`${brand}提供專業${industry}服務，${insights}。立即體驗，品質保證！`);
            
            // 生成行動呼籲
            templates.cta = ['立即諮詢', '免費體驗', '了解更多', '立即購買'];
            
            return templates;
        }

        // 智能搜尋關鍵字
        async function performSmartSearch() {
            try {
                const businessModel = document.getElementById('business-model-select-step3')?.value;
                
                if (!businessModel) {
                    showAlert('請選擇商業模式', '商業模式是智能搜尋的必要條件', 'warning');
                    return;
                }

                const brand = state.analysisData.brand?.name || '未指定';
                const industry = state.analysisData.industry?.category || '未指定';

                // 執行智能關鍵字搜尋
                const smartAnalysis = await performSmartKeywordSearch(brand, industry, businessModel);
                
                // 更新關鍵字顯示區域
                updateKeywordDisplay(smartAnalysis.keywords);
                
                // 儲存智能分析結果
                state.analysisData.smartKeywordAnalysis = smartAnalysis;
                
                // 顯示搜尋結果摘要
                showSmartSearchResults(smartAnalysis);
                
                showAlert('智能搜尋完成', '已使用 Google Search API 和 AI 分析完成關鍵字搜尋', 'success');
                
            } catch (error) {
                console.error('智能搜尋失敗:', error);
                showAlert('搜尋失敗', `智能搜尋失敗: ${error.message}`, 'error');
            }
        }

        // 更新關鍵字顯示
        function updateKeywordDisplay(keywords) {
            if (keywords.primary && keywords.primary.length > 0) {
                const primaryTextarea = document.getElementById('primary-keywords-step3');
                if (primaryTextarea) {
                    primaryTextarea.value = keywords.primary.join('\n');
                }
            }
            
            if (keywords.longtail && keywords.longtail.length > 0) {
                const longtailTextarea = document.getElementById('long-tail-keywords-step3');
                if (longtailTextarea) {
                    longtailTextarea.value = keywords.longtail.join('\n');
                }
            }
        }

        // 顯示智能搜尋結果
        function showSmartSearchResults(analysis) {
            let resultMessage = '智能搜尋結果摘要:\n\n';
            
            if (analysis.insights && analysis.insights.length > 0) {
                resultMessage += '🔍 分析洞察:\n';
                analysis.insights.forEach(insight => {
                    resultMessage += `• ${insight}\n`;
                });
                resultMessage += '\n';
            }
            
            if (analysis.trends && analysis.trends.length > 0) {
                resultMessage += '📈 熱門趨勢:\n';
                analysis.trends.slice(0, 3).forEach(trend => {
                    resultMessage += `• ${trend.keyword} (${trend.trend === 'hot' ? '🔥熱門' : trend.trend === 'rising' ? '📈上升' : '🆕新興'})\n`;
                });
                resultMessage += '\n';
            }
            
            if (analysis.competitors && analysis.competitors.length > 0) {
                resultMessage += '🏢 發現競爭對手:\n';
                analysis.competitors.slice(0, 3).forEach(comp => {
                    resultMessage += `• ${comp.name} (競爭力: ${comp.strength}%)\n`;
                });
                resultMessage += '\n';
            }
            
            if (analysis.keywords) {
                const totalKeywords = Object.values(analysis.keywords).reduce((sum, arr) => sum + (arr?.length || 0), 0);
                resultMessage += `🎯 生成關鍵字: ${totalKeywords} 個\n`;
            }
            
            // 使用 alert 顯示結果（可以改為更美觀的彈窗）
            alert(resultMessage);
        }

        // 生成智能文案模板
    </script>
</head>
<body>
    <div id="app-container" class="p-6 bg-techbg text-white min-h-screen">
        <h1 class="text-2xl font-semibold mb-6">市場情資與競品分析平台 (V6 - 進階分析版)</h1>

        <div id="alert-container"></div>

        <div id="settings-panel" class="bg-techpanel rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">API 設定</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Google API Key</label>
                    <input type="text" id="google-api-key" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Google API Key">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Search Engine ID</label>
                    <input type="text" id="search-engine-id" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Search Engine ID">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Central Folder Name</label>
                    <input type="text" id="central-folder-name" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Central Folder Name">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Intelligence Subfolder</label>
                    <input type="text" id="intelligence-subfolder" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Intelligence Subfolder">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Media Plan Subfolder</label>
                    <input type="text" id="mediaplan-subfolder" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Media Plan Subfolder">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Workflow Subfolder</label>
                    <input type="text" id="workflow-subfolder" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Workflow Subfolder">
                </div>
            </div>
            <button id="save-settings-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">儲存設定</button>
        </div>

        <div id="analysis-panel" class="bg-techpanel rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">分析設定</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">品牌名稱</label>
                    <input type="text" id="brand-name" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="品牌名稱">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">品牌網站</label>
                    <input type="text" id="brand-website" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="品牌網站">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">品牌描述</label>
                    <textarea id="brand-description" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3" placeholder="品牌描述"></textarea>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">行業類別</label>
                    <select id="industry-category" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇行業類別</option>
                        <option value="technology">科技/電子</option>
                        <option value="finance">金融/銀行</option>
                        <option value="healthcare">醫療/健康</option>
                        <option value="retail">零售/消費</option>
                        <option value="manufacturing">製造業</option>
                        <option value="ecommerce">電商</option>
                        <option value="saas">SaaS</option>
                        <option value="fintech">金融科技</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">市場規模</label>
                    <input type="text" id="market-size" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="市場規模">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">分析主題</label>
                    <input type="text" id="analysis-topic" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="分析主題">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">競爭對手數量</label>
                    <input type="number" id="competitor-count" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="競爭對手數量">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">分析深度</label>
                    <div class="flex gap-2">
                        <label class="flex items-center">
                            <input type="radio" name="analysis-depth" value="basic" class="form-radio">
                            <span class="ml-2">基礎分析 (搜尋量、競爭度)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="analysis-depth" value="standard" class="form-radio">
                            <span class="ml-2">標準分析 (搜尋量、競爭度、出價建議)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="analysis-depth" value="comprehensive" class="form-radio">
                            <span class="ml-2">深度分析 (搜尋量、競爭度、出價建議、內容策略)</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">主要關鍵字</label>
                    <textarea id="primary-keywords" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3" placeholder="主要關鍵字，每行一個"></textarea>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">長尾關鍵字</label>
                    <textarea id="long-tail-keywords" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3" placeholder="長尾關鍵字，每行一個"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">商業模式</label>
                    <select id="business-model-select" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇商業模式</option>
                        <option value="b2b">B2B (企業對企業)</option>
                        <option value="b2c">B2C (企業對消費者)</option>
                        <option value="b2b2c">B2B2C (企業對企業對消費者)</option>
                        <option value="c2c">C2C (消費者對消費者)</option>
                        <option value="saas">SaaS (軟體即服務)</option>
                        <option value="marketplace">Marketplace (平台模式)</option>
                        <option value="subscription">Subscription (訂閱模式)</option>
                        <option value="freemium">Freemium (免費增值)</option>
                        <option value="ecommerce">E-commerce (電商)</option>
                        <option value="agency">Agency (代理/服務)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">本地化程度</label>
                    <select id="localization-level" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇本地化程度</option>
                        <option value="basic">基礎本地化 (翻譯) - 基本語言適應</option>
                        <option value="standard">標準本地化 (翻譯+文化適應) - 文化內容調整</option>
                        <option value="advanced">深度本地化 (完全在地化) - 完全文化適應</option>
                        <option value="native">原生本地化 (在地團隊開發) - 原生文化體驗</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">主要語言</label>
                    <select id="primary-language" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇主要語言</option>
                        <option value="zh-tw">繁體中文 (台灣)</option>
                        <option value="zh-hk">繁體中文 (香港)</option>
                        <option value="zh-cn">簡體中文 (中國)</option>
                        <option value="en">English (英語)</option>
                        <option value="ja">日本語 (日語)</option>
                        <option value="ko">한국어 (韓語)</option>
                        <option value="th">ไทย (泰語)</option>
                        <option value="vi">Tiếng Việt (越南語)</option>
                        <option value="id">Bahasa Indonesia (印尼語)</option>
                        <option value="ms">Bahasa Melayu (馬來語)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">目標客群</label>
                    <select id="target-audience" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇目標客群</option>
                        <option value="startup">新創公司 - 成本敏感，快速決策</option>
                        <option value="sme">中小企業 - 實用導向，性價比重要</option>
                        <option value="enterprise">大型企業 - 品質要求高，決策週期長</option>
                        <option value="freelancer">自由工作者 - 靈活性重要，成本控制</option>
                        <option value="student">學生 - 價格敏感，功能需求</option>
                        <option value="professional">專業人士 - 品質要求高，效率重要</option>
                        <option value="consumer">一般消費者 - 用戶體驗，情感訴求</option>
                        <option value="elderly">銀髮族 - 易用性，信任建立</option>
                        <option value="youth">年輕族群 - 創新，社交分享</option>
                        <option value="parent">家長 - 安全，品質，教育價值</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">項目 ID</label>
                    <input type="text" id="project-id" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="項目 ID">
                </div>
            </div>
            <div class="flex gap-4">
                <button id="start-analysis-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">開始分析</button>
                <button id="generate-report-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">生成報告</button>
            </div>
        </div>

        <div id="history-panel" class="bg-techpanel rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">歷史紀錄</h2>
            <div id="auto-search-results"></div>
        </div>

        <!-- 步驟導航 -->
        <div class="flex justify-center mb-6">
            <div class="flex space-x-4">
                <button id="step-1-btn" class="step-btn active bg-techprimary text-white px-6 py-2 rounded-lg" onclick="goToStep(1)">
                    步驟 1: 設定分析
                </button>
                <button id="step-2-btn" class="step-btn bg-gray-600 text-gray-300 px-6 py-2 rounded-lg" onclick="goToStep(2)">
                    步驟 2: 對手篩選
                </button>
                <button id="step-3-btn" class="step-btn bg-gray-600 text-gray-300 px-6 py-2 rounded-lg" onclick="goToStep(3)">
                    步驟 3: 生成報告
                </button>
            </div>
        </div>

        <div id="step-1" class="step-panel">
            <h3 class="text-lg font-semibold mb-4">步驟 1: 設定分析</h3>
            <p class="text-gray-300 mb-4">請在上方的分析設定面板中填寫必要資訊，然後點擊「開始分析」按鈕。</p>
            
            <!-- 產品管理 -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-200 mb-4">📦 產品/服務管理</h4>
                <div id="products-container" class="space-y-3 mb-4">
                    <!-- 產品項目將在這裡動態生成 -->
                </div>
                <button id="add-product-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">添加產品</button>
            </div>
            
            <!-- 開始分析按鈕 -->
            <div class="flex justify-center">
                <button id="start-analysis-btn" class="bg-techprimary hover:bg-techaccent text-white px-6 py-3 rounded-lg text-lg font-semibold">開始分析</button>
            </div>
        </div>

        <div id="step-2" class="step-panel">
            <h3 class="text-lg font-semibold mb-4">步驟 2: 競爭對手分析</h3>
            
            <!-- 當前分析主題 -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-200 mb-2">📊 當前分析主題</h4>
                <p class="text-gray-300">分析主題: <span id="current-topic" class="text-techaccent font-semibold">未設定</span></p>
            </div>
            
            <!-- 自動搜尋結果 -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-200 mb-4">🔍 行業競爭對手分析</h4>
                <div id="auto-search-results" class="space-y-4">
                    <p class="text-gray-400">正在載入競爭對手分析...</p>
                </div>
            </div>
            
            <!-- 手動添加競爭對手 -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-200 mb-4">➕ 手動添加競爭對手</h4>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="manual-competitor" class="flex-1 px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="競爭對手名稱（用逗號分隔多個）">
                    <button id="add-competitor-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">添加</button>
                </div>
                <p class="text-gray-400 text-sm">說明：輸入競爭對手名稱，多個競爭對手請用逗號分隔</p>
            </div>
            
            <!-- 已選擇的競爭對手 -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-200 mb-4">✅ 已選擇的競爭對手 (<span id="selected-count">0</span>)</h4>
                <div id="selected-competitors" class="space-y-2">
                    <p class="text-gray-500 text-sm">尚未選擇任何競爭對手</p>
                </div>
            </div>
            
            <!-- 操作按鈕 -->
            <div class="flex justify-between items-center">
                <button id="back-to-step1-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">返回步驟 1</button>
                <button id="generate-report-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded" disabled>生成完整報告</button>
            </div>
        </div>

        <div id="step-3" class="step-panel">
            <h3 class="text-lg font-semibold mb-4">步驟 3: 生成報告</h3>
            <div id="final-report-content"></div>
        </div>
    </div>
</body>
</html>