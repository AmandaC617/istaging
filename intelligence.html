<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>市場情資與競品分析平台 (V6 - 進階分析版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Tailwind CSS configuration for a modern, tech-themed UI
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        techbg: '#181D27',
                        techpanel: '#22283A',
                        techaccent: '#2EE9E4',
                        techprimary: '#3762F0',
                        techsecondary: '#7D5FFF'
                    },
                    fontFamily: {
                        'tech': ['"Segoe UI"', 'Roboto', 'Arial', 'sans-serif']
                    }
                }
            }
        }

        // 修正 Google API 載入問題
        window.addEventListener('load', function() {
            // 延遲載入 Google API 以避免跨域問題
            setTimeout(() => {
                if (typeof gapi !== 'undefined') {
                    gapi.load('client', function() {
                        console.log('Google API 載入成功');
                    });
                }
            }, 1000);
        });
    </script>
    <style>
        /* Base styling and animations */
        body { font-family: "Segoe UI", Roboto, Arial, sans-serif; }
        .tab-main.active { border-color: #2EE9E4; background-color: #181D27; color: #2EE9E4; }
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.5s ease; }
        .locked { opacity: 0.5; pointer-events: none; }
        .spinner { border: 4px solid rgba(59,130,246,.2); width: 36px; height: 36px; border-radius: 50%; border-left-color: #2EE9E4; animation: spin 1s ease infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Table and result panel styling */
        th, td { padding: 12px 15px; }
        .result-panel { max-height: 65vh; overflow-y: auto; }
        .overflow-x-auto { overflow-x: auto; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #181D27; }
        ::-webkit-scrollbar-thumb { background: #3762F0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #7D5FFF; }

        /* Stepper UI */
        .stepper-container { display: flex; justify-content: space-between; margin-bottom: 1.5rem; }
        .step { flex: 1; text-align: center; position: relative; }
        .step-circle { width: 32px; height: 32px; line-height: 30px; border-radius: 50%; background-color: #22283A; color: #fff; display: inline-block; border: 2px solid #3762F0; font-weight: bold; cursor: pointer; transition: all .3s ease; }
        .step-title { margin-top: 0.5rem; font-size: 0.875rem; color: #9ca3af; }
        .step-line { position: absolute; top: 16px; left: 50%; width: 100%; height: 2px; background-color: #3762F0; z-index: -1; }
        .step:first-child .step-line { left: 50%; width: 50%; }
        .step:last-child .step-line { left: 0; width: 50%;}
        
        .step.active .step-circle { background-color: #3762F0; color: #fff; border-color: #2EE9E4; transform: scale(1.1); }
        .step.active .step-title { color: #2EE9E4; font-weight: bold; }
        .step.completed .step-circle { background-color: #2EE9E4; color: #181D27; border-color: #2EE9E4; }
        .step.completed .step-title { color: #d1d5db; }

        /* Badge Styles */
        .badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-weight: 600; font-size: 0.75rem; }
        .badge-high { background-color: #ef4444; color: white; }
        .badge-mid { background-color: #f97316; color: white; }
        .badge-low { background-color: #22c55e; color: white; }
        .badge-unknown { background-color: #6b7280; color: white; }

        /* Dashboard Cards */
        .dashboard-card { background: linear-gradient(135deg, #22283A 0%, #1a1f2e 100%); border: 1px solid #3762F0; border-radius: 12px; padding: 1.5rem; }
        .metric-value { font-size: 2rem; font-weight: bold; color: #2EE9E4; }
        .metric-label { color: #9ca3af; font-size: 0.875rem; margin-top: 0.5rem; }

        /* Comparison Table */
        .comparison-table { border-collapse: separate; border-spacing: 0; }
        .comparison-table th { background: #1a1f2e; border: 1px solid #3762F0; padding: 12px; }
        .comparison-table td { border: 1px solid #3762F0; padding: 12px; }
        .comparison-table tr:nth-child(even) { background: rgba(55, 98, 240, 0.05); }

        /* Chart Container */
        .chart-container { position: relative; height: 300px; margin: 1rem 0; }
    </style>
</head>
<body class="bg-techbg font-tech text-gray-100 min-h-screen">
    <!-- Header Section -->
    <header class="bg-techpanel shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold tracking-wide text-techaccent flex items-center gap-2">
                <svg class="w-8 h-8 text-techprimary inline-block" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364-7.364l-1.414 1.414M6.05 17.95l-1.414 1.414m12.728 0l1.414-1.414M6.05 6.05L4.636 4.636" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                市場情資與競品分析平台
            </h1>
            <div id="auth-container">
                <div class="flex items-center gap-4">
                    <div id="user-profile" class="hidden items-center gap-3">
                        <img id="user-avatar" class="w-10 h-10 rounded-full" src="" alt="User Avatar">
                        <span id="user-name" class="font-semibold text-gray-200"></span>
                        <button id="signout_button" class="text-sm text-gray-400 hover:text-techaccent">登出</button>
                    </div>
                     <button id="authorize_button" class="hidden bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-5 py-2 rounded-lg shadow-lg">登入 Google</button>
                </div>
                <div class="text-xs text-yellow-400 mt-2">※ 需授權 Google Drive 全權限才能正確儲存資料</div>
            </div>
        </div>
    </header>

    <div id="alert-container" class="fixed top-24 right-6 z-50"></div>

    <main class="container mx-auto px-6 py-8">
        <div id="app-container" class="locked">
            <!-- Main Panels -->
            <div id="analysis-panel" class="panel active">
                <!-- Stepper -->
                <div class="stepper-container mb-8">
                    <div id="step-1" class="step active">
                        <div class="step-circle" onclick="goToStep(1)">1</div>
                        <div class="step-title">分析設定</div>
                        <div class="step-line"></div>
                    </div>
                    <div id="step-2" class="step">
                        <div class="step-circle" onclick="goToStep(2)">2</div>
                        <div class="step-title">對手篩選與補充</div>
                        <div class="step-line"></div>
                    </div>
                    <div id="step-3" class="step">
                        <div class="step-circle" onclick="goToStep(3)">3</div>
                        <div class="step-title">完整報告</div>
                    </div>
                </div>

                <!-- Main Tabs -->
                <div class="flex border-b border-techprimary/20 mb-6">
                    <button data-tab="analysis" class="tab-main tab-btn active flex-1 p-4 font-semibold">分析系統</button>
                    <button data-tab="settings" class="tab-main tab-btn flex-1 p-4 font-semibold">API 設定</button>
                    <button data-tab="history" class="tab-main tab-btn flex-1 p-4 font-semibold">歷史紀錄</button>
                </div>

                <div id="settings-panel" class="panel hidden">
                    <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8 max-w-lg mx-auto">
                        <h2 class="text-2xl font-bold mb-6 text-techaccent text-center">API 與應用程式設定</h2>
                        <div class="space-y-4">
                            <div><label for="google-api-key" class="block text-sm font-medium text-gray-300">Google API 金鑰</label><input type="password" id="google-api-key" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="填寫 Gemini/Custom Search API Key"></div>
                            <div><label for="search-engine-id" class="block text-sm font-medium text-gray-300">可程式化搜尋引擎 ID (CX)</label><input type="text" id="search-engine-id" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="填寫 Custom Search Engine ID"></div>
                            
                            <!-- 集中化資料夾管理設定 -->
                            <div class="border-t border-techprimary/30 pt-4 mt-6">
                                <h3 class="text-lg font-semibold text-techaccent mb-4">📁 集中化資料夾管理</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="central-folder-name" class="block text-sm font-medium text-gray-300">主要專案資料夾名稱</label>
                                        <input type="text" id="central-folder-name" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="iStaging_專案管理" placeholder="例如: iStaging_專案管理">
                                        <p class="text-xs text-gray-400 mt-1">此資料夾將包含所有專案的子資料夾</p>
                                    </div>
                                    <div>
                                        <label for="intelligence-subfolder" class="block text-sm font-medium text-gray-300">市場情資子資料夾名稱</label>
                                        <input type="text" id="intelligence-subfolder" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="01_市場情資分析" placeholder="例如: 01_市場情資分析">
                                    </div>
                                    <div>
                                        <label for="mediaplan-subfolder" class="block text-sm font-medium text-gray-300">媒體提案子資料夾名稱</label>
                                        <input type="text" id="mediaplan-subfolder" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="02_媒體提案" placeholder="例如: 02_媒體提案">
                                    </div>
                                    <div>
                                        <label for="workflow-subfolder" class="block text-sm font-medium text-gray-300">工作流程子資料夾名稱</label>
                                        <input type="text" id="workflow-subfolder" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="03_工作流程文件" placeholder="例如: 03_工作流程文件">
                                    </div>
                                </div>
                            </div>
                            
                            <button id="save-settings-btn" class="w-full bg-gradient-to-tr from-techprimary to-techaccent font-bold text-white px-5 py-3 rounded-lg shadow-lg mt-6">儲存設定</button>
                        </div>
                    </section>
                </div>

                <!-- 分析系統主要內容區域 -->
                <div id="analysis-panel" class="panel active">
                    <!-- Step 1: 分析設定 -->
                    <div id="step-1-content" class="step-panel">
                        <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8">
                            <h2 class="text-2xl font-bold mb-6 text-techaccent">📊 分析設定</h2>
                            
                            <!-- Project ID 輸入 -->
                            <div class="mb-6">
                                <label for="project-id" class="block text-sm font-medium text-gray-300 mb-2">專案 ID</label>
                                <input type="text" id="project-id" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="請輸入專案 ID">
                                <p class="text-xs text-gray-400 mt-1">此 ID 將用於檔案命名和資料夾組織</p>
                            </div>

                            <!-- 分析主題設定 -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label for="topic" class="block text-sm font-medium text-gray-300 mb-2">分析主題 *</label>
                                    <input type="text" id="topic" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="例如: 電動車市場分析">
                                </div>
                                <div>
                                    <label for="industry" class="block text-sm font-medium text-gray-300 mb-2">產業類別</label>
                                    <input type="text" id="industry" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="例如: 汽車製造業">
                                </div>
                                <div>
                                    <label for="product" class="block text-sm font-medium text-gray-300 mb-2">產品/服務</label>
                                    <input type="text" id="product" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="例如: 電動車">
                                </div>
                                <div>
                                    <label for="company" class="block text-sm font-medium text-gray-300 mb-2">公司名稱</label>
                                    <input type="text" id="company" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="例如: Tesla">
                                </div>
                            </div>

                            <!-- 業務模式選擇 -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-300 mb-3">業務模式</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <label class="flex items-center p-3 rounded-lg bg-techbg border border-techprimary/20 cursor-pointer hover:border-techaccent">
                                        <input type="radio" name="business-model" value="B2B" class="mr-2" checked>
                                        <span class="text-sm">B2B</span>
                                    </label>
                                    <label class="flex items-center p-3 rounded-lg bg-techbg border border-techprimary/20 cursor-pointer hover:border-techaccent">
                                        <input type="radio" name="business-model" value="B2C" class="mr-2">
                                        <span class="text-sm">B2C</span>
                                    </label>
                                    <label class="flex items-center p-3 rounded-lg bg-techbg border border-techprimary/20 cursor-pointer hover:border-techaccent">
                                        <input type="radio" name="business-model" value="B2B2C" class="mr-2">
                                        <span class="text-sm">B2B2C</span>
                                    </label>
                                    <label class="flex items-center p-3 rounded-lg bg-techbg border border-techprimary/20 cursor-pointer hover:border-techaccent">
                                        <input type="radio" name="business-model" value="SaaS" class="mr-2">
                                        <span class="text-sm">SaaS</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 地區和語言設定 -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div>
                                    <label for="country" class="block text-sm font-medium text-gray-300 mb-2">目標市場</label>
                                    <select id="country" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20">
                                        <option value="TW">台灣</option>
                                        <option value="US">美國</option>
                                        <option value="CN">中國</option>
                                        <option value="JP">日本</option>
                                        <option value="KR">韓國</option>
                                        <option value="SG">新加坡</option>
                                        <option value="HK">香港</option>
                                        <option value="MY">馬來西亞</option>
                                        <option value="TH">泰國</option>
                                        <option value="VN">越南</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="language" class="block text-sm font-medium text-gray-300 mb-2">分析語言</label>
                                    <select id="language" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20">
                                        <option value="zh-TW">繁體中文</option>
                                        <option value="en">English</option>
                                        <option value="zh-CN">簡體中文</option>
                                        <option value="ja">日本語</option>
                                        <option value="ko">한국어</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="sector" class="block text-sm font-medium text-gray-300 mb-2">細分產業</label>
                                    <input type="text" id="sector" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="例如: 新能源汽車">
                                </div>
                            </div>

                            <button id="start-analysis-btn" class="w-full bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-6 py-3 rounded-lg shadow-lg">開始分析</button>
                        </section>
                    </div>

                    <!-- Step 2: 對手篩選與補充 -->
                    <div id="step-2-content" class="step-panel hidden">
                        <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8">
                            <h2 class="text-2xl font-bold mb-6 text-techaccent">🎯 對手篩選與補充</h2>
                            
                            <div class="mb-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-gray-200">初步競爭對手清單</h3>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="select-all-competitors" class="mr-2">
                                        <span class="text-sm text-gray-300">全選</span>
                                    </label>
                                </div>
                                <div id="initial-competitors-list" class="space-y-3">
                                    <!-- 競爭對手項目將在這裡動態生成 -->
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <button id="analyze-selected-btn" class="bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-6 py-3 rounded-lg shadow-lg">分析選中的競爭對手</button>
                                <button onclick="goToStep(1)" class="bg-gray-600 hover:bg-gray-700 font-bold text-white px-6 py-3 rounded-lg shadow-lg">返回上一步</button>
                            </div>
                        </section>
                    </div>

                    <!-- Step 3: 完整報告 -->
                    <div id="step-3-content" class="step-panel hidden">
                        <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8">
                            <h2 class="text-2xl font-bold mb-6 text-techaccent">📈 完整分析報告</h2>
                            
                            <!-- 載入指示器 -->
                            <div id="loading-indicator" class="hidden flex items-center justify-center py-8">
                                <div class="spinner mr-4"></div>
                                <div id="loading-status" class="text-gray-300">正在生成報告...</div>
                            </div>

                            <!-- 結果容器 -->
                            <div id="results-container" class="space-y-6">
                                <!-- 報告內容將在這裡動態生成 -->
                            </div>

                            <div class="flex gap-4 mt-8">
                                <button id="save-analysis-btn" class="bg-gradient-to-tr from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 font-bold text-white px-6 py-3 rounded-lg shadow-lg">儲存到 Google Drive</button>
                                <button id="export-excel-btn" class="bg-gradient-to-tr from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 font-bold text-white px-6 py-3 rounded-lg shadow-lg">匯出 Excel</button>
                                <button onclick="goToStep(2)" class="bg-gray-600 hover:bg-gray-700 font-bold text-white px-6 py-3 rounded-lg shadow-lg">返回上一步</button>
                            </div>
                        </section>
                    </div>
                </div>

                <div id="history-panel" class="panel hidden">
                     <div class="text-center text-gray-500 py-16">歷史紀錄功能正在開發中...</div>
                </div>
            </div>
        </div>
    </main>

<script>
// --- GLOBAL STATE AND CONFIGURATION ---
const GOOGLE_CLIENT_ID = "733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com";
const GOOGLE_SCOPES = "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.profile";

const state = {
    gapiReady: false,
    gisReady: false,
    tokenClient: null,
    accessToken: null,
    userProfile: null,
    driveFolderId: null,
    projectId: null,
    apiKeys: {
        google: null, searchEngineId: null, driveFolderName: 'Market_Analysis_Data'
    },
    folderStructure: {
        centralFolder: 'iStaging_專案管理',
        intelligenceSubfolder: '01_市場情資分析',
        mediaplanSubfolder: '02_媒體提案',
        workflowSubfolder: '03_工作流程文件'
    },
    folderIds: {
        central: null,
        intelligence: null,
        mediaplan: null,
        workflow: null
    },
    isApiReady: false,
    currentStep: 1,
    analysisData: {
        context: null,
        initialCompetitors: [],
        keywords: [],
        finalCompetitors: []
    },
    sortState: {
        keywords: { key: 'volume', order: 'desc' },
        competitors: { key: 'brandName', order: 'asc' }
    }
};

const ui = {
    authorizeButton: document.getElementById('authorize_button'),
    signOutButton: document.getElementById('signout_button'),
    userProfileDiv: document.getElementById('user-profile'),
    userNameSpan: document.getElementById('user-name'),
    userAvatarImg: document.getElementById('user-avatar'),
    appContainer: document.getElementById('app-container'),
    projectIdInput: document.getElementById('project-id'),
    saveSettingsBtn: document.getElementById('save-settings-btn'),
    startAnalysisBtn: document.getElementById('start-analysis-btn'),
    analyzeSelectedBtn: document.getElementById('analyze-selected-btn'),
    selectAllCompetitors: document.getElementById('select-all-competitors'),
    loadingIndicator: document.getElementById('loading-indicator'),
    spinner: document.querySelector('.spinner'),
    loadingStatus: document.getElementById('loading-status'),
    resultsContainer: document.getElementById('results-container'),
    saveAnalysisBtn: document.getElementById('save-analysis-btn'),
    exportExcelBtn: document.getElementById('export-excel-btn'),
};

// --- INITIALIZATION ---
window.onload = function() {
    setupGapi();
    setupEventListeners();
    loadProjectIdFromUrl();
};

function setupGapi() {
    const gapiScript = document.createElement('script');
    gapiScript.src = 'https://apis.google.com/js/api.js';
    gapiScript.onload = () => gapi.load('client', () => {
        state.gapiReady = true;
        updateUIState();
    });
    document.body.appendChild(gapiScript);

    const gisScript = document.createElement('script');
    gisScript.src = 'https://accounts.google.com/gsi/client';
    gisScript.async = true;
    gisScript.defer = true;
    gisScript.onload = () => {
        state.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: GOOGLE_SCOPES,
            callback: gisInCallback,
        });
        state.gisReady = true;
        updateUIState();
    };
    document.body.appendChild(gisScript);
}

function setupEventListeners() {
    // 安全地設置事件監聽器，檢查元素是否存在
    if (ui.authorizeButton) {
        ui.authorizeButton.onclick = () => state.tokenClient?.requestAccessToken();
    }
    if (ui.signOutButton) {
        ui.signOutButton.onclick = handleSignOut;
    }
    if (ui.saveSettingsBtn) {
        ui.saveSettingsBtn.onclick = handleSaveSettings;
    }
    if (ui.startAnalysisBtn) {
        ui.startAnalysisBtn.onclick = startInitialAnalysis;
    }
    if (ui.analyzeSelectedBtn) {
        ui.analyzeSelectedBtn.onclick = processAndAnalyzeCompetitors;
    }
    if (ui.selectAllCompetitors) {
        ui.selectAllCompetitors.onchange = (e) => {
            document.querySelectorAll('.competitor-checkbox').forEach(cb => cb.checked = e.target.checked);
        };
    }
    
    // 設置標籤頁切換事件
    document.querySelectorAll('.tab-main').forEach(btn => btn.addEventListener('click', handleMainTabSwitch));
    
    if (ui.saveAnalysisBtn) {
        ui.saveAnalysisBtn.onclick = saveAnalysisToDrive;
    }
    if (ui.exportExcelBtn) {
        ui.exportExcelBtn.onclick = exportToExcel;
    }
    
    // 新增事件監聽器
    setupEnhancedEventListeners();
}

// --- UI & STATE MANAGEMENT ---
function updateUIState() {
    const loggedIn = !!state.accessToken;
    ui.authorizeButton.classList.toggle('hidden', loggedIn);
    ui.userProfileDiv.classList.toggle('hidden', !loggedIn);
    ui.appContainer.classList.toggle('locked', !loggedIn);

    if (!loggedIn) {
        goToStep(1); // Reset to first step on logout
        showAlert('請先登入', '登入 Google 帳號以開始使用。', 'info');
    } else if (!state.isApiReady) {
        handleMainTabSwitch({ target: document.querySelector('[data-tab="settings"]') });
        showAlert('請先設定 API', '請在 API 設定頁面填寫必要的金鑰。', 'warning');
    }
}

function showAlert(title, message, type = 'info') {
    const alertContainer = document.getElementById('alert-container');
    const colors = {
        success: { bg: 'bg-green-500', text: 'text-white' },
        error: { bg: 'bg-red-500', text: 'text-white' },
        warning: { bg: 'bg-yellow-400', text: 'text-black' },
        info: { bg: 'bg-blue-500', text: 'text-white' }
    };
    const alertDiv = document.createElement('div');
    alertDiv.className = `rounded-lg shadow-lg px-5 py-3 mb-2 font-bold ${colors[type].bg} ${colors[type].text} transition-all duration-300 opacity-0 transform translate-x-10`;
    alertDiv.innerHTML = `<strong>${title}</strong> <span class="font-normal">${message}</span>`;
    alertContainer.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.opacity = '1';
        alertDiv.style.transform = 'translateX(0)';
    }, 10);
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        alertDiv.style.transform = 'translateX(10px)';
        alertDiv.addEventListener('transitionend', () => alertDiv.remove());
    }, 5000);
}

function handleMainTabSwitch(event) {
    const btn = event.target.closest('.tab-main');
    if (!btn || btn.classList.contains('active')) return;

    // 移除所有標籤頁的active狀態
    document.querySelectorAll('.tab-main').forEach(tab => {
        if (tab) tab.classList.remove('active');
    });
    btn.classList.add('active');

    const tabName = btn.dataset.tab;
    
    // 隱藏所有panel
    document.querySelectorAll('.panel').forEach(panel => {
        if (panel) panel.classList.remove('active');
    });
    
    // 顯示目標panel
    const targetPanel = document.getElementById(`${tabName}-panel`);
    if (targetPanel) {
        targetPanel.classList.add('active');
    } else {
        console.error(`找不到panel: ${tabName}-panel`);
    }
}

function setLoadingState(isLoading, message = '') {
    ui.loadingIndicator.classList.toggle('hidden', !isLoading);
    ui.loadingIndicator.classList.toggle('flex', isLoading);
    ui.resultsContainer.classList.toggle('hidden', isLoading);

    ui.loadingStatus.textContent = message;

    ui.startAnalysisBtn.disabled = isLoading;
    ui.analyzeSelectedBtn.disabled = isLoading;
    document.querySelectorAll('.step-circle').forEach(c => c.style.pointerEvents = isLoading ? 'none' : 'auto');
}

// --- STEPPER NAVIGATION ---
window.goToStep = function(step) {
    if (step > state.currentStep) return;
    if (step === 3 && state.analysisData.finalCompetitors.length === 0) return;
    if (step === 2 && state.analysisData.initialCompetitors.length === 0) return;

    // 隱藏所有step-panel
    document.querySelectorAll('.step-panel').forEach(p => {
        if (p) p.classList.add('hidden');
    });
    
    // 顯示目標step-panel
    const targetPanel = document.getElementById(`step-${step}-content`);
    if (targetPanel) {
        targetPanel.classList.remove('hidden');
    }

    // 更新step指示器
    document.querySelectorAll('.step').forEach((s) => {
        if (s) {
            s.classList.remove('active', 'completed');
            const currentStepNum = parseInt(s.id.split('-')[1]);
            if (currentStepNum < step) {
                s.classList.add('completed');
            } else if (currentStepNum === step) {
                s.classList.add('active');
            }
        }
    });
    
    if(step < state.currentStep) state.currentStep = step;
}

function advanceStep(step) {
    state.currentStep = step;
    goToStep(step);
}

// --- AUTHENTICATION & SETTINGS ---
async function gisInCallback(response) {
    if (response.error) { showAlert('登入失敗', response.error, 'error'); return; }
    state.accessToken = response.access_token;
    gapi.client.setToken({ access_token: state.accessToken });
    await updateUserInfo();
    updateUIState();
    if (state.isApiReady) await findOrCreateDriveFolder();
}

async function updateUserInfo() {
    try {
        const res = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', { headers: { 'Authorization': `Bearer ${state.accessToken}` } });
        if (!res.ok) throw new Error('無法獲取用戶資訊');
        const profile = await res.json();
        state.userProfile = profile;
        ui.userNameSpan.textContent = profile.name;
        ui.userAvatarImg.src = profile.picture;
        showAlert('登入成功', `歡迎您，${profile.name}！`, 'success');
    } catch (error) {
        showAlert('錯誤', '無法獲取用戶個人資料。', 'error');
        handleSignOut();
    }
}

function handleSignOut() {
    state.accessToken = null; state.userProfile = null; state.driveFolderId = null;
    gapi.client.setToken(null);
    updateUIState();
    showAlert('已登出', '您已成功登出。');
}

async function handleSaveSettings() {
    state.apiKeys.google = document.getElementById('google-api-key').value.trim();
    state.apiKeys.searchEngineId = document.getElementById('search-engine-id').value.trim();
    
    // 讀取集中化資料夾設定
    state.folderStructure.centralFolder = document.getElementById('central-folder-name').value.trim() || 'iStaging_專案管理';
    state.folderStructure.intelligenceSubfolder = document.getElementById('intelligence-subfolder').value.trim() || '01_市場情資分析';
    state.folderStructure.mediaplanSubfolder = document.getElementById('mediaplan-subfolder').value.trim() || '02_媒體提案';
    state.folderStructure.workflowSubfolder = document.getElementById('workflow-subfolder').value.trim() || '03_工作流程文件';

    if (state.apiKeys.google && state.apiKeys.searchEngineId) {
        state.isApiReady = true;
        showAlert('設定已儲存', 'API 與資料夾設定已儲存完成。', 'success');
        handleMainTabSwitch({ target: document.querySelector('[data-tab="analysis"]') });
        if (state.accessToken) await setupCentralizedFolderStructure();
    } else {
        state.isApiReady = false;
        showAlert('設定不完整', '請填寫 Google API 金鑰和搜尋引擎 ID。', 'warning');
    }
}

// --- CORE ANALYSIS WORKFLOW ---
function validateInputFields() {
    const context = getSearchContext();
    const hasInput = context.topic || context.industry || context.product;
    if (!hasInput) {
        showAlert('輸入不足', '請至少填寫分析主題、產品或產業名稱。', 'warning');
    }
    return hasInput;
}

function getSearchContext() {
    return {
        topic: document.getElementById('topic')?.value.trim(),
        businessModel: document.querySelector('input[name="business-model"]:checked').value,
        country: document.getElementById('country').value,
        language: document.getElementById('language').value,
        industry: document.getElementById('industry').value.trim(),
        sector: document.getElementById('sector').value.trim(),
        product: document.getElementById('product').value.trim(),
        company: document.getElementById('company').value.trim(),
    };
}

async function startInitialAnalysis() {
    // 驗證 project ID
    const projectId = ui.projectIdInput.value.trim();
    if (!projectId) {
        showAlert('專案 ID 必填', '請輸入從 Workflow 系統取得的專案 ID。', 'warning');
        return;
    }
    
    // 儲存 project ID 到 state
    state.projectId = projectId;
    
    if (!validateInputFields()) return;
    
    state.analysisData = { context: getSearchContext(), initialCompetitors: [], keywords: [], finalCompetitors: [] };
    
    setLoadingState(true, '正在產生 AI 建議列表...');
    
    try {
        const [keywords, competitorNames] = await Promise.all([
            getAiKeywordSuggestions(state.analysisData.context),
            getAiCompetitorNames(state.analysisData.context)
        ]);

        state.analysisData.keywords = keywords || [];
        state.analysisData.initialCompetitors = competitorNames || [];

        if (competitorNames.length === 0) {
            showAlert('查無競爭對手', 'AI 未能找到相關對手，請直接進入報告頁面查看關鍵字。', 'info');
            renderFullReport(); 
            advanceStep(3);
        } else {
            renderCompetitorSelection(competitorNames);
            advanceStep(2);
        }
    } catch (error) {
        showAlert('分析失敗', `步驟一失敗: ${error.message}`, 'error');
    } finally {
        setLoadingState(false);
    }
}

function processAndAnalyzeCompetitors() {
    const selectedAINames = Array.from(document.querySelectorAll('.competitor-checkbox:checked')).map(cb => cb.value);
    const supplementalInput = document.getElementById('supplemental-competitors').value;
    const supplementalNames = supplementalInput.split(/[\n,]/).map(name => name.trim()).filter(Boolean);
    const finalCompetitorList = [...new Set([...selectedAINames, ...supplementalNames])];
    
    if (finalCompetitorList.length === 0) {
        showAlert("未指定對手", "請至少勾選或補充一個競爭對手進行分析。", "warning");
        return;
    }

    analyzeCompetitors(finalCompetitorList);
}


async function analyzeCompetitors(competitorNames) {
    advanceStep(3);
    setLoadingState(true, `正在分析 ${competitorNames.length} 個競爭對手...`);

    try {
        const competitorPromises = competitorNames.map(name => getFullCompetitorDetails(name, state.analysisData.context));
        const competitorDetails = await Promise.all(competitorPromises);
        
        state.analysisData.finalCompetitors = competitorDetails.filter(Boolean);
        
        renderFullReport();
        showAlert('分析完成', `已成功取得 ${state.analysisData.finalCompetitors.length} 家競爭對手的詳細資料。`, 'success');

    } catch (error) {
        showAlert('分析失敗', `步驟二失敗: ${error.message}`, 'error');
    } finally {
        setLoadingState(false);
    }
}

// --- GOOGLE API & AI PROMPTS ---
async function callGemini(prompt) {
    const apiKey = state.apiKeys.google;
    if (!apiKey) throw new Error('Google API 金鑰未設定。');
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
    const body = { contents: [{ parts: [{ text: prompt }] }] };
    const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`Gemini API 錯誤: ${errorData.error?.message || response.statusText}`);
    }
    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) throw new Error('Gemini 回傳內容為空。');
    try {
        const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```|(\[.*\])|(\{.*\})/s);
        if (!jsonMatch) throw new Error('回傳的內容不包含有效的 JSON 格式。');
        return JSON.parse(jsonMatch[1] || jsonMatch[2] || jsonMatch[3]);
    } catch (e) {
        console.error("Gemini JSON parsing error:", e, "\nOriginal text:", text);
        throw new Error('Gemini 回傳格式解析失敗，請查看控制台日誌。');
    }
}

async function searchGoogle(query) {
    const apiKey = state.apiKeys.google;
    const cx = state.apiKeys.searchEngineId;
    if (!apiKey || !cx) throw new Error('Google API 金鑰或搜尋引擎 ID 未設定。');
    const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=${encodeURIComponent(query)}`;
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Custom Search API 錯誤: ${response.statusText}`);
        const data = await response.json();
        return data.items?.[0]?.link || null;
    } catch (error) {
        console.error(`Google Search for "${query}" failed:`, error);
        return null;
    }
}

async function getAiKeywordSuggestions(context) {
    const prompt = `You are a world-class SEO expert. Based on the following criteria, generate as many relevant SEO keywords as possible, aiming for 40-50, in the specified language. Critically, tailor keywords to the "businessModel". Also provide estimated search volume (高/中/低), type, and bidding competition (高/中/低). Output MUST be a valid JSON array of objects, with NO other text. Criteria: ${JSON.stringify(context)}. Format: [{"keyword": "...", "volume": "...", "type": "...", "biddingCompetition": "..."}, ...].`;
    return callGemini(prompt);
}

async function getAiCompetitorNames(context) {
    const prompt = `You are a market analysis expert. Based on the criteria below, identify the top 10 competitors. Output MUST be a valid JSON array of strings, with NO other text. Criteria: ${JSON.stringify(context)}. Format: ["Competitor A", "Competitor B", ...].`;
    return callGemini(prompt);
}

async function getFullCompetitorDetails(name, context) {
    const prompt = `Analyze the company "${name}", a competitor in the market of "${context.topic}". Find its official stock ticker, headquarters state/province, and postal code. Output MUST be a single valid JSON object. If a value isn't found, use null. Criteria: ${JSON.stringify(context)}. Format: {"brandName": "${name}", "country": "...", "summary": "...", "companyType": "...", "stockTicker": "e.g., AAPL", "state": "e.g., California", "postalCode": "e.g., 95014"}`;
    const detailPromise = callGemini(prompt);
    const websitePromise = searchGoogle(`${name} ${context.industry || ''} official website`);
    const linkedinPromise = searchGoogle(`site:linkedin.com/company/ ${name}`);
    const [details, websiteUrl, linkedinUrl] = await Promise.all([detailPromise.catch(e => ({ brandName: name })), websitePromise, linkedinPromise]);
    return { ...details, websiteUrl, linkedinUrl };
}

// --- RESULT RENDERING ---
function renderCompetitorSelection(competitorNames) {
    const listEl = document.getElementById('competitor-checkbox-list');
    listEl.innerHTML = competitorNames.map(name => `
        <label class="block p-3 rounded-lg hover:bg-techprimary/20 transition-colors bg-techbg cursor-pointer">
            <input type="checkbox" class="competitor-checkbox mr-3 accent-techaccent" value="${name}" checked>
            <span>${name}</span>
        </label>
    `).join('');
    document.getElementById('supplemental-competitors').value = '';
}

function renderFullReport() {
    renderCompetitorResults();
    renderKeywordResults();
}

function renderCompetitorResults() {
    const card = document.getElementById('competitors-result-card');
    const data = state.analysisData.finalCompetitors || [];
    let content = `<h3 class="text-xl font-bold mb-4 text-techaccent">A. 競爭對手分析</h3>`;

    if (data.length === 0) {
        card.innerHTML = content + '<p class="text-gray-500">沒有要顯示的競爭對手資料。</p>';
        return;
    }
    const headers = ['品牌', '國家', '股票代號', '州別', '郵遞區號', '連結'];
    const keys = ['brandName', 'country', 'stockTicker', 'state', 'postalCode', 'links'];
    const sortedData = sortData('competitors', data);

    content += `<div class="overflow-x-auto result-panel">
        <table class="w-full text-left text-sm">
        <thead class="bg-gray-900 sticky top-0 z-10"><tr class="border-b border-techprimary/30">
        ${headers.map((h, i) => `<th class="py-3 px-3 cursor-pointer" onclick="sortTable('competitors', '${keys[i]}')">${h}${getSortIcon('competitors', keys[i])}</th>`).join('')}
        </tr></thead><tbody>
        ${sortedData.map(item => `
            <tr class="border-b border-techprimary/20 hover:bg-techprimary/10">
                <td class="font-semibold">${item.brandName || '-'}</td>
                <td>${item.country || '-'}</td>
                <td>${item.stockTicker || '-'}</td>
                <td>${item.state || '-'}</td>
                <td>${item.postalCode || '-'}</td>
                <td class="flex gap-4 items-center">
                    ${item.websiteUrl ? `<a href="${item.websiteUrl}" target="_blank" title="官方網站" class="text-gray-400 hover:text-techaccent"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></a>` : ''}
                    ${item.linkedinUrl ? `<a href="${item.linkedinUrl}" target="_blank" title="LinkedIn" class="text-gray-400 hover:text-techaccent"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a>` : ''}
                </td>
            </tr>
        `).join('')}
        </tbody></table></div>`;
    card.innerHTML = content;
}

function renderKeywordResults() {
    const card = document.getElementById('keywords-result-card');
    const data = state.analysisData.keywords || [];
    let content = `<h3 class="text-xl font-bold mb-4 text-techaccent">B. 關鍵字建議</h3>`;
    if (data.length === 0) {
        card.innerHTML = content + '<p class="text-gray-500">沒有要顯示的關鍵字資料。</p>'; return;
    }
    const headers = ['關鍵字', '搜尋量級', '出價競爭', '類型'];
    const keys = ['keyword', 'volume', 'biddingCompetition', 'type'];
    const sortedData = sortData('keywords', data);
    const getBadgeClass = (value) => {
        const lower = String(value).toLowerCase();
        if (lower === '高' || lower === 'high') return 'badge-high';
        if (lower === '中' || lower === 'medium') return 'badge-mid';
        if (lower === '低' || lower === 'low') return 'badge-low';
        return 'badge-unknown';
    };
    content += `<div class="overflow-x-auto result-panel"><table class="w-full text-left text-sm">
        <thead class="bg-gray-900 sticky top-0 z-10"><tr class="border-b border-techprimary/30">
        ${headers.map((h, i) => `<th class="py-3 px-3 cursor-pointer" onclick="sortTable('keywords', '${keys[i]}')">${h}${getSortIcon('keywords', keys[i])}</th>`).join('')}
        </tr></thead><tbody>
        ${sortedData.map(item => `
            <tr class="border-b border-techprimary/20 hover:bg-techprimary/10">
                <td>${item.keyword || '-'}</td>
                <td><span class="badge ${getBadgeClass(item.volume)}">${item.volume || 'N/A'}</span></td>
                <td><span class="badge ${getBadgeClass(item.biddingCompetition)}">${item.biddingCompetition || 'N/A'}</span></td>
                <td>${item.type || '-'}</td>
            </tr>
        `).join('')}
        </tbody></table></div>`;
    card.innerHTML = content;
}

// --- DATA SORTING & UTILS ---
function getSortIcon(type, key) {
    if (state.sortState[type].key !== key) return '';
    return state.sortState[type].order === 'asc' ? ' ▲' : ' ▼';
}
window.sortTable = function(type, key) {
    const sortState = state.sortState[type];
    if (sortState.key === key) {
        sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
    } else {
        sortState.key = key;
        sortState.order = (key === 'volume' || key === 'biddingCompetition') ? 'desc' : 'asc';
    }
    if (type === 'keywords') renderKeywordResults();
    if (type === 'competitors') renderCompetitorResults();
};
function sortData(type, data) {
    const { key, order } = state.sortState[type];
    if (!key || !data) return data;
    const competitionMap = { '高': 3, '中': 2, '低': 1 };
    return [...data].sort((a, b) => {
        let aVal = a[key] || '', bVal = b[key] || '';
        if (key === 'volume' || key === 'biddingCompetition') {
            aVal = competitionMap[aVal] || 0;
            bVal = competitionMap[bVal] || 0;
            return order === 'asc' ? aVal - bVal : bVal - aVal;
        }
        return order === 'asc' ? String(aVal).localeCompare(String(bVal)) : String(bVal).localeCompare(String(aVal));
    });
}

// --- ACTIONS (SAVE, EXPORT) ---
function exportToExcel() {
    if (state.analysisData.finalCompetitors.length === 0 && state.analysisData.keywords.length === 0) {
        return showAlert("無法匯出", "目前沒有可匯出的分析結果。", "warning");
    }
    const wb = XLSX.utils.book_new();
    if (state.analysisData.finalCompetitors.length > 0) {
        const sheetData = state.analysisData.finalCompetitors.map(c => ({
            '品牌名稱': c.brandName, '國家': c.country, '摘要': c.summary, '公司類型': c.companyType,
            '股票代號': c.stockTicker, '州別': c.state, '郵遞區號': c.postalCode,
            '官方網站': c.websiteUrl, 'LinkedIn': c.linkedinUrl
        }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetData), "A_競爭對手分析");
    }
    if (state.analysisData.keywords.length > 0) {
        const sheetData = state.analysisData.keywords.map(k => ({ '關鍵字': k.keyword, '搜尋量級': k.volume, '出價競爭': k.biddingCompetition, '類型': k.type }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetData), "B_關鍵字建議");
    }
    const fileName = `${state.analysisData.context.topic || '市場分析'}_${new Date().toISOString().slice(0, 10)}.xlsx`;
    XLSX.writeFile(wb, fileName);
    showAlert('匯出成功', `已產生檔案 ${fileName}`, 'success');
}

async function saveAnalysisToDrive() {
    if (!state.projectId) return showAlert('專案 ID 缺失', '請先輸入專案 ID。', 'warning');
    if (state.analysisData.finalCompetitors.length === 0 && state.analysisData.keywords.length === 0) return showAlert('尚無結果', '請先執行分析。', 'warning');
    
    setLoadingState(true, '正在建立資料夾結構並儲存...');
    try {
        // 確保資料夾結構已建立
        if (!state.folderIds.intelligence) {
            await setupCentralizedFolderStructure();
        }
        
        // 在分析資料中加入 project ID
        const analysisDataWithProject = {
            ...state.analysisData,
            projectId: state.projectId,
            savedAt: new Date().toISOString(),
            savedBy: state.userProfile?.name || 'Unknown',
            tool: 'intelligence'
        };
        
        const fileContent = JSON.stringify(analysisDataWithProject, null, 2);
        const blob = new Blob([fileContent], { type: 'application/json' });
        const fileName = `[${state.projectId}]_市場情資分析_${state.analysisData.context.topic || '市場'}_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
        
        // 儲存到 intelligence 子資料夾
        const targetFolderId = state.folderIds.intelligence || state.driveFolderId;
        const metadata = { 
            name: fileName, 
            mimeType: 'application/json', 
            parents: [targetFolderId] 
        };
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', blob);
        
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${state.accessToken}` },
            body: form
        });
        
        if (!response.ok) throw new Error((await response.json()).error?.message || '未知上傳錯誤');
        
        showAlert('儲存成功', `分析結果已儲存至專案資料夾。專案 ID: ${state.projectId}`, 'success');
        
    } catch (error) {
        showAlert('存檔失敗', error.message, 'error');
    } finally {
        setLoadingState(false);
    }
}

async function findOrCreateDriveFolder() {
    try {
        await gapi.client.load('drive', 'v3');
        const folderName = state.apiKeys.driveFolderName;
        const response = await gapi.client.drive.files.list({ q: `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`, fields: 'files(id)' });
        if (response.result.files && response.result.files.length > 0) {
            state.driveFolderId = response.result.files[0].id;
        } else {
            const createResponse = await gapi.client.drive.files.create({ resource: { 'name': folderName, 'mimeType': 'application/vnd.google-apps.folder' }, fields: 'id' });
            state.driveFolderId = createResponse.result.id;
        }
    } catch (error) {
        console.error('Drive folder error:', error);
        showAlert('Drive 錯誤', `存取資料夾失敗: ${error.result?.error?.message || '未知錯誤'}`, 'error');
    }
}

// 新增：建立集中化資料夾結構
async function setupCentralizedFolderStructure() {
    try {
        await gapi.client.load('drive', 'v3');
        
        // 1. 建立或找到主要專案資料夾
        const centralFolderId = await findOrCreateFolder(state.folderStructure.centralFolder, null);
        state.folderIds.central = centralFolderId;
        
        // 2. 建立或找到專案子資料夾
        if (state.projectId) {
            const projectFolderName = `[${state.projectId}]_專案資料`;
            const projectFolderId = await findOrCreateFolder(projectFolderName, centralFolderId);
            
            // 3. 建立或找到各類別子資料夾
            const intelligenceFolderId = await findOrCreateFolder(state.folderStructure.intelligenceSubfolder, projectFolderId);
            const mediaplanFolderId = await findOrCreateFolder(state.folderStructure.mediaplanSubfolder, projectFolderId);
            const workflowFolderId = await findOrCreateFolder(state.folderStructure.workflowSubfolder, projectFolderId);
            
            state.folderIds.intelligence = intelligenceFolderId;
            state.folderIds.mediaplan = mediaplanFolderId;
            state.folderIds.workflow = workflowFolderId;
            
            // 設定 intelligence 的預設儲存資料夾
            state.driveFolderId = intelligenceFolderId;
            
            console.log('集中化資料夾結構建立完成:', {
                central: centralFolderId,
                project: projectFolderId,
                intelligence: intelligenceFolderId,
                mediaplan: mediaplanFolderId,
                workflow: workflowFolderId
            });
            
            showAlert('資料夾結構建立完成', `專案 ${state.projectId} 的資料夾結構已準備就緒`, 'success');
        }
        
    } catch (error) {
        console.error('建立資料夾結構失敗:', error);
        showAlert('資料夾建立失敗', `建立集中化資料夾結構時發生錯誤: ${error.message}`, 'error');
    }
}

// 輔助函數：建立或找到資料夾
async function findOrCreateFolder(folderName, parentId) {
    try {
        let query = `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`;
        if (parentId) {
            query += ` and '${parentId}' in parents`;
        }
        
        const response = await gapi.client.drive.files.list({ 
            q: query, 
            fields: 'files(id)' 
        });
        
        if (response.result.files && response.result.files.length > 0) {
            return response.result.files[0].id;
        } else {
            const folderMetadata = {
                name: folderName,
                mimeType: 'application/vnd.google-apps.folder'
            };
            
            if (parentId) {
                folderMetadata.parents = [parentId];
            }
            
            const createResponse = await gapi.client.drive.files.create({ 
                resource: folderMetadata, 
                fields: 'id' 
            });
            
            return createResponse.result.id;
        }
    } catch (error) {
        console.error(`建立資料夾 ${folderName} 失敗:`, error);
        throw error;
    }
}

// 新增：從 URL 參數讀取 project ID
function loadProjectIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('projectId');
    if (projectId) {
        ui.projectIdInput.value = projectId;
        state.projectId = projectId;
        console.log('從 URL 讀取到專案 ID:', projectId);
    }
}

// --- DASHBOARD & VISUALIZATION FUNCTIONS ---
function updateDashboard() {
    const competitors = state.analysisData.finalCompetitors || [];
    const keywords = state.analysisData.keywords || [];
    
    // 更新指標卡片
    document.getElementById('total-competitors').textContent = competitors.length;
    document.getElementById('total-keywords').textContent = keywords.length;
    document.getElementById('high-volume-keywords').textContent = keywords.filter(k => k.volume === '高').length;
    document.getElementById('high-competition-keywords').textContent = keywords.filter(k => k.biddingCompetition === '高').length;
    
    // 更新圖表
    updateKeywordVolumeChart(keywords);
    updateCompetitorLocationChart(competitors);
}

function updateKeywordVolumeChart(keywords) {
    const ctx = document.getElementById('keywordVolumeChart');
    if (!ctx) return;
    
    const volumeData = {
        '高': keywords.filter(k => k.volume === '高').length,
        '中': keywords.filter(k => k.volume === '中').length,
        '低': keywords.filter(k => k.volume === '低').length
    };
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(volumeData),
            datasets: [{
                data: Object.values(volumeData),
                backgroundColor: ['#ef4444', '#f97316', '#22c55e'],
                borderColor: '#22283A',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#9ca3af',
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });
}

function updateCompetitorLocationChart(competitors) {
    const ctx = document.getElementById('competitorLocationChart');
    if (!ctx) return;
    
    const locationCount = {};
    competitors.forEach(c => {
        const country = c.country || '未知';
        locationCount[country] = (locationCount[country] || 0) + 1;
    });
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(locationCount),
            datasets: [{
                label: '競爭對手數量',
                data: Object.values(locationCount),
                backgroundColor: '#3762F0',
                borderColor: '#2EE9E4',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: '#374151'
                    }
                },
                x: {
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: '#374151'
                    }
                }
            }
        }
    });
}

// --- COMPARISON ANALYSIS FUNCTIONS ---
function renderComparisonTable() {
    const competitors = state.analysisData.finalCompetitors || [];
    if (competitors.length === 0) {
        document.getElementById('comparison-table-container').innerHTML = '<p class="text-gray-500 text-center">沒有競爭對手資料可供比較</p>';
        return;
    }
    
    const comparisonFields = [
        { key: 'brandName', label: '品牌名稱' },
        { key: 'country', label: '國家' },
        { key: 'companyType', label: '公司類型' },
        { key: 'stockTicker', label: '股票代號' },
        { key: 'state', label: '州別/省份' },
        { key: 'postalCode', label: '郵遞區號' },
        { key: 'websiteUrl', label: '官方網站' },
        { key: 'linkedinUrl', label: 'LinkedIn' }
    ];
    
    let tableHTML = '<table class="comparison-table w-full">';
    
    // 表頭
    tableHTML += '<thead><tr>';
    tableHTML += '<th>比較項目</th>';
    competitors.forEach(comp => {
        tableHTML += `<th>${comp.brandName || '未知'}</th>`;
    });
    tableHTML += '</tr></thead>';
    
    // 表格內容
    tableHTML += '<tbody>';
    comparisonFields.forEach(field => {
        tableHTML += '<tr>';
        tableHTML += `<td class="font-semibold bg-gray-800">${field.label}</td>`;
        competitors.forEach(comp => {
            let value = comp[field.key] || '-';
            if (field.key === 'websiteUrl' && value !== '-') {
                value = `<a href="${value}" target="_blank" class="text-techaccent hover:underline">查看網站</a>`;
            } else if (field.key === 'linkedinUrl' && value !== '-') {
                value = `<a href="${value}" target="_blank" class="text-techaccent hover:underline">查看 LinkedIn</a>`;
            }
            tableHTML += `<td>${value}</td>`;
        });
        tableHTML += '</tr>';
    });
    tableHTML += '</tbody></table>';
    
    document.getElementById('comparison-table-container').innerHTML = tableHTML;
}

// --- GOOGLE ADS TOOLS FUNCTIONS ---
async function generateAdsSitesList() {
    const industry = document.getElementById('industry-for-ads').value;
    if (!industry) {
        showAlert('請選擇行業', '請先選擇要分析的行業。', 'warning');
        return;
    }
    
    setLoadingState(true, '正在生成 Google Ads 自定義人群網站清單...');
    
    try {
        const prompt = `作為 Google Ads 專家，請為 ${industry} 行業提供一份適合用於 Google Ads 自定義人群的網站清單。這些網站應該：
        1. 與該行業高度相關
        2. 有足夠的流量
        3. 適合用於再行銷
        4. 包含新聞、論壇、部落格等不同類型
        
        請提供 20-30 個網站，格式為 JSON 陣列，每個網站包含：
        - name: 網站名稱
        - url: 網站網址
        - type: 網站類型 (新聞/論壇/部落格/電商/其他)
        - relevance: 相關性 (高/中/低)
        - traffic: 流量等級 (高/中/低)
        
        行業: ${industry}`;
        
        const sitesList = await callGemini(prompt);
        renderAdsSitesResult(sitesList);
        
    } catch (error) {
        showAlert('生成失敗', error.message, 'error');
    } finally {
        setLoadingState(false);
    }
}

function renderAdsSitesResult(sitesList) {
    const container = document.getElementById('ads-sites-result');
    
    if (!sitesList || sitesList.length === 0) {
        container.innerHTML = '<p class="text-gray-500">無法生成網站清單</p>';
        return;
    }
    
    let html = `
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <h4 class="font-semibold text-techaccent">建議網站清單 (${sitesList.length} 個)</h4>
                <button onclick="exportAdsSitesToCSV()" class="text-sm bg-green-600 hover:bg-green-700 px-3 py-1 rounded">匯出 CSV</button>
            </div>
            <div class="max-h-96 overflow-y-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-800 sticky top-0">
                        <tr>
                            <th class="p-2 text-left">網站名稱</th>
                            <th class="p-2 text-left">網址</th>
                            <th class="p-2 text-left">類型</th>
                            <th class="p-2 text-left">相關性</th>
                            <th class="p-2 text-left">流量</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    sitesList.forEach(site => {
        const relevanceBadge = getBadgeClass(site.relevance);
        const trafficBadge = getBadgeClass(site.traffic);
        
        html += `
            <tr class="border-b border-gray-700">
                <td class="p-2">${site.name}</td>
                <td class="p-2">
                    <a href="${site.url}" target="_blank" class="text-techaccent hover:underline">${site.url}</a>
                </td>
                <td class="p-2">${site.type}</td>
                <td class="p-2"><span class="badge ${relevanceBadge}">${site.relevance}</span></td>
                <td class="p-2"><span class="badge ${trafficBadge}">${site.traffic}</span></td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // 儲存到全域變數供匯出使用
    window.adsSitesList = sitesList;
}

function exportAdsSitesToCSV() {
    if (!window.adsSitesList) {
        showAlert('無資料', '沒有可匯出的網站清單', 'warning');
        return;
    }
    
    const csvContent = [
        ['網站名稱', '網址', '類型', '相關性', '流量'],
        ...window.adsSitesList.map(site => [site.name, site.url, site.type, site.relevance, site.traffic])
    ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Google_Ads_自定義人群網站清單_${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
    
    showAlert('匯出成功', '網站清單已匯出為 CSV 檔案', 'success');
}

function generateKeywordStrategy() {
    const keywords = state.analysisData.keywords || [];
    if (keywords.length === 0) {
        document.getElementById('keyword-strategy-result').innerHTML = '<p class="text-gray-400">請先完成分析以查看關鍵字策略建議</p>';
        return;
    }
    
    const highVolumeKeywords = keywords.filter(k => k.volume === '高');
    const highCompetitionKeywords = keywords.filter(k => k.biddingCompetition === '高');
    const lowCompetitionKeywords = keywords.filter(k => k.biddingCompetition === '低');
    
    let strategyHTML = `
        <div class="space-y-6">
            <div class="bg-gray-800 p-4 rounded-lg">
                <h4 class="font-semibold text-techaccent mb-2">高搜尋量關鍵字 (${highVolumeKeywords.length} 個)</h4>
                <p class="text-sm text-gray-300 mb-3">建議：高預算投入，爭取排名前 3</p>
                <div class="flex flex-wrap gap-2">
                    ${highVolumeKeywords.slice(0, 10).map(k => `<span class="badge badge-high">${k.keyword}</span>`).join('')}
                </div>
            </div>
            
            <div class="bg-gray-800 p-4 rounded-lg">
                <h4 class="font-semibold text-techaccent mb-2">高競爭關鍵字 (${highCompetitionKeywords.length} 個)</h4>
                <p class="text-sm text-gray-300 mb-3">建議：謹慎出價，考慮長尾關鍵字</p>
                <div class="flex flex-wrap gap-2">
                    ${highCompetitionKeywords.slice(0, 10).map(k => `<span class="badge badge-high">${k.keyword}</span>`).join('')}
                </div>
            </div>
            
            <div class="bg-gray-800 p-4 rounded-lg">
                <h4 class="font-semibold text-techaccent mb-2">低競爭機會關鍵字 (${lowCompetitionKeywords.length} 個)</h4>
                <p class="text-sm text-gray-300 mb-3">建議：積極出價，爭取低成本轉換</p>
                <div class="flex flex-wrap gap-2">
                    ${lowCompetitionKeywords.slice(0, 10).map(k => `<span class="badge badge-low">${k.keyword}</span>`).join('')}
                </div>
            </div>
            
            <div class="bg-blue-900/20 p-4 rounded-lg border border-blue-500/30">
                <h4 class="font-semibold text-blue-400 mb-2">出價策略建議</h4>
                <ul class="text-sm text-gray-300 space-y-1">
                    <li>• 高搜尋量 + 低競爭：出價範圍 1.5-3.0</li>
                    <li>• 高搜尋量 + 高競爭：出價範圍 2.0-5.0</li>
                    <li>• 低搜尋量 + 低競爭：出價範圍 0.5-1.5</li>
                    <li>• 長尾關鍵字：出價範圍 0.3-1.0</li>
                </ul>
            </div>
        </div>
    `;
    
    document.getElementById('keyword-strategy-result').innerHTML = strategyHTML;
}

// --- AUTOMATED CONTENT DOWNLOAD ---
async function downloadContent() {
    if (!state.analysisData.finalCompetitors || state.analysisData.finalCompetitors.length === 0) {
        showAlert('無資料', '請先完成分析', 'warning');
        return;
    }
    
    setLoadingState(true, '正在下載競爭對手相關內容...');
    
    try {
        const downloadPromises = state.analysisData.finalCompetitors.map(async (competitor, index) => {
            const content = {
                brandName: competitor.brandName,
                websiteUrl: competitor.websiteUrl,
                linkedinUrl: competitor.linkedinUrl,
                summary: competitor.summary,
                downloadTime: new Date().toISOString()
            };
            
            // 建立檔案名稱
            const fileName = `${competitor.brandName}_競爭對手資料_${new Date().toISOString().slice(0, 10)}.json`;
            
            // 建立 Blob 並下載
            const blob = new Blob([JSON.stringify(content, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // 延遲下載以避免瀏覽器阻擋
            await new Promise(resolve => setTimeout(resolve, 1000));
        });
        
        await Promise.all(downloadPromises);
        showAlert('下載完成', `已下載 ${state.analysisData.finalCompetitors.length} 個競爭對手資料檔案`, 'success');
        
    } catch (error) {
        showAlert('下載失敗', error.message, 'error');
    } finally {
        setLoadingState(false);
    }
}

// --- ENHANCED COMPETITOR ANALYSIS ---
async function getEnhancedCompetitorDetails(name, context) {
    const prompt = `請對公司 "${name}" 進行深入分析，該公司是 "${context.topic}" 市場的競爭對手。請提供以下詳細資訊：

    1. 公司基本資訊：成立時間、員工人數、年營收範圍
    2. 產品/服務：主要產品線、特色功能、價格定位
    3. 市場地位：市占率、品牌知名度、競爭優勢
    4. 行銷策略：主要行銷管道、廣告投放、內容策略
    5. 技術實力：專利數量、研發投入、技術優勢
    6. 財務狀況：股票表現、財務健康度、投資動向
    7. 未來發展：擴張計劃、新產品開發、市場策略

    請以 JSON 格式回傳，包含以下欄位：
    {
        "brandName": "${name}",
        "basicInfo": { "founded": "年份", "employees": "人數範圍", "revenue": "營收範圍" },
        "products": { "mainProducts": ["產品1", "產品2"], "features": ["特色1", "特色2"], "pricing": "價格定位" },
        "marketPosition": { "marketShare": "市占率", "brandAwareness": "知名度", "competitiveAdvantage": "競爭優勢" },
        "marketingStrategy": { "channels": ["管道1", "管道2"], "advertising": "廣告策略", "contentStrategy": "內容策略" },
        "technology": { "patents": "專利數量", "rdInvestment": "研發投入", "techAdvantage": "技術優勢" },
        "financials": { "stockPerformance": "股票表現", "financialHealth": "財務健康度", "investments": "投資動向" },
        "futurePlans": { "expansion": "擴張計劃", "newProducts": "新產品開發", "marketStrategy": "市場策略" }
    }`;

    try {
        const enhancedDetails = await callGemini(prompt);
        return enhancedDetails;
    } catch (error) {
        console.error(`Enhanced analysis failed for ${name}:`, error);
        return { brandName: name, error: error.message };
    }
}

// --- EVENT LISTENERS FOR NEW FEATURES ---
function setupEnhancedEventListeners() {
    // 新增事件監聽器
    document.getElementById('generate-ads-sites-btn').onclick = generateAdsSitesList;
    document.getElementById('download-content-btn').onclick = downloadContent;
    
    // 標籤切換時更新相關內容
    document.querySelectorAll('.tab-main').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const tab = e.target.dataset.tab;
            if (tab === 'dashboard') {
                setTimeout(updateDashboard, 100);
            } else if (tab === 'comparison') {
                setTimeout(renderComparisonTable, 100);
            } else if (tab === 'ads-tools') {
                setTimeout(generateKeywordStrategy, 100);
            }
        });
    });
}

// --- ENHANCED RENDERING FUNCTIONS ---
function renderEnhancedCompetitorResults() {
    const card = document.getElementById('competitors-result-card');
    const data = state.analysisData.finalCompetitors || [];
    let content = `<h3 class="text-xl font-bold mb-4 text-techaccent">A. 競爭對手深度分析</h3>`;

    if (data.length === 0) {
        card.innerHTML = content + '<p class="text-gray-500">沒有要顯示的競爭對手資料。</p>';
        return;
    }

    content += `<div class="space-y-4">`;
    
    data.forEach(competitor => {
        content += `
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="flex justify-between items-start mb-3">
                    <h4 class="text-lg font-semibold text-techaccent">${competitor.brandName}</h4>
                    <div class="flex gap-2">
                        ${competitor.websiteUrl ? `<a href="${competitor.websiteUrl}" target="_blank" class="text-gray-400 hover:text-techaccent" title="官方網站"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a>` : ''}
                        ${competitor.linkedinUrl ? `<a href="${competitor.linkedinUrl}" target="_blank" class="text-gray-400 hover:text-techaccent" title="LinkedIn"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a>` : ''}
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-gray-400">國家: <span class="text-gray-200">${competitor.country || '未知'}</span></p>
                        <p class="text-gray-400">股票代號: <span class="text-gray-200">${competitor.stockTicker || '未上市'}</span></p>
                        <p class="text-gray-400">公司類型: <span class="text-gray-200">${competitor.companyType || '未知'}</span></p>
                    </div>
                    <div>
                        <p class="text-gray-400">州別: <span class="text-gray-200">${competitor.state || '未知'}</span></p>
                        <p class="text-gray-400">郵遞區號: <span class="text-gray-200">${competitor.postalCode || '未知'}</span></p>
                    </div>
                </div>
                
                ${competitor.summary ? `<p class="text-gray-300 mt-3 text-sm">${competitor.summary}</p>` : ''}
            </div>
        `;
    });
    
    content += `</div>`;
    card.innerHTML = content;
}
</script>
</body>
</html>
