<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>市場情資與競品分析平台 (V6 - 進階分析版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Tailwind CSS configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        techbg: '#181D27',
                        techpanel: '#22283A',
                        techaccent: '#2EE9E4',
                        techprimary: '#3762F0',
                        techsecondary: '#7D5FFF'
                    },
                    fontFamily: {
                        'tech': ['"Segoe UI"', 'Roboto', 'Arial', 'sans-serif']
                    }
                }
            }
        }

        // 全域狀態管理
        window.state = {
            isAuthenticated: false,
            apiConfigured: false,
            currentStep: 1,
            analysisData: {},
            settings: {
                googleApiKey: '',
                searchEngineId: '',
                centralFolderName: 'iStaging_專案管理',
                intelligenceSubfolder: '01_市場情資分析',
                mediaplanSubfolder: '02_媒體提案',
                workflowSubfolder: '03_工作流程文件'
            }
        };

        // 頁面載入完成後初始化
        window.addEventListener('load', function() {
            console.log('頁面載入完成，開始初始化...');
            
            // 使用 Promise 包裝初始化，避免未捕獲的錯誤
            initializeApp()
                .then(() => {
                    console.log('初始化完成');
                })
                .catch(error => {
                    console.error('初始化過程中發生錯誤:', error);
                    showAlert('初始化錯誤', '頁面初始化失敗，請重新整理頁面', 'error');
                });
        });

        // 全域錯誤處理
        window.addEventListener('error', function(event) {
            console.error('全域錯誤:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('未處理的 Promise 拒絕:', event.reason);
            event.preventDefault(); // 防止預設的錯誤處理
        });

        // 顯示警告訊息
        function showAlert(title, message, type = 'info') {
            try {
                const alertContainer = document.getElementById('alert-container');
                if (!alertContainer) return;

                const alertDiv = document.createElement('div');
                alertDiv.className = `p-4 mb-4 rounded-lg shadow-lg ${
                    type === 'error' ? 'bg-red-600 text-white' :
                    type === 'success' ? 'bg-green-600 text-white' :
                    type === 'warning' ? 'bg-yellow-600 text-white' :
                    'bg-blue-600 text-white'
                }`;
                
                alertDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold">${title}</h4>
                            <p class="text-sm mt-1">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;

                alertContainer.appendChild(alertDiv);

                // 自動移除警告
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 5000);
            } catch (error) {
                console.error('顯示警告失敗:', error);
            }
        }

        // 初始化應用程式
        function initializeApp() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('初始化應用程式...');
                    
                    // 載入設定
                    loadSettings();
                    
                    // 設定事件監聽器
                    setupEventListeners();
                    
                    // 檢查 URL 參數
                    checkUrlParameters();
                    
                    // 更新 UI 狀態
                    updateUIState();
                    
                    console.log('應用程式初始化完成');
                    resolve();
                } catch (error) {
                    console.error('應用程式初始化失敗:', error);
                    reject(error);
                }
            });
        }

        // 載入設定
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('intelligence_settings');
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    state.settings = { ...state.settings, ...parsed };
                    
                    // 更新表單欄位
                    const apiKeyInput = document.getElementById('google-api-key');
                    const searchEngineInput = document.getElementById('search-engine-id');
                    const centralFolderInput = document.getElementById('central-folder-name');
                    const intelligenceSubfolderInput = document.getElementById('intelligence-subfolder');
                    const mediaplanSubfolderInput = document.getElementById('mediaplan-subfolder');
                    const workflowSubfolderInput = document.getElementById('workflow-subfolder');
                    
                    if (apiKeyInput) apiKeyInput.value = state.settings.googleApiKey || '';
                    if (searchEngineInput) searchEngineInput.value = state.settings.searchEngineId || '';
                    if (centralFolderInput) centralFolderInput.value = state.settings.centralFolderName || '';
                    if (intelligenceSubfolderInput) intelligenceSubfolderInput.value = state.settings.intelligenceSubfolder || '';
                    if (mediaplanSubfolderInput) mediaplanSubfolderInput.value = state.settings.mediaplanSubfolder || '';
                    if (workflowSubfolderInput) workflowSubfolderInput.value = state.settings.workflowSubfolder || '';
                }
            } catch (error) {
                console.warn('載入設定失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 設定事件監聽器
        function setupEventListeners() {
            try {
                // 標籤頁切換
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(btn => {
                    if (btn) {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            const tab = this.dataset.tab;
                            switchTab(tab);
                        });
                    }
                });

                // 儲存設定按鈕
                const saveSettingsBtn = document.getElementById('save-settings-btn');
                if (saveSettingsBtn) {
                    saveSettingsBtn.addEventListener('click', saveSettings);
                }

                // Google 登入按鈕
                const authorizeBtn = document.getElementById('authorize_button');
                if (authorizeBtn) {
                    authorizeBtn.addEventListener('click', handleGoogleAuth);
                }

                // 登出按鈕
                const signoutBtn = document.getElementById('signout_button');
                if (signoutBtn) {
                    signoutBtn.addEventListener('click', handleSignOut);
                }

                // 步驟切換 - 修正事件監聽器
                const stepCircles = document.querySelectorAll('.step-circle');
                stepCircles.forEach((circle, index) => {
                    if (circle) {
                        circle.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const step = index + 1;
                            console.log(`點擊步驟 ${step}`);
                            goToStep(step);
                        });
                    }
                });

                // 設定步驟 1 的事件監聽器
                setupStep1EventListeners();

                console.log('事件監聽器設定完成');
            } catch (error) {
                console.error('設定事件監聽器失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 檢查 URL 參數
        function checkUrlParameters() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('projectId');
                
                if (projectId) {
                    const projectIdInput = document.getElementById('project-id');
                    if (projectIdInput) {
                        projectIdInput.value = projectId;
                    }
                }
            } catch (error) {
                console.warn('檢查 URL 參數失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 更新 UI 狀態
        function updateUIState() {
            try {
                const appContainer = document.getElementById('app-container');
                const analysisPanel = document.getElementById('analysis-panel');
                const historyPanel = document.getElementById('history-panel');
                const isConfigured = state.settings.googleApiKey && state.settings.searchEngineId;
                
                // 移除 app-container 的 locked class，改為只鎖定特定面板
                if (appContainer) {
                    appContainer.classList.remove('locked');
                }
                
                // 只有分析系統和歷史紀錄需要 API 設定
                if (analysisPanel) {
                    if (isConfigured) {
                        analysisPanel.classList.remove('locked');
                        state.apiConfigured = true;
                    } else {
                        analysisPanel.classList.add('locked');
                        state.apiConfigured = false;
                    }
                }
                
                if (historyPanel) {
                    if (isConfigured) {
                        historyPanel.classList.remove('locked');
                    } else {
                        historyPanel.classList.add('locked');
                    }
                }

                // 預設顯示 API 設定分頁
                switchTab('settings');
            } catch (error) {
                console.error('更新 UI 狀態失敗:', error);
            }
        }

        // 切換標籤頁
        function switchTab(tabName) {
            try {
                // 移除所有標籤頁的 active 狀態
                const tabButtons = document.querySelectorAll('.tab-btn');
                const panels = document.querySelectorAll('.panel');
                
                tabButtons.forEach(btn => btn.classList.remove('active'));
                panels.forEach(panel => panel.classList.remove('active'));
                
                // 啟用選中的標籤頁
                const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
                const activePanel = document.getElementById(`${tabName}-panel`);
                
                if (activeTab) activeTab.classList.add('active');
                if (activePanel) activePanel.classList.add('active');
                
                console.log(`切換到標籤頁: ${tabName}`);
            } catch (error) {
                console.error('切換標籤頁失敗:', error);
            }
        }

        // 儲存設定
        function saveSettings() {
            try {
                const apiKey = document.getElementById('google-api-key')?.value || '';
                const searchEngineId = document.getElementById('search-engine-id')?.value || '';
                const centralFolderName = document.getElementById('central-folder-name')?.value || '';
                const intelligenceSubfolder = document.getElementById('intelligence-subfolder')?.value || '';
                const mediaplanSubfolder = document.getElementById('mediaplan-subfolder')?.value || '';
                const workflowSubfolder = document.getElementById('workflow-subfolder')?.value || '';

                // 更新狀態
                state.settings = {
                    googleApiKey: apiKey,
                    searchEngineId: searchEngineId,
                    centralFolderName: centralFolderName,
                    intelligenceSubfolder: intelligenceSubfolder,
                    mediaplanSubfolder: mediaplanSubfolder,
                    workflowSubfolder: workflowSubfolder
                };

                // 儲存到 localStorage
                localStorage.setItem('intelligence_settings', JSON.stringify(state.settings));

                // 更新 UI 狀態
                updateUIState();

                showAlert('設定已儲存', 'API 設定已成功儲存', 'success');
                
                // 如果 API 已設定，切換到分析系統
                if (apiKey && searchEngineId) {
                    setTimeout(() => {
                        switchTab('analysis');
                    }, 1000);
                }
            } catch (error) {
                console.error('儲存設定失敗:', error);
                showAlert('儲存失敗', error.message, 'error');
            }
        }

        // 步驟切換功能
        function goToStep(step) {
            try {
                console.log(`切換到步驟 ${step}`);
                
                // 隱藏所有步驟面板
                const stepPanels = document.querySelectorAll('.step-panel');
                stepPanels.forEach(panel => {
                    panel.style.display = 'none';
                });
                
                // 移除所有步驟的 active 狀態
                const steps = document.querySelectorAll('.step');
                steps.forEach(s => {
                    s.classList.remove('active', 'completed');
                });
                
                // 顯示目標步驟
                const targetPanel = document.getElementById(`step-${step}-content`);
                if (targetPanel) {
                    targetPanel.style.display = 'block';
                }
                
                // 更新步驟狀態
                for (let i = 1; i <= step; i++) {
                    const stepElement = document.getElementById(`step-${i}`);
                    if (stepElement) {
                        if (i === step) {
                            stepElement.classList.add('active');
                        } else {
                            stepElement.classList.add('completed');
                        }
                    }
                }
                
                // 如果是步驟 2，執行額外的初始化
                if (step === 2) {
                    onStep2Load();
                }
                
                // 如果是步驟 3，顯示完整報告
                if (step === 3) {
                    displayFinalReport();
                }
                
            } catch (error) {
                console.error('切換步驟失敗:', error);
            }
        }

        // 開始分析
        function startAnalysis() {
            try {
                // 收集所有資料
                const brandName = document.getElementById('brand-name')?.value?.trim();
                const brandWebsite = document.getElementById('brand-website')?.value?.trim();
                const brandDescription = document.getElementById('brand-description')?.value?.trim();
                const industryCategory = document.getElementById('industry-category')?.value;
                const marketSize = document.getElementById('market-size')?.value;
                const topic = document.getElementById('analysis-topic')?.value?.trim();
                const projectId = document.getElementById('project-id')?.value?.trim();
                const competitorCount = document.getElementById('competitor-count')?.value;
                const analysisDepth = document.querySelector('input[name="analysis-depth"]:checked')?.value;

                // 驗證必填欄位
                if (!brandName) {
                    showAlert('請填寫品牌名稱', '品牌名稱為必填項目', 'warning');
                    return;
                }

                if (!industryCategory) {
                    showAlert('請選擇行業類別', '行業類別為必填項目', 'warning');
                    return;
                }

                if (!topic) {
                    showAlert('請填寫分析主題', '分析主題為必填項目', 'warning');
                    return;
                }

                // 收集產品和關鍵字資料
                const products = collectProductsData();
                const keywords = collectKeywordsData();

                // 儲存分析設定
                state.analysisData = {
                    brand: {
                        name: brandName,
                        website: brandWebsite,
                        description: brandDescription
                    },
                    products: products,
                    industry: {
                        category: industryCategory,
                        marketSize: marketSize
                    },
                    topic: topic,
                    projectId: projectId || `TEMP_${Date.now()}`,
                    competitorCount: parseInt(competitorCount),
                    analysisDepth: analysisDepth,
                    keywords: keywords,
                    timestamp: new Date().toISOString()
                };

                showAlert('分析設定已儲存', '正在準備競爭對手分析...', 'success');
                
                // 切換到步驟 2
                setTimeout(() => {
                    goToStep(2);
                }, 1000);

            } catch (error) {
                console.error('開始分析失敗:', error);
                showAlert('分析失敗', error.message, 'error');
            }
        }

        // 收集產品資料
        function collectProductsData() {
            try {
                const products = [];
                const productItems = document.querySelectorAll('.product-item');
                
                productItems.forEach(item => {
                    const name = item.querySelector('.product-name')?.value?.trim();
                    const pricing = item.querySelector('.product-pricing')?.value;
                    const target = item.querySelector('.product-target')?.value?.trim();
                    
                    if (name) {
                        products.push({
                            name: name,
                            pricing: pricing,
                            target: target
                        });
                    }
                });
                
                return products;
            } catch (error) {
                console.error('收集產品資料失敗:', error);
                return [];
            }
        }

        // 收集關鍵字資料
        function collectKeywordsData() {
            const primaryKeywords = document.getElementById('primary-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
            const longTailKeywords = document.getElementById('long-tail-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
            const businessModel = document.getElementById('business-model-select')?.value || '';
            
            return {
                primary: primaryKeywords,
                longTail: longTailKeywords,
                marketPositioning: {
                    businessModel: businessModel,
                    targetMarket: 'tw', // 預設台灣
                    targetAudience: 'general',
                    primaryLanguage: 'zh-TW',
                    localizationLevel: 'high'
                },
                depth: 'comprehensive'
            };
        }

        // Google 認證處理 - 簡化版本
        function handleGoogleAuth() {
            try {
                // 檢查是否已載入 Google API
                if (typeof gapi === 'undefined') {
                    showAlert('Google API 未載入', '請檢查網路連線並重新整理頁面', 'error');
                    return;
                }

                // 檢查 Google Client ID 是否已設定
                const clientId = '733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com';
                
                // 初始化 Google API
                gapi.load('auth2', function() {
                    gapi.auth2.init({
                        client_id: clientId,
                        scope: 'profile email' // 只要求基本權限
                    }).then(function(auth2) {
                        // 登入
                        auth2.signIn().then(function(googleUser) {
                            const profile = googleUser.getBasicProfile();
                            state.isAuthenticated = true;
                            state.userProfile = {
                                id: profile.getId(),
                                name: profile.getName(),
                                email: profile.getEmail(),
                                imageUrl: profile.getImageUrl()
                            };
                            
                            updateAuthUI();
                            showAlert('登入成功', `歡迎 ${profile.getName()}`, 'success');
                            
                            // 解鎖應用程式
                            unlockApp();
                        }).catch(function(error) {
                            console.error('Google 登入失敗:', error);
                            showAlert('登入失敗', 'Google 登入失敗，請重試', 'error');
                        });
                    }).catch(function(error) {
                        console.error('Google API 初始化失敗:', error);
                        showAlert('初始化失敗', 'Google API 初始化失敗，請檢查網路連線', 'error');
                    });
                });
            } catch (error) {
                console.error('Google 認證失敗:', error);
                showAlert('認證失敗', error.message, 'error');
            }
        }

        // 解鎖應用程式
        function unlockApp() {
            try {
                const appContainer = document.getElementById('app-container');
                if (appContainer) {
                    appContainer.classList.remove('locked');
                }
            } catch (error) {
                console.error('解鎖應用程式失敗:', error);
            }
        }

        // 登出處理
        function handleSignOut() {
            try {
                if (typeof gapi !== 'undefined' && gapi.auth2) {
                    const auth2 = gapi.auth2.getAuthInstance();
                    auth2.signOut().then(function() {
                        state.isAuthenticated = false;
                        state.userProfile = null;
                        updateAuthUI();
                        showAlert('已登出', '您已成功登出 Google 帳戶', 'info');
                    });
                } else {
                    state.isAuthenticated = false;
                    state.userProfile = null;
                    updateAuthUI();
                    showAlert('已登出', '您已成功登出', 'info');
                }
            } catch (error) {
                console.error('登出失敗:', error);
                showAlert('登出失敗', '登出過程中發生錯誤', 'error');
            }
        }

        // 更新認證 UI
        function updateAuthUI() {
            try {
                const userProfile = document.getElementById('user-profile');
                const authorizeBtn = document.getElementById('authorize_button');
                const signoutBtn = document.getElementById('signout_button');
                const userAvatar = document.getElementById('user-avatar');
                const userName = document.getElementById('user-name');

                if (state.isAuthenticated && state.userProfile) {
                    // 顯示用戶資訊
                    if (userProfile) userProfile.classList.remove('hidden');
                    if (authorizeBtn) authorizeBtn.classList.add('hidden');
                    if (signoutBtn) signoutBtn.classList.remove('hidden');
                    
                    if (userAvatar && state.userProfile.imageUrl) {
                        userAvatar.src = state.userProfile.imageUrl;
                    }
                    if (userName) {
                        userName.textContent = state.userProfile.name;
                    }
                } else {
                    // 顯示登入按鈕
                    if (userProfile) userProfile.classList.add('hidden');
                    if (authorizeBtn) authorizeBtn.classList.remove('hidden');
                    if (signoutBtn) signoutBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error('更新認證 UI 失敗:', error);
            }
        }

        // 初始化 Google Drive API
        function initializeGoogleDrive() {
            try {
                if (!state.isAuthenticated) {
                    console.warn('用戶未登入，無法初始化 Google Drive API');
                    return;
                }

                // 載入 Google Drive API
                gapi.load('client', function() {
                    gapi.client.init({
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    }).then(function() {
                        console.log('Google Drive API 初始化成功');
                        showAlert('Google Drive 已準備就緒', '可以開始使用檔案儲存功能', 'success');
                    }).catch(function(error) {
                        console.error('Google Drive API 初始化失敗:', error);
                        showAlert('Google Drive 初始化失敗', '請檢查網路連線', 'error');
                    });
                });
            } catch (error) {
                console.error('初始化 Google Drive 失敗:', error);
                showAlert('Google Drive 初始化失敗', error.message, 'error');
            }
        }

        // 儲存檔案到 Google Drive
        function saveFileToGoogleDrive(fileName, content, mimeType = 'text/plain') {
            return new Promise((resolve, reject) => {
                try {
                    if (!state.isAuthenticated) {
                        reject(new Error('用戶未登入'));
                        return;
                    }

                    // 檢查是否已初始化 Google Drive API
                    if (!gapi.client.drive) {
                        reject(new Error('Google Drive API 未初始化'));
                        return;
                    }

                    // 建立檔案中繼資料
                    const fileMetadata = {
                        name: fileName,
                        mimeType: mimeType,
                        parents: [] // 可以指定資料夾 ID
                    };

                    // 建立檔案內容
                    const fileContent = content;

                    // 上傳檔案
                    gapi.client.drive.files.create({
                        resource: fileMetadata,
                        media: {
                            mimeType: mimeType,
                            body: fileContent
                        }
                    }).then(function(response) {
                        console.log('檔案上傳成功:', response.result);
                        resolve(response.result);
                    }).catch(function(error) {
                        console.error('檔案上傳失敗:', error);
                        reject(error);
                    });
                } catch (error) {
                    console.error('儲存檔案到 Google Drive 失敗:', error);
                    reject(error);
                }
            });
        }

        // 更新儲存到 Google Drive 函數
        function saveToGoogleDrive() {
            try {
                if (!state.isAuthenticated) {
                    showAlert('需要登入', '請先登入 Google 帳戶才能儲存到 Drive', 'warning');
                    return;
                }

                showAlert('儲存中', '正在將報告儲存到 Google Drive...', 'info');
                
                // 這裡應該實作 Google Drive API 儲存功能
                // 目前只是模擬
                setTimeout(() => {
                    showAlert('儲存成功', '報告已儲存到 Google Drive', 'success');
                }, 2000);

            } catch (error) {
                console.error('儲存到 Google Drive 失敗:', error);
                showAlert('儲存失敗', '無法儲存到 Google Drive', 'error');
            }
        }

        // 下載關鍵字清單
        function downloadKeywords(type) {
            try {
                const keywords = collectKeywordsData();
                let content = '';
                let filename = '';

                switch (type) {
                    case 'primary':
                        content = generateKeywordFileContent(keywords.primary, '主要關鍵字', keywords.marketPositioning);
                        filename = `主要關鍵字清單_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    case 'longtail':
                        content = generateKeywordFileContent(keywords.longTail, '長尾關鍵字', keywords.marketPositioning);
                        filename = `長尾關鍵字清單_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    case 'all':
                        content = generateCompleteKeywordFileContent(keywords);
                        filename = `完整關鍵字清單_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    default:
                        showAlert('下載失敗', '無效的下載類型', 'error');
                        return;
                }

                downloadFile(content, filename);
                showAlert('下載成功', `${filename} 已下載到您的裝置`, 'success');

            } catch (error) {
                console.error('下載關鍵字失敗:', error);
                showAlert('下載失敗', '無法下載關鍵字清單', 'error');
            }
        }

        // 生成關鍵字檔案內容
        function generateKeywordFileContent(keywords, type, marketPositioning) {
            const marketInfo = getMarketInfo(marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(marketPositioning.primaryLanguage);

            return `關鍵字清單 - ${type}
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 市場定位資訊 ===
目標市場: ${marketInfo.name} (${marketInfo.code})
商業模式: ${businessModelInfo.name}
目標客群: ${getTargetAudienceInfo(marketPositioning.targetAudience)}
主要語言: ${languageInfo.name}
本地化程度: ${getLocalizationInfo(marketPositioning.localizationLevel)}

=== ${type}清單 ===
${keywords.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== SEO 建議 ===
${generateSEORecommendations(keywords, marketPositioning)}

=== 關鍵字購買建議 ===
${generateKeywordPurchaseRecommendations(keywords, marketPositioning)}

---
由 iStaging 市場情資與競品分析平台生成
`;
        }

        // 生成完整關鍵字檔案內容
        function generateCompleteKeywordFileContent(keywords) {
            const marketInfo = getMarketInfo(keywords.marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(keywords.marketPositioning.primaryLanguage);

            return `完整關鍵字分析報告
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 市場定位分析 ===
目標市場: ${marketInfo.name} (${marketInfo.code})
商業模式: ${businessModelInfo.name}
目標客群: ${getTargetAudienceInfo(keywords.marketPositioning.targetAudience)}
主要語言: ${languageInfo.name}
本地化程度: ${getLocalizationInfo(keywords.marketPositioning.localizationLevel)}

=== 主要關鍵字 (${keywords.primary.length} 個) ===
${keywords.primary.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== 長尾關鍵字 (${keywords.longTail.length} 個) ===
${keywords.longTail.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== 關鍵字策略分析 ===
分析深度: ${getKeywordDepthInfo(keywords.depth)}

=== SEO 策略建議 ===
${generateComprehensiveSEORecommendations(keywords)}

=== 關鍵字購買策略 ===
${generateComprehensiveKeywordPurchaseStrategy(keywords)}

=== 內容策略建議 ===
${generateContentStrategyRecommendations(keywords)}

---
由 iStaging 市場情資與競品分析平台生成
`;
        }

        // 生成關鍵字分析報告
        function generateKeywordReport() {
            try {
                const keywords = collectKeywordsData();
                
                if (keywords.primary.length === 0 && keywords.longTail.length === 0) {
                    showAlert('沒有關鍵字', '請先輸入關鍵字再生成報告', 'warning');
                    return;
                }

                showAlert('生成中', '正在生成關鍵字分析報告...', 'info');

                const report = generateKeywordAnalysisReport(keywords);
                const filename = `關鍵字分析報告_${new Date().toISOString().split('T')[0]}.txt`;
                
                downloadFile(report, filename);
                showAlert('報告生成成功', `${filename} 已下載到您的裝置`, 'success');

            } catch (error) {
                console.error('生成關鍵字報告失敗:', error);
                showAlert('報告生成失敗', '無法生成關鍵字分析報告', 'error');
            }
        }

        // 生成關鍵字分析報告內容
        function generateKeywordAnalysisReport(keywords) {
            const marketInfo = getMarketInfo(keywords.marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(keywords.marketPositioning.primaryLanguage);

            return `關鍵字分析報告
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 市場背景分析 ===
目標市場: ${marketInfo.name}
市場特點: ${marketInfo.characteristics}
競爭環境: ${marketInfo.competition}
搜尋行為: ${marketInfo.searchBehavior}

商業模式: ${businessModelInfo.name}
模式特點: ${businessModelInfo.characteristics}
關鍵字策略: ${businessModelInfo.keywordStrategy}

目標客群: ${getTargetAudienceInfo(keywords.marketPositioning.targetAudience)}
語言環境: ${languageInfo.name}
本地化需求: ${getLocalizationInfo(keywords.marketPositioning.localizationLevel)}

=== 關鍵字分析 ===
主要關鍵字數量: ${keywords.primary.length}
長尾關鍵字數量: ${keywords.longTail.length}
分析深度: ${getKeywordDepthInfo(keywords.depth)}

=== 關鍵字分類與建議 ===
${generateKeywordCategorization(keywords)}

=== 競爭分析 ===
${generateKeywordCompetitionAnalysis(keywords)}

=== 投資報酬率預測 ===
${generateROIPrediction(keywords)}

=== 執行建議 ===
${generateExecutionRecommendations(keywords)}

---
由 iStaging 市場情資與競品分析平台生成
`;
        }

        // 輔助函數：獲取市場資訊
        function getMarketInfo(marketCode) {
            const markets = {
                'tw': { name: '台灣', code: 'TW', characteristics: '數位化程度高，行動裝置普及率高', competition: '競爭激烈，本地化需求強', searchBehavior: '偏好繁體中文，重視本地化內容' },
                'hk': { name: '香港', code: 'HK', characteristics: '國際化程度高，消費能力強', competition: '國際品牌競爭激烈', searchBehavior: '中英文並用，重視品質' },
                'sg': { name: '新加坡', code: 'SG', characteristics: '多語言環境，科技發達', competition: '國際化競爭，品質要求高', searchBehavior: '多語言搜尋，重視效率' },
                'my': { name: '馬來西亞', code: 'MY', characteristics: '多元文化，成長潛力大', competition: '中等競爭，本地化機會多', searchBehavior: '多語言，價格敏感' },
                'th': { name: '泰國', code: 'TH', characteristics: '數位化快速發展', competition: '本地品牌優勢明顯', searchBehavior: '泰語為主，視覺內容重要' },
                'vn': { name: '越南', code: 'VN', characteristics: '年輕人口多，成長快速', competition: '新興市場，機會多', searchBehavior: '越南語，行動優先' },
                'id': { name: '印尼', code: 'ID', characteristics: '人口眾多，市場潛力大', competition: '本地化需求強', searchBehavior: '印尼語，社群媒體重要' },
                'ph': { name: '菲律賓', code: 'PH', characteristics: '英語普及，國際化程度高', competition: '國際品牌競爭', searchBehavior: '英語和菲律賓語並用' },
                'jp': { name: '日本', code: 'JP', characteristics: '品質要求極高，技術先進', competition: '競爭激烈，品質至上', searchBehavior: '日語，重視細節' },
                'kr': { name: '韓國', code: 'KR', characteristics: '科技發達，創新導向', competition: '技術競爭激烈', searchBehavior: '韓語，重視創新' },
                'cn': { name: '中國大陸', code: 'CN', characteristics: '市場規模巨大，競爭激烈', competition: '極度競爭，本地化重要', searchBehavior: '簡體中文，平台生態重要' },
                'us': { name: '美國', code: 'US', characteristics: '成熟市場，創新導向', competition: '高度競爭，創新重要', searchBehavior: '英語，重視便利性' },
                'ca': { name: '加拿大', code: 'CA', characteristics: '多元文化，品質要求高', competition: '國際競爭，品質重要', searchBehavior: '英語和法語，重視品質' },
                'au': { name: '澳洲', code: 'AU', characteristics: '高消費能力，品質導向', competition: '國際競爭，品質重要', searchBehavior: '英語，重視品質和服務' },
                'uk': { name: '英國', code: 'UK', characteristics: '成熟市場，創新導向', competition: '高度競爭，創新重要', searchBehavior: '英語，重視品牌' },
                'de': { name: '德國', code: 'DE', characteristics: '技術導向，品質要求高', competition: '技術競爭激烈', searchBehavior: '德語，重視技術和品質' },
                'fr': { name: '法國', code: 'FR', characteristics: '文化導向，品質要求高', competition: '文化競爭，品質重要', searchBehavior: '法語，重視文化和品質' },
                'global': { name: '全球市場', code: 'Global', characteristics: '多元化，本地化需求強', competition: '國際競爭，本地化重要', searchBehavior: '多語言，文化適應重要' }
            };
            return markets[marketCode] || { name: '未指定', code: 'Unknown', characteristics: '未知', competition: '未知', searchBehavior: '未知' };
        }

        // 輔助函數：獲取商業模式資訊
        function getBusinessModelInfo(modelCode) {
            const models = {
                'b2b': { name: 'B2B (企業對企業)', characteristics: '專業性強，決策週期長', keywordStrategy: '專業術語，解決方案導向' },
                'b2c': { name: 'B2C (企業對消費者)', characteristics: '用戶體驗重要，決策快速', keywordStrategy: '用戶友好，情感訴求' },
                'b2b2c': { name: 'B2B2C (企業對企業對消費者)', characteristics: '複雜價值鏈，多方利益', keywordStrategy: '平台價值，生態系統' },
                'c2c': { name: 'C2C (消費者對消費者)', characteristics: '社群驅動，信任重要', keywordStrategy: '社群關鍵字，信任建立' },
                'saas': { name: 'SaaS (軟體即服務)', characteristics: '訂閱模式，持續價值', keywordStrategy: '解決方案，ROI導向' },
                'marketplace': { name: 'Marketplace (平台模式)', characteristics: '網路效應，規模重要', keywordStrategy: '平台價值，選擇多樣' },
                'subscription': { name: 'Subscription (訂閱模式)', characteristics: '持續收入，用戶留存', keywordStrategy: '價值持續，便利性' },
                'freemium': { name: 'Freemium (免費增值)', characteristics: '用戶獲取，轉換重要', keywordStrategy: '免費價值，升級誘因' },
                'ecommerce': { name: 'E-commerce (電商)', characteristics: '轉換率重要，用戶體驗', keywordStrategy: '產品關鍵字，購買意圖' },
                'agency': { name: 'Agency (代理/服務)', characteristics: '專業服務，信任建立', keywordStrategy: '專業能力，服務品質' }
            };
            return models[modelCode] || { name: '未指定', characteristics: '未知', keywordStrategy: '未知' };
        }

        // 輔助函數：獲取語言資訊
        function getLanguageInfo(langCode) {
            const languages = {
                'zh-tw': { name: '繁體中文 (台灣)', characteristics: '本地化需求強，文化適應重要' },
                'zh-hk': { name: '繁體中文 (香港)', characteristics: '國際化程度高，中英文並用' },
                'zh-cn': { name: '簡體中文 (中國)', characteristics: '市場規模大，平台生態重要' },
                'en': { name: 'English (英語)', characteristics: '國際通用，競爭激烈' },
                'ja': { name: '日本語 (日語)', characteristics: '品質要求高，細節重要' },
                'ko': { name: '한국어 (韓語)', characteristics: '創新導向，技術重視' },
                'th': { name: 'ไทย (泰語)', characteristics: '本地化重要，文化適應' },
                'vi': { name: 'Tiếng Việt (越南語)', characteristics: '成長市場，本地化機會' },
                'id': { name: 'Bahasa Indonesia (印尼語)', characteristics: '人口眾多，市場潛力大' },
                'ms': { name: 'Bahasa Melayu (馬來語)', characteristics: '多元文化，本地化需求' }
            };
            return languages[langCode] || { name: '未指定', characteristics: '未知' };
        }

        // 輔助函數：獲取目標客群資訊
        function getTargetAudienceInfo(audienceCode) {
            const audiences = {
                'startup': '新創公司 - 成本敏感，快速決策',
                'sme': '中小企業 - 實用導向，性價比重要',
                'enterprise': '大型企業 - 品質要求高，決策週期長',
                'freelancer': '自由工作者 - 靈活性重要，成本控制',
                'student': '學生 - 價格敏感，功能需求',
                'professional': '專業人士 - 品質要求高，效率重要',
                'consumer': '一般消費者 - 用戶體驗，情感訴求',
                'elderly': '銀髮族 - 易用性，信任建立',
                'youth': '年輕族群 - 創新，社交分享',
                'parent': '家長 - 安全，品質，教育價值'
            };
            return audiences[audienceCode] || '未指定';
        }

        // 輔助函數：獲取本地化資訊
        function getLocalizationInfo(levelCode) {
            const levels = {
                'basic': '基礎本地化 (翻譯) - 基本語言適應',
                'standard': '標準本地化 (翻譯+文化適應) - 文化內容調整',
                'advanced': '深度本地化 (完全在地化) - 完全文化適應',
                'native': '原生本地化 (在地團隊開發) - 原生文化體驗'
            };
            return levels[levelCode] || '未指定';
        }

        // 輔助函數：獲取關鍵字深度資訊
        function getKeywordDepthInfo(depthCode) {
            const depths = {
                'basic': '基礎分析 (搜尋量、競爭度)',
                'standard': '標準分析 (搜尋量、競爭度、出價建議)',
                'comprehensive': '深度分析 (搜尋量、競爭度、出價建議、內容策略)'
            };
            return depths[depthCode] || '未指定';
        }

        // 通用下載檔案函數
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 生成 SEO 建議
        function generateSEORecommendations(keywords, marketPositioning) {
            return `1. 針對 ${getMarketInfo(marketPositioning.targetMarket).name} 市場優化
2. 使用 ${getLanguageInfo(marketPositioning.primaryLanguage).name} 進行內容創作
3. 考慮 ${getBusinessModelInfo(marketPositioning.businessModel).keywordStrategy}
4. 建立長尾關鍵字內容策略
5. 優化本地化內容和用戶體驗`;
        }

        // 生成關鍵字購買建議
        function generateKeywordPurchaseRecommendations(keywords, marketPositioning) {
            return `1. 主要關鍵字：高競爭度，建議 CPC 預算分配 60%
2. 長尾關鍵字：中等競爭度，建議 CPC 預算分配 40%
3. 根據 ${getMarketInfo(marketPositioning.targetMarket).name} 市場調整出價
4. 考慮 ${getBusinessModelInfo(marketPositioning.businessModel).name} 的轉換週期
5. 定期監控和調整關鍵字表現`;
        }

        // 生成綜合 SEO 建議
        function generateComprehensiveSEORecommendations(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `基於 ${businessModel.name} 商業模式的 SEO 策略建議：

1. 技術 SEO 優化
   - 網站速度優化 (目標載入時間 < 3秒)
   - 行動裝置友善設計 (Mobile-first)
   - 結構化資料標記 (Schema.org)
   - 網站地圖優化 (XML Sitemap)
   - 內部連結結構優化

2. 內容 SEO 策略
   - 主要關鍵字：${keywords.primary.slice(0, 3).join(', ')}
   - 長尾關鍵字：${keywords.longTail.slice(0, 5).join(', ')}
   - 內容深度：每篇文章至少 1500 字
   - 更新頻率：每週 2-3 篇新內容
   - 內容類型：部落格文章、案例研究、白皮書

3. 頁面 SEO 優化
   - 標題標籤 (Title Tag) 包含主要關鍵字
   - Meta 描述優化 (150-160 字元)
   - H1-H6 標籤層級結構
   - 圖片 Alt 標籤優化
   - URL 結構優化

4. 外部 SEO 策略
   - 高品質反向連結建立
   - 行業相關網站合作
   - 社群媒體內容分享
   - 影響者行銷合作
   - 客座文章發布

5. 本地 SEO (適用於實體業務)
   - Google My Business 優化
   - 本地關鍵字優化
   - 客戶評價管理
   - 本地目錄提交
   - 本地內容策略`;
        }

        // 生成綜合關鍵字購買策略
        function generateComprehensiveKeywordPurchaseStrategy(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `基於 ${businessModel.name} 的關鍵字購買策略：

1. 主要關鍵字策略 (${keywords.primary.length} 個)
   - 預算分配：總預算的 40%
   - 出價策略：競爭性出價，爭取前三名
   - 匹配類型：廣泛匹配 + 否定關鍵字
   - 目標：品牌知名度、流量建立

2. 長尾關鍵字策略 (${keywords.longTail.length} 個)
   - 預算分配：總預算的 35%
   - 出價策略：精準出價，控制成本
   - 匹配類型：詞組匹配 + 完全匹配
   - 目標：轉換率提升、ROI 優化

3. 商業意圖關鍵字
   - 預算分配：總預算的 15%
   - 出價策略：高競爭出價
   - 匹配類型：完全匹配為主
   - 目標：直接轉換、銷售線索

4. 資訊型關鍵字
   - 預算分配：總預算的 10%
   - 出價策略：中等出價
   - 匹配類型：廣泛匹配
   - 目標：內容行銷、教育客戶

5. 出價建議
   - 主要關鍵字：$$$ (高競爭)
   - 長尾關鍵字：$$ (中等競爭)
   - 商業意圖：$$$ (高價值)
   - 資訊型：$ (低競爭)

6. 預算分配建議
   - 每日預算：根據市場競爭度調整
   - 週期性調整：每週檢視一次
   - 季節性調整：重要節日增加預算
   - A/B 測試：持續優化出價策略`;
        }

        // 生成內容策略建議
        function generateContentStrategyRecommendations(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `基於 ${businessModel.name} 的內容策略建議：

1. 內容類型規劃
   - 教育型內容：${keywords.primary.slice(0, 2).join(', ')} 相關指南
   - 案例研究：客戶成功故事、ROI 展示
   - 行業洞察：趨勢分析、市場報告
   - 產品展示：功能介紹、使用教學
   - 客戶服務：FAQ、故障排除

2. 內容主題建議
   - 主要關鍵字主題：${keywords.primary.map(k => `"${k} 完整指南"`).join(', ')}
   - 長尾關鍵字主題：${keywords.longTail.slice(0, 3).map(k => `"${k} 最佳實踐"`).join(', ')}
   - 商業模式主題：${businessModel.focus} 相關內容
   - 客戶痛點主題：解決方案、最佳實踐

3. 內容發布策略
   - 發布頻率：每週 2-3 篇
   - 最佳時間：週二至週四 9:00-11:00
   - 內容長度：1500-3000 字
   - 多媒體內容：影片、資訊圖表、播客

4. 內容推廣策略
   - 社群媒體：LinkedIn、Facebook、Twitter
   - 電子郵件行銷：訂閱者分享
   - 影響者合作：行業專家背書
   - 付費推廣：Facebook Ads、LinkedIn Ads

5. 內容優化建議
   - SEO 優化：關鍵字密度 1-2%
   - 可讀性：Flesch Reading Ease > 60
   - 視覺元素：圖片、影片、圖表
   - 行動優化：響應式設計
   - 互動元素：評論、分享按鈕`;
        }

        // 生成關鍵字分類
        function generateKeywordCategorization(keywords) {
            return `主要關鍵字分類：
- 品牌關鍵字：建立品牌知名度
- 產品關鍵字：直接轉換導向
- 解決方案關鍵字：問題解決導向

長尾關鍵字分類：
- 問題解決型：回答具體問題
- 比較型：產品比較和選擇
- 教程型：教學和指南內容`;
        }

        // 生成競爭分析
        function generateKeywordCompetitionAnalysis(keywords) {
            return `競爭分析：
- 主要關鍵字競爭度：高，需要持續優化
- 長尾關鍵字競爭度：中等，機會較多
- 建議：專注於長尾關鍵字建立優勢
- 監控競爭對手關鍵字策略`;
        }

        // 生成 ROI 預測
        function generateROIPrediction(keywords) {
            return `ROI 預測：
- 短期 (1-3個月)：建立關鍵字排名基礎
- 中期 (3-6個月)：開始看到有機流量增長
- 長期 (6-12個月)：實現穩定的轉換和收入
- 建議：持續投資內容和技術優化`;
        }

        // 生成執行建議
        function generateExecutionRecommendations(keywords) {
            return `執行建議：
1. 立即行動：開始建立關鍵字內容
2. 短期目標：優化主要關鍵字排名
3. 中期目標：建立長尾關鍵字優勢
4. 長期目標：建立品牌權威性
5. 持續優化：定期監控和調整策略`;
        }

        // 搜尋競爭對手
        function searchCompetitors() {
            try {
                if (!state.analysisData.topic || !state.analysisData.brand) {
                    console.warn('沒有分析主題或品牌資訊，無法搜尋競爭對手');
                    return;
                }

                // 基於行業類別和品牌資訊生成更精確的競爭對手
                const industryCategory = state.analysisData.industry.category;
                const brandName = state.analysisData.brand.name;
                const topic = state.analysisData.topic;

                // 根據不同行業生成相關競爭對手
                let mockCompetitors = [];
                
                switch (industryCategory) {
                    case 'ecommerce':
                        mockCompetitors = [
                            { 
                                name: '蝦皮購物 (Shopee)', 
                                description: '東南亞最大電商平台，C2C 和 B2C 模式，母公司為 Sea Group', 
                                website: 'https://shopee.tw', 
                                linkedin: 'https://linkedin.com/company/shopee',
                                founded: '2015',
                                employees: '10,000+',
                                revenue: '數十億美元',
                                marketShare: '東南亞電商領導者',
                                strengths: '行動優先、社交電商、東南亞市場優勢',
                                weaknesses: '獲利能力待改善、競爭激烈'
                            },
                            { 
                                name: 'PChome 網路家庭', 
                                description: '台灣老牌電商平台，3C 產品起家，台灣電商先驅', 
                                website: 'https://pchome.com.tw', 
                                linkedin: 'https://linkedin.com/company/pchome',
                                founded: '1998',
                                employees: '1,000+',
                                revenue: '數百億台幣',
                                marketShare: '台灣電商前三名',
                                strengths: '3C 產品優勢、物流體系完整、品牌知名度高',
                                weaknesses: '轉型速度較慢、行動化不足'
                            },
                            { 
                                name: 'momo 富邦媒體', 
                                description: '台灣電商龍頭，電視購物轉型成功，富邦集團旗下', 
                                website: 'https://momoshop.com.tw', 
                                linkedin: 'https://linkedin.com/company/momo',
                                founded: '2004',
                                employees: '2,000+',
                                revenue: '千億台幣',
                                marketShare: '台灣電商第一名',
                                strengths: '電視購物基礎、物流配送快速、商品種類豐富',
                                weaknesses: '電視購物形象包袱、獲利模式單一'
                            },
                            { 
                                name: 'Yahoo 奇摩購物', 
                                description: '入口網站電商，搜尋流量優勢，Verizon Media 旗下', 
                                website: 'https://tw.buy.yahoo.com', 
                                linkedin: 'https://linkedin.com/company/yahoo',
                                founded: '1994',
                                employees: '全球 10,000+',
                                revenue: '數十億美元',
                                marketShare: '台灣電商前五名',
                                strengths: '搜尋流量優勢、入口網站整合、品牌信任度高',
                                weaknesses: '母公司策略變動、創新速度較慢'
                            },
                            { 
                                name: '露天拍賣', 
                                description: 'PChome 旗下 C2C 平台，台灣最大拍賣網站', 
                                website: 'https://www.ruten.com.tw', 
                                linkedin: 'https://linkedin.com/company/ruten',
                                founded: '2006',
                                employees: '500+',
                                revenue: '數十億台幣',
                                marketShare: '台灣 C2C 領導者',
                                strengths: 'C2C 平台優勢、PChome 資源整合、用戶基礎龐大',
                                weaknesses: '假貨問題、平台管理挑戰'
                            }
                        ];
                        break;
                    case 'saas':
                        mockCompetitors = [
                            { 
                                name: 'Microsoft 365', 
                                description: '企業辦公軟體套件，雲端協作，微軟核心產品', 
                                website: 'https://microsoft.com', 
                                linkedin: 'https://linkedin.com/company/microsoft',
                                founded: '1975',
                                employees: '200,000+',
                                revenue: '數千億美元',
                                marketShare: '企業軟體領導者',
                                strengths: '企業客戶基礎龐大、產品整合度高、品牌信任度極高',
                                weaknesses: '創新速度較慢、價格較高'
                            },
                            { 
                                name: 'Google Workspace', 
                                description: 'Google 企業服務，Gmail 生態系，雲端原生', 
                                website: 'https://workspace.google.com', 
                                linkedin: 'https://linkedin.com/company/google',
                                founded: '1998',
                                employees: '150,000+',
                                revenue: '數千億美元',
                                marketShare: '雲端辦公領導者',
                                strengths: '雲端原生、AI 整合、免費版本優勢',
                                weaknesses: '企業功能相對不足、隱私疑慮'
                            },
                            { 
                                name: 'Slack Technologies', 
                                description: '團隊溝通協作平台，企業即時通訊領導者', 
                                website: 'https://slack.com', 
                                linkedin: 'https://linkedin.com/company/slack',
                                founded: '2009',
                                employees: '2,000+',
                                revenue: '數億美元',
                                marketShare: '企業通訊領導者',
                                strengths: '用戶體驗優秀、整合能力強、企業採用率高',
                                weaknesses: '獲利能力待改善、競爭激烈'
                            },
                            { 
                                name: 'Notion Labs', 
                                description: '全能筆記和協作平台，知識管理工具', 
                                website: 'https://notion.so', 
                                linkedin: 'https://linkedin.com/company/notion',
                                founded: '2016',
                                employees: '500+',
                                revenue: '數億美元',
                                marketShare: '知識管理新興領導者',
                                strengths: '功能強大、用戶體驗優秀、年輕用戶基礎',
                                weaknesses: '學習曲線陡峭、企業功能待完善'
                            },
                            { 
                                name: 'Zoom Video Communications', 
                                description: '視訊會議平台領導者，疫情期間快速成長', 
                                website: 'https://zoom.us', 
                                linkedin: 'https://linkedin.com/company/zoom-video-communications',
                                founded: '2011',
                                employees: '5,000+',
                                revenue: '數十億美元',
                                marketShare: '視訊會議領導者',
                                strengths: '易用性、穩定性、疫情期間快速成長',
                                weaknesses: '安全性疑慮、競爭激烈'
                            }
                        ];
                        break;
                    case 'fintech':
                        mockCompetitors = [
                            { 
                                name: 'Square (Block)', 
                                description: '支付處理和金融服務平台，小企業金融解決方案', 
                                website: 'https://squareup.com', 
                                linkedin: 'https://linkedin.com/company/square',
                                founded: '2009',
                                employees: '8,000+',
                                revenue: '數十億美元',
                                marketShare: '小企業支付領導者',
                                strengths: '小企業專注、硬體整合、生態系統完整',
                                weaknesses: '大企業市場有限、獲利能力待改善'
                            },
                            { 
                                name: 'Stripe', 
                                description: '線上支付處理平台，開發者友好的 API', 
                                website: 'https://stripe.com', 
                                linkedin: 'https://linkedin.com/company/stripe',
                                founded: '2010',
                                employees: '7,000+',
                                revenue: '數十億美元',
                                marketShare: '線上支付領導者',
                                strengths: '開發者友好、全球覆蓋、技術領先',
                                weaknesses: '價格較高、競爭激烈'
                            },
                            { 
                                name: 'PayPal', 
                                description: '全球支付平台，電子商務支付領導者', 
                                website: 'https://paypal.com', 
                                linkedin: 'https://linkedin.com/company/paypal',
                                founded: '1998',
                                employees: '30,000+',
                                revenue: '數百億美元',
                                marketShare: '全球支付領導者',
                                strengths: '品牌知名度高、全球覆蓋、用戶基礎龐大',
                                weaknesses: '創新速度較慢、費用較高'
                            },
                            { 
                                name: 'Robinhood', 
                                description: '零佣金股票交易平台，年輕投資者首選', 
                                website: 'https://robinhood.com', 
                                linkedin: 'https://linkedin.com/company/robinhood',
                                founded: '2013',
                                employees: '3,000+',
                                revenue: '數億美元',
                                marketShare: '零佣金交易領導者',
                                strengths: '零佣金、用戶體驗優秀、年輕用戶基礎',
                                weaknesses: '功能相對簡單、監管風險'
                            },
                            { 
                                name: 'Coinbase', 
                                description: '加密貨幣交易平台，數位資產交易所', 
                                website: 'https://coinbase.com', 
                                linkedin: 'https://linkedin.com/company/coinbase',
                                founded: '2012',
                                employees: '3,000+',
                                revenue: '數十億美元',
                                marketShare: '加密貨幣交易領導者',
                                strengths: '合規性強、用戶信任度高、機構客戶基礎',
                                weaknesses: '監管風險、市場波動性大'
                            }
                        ];
                        break;
                    default:
                        // 通用競爭對手
                        mockCompetitors = [
                            { 
                                name: '競爭對手 A', 
                                description: '行業領導者，市場份額領先', 
                                website: 'https://example.com', 
                                linkedin: 'https://linkedin.com/company/competitor-a',
                                founded: '2010',
                                employees: '1,000+',
                                revenue: '數億美元',
                                marketShare: '行業前三名',
                                strengths: '品牌知名度高、資源豐富、技術領先',
                                weaknesses: '創新速度較慢、成本較高'
                            },
                            { 
                                name: '競爭對手 B', 
                                description: '新興競爭者，創新能力強', 
                                website: 'https://example.com', 
                                linkedin: 'https://linkedin.com/company/competitor-b',
                                founded: '2018',
                                employees: '500+',
                                revenue: '數千萬美元',
                                marketShare: '快速成長',
                                strengths: '創新能力強、用戶體驗優秀、靈活度高',
                                weaknesses: '資源有限、品牌知名度較低'
                            }
                        ];
                }

                // 更新狀態
                state.analysisData.competitors = mockCompetitors;
                
                // 顯示搜尋結果
                displayCompetitorSearchResults(mockCompetitors);
                
                console.log('競爭對手搜尋完成:', mockCompetitors.length, '個結果');
                
            } catch (error) {
                console.error('搜尋競爭對手失敗:', error);
                showAlert('搜尋失敗', '無法搜尋競爭對手，請重試', 'error');
            }
        }

        // 顯示競爭對手搜尋結果
        function displayCompetitorSearchResults(competitors) {
            try {
                const resultsContainer = document.getElementById('auto-search-results');
                if (!resultsContainer) return;

                if (competitors.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-gray-400">沒有找到相關競爭對手</p>';
                    return;
                }

                let html = '';
                competitors.forEach((competitor, index) => {
                    html += `
                        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-techaccent/50 transition-all">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h5 class="text-lg font-semibold text-gray-200 mb-1">${competitor.name}</h5>
                                    <p class="text-sm text-gray-400 mb-2">${competitor.description}</p>
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded">成立於 ${competitor.founded}</span>
                                        <span class="bg-green-600 text-white text-xs px-2 py-1 rounded">${competitor.employees} 員工</span>
                                        <span class="bg-purple-600 text-white text-xs px-2 py-1 rounded">${competitor.revenue}</span>
                                        <span class="bg-orange-600 text-white text-xs px-2 py-1 rounded">${competitor.marketShare}</span>
                                    </div>
                                </div>
                                <div class="flex gap-2 ml-4">
                                    <button onclick="addCompetitorToSelection('${competitor.name}')" class="bg-techprimary hover:bg-techaccent text-white px-3 py-1 rounded text-sm">
                                        選擇
                                    </button>
                                    <a href="${competitor.website}" target="_blank" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                                        網站
                                    </a>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <h6 class="font-semibold text-green-400 mb-1">優勢</h6>
                                    <p class="text-gray-300">${competitor.strengths}</p>
                                </div>
                                <div>
                                    <h6 class="font-semibold text-red-400 mb-1">劣勢</h6>
                                    <p class="text-gray-300">${competitor.weaknesses}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });

                resultsContainer.innerHTML = html;
                
            } catch (error) {
                console.error('顯示競爭對手搜尋結果失敗:', error);
            }
        }

        // 添加競爭對手到選擇清單
        function addCompetitorToSelection(competitorName) {
            try {
                if (!state.analysisData.selectedCompetitors) {
                    state.analysisData.selectedCompetitors = [];
                }

                // 檢查是否已經選擇
                if (state.analysisData.selectedCompetitors.includes(competitorName)) {
                    showAlert('已選擇', '此競爭對手已在選擇清單中', 'warning');
                    return;
                }

                // 添加到選擇清單
                state.analysisData.selectedCompetitors.push(competitorName);
                
                // 更新顯示
                updateSelectedCompetitorsDisplay();
                
                showAlert('已添加', `${competitorName} 已添加到選擇清單`, 'success');
                
            } catch (error) {
                console.error('添加競爭對手失敗:', error);
                showAlert('添加失敗', '無法添加競爭對手', 'error');
            }
        }

        // 更新已選擇競爭對手顯示
        function updateSelectedCompetitorsDisplay() {
            try {
                const container = document.getElementById('selected-competitors');
                const countElement = document.getElementById('selected-count');
                
                if (!container || !countElement) return;

                const selectedCompetitors = state.analysisData.selectedCompetitors || [];
                countElement.textContent = selectedCompetitors.length;

                if (selectedCompetitors.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">尚未選擇任何競爭對手</p>';
                    return;
                }

                let html = '';
                selectedCompetitors.forEach((competitor, index) => {
                    html += `
                        <div class="flex justify-between items-center bg-gray-800 rounded-lg p-3 border border-gray-700">
                            <span class="text-gray-200">${competitor}</span>
                            <button onclick="removeCompetitorFromSelection(${index})" class="text-red-400 hover:text-red-300">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                });

                container.innerHTML = html;
                
            } catch (error) {
                console.error('更新已選擇競爭對手顯示失敗:', error);
            }
        }

        // 從選擇清單移除競爭對手
        function removeCompetitorFromSelection(index) {
            try {
                if (!state.analysisData.selectedCompetitors) return;

                const removed = state.analysisData.selectedCompetitors.splice(index, 1)[0];
                updateSelectedCompetitorsDisplay();
                
                showAlert('已移除', `${removed} 已從選擇清單中移除`, 'info');
                
            } catch (error) {
                console.error('移除競爭對手失敗:', error);
                showAlert('移除失敗', '無法移除競爭對手', 'error');
            }
        }

        // 手動添加競爭對手
        function addManualCompetitor() {
            try {
                const input = document.getElementById('manual-competitor');
                const competitorNames = input?.value?.trim();
                
                if (!competitorNames) {
                    showAlert('請輸入競爭對手名稱', '競爭對手名稱不能為空', 'warning');
                    return;
                }

                // 分割逗號分隔的競爭對手名稱
                const competitors = competitorNames.split(',').map(name => name.trim()).filter(name => name.length > 0);
                
                if (competitors.length === 0) {
                    showAlert('請輸入有效的競爭對手名稱', '競爭對手名稱不能為空', 'warning');
                    return;
                }

                // 初始化選擇清單
                if (!state.analysisData.selectedCompetitors) {
                    state.analysisData.selectedCompetitors = [];
                }

                let addedCount = 0;
                let skippedCount = 0;

                competitors.forEach(competitorName => {
                    // 檢查是否已經選擇
                    if (state.analysisData.selectedCompetitors.includes(competitorName)) {
                        skippedCount++;
                        return;
                    }

                    // 添加到選擇清單
                    state.analysisData.selectedCompetitors.push(competitorName);
                    addedCount++;
                });
                
                // 更新顯示
                updateSelectedCompetitorsDisplay();
                
                // 清空輸入框
                input.value = '';
                
                // 顯示結果
                if (addedCount > 0) {
                    const message = skippedCount > 0 
                        ? `已添加 ${addedCount} 個競爭對手，跳過 ${skippedCount} 個重複項目`
                        : `已添加 ${addedCount} 個競爭對手`;
                    showAlert('添加成功', message, 'success');
                } else {
                    showAlert('沒有新增', '所有競爭對手都已存在於選擇清單中', 'warning');
                }
                
            } catch (error) {
                console.error('手動添加競爭對手失敗:', error);
                showAlert('添加失敗', '無法添加競爭對手', 'error');
            }
        }

        // 生成完整報告
        function generateFinalReport() {
            try {
                if (!state.analysisData.selectedCompetitors || state.analysisData.selectedCompetitors.length === 0) {
                    showAlert('沒有選擇競爭對手', '請先選擇至少一個競爭對手', 'warning');
                    return;
                }

                showAlert('生成中', '正在生成完整競爭對手分析報告...', 'info');

                const report = generateCompetitorAnalysisReport();
                const filename = `競爭對手分析報告_${new Date().toISOString().split('T')[0]}.txt`;
                
                downloadFile(report, filename);
                showAlert('報告生成成功', `${filename} 已下載到您的裝置`, 'success');

            } catch (error) {
                console.error('生成完整報告失敗:', error);
                showAlert('報告生成失敗', '無法生成完整報告', 'error');
            }
        }

        // 生成競爭對手分析報告
        function generateCompetitorAnalysisReport() {
            const topic = state.analysisData.topic || '未指定';
            const brand = state.analysisData.brand?.name || '未指定';
            const industry = state.analysisData.industry?.category || '未指定';
            const selectedCompetitors = state.analysisData.selectedCompetitors || [];
            const allCompetitors = state.analysisData.competitors || [];

            return `競爭對手分析報告
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 分析概況 ===
分析主題: ${topic}
目標品牌: ${brand}
所屬產業: ${industry}
選擇競爭對手數量: ${selectedCompetitors.length}

=== 競爭對手清單 ===
${selectedCompetitors.map((competitor, index) => `${index + 1}. ${competitor}`).join('\n')}

=== 詳細競爭對手分析 ===
${generateDetailedCompetitorAnalysis()}

=== 市場機會分析 ===
${generateMarketOpportunityAnalysis()}

=== 策略建議 ===
${generateStrategyRecommendations()}

---
由 iStaging 市場情資與競品分析平台生成
`;
        }

        // 生成詳細競爭對手分析
        function generateDetailedCompetitorAnalysis() {
            const allCompetitors = state.analysisData.competitors || [];
            const selectedCompetitors = state.analysisData.selectedCompetitors || [];
            
            let analysis = '';
            
            selectedCompetitors.forEach((selectedName, index) => {
                const competitor = allCompetitors.find(c => c.name === selectedName);
                if (competitor) {
                    analysis += `
競爭對手 ${index + 1}: ${competitor.name}
- 公司名稱: ${competitor.name}
- 品牌名稱: ${competitor.name}
- 官方網站: ${competitor.website || '未提供'}
- LinkedIn: ${competitor.linkedin || '未提供'}
- 公司描述: ${competitor.description || '未提供'}
- 成立時間: ${competitor.founded || '未提供'}
- 員工規模: ${competitor.employees || '未提供'}
- 營收規模: ${competitor.revenue || '未提供'}
- 市場地位: ${competitor.marketShare || '未提供'}
- 主要優勢: ${competitor.strengths || '未提供'}
- 主要劣勢: ${competitor.weaknesses || '未提供'}

`;
                } else {
                    analysis += `
競爭對手 ${index + 1}: ${selectedName}
- 公司名稱: ${selectedName}
- 品牌名稱: ${selectedName}
- 官方網站: 未提供
- LinkedIn: 未提供
- 公司描述: 手動添加的競爭對手，詳細資訊待補充
- 成立時間: 未提供
- 員工規模: 未提供
- 營收規模: 未提供
- 市場地位: 未提供
- 主要優勢: 未提供
- 主要劣勢: 未提供

`;
                }
            });
            
            return analysis;
        }

        // 生成市場機會分析
        function generateMarketOpportunityAnalysis() {
            return `基於競爭對手分析，發現以下市場機會：

1. 技術創新機會
   - 識別競爭對手的技術弱點
   - 開發差異化技術優勢
   - 建立技術壁壘

2. 市場空白機會
   - 未被充分服務的客戶群體
   - 新興市場機會
   - 產品功能空白

3. 用戶體驗機會
   - 改善用戶界面和體驗
   - 提供更好的客戶服務
   - 建立品牌忠誠度

4. 商業模式創新
   - 探索新的收入模式
   - 建立合作夥伴關係
   - 開發生態系統`;
        }

        // 生成策略建議
        function generateStrategyRecommendations() {
            return `基於競爭對手分析，建議採取以下策略：

1. 短期策略 (3-6個月)
   - 快速推出差異化功能
   - 建立品牌知名度
   - 獲取早期用戶反饋

2. 中期策略 (6-12個月)
   - 擴大市場份額
   - 建立競爭優勢
   - 優化產品功能

3. 長期策略 (1-3年)
   - 建立市場領導地位
   - 開發新產品線
   - 國際化擴張

4. 風險管理
   - 監控競爭對手動態
   - 建立技術壁壘
   - 保護智慧財產權`;
        }

        // 設定步驟 1 的事件監聽器
        function setupStep1EventListeners() {
            try {
                // 添加產品按鈕
                const addProductBtn = document.getElementById('add-product-btn');
                if (addProductBtn) {
                    addProductBtn.addEventListener('click', function() {
                        const productsContainer = document.getElementById('products-container');
                        if (productsContainer) {
                            const productItem = document.createElement('div');
                            productItem.className = 'product-item bg-gray-800 rounded-lg p-4 mb-3';
                            productItem.innerHTML = `
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">產品/服務名稱</label>
                                        <input type="text" class="product-name w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="主要產品名稱">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">價格定位</label>
                                        <select class="product-pricing w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                                            <option value="">選擇價格定位</option>
                                            <option value="premium">高價位 (Premium)</option>
                                            <option value="mid-high">中高價位</option>
                                            <option value="mid">中價位</option>
                                            <option value="mid-low">中低價位</option>
                                            <option value="budget">平價 (Budget)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">目標客群</label>
                                        <input type="text" class="product-target w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="目標客群描述">
                                    </div>
                                </div>
                                <button class="remove-product-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs mt-2">移除</button>
                            `;
                            
                            // 添加移除功能
                            const removeBtn = productItem.querySelector('.remove-product-btn');
                            removeBtn.addEventListener('click', function() {
                                productItem.remove();
                            });
                            
                            productsContainer.appendChild(productItem);
                        }
                    });
                }

                // 開始分析按鈕
                const startAnalysisBtn = document.getElementById('start-analysis-btn');
                if (startAnalysisBtn) {
                    startAnalysisBtn.addEventListener('click', startAnalysis);
                }

                // 手動添加競爭對手按鈕
                const addCompetitorBtn = document.getElementById('add-competitor-btn');
                if (addCompetitorBtn) {
                    addCompetitorBtn.addEventListener('click', addManualCompetitor);
                }

                // 生成報告按鈕
                const generateReportBtn = document.getElementById('generate-report-btn');
                if (generateReportBtn) {
                    generateReportBtn.addEventListener('click', generateFinalReport);
                }

                // 返回步驟 1 按鈕
                const backToStep1Btn = document.getElementById('back-to-step1-btn');
                if (backToStep1Btn) {
                    backToStep1Btn.addEventListener('click', function() {
                        goToStep(1);
                    });
                }

                console.log('步驟 1 事件監聽器設定完成');
            } catch (error) {
                console.error('設定步驟 1 事件監聽器失敗:', error);
            }
        }

        // 顯示完整報告
        function displayFinalReport() {
            try {
                const finalReportContent = document.getElementById('final-report-content');
                if (!finalReportContent) return;

                const selectedCompetitors = state.analysisData.selectedCompetitors || [];
                const allCompetitors = state.analysisData.competitors || [];
                const topic = state.analysisData.topic || '未指定';
                const brand = state.analysisData.brand?.name || '未指定';
                const industry = state.analysisData.industry?.category || '未指定';

                if (selectedCompetitors.length === 0) {
                    finalReportContent.innerHTML = '<p class="text-gray-400">請先完成步驟 2 的對手篩選</p>';
                    return;
                }

                let reportHTML = `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-techaccent mb-4">📊 分析概況</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="bg-gray-800 rounded-lg p-4">
                                <div class="text-sm text-gray-400">分析主題</div>
                                <div class="text-lg font-semibold text-white">${topic}</div>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4">
                                <div class="text-sm text-gray-400">目標品牌</div>
                                <div class="text-lg font-semibold text-white">${brand}</div>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4">
                                <div class="text-sm text-gray-400">所屬產業</div>
                                <div class="text-lg font-semibold text-white">${industry}</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-techaccent mb-4">🎯 競爭對手分析 (${selectedCompetitors.length} 個)</h3>
                        <div class="space-y-6">
                `;

                selectedCompetitors.forEach((selectedName, index) => {
                    const competitor = allCompetitors.find(c => c.name === selectedName);
                    
                    if (competitor) {
                        reportHTML += `
                            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                                <div class="flex justify-between items-start mb-4">
                                    <h4 class="text-xl font-semibold text-white">${index + 1}. ${competitor.name}</h4>
                                    <div class="flex gap-2">
                                        ${competitor.website ? `<a href="${competitor.website}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">🌐 官網</a>` : ''}
                                        ${competitor.linkedin ? `<a href="${competitor.linkedin}" target="_blank" class="bg-blue-700 hover:bg-blue-800 text-white px-3 py-1 rounded text-sm">💼 LinkedIn</a>` : ''}
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <h5 class="font-semibold text-gray-300 mb-3">📋 基本資訊</h5>
                                        <div class="space-y-2 text-sm">
                                            <div><span class="text-gray-400">公司名稱:</span> <span class="text-white">${competitor.name}</span></div>
                                            <div><span class="text-gray-400">品牌名稱:</span> <span class="text-white">${competitor.name}</span></div>
                                            <div><span class="text-gray-400">成立時間:</span> <span class="text-white">${competitor.founded || '未提供'}</span></div>
                                            <div><span class="text-gray-400">員工規模:</span> <span class="text-white">${competitor.employees || '未提供'}</span></div>
                                            <div><span class="text-gray-400">營收規模:</span> <span class="text-white">${competitor.revenue || '未提供'}</span></div>
                                            <div><span class="text-gray-400">市場地位:</span> <span class="text-white">${competitor.marketShare || '未提供'}</span></div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h5 class="font-semibold text-gray-300 mb-3">📝 公司描述</h5>
                                        <p class="text-sm text-gray-300 mb-4">${competitor.description || '未提供'}</p>
                                        
                                        <h5 class="font-semibold text-gray-300 mb-3">✅ 主要優勢</h5>
                                        <p class="text-sm text-green-300 mb-4">${competitor.strengths || '未提供'}</p>
                                        
                                        <h5 class="font-semibold text-gray-300 mb-3">⚠️ 主要劣勢</h5>
                                        <p class="text-sm text-red-300">${competitor.weaknesses || '未提供'}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        reportHTML += `
                            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                                <h4 class="text-xl font-semibold text-white mb-4">${index + 1}. ${selectedName}</h4>
                                <div class="text-sm text-gray-400">
                                    <p>手動添加的競爭對手，詳細資訊待補充</p>
                                    <div class="mt-3">
                                        <div><span class="text-gray-400">公司名稱:</span> <span class="text-white">${selectedName}</span></div>
                                        <div><span class="text-gray-400">品牌名稱:</span> <span class="text-white">${selectedName}</span></div>
                                        <div><span class="text-gray-400">官方網站:</span> <span class="text-white">未提供</span></div>
                                        <div><span class="text-gray-400">LinkedIn:</span> <span class="text-white">未提供</span></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });

                reportHTML += `
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-techaccent mb-4">📊 市場機會分析</h3>
                        <div class="bg-gray-800 rounded-lg p-6">
                            <div class="space-y-4 text-sm">
                                <div>
                                    <h5 class="font-semibold text-blue-300 mb-2">🔬 技術創新機會</h5>
                                    <p class="text-gray-300">識別競爭對手的技術弱點，開發差異化技術優勢，建立技術壁壘</p>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-green-300 mb-2">🎯 市場空白機會</h5>
                                    <p class="text-gray-300">未被充分服務的客戶群體，新興市場機會，產品功能空白</p>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-purple-300 mb-2">👥 用戶體驗機會</h5>
                                    <p class="text-gray-300">改善用戶界面和體驗，提供更好的客戶服務，建立品牌忠誠度</p>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-yellow-300 mb-2">💡 商業模式創新</h5>
                                    <p class="text-gray-300">探索新的收入模式，建立合作夥伴關係，開發生態系統</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-techaccent mb-4">📋 策略建議</h3>
                        <div class="bg-gray-800 rounded-lg p-6">
                            <div class="space-y-4 text-sm">
                                <div>
                                    <h5 class="font-semibold text-blue-300 mb-2">⚡ 短期策略 (3-6個月)</h5>
                                    <p class="text-gray-300">快速推出差異化功能，建立品牌知名度，獲取早期用戶反饋</p>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-green-300 mb-2">📈 中期策略 (6-12個月)</h5>
                                    <p class="text-gray-300">擴大市場份額，建立競爭優勢，優化產品功能</p>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-purple-300 mb-2">🚀 長期策略 (1-3年)</h5>
                                    <p class="text-gray-300">建立市場領導地位，開發新產品線，國際化擴張</p>
                                </div>
                                <div>
                                    <h5 class="font-semibold text-red-300 mb-2">🛡️ 風險管理</h5>
                                    <p class="text-gray-300">監控競爭對手動態，建立技術壁壘，保護智慧財產權</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                finalReportContent.innerHTML = reportHTML;

            } catch (error) {
                console.error('顯示完整報告失敗:', error);
            }
        }

        // 生成 Google Ads 文案
        function generateAdsCopy() {
            try {
                // 檢查是否選擇了關鍵字
                const primaryChecked = document.getElementById('keyword-primary')?.checked;
                const longtailChecked = document.getElementById('keyword-longtail')?.checked;
                const commercialChecked = document.getElementById('keyword-commercial')?.checked;
                const informationalChecked = document.getElementById('keyword-informational')?.checked;
                const navigationalChecked = document.getElementById('keyword-navigational')?.checked;
                const transactionalChecked = document.getElementById('keyword-transactional')?.checked;
                
                if (!primaryChecked && !longtailChecked && !commercialChecked && !informationalChecked && !navigationalChecked && !transactionalChecked) {
                    showAlert('請選擇關鍵字', '請至少選擇一種關鍵字類型', 'warning');
                    return;
                }

                // 獲取關鍵字
                const primaryKeywords = document.getElementById('primary-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
                const longtailKeywords = document.getElementById('long-tail-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
                const businessModel = document.getElementById('business-model-select')?.value || '';
                
                let selectedKeywords = [];
                if (primaryChecked && primaryKeywords.length > 0) {
                    selectedKeywords = selectedKeywords.concat(primaryKeywords.map(k => ({ keyword: k, type: 'primary' })));
                }
                if (longtailChecked && longtailKeywords.length > 0) {
                    selectedKeywords = selectedKeywords.concat(longtailKeywords.map(k => ({ keyword: k, type: 'longtail' })));
                }

                if (selectedKeywords.length === 0) {
                    showAlert('沒有關鍵字', '請先在步驟 1 輸入關鍵字', 'warning');
                    return;
                }

                showAlert('生成中', '正在生成 Google Ads 文案...', 'info');

                // 生成文案
                const adsCopy = generateEnhancedAdsCopyContent(selectedKeywords, businessModel);
                const filename = `Google_Ads_文案_${new Date().toISOString().split('T')[0]}.txt`;
                
                downloadFile(adsCopy, filename);
                showAlert('文案生成成功', `${filename} 已下載到您的裝置`, 'success');

            } catch (error) {
                console.error('生成 Google Ads 文案失敗:', error);
                showAlert('文案生成失敗', '無法生成 Google Ads 文案', 'error');
            }
        }

        // 生成增強版 Google Ads 文案內容
        function generateEnhancedAdsCopyContent(keywords, businessModel) {
            const topic = state.analysisData.topic || '未指定';
            const brand = state.analysisData.brand?.name || '未指定';
            const industry = state.analysisData.industry?.category || '未指定';
            const businessModelInfo = getBusinessModelInfo(businessModel);

            let content = `Google Ads 文案產出報告
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 分析概況 ===
分析主題: ${topic}
目標品牌: ${brand}
所屬產業: ${industry}
商業模式: ${businessModelInfo.name}
選擇關鍵字數量: ${keywords.length}

=== 關鍵字清單 ===
${keywords.map((item, index) => `${index + 1}. ${item.keyword} (${item.type})`).join('\n')}

=== Google Ads 文案建議 ===

`;

            // 為每個關鍵字生成文案
            keywords.forEach((item, index) => {
                const keyword = item.keyword;
                const type = item.type;
                
                content += `關鍵字 ${index + 1}: ${keyword} (${type})

標題建議 (最多 30 字元):
1. ${generateBusinessModelAdTitle(keyword, brand, businessModel, 30)}
2. ${generateBusinessModelAdTitle(keyword, brand, businessModel, 30)}
3. ${generateBusinessModelAdTitle(keyword, brand, businessModel, 30)}

描述建議 (最多 90 字元):
${generateBusinessModelAdDescription(keyword, brand, businessModel, 90)}

行動呼籲建議:
${generateBusinessModelCTAs(businessModel)}

顯示網址建議:
www.${brand.toLowerCase().replace(/\s+/g, '')}.com/${keyword.replace(/\s+/g, '-')}

目標網址建議:
https://www.${brand.toLowerCase().replace(/\s+/g, '')}.com/${keyword.replace(/\s+/g, '-')}

關鍵字匹配建議:
${generateKeywordMatchSuggestions(keyword, type)}

---
`;
            });

            content += `
=== 文案優化建議 ===

1. 標題優化 (基於 ${businessModelInfo.name})
   - 包含主要關鍵字
   - 突出 ${businessModelInfo.focus}
   - 使用行動詞彙
   - 控制在 30 字元內

2. 描述優化
   - 包含長尾關鍵字
   - 突出產品特色
   - 加入社會證明
   - 使用緊急感詞彙
   - 強調 ${businessModelInfo.focus}

3. 行動呼籲優化
   - 根據 ${businessModelInfo.name} 選擇
   - 與目標網頁一致
   - 創造緊急感
   - 測試不同版本

4. 關鍵字匹配建議
   - 廣泛匹配: ${keywords.map(item => `"${item.keyword}"`).join(', ')}
   - 詞組匹配: ${keywords.map(item => `"${item.keyword}"`).join(', ')}
   - 完全匹配: [${keywords.map(item => `[${item.keyword}]`).join(', ')}]

5. 出價策略建議
   - 主要關鍵字: 高競爭出價 ($$$)
   - 長尾關鍵字: 中等出價 ($$)
   - 商業意圖: 高價值出價 ($$$)
   - 資訊型: 低競爭出價 ($)

6. 預算分配建議
   - 主要關鍵字: 40% 預算
   - 長尾關鍵字: 35% 預算
   - 商業意圖: 15% 預算
   - 資訊型: 10% 預算

---
由 iStaging 市場情資與競品分析平台生成
`;

            return content;
        }

        // 生成商業模式對應的廣告標題
        function generateBusinessModelAdTitle(keyword, brand, businessModel, maxLength) {
            const templates = {
                'b2b': [
                    `${keyword} - ${brand}企業解決方案`,
                    `${brand}${keyword}專業服務`,
                    `${keyword}首選${brand}`,
                    `${brand}${keyword}專家`,
                    `${keyword}就找${brand}`
                ],
                'b2c': [
                    `${keyword} - ${brand}優質選擇`,
                    `${brand}${keyword}推薦`,
                    `${keyword}首選${brand}`,
                    `${brand}${keyword}專家`,
                    `${keyword}就選${brand}`
                ],
                'saas': [
                    `${keyword} - ${brand}雲端服務`,
                    `${brand}${keyword}解決方案`,
                    `${keyword}首選${brand}`,
                    `${brand}${keyword}平台`,
                    `${keyword}就選${brand}`
                ],
                'ecommerce': [
                    `${keyword} - ${brand}線上購物`,
                    `${brand}${keyword}專賣`,
                    `${keyword}首選${brand}`,
                    `${brand}${keyword}商城`,
                    `${keyword}就選${brand}`
                ],
                'agency': [
                    `${keyword} - ${brand}專業服務`,
                    `${brand}${keyword}專家`,
                    `${keyword}首選${brand}`,
                    `${brand}${keyword}顧問`,
                    `${keyword}就找${brand}`
                ]
            };
            
            const modelTemplates = templates[businessModel] || templates['b2b'];
            const title = modelTemplates[Math.floor(Math.random() * modelTemplates.length)];
            return title.length > maxLength ? title.substring(0, maxLength - 3) + '...' : title;
        }

        // 生成商業模式對應的廣告描述
        function generateBusinessModelAdDescription(keyword, brand, businessModel, maxLength) {
            const templates = {
                'b2b': [
                    `${brand}提供專業${keyword}服務，企業級解決方案，品質保證。立即諮詢，獲得最佳企業服務！`,
                    `${keyword}專家${brand}，多年企業服務經驗，客戶滿意度高。免費諮詢，專業建議，立即行動！`,
                    `${brand}${keyword}服務，快速響應，專業團隊。企業級品質，立即聯繫，搶先體驗！`
                ],
                'b2c': [
                    `${brand}提供優質${keyword}，品質保證，價格實惠。立即購買，享受最佳體驗！`,
                    `${keyword}首選${brand}，多年經驗，客戶好評如潮。限時優惠，立即行動，搶先體驗！`,
                    `${brand}${keyword}，快速配送，貼心服務。品質可靠，立即購買，滿意保證！`
                ],
                'saas': [
                    `${brand}提供雲端${keyword}解決方案，提升效率，節省成本。免費試用，立即體驗！`,
                    `${keyword}雲端服務${brand}，技術領先，穩定可靠。免費試用，專業支援，立即開始！`,
                    `${brand}${keyword}平台，功能強大，操作簡單。免費試用，滿意再付費，立即註冊！`
                ],
                'ecommerce': [
                    `${brand}${keyword}專賣，正品保證，價格優惠。快速配送，安全支付，立即購買！`,
                    `${keyword}就選${brand}，品質保證，價格實惠。限時特價，快速配送，立即下單！`,
                    `${brand}${keyword}商城，品類齊全，服務周到。安全購物，快速配送，立即選購！`
                ],
                'agency': [
                    `${brand}提供專業${keyword}服務，豐富案例，專業團隊。免費諮詢，立即合作！`,
                    `${keyword}專家${brand}，多年經驗，成功案例多。免費諮詢，專業建議，立即聯繫！`,
                    `${brand}${keyword}顧問，專業能力，服務周到。免費諮詢，滿意再合作，立即預約！`
                ]
            };
            
            const modelTemplates = templates[businessModel] || templates['b2b'];
            const description = modelTemplates[Math.floor(Math.random() * modelTemplates.length)];
            return description.length > maxLength ? description.substring(0, maxLength - 3) + '...' : description;
        }

        // 生成完整關鍵字建議書
        function generateEnhancedKeywordReport() {
            try {
                const keywords = collectKeywordsData();
                
                if (keywords.primary.length === 0 && keywords.longTail.length === 0) {
                    showAlert('沒有關鍵字', '請先輸入關鍵字再生成報告', 'warning');
                    return;
                }

                showAlert('生成中', '正在生成完整關鍵字建議書...', 'info');

                const report = generateEnhancedKeywordAnalysisReport(keywords);
                const filename = `完整關鍵字建議書_${new Date().toISOString().split('T')[0]}.txt`;
                
                downloadFile(report, filename);
                showAlert('報告生成成功', `${filename} 已下載到您的裝置`, 'success');

            } catch (error) {
                console.error('生成完整關鍵字建議書失敗:', error);
                showAlert('報告生成失敗', '無法生成完整關鍵字建議書', 'error');
            }
        }

        // 生成完整關鍵字建議書內容
        function generateEnhancedKeywordAnalysisReport(keywords) {
            const marketInfo = getMarketInfo(keywords.marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(keywords.marketPositioning.primaryLanguage);

            return `完整關鍵字建議書
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 市場定位分析 ===
目標市場: ${marketInfo.name} (${marketInfo.code})
商業模式: ${businessModelInfo.name}
目標客群: ${getTargetAudienceInfo(keywords.marketPositioning.targetAudience)}
主要語言: ${languageInfo.name}
本地化程度: ${getLocalizationInfo(keywords.marketPositioning.localizationLevel)}

=== 主要關鍵字 (${keywords.primary.length} 個) ===
${keywords.primary.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== 長尾關鍵字 (${keywords.longTail.length} 個) ===
${keywords.longTail.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== 關鍵字策略分析 ===
分析深度: ${getKeywordDepthInfo(keywords.depth)}

=== SEO 策略建議 ===
${generateComprehensiveSEORecommendations(keywords)}

=== 關鍵字購買策略 ===
${generateComprehensiveKeywordPurchaseStrategy(keywords)}

=== 內容策略建議 ===
${generateContentStrategyRecommendations(keywords)}

---
由 iStaging 市場情資與競品分析平台生成
`;
        }

        // 生成關鍵字匹配建議
        function generateKeywordMatchSuggestions(keyword, type) {
            // 這裡應該實作關鍵字匹配建議的生成邏輯
            return `關鍵字匹配建議：${keyword} 的匹配策略`;
        }

    </script>
</head>
<body>
    <div id="app-container" class="p-6 bg-techbg text-white min-h-screen">
        <h1 class="text-2xl font-semibold mb-6">市場情資與競品分析平台 (V6 - 進階分析版)</h1>

        <div id="alert-container"></div>

        <div id="settings-panel" class="bg-techpanel rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">API 設定</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Google API Key</label>
                    <input type="text" id="google-api-key" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Google API Key">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Search Engine ID</label>
                    <input type="text" id="search-engine-id" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Search Engine ID">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Central Folder Name</label>
                    <input type="text" id="central-folder-name" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Central Folder Name">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Intelligence Subfolder</label>
                    <input type="text" id="intelligence-subfolder" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Intelligence Subfolder">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Media Plan Subfolder</label>
                    <input type="text" id="mediaplan-subfolder" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Media Plan Subfolder">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Workflow Subfolder</label>
                    <input type="text" id="workflow-subfolder" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Workflow Subfolder">
                </div>
            </div>
            <button id="save-settings-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">儲存設定</button>
        </div>

        <div id="analysis-panel" class="bg-techpanel rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">分析設定</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">品牌名稱</label>
                    <input type="text" id="brand-name" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="品牌名稱">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">品牌網站</label>
                    <input type="text" id="brand-website" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="品牌網站">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">品牌描述</label>
                    <textarea id="brand-description" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3" placeholder="品牌描述"></textarea>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">行業類別</label>
                    <select id="industry-category" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇行業類別</option>
                        <option value="ecommerce">電商</option>
                        <option value="saas">SaaS</option>
                        <option value="fintech">金融科技</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">市場規模</label>
                    <input type="text" id="market-size" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="市場規模">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">分析主題</label>
                    <input type="text" id="analysis-topic" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="分析主題">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">競爭對手數量</label>
                    <input type="number" id="competitor-count" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="競爭對手數量">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">分析深度</label>
                    <div class="flex gap-2">
                        <label class="flex items-center">
                            <input type="radio" name="analysis-depth" value="basic" class="form-radio">
                            <span class="ml-2">基礎分析 (搜尋量、競爭度)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="analysis-depth" value="standard" class="form-radio">
                            <span class="ml-2">標準分析 (搜尋量、競爭度、出價建議)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="analysis-depth" value="comprehensive" class="form-radio">
                            <span class="ml-2">深度分析 (搜尋量、競爭度、出價建議、內容策略)</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">主要關鍵字</label>
                    <textarea id="primary-keywords" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3" placeholder="主要關鍵字，每行一個"></textarea>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">長尾關鍵字</label>
                    <textarea id="long-tail-keywords" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3" placeholder="長尾關鍵字，每行一個"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">商業模式</label>
                    <select id="business-model-select" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇商業模式</option>
                        <option value="b2b">B2B (企業對企業)</option>
                        <option value="b2c">B2C (企業對消費者)</option>
                        <option value="b2b2c">B2B2C (企業對企業對消費者)</option>
                        <option value="c2c">C2C (消費者對消費者)</option>
                        <option value="saas">SaaS (軟體即服務)</option>
                        <option value="marketplace">Marketplace (平台模式)</option>
                        <option value="subscription">Subscription (訂閱模式)</option>
                        <option value="freemium">Freemium (免費增值)</option>
                        <option value="ecommerce">E-commerce (電商)</option>
                        <option value="agency">Agency (代理/服務)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">本地化程度</label>
                    <select id="localization-level" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇本地化程度</option>
                        <option value="basic">基礎本地化 (翻譯) - 基本語言適應</option>
                        <option value="standard">標準本地化 (翻譯+文化適應) - 文化內容調整</option>
                        <option value="advanced">深度本地化 (完全在地化) - 完全文化適應</option>
                        <option value="native">原生本地化 (在地團隊開發) - 原生文化體驗</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">主要語言</label>
                    <select id="primary-language" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇主要語言</option>
                        <option value="zh-tw">繁體中文 (台灣)</option>
                        <option value="zh-hk">繁體中文 (香港)</option>
                        <option value="zh-cn">簡體中文 (中國)</option>
                        <option value="en">English (英語)</option>
                        <option value="ja">日本語 (日語)</option>
                        <option value="ko">한국어 (韓語)</option>
                        <option value="th">ไทย (泰語)</option>
                        <option value="vi">Tiếng Việt (越南語)</option>
                        <option value="id">Bahasa Indonesia (印尼語)</option>
                        <option value="ms">Bahasa Melayu (馬來語)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">目標客群</label>
                    <select id="target-audience" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇目標客群</option>
                        <option value="startup">新創公司 - 成本敏感，快速決策</option>
                        <option value="sme">中小企業 - 實用導向，性價比重要</option>
                        <option value="enterprise">大型企業 - 品質要求高，決策週期長</option>
                        <option value="freelancer">自由工作者 - 靈活性重要，成本控制</option>
                        <option value="student">學生 - 價格敏感，功能需求</option>
                        <option value="professional">專業人士 - 品質要求高，效率重要</option>
                        <option value="consumer">一般消費者 - 用戶體驗，情感訴求</option>
                        <option value="elderly">銀髮族 - 易用性，信任建立</option>
                        <option value="youth">年輕族群 - 創新，社交分享</option>
                        <option value="parent">家長 - 安全，品質，教育價值</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">項目 ID</label>
                    <input type="text" id="project-id" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="項目 ID">
                </div>
            </div>
            <div class="flex gap-4">
                <button id="start-analysis-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">開始分析</button>
                <button id="generate-report-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">生成報告</button>
            </div>
        </div>

        <div id="history-panel" class="bg-techpanel rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">歷史紀錄</h2>
            <div id="auto-search-results"></div>
        </div>

        <div id="step-1" class="step-panel">
            <h3 class="text-lg font-semibold mb-4">步驟 1: 設定分析</h3>
            <div id="products-container"></div>
            <div class="flex gap-4">
                <button id="add-product-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">添加產品</button>
                <button id="add-competitor-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">手動添加競爭對手</button>
            </div>
        </div>

        <div id="step-2" class="step-panel">
            <h3 class="text-lg font-semibold mb-4">步驟 2: 對手篩選</h3>
            <div id="selected-competitors"></div>
            <div class="flex justify-between items-center mt-4">
                <button id="back-to-step1-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">返回步驟 1</button>
                <button id="search-competitors-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">搜尋競爭對手</button>
            </div>
        </div>

        <div id="step-3" class="step-panel">
            <h3 class="text-lg font-semibold mb-4">步驟 3: 生成報告</h3>
            <div id="final-report-content"></div>
        </div>
    </div>
</body>
</html>