<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>市場情資與競品分析平台 (V6 - 進階分析版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Tailwind CSS configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        techbg: '#181D27',
                        techpanel: '#22283A',
                        techaccent: '#2EE9E4',
                        techprimary: '#3762F0',
                        techsecondary: '#7D5FFF'
                    },
                    fontFamily: {
                        'tech': ['"Segoe UI"', 'Roboto', 'Arial', 'sans-serif']
                    }
                }
            }
        }

        // 全域狀態管理
        window.state = {
            isAuthenticated: false,
            apiConfigured: false,
            currentStep: 1,
            analysisData: {},
            settings: {
                googleApiKey: '',
                searchEngineId: '',
                centralFolderName: 'iStaging_專案管理',
                intelligenceSubfolder: '01_市場情資分析',
                mediaplanSubfolder: '02_媒體提案',
                workflowSubfolder: '03_工作流程文件'
            }
        };

        // 頁面載入完成後初始化
        window.addEventListener('load', function() {
            console.log('頁面載入完成，開始初始化...');
            
            // 使用 Promise 包裝初始化，避免未捕獲的錯誤
            initializeApp()
                .then(() => {
                    console.log('初始化完成');
                })
                .catch(error => {
                    console.error('初始化過程中發生錯誤:', error);
                    showAlert('初始化錯誤', '頁面初始化失敗，請重新整理頁面', 'error');
                });
        });

        // 全域錯誤處理
        window.addEventListener('error', function(event) {
            console.error('全域錯誤:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('未處理的 Promise 拒絕:', event.reason);
            event.preventDefault(); // 防止預設的錯誤處理
        });

        // 顯示警告訊息
        function showAlert(title, message, type = 'info') {
            try {
                const alertContainer = document.getElementById('alert-container');
                if (!alertContainer) return;

                const alertDiv = document.createElement('div');
                alertDiv.className = `p-4 mb-4 rounded-lg shadow-lg ${
                    type === 'error' ? 'bg-red-600 text-white' :
                    type === 'success' ? 'bg-green-600 text-white' :
                    type === 'warning' ? 'bg-yellow-600 text-white' :
                    'bg-blue-600 text-white'
                }`;
                
                alertDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold">${title}</h4>
                            <p class="text-sm mt-1">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;

                alertContainer.appendChild(alertDiv);

                // 自動移除警告
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 5000);
            } catch (error) {
                console.error('顯示警告失敗:', error);
            }
        }

        // 初始化應用程式
        function initializeApp() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('初始化應用程式...');
                    
                    // 載入設定
                    loadSettings();
                    
                    // 設定事件監聽器
                    setupEventListeners();
                    
                    // 檢查 URL 參數
                    checkUrlParameters();
                    
                    // 更新 UI 狀態
                    updateUIState();
                    
                    console.log('應用程式初始化完成');
                    resolve();
                } catch (error) {
                    console.error('應用程式初始化失敗:', error);
                    reject(error);
                }
            });
        }

        // 載入設定
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('intelligence_settings');
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    state.settings = { ...state.settings, ...parsed };
                    
                    // 更新表單欄位
                    const apiKeyInput = document.getElementById('google-api-key');
                    const searchEngineInput = document.getElementById('search-engine-id');
                    const centralFolderInput = document.getElementById('central-folder-name');
                    const intelligenceSubfolderInput = document.getElementById('intelligence-subfolder');
                    const mediaplanSubfolderInput = document.getElementById('mediaplan-subfolder');
                    const workflowSubfolderInput = document.getElementById('workflow-subfolder');
                    
                    if (apiKeyInput) apiKeyInput.value = state.settings.googleApiKey || '';
                    if (searchEngineInput) searchEngineInput.value = state.settings.searchEngineId || '';
                    if (centralFolderInput) centralFolderInput.value = state.settings.centralFolderName || '';
                    if (intelligenceSubfolderInput) intelligenceSubfolderInput.value = state.settings.intelligenceSubfolder || '';
                    if (mediaplanSubfolderInput) mediaplanSubfolderInput.value = state.settings.mediaplanSubfolder || '';
                    if (workflowSubfolderInput) workflowSubfolderInput.value = state.settings.workflowSubfolder || '';
                }
            } catch (error) {
                console.warn('載入設定失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 設定事件監聽器
        function setupEventListeners() {
            try {
                // 標籤頁切換
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(btn => {
                    if (btn) {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            const tab = this.dataset.tab;
                            switchTab(tab);
                        });
                    }
                });

                // 儲存設定按鈕
                const saveSettingsBtn = document.getElementById('save-settings-btn');
                if (saveSettingsBtn) {
                    saveSettingsBtn.addEventListener('click', saveSettings);
                }

                // Google 登入按鈕
                const authorizeBtn = document.getElementById('authorize_button');
                if (authorizeBtn) {
                    authorizeBtn.addEventListener('click', handleGoogleAuth);
                }

                // 登出按鈕
                const signoutBtn = document.getElementById('signout_button');
                if (signoutBtn) {
                    signoutBtn.addEventListener('click', handleSignOut);
                }

                // 步驟切換 - 修正事件監聽器
                const stepCircles = document.querySelectorAll('.step-circle');
                stepCircles.forEach((circle, index) => {
                    if (circle) {
                        circle.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const step = index + 1;
                            console.log(`點擊步驟 ${step}`);
                            goToStep(step);
                        });
                    }
                });

                // 設定步驟 1 的事件監聽器
                setupStep1EventListeners();

                console.log('事件監聽器設定完成');
            } catch (error) {
                console.error('設定事件監聽器失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 檢查 URL 參數
        function checkUrlParameters() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('projectId');
                
                if (projectId) {
                    const projectIdInput = document.getElementById('project-id');
                    if (projectIdInput) {
                        projectIdInput.value = projectId;
                    }
                }
            } catch (error) {
                console.warn('檢查 URL 參數失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 更新 UI 狀態
        function updateUIState() {
            try {
                const appContainer = document.getElementById('app-container');
                const analysisPanel = document.getElementById('analysis-panel');
                const historyPanel = document.getElementById('history-panel');
                const isConfigured = state.settings.googleApiKey && state.settings.searchEngineId;
                
                // 移除 app-container 的 locked class，改為只鎖定特定面板
                if (appContainer) {
                    appContainer.classList.remove('locked');
                }
                
                // 只有分析系統和歷史紀錄需要 API 設定
                if (analysisPanel) {
                    if (isConfigured) {
                        analysisPanel.classList.remove('locked');
                        state.apiConfigured = true;
                    } else {
                        analysisPanel.classList.add('locked');
                        state.apiConfigured = false;
                    }
                }
                
                if (historyPanel) {
                    if (isConfigured) {
                        historyPanel.classList.remove('locked');
                    } else {
                        historyPanel.classList.add('locked');
                    }
                }

                // 預設顯示 API 設定分頁
                switchTab('settings');
            } catch (error) {
                console.error('更新 UI 狀態失敗:', error);
            }
        }

        // 切換標籤頁
        function switchTab(tabName) {
            try {
                // 移除所有標籤頁的 active 狀態
                const tabButtons = document.querySelectorAll('.tab-btn');
                const panels = document.querySelectorAll('.panel');
                
                tabButtons.forEach(btn => btn.classList.remove('active'));
                panels.forEach(panel => panel.classList.remove('active'));
                
                // 啟用選中的標籤頁
                const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
                const activePanel = document.getElementById(`${tabName}-panel`);
                
                if (activeTab) activeTab.classList.add('active');
                if (activePanel) activePanel.classList.add('active');
                
                console.log(`切換到標籤頁: ${tabName}`);
            } catch (error) {
                console.error('切換標籤頁失敗:', error);
            }
        }

        // 儲存設定
        function saveSettings() {
            try {
                const apiKey = document.getElementById('google-api-key')?.value || '';
                const searchEngineId = document.getElementById('search-engine-id')?.value || '';
                const centralFolderName = document.getElementById('central-folder-name')?.value || '';
                const intelligenceSubfolder = document.getElementById('intelligence-subfolder')?.value || '';
                const mediaplanSubfolder = document.getElementById('mediaplan-subfolder')?.value || '';
                const workflowSubfolder = document.getElementById('workflow-subfolder')?.value || '';

                // 更新狀態
                state.settings = {
                    googleApiKey: apiKey,
                    searchEngineId: searchEngineId,
                    centralFolderName: centralFolderName,
                    intelligenceSubfolder: intelligenceSubfolder,
                    mediaplanSubfolder: mediaplanSubfolder,
                    workflowSubfolder: workflowSubfolder
                };

                // 儲存到 localStorage
                localStorage.setItem('intelligence_settings', JSON.stringify(state.settings));

                // 更新 UI 狀態
                updateUIState();

                showAlert('設定已儲存', 'API 設定已成功儲存', 'success');
                
                // 如果 API 已設定，切換到分析系統
                if (apiKey && searchEngineId) {
                    setTimeout(() => {
                        switchTab('analysis');
                    }, 1000);
                }
            } catch (error) {
                console.error('儲存設定失敗:', error);
                showAlert('儲存失敗', error.message, 'error');
            }
        }

        // 開始分析
        function startAnalysis() {
            try {
                // 收集所有資料
                const brandName = document.getElementById('brand-name')?.value?.trim();
                const brandWebsite = document.getElementById('brand-website')?.value?.trim();
                const brandDescription = document.getElementById('brand-description')?.value?.trim();
                const industryCategory = document.getElementById('industry-category')?.value;
                const marketSize = document.getElementById('market-size')?.value;
                const topic = document.getElementById('analysis-topic')?.value?.trim();
                const projectId = document.getElementById('project-id')?.value?.trim();
                const competitorCount = document.getElementById('competitor-count')?.value;
                const analysisDepth = document.querySelector('input[name="analysis-depth"]:checked')?.value;

                // 驗證必填欄位
                if (!brandName) {
                    showAlert('請填寫品牌名稱', '品牌名稱為必填項目', 'warning');
                    return;
                }

                if (!industryCategory) {
                    showAlert('請選擇行業類別', '行業類別為必填項目', 'warning');
                    return;
                }

                if (!topic) {
                    showAlert('請填寫分析主題', '分析主題為必填項目', 'warning');
                    return;
                }

                // 收集產品和關鍵字資料
                const products = collectProductsData();
                const keywords = collectKeywordsData();

                // 儲存分析設定
                state.analysisData = {
                    brand: {
                        name: brandName,
                        website: brandWebsite,
                        description: brandDescription
                    },
                    products: products,
                    industry: {
                        category: industryCategory,
                        marketSize: marketSize
                    },
                    topic: topic,
                    projectId: projectId || `TEMP_${Date.now()}`,
                    competitorCount: parseInt(competitorCount),
                    analysisDepth: analysisDepth,
                    keywords: keywords,
                    timestamp: new Date().toISOString()
                };

                showAlert('分析設定已儲存', '正在準備競爭對手分析...', 'success');
                
                // 切換到步驟 2
                setTimeout(() => {
                    goToStep(2);
                }, 1000);

            } catch (error) {
                console.error('開始分析失敗:', error);
                showAlert('分析失敗', error.message, 'error');
            }
        }

        // 收集產品資料
        function collectProductsData() {
            try {
                const products = [];
                const productItems = document.querySelectorAll('.product-item');
                
                productItems.forEach(item => {
                    const name = item.querySelector('.product-name')?.value?.trim();
                    const pricing = item.querySelector('.product-pricing')?.value;
                    const target = item.querySelector('.product-target')?.value?.trim();
                    
                    if (name) {
                        products.push({
                            name: name,
                            pricing: pricing,
                            target: target
                        });
                    }
                });
                
                return products;
            } catch (error) {
                console.error('收集產品資料失敗:', error);
                return [];
            }
        }

        // 收集關鍵字資料
        function collectKeywordsData() {
            try {
                const primaryKeywords = document.getElementById('primary-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
                const longTailKeywords = document.getElementById('long-tail-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
                const keywordDepth = document.querySelector('input[name="keyword-depth"]:checked')?.value || 'standard';
                
                return {
                    primary: primaryKeywords,
                    longTail: longTailKeywords,
                    depth: keywordDepth
                };
            } catch (error) {
                console.error('收集關鍵字資料失敗:', error);
                return { primary: [], longTail: [], depth: 'standard' };
            }
        }

        // Google 認證處理 - 實作基本功能
        function handleGoogleAuth() {
            try {
                // 檢查是否已載入 Google API
                if (typeof gapi === 'undefined') {
                    showAlert('Google API 未載入', '請檢查網路連線並重新整理頁面', 'error');
                    return;
                }

                // 檢查 Google Client ID 是否已設定
                const clientId = 'YOUR_GOOGLE_CLIENT_ID'; // 需要設定你的 Google Client ID
                if (clientId === 'YOUR_GOOGLE_CLIENT_ID') {
                    showAlert('需要設定 Google Client ID', '請在程式碼中設定您的 Google Client ID 才能使用登入功能', 'warning');
                    return;
                }

                // 初始化 Google API
                gapi.load('auth2', function() {
                    gapi.auth2.init({
                        client_id: clientId
                    }).then(function(auth2) {
                        // 登入
                        auth2.signIn({
                            scope: 'https://www.googleapis.com/auth/drive.file'
                        }).then(function(googleUser) {
                            const profile = googleUser.getBasicProfile();
                            state.isAuthenticated = true;
                            state.userProfile = {
                                id: profile.getId(),
                                name: profile.getName(),
                                email: profile.getEmail(),
                                imageUrl: profile.getImageUrl()
                            };
                            
                            updateAuthUI();
                            showAlert('登入成功', `歡迎 ${profile.getName()}`, 'success');
                            
                            // 初始化 Google Drive API
                            initializeGoogleDrive();
                        }).catch(function(error) {
                            console.error('Google 登入失敗:', error);
                            showAlert('登入失敗', 'Google 登入失敗，請重試', 'error');
                        });
                    }).catch(function(error) {
                        console.error('Google API 初始化失敗:', error);
                        showAlert('初始化失敗', 'Google API 初始化失敗，請檢查 Client ID 設定', 'error');
                    });
                });
            } catch (error) {
                console.error('Google 認證失敗:', error);
                showAlert('認證失敗', error.message, 'error');
            }
        }

        // 登出處理
        function handleSignOut() {
            try {
                if (typeof gapi !== 'undefined' && gapi.auth2) {
                    const auth2 = gapi.auth2.getAuthInstance();
                    auth2.signOut().then(function() {
                        state.isAuthenticated = false;
                        state.userProfile = null;
                        updateAuthUI();
                        showAlert('已登出', '您已成功登出 Google 帳戶', 'info');
                    });
                } else {
                    state.isAuthenticated = false;
                    state.userProfile = null;
                    updateAuthUI();
                    showAlert('已登出', '您已成功登出', 'info');
                }
            } catch (error) {
                console.error('登出失敗:', error);
                showAlert('登出失敗', '登出過程中發生錯誤', 'error');
            }
        }

        // 更新認證 UI
        function updateAuthUI() {
            try {
                const userProfile = document.getElementById('user-profile');
                const authorizeBtn = document.getElementById('authorize_button');
                const signoutBtn = document.getElementById('signout_button');
                const userAvatar = document.getElementById('user-avatar');
                const userName = document.getElementById('user-name');

                if (state.isAuthenticated && state.userProfile) {
                    // 顯示用戶資訊
                    if (userProfile) userProfile.classList.remove('hidden');
                    if (authorizeBtn) authorizeBtn.classList.add('hidden');
                    if (signoutBtn) signoutBtn.classList.remove('hidden');
                    
                    if (userAvatar && state.userProfile.imageUrl) {
                        userAvatar.src = state.userProfile.imageUrl;
                    }
                    if (userName) {
                        userName.textContent = state.userProfile.name;
                    }
                } else {
                    // 顯示登入按鈕
                    if (userProfile) userProfile.classList.add('hidden');
                    if (authorizeBtn) authorizeBtn.classList.remove('hidden');
                    if (signoutBtn) signoutBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error('更新認證 UI 失敗:', error);
            }
        }

        // 初始化 Google Drive API
        function initializeGoogleDrive() {
            try {
                if (!state.isAuthenticated) {
                    console.warn('用戶未登入，無法初始化 Google Drive API');
                    return;
                }

                // 載入 Google Drive API
                gapi.load('client', function() {
                    gapi.client.init({
                        apiKey: state.settings.googleApiKey,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    }).then(function() {
                        console.log('Google Drive API 初始化成功');
                        showAlert('Google Drive 已準備就緒', '可以開始使用檔案儲存功能', 'success');
                    }).catch(function(error) {
                        console.error('Google Drive API 初始化失敗:', error);
                        showAlert('Google Drive 初始化失敗', '請檢查 API 金鑰設定', 'error');
                    });
                });
            } catch (error) {
                console.error('初始化 Google Drive 失敗:', error);
                showAlert('Google Drive 初始化失敗', error.message, 'error');
            }
        }

        // 儲存檔案到 Google Drive
        function saveFileToGoogleDrive(fileName, content, mimeType = 'text/plain') {
            return new Promise((resolve, reject) => {
                try {
                    if (!state.isAuthenticated) {
                        reject(new Error('用戶未登入'));
                        return;
                    }

                    // 檢查是否已初始化 Google Drive API
                    if (!gapi.client.drive) {
                        reject(new Error('Google Drive API 未初始化'));
                        return;
                    }

                    // 建立檔案中繼資料
                    const fileMetadata = {
                        name: fileName,
                        mimeType: mimeType,
                        parents: [] // 可以指定資料夾 ID
                    };

                    // 建立檔案內容
                    const fileContent = content;

                    // 上傳檔案
                    gapi.client.drive.files.create({
                        resource: fileMetadata,
                        media: {
                            mimeType: mimeType,
                            body: fileContent
                        }
                    }).then(function(response) {
                        console.log('檔案上傳成功:', response.result);
                        resolve(response.result);
                    }).catch(function(error) {
                        console.error('檔案上傳失敗:', error);
                        reject(error);
                    });
                } catch (error) {
                    console.error('儲存檔案到 Google Drive 失敗:', error);
                    reject(error);
                }
            });
        }

        // 更新儲存到 Google Drive 函數
        function saveToGoogleDrive() {
            try {
                if (!state.isAuthenticated) {
                    showAlert('請先登入', '需要 Google 帳戶授權才能儲存到 Drive', 'warning');
                    return;
                }
                
                showAlert('儲存中', '正在儲存報告到 Google Drive...', 'info');
                
                // 獲取報告內容
                const reportContent = document.getElementById('final-report-content').innerText;
                const projectId = document.getElementById('project-id')?.value || 'TEMP_' + Date.now();
                const fileName = `市場情資分析報告_${projectId}_${new Date().toISOString().split('T')[0]}.txt`;
                
                // 儲存到 Google Drive
                saveFileToGoogleDrive(fileName, reportContent, 'text/plain')
                    .then(() => {
                        showAlert('儲存成功', '報告已儲存到 Google Drive', 'success');
                    })
                    .catch((error) => {
                        console.error('儲存到 Google Drive 失敗:', error);
                        showAlert('儲存失敗', '無法儲存到 Google Drive，請重試', 'error');
                    });
                
            } catch (error) {
                console.error('儲存到 Google Drive 失敗:', error);
                showAlert('儲存失敗', '無法儲存到 Google Drive，請重試', 'error');
            }
        }

        // 搜尋競爭對手
        function searchCompetitors() {
            try {
                if (!state.analysisData.topic || !state.analysisData.brand) {
                    console.warn('沒有分析主題或品牌資訊，無法搜尋競爭對手');
                    return;
                }

                // 基於行業類別和品牌資訊生成更精確的競爭對手
                const industryCategory = state.analysisData.industry.category;
                const brandName = state.analysisData.brand.name;
                const topic = state.analysisData.topic;

                // 根據不同行業生成相關競爭對手
                let mockCompetitors = [];
                
                switch (industryCategory) {
                    case 'ecommerce':
                        mockCompetitors = [
                            { 
                                name: '蝦皮購物 (Shopee)', 
                                description: '東南亞最大電商平台，C2C 和 B2C 模式，母公司為 Sea Group', 
                                website: 'https://shopee.tw', 
                                linkedin: 'https://linkedin.com/company/shopee',
                                founded: '2015',
                                employees: '10,000+',
                                revenue: '數十億美元',
                                marketShare: '東南亞電商領導者',
                                strengths: '行動優先、社交電商、東南亞市場優勢',
                                weaknesses: '獲利能力待改善、競爭激烈'
                            },
                            { 
                                name: 'PChome 網路家庭', 
                                description: '台灣老牌電商平台，3C 產品起家，台灣電商先驅', 
                                website: 'https://pchome.com.tw', 
                                linkedin: 'https://linkedin.com/company/pchome',
                                founded: '1998',
                                employees: '1,000+',
                                revenue: '數百億台幣',
                                marketShare: '台灣電商前三名',
                                strengths: '3C 產品優勢、物流體系完整、品牌知名度高',
                                weaknesses: '轉型速度較慢、行動化不足'
                            },
                            { 
                                name: 'momo 富邦媒體', 
                                description: '台灣電商龍頭，電視購物轉型成功，富邦集團旗下', 
                                website: 'https://momoshop.com.tw', 
                                linkedin: 'https://linkedin.com/company/momo',
                                founded: '2004',
                                employees: '2,000+',
                                revenue: '千億台幣',
                                marketShare: '台灣電商第一名',
                                strengths: '電視購物基礎、物流配送快速、商品種類豐富',
                                weaknesses: '電視購物形象包袱、獲利模式單一'
                            },
                            { 
                                name: 'Yahoo 奇摩購物', 
                                description: '入口網站電商，搜尋流量優勢，Verizon Media 旗下', 
                                website: 'https://tw.buy.yahoo.com', 
                                linkedin: 'https://linkedin.com/company/yahoo',
                                founded: '1994',
                                employees: '全球 10,000+',
                                revenue: '數十億美元',
                                marketShare: '台灣電商前五名',
                                strengths: '搜尋流量優勢、入口網站整合、品牌信任度高',
                                weaknesses: '母公司策略變動、創新速度較慢'
                            },
                            { 
                                name: '露天拍賣', 
                                description: 'PChome 旗下 C2C 平台，台灣最大拍賣網站', 
                                website: 'https://www.ruten.com.tw', 
                                linkedin: 'https://linkedin.com/company/ruten',
                                founded: '2006',
                                employees: '500+',
                                revenue: '數十億台幣',
                                marketShare: '台灣 C2C 領導者',
                                strengths: 'C2C 平台優勢、PChome 資源整合、用戶基礎龐大',
                                weaknesses: '假貨問題、平台管理挑戰'
                            }
                        ];
                        break;
                    case 'saas':
                        mockCompetitors = [
                            { 
                                name: 'Microsoft 365', 
                                description: '企業辦公軟體套件，雲端協作，微軟核心產品', 
                                website: 'https://microsoft.com', 
                                linkedin: 'https://linkedin.com/company/microsoft',
                                founded: '1975',
                                employees: '200,000+',
                                revenue: '數千億美元',
                                marketShare: '企業軟體領導者',
                                strengths: '企業客戶基礎龐大、產品整合度高、品牌信任度極高',
                                weaknesses: '創新速度較慢、價格較高'
                            },
                            { 
                                name: 'Google Workspace', 
                                description: 'Google 企業服務，Gmail 生態系，雲端原生', 
                                website: 'https://workspace.google.com', 
                                linkedin: 'https://linkedin.com/company/google',
                                founded: '1998',
                                employees: '150,000+',
                                revenue: '數千億美元',
                                marketShare: '雲端辦公領導者',
                                strengths: '雲端原生、AI 整合、免費版本優勢',
                                weaknesses: '企業功能相對不足、隱私疑慮'
                            },
                            { 
                                name: 'Slack Technologies', 
                                description: '團隊溝通協作平台，企業即時通訊領導者', 
                                website: 'https://slack.com', 
                                linkedin: 'https://linkedin.com/company/slack',
                                founded: '2009',
                                employees: '2,000+',
                                revenue: '數億美元',
                                marketShare: '企業通訊領導者',
                                strengths: '用戶體驗優秀、整合能力強、企業採用率高',
                                weaknesses: '獲利能力待改善、競爭激烈'
                            },
                            { 
                                name: 'Notion Labs', 
                                description: '全能筆記和協作平台，知識管理工具', 
                                website: 'https://notion.so', 
                                linkedin: 'https://linkedin.com/company/notion',
                                founded: '2016',
                                employees: '500+',
                                revenue: '數億美元',
                                marketShare: '知識管理新興領導者',
                                strengths: '功能強大、用戶體驗優秀、年輕用戶基礎',
                                weaknesses: '學習曲線陡峭、企業功能待完善'
                            },
                            { 
                                name: 'Zoom Video Communications', 
                                description: '視訊會議平台領導者，疫情期間快速成長', 
                                website: 'https://zoom.us', 
                                linkedin: 'https://linkedin.com/company/zoom-video-communications',
                                founded: '2011',
                                employees: '5,000+',
                                revenue: '數十億美元',
                                marketShare: '視訊會議領導者',
                                strengths: '易用性、穩定性、疫情期間快速成長',
                                weaknesses: '安全性疑慮、競爭激烈'
                            }
                        ];
                        break;
                    case 'fintech':
                        mockCompetitors = [
                            { 
                                name: 'Square (Block)', 
                                description: '支付處理和金融服務平台，小企業金融解決方案', 
                                website: 'https://squareup.com', 
                                linkedin: 'https://linkedin.com/company/square',
                                founded: '2009',
                                employees: '8,000+',
                                revenue: '數十億美元',
                                marketShare: '小企業支付領導者',
                                strengths: '小企業專注、硬體整合、生態系統完整',
                                weaknesses: '大企業市場有限、獲利能力待改善'
                            },
                            { 
                                name: 'Stripe', 
                                description: '線上支付處理平台，開發者友好的 API', 
                                website: 'https://stripe.com', 
                                linkedin: 'https://linkedin.com/company/stripe',
                                founded: '2010',
                                employees: '7,000+',
                                revenue: '數十億美元',
                                marketShare: '線上支付領導者',
                                strengths: '開發者友好、全球覆蓋、技術領先',
                                weaknesses: '價格較高、競爭激烈'
                            },
                            { 
                                name: 'PayPal', 
                                description: '全球支付平台，電子商務支付領導者', 
                                website: 'https://paypal.com', 
                                linkedin: 'https://linkedin.com/company/paypal',
                                founded: '1998',
                                employees: '30,000+',
                                revenue: '數百億美元',
                                marketShare: '全球支付領導者',
                                strengths: '品牌知名度高、全球覆蓋、用戶基礎龐大',
                                weaknesses: '創新速度較慢、費用較高'
                            },
                            { 
                                name: 'Robinhood', 
                                description: '零佣金股票交易平台，年輕投資者首選', 
                                website: 'https://robinhood.com', 
                                linkedin: 'https://linkedin.com/company/robinhood',
                                founded: '2013',
                                employees: '3,000+',
                                revenue: '數億美元',
                                marketShare: '零佣金交易領導者',
                                strengths: '零佣金、用戶體驗優秀、年輕用戶基礎',
                                weaknesses: '功能相對簡單、監管風險'
                            },
                            { 
                                name: 'Coinbase', 
                                description: '加密貨幣交易平台，數位資產交易所', 
                                website: 'https://coinbase.com', 
                                linkedin: 'https://linkedin.com/company/coinbase',
                                founded: '2012',
                                employees: '3,000+',
                                revenue: '數十億美元',
                                marketShare: '加密貨幣交易領導者',
                                strengths: '合規性強、用戶信任度高、機構客戶基礎',
                                weaknesses: '監管風險、市場波動性大'
                            }
                        ];
                        break;
                    case 'marketing':
                        mockCompetitors = [
                            { 
                                name: 'HubSpot', 
                                description: '全方位行銷自動化平台，CRM 整合', 
                                website: 'https://hubspot.com', 
                                linkedin: 'https://linkedin.com/company/hubspot',
                                founded: '2006',
                                employees: '7,000+',
                                revenue: '數十億美元',
                                marketShare: '行銷自動化領導者',
                                strengths: '全方位解決方案、用戶體驗優秀、內容行銷強',
                                weaknesses: '價格較高、學習曲線陡峭'
                            },
                            { 
                                name: 'Mailchimp', 
                                description: '電子郵件行銷平台，小企業首選', 
                                website: 'https://mailchimp.com', 
                                linkedin: 'https://linkedin.com/company/mailchimp',
                                founded: '2001',
                                employees: '1,200+',
                                revenue: '數億美元',
                                marketShare: '電子郵件行銷領導者',
                                strengths: '易用性、小企業專注、價格實惠',
                                weaknesses: '功能相對簡單、企業功能不足'
                            },
                            { 
                                name: 'Canva', 
                                description: '線上設計平台，視覺內容創作工具', 
                                website: 'https://canva.com', 
                                linkedin: 'https://linkedin.com/company/canva',
                                founded: '2012',
                                employees: '3,000+',
                                revenue: '數億美元',
                                marketShare: '線上設計領導者',
                                strengths: '易用性、模板豐富、協作功能強',
                                weaknesses: '專業功能相對不足、版權問題'
                            },
                            { 
                                name: 'Hootsuite', 
                                description: '社群媒體管理平台，多平台整合', 
                                website: 'https://hootsuite.com', 
                                linkedin: 'https://linkedin.com/company/hootsuite',
                                founded: '2008',
                                employees: '1,000+',
                                revenue: '數億美元',
                                marketShare: '社群媒體管理領導者',
                                strengths: '多平台整合、企業功能完整、分析工具強',
                                weaknesses: '價格較高、用戶體驗待改善'
                            },
                            { 
                                name: 'Buffer', 
                                description: '社群媒體排程工具，簡潔易用', 
                                website: 'https://buffer.com', 
                                linkedin: 'https://linkedin.com/company/buffer',
                                founded: '2010',
                                employees: '100+',
                                revenue: '數千萬美元',
                                marketShare: '社群媒體工具新興領導者',
                                strengths: '簡潔易用、價格實惠、用戶體驗優秀',
                                weaknesses: '功能相對簡單、企業功能不足'
                            }
                        ];
                        break;
                    default:
                        // 通用競爭對手
                        mockCompetitors = [
                            { 
                                name: '競爭對手 A', 
                                description: '主要競爭對手，市占率約 30%，行業領導者', 
                                website: 'https://competitor-a.com', 
                                linkedin: 'https://linkedin.com/company/competitor-a',
                                founded: '2010',
                                employees: '5,000+',
                                revenue: '數十億美元',
                                marketShare: '行業領導者',
                                strengths: '品牌知名度高、資源豐富、技術領先',
                                weaknesses: '創新速度較慢、官僚化嚴重'
                            },
                            { 
                                name: '競爭對手 B', 
                                description: '新興競爭對手，成長快速，創新能力強', 
                                website: 'https://competitor-b.com', 
                                linkedin: 'https://linkedin.com/company/competitor-b',
                                founded: '2018',
                                employees: '500+',
                                revenue: '數億美元',
                                marketShare: '新興領導者',
                                strengths: '創新能力強、反應速度快、用戶體驗優秀',
                                weaknesses: '資源相對有限、品牌知名度待提升'
                            },
                            { 
                                name: '競爭對手 C', 
                                description: '傳統競爭對手，品牌知名度高，市場穩定', 
                                website: 'https://competitor-c.com', 
                                linkedin: 'https://linkedin.com/company/competitor-c',
                                founded: '2005',
                                employees: '2,000+',
                                revenue: '數十億美元',
                                marketShare: '傳統領導者',
                                strengths: '品牌信任度高、客戶基礎穩定、資源豐富',
                                weaknesses: '轉型困難、創新不足'
                            },
                            { 
                                name: '競爭對手 D', 
                                description: '技術領先的競爭對手，研發投入大', 
                                website: 'https://competitor-d.com', 
                                linkedin: 'https://linkedin.com/company/competitor-d',
                                founded: '2012',
                                employees: '1,500+',
                                revenue: '數億美元',
                                marketShare: '技術領導者',
                                strengths: '技術實力強、研發投入大、專利優勢',
                                weaknesses: '商業化能力待改善、用戶體驗不足'
                            },
                            { 
                                name: '競爭對手 E', 
                                description: '價格競爭對手，主打性價比，市場份額穩定', 
                                website: 'https://competitor-e.com', 
                                linkedin: 'https://linkedin.com/company/competitor-e',
                                founded: '2015',
                                employees: '800+',
                                revenue: '數億美元',
                                marketShare: '價格領導者',
                                strengths: '價格優勢、性價比高、市場反應快',
                                weaknesses: '獲利能力有限、品牌價值待提升'
                            }
                        ];
                }

                // 過濾掉與自身品牌相同的競爭對手
                mockCompetitors = mockCompetitors.filter(comp => 
                    comp.name.toLowerCase() !== brandName.toLowerCase()
                );

                // 模擬搜尋延遲
                setTimeout(() => {
                    displaySearchResults(mockCompetitors);
                }, 2000);

            } catch (error) {
                console.error('搜尋競爭對手失敗:', error);
            }
        }

        // 顯示搜尋結果
        function displaySearchResults(competitors) {
            try {
                const resultsContainer = document.getElementById('auto-search-results');
                if (!resultsContainer) return;

                let html = '';
                competitors.forEach((competitor, index) => {
                    html += `
                        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h5 class="font-semibold text-gray-200 text-lg">${competitor.name}</h5>
                                    <p class="text-sm text-gray-400 mb-2">${competitor.description}</p>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-gray-500">
                                        <div>成立：${competitor.founded}</div>
                                        <div>員工：${competitor.employees}</div>
                                        <div>營收：${competitor.revenue}</div>
                                        <div>市占：${competitor.marketShare}</div>
                                    </div>
                                    <div class="mt-2">
                                        <div class="text-xs text-green-400 mb-1">優勢：${competitor.strengths}</div>
                                        <div class="text-xs text-red-400">弱勢：${competitor.weaknesses}</div>
                                    </div>
                                </div>
                                <button class="add-competitor-btn bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded text-sm ml-4" 
                                        data-competitor="${competitor.name}" 
                                        data-description="${competitor.description}" 
                                        data-website="${competitor.website || ''}" 
                                        data-linkedin="${competitor.linkedin || ''}"
                                        data-founded="${competitor.founded}"
                                        data-employees="${competitor.employees}"
                                        data-revenue="${competitor.revenue}"
                                        data-marketShare="${competitor.marketShare}"
                                        data-strengths="${competitor.strengths}"
                                        data-weaknesses="${competitor.weaknesses}">
                                    添加
                                </button>
                            </div>
                            <div class="flex gap-2">
                                ${competitor.website ? `<a href="${competitor.website}" target="_blank" class="text-blue-400 hover:text-blue-300 text-xs">🌐 官網</a>` : ''}
                                ${competitor.linkedin ? `<a href="${competitor.linkedin}" target="_blank" class="text-blue-400 hover:text-blue-300 text-xs">💼 LinkedIn</a>` : ''}
                            </div>
                        </div>
                    `;
                });

                resultsContainer.innerHTML = html;

                // 為添加按鈕添加事件監聽器
                const addButtons = resultsContainer.querySelectorAll('.add-competitor-btn');
                addButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const competitorData = {
                            name: this.dataset.competitor,
                            description: this.dataset.description,
                            website: this.dataset.website,
                            linkedin: this.dataset.linkedin,
                            founded: this.dataset.founded,
                            employees: this.dataset.employees,
                            revenue: this.dataset.revenue,
                            marketShare: this.dataset.marketShare,
                            strengths: this.dataset.strengths,
                            weaknesses: this.dataset.weaknesses
                        };
                        
                        addCompetitorToList(
                            competitorData.name,
                            competitorData.description,
                            competitorData.website,
                            competitorData.linkedin,
                            competitorData.founded,
                            competitorData.employees,
                            competitorData.revenue,
                            competitorData.marketShare,
                            competitorData.strengths,
                            competitorData.weaknesses
                        );
                        
                        this.disabled = true;
                        this.textContent = '已添加';
                        this.classList.remove('bg-techprimary', 'hover:bg-techaccent');
                        this.classList.add('bg-gray-600');
                    });
                });

            } catch (error) {
                console.error('顯示搜尋結果失敗:', error);
            }
        }
    </script>
    <style>
        /* Base styling and animations */
        body { font-family: "Segoe UI", Roboto, Arial, sans-serif; }
        .tab-main.active { border-color: #2EE9E4; background-color: #181D27; color: #2EE9E4; }
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.5s ease; }
        .locked { opacity: 0.5; pointer-events: none; }
        .spinner { border: 4px solid rgba(59,130,246,.2); width: 36px; height: 36px; border-radius: 50%; border-left-color: #2EE9E4; animation: spin 1s ease infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Table and result panel styling */
        th, td { padding: 12px 15px; }
        .result-panel { max-height: 65vh; overflow-y: auto; }
        .overflow-x-auto { overflow-x: auto; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #181D27; }
        ::-webkit-scrollbar-thumb { background: #3762F0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #7D5FFF; }

        /* Stepper UI */
        .stepper-container { display: flex; justify-content: space-between; margin-bottom: 1.5rem; }
        .step { flex: 1; text-align: center; position: relative; }
        .step-circle { width: 32px; height: 32px; line-height: 30px; border-radius: 50%; background-color: #22283A; color: #fff; display: inline-block; border: 2px solid #3762F0; font-weight: bold; cursor: pointer; transition: all .3s ease; }
        .step-title { margin-top: 0.5rem; font-size: 0.875rem; color: #9ca3af; }
        .step-line { position: absolute; top: 16px; left: 50%; width: 100%; height: 2px; background-color: #3762F0; z-index: -1; }
        .step:first-child .step-line { left: 50%; width: 50%; }
        .step:last-child .step-line { left: 0; width: 50%;}
        
        .step.active .step-circle { background-color: #3762F0; color: #fff; border-color: #2EE9E4; transform: scale(1.1); }
        .step.active .step-title { color: #2EE9E4; font-weight: bold; }
        .step.completed .step-circle { background-color: #2EE9E4; color: #181D27; border-color: #2EE9E4; }
        .step.completed .step-title { color: #d1d5db; }

        /* Badge Styles */
        .badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-weight: 600; font-size: 0.75rem; }
        .badge-high { background-color: #ef4444; color: white; }
        .badge-mid { background-color: #f97316; color: white; }
        .badge-low { background-color: #22c55e; color: white; }
        .badge-unknown { background-color: #6b7280; color: white; }

        /* Dashboard Cards */
        .dashboard-card { background: linear-gradient(135deg, #22283A 0%, #1a1f2e 100%); border: 1px solid #3762F0; border-radius: 12px; padding: 1.5rem; }
        .metric-value { font-size: 2rem; font-weight: bold; color: #2EE9E4; }
        .metric-label { color: #9ca3af; font-size: 0.875rem; margin-top: 0.5rem; }

        /* Comparison Table */
        .comparison-table { border-collapse: separate; border-spacing: 0; }
        .comparison-table th { background: #1a1f2e; border: 1px solid #3762F0; padding: 12px; }
        .comparison-table td { border: 1px solid #3762F0; padding: 12px; }
        .comparison-table tr:nth-child(even) { background: rgba(55, 98, 240, 0.05); }

        /* Chart Container */
        .chart-container { position: relative; height: 300px; margin: 1rem 0; }
    </style>
</head>
<body class="bg-techbg font-tech text-gray-100 min-h-screen">
    <!-- Header Section -->
    <header class="bg-techpanel shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold tracking-wide text-techaccent flex items-center gap-2">
                <svg class="w-8 h-8 text-techprimary inline-block" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364-7.364l-1.414 1.414M6.05 17.95l-1.414 1.414m12.728 0l1.414-1.414M6.05 6.05L4.636 4.636" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                市場情資與競品分析平台
            </h1>
            <div id="auth-container">
                <div class="flex items-center gap-4">
                    <div id="user-profile" class="hidden items-center gap-3">
                        <img id="user-avatar" class="w-10 h-10 rounded-full" src="" alt="User Avatar">
                        <span id="user-name" class="font-semibold text-gray-200"></span>
                        <button id="signout_button" class="text-sm text-gray-400 hover:text-techaccent">登出</button>
                    </div>
                </div>
                <div class="text-xs text-yellow-400 mt-2">※ 需授權 Google Drive 全權限才能正確儲存資料</div>
            </div>
        </div>
    </header>

    <div id="alert-container" class="fixed top-24 right-6 z-50"></div>

    <main class="container mx-auto px-6 py-8">
        <div id="app-container" class="locked">
            <!-- Main Tabs -->
            <div class="flex border-b border-techprimary/20 mb-6">
                <button data-tab="analysis" class="tab-main tab-btn active flex-1 p-4 font-semibold">分析系統</button>
                <button data-tab="settings" class="tab-main tab-btn flex-1 p-4 font-semibold">API 設定</button>
                <button data-tab="history" class="tab-main tab-btn flex-1 p-4 font-semibold">歷史紀錄</button>
            </div>

            <!-- API 設定面板 -->
            <div id="settings-panel" class="panel">
                <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8 max-w-lg mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-techaccent text-center">API 與應用程式設定</h2>
                    <div class="space-y-4">
                        <div><label for="google-api-key" class="block text-sm font-medium text-gray-300">Google API 金鑰</label><input type="password" id="google-api-key" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="填寫 Gemini/Custom Search API Key"></div>
                        <div><label for="search-engine-id" class="block text-sm font-medium text-gray-300">可程式化搜尋引擎 ID (CX)</label><input type="text" id="search-engine-id" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="填寫 Custom Search Engine ID"></div>
                        
                        <!-- Google 登入設定說明 -->
                        <div class="border-t border-techprimary/30 pt-4 mt-6">
                            <h3 class="text-lg font-semibold text-techaccent mb-4">🔐 Google 登入設定</h3>
                            <div class="bg-yellow-900/20 border border-yellow-600/30 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-yellow-400 mb-2">⚠️ 重要提醒</h4>
                                <p class="text-sm text-gray-300 mb-3">要使用 Google Drive 儲存功能，您需要：</p>
                                <ol class="text-sm text-gray-300 space-y-1 list-decimal list-inside">
                                    <li>在 Google Cloud Console 建立專案</li>
                                    <li>啟用 Google Drive API 和 Google+ API</li>
                                    <li>建立 OAuth 2.0 憑證</li>
                                    <li>將 Client ID 填入程式碼中</li>
                                </ol>
                                <div class="mt-3 p-3 bg-gray-800 rounded text-xs">
                                    <p class="text-gray-400 mb-2">目前程式碼中的 Client ID 設定位置：</p>
                                    <code class="text-green-400">handleGoogleAuth() 函數中的 'YOUR_GOOGLE_CLIENT_ID'</code>
                                </div>
                            </div>
                            <div class="text-center">
                                <button id="authorize_button" class="bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-6 py-3 rounded-lg shadow-lg">
                                    🔐 登入 Google
                                </button>
                                <p class="text-xs text-gray-400 mt-2">點擊登入以測試 Google 認證功能</p>
                            </div>
                        </div>
                        
                        <!-- 集中化資料夾管理設定 -->
                        <div class="border-t border-techprimary/30 pt-4 mt-6">
                            <h3 class="text-lg font-semibold text-techaccent mb-4">📁 集中化資料夾管理</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="central-folder-name" class="block text-sm font-medium text-gray-300">主要專案資料夾名稱</label>
                                    <input type="text" id="central-folder-name" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="iStaging_專案管理" placeholder="例如: iStaging_專案管理">
                                    <p class="text-xs text-gray-400 mt-1">此資料夾將包含所有專案的子資料夾</p>
                                </div>
                                <div>
                                    <label for="intelligence-subfolder" class="block text-sm font-medium text-gray-300">市場情資子資料夾名稱</label>
                                    <input type="text" id="intelligence-subfolder" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="01_市場情資分析" placeholder="例如: 01_市場情資分析">
                                </div>
                                <div>
                                    <label for="mediaplan-subfolder" class="block text-sm font-medium text-gray-300">媒體提案子資料夾名稱</label>
                                    <input type="text" id="mediaplan-subfolder" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="02_媒體提案" placeholder="例如: 02_媒體提案">
                                </div>
                                <div>
                                    <label for="workflow-subfolder" class="block text-sm font-medium text-gray-300">工作流程子資料夾名稱</label>
                                    <input type="text" id="workflow-subfolder" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="03_工作流程文件" placeholder="例如: 03_工作流程文件">
                                </div>
                            </div>
                        </div>
                        
                        <button id="save-settings-btn" class="w-full bg-gradient-to-tr from-techprimary to-techaccent font-bold text-white px-5 py-3 rounded-lg shadow-lg mt-6">儲存設定</button>
                    </div>
                </section>
            </div>

            <!-- 分析系統面板 -->
            <div id="analysis-panel" class="panel">
                <!-- Stepper -->
                <div class="stepper-container mb-8">
                    <div id="step-1" class="step active">
                        <div class="step-circle">1</div>
                        <div class="step-title">分析設定</div>
                        <div class="step-line"></div>
                    </div>
                    <div id="step-2" class="step">
                        <div class="step-circle">2</div>
                        <div class="step-title">對手篩選與補充</div>
                        <div class="step-line"></div>
                    </div>
                    <div id="step-3" class="step">
                        <div class="step-circle">3</div>
                        <div class="step-title">完整報告</div>
                    </div>
                </div>

                <!-- Step 1: 分析設定 -->
                <div id="step-1-content" class="step-panel">
                    <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8">
                        <h2 class="text-2xl font-bold mb-6 text-techaccent">📊 品牌與市場分析設定</h2>
                        
                        <!-- Project ID 輸入 -->
                        <div class="mb-6">
                            <label for="project-id" class="block text-sm font-medium text-gray-300 mb-2">專案 ID (可選)</label>
                            <input type="text" id="project-id" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="請輸入專案 ID (可選)">
                            <p class="text-xs text-gray-400 mt-1">此 ID 將用於檔案命名和資料夾組織。如無專案ID，系統將自動產生臨時ID</p>
                        </div>

                        <!-- 自身品牌資訊 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-techaccent mb-4">🏢 自身品牌資訊</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="brand-name" class="block text-sm font-medium text-gray-300 mb-2">品牌名稱 *</label>
                                    <input type="text" id="brand-name" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="您的品牌名稱" required>
                                </div>
                                <div>
                                    <label for="brand-website" class="block text-sm font-medium text-gray-300 mb-2">品牌官網</label>
                                    <input type="url" id="brand-website" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="https://your-brand.com">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="brand-description" class="block text-sm font-medium text-gray-300 mb-2">品牌描述</label>
                                <textarea id="brand-description" rows="3" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="簡述您的品牌定位、核心產品/服務、目標客群等"></textarea>
                            </div>
                        </div>

                        <!-- 產品/服務分析 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-techaccent mb-4">📦 核心產品/服務</h3>
                            <div id="products-container">
                                <div class="product-item bg-gray-800 rounded-lg p-4 mb-3">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">產品/服務名稱</label>
                                            <input type="text" class="product-name w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="主要產品名稱">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">價格定位</label>
                                            <select class="product-pricing w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                                                <option value="">選擇價格定位</option>
                                                <option value="premium">高價位 (Premium)</option>
                                                <option value="mid-high">中高價位</option>
                                                <option value="mid">中價位</option>
                                                <option value="mid-low">中低價位</option>
                                                <option value="budget">平價 (Budget)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">目標客群</label>
                                            <input type="text" class="product-target w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="目標客群描述">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button id="add-product-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded-lg text-sm">+ 添加產品/服務</button>
                        </div>

                        <!-- 行業與市場分析 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-techaccent mb-4">🎯 行業與市場分析</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="industry-category" class="block text-sm font-medium text-gray-300 mb-2">行業類別 *</label>
                                    <select id="industry-category" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" required>
                                        <option value="">選擇行業類別</option>
                                        <option value="ecommerce">電商平台</option>
                                        <option value="saas">SaaS/軟體服務</option>
                                        <option value="fintech">金融科技</option>
                                        <option value="healthcare">醫療健康</option>
                                        <option value="education">教育科技</option>
                                        <option value="marketing">數位行銷</option>
                                        <option value="ai-ml">AI/機器學習</option>
                                        <option value="gaming">遊戲娛樂</option>
                                        <option value="food-delivery">外送服務</option>
                                        <option value="travel">旅遊服務</option>
                                        <option value="real-estate">房地產</option>
                                        <option value="automotive">汽車產業</option>
                                        <option value="fashion">時尚服飾</option>
                                        <option value="beauty">美妝保養</option>
                                        <option value="other">其他</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="market-size" class="block text-sm font-medium text-gray-300 mb-2">市場規模</label>
                                    <select id="market-size" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20">
                                        <option value="">選擇市場規模</option>
                                        <option value="niche">利基市場 (小眾)</option>
                                        <option value="small">小型市場</option>
                                        <option value="medium">中型市場</option>
                                        <option value="large">大型市場</option>
                                        <option value="massive">超大市場</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="analysis-topic" class="block text-sm font-medium text-gray-300 mb-2">具體分析主題 *</label>
                                <input type="text" id="analysis-topic" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="例如：台灣電商平台、數位行銷工具、AI 聊天機器人等" required>
                                <p class="text-xs text-gray-400 mt-1">請具體描述您要分析的市場細分或產品類別，避免過於廣泛</p>
                            </div>
                        </div>

                        <!-- SEO 關鍵字策略 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-techaccent mb-4">🔍 SEO 關鍵字策略</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="primary-keywords" class="block text-sm font-medium text-gray-300 mb-2">主要關鍵字</label>
                                    <textarea id="primary-keywords" rows="3" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="輸入 3-5 個主要關鍵字，每行一個&#10;例如：&#10;電商平台&#10;線上購物&#10;網路商店"></textarea>
                                </div>
                                <div>
                                    <label for="long-tail-keywords" class="block text-sm font-medium text-gray-300 mb-2">長尾關鍵字</label>
                                    <textarea id="long-tail-keywords" rows="3" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="輸入 5-10 個長尾關鍵字，每行一個&#10;例如：&#10;台灣電商平台推薦&#10;小型企業電商解決方案&#10;B2B 電商平台比較"></textarea>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">關鍵字分析深度</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="radio" name="keyword-depth" value="basic" class="mr-2">
                                        <span class="text-sm">基礎分析 (搜尋量、競爭度)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="keyword-depth" value="standard" checked class="mr-2">
                                        <span class="text-sm">標準分析 (搜尋量、競爭度、出價建議)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="keyword-depth" value="comprehensive" class="mr-2">
                                        <span class="text-sm">深度分析 (搜尋量、競爭度、出價建議、內容策略)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 競爭對手數量 -->
                        <div class="mb-6">
                            <label for="competitor-count" class="block text-sm font-medium text-gray-300 mb-2">競爭對手分析數量</label>
                            <select id="competitor-count" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20">
                                <option value="5">5 個 (快速分析)</option>
                                <option value="10" selected>10 個 (標準分析)</option>
                                <option value="15">15 個 (詳細分析)</option>
                                <option value="20">20 個 (全面分析)</option>
                            </select>
                        </div>

                        <!-- 分析深度 -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-300 mb-2">競爭對手分析深度</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="analysis-depth" value="basic" class="mr-2">
                                    <span class="text-sm">基礎分析 (基本資訊、產品比較)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="analysis-depth" value="standard" checked class="mr-2">
                                    <span class="text-sm">標準分析 (詳細資訊、SWOT 分析、行銷策略)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="analysis-depth" value="comprehensive" class="mr-2">
                                    <span class="text-sm">深度分析 (財務分析、技術實力、未來發展預測)</span>
                                </label>
                            </div>
                        </div>

                        <button id="start-analysis-btn" class="w-full bg-gradient-to-tr from-techprimary to-techaccent font-bold text-white px-6 py-3 rounded-lg shadow-lg">開始分析</button>
                    </section>
                </div>

                <!-- Step 2: 對手篩選與補充 -->
                <div id="step-2-content" class="step-panel" style="display: none;">
                    <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8">
                        <h2 class="text-2xl font-bold mb-6 text-techaccent">🎯 對手篩選與補充</h2>
                        <div id="competitor-selection-content">
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-gray-200 mb-4">分析主題：<span id="current-topic" class="text-techaccent"></span></h3>
                                <p class="text-gray-400 mb-4">系統將自動搜尋並分析相關競爭對手，您也可以手動添加或移除競爭對手。</p>
                            </div>

                            <!-- 自動搜尋結果 -->
                            <div class="mb-6">
                                <h4 class="text-md font-semibold text-gray-200 mb-3">🔍 自動搜尋結果</h4>
                                <div id="auto-search-results" class="space-y-3">
                                    <div class="flex items-center justify-center py-8">
                                        <div class="spinner"></div>
                                        <span class="ml-3 text-gray-400">正在搜尋競爭對手...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 手動添加競爭對手 -->
                            <div class="mb-6">
                                <h4 class="text-md font-semibold text-gray-200 mb-3">➕ 手動添加競爭對手</h4>
                                <div class="flex gap-2 mb-3">
                                    <input type="text" id="manual-competitor" class="flex-1 px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="輸入競爭對手名稱">
                                    <button id="add-competitor-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded-lg">添加</button>
                                </div>
                            </div>

                            <!-- 已選擇的競爭對手 -->
                            <div class="mb-6">
                                <h4 class="text-md font-semibold text-gray-200 mb-3">📋 已選擇的競爭對手 (<span id="selected-count">0</span>)</h4>
                                <div id="selected-competitors" class="space-y-2">
                                    <p class="text-gray-500 text-sm">尚未選擇任何競爭對手</p>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <button id="generate-report-btn" class="bg-gradient-to-tr from-techprimary to-techaccent font-bold text-white px-6 py-3 rounded-lg shadow-lg" disabled>生成完整報告</button>
                                <button id="back-to-step1-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg">返回步驟 1</button>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Step 3: 完整報告 -->
                <div id="step-3-content" class="step-panel" style="display: none;">
                    <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8">
                        <h2 class="text-2xl font-bold mb-6 text-techaccent">📋 完整報告</h2>
                        <div id="final-report-content">
                            <p class="text-gray-400">請先完成步驟 2 的對手篩選</p>
                        </div>
                    </section>
                </div>
            </div>

            <!-- 歷史紀錄面板 -->
            <div id="history-panel" class="panel">
                <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8">
                    <h2 class="text-2xl font-bold mb-6 text-techaccent">📚 歷史紀錄</h2>
                    <div id="history-content">
                        <p class="text-gray-400">歷史紀錄功能開發中...</p>
                    </div>
                </section>
            </div>
        </div>
    </main>
</body>
</html>
