<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>å¸‚å ´æƒ…è³‡èˆ‡ç«¶å“åˆ†æå¹³å° (V6 - é€²éšåˆ†æç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Tailwind CSS configuration for a modern, tech-themed UI
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        techbg: '#181D27',
                        techpanel: '#22283A',
                        techaccent: '#2EE9E4',
                        techprimary: '#3762F0',
                        techsecondary: '#7D5FFF'
                    },
                    fontFamily: {
                        'tech': ['"Segoe UI"', 'Roboto', 'Arial', 'sans-serif']
                    }
                }
            }
        }

        // ä¿®æ­£ Google API è¼‰å…¥å•é¡Œ
        window.addEventListener('load', function() {
            // å»¶é²è¼‰å…¥ Google API ä»¥é¿å…è·¨åŸŸå•é¡Œ
            setTimeout(() => {
                if (typeof gapi !== 'undefined') {
                    gapi.load('client', function() {
                        console.log('Google API è¼‰å…¥æˆåŠŸ');
                    });
                }
            }, 1000);
        });
    </script>
    <style>
        /* Base styling and animations */
        body { font-family: "Segoe UI", Roboto, Arial, sans-serif; }
        .tab-main.active { border-color: #2EE9E4; background-color: #181D27; color: #2EE9E4; }
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.5s ease; }
        .locked { opacity: 0.5; pointer-events: none; }
        .spinner { border: 4px solid rgba(59,130,246,.2); width: 36px; height: 36px; border-radius: 50%; border-left-color: #2EE9E4; animation: spin 1s ease infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Table and result panel styling */
        th, td { padding: 12px 15px; }
        .result-panel { max-height: 65vh; overflow-y: auto; }
        .overflow-x-auto { overflow-x: auto; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #181D27; }
        ::-webkit-scrollbar-thumb { background: #3762F0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #7D5FFF; }

        /* Stepper UI */
        .stepper-container { display: flex; justify-content: space-between; margin-bottom: 1.5rem; }
        .step { flex: 1; text-align: center; position: relative; }
        .step-circle { width: 32px; height: 32px; line-height: 30px; border-radius: 50%; background-color: #22283A; color: #fff; display: inline-block; border: 2px solid #3762F0; font-weight: bold; cursor: pointer; transition: all .3s ease; }
        .step-title { margin-top: 0.5rem; font-size: 0.875rem; color: #9ca3af; }
        .step-line { position: absolute; top: 16px; left: 50%; width: 100%; height: 2px; background-color: #3762F0; z-index: -1; }
        .step:first-child .step-line { left: 50%; width: 50%; }
        .step:last-child .step-line { left: 0; width: 50%;}
        
        .step.active .step-circle { background-color: #3762F0; color: #fff; border-color: #2EE9E4; transform: scale(1.1); }
        .step.active .step-title { color: #2EE9E4; font-weight: bold; }
        .step.completed .step-circle { background-color: #2EE9E4; color: #181D27; border-color: #2EE9E4; }
        .step.completed .step-title { color: #d1d5db; }

        /* Badge Styles */
        .badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-weight: 600; font-size: 0.75rem; }
        .badge-high { background-color: #ef4444; color: white; }
        .badge-mid { background-color: #f97316; color: white; }
        .badge-low { background-color: #22c55e; color: white; }
        .badge-unknown { background-color: #6b7280; color: white; }

        /* Dashboard Cards */
        .dashboard-card { background: linear-gradient(135deg, #22283A 0%, #1a1f2e 100%); border: 1px solid #3762F0; border-radius: 12px; padding: 1.5rem; }
        .metric-value { font-size: 2rem; font-weight: bold; color: #2EE9E4; }
        .metric-label { color: #9ca3af; font-size: 0.875rem; margin-top: 0.5rem; }

        /* Comparison Table */
        .comparison-table { border-collapse: separate; border-spacing: 0; }
        .comparison-table th { background: #1a1f2e; border: 1px solid #3762F0; padding: 12px; }
        .comparison-table td { border: 1px solid #3762F0; padding: 12px; }
        .comparison-table tr:nth-child(even) { background: rgba(55, 98, 240, 0.05); }

        /* Chart Container */
        .chart-container { position: relative; height: 300px; margin: 1rem 0; }
    </style>
</head>
<body class="bg-techbg font-tech text-gray-100 min-h-screen">
    <!-- Header Section -->
    <header class="bg-techpanel shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold tracking-wide text-techaccent flex items-center gap-2">
                <svg class="w-8 h-8 text-techprimary inline-block" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364-7.364l-1.414 1.414M6.05 17.95l-1.414 1.414m12.728 0l1.414-1.414M6.05 6.05L4.636 4.636" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                å¸‚å ´æƒ…è³‡èˆ‡ç«¶å“åˆ†æå¹³å°
            </h1>
            <div id="auth-container">
                <div class="flex items-center gap-4">
                    <div id="user-profile" class="hidden items-center gap-3">
                        <img id="user-avatar" class="w-10 h-10 rounded-full" src="" alt="User Avatar">
                        <span id="user-name" class="font-semibold text-gray-200"></span>
                        <button id="signout_button" class="text-sm text-gray-400 hover:text-techaccent">ç™»å‡º</button>
                    </div>
                     <button id="authorize_button" class="hidden bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-5 py-2 rounded-lg shadow-lg">ç™»å…¥ Google</button>
                </div>
                <div class="text-xs text-yellow-400 mt-2">â€» éœ€æˆæ¬Š Google Drive å…¨æ¬Šé™æ‰èƒ½æ­£ç¢ºå„²å­˜è³‡æ–™</div>
            </div>
        </div>
    </header>

    <div id="alert-container" class="fixed top-24 right-6 z-50"></div>

    <main class="container mx-auto px-6 py-8">
        <div id="app-container" class="locked">
            <!-- Main Panels -->
            <div id="analysis-panel" class="panel active">
                <!-- Stepper -->
                <div class="stepper-container mb-8">
                    <div id="step-1" class="step active">
                        <div class="step-circle" onclick="goToStep(1)">1</div>
                        <div class="step-title">åˆ†æè¨­å®š</div>
                        <div class="step-line"></div>
                    </div>
                    <div id="step-2" class="step">
                        <div class="step-circle" onclick="goToStep(2)">2</div>
                        <div class="step-title">å°æ‰‹ç¯©é¸èˆ‡è£œå……</div>
                        <div class="step-line"></div>
                    </div>
                    <div id="step-3" class="step">
                        <div class="step-circle" onclick="goToStep(3)">3</div>
                        <div class="step-title">å®Œæ•´å ±å‘Š</div>
                    </div>
                </div>

                <!-- Main Tabs -->
                <div class="flex border-b border-techprimary/20 mb-6">
                    <button data-tab="analysis" class="tab-main tab-btn active flex-1 p-4 font-semibold">åˆ†æç³»çµ±</button>
                    <button data-tab="settings" class="tab-main tab-btn flex-1 p-4 font-semibold">API è¨­å®š</button>
                    <button data-tab="history" class="tab-main tab-btn flex-1 p-4 font-semibold">æ­·å²ç´€éŒ„</button>
                </div>

                <div id="settings-panel" class="panel hidden">
                    <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8 max-w-lg mx-auto">
                        <h2 class="text-2xl font-bold mb-6 text-techaccent text-center">API èˆ‡æ‡‰ç”¨ç¨‹å¼è¨­å®š</h2>
                        <div class="space-y-4">
                            <div><label for="google-api-key" class="block text-sm font-medium text-gray-300">Google API é‡‘é‘°</label><input type="password" id="google-api-key" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="å¡«å¯« Gemini/Custom Search API Key"></div>
                            <div><label for="search-engine-id" class="block text-sm font-medium text-gray-300">å¯ç¨‹å¼åŒ–æœå°‹å¼•æ“ ID (CX)</label><input type="text" id="search-engine-id" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="å¡«å¯« Custom Search Engine ID"></div>
                            
                            <!-- é›†ä¸­åŒ–è³‡æ–™å¤¾ç®¡ç†è¨­å®š -->
                            <div class="border-t border-techprimary/30 pt-4 mt-6">
                                <h3 class="text-lg font-semibold text-techaccent mb-4">ğŸ“ é›†ä¸­åŒ–è³‡æ–™å¤¾ç®¡ç†</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="central-folder-name" class="block text-sm font-medium text-gray-300">ä¸»è¦å°ˆæ¡ˆè³‡æ–™å¤¾åç¨±</label>
                                        <input type="text" id="central-folder-name" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="iStaging_å°ˆæ¡ˆç®¡ç†" placeholder="ä¾‹å¦‚: iStaging_å°ˆæ¡ˆç®¡ç†">
                                        <p class="text-xs text-gray-400 mt-1">æ­¤è³‡æ–™å¤¾å°‡åŒ…å«æ‰€æœ‰å°ˆæ¡ˆçš„å­è³‡æ–™å¤¾</p>
                                    </div>
                                    <div>
                                        <label for="intelligence-subfolder" class="block text-sm font-medium text-gray-300">å¸‚å ´æƒ…è³‡å­è³‡æ–™å¤¾åç¨±</label>
                                        <input type="text" id="intelligence-subfolder" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="01_å¸‚å ´æƒ…è³‡åˆ†æ" placeholder="ä¾‹å¦‚: 01_å¸‚å ´æƒ…è³‡åˆ†æ">
                                    </div>
                                    <div>
                                        <label for="mediaplan-subfolder" class="block text-sm font-medium text-gray-300">åª’é«”ææ¡ˆå­è³‡æ–™å¤¾åç¨±</label>
                                        <input type="text" id="mediaplan-subfolder" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="02_åª’é«”ææ¡ˆ" placeholder="ä¾‹å¦‚: 02_åª’é«”ææ¡ˆ">
                                    </div>
                                    <div>
                                        <label for="workflow-subfolder" class="block text-sm font-medium text-gray-300">å·¥ä½œæµç¨‹å­è³‡æ–™å¤¾åç¨±</label>
                                        <input type="text" id="workflow-subfolder" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" value="03_å·¥ä½œæµç¨‹æ–‡ä»¶" placeholder="ä¾‹å¦‚: 03_å·¥ä½œæµç¨‹æ–‡ä»¶">
                                    </div>
                                </div>
                            </div>
                            
                            <button id="save-settings-btn" class="w-full bg-gradient-to-tr from-techprimary to-techaccent font-bold text-white px-5 py-3 rounded-lg shadow-lg mt-6">å„²å­˜è¨­å®š</button>
                        </div>
                    </section>
                </div>

                <!-- åˆ†æç³»çµ±ä¸»è¦å…§å®¹å€åŸŸ -->
                <div id="analysis-panel" class="panel active">
                    <!-- Step 1: åˆ†æè¨­å®š -->
                    <div id="step-1-content" class="step-panel">
                        <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8">
                            <h2 class="text-2xl font-bold mb-6 text-techaccent">ğŸ“Š åˆ†æè¨­å®š</h2>
                            
                            <!-- Project ID è¼¸å…¥ -->
                            <div class="mb-6">
                                <label for="project-id" class="block text-sm font-medium text-gray-300 mb-2">å°ˆæ¡ˆ ID</label>
                                <input type="text" id="project-id" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="è«‹è¼¸å…¥å°ˆæ¡ˆ ID">
                                <p class="text-xs text-gray-400 mt-1">æ­¤ ID å°‡ç”¨æ–¼æª”æ¡ˆå‘½åå’Œè³‡æ–™å¤¾çµ„ç¹”</p>
                            </div>

                            <!-- åˆ†æä¸»é¡Œè¨­å®š -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label for="topic" class="block text-sm font-medium text-gray-300 mb-2">åˆ†æä¸»é¡Œ *</label>
                                    <input type="text" id="topic" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="ä¾‹å¦‚: é›»å‹•è»Šå¸‚å ´åˆ†æ">
                                </div>
                                <div>
                                    <label for="industry" class="block text-sm font-medium text-gray-300 mb-2">ç”¢æ¥­é¡åˆ¥</label>
                                    <input type="text" id="industry" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="ä¾‹å¦‚: æ±½è»Šè£½é€ æ¥­">
                                </div>
                                <div>
                                    <label for="product" class="block text-sm font-medium text-gray-300 mb-2">ç”¢å“/æœå‹™</label>
                                    <input type="text" id="product" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="ä¾‹å¦‚: é›»å‹•è»Š">
                                </div>
                                <div>
                                    <label for="company" class="block text-sm font-medium text-gray-300 mb-2">å…¬å¸åç¨±</label>
                                    <input type="text" id="company" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="ä¾‹å¦‚: Tesla">
                                </div>
                            </div>

                            <!-- æ¥­å‹™æ¨¡å¼é¸æ“‡ -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-300 mb-3">æ¥­å‹™æ¨¡å¼</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <label class="flex items-center p-3 rounded-lg bg-techbg border border-techprimary/20 cursor-pointer hover:border-techaccent">
                                        <input type="radio" name="business-model" value="B2B" class="mr-2" checked>
                                        <span class="text-sm">B2B</span>
                                    </label>
                                    <label class="flex items-center p-3 rounded-lg bg-techbg border border-techprimary/20 cursor-pointer hover:border-techaccent">
                                        <input type="radio" name="business-model" value="B2C" class="mr-2">
                                        <span class="text-sm">B2C</span>
                                    </label>
                                    <label class="flex items-center p-3 rounded-lg bg-techbg border border-techprimary/20 cursor-pointer hover:border-techaccent">
                                        <input type="radio" name="business-model" value="B2B2C" class="mr-2">
                                        <span class="text-sm">B2B2C</span>
                                    </label>
                                    <label class="flex items-center p-3 rounded-lg bg-techbg border border-techprimary/20 cursor-pointer hover:border-techaccent">
                                        <input type="radio" name="business-model" value="SaaS" class="mr-2">
                                        <span class="text-sm">SaaS</span>
                                    </label>
                                </div>
                            </div>

                            <!-- åœ°å€å’Œèªè¨€è¨­å®š -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div>
                                    <label for="country" class="block text-sm font-medium text-gray-300 mb-2">ç›®æ¨™å¸‚å ´</label>
                                    <select id="country" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20">
                                        <option value="TW">å°ç£</option>
                                        <option value="US">ç¾åœ‹</option>
                                        <option value="CN">ä¸­åœ‹</option>
                                        <option value="JP">æ—¥æœ¬</option>
                                        <option value="KR">éŸ“åœ‹</option>
                                        <option value="SG">æ–°åŠ å¡</option>
                                        <option value="HK">é¦™æ¸¯</option>
                                        <option value="MY">é¦¬ä¾†è¥¿äº</option>
                                        <option value="TH">æ³°åœ‹</option>
                                        <option value="VN">è¶Šå—</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="language" class="block text-sm font-medium text-gray-300 mb-2">åˆ†æèªè¨€</label>
                                    <select id="language" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20">
                                        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                                        <option value="en">English</option>
                                        <option value="zh-CN">ç°¡é«”ä¸­æ–‡</option>
                                        <option value="ja">æ—¥æœ¬èª</option>
                                        <option value="ko">í•œêµ­ì–´</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="sector" class="block text-sm font-medium text-gray-300 mb-2">ç´°åˆ†ç”¢æ¥­</label>
                                    <input type="text" id="sector" class="w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20" placeholder="ä¾‹å¦‚: æ–°èƒ½æºæ±½è»Š">
                                </div>
                            </div>

                            <button id="start-analysis-btn" class="w-full bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-6 py-3 rounded-lg shadow-lg">é–‹å§‹åˆ†æ</button>
                        </section>
                    </div>

                    <!-- Step 2: å°æ‰‹ç¯©é¸èˆ‡è£œå…… -->
                    <div id="step-2-content" class="step-panel hidden">
                        <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8">
                            <h2 class="text-2xl font-bold mb-6 text-techaccent">ğŸ¯ å°æ‰‹ç¯©é¸èˆ‡è£œå……</h2>
                            
                            <div class="mb-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-gray-200">åˆæ­¥ç«¶çˆ­å°æ‰‹æ¸…å–®</h3>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="select-all-competitors" class="mr-2">
                                        <span class="text-sm text-gray-300">å…¨é¸</span>
                                    </label>
                                </div>
                                <div id="initial-competitors-list" class="space-y-3">
                                    <!-- ç«¶çˆ­å°æ‰‹é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <button id="analyze-selected-btn" class="bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-6 py-3 rounded-lg shadow-lg">åˆ†æé¸ä¸­çš„ç«¶çˆ­å°æ‰‹</button>
                                <button onclick="goToStep(1)" class="bg-gray-600 hover:bg-gray-700 font-bold text-white px-6 py-3 rounded-lg shadow-lg">è¿”å›ä¸Šä¸€æ­¥</button>
                            </div>
                        </section>
                    </div>

                    <!-- Step 3: å®Œæ•´å ±å‘Š -->
                    <div id="step-3-content" class="step-panel hidden">
                        <section class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-8">
                            <h2 class="text-2xl font-bold mb-6 text-techaccent">ğŸ“ˆ å®Œæ•´åˆ†æå ±å‘Š</h2>
                            
                            <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
                            <div id="loading-indicator" class="hidden flex items-center justify-center py-8">
                                <div class="spinner mr-4"></div>
                                <div id="loading-status" class="text-gray-300">æ­£åœ¨ç”Ÿæˆå ±å‘Š...</div>
                            </div>

                            <!-- çµæœå®¹å™¨ -->
                            <div id="results-container" class="space-y-6">
                                <!-- å ±å‘Šå…§å®¹å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                            </div>

                            <div class="flex gap-4 mt-8">
                                <button id="save-analysis-btn" class="bg-gradient-to-tr from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 font-bold text-white px-6 py-3 rounded-lg shadow-lg">å„²å­˜åˆ° Google Drive</button>
                                <button id="export-excel-btn" class="bg-gradient-to-tr from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 font-bold text-white px-6 py-3 rounded-lg shadow-lg">åŒ¯å‡º Excel</button>
                                <button onclick="goToStep(2)" class="bg-gray-600 hover:bg-gray-700 font-bold text-white px-6 py-3 rounded-lg shadow-lg">è¿”å›ä¸Šä¸€æ­¥</button>
                            </div>
                        </section>
                    </div>
                </div>

                <div id="history-panel" class="panel hidden">
                     <div class="text-center text-gray-500 py-16">æ­·å²ç´€éŒ„åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...</div>
                </div>
            </div>
        </div>
    </main>

<script>
// --- GLOBAL STATE AND CONFIGURATION ---
const GOOGLE_CLIENT_ID = "733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com";
const GOOGLE_SCOPES = "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.profile";

const state = {
    gapiReady: false,
    gisReady: false,
    tokenClient: null,
    accessToken: null,
    userProfile: null,
    driveFolderId: null,
    projectId: null,
    apiKeys: {
        google: null, searchEngineId: null, driveFolderName: 'Market_Analysis_Data'
    },
    folderStructure: {
        centralFolder: 'iStaging_å°ˆæ¡ˆç®¡ç†',
        intelligenceSubfolder: '01_å¸‚å ´æƒ…è³‡åˆ†æ',
        mediaplanSubfolder: '02_åª’é«”ææ¡ˆ',
        workflowSubfolder: '03_å·¥ä½œæµç¨‹æ–‡ä»¶'
    },
    folderIds: {
        central: null,
        intelligence: null,
        mediaplan: null,
        workflow: null
    },
    isApiReady: false,
    currentStep: 1,
    analysisData: {
        context: null,
        initialCompetitors: [],
        keywords: [],
        finalCompetitors: []
    },
    sortState: {
        keywords: { key: 'volume', order: 'desc' },
        competitors: { key: 'brandName', order: 'asc' }
    }
};

const ui = {
    authorizeButton: document.getElementById('authorize_button'),
    signOutButton: document.getElementById('signout_button'),
    userProfileDiv: document.getElementById('user-profile'),
    userNameSpan: document.getElementById('user-name'),
    userAvatarImg: document.getElementById('user-avatar'),
    appContainer: document.getElementById('app-container'),
    projectIdInput: document.getElementById('project-id'),
    saveSettingsBtn: document.getElementById('save-settings-btn'),
    startAnalysisBtn: document.getElementById('start-analysis-btn'),
    analyzeSelectedBtn: document.getElementById('analyze-selected-btn'),
    selectAllCompetitors: document.getElementById('select-all-competitors'),
    loadingIndicator: document.getElementById('loading-indicator'),
    spinner: document.querySelector('.spinner'),
    loadingStatus: document.getElementById('loading-status'),
    resultsContainer: document.getElementById('results-container'),
    saveAnalysisBtn: document.getElementById('save-analysis-btn'),
    exportExcelBtn: document.getElementById('export-excel-btn'),
};

// --- INITIALIZATION ---
window.onload = function() {
    setupGapi();
    setupEventListeners();
    loadProjectIdFromUrl();
};

function setupGapi() {
    const gapiScript = document.createElement('script');
    gapiScript.src = 'https://apis.google.com/js/api.js';
    gapiScript.onload = () => gapi.load('client', () => {
        state.gapiReady = true;
        updateUIState();
    });
    document.body.appendChild(gapiScript);

    const gisScript = document.createElement('script');
    gisScript.src = 'https://accounts.google.com/gsi/client';
    gisScript.async = true;
    gisScript.defer = true;
    gisScript.onload = () => {
        state.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: GOOGLE_SCOPES,
            callback: gisInCallback,
        });
        state.gisReady = true;
        updateUIState();
    };
    document.body.appendChild(gisScript);
}

function setupEventListeners() {
    // å®‰å…¨åœ°è¨­ç½®äº‹ä»¶ç›£è½å™¨ï¼Œæª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
    if (ui.authorizeButton) {
        ui.authorizeButton.onclick = () => state.tokenClient?.requestAccessToken();
    }
    if (ui.signOutButton) {
        ui.signOutButton.onclick = handleSignOut;
    }
    if (ui.saveSettingsBtn) {
        ui.saveSettingsBtn.onclick = handleSaveSettings;
    }
    if (ui.startAnalysisBtn) {
        ui.startAnalysisBtn.onclick = startInitialAnalysis;
    }
    if (ui.analyzeSelectedBtn) {
        ui.analyzeSelectedBtn.onclick = processAndAnalyzeCompetitors;
    }
    if (ui.selectAllCompetitors) {
        ui.selectAllCompetitors.onchange = (e) => {
            document.querySelectorAll('.competitor-checkbox').forEach(cb => cb.checked = e.target.checked);
        };
    }
    
    // è¨­ç½®æ¨™ç±¤é åˆ‡æ›äº‹ä»¶
    document.querySelectorAll('.tab-main').forEach(btn => btn.addEventListener('click', handleMainTabSwitch));
    
    if (ui.saveAnalysisBtn) {
        ui.saveAnalysisBtn.onclick = saveAnalysisToDrive;
    }
    if (ui.exportExcelBtn) {
        ui.exportExcelBtn.onclick = exportToExcel;
    }
    
    // æ–°å¢äº‹ä»¶ç›£è½å™¨
    setupEnhancedEventListeners();
}

// --- UI & STATE MANAGEMENT ---
function updateUIState() {
    const loggedIn = !!state.accessToken;
    ui.authorizeButton.classList.toggle('hidden', loggedIn);
    ui.userProfileDiv.classList.toggle('hidden', !loggedIn);
    ui.appContainer.classList.toggle('locked', !loggedIn);

    if (!loggedIn) {
        goToStep(1); // Reset to first step on logout
        showAlert('è«‹å…ˆç™»å…¥', 'ç™»å…¥ Google å¸³è™Ÿä»¥é–‹å§‹ä½¿ç”¨ã€‚', 'info');
    } else if (!state.isApiReady) {
        handleMainTabSwitch({ target: document.querySelector('[data-tab="settings"]') });
        showAlert('è«‹å…ˆè¨­å®š API', 'è«‹åœ¨ API è¨­å®šé é¢å¡«å¯«å¿…è¦çš„é‡‘é‘°ã€‚', 'warning');
    }
}

function showAlert(title, message, type = 'info') {
    const alertContainer = document.getElementById('alert-container');
    const colors = {
        success: { bg: 'bg-green-500', text: 'text-white' },
        error: { bg: 'bg-red-500', text: 'text-white' },
        warning: { bg: 'bg-yellow-400', text: 'text-black' },
        info: { bg: 'bg-blue-500', text: 'text-white' }
    };
    const alertDiv = document.createElement('div');
    alertDiv.className = `rounded-lg shadow-lg px-5 py-3 mb-2 font-bold ${colors[type].bg} ${colors[type].text} transition-all duration-300 opacity-0 transform translate-x-10`;
    alertDiv.innerHTML = `<strong>${title}</strong> <span class="font-normal">${message}</span>`;
    alertContainer.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.opacity = '1';
        alertDiv.style.transform = 'translateX(0)';
    }, 10);
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        alertDiv.style.transform = 'translateX(10px)';
        alertDiv.addEventListener('transitionend', () => alertDiv.remove());
    }, 5000);
}

function handleMainTabSwitch(event) {
    const btn = event.target.closest('.tab-main');
    if (!btn || btn.classList.contains('active')) return;

    // ç§»é™¤æ‰€æœ‰æ¨™ç±¤é çš„activeç‹€æ…‹
    document.querySelectorAll('.tab-main').forEach(tab => {
        if (tab) tab.classList.remove('active');
    });
    btn.classList.add('active');

    const tabName = btn.dataset.tab;
    
    // éš±è—æ‰€æœ‰panel
    document.querySelectorAll('.panel').forEach(panel => {
        if (panel) panel.classList.remove('active');
    });
    
    // é¡¯ç¤ºç›®æ¨™panel
    const targetPanel = document.getElementById(`${tabName}-panel`);
    if (targetPanel) {
        targetPanel.classList.add('active');
    } else {
        console.error(`æ‰¾ä¸åˆ°panel: ${tabName}-panel`);
    }
}

function setLoadingState(isLoading, message = '') {
    ui.loadingIndicator.classList.toggle('hidden', !isLoading);
    ui.loadingIndicator.classList.toggle('flex', isLoading);
    ui.resultsContainer.classList.toggle('hidden', isLoading);

    ui.loadingStatus.textContent = message;

    ui.startAnalysisBtn.disabled = isLoading;
    ui.analyzeSelectedBtn.disabled = isLoading;
    document.querySelectorAll('.step-circle').forEach(c => c.style.pointerEvents = isLoading ? 'none' : 'auto');
}

// --- STEPPER NAVIGATION ---
window.goToStep = function(step) {
    if (step > state.currentStep) return;
    if (step === 3 && state.analysisData.finalCompetitors.length === 0) return;
    if (step === 2 && state.analysisData.initialCompetitors.length === 0) return;

    // éš±è—æ‰€æœ‰step-panel
    document.querySelectorAll('.step-panel').forEach(p => {
        if (p) p.classList.add('hidden');
    });
    
    // é¡¯ç¤ºç›®æ¨™step-panel
    const targetPanel = document.getElementById(`step-${step}-content`);
    if (targetPanel) {
        targetPanel.classList.remove('hidden');
    }

    // æ›´æ–°stepæŒ‡ç¤ºå™¨
    document.querySelectorAll('.step').forEach((s) => {
        if (s) {
            s.classList.remove('active', 'completed');
            const currentStepNum = parseInt(s.id.split('-')[1]);
            if (currentStepNum < step) {
                s.classList.add('completed');
            } else if (currentStepNum === step) {
                s.classList.add('active');
            }
        }
    });
    
    if(step < state.currentStep) state.currentStep = step;
}

function advanceStep(step) {
    state.currentStep = step;
    goToStep(step);
}

// --- AUTHENTICATION & SETTINGS ---
async function gisInCallback(response) {
    if (response.error) { showAlert('ç™»å…¥å¤±æ•—', response.error, 'error'); return; }
    state.accessToken = response.access_token;
    gapi.client.setToken({ access_token: state.accessToken });
    await updateUserInfo();
    updateUIState();
    if (state.isApiReady) await findOrCreateDriveFolder();
}

async function updateUserInfo() {
    try {
        const res = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', { headers: { 'Authorization': `Bearer ${state.accessToken}` } });
        if (!res.ok) throw new Error('ç„¡æ³•ç²å–ç”¨æˆ¶è³‡è¨Š');
        const profile = await res.json();
        state.userProfile = profile;
        ui.userNameSpan.textContent = profile.name;
        ui.userAvatarImg.src = profile.picture;
        showAlert('ç™»å…¥æˆåŠŸ', `æ­¡è¿æ‚¨ï¼Œ${profile.name}ï¼`, 'success');
    } catch (error) {
        showAlert('éŒ¯èª¤', 'ç„¡æ³•ç²å–ç”¨æˆ¶å€‹äººè³‡æ–™ã€‚', 'error');
        handleSignOut();
    }
}

function handleSignOut() {
    state.accessToken = null; state.userProfile = null; state.driveFolderId = null;
    gapi.client.setToken(null);
    updateUIState();
    showAlert('å·²ç™»å‡º', 'æ‚¨å·²æˆåŠŸç™»å‡ºã€‚');
}

async function handleSaveSettings() {
    state.apiKeys.google = document.getElementById('google-api-key').value.trim();
    state.apiKeys.searchEngineId = document.getElementById('search-engine-id').value.trim();
    
    // è®€å–é›†ä¸­åŒ–è³‡æ–™å¤¾è¨­å®š
    state.folderStructure.centralFolder = document.getElementById('central-folder-name').value.trim() || 'iStaging_å°ˆæ¡ˆç®¡ç†';
    state.folderStructure.intelligenceSubfolder = document.getElementById('intelligence-subfolder').value.trim() || '01_å¸‚å ´æƒ…è³‡åˆ†æ';
    state.folderStructure.mediaplanSubfolder = document.getElementById('mediaplan-subfolder').value.trim() || '02_åª’é«”ææ¡ˆ';
    state.folderStructure.workflowSubfolder = document.getElementById('workflow-subfolder').value.trim() || '03_å·¥ä½œæµç¨‹æ–‡ä»¶';

    if (state.apiKeys.google && state.apiKeys.searchEngineId) {
        state.isApiReady = true;
        showAlert('è¨­å®šå·²å„²å­˜', 'API èˆ‡è³‡æ–™å¤¾è¨­å®šå·²å„²å­˜å®Œæˆã€‚', 'success');
        handleMainTabSwitch({ target: document.querySelector('[data-tab="analysis"]') });
        if (state.accessToken) await setupCentralizedFolderStructure();
    } else {
        state.isApiReady = false;
        showAlert('è¨­å®šä¸å®Œæ•´', 'è«‹å¡«å¯« Google API é‡‘é‘°å’Œæœå°‹å¼•æ“ IDã€‚', 'warning');
    }
}

// --- CORE ANALYSIS WORKFLOW ---
function validateInputFields() {
    const context = getSearchContext();
    const hasInput = context.topic || context.industry || context.product;
    if (!hasInput) {
        showAlert('è¼¸å…¥ä¸è¶³', 'è«‹è‡³å°‘å¡«å¯«åˆ†æä¸»é¡Œã€ç”¢å“æˆ–ç”¢æ¥­åç¨±ã€‚', 'warning');
    }
    return hasInput;
}

function getSearchContext() {
    return {
        topic: document.getElementById('topic')?.value.trim(),
        businessModel: document.querySelector('input[name="business-model"]:checked').value,
        country: document.getElementById('country').value,
        language: document.getElementById('language').value,
        industry: document.getElementById('industry').value.trim(),
        sector: document.getElementById('sector').value.trim(),
        product: document.getElementById('product').value.trim(),
        company: document.getElementById('company').value.trim(),
    };
}

async function startInitialAnalysis() {
    // é©—è­‰ project ID
    const projectId = ui.projectIdInput.value.trim();
    if (!projectId) {
        showAlert('å°ˆæ¡ˆ ID å¿…å¡«', 'è«‹è¼¸å…¥å¾ Workflow ç³»çµ±å–å¾—çš„å°ˆæ¡ˆ IDã€‚', 'warning');
        return;
    }
    
    // å„²å­˜ project ID åˆ° state
    state.projectId = projectId;
    
    if (!validateInputFields()) return;
    
    state.analysisData = { context: getSearchContext(), initialCompetitors: [], keywords: [], finalCompetitors: [] };
    
    setLoadingState(true, 'æ­£åœ¨ç”¢ç”Ÿ AI å»ºè­°åˆ—è¡¨...');
    
    try {
        const [keywords, competitorNames] = await Promise.all([
            getAiKeywordSuggestions(state.analysisData.context),
            getAiCompetitorNames(state.analysisData.context)
        ]);

        state.analysisData.keywords = keywords || [];
        state.analysisData.initialCompetitors = competitorNames || [];

        if (competitorNames.length === 0) {
            showAlert('æŸ¥ç„¡ç«¶çˆ­å°æ‰‹', 'AI æœªèƒ½æ‰¾åˆ°ç›¸é—œå°æ‰‹ï¼Œè«‹ç›´æ¥é€²å…¥å ±å‘Šé é¢æŸ¥çœ‹é—œéµå­—ã€‚', 'info');
            renderFullReport(); 
            advanceStep(3);
        } else {
            renderCompetitorSelection(competitorNames);
            advanceStep(2);
        }
    } catch (error) {
        showAlert('åˆ†æå¤±æ•—', `æ­¥é©Ÿä¸€å¤±æ•—: ${error.message}`, 'error');
    } finally {
        setLoadingState(false);
    }
}

function processAndAnalyzeCompetitors() {
    const selectedAINames = Array.from(document.querySelectorAll('.competitor-checkbox:checked')).map(cb => cb.value);
    const supplementalInput = document.getElementById('supplemental-competitors').value;
    const supplementalNames = supplementalInput.split(/[\n,]/).map(name => name.trim()).filter(Boolean);
    const finalCompetitorList = [...new Set([...selectedAINames, ...supplementalNames])];
    
    if (finalCompetitorList.length === 0) {
        showAlert("æœªæŒ‡å®šå°æ‰‹", "è«‹è‡³å°‘å‹¾é¸æˆ–è£œå……ä¸€å€‹ç«¶çˆ­å°æ‰‹é€²è¡Œåˆ†æã€‚", "warning");
        return;
    }

    analyzeCompetitors(finalCompetitorList);
}


async function analyzeCompetitors(competitorNames) {
    advanceStep(3);
    setLoadingState(true, `æ­£åœ¨åˆ†æ ${competitorNames.length} å€‹ç«¶çˆ­å°æ‰‹...`);

    try {
        const competitorPromises = competitorNames.map(name => getFullCompetitorDetails(name, state.analysisData.context));
        const competitorDetails = await Promise.all(competitorPromises);
        
        state.analysisData.finalCompetitors = competitorDetails.filter(Boolean);
        
        renderFullReport();
        showAlert('åˆ†æå®Œæˆ', `å·²æˆåŠŸå–å¾— ${state.analysisData.finalCompetitors.length} å®¶ç«¶çˆ­å°æ‰‹çš„è©³ç´°è³‡æ–™ã€‚`, 'success');

    } catch (error) {
        showAlert('åˆ†æå¤±æ•—', `æ­¥é©ŸäºŒå¤±æ•—: ${error.message}`, 'error');
    } finally {
        setLoadingState(false);
    }
}

// --- GOOGLE API & AI PROMPTS ---
async function callGemini(prompt) {
    const apiKey = state.apiKeys.google;
    if (!apiKey) throw new Error('Google API é‡‘é‘°æœªè¨­å®šã€‚');
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
    const body = { contents: [{ parts: [{ text: prompt }] }] };
    const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`Gemini API éŒ¯èª¤: ${errorData.error?.message || response.statusText}`);
    }
    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) throw new Error('Gemini å›å‚³å…§å®¹ç‚ºç©ºã€‚');
    try {
        const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```|(\[.*\])|(\{.*\})/s);
        if (!jsonMatch) throw new Error('å›å‚³çš„å…§å®¹ä¸åŒ…å«æœ‰æ•ˆçš„ JSON æ ¼å¼ã€‚');
        return JSON.parse(jsonMatch[1] || jsonMatch[2] || jsonMatch[3]);
    } catch (e) {
        console.error("Gemini JSON parsing error:", e, "\nOriginal text:", text);
        throw new Error('Gemini å›å‚³æ ¼å¼è§£æå¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°æ—¥èªŒã€‚');
    }
}

async function searchGoogle(query) {
    const apiKey = state.apiKeys.google;
    const cx = state.apiKeys.searchEngineId;
    if (!apiKey || !cx) throw new Error('Google API é‡‘é‘°æˆ–æœå°‹å¼•æ“ ID æœªè¨­å®šã€‚');
    const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=${encodeURIComponent(query)}`;
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Custom Search API éŒ¯èª¤: ${response.statusText}`);
        const data = await response.json();
        return data.items?.[0]?.link || null;
    } catch (error) {
        console.error(`Google Search for "${query}" failed:`, error);
        return null;
    }
}

async function getAiKeywordSuggestions(context) {
    const prompt = `You are a world-class SEO expert. Based on the following criteria, generate as many relevant SEO keywords as possible, aiming for 40-50, in the specified language. Critically, tailor keywords to the "businessModel". Also provide estimated search volume (é«˜/ä¸­/ä½), type, and bidding competition (é«˜/ä¸­/ä½). Output MUST be a valid JSON array of objects, with NO other text. Criteria: ${JSON.stringify(context)}. Format: [{"keyword": "...", "volume": "...", "type": "...", "biddingCompetition": "..."}, ...].`;
    return callGemini(prompt);
}

async function getAiCompetitorNames(context) {
    const prompt = `You are a market analysis expert. Based on the criteria below, identify the top 10 competitors. Output MUST be a valid JSON array of strings, with NO other text. Criteria: ${JSON.stringify(context)}. Format: ["Competitor A", "Competitor B", ...].`;
    return callGemini(prompt);
}

async function getFullCompetitorDetails(name, context) {
    const prompt = `Analyze the company "${name}", a competitor in the market of "${context.topic}". Find its official stock ticker, headquarters state/province, and postal code. Output MUST be a single valid JSON object. If a value isn't found, use null. Criteria: ${JSON.stringify(context)}. Format: {"brandName": "${name}", "country": "...", "summary": "...", "companyType": "...", "stockTicker": "e.g., AAPL", "state": "e.g., California", "postalCode": "e.g., 95014"}`;
    const detailPromise = callGemini(prompt);
    const websitePromise = searchGoogle(`${name} ${context.industry || ''} official website`);
    const linkedinPromise = searchGoogle(`site:linkedin.com/company/ ${name}`);
    const [details, websiteUrl, linkedinUrl] = await Promise.all([detailPromise.catch(e => ({ brandName: name })), websitePromise, linkedinPromise]);
    return { ...details, websiteUrl, linkedinUrl };
}

// --- RESULT RENDERING ---
function renderCompetitorSelection(competitorNames) {
    const listEl = document.getElementById('competitor-checkbox-list');
    listEl.innerHTML = competitorNames.map(name => `
        <label class="block p-3 rounded-lg hover:bg-techprimary/20 transition-colors bg-techbg cursor-pointer">
            <input type="checkbox" class="competitor-checkbox mr-3 accent-techaccent" value="${name}" checked>
            <span>${name}</span>
        </label>
    `).join('');
    document.getElementById('supplemental-competitors').value = '';
}

function renderFullReport() {
    renderCompetitorResults();
    renderKeywordResults();
}

function renderCompetitorResults() {
    const card = document.getElementById('competitors-result-card');
    const data = state.analysisData.finalCompetitors || [];
    let content = `<h3 class="text-xl font-bold mb-4 text-techaccent">A. ç«¶çˆ­å°æ‰‹åˆ†æ</h3>`;

    if (data.length === 0) {
        card.innerHTML = content + '<p class="text-gray-500">æ²’æœ‰è¦é¡¯ç¤ºçš„ç«¶çˆ­å°æ‰‹è³‡æ–™ã€‚</p>';
        return;
    }
    const headers = ['å“ç‰Œ', 'åœ‹å®¶', 'è‚¡ç¥¨ä»£è™Ÿ', 'å·åˆ¥', 'éƒµéå€è™Ÿ', 'é€£çµ'];
    const keys = ['brandName', 'country', 'stockTicker', 'state', 'postalCode', 'links'];
    const sortedData = sortData('competitors', data);

    content += `<div class="overflow-x-auto result-panel">
        <table class="w-full text-left text-sm">
        <thead class="bg-gray-900 sticky top-0 z-10"><tr class="border-b border-techprimary/30">
        ${headers.map((h, i) => `<th class="py-3 px-3 cursor-pointer" onclick="sortTable('competitors', '${keys[i]}')">${h}${getSortIcon('competitors', keys[i])}</th>`).join('')}
        </tr></thead><tbody>
        ${sortedData.map(item => `
            <tr class="border-b border-techprimary/20 hover:bg-techprimary/10">
                <td class="font-semibold">${item.brandName || '-'}</td>
                <td>${item.country || '-'}</td>
                <td>${item.stockTicker || '-'}</td>
                <td>${item.state || '-'}</td>
                <td>${item.postalCode || '-'}</td>
                <td class="flex gap-4 items-center">
                    ${item.websiteUrl ? `<a href="${item.websiteUrl}" target="_blank" title="å®˜æ–¹ç¶²ç«™" class="text-gray-400 hover:text-techaccent"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></a>` : ''}
                    ${item.linkedinUrl ? `<a href="${item.linkedinUrl}" target="_blank" title="LinkedIn" class="text-gray-400 hover:text-techaccent"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a>` : ''}
                </td>
            </tr>
        `).join('')}
        </tbody></table></div>`;
    card.innerHTML = content;
}

function renderKeywordResults() {
    const card = document.getElementById('keywords-result-card');
    const data = state.analysisData.keywords || [];
    let content = `<h3 class="text-xl font-bold mb-4 text-techaccent">B. é—œéµå­—å»ºè­°</h3>`;
    if (data.length === 0) {
        card.innerHTML = content + '<p class="text-gray-500">æ²’æœ‰è¦é¡¯ç¤ºçš„é—œéµå­—è³‡æ–™ã€‚</p>'; return;
    }
    const headers = ['é—œéµå­—', 'æœå°‹é‡ç´š', 'å‡ºåƒ¹ç«¶çˆ­', 'é¡å‹'];
    const keys = ['keyword', 'volume', 'biddingCompetition', 'type'];
    const sortedData = sortData('keywords', data);
    const getBadgeClass = (value) => {
        const lower = String(value).toLowerCase();
        if (lower === 'é«˜' || lower === 'high') return 'badge-high';
        if (lower === 'ä¸­' || lower === 'medium') return 'badge-mid';
        if (lower === 'ä½' || lower === 'low') return 'badge-low';
        return 'badge-unknown';
    };
    content += `<div class="overflow-x-auto result-panel"><table class="w-full text-left text-sm">
        <thead class="bg-gray-900 sticky top-0 z-10"><tr class="border-b border-techprimary/30">
        ${headers.map((h, i) => `<th class="py-3 px-3 cursor-pointer" onclick="sortTable('keywords', '${keys[i]}')">${h}${getSortIcon('keywords', keys[i])}</th>`).join('')}
        </tr></thead><tbody>
        ${sortedData.map(item => `
            <tr class="border-b border-techprimary/20 hover:bg-techprimary/10">
                <td>${item.keyword || '-'}</td>
                <td><span class="badge ${getBadgeClass(item.volume)}">${item.volume || 'N/A'}</span></td>
                <td><span class="badge ${getBadgeClass(item.biddingCompetition)}">${item.biddingCompetition || 'N/A'}</span></td>
                <td>${item.type || '-'}</td>
            </tr>
        `).join('')}
        </tbody></table></div>`;
    card.innerHTML = content;
}

// --- DATA SORTING & UTILS ---
function getSortIcon(type, key) {
    if (state.sortState[type].key !== key) return '';
    return state.sortState[type].order === 'asc' ? ' â–²' : ' â–¼';
}
window.sortTable = function(type, key) {
    const sortState = state.sortState[type];
    if (sortState.key === key) {
        sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
    } else {
        sortState.key = key;
        sortState.order = (key === 'volume' || key === 'biddingCompetition') ? 'desc' : 'asc';
    }
    if (type === 'keywords') renderKeywordResults();
    if (type === 'competitors') renderCompetitorResults();
};
function sortData(type, data) {
    const { key, order } = state.sortState[type];
    if (!key || !data) return data;
    const competitionMap = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
    return [...data].sort((a, b) => {
        let aVal = a[key] || '', bVal = b[key] || '';
        if (key === 'volume' || key === 'biddingCompetition') {
            aVal = competitionMap[aVal] || 0;
            bVal = competitionMap[bVal] || 0;
            return order === 'asc' ? aVal - bVal : bVal - aVal;
        }
        return order === 'asc' ? String(aVal).localeCompare(String(bVal)) : String(bVal).localeCompare(String(aVal));
    });
}

// --- ACTIONS (SAVE, EXPORT) ---
function exportToExcel() {
    if (state.analysisData.finalCompetitors.length === 0 && state.analysisData.keywords.length === 0) {
        return showAlert("ç„¡æ³•åŒ¯å‡º", "ç›®å‰æ²’æœ‰å¯åŒ¯å‡ºçš„åˆ†æçµæœã€‚", "warning");
    }
    const wb = XLSX.utils.book_new();
    if (state.analysisData.finalCompetitors.length > 0) {
        const sheetData = state.analysisData.finalCompetitors.map(c => ({
            'å“ç‰Œåç¨±': c.brandName, 'åœ‹å®¶': c.country, 'æ‘˜è¦': c.summary, 'å…¬å¸é¡å‹': c.companyType,
            'è‚¡ç¥¨ä»£è™Ÿ': c.stockTicker, 'å·åˆ¥': c.state, 'éƒµéå€è™Ÿ': c.postalCode,
            'å®˜æ–¹ç¶²ç«™': c.websiteUrl, 'LinkedIn': c.linkedinUrl
        }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetData), "A_ç«¶çˆ­å°æ‰‹åˆ†æ");
    }
    if (state.analysisData.keywords.length > 0) {
        const sheetData = state.analysisData.keywords.map(k => ({ 'é—œéµå­—': k.keyword, 'æœå°‹é‡ç´š': k.volume, 'å‡ºåƒ¹ç«¶çˆ­': k.biddingCompetition, 'é¡å‹': k.type }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sheetData), "B_é—œéµå­—å»ºè­°");
    }
    const fileName = `${state.analysisData.context.topic || 'å¸‚å ´åˆ†æ'}_${new Date().toISOString().slice(0, 10)}.xlsx`;
    XLSX.writeFile(wb, fileName);
    showAlert('åŒ¯å‡ºæˆåŠŸ', `å·²ç”¢ç”Ÿæª”æ¡ˆ ${fileName}`, 'success');
}

async function saveAnalysisToDrive() {
    if (!state.projectId) return showAlert('å°ˆæ¡ˆ ID ç¼ºå¤±', 'è«‹å…ˆè¼¸å…¥å°ˆæ¡ˆ IDã€‚', 'warning');
    if (state.analysisData.finalCompetitors.length === 0 && state.analysisData.keywords.length === 0) return showAlert('å°šç„¡çµæœ', 'è«‹å…ˆåŸ·è¡Œåˆ†æã€‚', 'warning');
    
    setLoadingState(true, 'æ­£åœ¨å»ºç«‹è³‡æ–™å¤¾çµæ§‹ä¸¦å„²å­˜...');
    try {
        // ç¢ºä¿è³‡æ–™å¤¾çµæ§‹å·²å»ºç«‹
        if (!state.folderIds.intelligence) {
            await setupCentralizedFolderStructure();
        }
        
        // åœ¨åˆ†æè³‡æ–™ä¸­åŠ å…¥ project ID
        const analysisDataWithProject = {
            ...state.analysisData,
            projectId: state.projectId,
            savedAt: new Date().toISOString(),
            savedBy: state.userProfile?.name || 'Unknown',
            tool: 'intelligence'
        };
        
        const fileContent = JSON.stringify(analysisDataWithProject, null, 2);
        const blob = new Blob([fileContent], { type: 'application/json' });
        const fileName = `[${state.projectId}]_å¸‚å ´æƒ…è³‡åˆ†æ_${state.analysisData.context.topic || 'å¸‚å ´'}_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
        
        // å„²å­˜åˆ° intelligence å­è³‡æ–™å¤¾
        const targetFolderId = state.folderIds.intelligence || state.driveFolderId;
        const metadata = { 
            name: fileName, 
            mimeType: 'application/json', 
            parents: [targetFolderId] 
        };
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', blob);
        
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${state.accessToken}` },
            body: form
        });
        
        if (!response.ok) throw new Error((await response.json()).error?.message || 'æœªçŸ¥ä¸Šå‚³éŒ¯èª¤');
        
        showAlert('å„²å­˜æˆåŠŸ', `åˆ†æçµæœå·²å„²å­˜è‡³å°ˆæ¡ˆè³‡æ–™å¤¾ã€‚å°ˆæ¡ˆ ID: ${state.projectId}`, 'success');
        
    } catch (error) {
        showAlert('å­˜æª”å¤±æ•—', error.message, 'error');
    } finally {
        setLoadingState(false);
    }
}

async function findOrCreateDriveFolder() {
    try {
        await gapi.client.load('drive', 'v3');
        const folderName = state.apiKeys.driveFolderName;
        const response = await gapi.client.drive.files.list({ q: `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`, fields: 'files(id)' });
        if (response.result.files && response.result.files.length > 0) {
            state.driveFolderId = response.result.files[0].id;
        } else {
            const createResponse = await gapi.client.drive.files.create({ resource: { 'name': folderName, 'mimeType': 'application/vnd.google-apps.folder' }, fields: 'id' });
            state.driveFolderId = createResponse.result.id;
        }
    } catch (error) {
        console.error('Drive folder error:', error);
        showAlert('Drive éŒ¯èª¤', `å­˜å–è³‡æ–™å¤¾å¤±æ•—: ${error.result?.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
    }
}

// æ–°å¢ï¼šå»ºç«‹é›†ä¸­åŒ–è³‡æ–™å¤¾çµæ§‹
async function setupCentralizedFolderStructure() {
    try {
        await gapi.client.load('drive', 'v3');
        
        // 1. å»ºç«‹æˆ–æ‰¾åˆ°ä¸»è¦å°ˆæ¡ˆè³‡æ–™å¤¾
        const centralFolderId = await findOrCreateFolder(state.folderStructure.centralFolder, null);
        state.folderIds.central = centralFolderId;
        
        // 2. å»ºç«‹æˆ–æ‰¾åˆ°å°ˆæ¡ˆå­è³‡æ–™å¤¾
        if (state.projectId) {
            const projectFolderName = `[${state.projectId}]_å°ˆæ¡ˆè³‡æ–™`;
            const projectFolderId = await findOrCreateFolder(projectFolderName, centralFolderId);
            
            // 3. å»ºç«‹æˆ–æ‰¾åˆ°å„é¡åˆ¥å­è³‡æ–™å¤¾
            const intelligenceFolderId = await findOrCreateFolder(state.folderStructure.intelligenceSubfolder, projectFolderId);
            const mediaplanFolderId = await findOrCreateFolder(state.folderStructure.mediaplanSubfolder, projectFolderId);
            const workflowFolderId = await findOrCreateFolder(state.folderStructure.workflowSubfolder, projectFolderId);
            
            state.folderIds.intelligence = intelligenceFolderId;
            state.folderIds.mediaplan = mediaplanFolderId;
            state.folderIds.workflow = workflowFolderId;
            
            // è¨­å®š intelligence çš„é è¨­å„²å­˜è³‡æ–™å¤¾
            state.driveFolderId = intelligenceFolderId;
            
            console.log('é›†ä¸­åŒ–è³‡æ–™å¤¾çµæ§‹å»ºç«‹å®Œæˆ:', {
                central: centralFolderId,
                project: projectFolderId,
                intelligence: intelligenceFolderId,
                mediaplan: mediaplanFolderId,
                workflow: workflowFolderId
            });
            
            showAlert('è³‡æ–™å¤¾çµæ§‹å»ºç«‹å®Œæˆ', `å°ˆæ¡ˆ ${state.projectId} çš„è³‡æ–™å¤¾çµæ§‹å·²æº–å‚™å°±ç·’`, 'success');
        }
        
    } catch (error) {
        console.error('å»ºç«‹è³‡æ–™å¤¾çµæ§‹å¤±æ•—:', error);
        showAlert('è³‡æ–™å¤¾å»ºç«‹å¤±æ•—', `å»ºç«‹é›†ä¸­åŒ–è³‡æ–™å¤¾çµæ§‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
    }
}

// è¼”åŠ©å‡½æ•¸ï¼šå»ºç«‹æˆ–æ‰¾åˆ°è³‡æ–™å¤¾
async function findOrCreateFolder(folderName, parentId) {
    try {
        let query = `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`;
        if (parentId) {
            query += ` and '${parentId}' in parents`;
        }
        
        const response = await gapi.client.drive.files.list({ 
            q: query, 
            fields: 'files(id)' 
        });
        
        if (response.result.files && response.result.files.length > 0) {
            return response.result.files[0].id;
        } else {
            const folderMetadata = {
                name: folderName,
                mimeType: 'application/vnd.google-apps.folder'
            };
            
            if (parentId) {
                folderMetadata.parents = [parentId];
            }
            
            const createResponse = await gapi.client.drive.files.create({ 
                resource: folderMetadata, 
                fields: 'id' 
            });
            
            return createResponse.result.id;
        }
    } catch (error) {
        console.error(`å»ºç«‹è³‡æ–™å¤¾ ${folderName} å¤±æ•—:`, error);
        throw error;
    }
}

// æ–°å¢ï¼šå¾ URL åƒæ•¸è®€å– project ID
function loadProjectIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('projectId');
    if (projectId) {
        ui.projectIdInput.value = projectId;
        state.projectId = projectId;
        console.log('å¾ URL è®€å–åˆ°å°ˆæ¡ˆ ID:', projectId);
    }
}

// --- DASHBOARD & VISUALIZATION FUNCTIONS ---
function updateDashboard() {
    const competitors = state.analysisData.finalCompetitors || [];
    const keywords = state.analysisData.keywords || [];
    
    // æ›´æ–°æŒ‡æ¨™å¡ç‰‡
    document.getElementById('total-competitors').textContent = competitors.length;
    document.getElementById('total-keywords').textContent = keywords.length;
    document.getElementById('high-volume-keywords').textContent = keywords.filter(k => k.volume === 'é«˜').length;
    document.getElementById('high-competition-keywords').textContent = keywords.filter(k => k.biddingCompetition === 'é«˜').length;
    
    // æ›´æ–°åœ–è¡¨
    updateKeywordVolumeChart(keywords);
    updateCompetitorLocationChart(competitors);
}

function updateKeywordVolumeChart(keywords) {
    const ctx = document.getElementById('keywordVolumeChart');
    if (!ctx) return;
    
    const volumeData = {
        'é«˜': keywords.filter(k => k.volume === 'é«˜').length,
        'ä¸­': keywords.filter(k => k.volume === 'ä¸­').length,
        'ä½': keywords.filter(k => k.volume === 'ä½').length
    };
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(volumeData),
            datasets: [{
                data: Object.values(volumeData),
                backgroundColor: ['#ef4444', '#f97316', '#22c55e'],
                borderColor: '#22283A',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#9ca3af',
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });
}

function updateCompetitorLocationChart(competitors) {
    const ctx = document.getElementById('competitorLocationChart');
    if (!ctx) return;
    
    const locationCount = {};
    competitors.forEach(c => {
        const country = c.country || 'æœªçŸ¥';
        locationCount[country] = (locationCount[country] || 0) + 1;
    });
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(locationCount),
            datasets: [{
                label: 'ç«¶çˆ­å°æ‰‹æ•¸é‡',
                data: Object.values(locationCount),
                backgroundColor: '#3762F0',
                borderColor: '#2EE9E4',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: '#374151'
                    }
                },
                x: {
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: '#374151'
                    }
                }
            }
        }
    });
}

// --- COMPARISON ANALYSIS FUNCTIONS ---
function renderComparisonTable() {
    const competitors = state.analysisData.finalCompetitors || [];
    if (competitors.length === 0) {
        document.getElementById('comparison-table-container').innerHTML = '<p class="text-gray-500 text-center">æ²’æœ‰ç«¶çˆ­å°æ‰‹è³‡æ–™å¯ä¾›æ¯”è¼ƒ</p>';
        return;
    }
    
    const comparisonFields = [
        { key: 'brandName', label: 'å“ç‰Œåç¨±' },
        { key: 'country', label: 'åœ‹å®¶' },
        { key: 'companyType', label: 'å…¬å¸é¡å‹' },
        { key: 'stockTicker', label: 'è‚¡ç¥¨ä»£è™Ÿ' },
        { key: 'state', label: 'å·åˆ¥/çœä»½' },
        { key: 'postalCode', label: 'éƒµéå€è™Ÿ' },
        { key: 'websiteUrl', label: 'å®˜æ–¹ç¶²ç«™' },
        { key: 'linkedinUrl', label: 'LinkedIn' }
    ];
    
    let tableHTML = '<table class="comparison-table w-full">';
    
    // è¡¨é ­
    tableHTML += '<thead><tr>';
    tableHTML += '<th>æ¯”è¼ƒé …ç›®</th>';
    competitors.forEach(comp => {
        tableHTML += `<th>${comp.brandName || 'æœªçŸ¥'}</th>`;
    });
    tableHTML += '</tr></thead>';
    
    // è¡¨æ ¼å…§å®¹
    tableHTML += '<tbody>';
    comparisonFields.forEach(field => {
        tableHTML += '<tr>';
        tableHTML += `<td class="font-semibold bg-gray-800">${field.label}</td>`;
        competitors.forEach(comp => {
            let value = comp[field.key] || '-';
            if (field.key === 'websiteUrl' && value !== '-') {
                value = `<a href="${value}" target="_blank" class="text-techaccent hover:underline">æŸ¥çœ‹ç¶²ç«™</a>`;
            } else if (field.key === 'linkedinUrl' && value !== '-') {
                value = `<a href="${value}" target="_blank" class="text-techaccent hover:underline">æŸ¥çœ‹ LinkedIn</a>`;
            }
            tableHTML += `<td>${value}</td>`;
        });
        tableHTML += '</tr>';
    });
    tableHTML += '</tbody></table>';
    
    document.getElementById('comparison-table-container').innerHTML = tableHTML;
}

// --- GOOGLE ADS TOOLS FUNCTIONS ---
async function generateAdsSitesList() {
    const industry = document.getElementById('industry-for-ads').value;
    if (!industry) {
        showAlert('è«‹é¸æ“‡è¡Œæ¥­', 'è«‹å…ˆé¸æ“‡è¦åˆ†æçš„è¡Œæ¥­ã€‚', 'warning');
        return;
    }
    
    setLoadingState(true, 'æ­£åœ¨ç”Ÿæˆ Google Ads è‡ªå®šç¾©äººç¾¤ç¶²ç«™æ¸…å–®...');
    
    try {
        const prompt = `ä½œç‚º Google Ads å°ˆå®¶ï¼Œè«‹ç‚º ${industry} è¡Œæ¥­æä¾›ä¸€ä»½é©åˆç”¨æ–¼ Google Ads è‡ªå®šç¾©äººç¾¤çš„ç¶²ç«™æ¸…å–®ã€‚é€™äº›ç¶²ç«™æ‡‰è©²ï¼š
        1. èˆ‡è©²è¡Œæ¥­é«˜åº¦ç›¸é—œ
        2. æœ‰è¶³å¤ çš„æµé‡
        3. é©åˆç”¨æ–¼å†è¡ŒéŠ·
        4. åŒ…å«æ–°èã€è«–å£‡ã€éƒ¨è½æ ¼ç­‰ä¸åŒé¡å‹
        
        è«‹æä¾› 20-30 å€‹ç¶²ç«™ï¼Œæ ¼å¼ç‚º JSON é™£åˆ—ï¼Œæ¯å€‹ç¶²ç«™åŒ…å«ï¼š
        - name: ç¶²ç«™åç¨±
        - url: ç¶²ç«™ç¶²å€
        - type: ç¶²ç«™é¡å‹ (æ–°è/è«–å£‡/éƒ¨è½æ ¼/é›»å•†/å…¶ä»–)
        - relevance: ç›¸é—œæ€§ (é«˜/ä¸­/ä½)
        - traffic: æµé‡ç­‰ç´š (é«˜/ä¸­/ä½)
        
        è¡Œæ¥­: ${industry}`;
        
        const sitesList = await callGemini(prompt);
        renderAdsSitesResult(sitesList);
        
    } catch (error) {
        showAlert('ç”Ÿæˆå¤±æ•—', error.message, 'error');
    } finally {
        setLoadingState(false);
    }
}

function renderAdsSitesResult(sitesList) {
    const container = document.getElementById('ads-sites-result');
    
    if (!sitesList || sitesList.length === 0) {
        container.innerHTML = '<p class="text-gray-500">ç„¡æ³•ç”Ÿæˆç¶²ç«™æ¸…å–®</p>';
        return;
    }
    
    let html = `
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <h4 class="font-semibold text-techaccent">å»ºè­°ç¶²ç«™æ¸…å–® (${sitesList.length} å€‹)</h4>
                <button onclick="exportAdsSitesToCSV()" class="text-sm bg-green-600 hover:bg-green-700 px-3 py-1 rounded">åŒ¯å‡º CSV</button>
            </div>
            <div class="max-h-96 overflow-y-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-800 sticky top-0">
                        <tr>
                            <th class="p-2 text-left">ç¶²ç«™åç¨±</th>
                            <th class="p-2 text-left">ç¶²å€</th>
                            <th class="p-2 text-left">é¡å‹</th>
                            <th class="p-2 text-left">ç›¸é—œæ€§</th>
                            <th class="p-2 text-left">æµé‡</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    sitesList.forEach(site => {
        const relevanceBadge = getBadgeClass(site.relevance);
        const trafficBadge = getBadgeClass(site.traffic);
        
        html += `
            <tr class="border-b border-gray-700">
                <td class="p-2">${site.name}</td>
                <td class="p-2">
                    <a href="${site.url}" target="_blank" class="text-techaccent hover:underline">${site.url}</a>
                </td>
                <td class="p-2">${site.type}</td>
                <td class="p-2"><span class="badge ${relevanceBadge}">${site.relevance}</span></td>
                <td class="p-2"><span class="badge ${trafficBadge}">${site.traffic}</span></td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸ä¾›åŒ¯å‡ºä½¿ç”¨
    window.adsSitesList = sitesList;
}

function exportAdsSitesToCSV() {
    if (!window.adsSitesList) {
        showAlert('ç„¡è³‡æ–™', 'æ²’æœ‰å¯åŒ¯å‡ºçš„ç¶²ç«™æ¸…å–®', 'warning');
        return;
    }
    
    const csvContent = [
        ['ç¶²ç«™åç¨±', 'ç¶²å€', 'é¡å‹', 'ç›¸é—œæ€§', 'æµé‡'],
        ...window.adsSitesList.map(site => [site.name, site.url, site.type, site.relevance, site.traffic])
    ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Google_Ads_è‡ªå®šç¾©äººç¾¤ç¶²ç«™æ¸…å–®_${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
    
    showAlert('åŒ¯å‡ºæˆåŠŸ', 'ç¶²ç«™æ¸…å–®å·²åŒ¯å‡ºç‚º CSV æª”æ¡ˆ', 'success');
}

function generateKeywordStrategy() {
    const keywords = state.analysisData.keywords || [];
    if (keywords.length === 0) {
        document.getElementById('keyword-strategy-result').innerHTML = '<p class="text-gray-400">è«‹å…ˆå®Œæˆåˆ†æä»¥æŸ¥çœ‹é—œéµå­—ç­–ç•¥å»ºè­°</p>';
        return;
    }
    
    const highVolumeKeywords = keywords.filter(k => k.volume === 'é«˜');
    const highCompetitionKeywords = keywords.filter(k => k.biddingCompetition === 'é«˜');
    const lowCompetitionKeywords = keywords.filter(k => k.biddingCompetition === 'ä½');
    
    let strategyHTML = `
        <div class="space-y-6">
            <div class="bg-gray-800 p-4 rounded-lg">
                <h4 class="font-semibold text-techaccent mb-2">é«˜æœå°‹é‡é—œéµå­— (${highVolumeKeywords.length} å€‹)</h4>
                <p class="text-sm text-gray-300 mb-3">å»ºè­°ï¼šé«˜é ç®—æŠ•å…¥ï¼Œçˆ­å–æ’åå‰ 3</p>
                <div class="flex flex-wrap gap-2">
                    ${highVolumeKeywords.slice(0, 10).map(k => `<span class="badge badge-high">${k.keyword}</span>`).join('')}
                </div>
            </div>
            
            <div class="bg-gray-800 p-4 rounded-lg">
                <h4 class="font-semibold text-techaccent mb-2">é«˜ç«¶çˆ­é—œéµå­— (${highCompetitionKeywords.length} å€‹)</h4>
                <p class="text-sm text-gray-300 mb-3">å»ºè­°ï¼šè¬¹æ…å‡ºåƒ¹ï¼Œè€ƒæ…®é•·å°¾é—œéµå­—</p>
                <div class="flex flex-wrap gap-2">
                    ${highCompetitionKeywords.slice(0, 10).map(k => `<span class="badge badge-high">${k.keyword}</span>`).join('')}
                </div>
            </div>
            
            <div class="bg-gray-800 p-4 rounded-lg">
                <h4 class="font-semibold text-techaccent mb-2">ä½ç«¶çˆ­æ©Ÿæœƒé—œéµå­— (${lowCompetitionKeywords.length} å€‹)</h4>
                <p class="text-sm text-gray-300 mb-3">å»ºè­°ï¼šç©æ¥µå‡ºåƒ¹ï¼Œçˆ­å–ä½æˆæœ¬è½‰æ›</p>
                <div class="flex flex-wrap gap-2">
                    ${lowCompetitionKeywords.slice(0, 10).map(k => `<span class="badge badge-low">${k.keyword}</span>`).join('')}
                </div>
            </div>
            
            <div class="bg-blue-900/20 p-4 rounded-lg border border-blue-500/30">
                <h4 class="font-semibold text-blue-400 mb-2">å‡ºåƒ¹ç­–ç•¥å»ºè­°</h4>
                <ul class="text-sm text-gray-300 space-y-1">
                    <li>â€¢ é«˜æœå°‹é‡ + ä½ç«¶çˆ­ï¼šå‡ºåƒ¹ç¯„åœ 1.5-3.0</li>
                    <li>â€¢ é«˜æœå°‹é‡ + é«˜ç«¶çˆ­ï¼šå‡ºåƒ¹ç¯„åœ 2.0-5.0</li>
                    <li>â€¢ ä½æœå°‹é‡ + ä½ç«¶çˆ­ï¼šå‡ºåƒ¹ç¯„åœ 0.5-1.5</li>
                    <li>â€¢ é•·å°¾é—œéµå­—ï¼šå‡ºåƒ¹ç¯„åœ 0.3-1.0</li>
                </ul>
            </div>
        </div>
    `;
    
    document.getElementById('keyword-strategy-result').innerHTML = strategyHTML;
}

// --- AUTOMATED CONTENT DOWNLOAD ---
async function downloadContent() {
    if (!state.analysisData.finalCompetitors || state.analysisData.finalCompetitors.length === 0) {
        showAlert('ç„¡è³‡æ–™', 'è«‹å…ˆå®Œæˆåˆ†æ', 'warning');
        return;
    }
    
    setLoadingState(true, 'æ­£åœ¨ä¸‹è¼‰ç«¶çˆ­å°æ‰‹ç›¸é—œå…§å®¹...');
    
    try {
        const downloadPromises = state.analysisData.finalCompetitors.map(async (competitor, index) => {
            const content = {
                brandName: competitor.brandName,
                websiteUrl: competitor.websiteUrl,
                linkedinUrl: competitor.linkedinUrl,
                summary: competitor.summary,
                downloadTime: new Date().toISOString()
            };
            
            // å»ºç«‹æª”æ¡ˆåç¨±
            const fileName = `${competitor.brandName}_ç«¶çˆ­å°æ‰‹è³‡æ–™_${new Date().toISOString().slice(0, 10)}.json`;
            
            // å»ºç«‹ Blob ä¸¦ä¸‹è¼‰
            const blob = new Blob([JSON.stringify(content, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // å»¶é²ä¸‹è¼‰ä»¥é¿å…ç€è¦½å™¨é˜»æ“‹
            await new Promise(resolve => setTimeout(resolve, 1000));
        });
        
        await Promise.all(downloadPromises);
        showAlert('ä¸‹è¼‰å®Œæˆ', `å·²ä¸‹è¼‰ ${state.analysisData.finalCompetitors.length} å€‹ç«¶çˆ­å°æ‰‹è³‡æ–™æª”æ¡ˆ`, 'success');
        
    } catch (error) {
        showAlert('ä¸‹è¼‰å¤±æ•—', error.message, 'error');
    } finally {
        setLoadingState(false);
    }
}

// --- ENHANCED COMPETITOR ANALYSIS ---
async function getEnhancedCompetitorDetails(name, context) {
    const prompt = `è«‹å°å…¬å¸ "${name}" é€²è¡Œæ·±å…¥åˆ†æï¼Œè©²å…¬å¸æ˜¯ "${context.topic}" å¸‚å ´çš„ç«¶çˆ­å°æ‰‹ã€‚è«‹æä¾›ä»¥ä¸‹è©³ç´°è³‡è¨Šï¼š

    1. å…¬å¸åŸºæœ¬è³‡è¨Šï¼šæˆç«‹æ™‚é–“ã€å“¡å·¥äººæ•¸ã€å¹´ç‡Ÿæ”¶ç¯„åœ
    2. ç”¢å“/æœå‹™ï¼šä¸»è¦ç”¢å“ç·šã€ç‰¹è‰²åŠŸèƒ½ã€åƒ¹æ ¼å®šä½
    3. å¸‚å ´åœ°ä½ï¼šå¸‚å ç‡ã€å“ç‰ŒçŸ¥ååº¦ã€ç«¶çˆ­å„ªå‹¢
    4. è¡ŒéŠ·ç­–ç•¥ï¼šä¸»è¦è¡ŒéŠ·ç®¡é“ã€å»£å‘ŠæŠ•æ”¾ã€å…§å®¹ç­–ç•¥
    5. æŠ€è¡“å¯¦åŠ›ï¼šå°ˆåˆ©æ•¸é‡ã€ç ”ç™¼æŠ•å…¥ã€æŠ€è¡“å„ªå‹¢
    6. è²¡å‹™ç‹€æ³ï¼šè‚¡ç¥¨è¡¨ç¾ã€è²¡å‹™å¥åº·åº¦ã€æŠ•è³‡å‹•å‘
    7. æœªä¾†ç™¼å±•ï¼šæ“´å¼µè¨ˆåŠƒã€æ–°ç”¢å“é–‹ç™¼ã€å¸‚å ´ç­–ç•¥

    è«‹ä»¥ JSON æ ¼å¼å›å‚³ï¼ŒåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š
    {
        "brandName": "${name}",
        "basicInfo": { "founded": "å¹´ä»½", "employees": "äººæ•¸ç¯„åœ", "revenue": "ç‡Ÿæ”¶ç¯„åœ" },
        "products": { "mainProducts": ["ç”¢å“1", "ç”¢å“2"], "features": ["ç‰¹è‰²1", "ç‰¹è‰²2"], "pricing": "åƒ¹æ ¼å®šä½" },
        "marketPosition": { "marketShare": "å¸‚å ç‡", "brandAwareness": "çŸ¥ååº¦", "competitiveAdvantage": "ç«¶çˆ­å„ªå‹¢" },
        "marketingStrategy": { "channels": ["ç®¡é“1", "ç®¡é“2"], "advertising": "å»£å‘Šç­–ç•¥", "contentStrategy": "å…§å®¹ç­–ç•¥" },
        "technology": { "patents": "å°ˆåˆ©æ•¸é‡", "rdInvestment": "ç ”ç™¼æŠ•å…¥", "techAdvantage": "æŠ€è¡“å„ªå‹¢" },
        "financials": { "stockPerformance": "è‚¡ç¥¨è¡¨ç¾", "financialHealth": "è²¡å‹™å¥åº·åº¦", "investments": "æŠ•è³‡å‹•å‘" },
        "futurePlans": { "expansion": "æ“´å¼µè¨ˆåŠƒ", "newProducts": "æ–°ç”¢å“é–‹ç™¼", "marketStrategy": "å¸‚å ´ç­–ç•¥" }
    }`;

    try {
        const enhancedDetails = await callGemini(prompt);
        return enhancedDetails;
    } catch (error) {
        console.error(`Enhanced analysis failed for ${name}:`, error);
        return { brandName: name, error: error.message };
    }
}

// --- EVENT LISTENERS FOR NEW FEATURES ---
function setupEnhancedEventListeners() {
    // æ–°å¢äº‹ä»¶ç›£è½å™¨
    document.getElementById('generate-ads-sites-btn').onclick = generateAdsSitesList;
    document.getElementById('download-content-btn').onclick = downloadContent;
    
    // æ¨™ç±¤åˆ‡æ›æ™‚æ›´æ–°ç›¸é—œå…§å®¹
    document.querySelectorAll('.tab-main').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const tab = e.target.dataset.tab;
            if (tab === 'dashboard') {
                setTimeout(updateDashboard, 100);
            } else if (tab === 'comparison') {
                setTimeout(renderComparisonTable, 100);
            } else if (tab === 'ads-tools') {
                setTimeout(generateKeywordStrategy, 100);
            }
        });
    });
}

// --- ENHANCED RENDERING FUNCTIONS ---
function renderEnhancedCompetitorResults() {
    const card = document.getElementById('competitors-result-card');
    const data = state.analysisData.finalCompetitors || [];
    let content = `<h3 class="text-xl font-bold mb-4 text-techaccent">A. ç«¶çˆ­å°æ‰‹æ·±åº¦åˆ†æ</h3>`;

    if (data.length === 0) {
        card.innerHTML = content + '<p class="text-gray-500">æ²’æœ‰è¦é¡¯ç¤ºçš„ç«¶çˆ­å°æ‰‹è³‡æ–™ã€‚</p>';
        return;
    }

    content += `<div class="space-y-4">`;
    
    data.forEach(competitor => {
        content += `
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="flex justify-between items-start mb-3">
                    <h4 class="text-lg font-semibold text-techaccent">${competitor.brandName}</h4>
                    <div class="flex gap-2">
                        ${competitor.websiteUrl ? `<a href="${competitor.websiteUrl}" target="_blank" class="text-gray-400 hover:text-techaccent" title="å®˜æ–¹ç¶²ç«™"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a>` : ''}
                        ${competitor.linkedinUrl ? `<a href="${competitor.linkedinUrl}" target="_blank" class="text-gray-400 hover:text-techaccent" title="LinkedIn"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a>` : ''}
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-gray-400">åœ‹å®¶: <span class="text-gray-200">${competitor.country || 'æœªçŸ¥'}</span></p>
                        <p class="text-gray-400">è‚¡ç¥¨ä»£è™Ÿ: <span class="text-gray-200">${competitor.stockTicker || 'æœªä¸Šå¸‚'}</span></p>
                        <p class="text-gray-400">å…¬å¸é¡å‹: <span class="text-gray-200">${competitor.companyType || 'æœªçŸ¥'}</span></p>
                    </div>
                    <div>
                        <p class="text-gray-400">å·åˆ¥: <span class="text-gray-200">${competitor.state || 'æœªçŸ¥'}</span></p>
                        <p class="text-gray-400">éƒµéå€è™Ÿ: <span class="text-gray-200">${competitor.postalCode || 'æœªçŸ¥'}</span></p>
                    </div>
                </div>
                
                ${competitor.summary ? `<p class="text-gray-300 mt-3 text-sm">${competitor.summary}</p>` : ''}
            </div>
        `;
    });
    
    content += `</div>`;
    card.innerHTML = content;
}
</script>
</body>
</html>
